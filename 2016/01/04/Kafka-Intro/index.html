<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Introduce Kafka | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Introduce Kafka">
<meta property="og:type" content="article">
<meta property="og:title" content="Introduce Kafka">
<meta property="og:url" content="http://github.com/zqhxuyuan/2016/01/04/Kafka-Intro/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="Introduce Kafka">
<meta property="og:image" content="http://kafka.apache.org/images/consumer-groups.png">
<meta property="og:updated_time" content="2016-03-21T02:48:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Introduce Kafka">
<meta name="twitter:description" content="Introduce Kafka">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						
						<li>å…³äºæˆ‘</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives/">å½’æ¡£</a></li>
				        
							<li><a href="/tags/">æ ‡ç­¾</a></li>
				        
							<li><a href="/about/">å…³äº</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/akka/" style="font-size: 10px;">akka</a> <a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.75px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.25px;">drill</a> <a href="/tags/druid/" style="font-size: 13.75px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 13.75px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.25px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 11.25px;">midd</a> <a href="/tags/ops/" style="font-size: 13.75px;">ops</a> <a href="/tags/redis/" style="font-size: 11.25px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.75px;">scala</a> <a href="/tags/spark/" style="font-size: 17.5px;">spark</a> <a href="/tags/storm/" style="font-size: 17.5px;">storm</a> <a href="/tags/timeseries/" style="font-size: 12.5px;">timeseries</a> <a href="/tags/work/" style="font-size: 13.75px;">work</a> <a href="/tags/æµå¤„ç†/" style="font-size: 11.25px;">æµå¤„ç†</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="å›åˆ°ä¸»é¡µ">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="å›åˆ°ä¸»é¡µ">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives/">å½’æ¡£</a></li>
		        
					<li><a href="/tags/">æ ‡ç­¾</a></li>
		        
					<li><a href="/about/">å…³äº</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Kafka-Intro" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/04/Kafka-Intro/" class="article-date">
  	<time datetime="2016-01-03T16:00:00.000Z" itemprop="datePublished">2016-01-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Introduce Kafka
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/mq/">mq</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/">kafka</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>Introduce Kafka<br><a id="more"></a></p>
<h2 id="Background">Background</h2><p><strong>MQçš„é€šè®¯æ¨¡å¼</strong>  </p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç‚¹å¯¹ç‚¹é€šè®¯</td>
<td>ç‚¹å¯¹ç‚¹æ–¹å¼æ˜¯æœ€ä¸ºä¼ ç»Ÿå’Œå¸¸è§çš„é€šè®¯æ–¹å¼ï¼Œå®ƒæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šã€å¤šå¯¹ä¸€ç­‰å¤šç§é…ç½®æ–¹å¼ï¼Œæ”¯æŒæ ‘çŠ¶ã€ç½‘çŠ¶ç­‰å¤šç§æ‹“æ‰‘ç»“æ„ã€‚</td>
</tr>
<tr>
<td>å¤šç‚¹å¹¿æ’­</td>
<td>MQ é€‚ç”¨äºä¸åŒç±»å‹çš„åº”ç”¨ã€‚å…¶ä¸­é‡è¦çš„ï¼Œä¹Ÿæ˜¯æ­£åœ¨å‘å±•ä¸­çš„æ˜¯â€å¤šç‚¹å¹¿æ’­â€åº”ç”¨ï¼Œå³èƒ½å¤Ÿå°†æ¶ˆæ¯å‘é€åˆ°å¤šä¸ªç›®æ ‡ç«™ç‚¹ (Destination List)ã€‚å¯ä»¥ä½¿ç”¨ä¸€æ¡ MQ æŒ‡ä»¤å°†å•ä¸€æ¶ˆæ¯å‘é€åˆ°å¤šä¸ªç›®æ ‡ç«™ç‚¹ï¼Œå¹¶ç¡®ä¿ä¸ºæ¯ä¸€ç«™ç‚¹å¯é åœ°æä¾›ä¿¡æ¯ã€‚MQ ä¸ä»…æä¾›äº†å¤šç‚¹å¹¿æ’­çš„åŠŸèƒ½ï¼Œè€Œä¸”è¿˜æ‹¥æœ‰æ™ºèƒ½æ¶ˆæ¯åˆ†å‘åŠŸèƒ½ï¼Œåœ¨å°†ä¸€æ¡æ¶ˆæ¯å‘é€åˆ°åŒä¸€ç³»ç»Ÿä¸Šçš„å¤šä¸ªç”¨æˆ·æ—¶ï¼ŒMQ å°†æ¶ˆæ¯çš„ä¸€ä¸ªå¤åˆ¶ç‰ˆæœ¬å’Œè¯¥ç³»ç»Ÿä¸Šæ¥æ”¶è€…çš„åå•å‘é€åˆ°ç›®æ ‡ MQ ç³»ç»Ÿã€‚ç›®æ ‡ MQ ç³»ç»Ÿåœ¨æœ¬åœ°å¤åˆ¶è¿™äº›æ¶ˆæ¯ï¼Œå¹¶å°†å®ƒä»¬å‘é€åˆ°åå•ä¸Šçš„é˜Ÿåˆ—ï¼Œä»è€Œå°½å¯èƒ½å‡å°‘ç½‘ç»œçš„ä¼ è¾“é‡ã€‚</td>
</tr>
<tr>
<td>å‘å¸ƒ/è®¢é˜…(Publish/Subscribe)æ¨¡å¼</td>
<td>å‘å¸ƒ/è®¢é˜…åŠŸèƒ½ä½¿æ¶ˆæ¯çš„åˆ†å‘å¯ä»¥çªç ´ç›®çš„é˜Ÿåˆ—åœ°ç†æŒ‡å‘çš„é™åˆ¶ï¼Œä½¿æ¶ˆæ¯æŒ‰ç…§ç‰¹å®šçš„ä¸»é¢˜ç”šè‡³å†…å®¹è¿›è¡Œåˆ†å‘ï¼Œç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®ä¸»é¢˜æˆ–å†…å®¹æ¥æ”¶åˆ°æ‰€éœ€è¦çš„æ¶ˆæ¯ã€‚å‘å¸ƒ/è®¢é˜…åŠŸèƒ½ä½¿å¾—å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»å˜å¾—æ›´ä¸ºæ¾æ•£ï¼Œå‘é€è€…ä¸å¿…å…³å¿ƒæ¥æ”¶è€…çš„ç›®çš„åœ°å€ï¼Œè€Œæ¥æ”¶è€…ä¹Ÿä¸å¿…å…³å¿ƒæ¶ˆæ¯çš„å‘é€åœ°å€ï¼Œè€Œåªæ˜¯æ ¹æ®æ¶ˆæ¯çš„ä¸»é¢˜è¿›è¡Œæ¶ˆæ¯çš„æ”¶å‘ã€‚</td>
</tr>
<tr>
<td>ç¾¤é›† (Cluster)</td>
<td>ä¸ºäº†ç®€åŒ–ç‚¹å¯¹ç‚¹é€šè®¯æ¨¡å¼ä¸­çš„ç³»ç»Ÿé…ç½®ï¼ŒMQ æä¾› Cluster(ç¾¤é›†) çš„è§£å†³æ–¹æ¡ˆã€‚ç¾¤é›†ç±»ä¼¼äºä¸€ä¸ªåŸŸ (Domain)ï¼Œç¾¤é›†å†…éƒ¨çš„é˜Ÿåˆ—ç®¡ç†å™¨ä¹‹é—´é€šè®¯æ—¶ï¼Œä¸éœ€è¦ä¸¤ä¸¤ä¹‹é—´å»ºç«‹æ¶ˆæ¯é€šé“ï¼Œè€Œæ˜¯é‡‡ç”¨ç¾¤é›† (Cluster) é€šé“ä¸å…¶å®ƒæˆå‘˜é€šè®¯ï¼Œä»è€Œå¤§å¤§ç®€åŒ–äº†ç³»ç»Ÿé…ç½®ã€‚æ­¤å¤–ï¼Œç¾¤é›†ä¸­çš„é˜Ÿåˆ—ç®¡ç†å™¨ä¹‹é—´èƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå½“æŸä¸€é˜Ÿåˆ—ç®¡ç†å™¨å‡ºç°æ•…éšœæ—¶ï¼Œå…¶å®ƒé˜Ÿåˆ—ç®¡ç†å™¨å¯ä»¥æ¥ç®¡å®ƒçš„å·¥ä½œï¼Œä»è€Œå¤§å¤§æé«˜ç³»ç»Ÿçš„é«˜å¯é æ€§ã€‚</td>
</tr>
</tbody>
</table>
<p><strong>å…³é”®æ¦‚å¿µ</strong></p>
<table>
<thead>
<tr>
<th>Concepts</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td>Topic</td>
<td>ç”¨äºåˆ’åˆ†Messageçš„é€»è¾‘æ¦‚å¿µï¼Œä¸€ä¸ªTopicå¯ä»¥åˆ†å¸ƒåœ¨å¤šä¸ªBrokerä¸Šã€‚</td>
</tr>
<tr>
<td>Partition</td>
<td>æ˜¯Kafkaä¸­æ¨ªå‘æ‰©å±•å’Œä¸€åˆ‡å¹¶è¡ŒåŒ–çš„åŸºç¡€ï¼Œæ¯ä¸ªTopicéƒ½è‡³å°‘è¢«åˆ‡åˆ†ä¸º1ä¸ªPartitionã€‚</td>
</tr>
<tr>
<td>Offset</td>
<td>æ¶ˆæ¯åœ¨Partitionä¸­çš„ç¼–å·ï¼Œç¼–å·é¡ºåºä¸è·¨Partition(åœ¨Partitionå†…æœ‰åº)ã€‚</td>
</tr>
<tr>
<td>Consumer</td>
<td>ç”¨äºä»Brokerä¸­å–å‡º/æ¶ˆè´¹Messageã€‚</td>
</tr>
<tr>
<td>Producer</td>
<td>ç”¨äºå¾€Brokerä¸­å‘é€/ç”Ÿäº§Messageã€‚</td>
</tr>
<tr>
<td>Replication</td>
<td>Kafkaæ”¯æŒä»¥Partitionä¸ºå•ä½å¯¹Messageè¿›è¡Œå†—ä½™å¤‡ä»½ï¼Œæ¯ä¸ªPartitionéƒ½å¯ä»¥é…ç½®è‡³å°‘1ä¸ªReplication(å½“ä»…1ä¸ªReplicationæ—¶å³ä»…è¯¥Partitionæœ¬èº«)ã€‚</td>
</tr>
<tr>
<td>Leader</td>
<td>æ¯ä¸ªReplicationé›†åˆä¸­çš„Partitionéƒ½ä¼šé€‰å‡ºä¸€ä¸ªå”¯ä¸€çš„Leaderï¼Œæ‰€æœ‰çš„è¯»å†™è¯·æ±‚éƒ½ç”±Leaderå¤„ç†ã€‚å…¶ä»–Replicasä»Leaderå¤„æŠŠæ•°æ®æ›´æ–°åŒæ­¥åˆ°æœ¬åœ°ã€‚</td>
</tr>
<tr>
<td>Broker</td>
<td>Kafkaä¸­ä½¿ç”¨Brokeræ¥æ¥å—Producerå’ŒConsumerçš„è¯·æ±‚ï¼Œå¹¶æŠŠMessageæŒä¹…åŒ–åˆ°æœ¬åœ°ç£ç›˜ã€‚æ¯ä¸ªClusterå½“ä¸­ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªBrokeræ¥æ‹…ä»»Controllerï¼Œè´Ÿè´£å¤„ç†Partitionçš„Leaderé€‰ä¸¾ï¼Œåè°ƒPartitionè¿ç§»ç­‰å·¥ä½œã€‚</td>
</tr>
<tr>
<td>ISR</td>
<td>In-Sync Replica,æ˜¯Replicasçš„ä¸€ä¸ªå­é›†ï¼Œè¡¨ç¤ºç›®å‰Aliveä¸”ä¸Leaderèƒ½å¤Ÿâ€œCatch-upâ€çš„Replicasé›†åˆã€‚ç”±äºè¯»å†™éƒ½æ˜¯é¦–å…ˆè½åˆ°Leaderä¸Šï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´é€šè¿‡åŒæ­¥æœºåˆ¶ä»Leaderä¸Šæ‹‰å–æ•°æ®çš„Replicaéƒ½ä¼šå’ŒLeaderæœ‰ä¸€äº›å»¶è¿Ÿ(åŒ…æ‹¬äº†å»¶è¿Ÿæ—¶é—´å’Œå»¶è¿Ÿæ¡æ•°ä¸¤ä¸ªç»´åº¦)ï¼Œä»»æ„ä¸€ä¸ªè¶…è¿‡é˜ˆå€¼éƒ½ä¼šæŠŠè¯¥Replicaè¸¢å‡ºISRã€‚æ¯ä¸ªLeader Partitionéƒ½æœ‰å®ƒè‡ªå·±ç‹¬ç«‹çš„ISRã€‚</td>
</tr>
</tbody>
</table>
<p><strong>è®¾è®¡æ€æƒ³</strong></p>
<table>
<thead>
<tr>
<th>Concepts</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td>Consumergroup</td>
<td>å„ä¸ªconsumerå¯ä»¥ç»„æˆä¸€ä¸ªç»„ï¼Œæ¯ä¸ªæ¶ˆæ¯åªèƒ½è¢«ç»„ä¸­çš„ä¸€ä¸ªconsumeræ¶ˆè´¹ï¼Œå¦‚æœä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªconsumeræ¶ˆè´¹çš„è¯ï¼Œé‚£ä¹ˆè¿™äº›consumerå¿…é¡»åœ¨ä¸åŒçš„ç»„ã€‚</td>
</tr>
<tr>
<td>æ¶ˆæ¯çŠ¶æ€</td>
<td>åœ¨Kafkaä¸­ï¼Œæ¶ˆæ¯çš„çŠ¶æ€è¢«ä¿å­˜åœ¨consumerä¸­ï¼Œbrokerä¸ä¼šå…³å¿ƒå“ªä¸ªæ¶ˆæ¯è¢«æ¶ˆè´¹äº†è¢«è°æ¶ˆè´¹äº†ï¼Œåªè®°å½•ä¸€ä¸ªoffsetå€¼ï¼ˆæŒ‡å‘partitionä¸­ä¸‹ä¸€ä¸ªè¦è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ä½ç½®ï¼‰ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœconsumerå¤„ç†ä¸å¥½çš„è¯ï¼Œbrokerä¸Šçš„ä¸€ä¸ªæ¶ˆæ¯å¯èƒ½ä¼šè¢«æ¶ˆè´¹å¤šæ¬¡ã€‚</td>
</tr>
<tr>
<td>æ¶ˆæ¯æŒä¹…åŒ–</td>
<td>Kafkaä¸­ä¼šæŠŠæ¶ˆæ¯æŒä¹…åŒ–åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸”ä¿æŒæé«˜çš„æ•ˆç‡ã€‚</td>
</tr>
<tr>
<td>æ¶ˆæ¯æœ‰æ•ˆæœŸ</td>
<td>Kafkaä¼šé•¿ä¹…ä¿ç•™å…¶ä¸­çš„æ¶ˆæ¯ï¼Œä»¥ä¾¿consumerå¯ä»¥å¤šæ¬¡æ¶ˆè´¹ï¼Œå½“ç„¶å…¶ä¸­å¾ˆå¤šç»†èŠ‚æ˜¯å¯é…ç½®çš„ã€‚</td>
</tr>
<tr>
<td>æ‰¹é‡å‘é€</td>
<td>Kafkaæ”¯æŒä»¥æ¶ˆæ¯é›†åˆä¸ºå•ä½è¿›è¡Œæ‰¹é‡å‘é€ï¼Œä»¥æé«˜pushæ•ˆç‡ã€‚</td>
</tr>
<tr>
<td>push-and-pull</td>
<td>Kafkaä¸­çš„Producerå’Œconsumeré‡‡ç”¨çš„æ˜¯push-and-pullæ¨¡å¼ï¼Œå³Produceråªç®¡å‘broker pushæ¶ˆæ¯ï¼Œconsumeråªç®¡ä»broker pullæ¶ˆæ¯ï¼Œä¸¤è€…å¯¹æ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹æ˜¯å¼‚æ­¥çš„ã€‚</td>
</tr>
<tr>
<td>Brokerä¹‹é—´çš„å…³ç³»</td>
<td>ä¸æ˜¯ä¸»ä»å…³ç³»ï¼Œå„ä¸ªbrokeråœ¨é›†ç¾¤ä¸­åœ°ä½ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥éšæ„çš„å¢åŠ æˆ–åˆ é™¤ä»»ä½•ä¸€ä¸ªbrokerèŠ‚ç‚¹ã€‚</td>
</tr>
<tr>
<td>è´Ÿè½½å‡è¡¡</td>
<td>Kafkaæä¾›äº†ä¸€ä¸ª metadata APIæ¥ç®¡ç†brokerä¹‹é—´çš„è´Ÿè½½ï¼ˆå¯¹Kafka0.8.xè€Œè¨€ï¼Œå¯¹äº0.7.xä¸»è¦é zookeeperæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼‰ã€‚</td>
</tr>
<tr>
<td>åŒæ­¥å¼‚æ­¥</td>
<td>Produceré‡‡ç”¨å¼‚æ­¥pushæ–¹å¼ï¼Œæå¤§æé«˜Kafkaç³»ç»Ÿçš„ååç‡ï¼ˆå¯ä»¥é€šè¿‡å‚æ•°æ§åˆ¶æ˜¯é‡‡ç”¨åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ–¹å¼ï¼‰ã€‚</td>
</tr>
<tr>
<td>åˆ†åŒºæœºåˆ¶partition</td>
<td>Kafkaçš„brokerç«¯æ”¯æŒæ¶ˆæ¯åˆ†åŒºï¼ŒProducerå¯ä»¥å†³å®šæŠŠæ¶ˆæ¯å‘åˆ°å“ªä¸ªåˆ†åŒºï¼Œåœ¨ä¸€ä¸ªåˆ†åŒºä¸­æ¶ˆæ¯çš„é¡ºåºå°±æ˜¯Producerå‘é€æ¶ˆæ¯çš„é¡ºåºï¼Œä¸€ä¸ªä¸»é¢˜ä¸­å¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºï¼Œå…·ä½“åˆ†åŒºçš„æ•°é‡æ˜¯å¯é…ç½®çš„ã€‚åˆ†åŒºçš„æ„ä¹‰å¾ˆé‡å¤§ï¼Œåé¢çš„å†…å®¹ä¼šé€æ¸ä½“ç°ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="Kafka_Replication">Kafka Replication</h2><p>The leader maintains a set of in-sync replicas (ISR): the set of replicas that have fully caught up with the leader.<br>For each partition, we store in Zookeeper the current leader and the current ISR.  </p>
<blockquote>
<p>Leaderç»´æŠ¤äº†ISR(èƒ½å®Œå…¨èµ¶å¾—ä¸ŠLeaderçš„å‰¯æœ¬é›†).æ¯ä¸ªPartitionå½“å‰çš„Leaderå’ŒISRä¿¡æ¯ä¼šè®°å½•åœ¨ZooKeeperä¸­.  </p>
<p>é—®é¢˜:ä¸ºä»€ä¹ˆæ˜¯ç”±Leaderæ¥ç»´æŠ¤ISR?<br>èƒŒæ™¯:Leaderä¼šè·Ÿè¸ªä¸å…¶ä¿æŒåŒæ­¥çš„Replicaåˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨ç§°ä¸ºISRã€‚å¦‚æœä¸€ä¸ªFollowerå®•æœºï¼Œæˆ–è€…è½åå¤ªå¤šï¼ŒLeaderå°†æŠŠå®ƒä»ISRä¸­ç§»é™¤.<br>ç­”æ¡ˆ:åªæœ‰Leaderæ‰èƒ½çŸ¥é“å“ªäº›Replicaèƒ½å¤ŸåŠæ—¶å®Œå…¨èµ¶å¾—ä¸Š.æ‰€æœ‰Followeréƒ½ä¼šå’ŒLeaderé€šä¿¡è·å–æœ€æ–°çš„æ¶ˆæ¯.<br>ä½†æ˜¯Followerä¹‹é—´å¹¶ä¸äº’ç›¸çŸ¥é“å½¼æ­¤çš„ä¿¡æ¯.æ‰€ä»¥ç”±Leaderæ¥ç®¡ç†ISRæœ€åˆé€‚äº†.Leaderè¿˜å¯ä»¥å†³å®šç§»é™¤è½åå¤ªå¤šçš„Replicas. </p>
</blockquote>
<p>Each replica stores messages in a local log and maintains a few important offset positions in the log.<br>The log end offset (LEO) represents the tail of the log.<br>The high watermark (HW) is the offset of the last committed message.  </p>
<blockquote>
<p>æ¯ä¸ªReplicaéƒ½åœ¨è‡ªå·±çš„local logä¸­å­˜å‚¨æ¶ˆæ¯,å¹¶åœ¨æ—¥å¿—ä¸­ç»´æŠ¤äº†é‡è¦çš„offsetä½ç½®ä¿¡æ¯.<br>LEOä»£è¡¨äº†æ—¥å¿—çš„æœ€æ–°çš„åç§»é‡,HWæ˜¯æœ€è¿‘æäº¤æ¶ˆæ¯çš„åç§»é‡(HWä¹Ÿæ˜¯æ¯ä¸ªReplicaéƒ½æœ‰çš„å—?).  </p>
</blockquote>
<p>Each log is periodically synced to disks. Data before the flushed offset is guaranteed to be persisted on disks.<br>As we will see, the flush offset can be before or after HW.  </p>
<blockquote>
<p>æ¯ä¸ªæ—¥å¿—éƒ½ä¼šå®šæ—¶åœ°åŒæ­¥åˆ°ç£ç›˜.åœ¨flushed offsetä¹‹å‰çš„æ•°æ®ä¸€å®šèƒ½ä¿å­˜æˆåŠŸæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Š.<br>flush offsetå¯ä»¥åœ¨HWä¹‹å‰æˆ–è€…ä¹‹å(å› ä¸ºfolloweråªæ˜¯å…ˆå†™åˆ°å†…å­˜ä¸­ç„¶åè¿”å›ackç»™leader,hwå¢åŠ æ—¶,<br>followeråœ¨å†…å­˜ä¸­çš„æ¶ˆæ¯ä¸ä¸€å®šä»€ä¹ˆæ—¶å€™å†™åˆ°ç£ç›˜ä¸Š,å³å¯èƒ½åœ¨hwå¢åŠ å‰å°±å†™åˆ°ç£ç›˜,æˆ–è€…ç­‰hwå¢åŠ åæ‰å†™åˆ°ç£ç›˜).</p>
</blockquote>
<p><strong>Writes</strong><br>To publish a message to a partition, the client first finds the <code>leader of the partition</code> from<br>Zookeeper and <code>sends the message to the leader</code>.The leader writes the message to its <code>local log</code>.<br>Each follower constantly <code>pulls</code> new messages from the leader using a single socket channel.<br>That way, the follower receives all messages in the <code>same order</code> as written in the leader.  </p>
<blockquote>
<p>ä¸ºäº†å°†æ¶ˆæ¯å‘å¸ƒç»™ä¸€ä¸ªPartition,å®¢æˆ·ç«¯ä¼šä»ZKä¸­å…ˆæ‰¾åˆ°è¿™ä¸ªPartitionçš„Leader,ç„¶åæŠŠæ¶ˆæ¯å‘é€ç»™Leader.<br>Leaderä¼šå°†æ¶ˆæ¯å†™åˆ°è‡ªå·±çš„æœ¬åœ°æ—¥å¿—æ–‡ä»¶ä¸­,(Partitionçš„)æ¯ä¸ªfollowerä¼šä»Leaderä¸€ç›´æ‹‰å–æ•°æ®.<br>é€šè¿‡è¿™ç§æ–¹å¼,followeræ¥æ”¶çš„æ‰€æœ‰æ¶ˆæ¯çš„é¡ºåºä¸€å®šå’Œå†™åˆ°leaderçš„æ¶ˆæ¯æ˜¯åŒæ ·çš„é¡ºåº.  </p>
</blockquote>
<p>The follower writes each received message to its <code>own log</code> and sends an <code>acknowledgment</code> back to the leader.<br>Once the leader receives the acknowledgment from <code>all replicas in ISR</code>, the message is <code>committed</code>.<br>The <code>leader advances the HW</code> and sends an acknowledgment to the client.  </p>
<blockquote>
<p>followeræ”¶åˆ°çš„æ¯æ¡æ¶ˆæ¯éƒ½ä¼šå†™åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­,å¹¶ä¸”å‘é€ackç»™leader.<br>ä¸€æ—¦leaderæ¥æ”¶åˆ°åœ¨ISRä¸­æ‰€æœ‰å‰¯æœ¬çš„ack,è¿™æ¡æ¶ˆæ¯å°±ä¼šè¢«æäº¤.ç„¶åLeaderä¼šå¢åŠ HW,å¹¶å‘é€ackç»™å®¢æˆ·ç«¯.</p>
</blockquote>
<p>For better performance, each follower sends an acknowledgment after the message is <code>written to memory</code>.<br>So, for each committed message, we guarantee that the message is stored in multiple replicas in memory.<br>However, there is <code>no guarantee</code> that any replica has <code>persisted</code> the commit message to disks though.<br>Given that correlated failures are relatively rare, this approach gives us a good balance between response time and durability.<br>In the future, we may consider adding options that provide even stronger guarantees.  </p>
<blockquote>
<p>ä¸ºäº†æ€§èƒ½è€ƒè™‘,æ¯ä¸ªfollowerå½“æ¶ˆæ¯è¢«å†™åˆ°å†…å­˜æ—¶å°±å‘é€ack(è€Œä¸æ˜¯è¦å®Œå…¨åœ°åˆ·å†™åˆ°ç£ç›˜ä¸Šæ‰ack).<br>æ‰€ä»¥å¯¹äºæ¯æ¡æäº¤çš„æ¶ˆæ¯,æˆ‘ä»¬èƒ½å¤Ÿä¿è¯çš„æ˜¯è¿™æ¡æ¶ˆæ¯ä¸€å®šæ˜¯å­˜å‚¨åœ¨å¤šä¸ªå‰¯æœ¬(æ‰€æœ‰ISR)çš„å†…å­˜ä¸­.<br>ä½†æ˜¯å¹¶ä¸ä¿è¯ä»»ä½•å‰¯æœ¬å·²ç»æŠŠè¿™æ¡æäº¤çš„æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­.è¿™æ˜¯åŸºäºå“åº”æ—¶é—´å’ŒæŒä¹…æ€§ä¸¤è€…å¹³è¡¡çš„.    </p>
</blockquote>
<p>The leader also periodically <code>broadcasts the HW</code> to all followers.<br>The broadcasting can be piggybacked(èƒŒè´Ÿ) on the return value of the <code>fetch requests</code> from the followers.<br>From time to time, <code>each replica checkpoints its HW to its disk</code>.  </p>
<blockquote>
<p>Leaderä¹Ÿä¼šå®šæ—¶åœ°å°†HWå¹¿æ’­ç»™æ‰€æœ‰çš„followers. å¹¿æ’­æ¶ˆæ¯å¯ä»¥é™„åŠ åœ¨ä»followerè¿‡æ¥çš„fetchè¯·æ±‚çš„ç»“æœä¸­.<br>åŒæ—¶,æ¯ä¸ªå‰¯æœ¬(ä¸ç®¡æ˜¯leaderè¿˜æ˜¯follower)ä¹Ÿä¼šå®šæ—¶åœ°å°†HWæŒä¹…åŒ–åˆ°è‡ªå·±çš„ç£ç›˜ä¸Š.  </p>
<p>å½“followerå‘leaderæäº¤fetchè¯·æ±‚æ—¶,leaderä¹Ÿä¼šå‘Šè¯‰æ‰€æœ‰çš„followerè¯´,æˆ‘ç°åœ¨çš„hwæ˜¯å¤šå°‘äº†.è¿™æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶.<br>å‡è®¾åªæœ‰leaderä¸€ä¸ªäººä¿æŠ¤äº†hwè¿™ä¸ªé‡è¦çš„ä¿¡æ¯,ä¸€æ—¦leaderä¸å¹¸æŒ‚æ‰äº†,å°±æ²¡æœ‰äººçŸ¥é“hwç°åœ¨åˆ°åº•æ˜¯å¤šå°‘äº†.<br>æ‰€ä»¥åªè¦ä¸€æœ‰followerè¿‡æ¥è·å–æ¶ˆæ¯æ—¶,leaderå°±ä¸åŒå…¶çƒ¦åœ°åƒä¸ªè€å¤ªå©†ä¸æ–­åœ°å” å¨è¯´æˆ‘è¿™ä¸€æ¬¡çš„hwæ›´æ–°åˆ°äº†å“ªé‡Œ.<br>æ¯ä¸ªfollowerä¹Ÿå°±éƒ½ä¼šçŸ¥é“leaderçš„æœ€æ–°hw.è¿™æ ·å³ä½¿leaderæŒ‚æ‰äº†,hwä»ç„¶åœ¨å…¶ä»–followerä¸Šéƒ½å¤‡ä»½æœ‰è¿™ä¸ªé‡è¦ä¿¡æ¯.<br>å‡ ä¸ªfolloweråœ¨ä¸€é˜µå•†é‡å,é€‰ä¸¾å‡ºäº†æ–°çš„leader,è¿™äº›äººéƒ½çŸ¥é“ä¸Šä¸€ä¸ªleaderæœ€æ–°çš„hw,å› æ­¤hwè¿™ä¸ªé¦™ç«ä¼šç»§ç»­ä¼ æ‰¿ä¸‹å».  </p>
</blockquote>
<p><strong>Reads</strong><br>For simplicity, reads are always served from the leader. Only messages up to the HW are exposed to the reader.  </p>
<blockquote>
<p>ä¸ºäº†ç®€å•èµ·è§,åªæœ‰leaderå¯ä»¥æä¾›è¯»æ¶ˆæ¯çš„æœåŠ¡.å¹¶ä¸”æœ€å¤šåªåˆ°hwä½ç½®çš„æ¶ˆæ¯æ‰ä¼šæš´éœ²ç»™å®¢æˆ·ç«¯.  </p>
</blockquote>
<hr>
<p>Produceråœ¨å‘å¸ƒæ¶ˆæ¯åˆ°æŸä¸ªPartitionæ—¶ï¼Œå…ˆé€šè¿‡Zookeeperæ‰¾åˆ°è¯¥Partitionçš„Leaderï¼Œ<br>ç„¶åæ— è®ºè¯¥Topicçš„Replication Factorä¸ºå¤šå°‘ï¼ˆä¹Ÿå³è¯¥Partitionæœ‰å¤šå°‘ä¸ªReplicaï¼‰ï¼Œ<br>Produceråªå°†è¯¥æ¶ˆæ¯å‘é€åˆ°è¯¥Partitionçš„Leaderã€‚Leaderä¼šå°†è¯¥æ¶ˆæ¯å†™å…¥å…¶æœ¬åœ°Logã€‚æ¯ä¸ªFolloweréƒ½ä»Leader pullæ•°æ®ã€‚<br>è¿™ç§æ–¹å¼ä¸Šï¼ŒFollowerå­˜å‚¨çš„æ•°æ®é¡ºåºä¸Leaderä¿æŒä¸€è‡´ã€‚Followeråœ¨æ”¶åˆ°è¯¥æ¶ˆæ¯å¹¶å†™å…¥å…¶Logåï¼Œå‘Leaderå‘é€ACKã€‚<br>ä¸€æ—¦Leaderæ”¶åˆ°äº†ISRä¸­çš„æ‰€æœ‰Replicaçš„ACKï¼Œè¯¥æ¶ˆæ¯å°±è¢«è®¤ä¸ºå·²ç»commitäº†ï¼ŒLeaderå°†å¢åŠ HWå¹¶ä¸”å‘Producerå‘é€ACKã€‚<br>ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæ¯ä¸ªFolloweråœ¨æ¥æ”¶åˆ°æ•°æ®åå°±ç«‹é©¬å‘Leaderå‘é€ACKï¼Œè€Œéç­‰åˆ°æ•°æ®å†™å…¥Logä¸­ã€‚<br>å› æ­¤ï¼Œå¯¹äºå·²ç»commitçš„æ¶ˆæ¯ï¼ŒKafkaåªèƒ½ä¿è¯å®ƒè¢«å­˜äºå¤šä¸ªReplicaçš„å†…å­˜ä¸­ï¼Œè€Œä¸èƒ½ä¿è¯å®ƒä»¬è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œ<br>ä¹Ÿå°±ä¸èƒ½å®Œå…¨ä¿è¯å¼‚å¸¸å‘ç”Ÿåè¯¥æ¡æ¶ˆæ¯ä¸€å®šèƒ½è¢«Consumeræ¶ˆè´¹ã€‚ä½†è€ƒè™‘åˆ°è¿™ç§åœºæ™¯éå¸¸å°‘è§ï¼Œ<br>å¯ä»¥è®¤ä¸ºè¿™ç§æ–¹å¼åœ¨æ€§èƒ½å’Œæ•°æ®æŒä¹…åŒ–ä¸Šåšäº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å¹³è¡¡ã€‚åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­ï¼ŒKafkaä¼šè€ƒè™‘æä¾›æ›´é«˜çš„æŒä¹…æ€§ã€‚<br>Consumerè¯»æ¶ˆæ¯ä¹Ÿæ˜¯ä»Leaderè¯»å–ï¼Œåªæœ‰è¢«commitè¿‡çš„æ¶ˆæ¯ï¼ˆoffsetä½äºHWçš„æ¶ˆæ¯ï¼‰æ‰ä¼šæš´éœ²ç»™Consumerã€‚ </p>
<p>Kafkaçš„å¤åˆ¶æœºåˆ¶æ—¢ä¸æ˜¯å®Œå…¨çš„åŒæ­¥å¤åˆ¶ï¼Œä¹Ÿä¸æ˜¯å•çº¯çš„å¼‚æ­¥å¤åˆ¶ã€‚äº‹å®ä¸Šï¼Œ<br>åŒæ­¥å¤åˆ¶è¦æ±‚æ‰€æœ‰èƒ½å·¥ä½œçš„Followeréƒ½å¤åˆ¶å®Œï¼Œè¿™æ¡æ¶ˆæ¯æ‰ä¼šè¢«è®¤ä¸ºcommitï¼Œè¿™ç§å¤åˆ¶æ–¹å¼æå¤§çš„å½±å“äº†ååç‡ã€‚<br>è€Œå¼‚æ­¥å¤åˆ¶æ–¹å¼ä¸‹ï¼ŒFollowerå¼‚æ­¥çš„ä»Leaderå¤åˆ¶æ•°æ®ï¼Œæ•°æ®åªè¦è¢«Leaderå†™å…¥logå°±è¢«è®¤ä¸ºå·²ç»commitï¼Œ<br>è¿™ç§æƒ…å†µä¸‹å¦‚æœFolloweréƒ½å¤åˆ¶å®Œéƒ½è½åäºLeaderï¼Œè€Œå¦‚æœLeaderçªç„¶å®•æœºï¼Œåˆ™ä¼šä¸¢å¤±æ•°æ®ã€‚<br>è€ŒKafkaçš„è¿™ç§ä½¿ç”¨ISRçš„æ–¹å¼åˆ™å¾ˆå¥½çš„å‡è¡¡äº†ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ä»¥åŠååç‡ã€‚<br>Followerå¯ä»¥æ‰¹é‡çš„ä»Leaderå¤åˆ¶æ•°æ®ï¼Œè¿™æ ·æå¤§çš„æé«˜å¤åˆ¶æ€§èƒ½ï¼ˆæ‰¹é‡å†™ç£ç›˜ï¼‰ï¼Œæå¤§å‡å°‘äº†Followerä¸Leaderçš„å·®è·  </p>
<hr>
<p>Checkpointç”¨åœ¨Follower failureæ˜¯æ€ä¹ˆè§£å†³HWçš„åŒæ­¥é—®é¢˜:<br>After a configured timeout period, the leader will drop the failed follower from its ISR<br>and writes will continue on the remaining replicas in ISR.  </p>
<blockquote>
<p>å¦‚æœFollowerå¤±è´¥äº†,åœ¨è¶…è¿‡ä¸€å®šæ—¶é—´å,Leaderä¼šå°†è¿™ä¸ªå¤±è´¥çš„followerä»ISRä¸­ç§»é™¤(followeræ²¡æœ‰å‘é€fetchè¯·æ±‚)<br>ç”±äºISRä¿å­˜çš„æ˜¯æ‰€æœ‰å…¨éƒ¨èµ¶å¾—ä¸ŠLeaderçš„follower replicas,å¤±è´¥çš„followerè‚¯å®šæ˜¯èµ¶ä¸ä¸Šäº†.<br>è™½ç„¶ISRç°åœ¨å°‘äº†ä¸€ä¸ª,ä½†æ˜¯å¹¶ä¸ä¼šå¼•èµ·çš„æ•°æ®çš„ä¸¢å¤±,ISRä¸­å‰©ä½™çš„replicasä¼šç»§ç»­åŒæ­¥æ•°æ®(åªè¦ISRä¸­æœ‰ä¸€ä¸ªfollower,å°±ä¸ä¼šä¸¢å¤±æ•°æ®)<br>(æ³¨æ„:è¿™é‡Œè®¨è®ºçš„æ˜¯ä¸€ä¸ªPartitionçš„followerå‰¯æœ¬,è€Œä¸æ˜¯èŠ‚ç‚¹,å¦‚æœæ˜¯ä¸€ä¸ªèŠ‚ç‚¹,å®ƒä¸æ­¢å­˜å‚¨ä¸€ä¸ªPartition,è€Œä¸”ä¸éƒ½æ˜¯follower)  </p>
</blockquote>
<p>If the failed follower comes back, it first truncates its log to the last checkpointed HW.<br>It then starts to catch up all messages after its HW from the leader.<br>When the follower fully catches up, the leader will add it back to the current ISR.  </p>
<blockquote>
<p>å¦‚æœå¤±è´¥çš„followeræ¢å¤è¿‡æ¥,å®ƒé¦–å…ˆå°†è‡ªå·±çš„æ—¥å¿—æˆªæ–­åˆ°ä¸Šæ¬¡checkpointedæ—¶åˆ»çš„HW.<br>å› ä¸ºcheckpointè®°å½•çš„æ˜¯æ‰€æœ‰Partitionçš„hw offset. å½“followerå¤±è´¥æ—¶,checkpointä¸­å…³äºè¿™ä¸ªPartitionçš„HWå°±ä¸ä¼šå†æ›´æ–°äº†.<br>è€Œè¿™ä¸ªæ—¶å€™å­˜å‚¨çš„HWä¿¡æ¯å’Œfollower partition replicaçš„offsetå¹¶ä¸ä¸€å®šæ˜¯ä¸€è‡´çš„. æ¯”å¦‚è¿™ä¸ªfollowerè·å–æ¶ˆæ¯æ¯”è¾ƒå¿«,<br>ä½†æ˜¯ISRä¸­æœ‰å…¶ä»–followerå¤åˆ¶æ¶ˆæ¯æ¯”è¾ƒæ…¢,è¿™æ ·Leaderå¹¶ä¸ä¼šå¾ˆå¿«åœ°æ›´æ–°HW,è¿™ä¸ªå¿«çš„followerçš„hwä¹Ÿä¸ä¼šæ›´æ–°(leaderå¹¿æ’­hwç»™follower)<br>è¿™ç§æƒ…å†µä¸‹,è¿™ä¸ªfolloweræ—¥å¿—çš„offsetæ˜¯æ¯”hwè¦å¤§çš„.æ‰€ä»¥åœ¨å®ƒæ¢å¤ä¹‹å,è¦å°†æ¯”hwå¤šçš„éƒ¨åˆ†æˆªæ‰,ç„¶åç»§ç»­ä»leaderæ‹‰å–æ¶ˆæ¯(è·Ÿå¹³æ—¶ä¸€æ ·).<br>å®é™…ä¸Š,ISRä¸­çš„æ¯ä¸ªfolloweræ—¥å¿—çš„offsetä¸€å®šæ˜¯æ¯”hwå¤§çš„.å› ä¸ºåªæœ‰ISRä¸­æ‰€æœ‰followeréƒ½å¤åˆ¶å®Œæ¶ˆæ¯,leaderæ‰ä¼šå¢åŠ hw.<br>ä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½æœ‰äº›followerå¤åˆ¶å®Œäº†,è€Œæœ‰äº›followerè¿˜æ²¡æœ‰å¤åˆ¶å®Œ,é‚£ä¹ˆhwæ˜¯ä¸ä¼šå¢åŠ çš„,å¤åˆ¶å®Œçš„followerçš„offsetå°±æ¯”hwè¦å¤§.  </p>
</blockquote>
<h2 id="Consumer_Design">Consumer Design</h2><h3 id="Group_management_protocol">Group management protocol</h3><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+0.9+Consumer+Rewrite+Design" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/KAFKA/Kafka+0.9+Consumer+Rewrite+Design</a>  </p>
<p>Rebalancing is the process where a group of consumer instances (belonging to the same group) co-ordinate to own a mutually exclusive set of partitions of topics that the group is subscribed to. At the end of a successful rebalance operation for a consumer group, every partition for all subscribed topics will be owned by a single consumer instance within the group. The way rebalancing works is as follows. Every broker is elected as the coordinator for a subset of the consumer groups. The co-ordinator broker for a group is responsible for orchestrating a rebalance operation on consumer group membership changes or partition changes for the subscribed topics. It is also responsible for communicating the resulting partition ownership configuration to all consumers of the group undergoing a rebalance operation.<br>åœ¨åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œå¤šä¸ªconsumerå®ä¾‹éœ€è¦è¿›è¡Œå¹³è¡¡æ“ä½œ. æ¶ˆè´¹ç»„ä¼šæ³¨å†Œæ„Ÿå…´è¶£çš„topics. è¿™ä¸ªæ¶ˆè´¹ç»„ä¸­çš„æ‰€æœ‰æ¶ˆè´¹è€…ä¼šäº’ç›¸åè°ƒ,<br>æ¯ä¸ªæ¶ˆè´¹è€…ä¼šäº’ç›¸æ‹¥æœ‰ç‹¬ä¸€çš„partitioné›†åˆ. å³åŒä¸€ä¸ªpartitionåªä¼šåˆ†é…ç»™æ¶ˆè´¹ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€….ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æœ‰å¤šä¸ªpartition.<br>å½“æ¶ˆè´¹ç»„æˆåŠŸå¹³è¡¡å,æ‰€æœ‰æ³¨å†Œçš„topicsçš„æ¯ä¸ªpartitionéƒ½ä¼šè¢«å”¯ä¸€çš„æ¶ˆè´¹è€…æ‹¥æœ‰(æ¯ä¸ªpartitionéƒ½ä¼šè¢«åˆ†é…ç»™æ¶ˆè´¹è€…å»æ¶ˆè´¹)<br>æ¯ä¸ªBrokerèŠ‚ç‚¹ä¼šè¢«é€‰ä¸¾ä¸ºä¸€éƒ¨åˆ†æ¶ˆè´¹ç»„çš„åè°ƒèŠ‚ç‚¹,æ¶ˆè´¹ç»„çš„åè°ƒèŠ‚ç‚¹è´Ÿè´£åœ¨ç»„æˆå‘˜å˜åŒ–,æˆ–è€…æ³¨å†Œçš„topicsçš„partitionå˜åŒ–æ—¶è¿›è¡Œåè°ƒ<br>åè°ƒèŠ‚ç‚¹åŒæ—¶è´Ÿè´£åœ¨å¹³è¡¡æ“ä½œæ—¶, å°†partitionçš„æ‰€æœ‰æƒé…ç½®ä¿¡æ¯(partitionåˆ†é…ç»™å“ªä¸ªæ¶ˆè´¹è€…)åœ¨æ‰€æœ‰consumersä¹‹é—´è¿›è¡Œäº¤æµ  </p>
<p>Consumeræ¶ˆè´¹è€…çš„å·¥ä½œè¿‡ç¨‹:<br>1.åœ¨å¯åŠ¨æ˜¯æˆ–è€…åè°ƒèŠ‚ç‚¹æ•…éšœè½¬ç§»æ—¶,æ¶ˆè´¹è€…å‘é€ConsumerMetadataRequest(GroupCoordinatorRequest)ç»™bootstrap.brokersåˆ—è¡¨ä¸­çš„<br>ä»»æ„ä¸€ä¸ªbrokers.åœ¨ConsumerMetadataResponse(GroupCoordinatorResponse)ä¸­,å®ƒæ¥æ”¶æ¶ˆè´¹è€…å¯¹åº”çš„æ¶ˆè´¹ç»„æ‰€å±çš„åè°ƒèŠ‚ç‚¹çš„ä½ç½®ä¿¡æ¯<br>2.æ¶ˆè´¹è€…è¿æ¥åè°ƒèŠ‚ç‚¹,å¹¶å‘é€HeartbeatRequest.å¦‚æœè¿”å›çš„HeartbeatResponseä¸­è¿”å›IllegalGenerationé”™è¯¯ç ,è¯´æ˜åè°ƒèŠ‚ç‚¹å·²ç»åœ¨åˆå§‹åŒ–å¹³è¡¡.<br>æ¶ˆè´¹è€…å°±ä¼šåœæ­¢æŠ“å–æ•°æ®,æäº¤offsets,å‘é€JoinGroupRequestç»™åè°ƒèŠ‚ç‚¹. åœ¨JoinGroupResponse,å®ƒæ¥æ”¶æ¶ˆè´¹è€…åº”è¯¥æ‹¥æœ‰çš„topic-partitionsåˆ—è¡¨<br>ä»¥åŠå½“å‰æ¶ˆè´¹ç»„çš„æ–°çš„generationç¼–å·. è¿™ä¸ªæ—¶å€™æ¶ˆè´¹ç»„ç®¡ç†å·²ç»å®Œæˆ,æ¶ˆè´¹è€…å°±å¯ä»¥å¼€å§‹æŠ“å–æ•°æ®,å¹¶ä¸ºå®ƒæ‹¥æœ‰çš„partitionsæäº¤offsets<br>3.å¦‚æœHeartbeatResponseæ²¡æœ‰é”™è¯¯è¿”å›,æ¶ˆè´¹è€…ä¼šä»å®ƒä¸Šæ¬¡æ‹¥æœ‰çš„partitionsåˆ—è¡¨ç»§ç»­æŠ“å–æ•°æ®,è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸ä¼šè¢«ä¸­æ–­çš„.  </p>
<p>Co-ordinatoråè°ƒèŠ‚ç‚¹çš„å·¥ä½œè¿‡ç¨‹:<br>1.åœ¨ç¨³å®šçŠ¶æ€ä¸‹,åè°ƒèŠ‚ç‚¹é€šè¿‡æ•…éšœæ£€æµ‹åè®®è·Ÿè¸ªæ¯ä¸ªæ¶ˆè´¹ç»„ä¸­æ¯ä¸ªæ¶ˆè´¹è€…çš„å¥åº·çŠ¶å†µ.<br>2.åœ¨é€‰ä¸¾å’Œå¯åŠ¨æ—¶,åè°ƒèŠ‚ç‚¹è¯»å–å®ƒç®¡ç†çš„æ¶ˆè´¹ç»„åˆ—è¡¨,ä»¥åŠä»ZKä¸­è¯»å–æ¯ä¸ªæ¶ˆè´¹ç»„çš„æˆå‘˜ä¿¡æ¯.å¦‚æœä¹‹å‰æ²¡æœ‰æˆå‘˜ä¿¡æ¯,å®ƒä¸ä¼šåšä»»ä½•åŠ¨ä½œ.<br>åªæœ‰åœ¨åŒä¸€ä¸ªæ¶ˆè´¹ç»„çš„ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…æ³¨å†Œè¿›æ¥æ—¶,åè°ƒèŠ‚ç‚¹æ‰å¼€å§‹å·¥ä½œ(å³å¼€å§‹åŠ è½½æ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…æˆå‘˜ä¿¡æ¯).<br>3.å½“åè°ƒèŠ‚ç‚¹å®Œå…¨åŠ è½½å®Œå®ƒæ‰€è´Ÿè´£çš„æ¶ˆè´¹ç»„åˆ—è¡¨çš„æ‰€æœ‰ç»„æˆå‘˜ä¹‹å‰,å®ƒä¼šåœ¨ä»¥ä¸‹å‡ ç§è¯·æ±‚çš„å“åº”ä¸­è¿”å›CoordinatorStartupNotCompleteé”™è¯¯ç :<br>HeartbeatRequest,OffsetCommitRequest,JoinGroupRequest.è¿™æ ·æ¶ˆè´¹è€…å°±ä¼šæœæ–­æ—¶é—´é‡è¯•(ç›´åˆ°å®Œå…¨åŠ è½½,æ²¡æœ‰é”™è¯¯ç è¿”å›ä¸ºæ­¢).<br>4.åœ¨é€‰ä¸¾æˆ–å¯åŠ¨æ—¶,åè°ƒèŠ‚ç‚¹ä¼šå¯¹æ¶ˆè´¹ç»„ä¸­çš„æ‰€æœ‰æ¶ˆè´¹è€…è¿›è¡Œæ•…éšœæ£€æµ‹. æ ¹æ®æ•…éšœæ£€æµ‹åè®®è¢«åè°ƒèŠ‚ç‚¹æ ‡è®°ä¸ºDeadçš„æ¶ˆè´¹è€…ä¼šä»æ¶ˆè´¹ç»„ä¸­ç§»é™¤<br>è¿™ä¸ªæ—¶å€™åè°ƒèŠ‚ç‚¹ä¼šä¸ºDeadçš„æ¶ˆè´¹è€…æ‰€å±çš„æ¶ˆè´¹ç»„è§¦å‘ä¸€ä¸ªå¹³è¡¡æ“ä½œ(æ¶ˆè´¹è€…Deadä¹‹å,è¿™ä¸ªæ¶ˆè´¹è€…æ‹¥æœ‰çš„partitionéœ€è¦å¹³è¡¡ç»™å…¶ä»–æ¶ˆè´¹è€…).<br>5.å½“HeartbeatResponseè¿”å›IllegalGenerationé”™è¯¯ç ,å°±ä¼šè§¦å‘å¹³è¡¡æ“ä½œ. ä¸€æ—¦æ‰€æœ‰å­˜æ´»çš„æ¶ˆè´¹è€…é€šè¿‡JoinGroupRequestsé‡æ–°æ³¨å†Œåˆ°åè°ƒèŠ‚ç‚¹<br>åè°ƒèŠ‚ç‚¹ä¼šå°†æœ€æ–°çš„partitionæ‰€æœ‰æƒä¿¡æ¯åœ¨JoinGroupResponseçš„æ¯ä¸ªæ¶ˆè´¹è€…ä¹‹é—´é€šä¿¡(åŒæ­¥),ç„¶åå°±å®Œæˆäº†å¹³è¡¡æ“ä½œ.<br>6.åè°ƒèŠ‚ç‚¹ä¼šè·Ÿè¸ªä»»ä½•ä¸€ä¸ªæ¶ˆè´¹è€…å·²ç»æ³¨å†Œçš„topicsçš„topic-partitionçš„å˜æ›´. å¦‚æœå®ƒæ£€æµ‹åˆ°æŸä¸ªtopicæ–°å¢çš„partition,å°±ä¼šè§¦å‘å¹³è¡¡æ“ä½œ.<br>å½“åˆ›å»ºä¸€ä¸ªæ–°çš„topicsä¹Ÿä¼šè§¦å‘å¹³è¡¡æ“ä½œ,å› ä¸ºæ¶ˆè´¹è€…å¯ä»¥åœ¨topicè¢«åˆ›å»ºä¹‹å‰å°±æ³¨å†Œå®ƒæ„Ÿå…´è¶£çš„topics.  </p>
<p>ä»ä¸Šé¢ä¸¤è€…çš„å·¥ä½œè¿‡ç¨‹,æˆ‘ä»¬å¤§è‡´çŸ¥é“äº†åè°ƒèŠ‚ç‚¹è´Ÿè´£ç®¡ç†æ¶ˆè´¹ç»„ä¸­çš„æ¶ˆè´¹è€….è€Œæ¶ˆè´¹è€…ä¼šå’Œåè°ƒèŠ‚ç‚¹é€šä¿¡.<br>å¦‚æœåè°ƒèŠ‚ç‚¹å‘ç”Ÿæ•…éšœè½¬ç§»,åˆ™æ¶ˆè´¹è€…éœ€è¦å¯»æ‰¾æ–°çš„åè°ƒèŠ‚ç‚¹.<br>å¦‚æœåè°ƒèŠ‚ç‚¹æ£€æµ‹åˆ°æ¶ˆè´¹è€…å‘ç”Ÿäº†æ•…éšœ,åˆ™åè°ƒèŠ‚ç‚¹è´Ÿè´£å¹³è¡¡æ“ä½œ. </p>
<h3 id="High_Level_Consumer">High Level Consumer</h3><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/Consumer+Group+Example" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/KAFKA/Consumer+Group+Example</a>  </p>
<p>high-levelæ–¹å¼çš„æ¶ˆè´¹ä¸ç”¨å…³å¿ƒoffset,å®ƒä¼šè‡ªåŠ¨çš„è¯»ZKä¸­è¿™ä¸ªConsumer Groupçš„last offset(æœ€è¿‘è¯»å–è¿‡çš„æ¶ˆæ¯).<br>å› ä¸ºæ¶ˆè´¹è€…åœ¨è¯»å–æ¶ˆæ¯å, ä¼šå°†æœ€è¿‘è¯»å–Partitionçš„offsetå†™åˆ°ZKä¸­.å†™åˆ°ZKä¸­çš„offsetåç§°æ˜¯ä»¥ConsumerGroup.  </p>
<p>ä¸€ä¸ªæ¶ˆè´¹è€…ç»„å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…,Kafkaä¸­çš„ä¸€ä¸ªPartitionåªä¼šè¢«æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹,ä½†å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹ç»„åŒæ—¶æ¶ˆè´¹.<br>ä¸‹å›¾Server1çš„Partition0(P0),ä¼šè¢«æ¶ˆè´¹ç»„Aå’Œæ¶ˆè´¹ç»„BåŒæ—¶æ¶ˆè´¹,ä½†æ˜¯æ¶ˆè´¹ç»„Aä¸­åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–æ¯”å¦‚C1(æ¶ˆè´¹ç»„Bä¹Ÿåªæœ‰C3è¯»å–).<br>é€šè¿‡è¿™ç§æ–¹å¼,å¯ä»¥å°†ä¸€ä¸ªBrokerä¸Šçš„å¤šä¸ªPartitionè´Ÿè½½åˆ°ä¸åŒçš„æ¶ˆè´¹è€…(åŒä¸€ä¸ªæ¶ˆè´¹ç»„çš„å¤šä¸ªæ¶ˆè´¹è€…).<br>æ¯”å¦‚Broker1ä¸Šæœ‰ä¸¤ä¸ªPartition(P0,P3), å¯¹äºæ¶ˆè´¹ç»„B, P0åˆ†ç»™C3,P3åˆ†ç»™C4. ä½†æ˜¯å¯¹äºæ¶ˆè´¹ç»„A,éƒ½åˆ†ç»™äº†C1.  </p>
<p><img src="http://kafka.apache.org/images/consumer-groups.png" alt="consumer_group"></p>
<p>å¯¹äºå¤šä¸ªpartitionå’Œå¤šä¸ªconsumeræœ‰ä»¥ä¸‹è¿™æ ·çš„é™åˆ¶æ¡ä»¶:  </p>
<ul>
<li>å¦‚æœconsumeræ¯”partitionå¤šï¼Œæ˜¯æµªè´¹ï¼Œå› ä¸ºkafkaçš„è®¾è®¡æ˜¯åœ¨ä¸€ä¸ªpartitionä¸Šæ˜¯ä¸å…è®¸å¹¶å‘çš„ï¼Œæ‰€ä»¥consumeræ•°ä¸è¦å¤§äºpartitionæ•° </li>
<li>å¦‚æœconsumeræ¯”partitionå°‘ï¼Œä¸€ä¸ªconsumerä¼šå¯¹åº”äºå¤šä¸ªpartitionsï¼Œè¿™é‡Œä¸»è¦åˆç†åˆ†é…consumeræ•°å’Œpartitionæ•°ï¼Œå¦åˆ™ä¼šå¯¼è‡´partitioné‡Œé¢çš„æ•°æ®è¢«å–çš„ä¸å‡åŒ€.<br>æœ€å¥½partitonæ•°ç›®æ˜¯consumeræ•°ç›®çš„æ•´æ•°å€ï¼Œæ‰€ä»¥partitionæ•°ç›®å¾ˆé‡è¦ï¼Œæ¯”å¦‚å–24ï¼Œå°±å¾ˆå®¹æ˜“è®¾å®šconsumeræ•°ç›® </li>
<li>å¦‚æœconsumerä»å¤šä¸ªpartitionè¯»åˆ°æ•°æ®ï¼Œä¸ä¿è¯æ•°æ®é—´çš„é¡ºåºæ€§ï¼Œkafkaåªä¿è¯åœ¨ä¸€ä¸ªpartitionä¸Šæ•°æ®æ˜¯æœ‰åºçš„ï¼Œä½†å¤šä¸ªpartitionï¼Œæ ¹æ®ä½ è¯»çš„é¡ºåºä¼šæœ‰ä¸åŒ </li>
<li>å¢å‡consumerï¼Œbrokerï¼Œpartitionä¼šå¯¼è‡´rebalanceï¼Œæ‰€ä»¥rebalanceåconsumerå¯¹åº”çš„partitionä¼šå‘ç”Ÿå˜åŒ– </li>
<li>High-levelæ¥å£ä¸­è·å–ä¸åˆ°æ•°æ®çš„æ—¶å€™æ˜¯ä¼šblockä½æ¶ˆè´¹è€…çº¿ç¨‹çš„</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">String topic = <span class="string">"page_visits"</span>;</span><br><span class="line">String group = <span class="string">"pv"</span>;</span><br><span class="line"></span><br><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.put(<span class="string">"group.id"</span>, group);</span><br><span class="line">props.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"smallest"</span>); <span class="comment">// å¿…é¡»è¦åŠ ï¼Œå¦‚æœè¦è¯»æ—§æ•°æ®</span></span><br><span class="line">props.put(<span class="string">"zookeeper.connect"</span>, <span class="string">"localhost:2181"</span>);</span><br><span class="line">props.put(<span class="string">"zookeeper.session.timeout.ms"</span>, <span class="string">"400"</span>);</span><br><span class="line">props.put(<span class="string">"zookeeper.sync.time.ms"</span>, <span class="string">"200"</span>);</span><br><span class="line">props.put(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ¶ˆè´¹è€…åˆ°Kafkaé›†ç¾¤çš„è¿æ¥(ä¸»è¦æ˜¯é€šè¿‡ZooKeeper, å› ä¸ºZKä¸­ä¸ä»…è®°å½•äº†Kafkaé›†ç¾¤çš„åœ°å€,ä¹Ÿä¿ç®¡äº†æ¯ä¸ªPartitonçš„æœ€è¿‘offset)</span></span><br><span class="line">ConsumerConfig conf = <span class="keyword">new</span> ConsumerConfig(props);</span><br><span class="line">ConsumerConnector consumer = kafka.consumer.Consumer.createJavaConsumerConnector(conf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// topicå’Œçº¿ç¨‹çš„å¯¹åº”å…³ç³», è¿™é‡Œæ”¾äº†ä¸€ä¸ªtopic, å¹¶ä¸”ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ¶ˆè´¹</span></span><br><span class="line">Map&lt;String, Integer&gt; topicCountMap = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">topicCountMap.put(topic, <span class="keyword">new</span> Integer(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…æŒ‡å®šäº†è¦æ¶ˆè´¹çš„topics, è¿”å›æ‰€æœ‰topicsçš„æ¶ˆæ¯æµ. è¿”å›çš„keyæ˜¯topicåè¯, valueæ˜¯è¿™ä¸ªtopicçš„KafkaStreamæ¶ˆæ¯æµåˆ—è¡¨</span></span><br><span class="line">Map&lt;String, List&lt;KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;&gt; consumerMap = consumer.createMessageStreams(topicCountMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–è¿™ä¸ªtopicçš„Kafkaæ¶ˆæ¯æµ, ä¸€ä¸ªtopicæ˜¯æœ‰å¤šä¸ªæ¶ˆæ¯æµçš„, å› ä¸ºä¼šä»å¤šä¸ªPartitionä¸Šè¯»å–æ¶ˆæ¯</span></span><br><span class="line">List&lt;KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; streams = consumerMap.get(topic);</span><br><span class="line">KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; stream = streams.get(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ¶ˆæ¯, ä½¿ç”¨KafkaStream, è·å¾—æµçš„è¿­ä»£å™¨, åŒ…å«äº†æ¶ˆæ¯çš„keyå’Œmessage</span></span><br><span class="line">ConsumerIterator&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; it = stream.iterator();</span><br><span class="line"><span class="keyword">while</span> (it.hasNext())&#123;</span><br><span class="line">    System.out.println(<span class="string">"message: "</span> + <span class="keyword">new</span> String(it.next().message()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…¶å®æ‰§è¡Œä¸åˆ°ï¼Œå› ä¸ºå¯¹äºhigh level,æ²¡æœ‰æ•°æ®çš„ è¯, ä¸Šé¢çš„hasNextä¼šblock</span></span><br><span class="line"><span class="keyword">if</span> (consumer != <span class="keyword">null</span>) consumer.shutdown();</span><br></pre></td></tr></table></figure>
<h3 id="Simple_Consumer">Simple Consumer</h3><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/0.8.0+SimpleConsumer+Example" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/KAFKA/0.8.0+SimpleConsumer+Example</a></p>
<p>ç”±äºhigh-level consumerä½¿ç”¨äº†ConsumerGroupæä¾›çš„è¯­ä¹‰çš„ä¸€äº›é™åˆ¶æ¡ä»¶.<br>ç”¨æˆ·å¸Œæœ›æ¯”Consumer Groupèƒ½æ›´å¥½çš„æ§åˆ¶æ•°æ®çš„æ¶ˆè´¹,è¿™æ˜¯ä½¿ç”¨Low Level Consumer(Simple Consumer)çš„ä¸»è¦åŸå› .  </p>
<ul>
<li>åŒä¸€æ¡æ¶ˆæ¯è¯»å¤šæ¬¡</li>
<li>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åªè¯»å–æŸä¸ªTopicçš„éƒ¨åˆ†Partition</li>
<li>ç®¡ç†äº‹åŠ¡ï¼Œä»è€Œç¡®ä¿æ¯æ¡æ¶ˆæ¯è¢«å¤„ç†ä¸€æ¬¡ï¼Œä¸”ä»…è¢«å¤„ç†ä¸€æ¬¡</li>
</ul>
<p>ä¸Consumer Groupç›¸æ¯”ï¼ŒLow Level Consumerè¦æ±‚ç”¨æˆ·(åº”ç”¨ç¨‹åº)åšå¤§é‡çš„é¢å¤–å·¥ä½œã€‚</p>
<ul>
<li>å¿…é¡»è·Ÿè¸ªoffsetï¼Œä»è€Œç¡®å®šä¸‹ä¸€æ¡åº”è¯¥æ¶ˆè´¹å“ªæ¡æ¶ˆæ¯(ä¸Šä¸€æ¬¡æ¶ˆè´¹åˆ°å“ªé‡Œäº†)</li>
<li>å¿…é¡»æ‰¾å‡ºæ¯ä¸ªTopicPartitionçš„Leader Brokeræ˜¯å“ªä¸ªBroker(Partitionçš„Leader)</li>
<li>å¿…é¡»å¤„ç†Broker Leaderçš„å˜åŒ–(å½“Partitionçš„Leaderå‘ç”Ÿå˜åŒ–,å¦‚ä½•è‡ªæˆ‘è°ƒæ•´)</li>
</ul>
<p>ä½¿ç”¨Low Level Consumerçš„ä¸€èˆ¬æµç¨‹å¦‚ä¸‹</p>
<ul>
<li>æŸ¥æ‰¾åˆ°ä¸€ä¸ªâ€œæ´»ç€â€çš„Brokerï¼Œå¹¶ä¸”æ‰¾å‡ºæ¯ä¸ªPartitionçš„Leader</li>
<li>æ‰¾å‡ºæ¯ä¸ªPartitionçš„Follower(Replica Brokers)</li>
<li>å®šä¹‰å¥½è¯·æ±‚ï¼Œè¯¥è¯·æ±‚åº”è¯¥èƒ½æè¿°åº”ç”¨ç¨‹åºéœ€è¦å“ªäº›æ•°æ®</li>
<li>Fetchæ•°æ®</li>
<li>è¯†åˆ«Leaderçš„å˜åŒ–ï¼Œå¹¶å¯¹ä¹‹ä½œå‡ºå¿…è¦çš„å“åº”</li>
</ul>
<h3 id="New_Consumer">New Consumer</h3><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+0.9+Consumer+Rewrite+Design" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/KAFKA/Kafka+0.9+Consumer+Rewrite+Design</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KafkaConsumer&lt;Integer, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</span><br><span class="line">consumer.subscribe(Collections.singletonList(<span class="keyword">this</span>.topic));</span><br><span class="line">ConsumerRecords&lt;Integer, String&gt; records = consumer.poll(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">for</span> (ConsumerRecord&lt;Integer, String&gt; record : records) &#123;</span><br><span class="line">    System.out.println(<span class="string">"Received message: ("</span> + record.key() + <span class="string">", "</span> + record.value() + <span class="string">") at offset "</span> + record.offset());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Partitions">Partitions</h3><p><a href="http://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/" target="_blank" rel="external">http://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/</a></p>
<p>When publishing a keyed message, Kafka deterministically maps the message to a partition based on the hash of the key. This provides a guarantee that messages with the same key are always routed to the same partition. This guarantee can be important for certain applications since messages within a partition are always delivered in order to the consumer. If the number of partitions changes, such a guaranteemay no longer hold. ä¹‹å‰è®¤ä¸ºåªç”¨ä¸€ä¸ªPartitionä¿è¯æœ‰åºæ€§ï¼Œå…¶å®è¿˜å¯ä»¥è¿™ä¹ˆå¹²..</p>
<p>The end-to-end latency in Kafka is defined by the time from when a message is published by the producer to when the message is read by the consumer. Kafka only exposes a message to a consumer after it has been committed</p>
<h2 id="Ref">Ref</h2><ul>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-kafka/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/opensource/os-cn-kafka/index.html</a></li>
<li><a href="http://bbs.umeng.com/thread-12086-1-1.html" target="_blank" rel="external">http://bbs.umeng.com/thread-12086-1-1.html</a></li>
<li><a href="http://www.aboutyun.com/forum.php?mod=viewthread&amp;tid=15812" target="_blank" rel="external">http://www.aboutyun.com/forum.php?mod=viewthread&amp;tid=15812</a></li>
</ul>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>æœ¬æ–‡æ ‡é¢˜:</span><a href="/2016/01/04/Kafka-Intro/">Introduce Kafka</a></p>
  <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="è®¿é—® ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½ çš„ä¸ªäººåšå®¢">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></p>
  <p><span>å‘å¸ƒæ—¶é—´:</span>2016å¹´01æœˆ04æ—¥ - 00æ—¶00åˆ†</p>
  <p><span>æœ€åæ›´æ–°:</span>2016å¹´03æœˆ21æ—¥ - 10æ—¶48åˆ†</p>
  <p>
    <span>åŸå§‹é“¾æ¥:</span><a href="/2016/01/04/Kafka-Intro/" title="Introduce Kafka">http://github.com/zqhxuyuan/2016/01/04/Kafka-Intro/</a>
    <span class="btn" data-clipboard-text="åŸæ–‡: http://github.com/zqhxuyuan/2016/01/04/Kafka-Intro/ã€€ã€€ä½œè€…: ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½" title="ç‚¹å‡»å¤åˆ¶æ–‡ç« é“¾æ¥">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>è®¸å¯åè®®:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="ä¸­å›½å¤§é™† (CC BY-NC-SA 3.0 CN)">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 3.0"</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "å¤åˆ¶"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2016/01/04/BookNote_Scala_doc/">
        Scala Documentation
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2016/01/04/BookNote_FP_scala/">
        Function Programming in Scala
      </a>
    </div>
  
</nav>

  
  
    <div class ="post-donate">
	<br/>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="æ‰“èµ"></a>
        <span class="donate_txt">
           &uarr;<br>
		   è¿™ä¹ˆé•¿çš„æ–‡ç« æˆ‘éƒ½è¯»å®Œäº†ï¼Œçœ‹èµ·æ¥ä½œè€…å†™çš„å¾ˆè¾›è‹¦å“‡ï¼ç»™ä½œè€…èµæ¯å’–å•¡å–ï¼Œæ”¯æŒä½œè€…ç»§ç»­å†™ä½œğŸ˜
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<img src="/img/zhifubao.png" alt="æ”¯ä»˜å®æ‰“èµ"> 
		<img src="/img/weixin.png" alt="å¾®ä¿¡æ‰“èµ">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
  
</article>

<!-- é»˜è®¤æ˜¾ç¤ºæ–‡ç« ç›®å½•ï¼Œåœ¨æ–‡ç« ---å‰è¾“å…¥toc: falseå…³é—­ç›®å½• -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">æ–‡ç« ç›®å½•</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-number">1.</span> <span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka_Replication"><span class="toc-number">2.</span> <span class="toc-text">Kafka Replication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer_Design"><span class="toc-number">3.</span> <span class="toc-text">Consumer Design</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Group_management_protocol"><span class="toc-number">3.1.</span> <span class="toc-text">Group management protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High_Level_Consumer"><span class="toc-number">3.2.</span> <span class="toc-text">High Level Consumer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Simple_Consumer"><span class="toc-number">3.3.</span> <span class="toc-text">Simple Consumer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#New_Consumer"><span class="toc-number">3.4.</span> <span class="toc-text">New Consumer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partitions"><span class="toc-number">3.5.</span> <span class="toc-text">Partitions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ref"><span class="toc-number">4.</span> <span class="toc-text">Ref</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="éšè—ç›®å½•"  title="ç‚¹å‡»æŒ‰é’®éšè—æˆ–è€…æ˜¾ç¤ºæ–‡ç« ç›®å½•">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  é€šè¿‡ç‚¹å‡»è®¾ç½®çš„æŒ‰é’®æ˜¾ç¤ºæˆ–è€…éšè—æ–‡ç« ç›®å½•.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="éšè—ç›®å½•";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="æ˜¾ç¤ºç›®å½•";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="åˆ†äº«åˆ°æ–°æµªå¾®åš"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="åˆ†äº«ç»™ QQ å¥½å‹"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="å¤åˆ¶ç½‘å€"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="é€šè¿‡é‚®ä»¶åˆ†äº«"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="ç”Ÿæˆæ–‡ç« äºŒç»´ç "></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
	<div class="ds-thread" data-thread-key="2016/01/04/Kafka-Intro/" data-title="Introduce Kafka" data-url="http://github.com/zqhxuyuan/2016/01/04/Kafka-Intro/"></div>
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="æŸ¥çœ‹è¯„è®º"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2016/01/04/BookNote_Scala_doc/" title="ä¸Šä¸€ç¯‡: Scala Documentation">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2016/01/04/BookNote_FP_scala/" title="ä¸‹ä¸€ç¯‡: Function Programming in Scala">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="å¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„é™æ€åšå®¢æ¡†æ¶">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="ç®€è€Œä¸å‡åŒæ  Hexo åšå®¢ä¸»é¢˜">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >æœ¬ç«™åˆ°è®¿æ•°: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, æœ¬é¡µé˜…è¯»é‡: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>