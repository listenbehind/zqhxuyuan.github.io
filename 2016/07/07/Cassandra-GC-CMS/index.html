<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra CMS GC | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="http://aryanet.com/blog/cassandra-garbage-collector-tuninghttp://tech.shift.com/post/74311817513/cassandra-tuning-the-jvm-for-read-heavy-workloadshttp://docs.datastax.com/en/cassandra/2.0/cassandra/op">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra CMS GC">
<meta property="og:url" content="http://github.com/zqhxuyuan/2016/07/07/Cassandra-GC-CMS/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="http://aryanet.com/blog/cassandra-garbage-collector-tuninghttp://tech.shift.com/post/74311817513/cassandra-tuning-the-jvm-for-read-heavy-workloadshttp://docs.datastax.com/en/cassandra/2.0/cassandra/op">
<meta property="og:image" content="http://img.blog.csdn.net/20151022134521140">
<meta property="og:image" content="http://img.blog.csdn.net/20151022101159811">
<meta property="og:image" content="http://img.blog.csdn.net/20151022101214392">
<meta property="og:image" content="http://img.blog.csdn.net/20151023185937620">
<meta property="og:image" content="http://img.blog.csdn.net/20151025102209440">
<meta property="og:image" content="http://img.blog.csdn.net/20151104104302323">
<meta property="og:image" content="http://img.blog.csdn.net/20151104104319137">
<meta property="og:image" content="http://img.blog.csdn.net/20151104104335018">
<meta property="og:image" content="http://img.blog.csdn.net/20151104113357712">
<meta property="og:updated_time" content="2016-07-28T09:26:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra CMS GC">
<meta name="twitter:description" content="http://aryanet.com/blog/cassandra-garbage-collector-tuninghttp://tech.shift.com/post/74311817513/cassandra-tuning-the-jvm-for-read-heavy-workloadshttp://docs.datastax.com/en/cassandra/2.0/cassandra/op">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/akka/" style="font-size: 10px;">akka</a> <a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.75px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.25px;">drill</a> <a href="/tags/druid/" style="font-size: 13.75px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 13.75px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.25px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 11.25px;">midd</a> <a href="/tags/ops/" style="font-size: 13.75px;">ops</a> <a href="/tags/redis/" style="font-size: 11.25px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.75px;">scala</a> <a href="/tags/spark/" style="font-size: 17.5px;">spark</a> <a href="/tags/storm/" style="font-size: 17.5px;">storm</a> <a href="/tags/timeseries/" style="font-size: 12.5px;">timeseries</a> <a href="/tags/work/" style="font-size: 13.75px;">work</a> <a href="/tags/流处理/" style="font-size: 11.25px;">流处理</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Cassandra-GC-CMS" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/07/Cassandra-GC-CMS/" class="article-date">
  	<time datetime="2016-07-06T16:00:00.000Z" itemprop="datePublished">2016-07-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra CMS GC
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/cassandra/">cassandra</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><a href="http://aryanet.com/blog/cassandra-garbage-collector-tuning" target="_blank" rel="external">http://aryanet.com/blog/cassandra-garbage-collector-tuning</a><br><a href="http://tech.shift.com/post/74311817513/cassandra-tuning-the-jvm-for-read-heavy-workloads" target="_blank" rel="external">http://tech.shift.com/post/74311817513/cassandra-tuning-the-jvm-for-read-heavy-workloads</a><br><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html</a></p>
<a id="more"></a>
<h3 id="GC_Background">GC Background</h3><blockquote>
<p>When tuning your garbage collection configuration, the main things you need to worry about are pause time and throughput. 关注停顿时间和吞吐量<br>Pause time is the length of time the collector stops the application while it frees up memory. 停顿是垃圾收集器释放内存,停止响应应用的时间.<br>Throughput is determined by how often the garbage collection runs, and pauses the application. 吞吐量由垃圾收集器多长时间运行一次并停止应用程序决定的.<br>The more often the collector runs, the lower the throughput. 垃圾收集器运行的越频繁, 就会降低吞吐量.  </p>
<p>the new gen is collected by the Parallel New (ParNew) collector, 新生代的对象由ParNew垃圾收集器收集<br>and the old gen is collected by the Concurrent Mark and Sweep (CMS) collector. 老年代的对象由CMS垃圾收集器收集.  </p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20151022134521140" alt="gc_memory"></p>
<blockquote>
<p>When eden fills up with new objects, a minor gc is triggered. A minor gc stops execution, iterates over the objects in eden, 当伊甸区填满新生对象,YGC被触发:它会停止应用程序的执行<br>copies any objects that are not (yet) garbage to the active survivor space, and clears eden. 迭代伊甸区的对象,拷贝所有没有被垃圾回收的对象到一个存活区中,并清理伊甸区.</p>
<p>为什么YGC发生的时候会StopTheWorld! 因为新创建new出来的对象会首先放到Eden中,现在Eden满了,新创建的对象就没有地方放了.<br>得等到Eden中的全部对象都转移到Survivor,并清空Eden, 新创建的对象才可以继续往Eden中存放.这时才从StopTheWorld中恢复过来.  </p>
<p>If an object has survived a certain number of survivor space collections, (cassandra defaults to 1), 如果一个对象在多次存活区的垃圾回收中仍存活<br>it is promoted to the old generation. Once this is done, the application resumes execution. 它就会被提升到老年代,当这个(YGC)完成时,应用程序才恢复执行.</p>
<p>If you have long ParNew pauses, it means that a lot of the objects in eden are not (yet) garbage, 如果有长时间的ParNew收集,说明很多的对象<br>and they’re being copied around to the survivor space, or into the old gen. 在伊甸区还没有被垃圾回收,就被拷贝到存活区或者老年代.  </p>
<p>什么是垃圾收集,一个很简单的理解方式是: 垃圾被收集. 这样原来被垃圾占满的空间, 被收集之后, <code>空间</code>就被释放了.<br>在收集垃圾的时候, 你是没办法做其他事情的, 因此如果收集垃圾的这个过程很长, 应用程序就会被阻塞住了,就会出现<code>超时</code>的现象.  </p>
</blockquote>
<h3 id="Cassandra_&amp;_GCInspector">Cassandra &amp; GCInspector</h3><blockquote>
<p>ParNew是YGC, 会<code>Stop The World</code>. 所以通常GC for ParNew不会超过一秒. Cassandra会打印出超过200ms的ParNew.<br>Cassandra’s GCInspector class logs information about garbage collection whenever a garbage collection takes longer than 200ms. 超过200ms的GC会被记录<br>Garbage collections that occur frequently and take a moderate length of time to complete (such as ConcurrentMarkSweep taking a few seconds), 垃圾收集频繁且缓慢<br>indicate that there is a lot of garbage collection pressure on the JVM. 说明很多的垃圾回收操作导致JVM有压力.</p>
</blockquote>
<h2 id="Problem_1:_进程假死,_很长时间的GC_for_CMS,_最终OOM_[202@2015-10-21_16:19,_21:10]">Problem 1: 进程假死, 很长时间的GC for CMS, 最终OOM [202@2015-10-21 16:19, 21:10]</h2><p>线上遇到一个问题: Cassandra进程虽然存在,但是使用status查询状态为DN. 这时查看system.log发现这段时间(进程假死)CMS的时间很长.  </p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/cassandra/system.log | grep 'GC for .*: [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>]' | grep '2015-10-21' </span><br><span class="line">cat /var/log/cassandra/system.log | grep "GC for ParNew: [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>]" | grep "2015-10-21"</span><br><span class="line">cat /var/log/cassandra/system.log | grep "GC for ConcurrentMarkSweep: [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>]" | grep "2015-10-21"</span><br></pre></td></tr></table></figure>
<p>超过1s/10s中的YGC(ParNew):<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="link_label">qihuang.zheng@cass047202 cassandra</span>]$ cat system.log | grep "GC for ParNew: [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>]" | grep "2015-10-21" | wc -l</span><br><span class="line">138</span><br><span class="line">[<span class="link_label">qihuang.zheng@cass047202 cassandra</span>]$ cat system.log | grep "GC for ParNew: [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>]" | grep "2015-10-21"</span><br><span class="line"> INFO [ScheduledTasks:1] 2015-10-21 16:19:08,479 GCInspector.java (line 116) GC for ParNew: 11158 ms for 2 collections, 14193894536 used; max is 16750411776</span><br></pre></td></tr></table></figure></p>
<p>超过10s的CMS(ConcurrentMarkSweep)<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ cat system.<span class="built_in">log</span> | grep <span class="string">"GC for ConcurrentMarkSweep: [0-9][0-9][0-9][0-9][0-9]"</span> | grep <span class="string">"2015-10-21"</span> | wc -l</span><br><span class="line"><span class="number">40</span></span><br><span class="line">[qihuang.zheng@cass047202 cassandra]$ cat system.<span class="built_in">log</span> | grep <span class="string">"GC for ConcurrentMarkSweep: [0-9][0-9][0-9][0-9][0-9]"</span> | grep <span class="string">"2015-10-21"</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">19</span>:<span class="number">08</span>,<span class="number">577</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">35447</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">1486</span>,<span class="number">5198320</span> used; max is <span class="number">1675</span>,<span class="number">0411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">31</span>,<span class="number">955</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">57793</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">1638</span>,<span class="number">9516152</span> used; max is <span class="number">1675</span>,<span class="number">0411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">21</span>:<span class="number">56</span>,<span class="number">322</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">53039</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">1668</span>,<span class="number">0865152</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">21</span>,<span class="number">821</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">58749</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">1674</span>,<span class="number">1060824</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">17</span>:<span class="number">02</span>:<span class="number">46</span>,<span class="number">410</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">1325054</span> ms <span class="keyword">for</span> <span class="number">31</span> collections, <span class="number">1650</span>,<span class="number">1107888</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">10</span>:<span class="number">56</span>,<span class="number">385</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">41123</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">1129</span>,<span class="number">1487752</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">11</span>:<span class="number">52</span>,<span class="number">609</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">34233</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">1363</span>,<span class="number">4908632</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> ...(total <span class="number">17</span> counts)</span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">39</span>:<span class="number">14</span>,<span class="number">721</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">177348</span> ms <span class="keyword">for</span> <span class="number">3</span> collections, <span class="number">1671</span>,<span class="number">3835416</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">08</span>,<span class="number">348</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">2243741</span> ms <span class="keyword">for</span> <span class="number">51</span> collections, <span class="number">1647</span>,<span class="number">0811144</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意: 这里我们只是先简单地查看下GC的情况, 具体是什么引起GC, 要结合system.log中具体的日志查看的! 同时我们统计的是比较耗时的(比如超过1s或10秒)  </p>
<p>GC for CMS是老年代的GC. 如果这种情况出现很多, 并且时间超过10s, 就会造成Cassandra进程假死的状态: 进程没有停掉, 但是状态为DN.<br>简单地分析其中的一条日志:<br>GC for ConcurrentMarkSweep: 35447 ms for 1 collections, 1486,5198320 used; max is 1675,0411776<br>收集了一次, 花费了35s, 这时候堆内存为14G, 最大值为16G. 越往后几条数据的堆内存越接近16G(从而导致OOM).   </p>
</blockquote>
<p>查看其他节点这时候的日志, 因为Gossip协议会连接到这台假死的202节点, 就会报告202节点是DOWN的:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047205 cassandra]$ cat  system.<span class="built_in">log</span> | grep <span class="string">"202 is now DOWN"</span></span><br><span class="line"></span><br><span class="line"> INFO [GossipTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">18</span>:<span class="number">22</span>,<span class="number">861</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br><span class="line"> INFO [GossipStage:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">17</span>:<span class="number">02</span>:<span class="number">45</span>,<span class="number">239</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br><span class="line"> INFO [GossipTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">10</span>:<span class="number">13</span>,<span class="number">752</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br><span class="line"> INFO [GossipTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">12</span>:<span class="number">18</span>,<span class="number">980</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br><span class="line"> ...</span><br><span class="line"> INFO [GossipTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">38</span>:<span class="number">04</span>,<span class="number">605</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br><span class="line"> INFO [GossipStage:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">08</span>,<span class="number">139</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br><span class="line"> INFO [GossipTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">26</span>,<span class="number">225</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> is now DOWN</span><br></pre></td></tr></table></figure></p>
<p>在这台假死的202节点上可以看到最终因为OOM,Cassandra进程被杀死:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ERROR [RMI TCP <span class="function"><span class="title">Connection</span><span class="params">(idle)</span></span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">17</span>:<span class="number">02</span>:<span class="number">44</span>,<span class="number">484</span> CassandraDaemon<span class="class">.java</span> (line <span class="number">258</span>) Exception <span class="keyword">in</span> thread Thread[RMI TCP <span class="function"><span class="title">Connection</span><span class="params">(idle)</span></span>,<span class="number">5</span>,RMI Runtime]</span><br><span class="line">java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">        at java<span class="class">.io</span><span class="class">.ObjectStreamClass</span><span class="class">.lookup</span>(ObjectStreamClass<span class="class">.java</span>:<span class="number">322</span>)</span><br><span class="line"></span><br><span class="line">ERROR [RMI TCP <span class="function"><span class="title">Connection</span><span class="params">(idle)</span></span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">39</span>:<span class="number">03</span>,<span class="number">802</span> CassandraDaemon<span class="class">.java</span> (line <span class="number">258</span>) Exception <span class="keyword">in</span> thread Thread[RMI TCP <span class="function"><span class="title">Connection</span><span class="params">(idle)</span></span>,<span class="number">5</span>,RMI Runtime]</span><br><span class="line">java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.Arrays</span><span class="class">.copyOfRange</span>(Arrays<span class="class">.java</span>:<span class="number">2694</span>)</span><br><span class="line"></span><br><span class="line">ERROR [ReadStage:<span class="number">41</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">43</span>:<span class="number">07</span>,<span class="number">512</span> CassandraDaemon<span class="class">.java</span> (line <span class="number">258</span>) Exception <span class="keyword">in</span> thread Thread[ReadStage:<span class="number">41</span>,<span class="number">5</span>,main]</span><br><span class="line">java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">        at java<span class="class">.nio</span><span class="class">.ByteBuffer</span><span class="class">.allocate</span>(ByteBuffer<span class="class">.java</span>:<span class="number">331</span>)</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.MappedFileDataInput</span><span class="class">.readBytes</span>(MappedFileDataInput<span class="class">.java</span>:<span class="number">146</span>)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>旧生代(Old Gen)空间只有在<code>新生代对象转入</code>及<code>创建大对象</code>(大对象不会在新生代中,会直接转到旧生代)才会出现不足的现象，<br>当执行<code>Full GC后老年代空间仍然不足</code>，则抛出如下错误：java.lang.OutOfMemoryError: Java heap space  </p>
<p>新生代对象要转入到老年代中, 但是老年代的空间不足以存放新生代的对象, 因此需要首先对老年代进行一次FGC(还是CMS GC?)<br>当FGC完成后, 就可以把新生代对象转入了. 但是但是如果FGC后, 老年代的空间还是不够新生代的转入,就报堆内存不足OOM了!  </p>
</blockquote>
<p>分析问题的入口点是: 什么引起很长时间的GC, 因为GC, 最终导致OOM.  </p>
<h3 id="Zabbix监控">Zabbix监控</h3><p>上面的日志显示在16:19 - 17:02这段时间发生了频繁的FGC,并且时间都很长. 同样的情况发生在21:10 - 22:43.<br>下图分别是堆内存的使用情况以及CMS老年代占用的大小. 可以看到这两个时间段都没有数据显示出来.  </p>
<p><img src="http://img.blog.csdn.net/20151022101159811" alt="c_heap">  </p>
<blockquote>
<p>从Heap的趋势可以看到一旦到达12G,就有个下降的趋势,然后继续上升. 回想垃圾收集的原理:垃圾被收集后,空间被释放!<br>这是因为最大Heap内存为16G,在达到0.75*16G=12G时发生CMS GC(下图), GC完成后, 堆内存就被释放.<br><code>-Xms16G -Xmx16G</code> -Xmn4G -XX:MaxDirectMemorySize=6G -XX:+HeapDumpOnOutOfMemoryError -Xss256k<br>-XX:StringTableSize=1000003 -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled<br>-XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=1 -XX:CMSInitiatingOccupancyFraction=<code>75</code><br>-XX:+UseCMSInitiatingOccupancyOnly -XX:+UseTLAB -XX:+UseCondCardMark<br>最大堆内存=16G, 新生代内存=4G, 新生代中Edeng占比80%=3276MB.   </p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20151022101214392" alt="c_cms"></p>
<blockquote>
<p>当达到老年代的75%, CMS收集器就开始运行. 老年代大小=12G, *0.75=9G. 所以上图在9G时有个下降的趋势.<br>When a pre-determined percentage of the old generation is full (75% by default in cassandra), the CMS collector is run.  </p>
</blockquote>
<p>Heap堆内存的使用和Old Gen的大小是同向的. 因为老年代内存增加,会占用更多的堆内存. 老年代收集器运行完成后, 释放老年代空间, 就减少了堆内存.  </p>
<p><img src="http://img.blog.csdn.net/20151023185937620" alt="202-jvm"></p>
<blockquote>
<p>上图是更完整的GC信息. 淡绿色的是CMS Perm Gen. 这个区域是永久区,不会有很大的变化, 所以可以看到最大值和平均值都只是在27MB.<br>蓝色的Par Eden区是新创建的对象, 最小值32M, 最大值3.2G. 这是因为Eden为空时,刚创建的对象没几个,所以很小. 当Eden填满时, 达到最大值.<br>那么Eden的容量是多大, 可以通过jstat -gc pid查看.  Eden和Survivor的比例是8:1, 所以Survivor的大小是400M. ParNew的总大小=3.2+800M=4G.<br>淡蓝色的Par Survivor的最大值是409Mb. 可见上面我们的推论也是正确的. 因为Survivor和Eden一样都有一个清空的过程, 所以最小值都是很小的.<br>最后一个橘黄色的是CMS老年代. 最大值为10.4G(和上面我们说的9G有差别啊,不过这只是个别情况).  老年代的10G+新生代的4G接近堆内存最大值的16G.  </p>
<p>上图基本上是很多个山峰的形状. 说明了:<br>1.随着对象的不断创建, 对象会先后在Eden, Survivor, Old中存活.<br>2.对象创建,就会消耗一定的内存(堆内存会不断增加), 对象首先在新生代中存活.<br>3.在Survivor中存活的对象被提升到老年代(因此老年代的内存增加也会导致堆内存不断增加).<br>4.老年代垃圾收集完成后, 堆内存会被释放(堆内存减少的比较明显,因为老年代的大小比较大,收集之后释放的空间也比较多).   </p>
</blockquote>
<h3 id="system-log_&amp;_gc-log_关于GC的吻合">system.log &amp; gc.log 关于GC的吻合</h3><p>在21号202节点一共当过(其实都是假死)三次,并重启. 在<code>重启之前(并不是进程当掉的时候)</code>会产生一个新的gc日志文件用于<code>下一个时间段</code>.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ ll -h</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">2.5</span>G <span class="number">10</span>月 <span class="number">21</span> <span class="number">10</span>:<span class="number">57</span> gc-<span class="number">1442762094.l</span>og   在<span class="number">10</span>:<span class="number">57</span>分重启下, 这里包含了<span class="number">21</span>好之前的所有gc日志,所以日志文件很大</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">22</span>M <span class="number">10</span>月 <span class="number">21</span> <span class="number">17</span>:<span class="number">02</span> gc-<span class="number">1445396282.l</span>og   <span class="number">16</span>:<span class="number">19</span>开始FGC,这时C进程还在,直到<span class="number">17</span>:<span class="number">02</span>分进程当掉,开始重启.这里日志表示<span class="number">10</span>:<span class="number">57</span>到<span class="number">17</span>:<span class="number">02</span>之间的gc日志</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">33</span>M <span class="number">10</span>月 <span class="number">21</span> <span class="number">22</span>:<span class="number">43</span> gc-<span class="number">1445418381.l</span>og   <span class="number">21</span>:<span class="number">10</span>开始FGC,在<span class="number">22</span>:<span class="number">43</span>才重启. 这里日志表示<span class="number">17</span>:<span class="number">02</span>到<span class="number">22</span>:<span class="number">43</span>之间的gc日志</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">28</span>M <span class="number">10</span>月 <span class="number">22</span> <span class="number">10</span>:<span class="number">24</span> gc-<span class="number">1445439377.l</span>og   这里表示<span class="number">22</span>:<span class="number">43</span>一直到现在的gc日志.</span><br></pre></td></tr></table></figure></p>
<p>分别查看不同的gc日志文件. GC时间超过10s的和system.log中超过10s的FGC的时间段是对应的(total time的秒数有点区别).<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ cat gc-<span class="number">1445396282.l</span>og | grep <span class="string">"2015-10-2"</span> | grep <span class="string">"Total time for which application threads were stopped: [^0][0-9].*$"</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T16:<span class="number">18</span>:<span class="number">56.346</span>+<span class="number">0800</span>: <span class="number">19252.706</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">52.9533050</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T16:<span class="number">19</span>:<span class="number">08.005</span>+<span class="number">0800</span>: <span class="number">19264.365</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">11.1686950</span> seconds</span><br><span class="line">....</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T17:<span class="number">02</span>:<span class="number">41.868</span>+<span class="number">0800</span>: <span class="number">21878.228</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">81.2595120</span> seconds</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 cassandra]$ cat gc-<span class="number">1445418381.l</span>og | grep <span class="string">"2015-10-2"</span> | grep <span class="string">"Total time for which application threads were stopped: [^0][0-9].*$"</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">10</span>:<span class="number">56.372</span>+<span class="number">0800</span>: <span class="number">14674.292</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">61.2555790</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">11</span>:<span class="number">52.177</span>+<span class="number">0800</span>: <span class="number">14730.097</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">55.4579170</span> seconds</span><br><span class="line">....</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T22:<span class="number">39</span>:<span class="number">03.800</span>+<span class="number">0800</span>: <span class="number">19961.719</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">82.8747310</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T22:<span class="number">43</span>:<span class="number">04.221</span>+<span class="number">0800</span>: <span class="number">20202.140</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">240.4117940</span> seconds</span><br></pre></td></tr></table></figure></p>
<p>观察正常的203节点发生GC for CMS情况: 会存在10几秒的, 但是不会夸张到一分钟多的.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047203 cassandra]$ cat system.<span class="built_in">log</span> | grep <span class="string">"GC for ConcurrentMarkSweep: [0-9][0-9][0-9][0-9][0-9]"</span> | grep <span class="string">"2015-10-2"</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">20</span> <span class="number">04</span>:<span class="number">54</span>:<span class="number">07</span>,<span class="number">318</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">13873</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">2258327168</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">05</span>:<span class="number">10</span>:<span class="number">31</span>,<span class="number">167</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">15803</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">3578782544</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">04</span>:<span class="number">58</span>:<span class="number">11</span>,<span class="number">610</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">13137</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">2438639584</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<p>对应的GC日志(大于10s的):  可以看到时间都能对应上.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047203 cassandra]$ cat gc-<span class="number">1441001670.l</span>og | grep <span class="string">"2015-10-2"</span> | grep <span class="string">"Total time for which application threads were stopped: [^0][0-9].*$"</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">20</span>T04:<span class="number">54</span>:<span class="number">07.168</span>+<span class="number">0800</span>: <span class="number">4286376.327</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">27.1404730</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T05:<span class="number">10</span>:<span class="number">30.907</span>+<span class="number">0800</span>: <span class="number">4373760.065</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">30.5866390</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span>T04:<span class="number">58</span>:<span class="number">11.372</span>+<span class="number">0800</span>: <span class="number">4459420.530</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">23.8347940</span> seconds</span><br></pre></td></tr></table></figure></p>
<h3 id="GC_Log分析">GC Log分析</h3><h3 id="YGC">YGC</h3><p><strong>1.一次比较短暂的GC(YGC)示例</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">05</span>:<span class="number">22.465</span>+<span class="number">0800</span>: <span class="number">14340.384</span>: [GCBefore GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">05</span>:<span class="number">22.467</span>+<span class="number">0800</span>: <span class="number">14340.386</span>: [ParNew: <span class="number">3363</span>,<span class="number">261</span>K-&gt;<span class="number">11</span>,<span class="number">273</span>K(<span class="number">3774</span>,<span class="number">912</span>K), <span class="number">0.0429780</span> secs] <span class="number">6720</span>,<span class="number">828</span>K-&gt;<span class="number">3371</span>,<span class="number">977</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line">, <span class="number">0.0464130</span> secs] [Times: user=<span class="number">0.28</span> sys=<span class="number">0.00</span>, real=<span class="number">0.04</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">05</span>:<span class="number">22.512</span>+<span class="number">0800</span>: <span class="number">14340.431</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.0502940</span> seconds</span><br></pre></td></tr></table></figure>
<p>Total time stopped=0.05的计算方式是 当前打印的时间.512 - BeforeGC=.465 = 0.047<br>可以看到在After GC之前, ParNew由3.2G减少到11M(新生代总的容量为3.7G). 并且GC时间很短, 只有0.04s. 因为是ParNew,说明这是一次YGC!  </p>
<blockquote>
<p>像这种在gc.log中的ParNew收集, 对应在system.log中就会出现GC for ParNew的日志.<br>当然gc.log对于所有的ParNew都会打印, 而system.log中只有超过200ms的才打印.<br>比如上面gc.log的时间为0.05秒=50ms, 就不会在system.log中出现.  </p>
</blockquote>
<p><strong>2.统计GC for ParNew和for CMS</strong>  </p>
<p>我们可以选择system.log中出现GC的记录, 再来找gc.log中对应的记录, 对比着分析. 这是system.log中21点所有的GC日志:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ cat system.<span class="built_in">log</span> | grep <span class="string">"GC"</span> | grep <span class="string">"2015-10-21 21"</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">31</span>,<span class="number">882</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">672</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">9135816744</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">39</span>,<span class="number">945</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">372</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9325350800</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">42</span>,<span class="number">106</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">247</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9448812016</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">19</span>,<span class="number">142</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">267</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9969463696</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">56</span>,<span class="number">802</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">1549</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">10679738240</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">57</span>,<span class="number">783</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">750</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11082238408</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">59</span>,<span class="number">784</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">351</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11876803840</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">09</span>:<span class="number">42</span>,<span class="number">724</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">1420</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">5274947408</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">09</span>:<span class="number">45</span>,<span class="number">891</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">2342</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">7007901632</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">09</span>:<span class="number">49</span>,<span class="number">573</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">3161</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9012309600</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">09</span>:<span class="number">53</span>,<span class="number">443</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">3277</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11212220496</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">09</span>:<span class="number">54</span>,<span class="number">790</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">1142</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">12623059520</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">10</span>:<span class="number">56</span>,<span class="number">385</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">41123</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11291487752</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">11</span>:<span class="number">52</span>,<span class="number">609</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">34233</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">13634908632</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">13</span>:<span class="number">14</span>,<span class="number">546</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">50091</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16324832400</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">14</span>:<span class="number">39</span>,<span class="number">080</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">53386</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16329236976</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">16</span>:<span class="number">02</span>,<span class="number">382</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">51146</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16327015232</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">17</span>:<span class="number">26</span>,<span class="number">713</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">50636</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16331153704</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">18</span>:<span class="number">55</span>,<span class="number">963</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">54231</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16330768976</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">20</span>:<span class="number">20</span>,<span class="number">116</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">50762</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16393698912</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">21</span>:<span class="number">49</span>,<span class="number">551</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">56023</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16542754632</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">23</span>:<span class="number">16</span>,<span class="number">369</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">56855</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16668440992</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">29</span>:<span class="number">02</span>,<span class="number">054</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">232369</span> ms <span class="keyword">for</span> <span class="number">4</span> collections, <span class="number">16133717848</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">30</span>:<span class="number">31</span>,<span class="number">795</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">53874</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16326381000</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">31</span>:<span class="number">56</span>,<span class="number">763</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">52632</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16438384848</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">33</span>:<span class="number">25</span>,<span class="number">591</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">55474</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16543840528</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">34</span>:<span class="number">51</span>,<span class="number">572</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">54773</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16613439072</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">39</span>:<span class="number">14</span>,<span class="number">721</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">177348</span> ms <span class="keyword">for</span> <span class="number">3</span> collections, <span class="number">16713835416</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<p>观察下面几个时间点的used. 在03:57的CMS和03:59的ParNew时, used是增加的, 但是接下来的09:42,则一下子降到了5G. 具体原因是CMS收集释放了老年代内存.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">03</span>:<span class="number">57</span>,<span class="number">783</span> GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">750</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11082238408</span> used; max is <span class="number">16750411776</span></span><br><span class="line"><span class="number">21</span>:<span class="number">03</span>:<span class="number">59</span>,<span class="number">784</span> GC <span class="keyword">for</span> ParNew: <span class="number">351</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11876803840</span> used; max is <span class="number">16750411776</span></span><br><span class="line">... 这中间虽然没有GC <span class="keyword">for</span> ..., 但是有CMS的日志. 我们上面这么过滤只查询GC,所以没有CMS的日志出来.  </span><br><span class="line"><span class="number">21</span>:<span class="number">09</span>:<span class="number">42</span>,<span class="number">724</span> GC <span class="keyword">for</span> ParNew: <span class="number">1420</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">5274947408</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3.对比gc.log</strong>   </p>
<blockquote>
<p>通常来说gc.log中打印的Total time stopped会比GC for 的时间要长. 这是因为stopped的时间不仅仅包括GC. GC for ParNew跟[ParNew: ** secs]比较接近.   </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">31.202</span>+<span class="number">0800</span>: <span class="number">14169.122</span>: [GCBefore GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">31.203</span>+<span class="number">0800</span>: <span class="number">14169.122</span>: [ParNew: <span class="number">3365</span>,<span class="number">222</span>K-&gt;<span class="number">12</span>,<span class="number">415</span>K(<span class="number">3774</span>,<span class="number">912</span>K), <span class="number">0.4782790</span> secs] <span class="number">12265</span>,<span class="number">316</span>K-&gt;<span class="number">8916</span>,<span class="number">561</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">31.682</span>+<span class="number">0800</span>: <span class="number">14169.601</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.4870030</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">39.570</span>+<span class="number">0800</span>: <span class="number">14177.489</span>: [GCBefore GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">39.571</span>+<span class="number">0800</span>: <span class="number">14177.490</span>: [ParNew: <span class="number">3368051</span>K-&gt;<span class="number">178376</span>K(<span class="number">3774912</span>K), <span class="number">0.3727510</span> secs] <span class="number">12288868</span>K-&gt;<span class="number">9106223</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">39.944</span>+<span class="number">0800</span>: <span class="number">14177.863</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.3774920</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">41.857</span>+<span class="number">0800</span>: <span class="number">14179.776</span>: [GCBefore GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">41.857</span>+<span class="number">0800</span>: <span class="number">14179.777</span>: [ParNew: <span class="number">3533896</span>K-&gt;<span class="number">126378</span>K(<span class="number">3774912</span>K), <span class="number">0.2469170</span> secs] <span class="number">12461743</span>K-&gt;<span class="number">9226735</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">02</span>:<span class="number">42.105</span>+<span class="number">0800</span>: <span class="number">14180.024</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.2506860</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">55.249</span>+<span class="number">0800</span>: <span class="number">14253.168</span>: [GCBefore GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">55.249</span>+<span class="number">0800</span>: <span class="number">14253.169</span>: [ParNew: <span class="number">3416062</span>K-&gt;<span class="number">419392</span>K(<span class="number">3774912</span>K), <span class="number">1.5487250</span> secs] <span class="number">12664844</span>K-&gt;<span class="number">10423713</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">56.799</span>+<span class="number">0800</span>: <span class="number">14254.718</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">1.5529860</span> seconds</span><br></pre></td></tr></table></figure>
<p><strong>4.jstat -gc查看YGC引起的堆内存变化</strong>  </p>
<p><a href="http://www.importnew.com/1993.html" target="_blank" rel="external">http://www.importnew.com/1993.html</a><br><code>新生代（Young generation）</code>: 绝大多数最新被创建的对象会被分配到这里，由于大部分对象在创建后会很快变得不可到达，<br>所以很多对象被创建在新生代，然后消失。对象从这个区域消失的过程我们称之为”minor GC“。</p>
<p><code>老年代（Old generation）</code>: 对象没有变得不可达，并且从新生代中存活下来，会被拷贝到这里。其所占用的空间要比新生代多。<br>也正由于其相对较大的空间，发生在老年代上的GC要比新生代少得多。对象从老年代中消失的过程，我们称之为”major GC”或full GC  </p>
<p>新生代其中一个存活区一直是空的(<code>下图第一次YGC前,S1=0</code>)，是eden区和另一个存活区(<code>S0,不为0</code>)在<code>下一次copy collection后活着的对象</code>的目的地.<br>对象<code>在存活区被复制(从from survivor复制到to survivor)</code>直到转移到老年代, 晋升的依据是对象的年龄计数器, 达到计数器阈值, 即可晋升到老年代.  </p>
<p>Minor GC(YGC)会把Eden中的所有活的对象都移到Survivor区中，如果Survivor区中放不下，那么剩下的活的对象就被移到Old Gen中.  </p>
<blockquote>
<p>在垃圾回收时，eden空间中的存活对象会被复制到未使用的survivor空间中(假设是to)，<br>正在使用的survivor空间(假设是from)中的年轻对象(年龄计数器小于阈值)也会被复制到to空间中.<br>大对象，或者老年对象(年龄计数器超过阈值)会直接进入老年代，<code>如果to空间已满，则对象也会直接进入老年代</code>。<br>此时，eden空间和from空间中的剩余对象就是垃圾对象，可以直接清空，to空间则存放此次回收后的存活对象。</p>
</blockquote>
<p>如果对象在Eden出生并经过第一次Minor GC后仍然存活，并且能被Survivor容纳的话，将被移动到Survivor空间中，并将对象年龄设为1.<br>对象在Survivor区中每熬过一次Minor GC，年龄就增加1岁，当它的年龄增加到一定程度（默认为15岁）时，就会被晋升到老年代中.  </p>
<blockquote>
<p>当新生代空间不足时发生minor gc(YGC),根据复制算法, jvm会<br>1）将eden和from survivor(<code>下图中是S0</code>)中存活的对象拷贝到to survior(<code>S1</code>)中，<br>2）释放eden和from中的所有需要回收对象(<code>S0U和EU都被清空=0</code>)，<br>3）调换from/to survior，jvm将eden和新的from survior(<code>现在from是S1了,下一次拷贝E和S1到to survivor:S0</code>)作为新生代  </p>
</blockquote>
<p>查看新生代内存以及老年代内存之间的变化, 可以使用下面的命令每隔100毫秒打印一次GC信息:<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin jstat -gc `sudo -u admin jps | grep CassandraDaemon |awk '&#123;print $1&#125;'` 100</span><br><span class="line"></span><br><span class="line"> S0C     S1C      S0U      S1U   EC        EU        OC         OU         PC      PU      YGC    YGCT      FGC    FGCT   GCT</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">16805.3</span>  0.0   <span class="number">3355520.0</span> <span class="number">2174554.4</span> <span class="number">12582912.0</span> <span class="number">7490006.5</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">874 5399</span>.166  310    <span class="number">91.654 54</span>90.820</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">16805.3</span>  0.0   <span class="number">3355520.0</span> <span class="number">2457122.2 125</span><span class="number">82912.0 74</span><span class="number">90006.5</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">874 5399</span>.166  310    <span class="number">91.654 54</span>90.820</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">16805.3</span>  0.0   <span class="number">3355520.0</span> <span class="number">2794739.1</span> <span class="number">12582912.0</span> <span class="number">7490006.5</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">874 5399</span>.166  310    <span class="number">91.654 54</span>90.820</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">16805.3</span>  0.0   <span class="number">3355520.0</span> <span class="number">3066774.6</span> <span class="number">12582912.0</span> <span class="number">7490006.5</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">874 5399</span>.166  310    <span class="number">91.654 54</span>90.820</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">16805.3</span>  0.0   <span class="number">3355520.0</span> <span class="number">3207202.1</span> <span class="number">12582912.0</span> <span class="number">7490006.5</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">874 5399</span>.166  310    <span class="number">91.654 54</span>90.820  ①</span><br><span class="line"></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">7578.0 33</span><span class="number">55520.0</span>   0.0    <span class="number">12582912.0</span> <span class="number">7494329.9</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">875 5399</span>.197  310    <span class="number">91.654 54</span>90.851  ②</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">7578.0 33</span><span class="number">55520.0 141</span><span class="number">496.6 125</span><span class="number">82912.0 74</span><span class="number">94329.9</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">875 5399</span>.197  310    <span class="number">91.654 54</span>90.851</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">7578.0 33</span><span class="number">55520.0 49</span><span class="number">2729.4 125</span><span class="number">82912.0 74</span><span class="number">94329.9</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">875 5399</span>.197  310    <span class="number">91.654 54</span>90.851</span><br><span class="line">...</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">7578.0 33</span><span class="number">55520.0 29</span><span class="number">93116.6 125</span><span class="number">82912.0 74</span><span class="number">94329.9</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">875 5399</span>.197  310    <span class="number">91.654 54</span>90.851</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">7578.0 33</span><span class="number">55520.0 32</span><span class="number">15684.2 125</span><span class="number">82912.0 74</span><span class="number">94329.9</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">875 5399</span>.197  310    <span class="number">91.654 54</span>90.851</span><br><span class="line"></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">16224.9</span>  0.0   <span class="number">3355520.0</span>   0.0    <span class="number">12582912.0</span> <span class="number">7498158.7</span>  <span class="number">46492.0 27</span><span class="number">829.5 138</span><span class="number">876 5399</span>.248  310    <span class="number">91.654 54</span>90.902</span><br></pre></td></tr></table></figure></p>
<p>① 第一次YGC之前, EU不断增大(伊甸区不断创建新对象), 因为还没有发生YGC, 所以OU,S0U都没有变化. S0U是上一次YGC的to survivor.<br>② 发生YGC时, <code>Eden中存活的对象转入S1, S0中存活的对象转入Old</code>. 因为Cassandra的对象年龄计数器=1, 只要在Survivor中存活过一次,就<code>有机会</code>晋升到老年代.  </p>
<p>Cassandra的对象年龄计数器默认是1: <code>-XX:MaxTenuringThreshold=1</code>. 即对象在第一次YGC时,进入到Survivor,这时计数器=1.<br><strong>1) 当下一次YGC时,对象如果还存活,则计数器=2,超过MaxTenuringThreshold=1的阈值, 于是被晋升到了老年代中.</strong><br><strong>2) 还是说: 当第一次YGC时, 因为年龄计数器=1, 满足MaxTenuringThreshold=1的阈值条件了, 就马上被转移到老年代?</strong>  </p>
<p>结论: <strong>XX:MaxTenuringThreshold=1 指的是<code>GC的次数</code>, 对象存活的年龄计数器<code>&gt;</code>GC次数时,才会被转移到老年代, 等于时并没有转移.</strong>  </p>
<blockquote>
<p>对象年龄计数器引起从Survivor到Old:<br>1) 第二次YGC时转移:<br>以第一次YGC为例, ①在YGC之前中S0U的对象计数器=1, ②当发生YGC时,S0U中存活的对象会被拷贝到S1U中,并且这些对象的年龄计数器=2.<br>同时S1U中还包括了从Eden中存活的对象,这些对象的年龄计数器=1. 即S1包括了从Eden和经过一次YGC后在S0中仍存活的对象.<br>而S0中存活的对象年龄计数器=2超过阈值=1, 因此会被转移到老年代中. 所以S1中剩下的只是从Eden中存活的对象(计数器=1).<br>因此在阈值为1的情况, 可以认为: <code>在YGC时, S0中可存活的对象直接转移到Old, Eden中可存活的对象转移到S1</code>.<br>实际上不能说S0直接转移到了Old, S0中的对象需要经过YGC之后, 才能判断是否存活, 并拷贝到S1.<br>如果存活,对象计数器才增加, 这时再判断是否超过GC的阈值, 如果超过阈值,才将S1中存活的对象再转移到老年代.   </p>
<p>在这次YGC时, 老年代内存增加了: 7494329.9-7490006.5=4323.4. 说明有4M的对象被晋升到老年代.<br>按照上面的结论, 这4M的数据都是从S0的16M中过来的, 说明S0中有12M的对象被垃圾回收了. 同时S1的7M对象则全部来自于Eden中存活的对象.<br>在第二次的YGC时, 老年代内存增加了7498158-7494329=3828K=3M, 这些增加的对象是来源于上一次YGC的S1:7528.<br>说明第二次的YGC, 有7528-3828=3700被垃圾回收了. 同时S0的16M对象也是全部来自于第二次的Eden中存活的对象.<br>那么我们还能得出一个结论: <code>每次YGC后Old增加的内存总是来自于上一次的Survivor中存活的对象,它不会超过这个Survivor的大小</code>.  </p>
<p>2) 第一次YGC时就转移:<br>因为MaxTenuringThreshold=1, 所以在第一次YGC时, 从Eden中存活的对象能够到Survivor, 这些对象的年龄计数器=1, 满足条件, 就立马被转移到老年代了.<br>那么相当于Eden中的存活对象,首先被复制到Survivor, 然后因为达到年龄计数器阈值, Survivor中的这些对象又被转移到Old.<br>也就是说Survivor最终不会保留从Eden过来的存活对象. 但是从上面的gc日志查看Survivor是有空间的. 所以这种说法是错误的.   </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ sudo -u admin jstat -gc `sudo -u admin jps | grep CassandraDaemon |awk '&#123;print $1&#125;'` 300 | awk '&#123;printf("%10s\t%10s\t%10s\t%10s\t%10s\t\n",$3,$4,$6,$8,$11)&#125;'</span><br><span class="line">       S0U         S1U          EU          OU         YGC    Old Increment</span><br><span class="line">       0.0      7596.6         0.0   <span class="number">8280664.8</span>      210091    </span><br><span class="line">       0.0      7596.6   <span class="number">3330543.3</span>   <span class="number">8280664.8</span>      210092</span><br><span class="line">   <span class="number">13250.2</span>         0.0    <span class="number">735411.8</span>   <span class="number">8283003.0</span>      210092    <span class="number">3000&lt;7596</span></span><br><span class="line">   <span class="number">13250.2</span>         0.0   <span class="number">2846976.6</span>   <span class="number">8283003.0</span>      210092</span><br><span class="line">       0.0      6458.5    <span class="number">162674.7</span>   <span class="number">8288867.9</span>      210093    <span class="number">5800&lt;13250</span>    </span><br><span class="line">       0.0      6458.5   <span class="number">3162963.9</span>   <span class="number">8288867.9</span>      210093</span><br><span class="line">    6035.6         0.0    <span class="number">446169.8</span>   <span class="number">8291703.2</span>      210094    <span class="number">2836&lt;6458</span></span><br><span class="line">    6035.6         0.0   <span class="number">3171635.2</span>   <span class="number">8291703.2</span>      210094   </span><br><span class="line">       0.0      9745.3    <span class="number">595891.9</span>   <span class="number">8294672.9</span>      210095    <span class="number">3000&lt;6035</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>是否需要修改MaxTenuringThreshold的值</strong><br><a href="http://stackoverflow.com/questions/21992943/persistant-gc-issues-with-cassandra-long-app-pauses" target="_blank" rel="external">http://stackoverflow.com/questions/21992943/persistant-gc-issues-with-cassandra-long-app-pauses</a>  </p>
<blockquote>
<p>For read/write heavy loads chances are the default tenuring threshold flag in GC setting is very low causing premature promotions.<br>Try increasing the tenuringthreshold to a large value like 32 to prevent premature promotions so that ParNew collects most garbage in young generation.</p>
<p>You can observer this tenuring problem and promotion failures by running jstat command and see how the survivor spaces in heap are utilized.<br>I bet you they are not utilized much and objects go straight from eden to old generation.</p>
</blockquote>
<p><strong>5.分析gc.log中的ParNew</strong>  </p>
<p>分析ParNew的内存变化: <code>[ParNew: 3365,222K-&gt;12,415K(3774,912K), 0.4782790 secs] 12265,316K-&gt;8916,561K(16357,824K)</code><br>括号内的分别是ParNew的总内存3774912KB(约3.6G),这个值在多次ParNew中都没有变化, 最后一个括号是堆的总内存约16G,同样多次ParNew也没有变化. 主要分析-&gt;的变化.   </p>
<blockquote>
<p>注意: 新生代的内存3774,912K的计算方式是Eden的Capacity+一个Survivor的Capacity:419392. 即3355520+419392=3774912.<br>本来以为新生代内存是Eden+2*SurvivorCapacity, 发现加起来并不等于3774912K. 所以在说新生代时,指的是<code>Eden和其中一个非空的Survivor</code>.<br><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ sudo -u <span class="literal">admin</span> jstat -gc `sudo -u <span class="literal">admin</span> jps | grep CassandraDaemon |awk '&#123;<span class="literal">print</span> <span class="variable">$1</span>&#125;'` <span class="number">100</span> <span class="number">1</span> | awk '&#123;printf(<span class="string">"%10s\t%10s\t%10s\t%10s\t\n"</span>,<span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$5</span>,<span class="variable">$7</span>)&#125;'</span><br><span class="line">       S0C         S1C          EC          OC</span><br><span class="line">  <span class="number">419392.0</span>    <span class="number">419392.0</span>   <span class="number">3355520.0</span>  <span class="number">12582912.0</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>年轻代内存减少了3365222-12415=3352807K, 总的内存减少=12265316-8916561=3348755K. 即有3352807-3348755=4052K=4M对象晋升到老年代.<br>(这些对象有部分可能是已经到了晋升的年龄，然而由于Minor GC后Survivor几乎满了，因而基本可以确定有部分对象并没有到达晋升年龄而直接晋升了)  </p>
<p>假设内存的变化是: [ParNew: A-&gt;B] C-&gt;D. 则新生代晋升到老年代的大小=D-B-(C-A) = D-C-(B-A)=A-B-(C-D)<br><img src="http://img.blog.csdn.net/20151025102209440" alt="gc-changes"></p>
<p>YGC回收后的老年代内存=回收后的堆内存-回收后的新生代内存, 因为回收后新生代只有S0=B, 所以回收后老年代内存=D-B. </p>
<table>
<thead>
<tr>
<th>Time</th>
<th>GC for ParNew</th>
<th>gc.log: ParNew</th>
<th>Total stopped</th>
<th>After YGC Old Gen Size</th>
<th>New 2 Old</th>
</tr>
</thead>
<tbody>
<tr>
<td>21:02:31</td>
<td>672ms[2]</td>
<td>0.4782s</td>
<td>0.4870s</td>
<td>8904146</td>
<td>4052</td>
</tr>
<tr>
<td>21:02:39</td>
<td>372ms</td>
<td>0.3727s</td>
<td>0.3774s</td>
<td>8927847</td>
<td>7030</td>
</tr>
<tr>
<td>21:02:42</td>
<td>247ms</td>
<td>0.2469s</td>
<td>0.2506s</td>
<td>9100357</td>
<td>172510</td>
</tr>
<tr>
<td>21:03:56</td>
<td>1549ms</td>
<td>1.5487s</td>
<td>1.5529s</td>
<td>10004321</td>
<td>755539</td>
</tr>
</tbody>
</table>
<p>YGC之后,老年代内存不断增加,因为不断会有Survivor区的对象被晋升到老年代中.<br>当然堆内存也是一直增加的,比较直观地观察老年代内存增加是使用gcutil其中O的占比不断增加<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ sudo -u admin jstat -gcutil `sudo -u admin jps | grep CassandraDaemon |awk '&#123;print $1&#125;'` 1000 10</span><br><span class="line">  S0     S1     E      O      P     YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">  1.60   0.00   0.00  62.97  <span class="number">59.86 152418</span> <span class="number">5924.029</span>   338   <span class="number">96.775 60</span>20.804</span><br><span class="line">  1.60   0.00  81.17  62.97  <span class="number">59.86 152418</span> <span class="number">5924.029</span>   338   <span class="number">96.775 60</span>20.804</span><br><span class="line">  0.00   2.24  63.60  62.99  <span class="number">59.86 152419</span> <span class="number">5924.061</span>   338   <span class="number">96.775 60</span>20.836</span><br><span class="line">  1.10   0.00  49.40  63.02  <span class="number">59.86 152420</span> <span class="number">5924.093</span>   338   <span class="number">96.775 60</span>20.868</span><br><span class="line">  0.00   1.56  32.86  63.04  <span class="number">59.86 152421</span> <span class="number">5924.126</span>   338   <span class="number">96.775 60</span>20.901</span><br><span class="line">  0.00   0.68  12.10  63.11  <span class="number">59.86 152423</span> <span class="number">5924.189</span>   338   <span class="number">96.775 60</span>20.964</span><br><span class="line">  0.00   0.68  95.35  63.11  <span class="number">59.86 152423</span> <span class="number">5924.189</span>   338   <span class="number">96.775 60</span>20.964</span><br><span class="line">  1.25   0.00  78.39  63.11  <span class="number">59.86 152424</span> <span class="number">5924.218</span>   338   <span class="number">96.775 60</span>20.993</span><br><span class="line">  0.00   1.75  62.09  63.13  <span class="number">59.86 152425</span> <span class="number">5924.250</span>   338   <span class="number">96.775 60</span>21.025</span><br></pre></td></tr></table></figure></p>
<p><strong>6.查看gc时system.log发生了什么</strong>  </p>
<p>1).选取21:02:31发生的<code>GC for ParNew: 672 ms</code>: 在GC for ParNew之前, 执行了两个SliceQueryFilter, 并且都是带有tombstone的查询.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INFO [CompactionExecutor:<span class="number">529</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">03</span>,<span class="number">193</span> CompactionTask.java (line <span class="number">299</span>) Compacted <span class="number">5</span> sstables to [/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-<span class="number">1129535</span>,].  <span class="number">751</span> bytes to <span class="number">351</span> (~<span class="number">46</span>% of original) in <span class="number">33</span>ms = <span class="number">0.010144</span>MB/s.  <span class="number">7</span> total partitions merged to <span class="number">4.</span>  Partition merge counts were &#123;<span class="number">1</span>:<span class="number">5</span>, <span class="number">2</span>:<span class="number">1</span>, &#125;</span><br><span class="line">WARN [ReadStage:<span class="number">60</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">18</span>,<span class="number">412</span> SliceQueryFilter.java (line <span class="number">231</span>) Read <span class="number">991</span> live and <span class="number">2109</span> tombstone cells in forseti.velocity (see tombstone_warn_threshold). <span class="number">1000</span> columns was requested, slices=[dafycredit:dafycredit:accountLogin:!-dafycredit:dafycredit:accountLogin]</span><br><span class="line">WARN [ReadStage:<span class="number">58</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">18</span>,<span class="number">421</span> SliceQueryFilter.java (line <span class="number">231</span>) Read <span class="number">991</span> live and <span class="number">2109</span> tombstone cells in forseti.velocity (see tombstone_warn_threshold). <span class="number">1000</span> columns was requested, slices=[dafycredit:dafycredit:accountLogin:!-dafycredit:dafycredit:accountLogin]</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">31</span>,<span class="number">882</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">672</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">9135816744</span> used; max is <span class="number">16750411776</span></span><br><span class="line">INFO [CompactionExecutor:<span class="number">530</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">36</span>,<span class="number">113</span> ColumnFamilyStore.java (line <span class="number">795</span>) Enqueuing flush of Memtable-compactions_in_progress@<span class="number">410924923</span>(<span class="number">1</span>/<span class="number">10</span> serialized/live bytes, <span class="number">1</span> ops)</span><br></pre></td></tr></table></figure></p>
<p>2).选取21:03:56发生的<code>GC for ParNew: 1549 ms</code>: 在GC前发生了一次Compaction操作, 并在之后打印了StatusLogger.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INFO [CompactionExecutor:<span class="number">506</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">02</span>:<span class="number">45</span>,<span class="number">116</span> CompactionTask.java (line <span class="number">299</span>) Compacted <span class="number">1</span> sstables to [/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-<span class="number">297051</span>,].  </span><br><span class="line"> <span class="number">163</span>,<span class="number">330</span>,<span class="number">070</span> bytes to <span class="number">161</span>,<span class="number">872</span>,<span class="number">089</span> (~<span class="number">99</span>% of original) in <span class="number">42</span>,<span class="number">087</span>ms = <span class="number">3.667956</span>MB/s.  <span class="number">132</span>,<span class="number">045</span> total partitions merged to <span class="number">130</span>,<span class="number">604.</span>  Partition merge counts were &#123;<span class="number">1</span>:<span class="number">132045</span>, &#125;</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">19</span>,<span class="number">142</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">267</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9969463696</span> used; max is <span class="number">16750411776</span></span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">56</span>,<span class="number">802</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">1549</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">10679738240</span> used; max is <span class="number">16750411776</span></span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">56</span>,<span class="number">803</span> StatusLogger.java (line <span class="number">55</span>) Pool Name                    Active   Pending      Completed   Blocked  All Time Blocked</span><br><span class="line">...</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">57</span>,<span class="number">783</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">750</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11082238408</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>上面两个比较耗时的GC for ParNew, 我们能得出的结论是跟查询带有tombstone以及Compaction操作有关. 但是具体是不是他们一起的, 还需要进一步收集更多的信息.<br>但其实system.log中发生Compaction以及查询tombstone的操作是很频繁的. 不能根据这个就认为是他们引起的GC.  </p>
</blockquote>
<p>3).紧接着在21:03:57和21:03:59执行了一次750ms的<code>GC for ConcurrentMarkSweep</code>和351ms的<code>GC for ParNew</code>:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">57</span>,<span class="number">783</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">750</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11082</span>,<span class="number">238408</span> used; max is <span class="number">16750</span>,<span class="number">411776</span></span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span> <span class="number">21</span>:<span class="number">03</span>:<span class="number">59</span>,<span class="number">784</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">351</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11876803840</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<p>看看gc.log中对应的这次CMS, 很快就完成了: 初始标记花了0.749s, 总共花了0.842s. 这次CMS并没有引起FGC. 接下来是另外一次的YGC.<br>CMS和Full GC不是一个概念! 所以下面的日志第一段中你看到了CMS…, 但是并没有Full GC.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">56.997</span>+<span class="number">0800</span>: <span class="number">14254.917</span>: [GC [<span class="number">1</span> CMS-initial-mark: <span class="number">10004321</span>K(<span class="number">12582912</span>K)] <span class="number">10725707</span>K(<span class="number">16357824</span>K), <span class="number">0.7497450</span> secs] [Times: user=<span class="number">0.74</span> sys=<span class="number">0.00</span>, real=<span class="number">0.75</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">57.747</span>+<span class="number">0800</span>: <span class="number">14255.667</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.8420690</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">57.748</span>+<span class="number">0800</span>: <span class="number">14255.667</span>: [CMS-concurrent-mark-start]</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">58.943</span>+<span class="number">0800</span>: <span class="number">14256.862</span>: [GCBefore GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">58.943</span>+<span class="number">0800</span>: <span class="number">14256.862</span>: [ParNew: <span class="number">3774</span>,<span class="number">912</span>K-&gt;<span class="number">310</span>,<span class="number">526</span>K(<span class="number">3774912</span>K), <span class="number">0.3513860</span> secs] <span class="number">13779233</span>K-&gt;<span class="number">10596099</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">59.295</span>+<span class="number">0800</span>: <span class="number">14257.214</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.3553810</span> seconds</span><br></pre></td></tr></table></figure></p>
<p>将CMS出现的上下几条关于ParNew进行对比, 会看到21:09:41总的堆总内存由上一次的10596099K减少到5092663K.<br>可见21:03:56的CMS肯定是发挥了作用: 因为CMS垃圾收集会释放老年代的空间, 从而减少堆内存的占用.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">56.997</span>+<span class="number">0800</span>: <span class="number">14254.917</span>: [GC [<span class="number">1</span> CMS-initial-mark: <span class="number">10004</span>,<span class="number">321</span>K(<span class="number">12582912</span>K)] <span class="number">10725707</span>K(<span class="number">16357824</span>K), <span class="number">0.7497450</span> secs] [Times: user=<span class="number">0.74</span> sys=<span class="number">0.00</span>, real=<span class="number">0.75</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">58.943</span>+<span class="number">0800</span>: <span class="number">14256.862</span>: [ParNew: <span class="number">3774</span>,<span class="number">912</span>K-&gt;<span class="number">310</span>,<span class="number">526</span>K(<span class="number">3774912</span>K), <span class="number">0.3513860</span> secs] <span class="number">13779233</span>K-&gt;<span class="number">10596099</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line">... 这中间是有CMS日志的, 见下文 </span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">41.291</span>+<span class="number">0800</span>: <span class="number">14599.210</span>: [ParNew: <span class="number">3374</span>,<span class="number">088</span>K-&gt;<span class="number">419</span>,<span class="number">392</span>K(<span class="number">3774912</span>K), <span class="number">1.4201840</span> secs] <span class="number">7553474</span>K-&gt;<span class="number">5092663</span>K(<span class="number">16357824</span>K)After GC:</span><br></pre></td></tr></table></figure></p>
<p>4).CMS GC, not trigger FGC</p>
<p>理解CMS GC日志: <a href="https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs" target="_blank" rel="external">https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs</a><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">56.997</span>+<span class="number">0800</span>: <span class="number">14254.917</span>: [GC [<span class="number">1</span> 👉CMS-initial-mark: <span class="number">10004321</span>K(<span class="number">12582912</span>K)] <span class="number">10725707</span>K(<span class="number">16357824</span>K), <span class="number">0.7497450</span> secs] [Times: user=<span class="number">0.74</span> sys=<span class="number">0.00</span>, real=<span class="number">0.75</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">57.747</span>+<span class="number">0800</span>: <span class="number">14255.667</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.8420690</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">03</span>:<span class="number">57.748</span>+<span class="number">0800</span>: <span class="number">14255.667</span>: [CMS-concurrent-mark-start]</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">01.922</span>+<span class="number">0800</span>: <span class="number">14259.842</span>: [👉CMS-concurrent-mark: <span class="number">3.774</span>/<span class="number">4.175</span> secs] [Times: user=<span class="number">21.69</span> sys=<span class="number">1.42</span>, real=<span class="number">4.18</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">01.923</span>+<span class="number">0800</span>: <span class="number">14259.842</span>: [CMS-concurrent-preclean-start]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">02.472</span>+<span class="number">0800</span>: <span class="number">14260.391</span>: [CMS-concurrent-preclean: <span class="number">0.534</span>/<span class="number">0.549</span> secs] [Times: user=<span class="number">1.89</span> sys=<span class="number">0.20</span>, real=<span class="number">0.54</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">02.472</span>+<span class="number">0800</span>: <span class="number">14260.391</span>: [CMS-concurrent-abortable-preclean-start]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">02.855</span>+<span class="number">0800</span>: <span class="number">14260.774</span>: [👉ParNew: <span class="number">3436653</span>K-&gt;<span class="number">21828</span>K(<span class="number">3774912</span>K), <span class="number">0.0333360</span> secs] <span class="number">13732995</span>K-&gt;<span class="number">10322861</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.134</span>+<span class="number">0800</span>: <span class="number">14262.054</span>: [CMS-concurrent-abortable-preclean: <span class="number">1.619</span>/<span class="number">1.663</span> secs] [Times: user=<span class="number">5.98</span> sys=<span class="number">0.57</span>, real=<span class="number">1.67</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.138</span>+<span class="number">0800</span>: <span class="number">14262.057</span>: [GC[👉YG occupancy: <span class="number">1747139</span> K (<span class="number">3774912</span> K)]</span><br><span class="line">  <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.138</span>+<span class="number">0800</span>: <span class="number">14262.057</span>: [Rescan (parallel) , <span class="number">0.2811700</span> secs]</span><br><span class="line">  <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.420</span>+<span class="number">0800</span>: <span class="number">14262.339</span>: [weak refs processing, <span class="number">0.0024920</span> secs]</span><br><span class="line">  <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.422</span>+<span class="number">0800</span>: <span class="number">14262.341</span>: [<span class="keyword">class</span> unloading, <span class="number">0.0154740</span> secs]</span><br><span class="line">  <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.438</span>+<span class="number">0800</span>: <span class="number">14262.357</span>: [scrub symbol table, <span class="number">0.0037670</span> secs]</span><br><span class="line">  <span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.441</span>+<span class="number">0800</span>: <span class="number">14262.361</span>: [scrub <span class="built_in">string</span> table, <span class="number">0.0047420</span> secs] </span><br><span class="line">  [<span class="number">1</span> 👉CMS-remark: <span class="number">10301033</span>K(<span class="number">12582912</span>K)] <span class="number">12048173</span>K(<span class="number">16357824</span>K), <span class="number">0.3147390</span> secs] [Times: user=<span class="number">2.15</span> sys=<span class="number">0.00</span>, real=<span class="number">0.32</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.453</span>+<span class="number">0800</span>: <span class="number">14262.372</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.3184590</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">04.453</span>+<span class="number">0800</span>: <span class="number">14262.373</span>: [CMS-concurrent-sweep-start]</span><br><span class="line">CMS: Large Block: <span class="number">0x00000007c1173180</span>; Proximity: <span class="number">0x00000007ae04a648</span> -&gt; <span class="number">0x00000007b9fd0a80</span></span><br><span class="line"></span><br><span class="line">CMS: Large block <span class="number">0x00000007c1173180</span></span><br><span class="line">CMS: Large Block: <span class="number">0x00000007fc840000</span>; Proximity: <span class="number">0x00000007fc7fccb0</span> -&gt; <span class="number">0x00000007fc7fccb0</span></span><br><span class="line">CMS: Large block <span class="number">0x00000007fc840000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">14.119</span>+<span class="number">0800</span>: <span class="number">14272.038</span>: [👉CMS-concurrent-sweep: <span class="number">9.423</span>/<span class="number">9.665</span> secs] [Times: user=<span class="number">36.55</span> sys=<span class="number">4.19</span>, real=<span class="number">9.66</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">14.119</span>+<span class="number">0800</span>: <span class="number">14272.038</span>: [CMS-concurrent-reset-start]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">04</span>:<span class="number">14.163</span>+<span class="number">0800</span>: <span class="number">14272.083</span>: [👉CMS-concurrent-reset: <span class="number">0.045</span>/<span class="number">0.045</span> secs] [Times: user=<span class="number">0.17</span> sys=<span class="number">0.02</span>, real=<span class="number">0.04</span> secs]</span><br></pre></td></tr></table></figure></p>
<p>注意: 在CMS-concurrent-abortable-preclean-start后有一次ParNew的新生代垃圾收集.   </p>
<blockquote>
<p>after a preclean, ‘abortable preclean’ starts. After the young generation collection,<br>the young gen occupancy drops down from 3436653K to 21828K.<br>When young gen occupancy reaches 1747139 which is 50% of the total capacity(3774912),<br>precleaning is aborted and ‘remark’ phase is started.</p>
</blockquote>
<p>5).观察system.log统计的GC信息, 发现在这之后的<code>21:09:42</code>开始<code>GC for ParNew</code>时间越来越长, 并且出现了多次的<code>GC for CMS</code>.<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[CompactionExecutor:546]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:10</span>,664 <span class="tag">CompactionTask</span><span class="class">.java</span> (<span class="tag">line</span> 120) <span class="tag">Compacting</span> <span class="attr_selector">[SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297018-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297014-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297007-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297012-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297006-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297008-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297057-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297009-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297013-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297017-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297056-Data.db'), SSTableReader(path='/home/admin/cassandra/data/forseti/velocity/forseti-velocity-jb-297011-Data.db')]</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:42</span>,724 <span class="tag">GCInspector</span><span class="class">.java</span> (<span class="tag">line</span> 116) <span class="tag">GC</span> <span class="tag">for</span> <span class="tag">ParNew</span>: 1420 <span class="tag">ms</span> <span class="tag">for</span> 1 <span class="tag">collections</span>, 5274947408 <span class="tag">used</span>; <span class="tag">max</span> <span class="tag">is</span> 16750411776</span><br><span class="line"></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:45</span>,891 <span class="tag">GCInspector</span><span class="class">.java</span> (<span class="tag">line</span> 116) <span class="tag">GC</span> <span class="tag">for</span> <span class="tag">ParNew</span>: 2342 <span class="tag">ms</span> <span class="tag">for</span> 1 <span class="tag">collections</span>, 7007901632 <span class="tag">used</span>; <span class="tag">max</span> <span class="tag">is</span> 16750411776</span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:45</span>,892 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 55) <span class="tag">Pool</span> <span class="tag">Name</span>                    <span class="tag">Active</span>   <span class="tag">Pending</span>      <span class="tag">Completed</span>   <span class="tag">Blocked</span>  <span class="tag">All</span> <span class="tag">Time</span> <span class="tag">Blocked</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:45</span>,892 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 70) <span class="tag">ReadStage</span>                        23       129         645249         0                 0</span><br><span class="line"></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:49</span>,573 <span class="tag">GCInspector</span><span class="class">.java</span> (<span class="tag">line</span> 116) <span class="tag">GC</span> <span class="tag">for</span> <span class="tag">ParNew</span>: 3161 <span class="tag">ms</span> <span class="tag">for</span> 1 <span class="tag">collections</span>, 9012309600 <span class="tag">used</span>; <span class="tag">max</span> <span class="tag">is</span> 16750411776</span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:49</span>,574 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 55) <span class="tag">Pool</span> <span class="tag">Name</span>                    <span class="tag">Active</span>   <span class="tag">Pending</span>      <span class="tag">Completed</span>   <span class="tag">Blocked</span>  <span class="tag">All</span> <span class="tag">Time</span> <span class="tag">Blocked</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:49</span>,575 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 70) <span class="tag">ReadStage</span>                        32        94         645515         0                 0</span><br><span class="line"></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:53</span>,443 <span class="tag">GCInspector</span><span class="class">.java</span> (<span class="tag">line</span> 116) <span class="tag">GC</span> <span class="tag">for</span> <span class="tag">ParNew</span>: 3277 <span class="tag">ms</span> <span class="tag">for</span> 1 <span class="tag">collections</span>, 11212220496 <span class="tag">used</span>; <span class="tag">max</span> <span class="tag">is</span> 16750411776</span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:53</span>,443 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 55) <span class="tag">Pool</span> <span class="tag">Name</span>                    <span class="tag">Active</span>   <span class="tag">Pending</span>      <span class="tag">Completed</span>   <span class="tag">Blocked</span>  <span class="tag">All</span> <span class="tag">Time</span> <span class="tag">Blocked</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:53</span>,444 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 70) <span class="tag">ReadStage</span>                        32       254         645647         0                 0</span><br><span class="line"></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:54</span>,790 <span class="tag">GCInspector</span><span class="class">.java</span> (<span class="tag">line</span> 116) <span class="tag">GC</span> <span class="tag">for</span> <span class="tag">ConcurrentMarkSweep</span>: 1142 <span class="tag">ms</span> <span class="tag">for</span> 1 <span class="tag">collections</span>, 12623059520 <span class="tag">used</span>; <span class="tag">max</span> <span class="tag">is</span> 16750411776</span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:54</span>,790 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 55) <span class="tag">Pool</span> <span class="tag">Name</span>                    <span class="tag">Active</span>   <span class="tag">Pending</span>      <span class="tag">Completed</span>   <span class="tag">Blocked</span>  <span class="tag">All</span> <span class="tag">Time</span> <span class="tag">Blocked</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:54</span>,791 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 70) <span class="tag">ReadStage</span>                        32       475         645647         0                 0</span><br><span class="line"></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:55</span>,022 <span class="tag">MessagingService</span><span class="class">.java</span> (<span class="tag">line</span> 876) 52 <span class="tag">READ</span> <span class="tag">messages</span> <span class="tag">dropped</span> <span class="tag">in</span> <span class="tag">last</span> 5000<span class="tag">ms</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:55</span>,025 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 55) <span class="tag">Pool</span> <span class="tag">Name</span>                    <span class="tag">Active</span>   <span class="tag">Pending</span>      <span class="tag">Completed</span>   <span class="tag">Blocked</span>  <span class="tag">All</span> <span class="tag">Time</span> <span class="tag">Blocked</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:09</span><span class="pseudo">:55</span>,026 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 70) <span class="tag">ReadStage</span>                        32       512         645647         0                 0</span><br><span class="line"></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:10</span><span class="pseudo">:56</span>,385 <span class="tag">GCInspector</span><span class="class">.java</span> (<span class="tag">line</span> 116) <span class="tag">GC</span> <span class="tag">for</span> <span class="tag">ConcurrentMarkSweep</span>: 41123 <span class="tag">ms</span> <span class="tag">for</span> 1 <span class="tag">collections</span>, 11291487752 <span class="tag">used</span>; <span class="tag">max</span> <span class="tag">is</span> 16750411776</span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:10</span><span class="pseudo">:56</span>,385 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 55) <span class="tag">Pool</span> <span class="tag">Name</span>                    <span class="tag">Active</span>   <span class="tag">Pending</span>      <span class="tag">Completed</span>   <span class="tag">Blocked</span>  <span class="tag">All</span> <span class="tag">Time</span> <span class="tag">Blocked</span></span><br><span class="line"><span class="tag">INFO</span> <span class="attr_selector">[ScheduledTasks:1]</span> 2015<span class="tag">-10-21</span> 21<span class="pseudo">:10</span><span class="pseudo">:56</span>,386 <span class="tag">StatusLogger</span><span class="class">.java</span> (<span class="tag">line</span> 70) <span class="tag">ReadStage</span>                        32       515         645647         0                 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>system.log中在这几次比较长的GC for ParNew以及GC for CMS都没有什么异常信息, 不过打印了很多SatusLogger的信息.  </p>
<blockquote>
<p>StatusLogger会在GCInspector计算<code>GC duration超过1s</code>时打印. 具体可以查看GCInspector.java中的StatsLogger的输出条件.   </p>
</blockquote>
<p>看看gc.log对应这段时间的日志, 也都只是简单地打印了before, after gc的, 并没有打印heap中对象的信息.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">41.291</span>+<span class="number">0800</span>: <span class="number">14599.210</span>: [ParNew: <span class="number">3374088</span>K-&gt;<span class="number">419392</span>K(<span class="number">3774912</span>K), <span class="number">1.4201840</span> secs] <span class="number">7553474</span>K-&gt;<span class="number">5092663</span>K(<span class="number">16357824</span>K)After GC: ①</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">42.712</span>+<span class="number">0800</span>: <span class="number">14600.632</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">1.4269430</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">43.530</span>+<span class="number">0800</span>: <span class="number">14601.449</span>: [ParNew: <span class="number">3774641</span>K-&gt;<span class="number">419392</span>K(<span class="number">3774912</span>K), <span class="number">2.3420270</span> secs] <span class="number">8447913</span>K-&gt;<span class="number">6726642</span>K(<span class="number">16357824</span>K)After GC: ②</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">45.873</span>+<span class="number">0800</span>: <span class="number">14603.792</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">2.3507670</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">46.400</span>+<span class="number">0800</span>: <span class="number">14604.320</span>: [ParNew: <span class="number">3774912</span>K-&gt;<span class="number">419392</span>K(<span class="number">3774912</span>K), <span class="number">3.1607140</span> secs] <span class="number">10082162</span>K-&gt;<span class="number">8787059</span>K(<span class="number">16357824</span>K)After GC: ③</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">49.562</span>+<span class="number">0800</span>: <span class="number">14607.481</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">3.1836570</span> seconds</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">50.160</span>+<span class="number">0800</span>: <span class="number">14608.079</span>: [ParNew: <span class="number">3774912</span>K-&gt;<span class="number">419392</span>K(<span class="number">3774912</span>K), <span class="number">3.2769040</span> secs] <span class="number">12142579</span>K-&gt;<span class="number">10947142</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">21</span>T21:<span class="number">09</span>:<span class="number">53.437</span>+<span class="number">0800</span>: <span class="number">14611.356</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">3.2819760</span> seconds</span><br></pre></td></tr></table></figure></p>
<p>但是等等, 仔细看下ParNew中回收后的新生代内存大小, 有没有发现什么??  </p>
<p>7.<strong>问题初/出现: ParNew后Survivor满了</strong>  </p>
<p>和之前我们分析的ParNew不同的是这里回收之前新生代的内存就和总内存一样都是3774912K(前面两个只差一点, 后面两个完全一样).<br>回收后新生代内存都是419392K. 这种一模一样的数据说明了什么问题? 一般而言, 随机的数据是没有问题的, 固定的数据就是有问题了.   </p>
<p><strong>可以看到ParNew之前的新生代内存已经达到了新生代内存的容量3774912K了(前面使用-gc命令,EC+一个SurvivorCapacity的值=3774912K).</strong><br><strong>说明在回收前, Eden和一个Survivor都完全填满对象了. 那么在YGC时, 这个满了的Survivor因为对象计数器&gt;1晋升到老年代,</strong><br><strong>而我们看到回收后的新生代内存仍然是满了的SurvivorCapacity:419392K. 说明Eden中经过这次YGC仍然存活的对象不止400M,</strong><br><strong>由于Eden存活的对象不能够放入Survivor,所以剩余的这些对象会直接进入老年代.  观察老年代的内存②比①增加了1.6G多:</strong><br><strong>包括了Survivor晋升过来的最多400M,以及因为Survivor满了无法存放而直接转移的Eden中存活的对象有近至少1.2G!</strong><br><strong>Eden中存活的对象因为Survivor满了而直接转移到老年代, 这种情况发生的时候是很不妙的. 因为对象没有经过Survivor.</strong><br><strong>不过这个问题的根源应该是: 为什么Eden的存活对象之前是只有最多4M, 突然一下子增大到有1.2G的存活对象?</strong>   </p>
<blockquote>
<p><code>YGC会把Eden中的所有活的对象都移到Survivor区中，如果Survivor区中放不下，那么剩下的活的对象就被移到Old Gen中.</code><br>因为YGC会把Eden中存活的对象以及from survivor拷贝到to survivor, 但是由于现在from survivor已经满了,所以Eden中存活的对象会直接拷贝到老年代.  </p>
</blockquote>
<h4 id="很长的FGC">很长的FGC</h4><p>1.<strong>CMS GC</strong>  </p>
<p>聊聊JVM（四）深入理解Major GC, Full GC, CMS: <a href="http://blog.csdn.net/iter_zc/article/details/41825395" target="_blank" rel="external">http://blog.csdn.net/iter_zc/article/details/41825395</a><br>[HotSpot VM] JVM调优的”标准参数”的各种陷阱: <a href="http://hllvm.group.iteye.com/group/topic/27945" target="_blank" rel="external">http://hllvm.group.iteye.com/group/topic/27945</a>  </p>
<blockquote>
<p>CMS垃圾收集器包括了四个阶段: 初始标记<code>initial-mark</code>, 并发标记<code>concurrent-mark</code>, 重新标记<code>remark</code>, 并发整理<code>concurrent sweep</code>.<br>其中initital mark和remark两个没有带concurrent的会StopTheWorld.  </p>
<p>CMS至少会给Full GC的次数 + 2，因为Full GC的次数是按照老年代GC时stop the world的次数而定的.<br>Full GC的Time的定义，可以理解它指的是老年代GC时stop the world的时间  </p>
<p>CMS 不等于Full GC，我们可以看到CMS分为多个阶段，只有stop the world的阶段被计算到了Full GC的次数和时间，而和业务线程并发的GC的次数和时间则不被认为是Full GC</p>
<p>正常的CMS的stop the world的时间很短，都是在几十到几百ms的级别，对Full GC的时间影响很小</p>
</blockquote>
<p>2.<strong>Class Histogram FGC</strong>  </p>
<p>我们分析21:10分左右开始到22:43分之间Cassandra进程假死这个过程到底发生了什么: <code>33M 10月 21 22:43 gc-1445418381.log</code>. 找到21:10分之前最近的GC日志信息:<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:53.57</span>7+0800: <span class="number">14611.496</span>: [GC [1 CMS-initial-mark: 👉<span class="number">10,527,75</span>0K(<span class="number">12,582,91</span>2K)👈] <span class="number">11877,789</span>K(<span class="number">16357,824</span>K), <span class="number">1.1421340</span> secs] [Times: user=1.15 sys=0.00, real=1.14 secs]</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:54.71</span>9+0800: <span class="number">14612.639</span>: Total time for which application threads were stopped: <span class="number">1.1519090</span> seconds  ①</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:54.72</span>0+0800: <span class="number">14612.639</span>: [CMS-concurrent-mark-start]</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:54.94</span>6+0800: <span class="number">14612.865</span>: Total time for which application threads were stopped: <span class="number">0.0044060</span> seconds</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:54.94</span>9+0800: <span class="number">14612.868</span>: Total time for which application threads were stopped: <span class="number">0.0028860</span> seconds</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:55.120</span>+0800: <span class="number">14613.039</span>: [GCBefore GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: <span class="number">132,062,67</span>0  剩余容量为132M. </span><br><span class="line">Max   Chunk Size: <span class="number">108,169,992</span>  最大Chunk的容量为108M.</span><br><span class="line">Number of Blocks: 198          块的数量(多少Chunks)</span><br><span class="line">Av.  Block  Size: <span class="number">666,983</span>.     NumOfBlocks*AvgBlockSize=TotalFreeSpace</span><br><span class="line">Tree      Height: 11</span><br><span class="line">Before GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:   这里为什么有两段信息?</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: <span class="number">2,285,36</span>1</span><br><span class="line">Max   Chunk Size: <span class="number">2,281,47</span>2</span><br><span class="line">Number of Blocks: 10</span><br><span class="line">Av.  Block  Size: <span class="number">228,536</span></span><br><span class="line">Tree      Height: 6</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:09:55.120</span>+0800: <span class="number">14613.039</span>: [👉ParNew: <span class="number">3774,912</span>K-&gt;<span class="number">3774,912</span>K👈(<span class="number">3774912</span>K), <span class="number">0.0000490</span> secs]<span class="number">2015-10-21</span>T<span class="number">21:09:55.120</span>+0800: <span class="number">14613.039</span>: [Class Histogram (before full gc):</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:      <span class="number">80698905</span>     <span class="number">6645469872</span>  [B</span><br><span class="line">   2:      <span class="number">88784779</span>     <span class="number">4261669392</span>  java.nio.HeapByteBuffer</span><br><span class="line">   3:      <span class="number">39890367</span>     <span class="number">1595614680</span>  org.apache.cassandra.io.sstable.IndexHelper$IndexInfo</span><br><span class="line">   4:      <span class="number">15687882</span>     <span class="number">1004024448</span>  java.nio.DirectByteBufferR</span><br><span class="line">   5:        104774      <span class="number">385911192</span>  [Ljava.lang.Object<span class="comment">;</span></span><br><span class="line">   6:       <span class="number">3206670</span>      <span class="number">153920160</span>  edu.stanford.ppl.concurrent.SnapTreeMap$Node</span><br><span class="line">   7:       <span class="number">2783478</span>      <span class="number">111339120</span>  org.apache.cassandra.db.ExpiringColumn</span><br><span class="line">   8:        531668       <span class="number">51040128</span>  edu.stanford.ppl.concurrent.CopyOnWriteManager$COWEpoch</span><br><span class="line">   9:        536228       <span class="number">25738944</span>  edu.stanford.ppl.concurrent.SnapTreeMap$RootHolder</span><br><span class="line">  10:        823822       <span class="number">19771728</span>  java.util.concurrent.ConcurrentSkipListMap$Node</span><br><span class="line">  11:        531668       <span class="number">17013376</span>  edu.stanford.ppl.concurrent.CopyOnWriteManager$Latch</span><br><span class="line">  ...</span><br><span class="line">Total     <span class="number">239496755</span>    <span class="number">14467348864</span>  👉6G+4G+1G+500M=12.6G, 再加上其他,一共有近14G.👈 </span><br><span class="line">, <span class="number">11.1813410</span> secs]</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:10:06.30</span>2+0800: <span class="number">14624.221</span>: [CMS<span class="number">2015-10-21</span>T<span class="number">21:10:18.42</span>0+0800: <span class="number">14636.339</span>: [CMS-concurrent-mark: <span class="number">12.488/23</span>.700 secs] [Times: user=37.26 sys=0.72, real=23.70 secs]</span><br><span class="line">✨(concurrent mode failure)✨CMS: Large block <span class="number">0x00000007</span><span class="number">96a01988</span> ④</span><br><span class="line">: <span class="number">10527750</span>K-&gt;<span class="number">10940294</span>K(<span class="number">12582912</span>K), <span class="number">41.1230770</span> secs]  </span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:10:47.42</span>5+0800: <span class="number">14665.344</span>: [Class Histogram (after full gc):</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:      <span class="number">72165660</span>     <span class="number">5523991976</span>  [B</span><br><span class="line">   2:      <span class="number">75437882</span>     <span class="number">3621018336</span>  java.nio.HeapByteBuffer</span><br><span class="line">   3:      <span class="number">36048357</span>     <span class="number">1441934280</span>  org.apache.cassandra.io.sstable.IndexHelper$IndexInfo</span><br><span class="line">   4:         25412      <span class="number">365368784</span>  [Ljava.lang.Object<span class="comment">;</span></span><br><span class="line">   5:       <span class="number">1368526</span>       <span class="number">65689248</span>  edu.stanford.ppl.concurrent.SnapTreeMap$Node</span><br><span class="line">   6:       <span class="number">1365018</span>       <span class="number">54600720</span>  org.apache.cassandra.db.ExpiringColumn  ⑤</span><br><span class="line">   7:        150348       <span class="number">14433408</span>  edu.stanford.ppl.concurrent.CopyOnWriteManager$COWEpoch</span><br><span class="line">   8:         15940       <span class="number">12236136</span>  [J</span><br><span class="line">   9:        222563        <span class="number">8902520</span>  java.util.TreeMap$Entry</span><br><span class="line">  10:        357980        <span class="number">8591520</span>  java.lang.Long</span><br><span class="line">  11:         62812        <span class="number">8470512</span>  [C</span><br><span class="line">  12:        304483        <span class="number">7307592</span>  java.lang.Double</span><br><span class="line">  13:        150424        <span class="number">7220352</span>  edu.stanford.ppl.concurrent.SnapTreeMap$RootHolder  </span><br><span class="line"> Total     <span class="number">190044152</span>    <span class="number">11225332704</span></span><br><span class="line">, <span class="number">8.9471970</span> secs]</span><br><span class="line"> <span class="number">14302662</span>K-&gt;<span class="number">10940294</span>K(<span class="number">16357824</span>K), [CMS Perm : 26777K-&gt;26774K(44704K)]After GC:   ②</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: <span class="number">210,238,671</span>.   原先剩余132M,现在是210M.</span><br><span class="line">Max   Chunk Size: <span class="number">210,238,671</span>    只有一个块了</span><br><span class="line">Number of Blocks: 1</span><br><span class="line">Av.  Block  Size: <span class="number">210238671</span>      所以最大值=平均值=Total  </span><br><span class="line">Tree      Height: 1</span><br><span class="line">After GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: 0</span><br><span class="line">Max   Chunk Size: 0</span><br><span class="line">Number of Blocks: 0</span><br><span class="line">Tree      Height: 0</span><br><span class="line">, <span class="number">61.2523050</span> secs] [Times: user=72.60 sys=0.62, real=61.24 secs]</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">21:10:56.37</span>2+0800: <span class="number">14674.292</span>: Total time for which application threads were stopped: <span class="number">61.2555790</span> seconds  ③</span><br></pre></td></tr></table></figure></p>
<p>① initial-mark时间很短,只有1.14秒. 虽然只有1.14秒, 但日志接着打印出Total time … stopped:1.15s. 因为初始标记会STW.   </p>
<blockquote>
<p>Beginning of tenured generation collection with CMS collector. This is initial Marking phase of CMS where<br>all the objects directly reachable from roots are marked and this is done with all the mutator threads stopped.<br>老年代的容量OC为12G,当它被使用(occupancy)了10G时, CMS收集器被触发(trigger).  </p>
</blockquote>
<p>② 回收前的13.96G减少到10.68G. Perm永久代在垃圾收集过程中没有什么变化.<br>③ GC的时间从<code>21:09:55</code>-<code>21:10:56</code>刚好是<code>61s</code>. FGC的这段时间就是应用程序线程被中断Stopped的总时间.<br>④ 有个23.7s的<code>concurrent mark</code>, 并且<code>(concurrent mode failure)CMS: Large block</code>.    </p>
<blockquote>
<p>CMS GC时出现promotion failed和concurrent mode failure:<br>promotion failed是在进行Minor GC时，survivor space放不下、对象只能放入旧生代，而此时旧生代也放不下造成的；<br>concurrent mode failure是在执行CMS GC的过程中同时有对象要放入旧生代，而此时旧生代空间不足造成的。<br>应对措施为：增大survivor space、旧生代空间或调低触发并发GC的比率  </p>
</blockquote>
<p>⑤ ExpiringColumn在GC后被回收, 这些对象来自于查询时把tombstone都加载到内存,而没有及时回收. 不过只有50M左右.  </p>
<p>除了表面的这些日志信息外, 我们还能挖掘出什么信息:<br>1) 观察上面一次FGC的过程, DirectByteBufferR对象在GC后没有存在(将近1G), 其他对象的instances和bytes都有所减少.   </p>
<p>2) SSTable的IndexInfo是数据的索引信息. 占了约1.5G.  </p>
<p>3) BinaryTreeDictionary是Perm的statics吗</p>
<p>3.<strong>concurrent mode failure</strong>  </p>
<p><a href="https://blogs.oracle.com/poonam/entry/troubleshooting_long_gc_pauses" target="_blank" rel="external">https://blogs.oracle.com/poonam/entry/troubleshooting_long_gc_pauses</a>  </p>
<blockquote>
<p>Fragmentation in the Java Heap can cause GCs to occur more frequently and also sometimes causing long pauses in the GCs.<br>This is more probable in the case of Concurrent Mark Sweep collector, also known as CMS, 在CMS阶段由于碎片更容易引起GC.<br>where the tenured generation space is not compacted with the concurrent collections. 因为老年代的空间在并发收集时并没有做压缩操作.    </p>
<p>In case of the CMS, due to fragmentation in the tenured generation space, the young generation collections can face 新生代的收集会面临晋升失败<br>promotion failures and thus triggering ‘Concurrent Mode Failure’ collections that are stop-the-world Full GCs, 从而触发<code>并发模式失败</code>引起FGC<br>and Full GCs take a long time to finish as compared to the concurrent collection pauses. FGC会花费更多的时间  </p>
<p>Due to the fragmentation, the direct allocations in the tenured generation may fail 因为碎片存在,即使老年代有足够的空间. 但是因为这些碎片不是连续的<br>even when there is lot of free space available and thus causing Full GCs. 如果新生代要求一个连续的空间,老年代没有这样的,就会导致FGC.<br>Fragmentation can also cause frequent allocation failures and thus triggering frequent Full GCs that increase the overall time the application is paused for.</p>
</blockquote>
<h4 id="最终OOM时">最终OOM时</h4><p>最后导致Cassandra进程挂掉时打印的堆信息: </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015-10-21</span>T<span class="number">22:37:40.92</span>8+0800: <span class="number">19878.847</span>: [Class Histogram (before full gc):</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:     <span class="number">109883385</span>     <span class="number">8494073440</span>  [B  ②</span><br><span class="line">   2:     <span class="number">113572533</span>     <span class="number">5451481584</span>  java.nio.HeapByteBuffer</span><br><span class="line">   3:      <span class="number">54818129</span>     <span class="number">2192725160</span>  org.apache.cassandra.io.sstable.IndexHelper$IndexInfo</span><br><span class="line">   4:         38540      <span class="number">329177992</span>  [Ljava.lang.Object<span class="comment">;</span></span><br><span class="line">   5:       <span class="number">1558136</span>       <span class="number">74790528</span>  edu.stanford.ppl.concurrent.SnapTreeMap$Node</span><br><span class="line">   6:       <span class="number">1661366</span>       <span class="number">66454640</span>  org.apache.cassandra.db.ExpiringColumn</span><br><span class="line">   7:        175824       <span class="number">16879104</span>  edu.stanford.ppl.concurrent.CopyOnWriteManager$COWEpoch</span><br><span class="line"></span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">22:37:53.86</span>7+0800: <span class="number">19891.786</span>: [CMS<span class="number">2015-10-21</span>T<span class="number">22:38:10.33</span>3+0800: <span class="number">19908.252</span>: [CMS-concurrent-mark: <span class="number">16.465/29</span>.409 secs] [Times: user=45.59 sys=0.10, real=29.41 secs]</span><br><span class="line"> (concurrent mode failure)CMS: Large block <span class="number">0x00000000</span><span class="number">00000000</span></span><br><span class="line">: <span class="number">12582912</span>K-&gt;<span class="number">12582911</span>K(<span class="number">12582912</span>K), <span class="number">57.4368210</span> secs]</span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">22:38:51.30</span>4+0800: <span class="number">19949.223</span>: [Class Histogram (after full gc):</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:     <span class="number">107032770</span>     <span class="number">8287003856</span>  [B</span><br><span class="line">   2:     <span class="number">110721923</span>     <span class="number">5314652304</span>  java.nio.HeapByteBuffer</span><br><span class="line">   3:      <span class="number">53392823</span>     <span class="number">2135712920</span>  org.apache.cassandra.io.sstable.IndexHelper$IndexInfo</span><br><span class="line">   4:         38529      <span class="number">318767288</span>  [Ljava.lang.Object<span class="comment">;</span></span><br><span class="line">   5:       <span class="number">1558136</span>       <span class="number">74790528</span>  edu.stanford.ppl.concurrent.SnapTreeMap$Node</span><br><span class="line">   6:       <span class="number">1661366</span>       <span class="number">66454640</span>  org.apache.cassandra.db.ExpiringColumn</span><br><span class="line">   7:        175824       <span class="number">16879104</span>  edu.stanford.ppl.concurrent.CopyOnWriteManager$COWEpoch</span><br><span class="line">   8:         19299       <span class="number">12399344</span>  [J</span><br><span class="line">   9:        374876        <span class="number">8997024</span>  java.lang.Long</span><br><span class="line"></span><br><span class="line">① <span class="number">16,357,82</span>3K-&gt;<span class="number">15,956,145</span>K(<span class="number">16357824</span>K), [CMS Perm : 26698K-&gt;26684K(44704K)]After GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: 0</span><br><span class="line">Max   Chunk Size: 0</span><br><span class="line">Number of Blocks: 0</span><br><span class="line">Tree      Height: 0</span><br><span class="line">After GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: 0</span><br><span class="line">Max   Chunk Size: 0</span><br><span class="line">Number of Blocks: 0</span><br><span class="line">Tree      Height: 0</span><br><span class="line"></span><br><span class="line"><span class="number">2015-10-21</span>T<span class="number">22:43:09.60</span>6+0800: <span class="number">20207.525</span>: Total time for which application threads were stopped: <span class="number">0.0032060</span> seconds</span><br><span class="line">Heap  ③</span><br><span class="line"> par new generation   total <span class="number">3,774,91</span>2K, used <span class="number">3,677,02</span>1K [<span class="number">0x00000003</span>fae00000, <span class="number">0x00000004</span>fae00000, <span class="number">0x00000004</span>fae00000)</span><br><span class="line">  eden space <span class="number">3,355,52</span>0K, 100% used [<span class="number">0x00000003</span>fae00000, <span class="number">0x00000004</span>c7ae0000, <span class="number">0x00000004</span>c7ae0000)</span><br><span class="line">  from space <span class="number">419,392</span>K,  76% used [<span class="number">0x00000004</span>c7ae0000, <span class="number">0x00000004</span>db4d79d0, <span class="number">0x00000004</span>e<span class="number">1470000</span>)</span><br><span class="line">  to   space <span class="number">419,392</span>K,   0% used [<span class="number">0x00000004</span>e<span class="number">1470000</span>, <span class="number">0x00000004</span>e<span class="number">1470000</span>, <span class="number">0x00000004</span>fae00000)</span><br><span class="line"> concurrent mark-sweep generation total <span class="number">12,582,91</span>2K, used <span class="number">12,582,91</span>1K [<span class="number">0x00000004</span>fae00000, <span class="number">0x00000007</span>fae00000, <span class="number">0x00000007</span>fae00000)</span><br><span class="line"> concurrent-mark-sweep perm gen total 44,704K, used 26,855K [<span class="number">0x00000007</span>fae00000, <span class="number">0x00000007</span>fd9a8000, <span class="number">0x00000008</span><span class="number">00000000</span>)</span><br></pre></td></tr></table></figure>
<p>① GC前和GC后几乎没有回收多少内存<br>② 查看各个对象占用的大小: 8+5+2=15已经接近堆内存的最大值16G了<br>③ 从最后OOM时打印的Heap信息查看堆内存中各个部分的大小如下:  </p>
<p>新生代:3.7G, 其中Eden:3.3G, Survivor0:400MB.<br>老年代:12G, 使用了100%. 永久代44M.<br>所以新生代+老年代=12+3.7, 接近最大内存16G, OOM就是因为堆内存被使用光了引起的.<br>通常来说: 老年代(CMS)的对象没有及时被回收释放, 就会造成OOM!<br>也就是说老年代的对象太多了, 造成了<code>内存泄露</code>!  </p>
<p>最后OOM, 因此Cassandra进程最终终于挂掉了(当然OOM异常信息是打印在了system.log中, 这里只是打印出发生OOM时的Heap信息)!<br>因为我们指定了<code>-XX:+HeapDumpOnOutOfMemoryError</code>: 在OOM错误时dump heap.  </p>
<h3 id="GC问题再现:_[203@2015-10-28_19:55]">GC问题再现: [203@2015-10-28 19:55]</h3><p>本来正在下线226节点. 用nodetool status查看时发现203状态为DN, 查看后台很长的GC for CMS.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat  /var/<span class="built_in">log</span>/cassandra/system.<span class="built_in">log</span>  | grep <span class="string">"GC"</span> | grep <span class="string">"2015-10-28"</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">19</span>:<span class="number">54</span>:<span class="number">38</span>,<span class="number">278</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">235</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">2419573000</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">19</span>:<span class="number">55</span>:<span class="number">25</span>,<span class="number">997</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">1504</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3733428056</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">19</span>:<span class="number">55</span>:<span class="number">28</span>,<span class="number">946</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">2330</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">5676292056</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">19</span>:<span class="number">55</span>:<span class="number">32</span>,<span class="number">165</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">2739</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">7921578528</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">19</span>:<span class="number">55</span>:<span class="number">35</span>,<span class="number">572</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">2952</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">10161987488</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">10</span>:<span class="number">53</span>,<span class="number">290</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">866487</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">11508739304</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">10</span>:<span class="number">53</span>,<span class="number">376</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">31607</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">12110583384</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">12</span>:<span class="number">06</span>,<span class="number">522</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">51422</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16334886216</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">13</span>:<span class="number">24</span>,<span class="number">020</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">51095</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">14423806424</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">14</span>:<span class="number">43</span>,<span class="number">251</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">49143</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16170444160</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">16</span>:<span class="number">03</span>,<span class="number">026</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">49301</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16327286728</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">17</span>:<span class="number">27</span>,<span class="number">808</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">56111</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16416467232</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">18</span>:<span class="number">48</span>,<span class="number">870</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">53220</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16494725704</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">10</span>,<span class="number">354</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">53595</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">16644566464</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">24</span>:<span class="number">10</span>,<span class="number">303</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">163458</span> ms <span class="keyword">for</span> <span class="number">3</span> collections, <span class="number">16649751064</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<p>于是用jstat查看了gc, 发现新生代, 老年代空间都满了!<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> S0C     S1C       S0U   S1U      EC        EU        OC         OU       PC        PU      YGC     YGCT       FGC   FGCT     GCT</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  <span class="number">0.0</span>   <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">48904.0</span> <span class="number">29197.6</span> <span class="number">4066626</span> <span class="number">147156.174</span> <span class="number">10140</span> <span class="number">6473.549</span> <span class="number">153629.722</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  <span class="number">0.0</span>   <span class="number">419392.0</span> <span class="number">3355520.0</span> <span class="number">3355520.0</span> <span class="number">12582912.0</span> <span class="number">12582912.0</span> <span class="number">48904.0</span> <span class="number">29195.8</span> <span class="number">4066626</span> <span class="number">147156.174</span> <span class="number">10140</span> <span class="number">6473.549</span> <span class="number">153629.722</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">4.5</span>G <span class="number">10</span>月 <span class="number">28</span> <span class="number">20</span>:<span class="number">26</span> gc-<span class="number">1441001670.l</span>og   停掉C进程    </span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">124</span>K <span class="number">10</span>月 <span class="number">28</span> <span class="number">20</span>:<span class="number">34</span> gc-<span class="number">1446035196.l</span>og   第一次启动, 启动失败</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">2.8</span>M <span class="number">10</span>月 <span class="number">28</span> <span class="number">21</span>:<span class="number">14</span> gc-<span class="number">1446035781.l</span>og   第二次启动</span><br></pre></td></tr></table></figure>
<h2 id="Problem_2:_GC引起的读超时?_[229@2015-10-22_17:06-08]">Problem 2: GC引起的读超时? [229@2015-10-22 17:06-08]</h2><blockquote>
<p>GC的告白: 不要把一切原因都归结是我的问题啊! 可是总要找个借口吧: 不知道什么引起的读超时,先把GC你当做挡箭牌吧. </p>
</blockquote>
<p>线上报警2015-10-22 17:06-08分超时很严重. 查看202几个forseti节点的system.log,都提示fp的229节点DOWN.<br>但是实际上229并没有当掉, 只是这个节点在执行比较长的GC而已.  </p>
<p>下面是截取的部分日志, 因为GC超过1m,它自己连接别的节点状态都是Down. 还进行了一个26s的CMS FullGC.<br>FullGC一旦完成, Gossiper就提示连接其他节点的状态为Up了. 不过这时候丢弃了一些MUTATION消息.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">469</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">1653</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3675</span>,<span class="number">714864</span> used; max is <span class="number">16750</span>,<span class="number">411776</span></span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">470</span> StatusLogger.java (line <span class="number">55</span>) Pool Name                    Active   Pending      Completed   Blocked  All Time Blocked</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">471</span> StatusLogger.java (line <span class="number">70</span>) ReadStage                         <span class="number">0</span>        <span class="number">69</span>       <span class="number">80126766</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">INFO [GossipTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">484</span> Gossiper.java (line <span class="number">962</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.226</span> is now DOWN</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">502</span> StatusLogger.java (line <span class="number">70</span>) MutationStage                    <span class="number">64</span>      <span class="number">3144</span>     <span class="number">7568222241</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">...</span><br><span class="line">INFO [HANDSHAKE-/<span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">508</span> OutboundTcpConnection.java (line <span class="number">389</span>) Handshaking version with /<span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span></span><br><span class="line">INFO [RequestResponseStage:<span class="number">17</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">01</span>,<span class="number">621</span> Gossiper.java (line <span class="number">948</span>) InetAddress /<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span> is now UP</span><br><span class="line">...</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">02</span>,<span class="number">180</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ConcurrentMarkSweep: <span class="number">26194</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">504</span>,<span class="number">0721624</span> used; max is <span class="number">16750</span>,<span class="number">411776</span></span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">02</span>,<span class="number">295</span> StatusLogger.java (line <span class="number">70</span>) ReadStage                         <span class="number">4</span>         <span class="number">4</span>       <span class="number">80127252</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">02</span>,<span class="number">305</span> StatusLogger.java (line <span class="number">70</span>) MutationStage                    <span class="number">64</span>     <span class="number">16652</span>     <span class="number">7568222241</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">...</span><br><span class="line">INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">08</span>:<span class="number">07</span>,<span class="number">358</span> MessagingService.java (line <span class="number">876</span>) <span class="number">1503</span> MUTATION messages dropped in last <span class="number">5000</span>ms</span><br></pre></td></tr></table></figure>
<p>1) 这里的GC for ParNew或者for CMS使用的堆内存只有3G,5G. 和上一个Problem接近堆的最大内存16G不可同日而语的. 不过CMS的时间仍然很长:26s.<br>2) Gossiper在17:08:01,502为DOWN, 在17:08:01,621又恢复为UP, 说明当前节点并不是真正的挂掉的.  </p>
<p>看看这个时候的gc日志:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -C <span class="number">10</span> <span class="string">"2015-10-22T17:07"</span> gc-<span class="number">1442722105.l</span>og</span><br><span class="line">grep -C <span class="number">20</span> <span class="string">"2015-10-22T17:07.*Class Histogram (before full gc)"</span> gc-<span class="number">1442722105.l</span>og</span><br></pre></td></tr></table></figure></p>
<p>ParNew收集器提升失败, 可以看到ParNew后面的反而比之前要大. (是这个原因吗, 不是吧)<br>为什么提升失败: 因为总的才有3374, 提升前是3364, 提升后是3378, 显然不能成功提升. 这里提升的含义是?</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span>T17:<span class="number">07</span>:<span class="number">25.975</span>+<span class="number">0800</span>: <span class="number">2782739.528</span>: [ParNew (promotion failed): <span class="number">3364</span>,<span class="number">001</span>K-&gt;<span class="number">3378</span>,<span class="number">480</span>K(<span class="number">3774</span>,<span class="number">912</span>K), <span class="number">1.6523860</span> secs]</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span>T17:<span class="number">07</span>:<span class="number">33.314</span>+<span class="number">0800</span>: <span class="number">2782746.867</span>: [CMSCMS: Large block <span class="number">0x00000007c440e128</span></span><br><span class="line">CMS: Large Block: <span class="number">0x00000007fdb07000</span>; Proximity: <span class="number">0x00000007fda93b90</span> -&gt; <span class="number">0x00000007fda93b90</span></span><br><span class="line">CMS: Large block <span class="number">0x00000007fdb07000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">22</span>T17:<span class="number">07</span>:<span class="number">35.001</span>+<span class="number">0800</span>: <span class="number">2782748.554</span>: [CMS-concurrent-sweep: <span class="number">5.884</span>/<span class="number">13.956</span> secs] [Times: user=<span class="number">86.82</span> sys=<span class="number">2.11</span>, real=<span class="number">13.96</span> secs]</span><br><span class="line"> (concurrent mode failure)CMS: Large block <span class="number">0x00000005d4d31cb8</span></span><br></pre></td></tr></table></figure>
<p>分析GC信息:<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192-168-47-229</span> ~]$ sudo -u admin jstat -gc `sudo -u admin jps | grep CassandraDaemon |awk '&#123;print $1&#125;'` 1000</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">15686.1 33</span><span class="number">55520.0 32</span><span class="number">93381.8 125</span><span class="number">82912.0 29</span><span class="number">88456.0</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12928 97557</span>.<span class="number">349 11677</span> <span class="number">2883.959</span> <span class="number">100441.307</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">24851.0 33</span><span class="number">55520.0 143</span><span class="number">9211.8 125</span><span class="number">82912.0 30</span><span class="number">06161.3</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12930 97557</span>.<span class="number">397 11677</span> <span class="number">2883.959</span> <span class="number">100441.355</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">1109.9 33</span><span class="number">55520.0 194</span><span class="number">9350.9 125</span><span class="number">82912.0 30</span><span class="number">27253.7</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12932 97557</span>.<span class="number">452 11677</span> <span class="number">2883.959</span> <span class="number">100441.410</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">17355.3 33</span><span class="number">55520.0 70</span><span class="number">5937.7 125</span><span class="number">82912.0 30</span><span class="number">39274.0</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12934 97557</span>.<span class="number">493 11677</span> <span class="number">2883.959</span> <span class="number">100441.452</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   594.5  <span class="number">3355520.0</span> <span class="number">2404209.8 125</span><span class="number">82912.0 30</span><span class="number">59189.1</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12936 97557</span>.<span class="number">547 11677</span> <span class="number">2883.959</span> <span class="number">100441.505</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">14354.7 33</span><span class="number">55520.0 66</span><span class="number">9799.8 125</span><span class="number">82912.0 30</span><span class="number">70693.1</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12938 97557</span>.<span class="number">600 11677</span> <span class="number">2883.959</span> <span class="number">100441.559</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">24026.0</span>  0.0   <span class="number">3355520.0</span> <span class="number">2792573.7</span> <span class="number">12582912.0</span> <span class="number">3078149.1</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12939 97557</span>.<span class="number">626 11677</span> <span class="number">2883.959</span> <span class="number">100441.585</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">12748.3</span>  0.0   <span class="number">3355520.0</span> <span class="number">1614777.9</span> <span class="number">12582912.0</span> <span class="number">3097754.2</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12941 97557</span>.<span class="number">677 11677</span> <span class="number">2883.959</span> <span class="number">100441.636</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span> <span class="number">15593.8</span>  0.0   <span class="number">3355520.0</span> <span class="number">171442.8 125</span><span class="number">82912.0 31</span><span class="number">16802.0</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12943 97557</span>.<span class="number">727 11677</span> <span class="number">2883.959</span> <span class="number">100441.686</span></span><br><span class="line"><span class="number">419392.0</span> <span class="number">419392.0</span>  0.0   <span class="number">12975.7 33</span><span class="number">55520.0 209</span><span class="number">6091.2 125</span><span class="number">82912.0 31</span><span class="number">25678.7</span>  <span class="number">46492.0 27</span><span class="number">854.7 34</span><span class="number">12944 97557</span>.<span class="number">753 11677</span> <span class="number">2883.959</span> <span class="number">100441.712</span></span><br></pre></td></tr></table></figure></p>
<p>看到一秒钟就发生了2次YGC. 使用-gccause查看:输出-gcutil提供的信息以及最后一次(Last)执行GC的发生原因和当前(Current)所执行的GC的发生原因<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ sudo -<span class="keyword">u</span> admin jstat -gccause `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'`</span><br><span class="line">  S0     S1     <span class="keyword">E</span>      O      P     YGC     YGCT    FGC    FGCT     GCT    LGCC                 GCC</span><br><span class="line">  5.69   0.00  21.40  74.47  59.86 147180 5728.515   328   95.091 5823.606 Allocation Failure   <span class="keyword">No</span> GC</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@192-168-47-229 ~]$ sudo -<span class="keyword">u</span> admin jstat -gccause `sudo -<span class="keyword">u</span> admin jps | grep CassandraDaemon |awk '&#123;<span class="keyword">print</span> <span class="label">$1&#125;</span>'`</span><br><span class="line">  S0     S1     <span class="keyword">E</span>      O      P     YGC     YGCT    FGC    FGCT     GCT    LGCC                 GCC</span><br><span class="line">  4.14   0.00  41.68  40.57  59.91 3410825 97506.253 11671 2882.208 100388.461 Allocation Failure   <span class="keyword">No</span> GC</span><br></pre></td></tr></table></figure></p>
<p>虽然229节点的YGC和FGC次数很多, 但是总体来说每次的GC时间并不是很长.  </p>
<table>
<thead>
<tr>
<th>Node</th>
<th>GC Type</th>
<th>Count</th>
<th>Time</th>
<th>Avg=Time/Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>202</td>
<td>YGC</td>
<td>147180</td>
<td>5728.515</td>
<td>0.0389s(38ms)</td>
</tr>
<tr>
<td>202</td>
<td>FGC</td>
<td>328</td>
<td>95.091</td>
<td>0.289s(289ms)</td>
</tr>
<tr>
<td>229</td>
<td>YGC</td>
<td>3410825</td>
<td>97506.253</td>
<td>0.028s(28ms)</td>
</tr>
<tr>
<td>229</td>
<td>FGC</td>
<td>11671</td>
<td>2882.208</td>
<td>0.246s(246ms)</td>
</tr>
</tbody>
</table>
<p>上面GC失败的原因提示<code>Allocation Failure</code>,通常是Eden空间不够.<br><a href="http://stackoverflow.com/questions/28342736/java-gc-allocation-failure" target="_blank" rel="external">http://stackoverflow.com/questions/28342736/java-gc-allocation-failure</a>  </p>
<p>由于229节点有64G内存, 而设置的<code>-Xms16G -Xmx16G -Xmn4G</code>, 可以考虑增加这三个值的大小.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/cassandra/conf/cassandra-env.sh</span><br><span class="line">JVM_OPTS=<span class="string">"<span class="variable">$JVM_OPTS</span> -Xms16G"</span></span><br><span class="line">JVM_OPTS=<span class="string">"<span class="variable">$JVM_OPTS</span> -Xmx16G"</span></span><br><span class="line">JVM_OPTS=<span class="string">"<span class="variable">$JVM_OPTS</span> -Xmn4G"</span></span><br><span class="line">JVM_OPTS=<span class="string">"<span class="variable">$JVM_OPTS</span> -XX:MaxDirectMemorySize=6G"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="GC_Question">GC Question</h2><h3 id="Tombstone">Tombstone</h3><p>查询超过1000个tombstone的记录:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="link_label">qihuang.zheng@cass047202 cassandra</span>]$ cat system.log | grep "live and [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>] tombstone cells in forseti.velocity" | grep "2015-10-26" | wc -l</span><br><span class="line">576</span><br><span class="line">[<span class="link_label">qihuang.zheng@cass047202 cassandra</span>]$ cat system.log | grep "live and [<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>][<span class="link_label">0-9</span>][<span class="link_reference">0-9</span>] tombstone cells in forseti.velocity" | grep "2015-10-26" | head</span><br><span class="line"> WARN [ReadStage:751] 2015-10-26 00:13:14,986 SliceQueryFilter.java (line 231) Read 654 live and 5751 tombstone cells in forseti.velocity (see tombstone<span class="emphasis">_warn_</span>threshold). 1000 columns was requested, slices=[koudai:weidian:payeeIdNumber:!-koudai:weidian:payeeIdNumber]</span><br><span class="line"> WARN [ReadStage:752] 2015-10-26 00:13:19,420 SliceQueryFilter.java (line 231) Read 0 live and 5079 tombstone cells in forseti.velocity (see tombstone<span class="emphasis">_warn_</span>threshold). 1000 columns was requested, slices=[fyzhibo:fyzhibo<span class="emphasis">_web:accountLogin:!-fyzhibo:fyzhibo_</span>web:accountLogin]</span><br></pre></td></tr></table></figure></p>
<p>Read 0 live and 5079 tombstone是的记录表示要查询的记录都已经过期了. 但是还剩把tombstone都返回到客户端.  </p>
<h3 id="CMS_and_Heap_Memory_Relation">CMS and Heap Memory Relation</h3><p>如果直接查看system.log的GC日志, 会发现used增长到一定程序比如10G左右, 就会下降, 那么这个下降之前的一定发生了CMS.<br>虽然在system.log中我们并没有看到GC for CMS的日志. 但是在gc.log中一定是发生了CMS, 否则堆内存是不会减少的.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ cat /var/<span class="built_in">log</span>/cassandra/system.<span class="built_in">log</span> | grep <span class="string">"GC"</span> | grep <span class="string">"2015-10-26"</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">08</span>,<span class="number">627</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">224</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">7815460192</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">08</span>:<span class="number">52</span>,<span class="number">236</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">230</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9134796832</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">10</span>:<span class="number">58</span>,<span class="number">390</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">371</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">9907968408</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">01</span>,<span class="number">391</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">475</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">10142946312</span> used; max is <span class="number">16750411776</span></span><br><span class="line"></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">12</span>:<span class="number">08</span>,<span class="number">499</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">225</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3120763368</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">27</span>,<span class="number">580</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">214</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3887484088</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">49</span>,<span class="number">744</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">308</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3189094392</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">51</span>,<span class="number">883</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">556</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3412395496</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">54</span>,<span class="number">884</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">231</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3724150752</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">35</span>:<span class="number">13</span>,<span class="number">382</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">402</span> ms <span class="keyword">for</span> <span class="number">2</span> collections, <span class="number">7429717728</span> used; max is <span class="number">16750411776</span></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">07</span>,<span class="number">388</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">228</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">10338198528</span> used; max is <span class="number">16750411776</span></span><br><span class="line"></span><br><span class="line"> INFO [ScheduledTasks:<span class="number">1</span>] <span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span> <span class="number">16</span>:<span class="number">52</span>:<span class="number">28</span>,<span class="number">976</span> GCInspector.java (line <span class="number">116</span>) GC <span class="keyword">for</span> ParNew: <span class="number">303</span> ms <span class="keyword">for</span> <span class="number">1</span> collections, <span class="number">3099641168</span> used; max is <span class="number">16750411776</span></span><br></pre></td></tr></table></figure></p>
<p>选取16:45这个点之后的16:52, 堆内存的used从10338198528下降到3099641168, 下面是对应的system.log对应这个时间段的日志, 发生了一次CMS:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">06.703</span>+<span class="number">0800</span>: <span class="number">323508.048</span>: [👉ParNew: <span class="number">3535452</span>K-&gt;<span class="number">126895</span>K(<span class="number">3774912</span>K), <span class="number">0.2282630</span> secs] <span class="number">12898898</span>K-&gt;<span class="number">9656082</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">06.937</span>+<span class="number">0800</span>: <span class="number">323508.282</span>: [GC [<span class="number">1</span> CMS-initial-mark: <span class="number">9529186</span>K(<span class="number">12582912</span>K)] <span class="number">9656178</span>K(<span class="number">16357824</span>K), <span class="number">0.0232120</span> secs] [Times: user=<span class="number">0.02</span> sys=<span class="number">0.00</span>, real=<span class="number">0.02</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">06.960</span>+<span class="number">0800</span>: <span class="number">323508.305</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.0271990</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">06.961</span>+<span class="number">0800</span>: <span class="number">323508.305</span>: [CMS-concurrent-mark-start]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">08.299</span>+<span class="number">0800</span>: <span class="number">323509.643</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.0034360</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">08.660</span>+<span class="number">0800</span>: <span class="number">323510.004</span>: [CMS-concurrent-mark: <span class="number">1.695</span>/<span class="number">1.699</span> secs] [Times: user=<span class="number">7.69</span> sys=<span class="number">0.52</span>, real=<span class="number">1.70</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">08.660</span>+<span class="number">0800</span>: <span class="number">323510.004</span>: [CMS-concurrent-preclean-start]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">08.711</span>+<span class="number">0800</span>: <span class="number">323510.055</span>: [CMS-concurrent-preclean: <span class="number">0.049</span>/<span class="number">0.051</span> secs] [Times: user=<span class="number">0.17</span> sys=<span class="number">0.03</span>, real=<span class="number">0.05</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">08.711</span>+<span class="number">0800</span>: <span class="number">323510.055</span>: [CMS-concurrent-abortable-preclean-start]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">09.696</span>+<span class="number">0800</span>: <span class="number">323511.040</span>: [👉ParNew: <span class="number">3482415</span>K-&gt;<span class="number">33672</span>K(<span class="number">3774912</span>K), <span class="number">0.0383290</span> secs] <span class="number">13011602</span>K-&gt;<span class="number">9568814</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.023</span>+<span class="number">0800</span>: <span class="number">323512.367</span>: [CMS-concurrent-abortable-preclean: <span class="number">2.256</span>/<span class="number">2.312</span> secs] [Times: user=<span class="number">8.44</span> sys=<span class="number">0.82</span>, real=<span class="number">2.31</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.026</span>+<span class="number">0800</span>: <span class="number">323512.371</span>: [GC[YG occupancy: <span class="number">1833528</span> K (<span class="number">3774912</span> K)]<span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.027</span>+<span class="number">0800</span>: <span class="number">323512.371</span>: [Rescan (parallel) , <span class="number">0.3862770</span> secs]<span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.413</span>+<span class="number">0800</span>: <span class="number">323512.758</span>: [weak refs processing, <span class="number">0.0027200</span> secs]<span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.416</span>+<span class="number">0800</span>: <span class="number">323512.760</span>: [<span class="keyword">class</span> unloading, <span class="number">0.0165040</span> secs]<span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.432</span>+<span class="number">0800</span>: <span class="number">323512.777</span>: [scrub symbol table, <span class="number">0.0027290</span> secs]<span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.435</span>+<span class="number">0800</span>: <span class="number">323512.780</span>: [scrub <span class="built_in">string</span> table, <span class="number">0.0044760</span> secs] [<span class="number">1</span> CMS-remark: <span class="number">9535141</span>K(<span class="number">12582912</span>K)] <span class="number">11368669</span>K(<span class="number">16357824</span>K), <span class="number">0.4202100</span> secs] [Times: user=<span class="number">2.83</span> sys=<span class="number">0.00</span>, real=<span class="number">0.42</span> secs]</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.447</span>+<span class="number">0800</span>: <span class="number">323512.792</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.4239320</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.447</span>+<span class="number">0800</span>: <span class="number">323512.792</span>: [CMS-concurrent-sweep-start]</span><br><span class="line">CMS: Large Block: <span class="number">0x00000007d0aedfc0</span>; Proximity: <span class="number">0x00000007c96cce08</span> -&gt; <span class="number">0x00000007c96cce08</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">11.571</span>+<span class="number">0800</span>: <span class="number">323512.915</span>: Total time <span class="keyword">for</span> which application threads were stopped: <span class="number">0.0038340</span> seconds</span><br><span class="line"><span class="number">2015</span>-<span class="number">10</span>-<span class="number">26</span>T16:<span class="number">45</span>:<span class="number">12.641</span>+<span class="number">0800</span>: <span class="number">323513.986</span>: [👉ParNew: <span class="number">3389192</span>K-&gt;<span class="number">24343</span>K(<span class="number">3774912</span>K), <span class="number">0.0435410</span> secs] <span class="number">12284258</span>K-&gt;<span class="number">8924627</span>K(<span class="number">16357824</span>K)After GC:</span><br></pre></td></tr></table></figure></p>
<p>可以看到这几次的ParNew夹杂着CMS, 总体的对内存变化是: 9656082K -&gt; 9568814K -&gt; 8924627K  </p>
<h3 id="ParNew_promotion_failed">ParNew promotion failed</h3><p>在查询是否有较多的ExpiringColumn时, 发现了一个新生代晋升的异常:<br>虽然在失败的前一个ParNew回收后, 堆内存是7700182K, 还剩有3个G左右. 但是因为碎片数太多:9599. 导致这次ParNew失败.<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ grep "org.apache.cassandra.db.ExpiringColumn" -C 50 gc-<span class="number">1445525597</span>.log &gt; ~/ttl2.log</span><br><span class="line"><span class="number">2015-10-24</span>T<span class="number">00:55:39.33</span>3+0800: <span class="number">93740.677</span>: [ParNew: <span class="number">3369116</span>K-&gt;9027K(<span class="number">3774912</span>K), <span class="number">0.0332100</span> secs] <span class="number">11053952</span>K-&gt;<span class="number">7700182</span>K(<span class="number">16357824</span>K)After GC:</span><br><span class="line"><span class="number">2015-10-24</span>T<span class="number">00:55:40.97</span>6+0800: <span class="number">93742.320</span>: [GCBefore GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: <span class="number">28243524</span></span><br><span class="line">Max   Chunk Size: 100283        最大的连续块只有100KB! </span><br><span class="line">Number of Blocks: 9599</span><br><span class="line">Av.  Block  Size: 2942</span><br><span class="line">Tree      Height: 110</span><br><span class="line">Before GC:</span><br><span class="line">Statistics for BinaryTreeDictionary:</span><br><span class="line">------------------------------------</span><br><span class="line">Total Free Space: <span class="number">2371623</span></span><br><span class="line">Max   Chunk Size: <span class="number">2362880</span></span><br><span class="line">Number of Blocks: 15</span><br><span class="line">Av.  Block  Size: 158108</span><br><span class="line">Tree      Height: 5</span><br><span class="line"><span class="number">2015-10-24</span>T<span class="number">00:55:40.97</span>7+0800: <span class="number">93742.321</span>: [ParNew (promotion failed): <span class="number">3364547</span>K-&gt;<span class="number">3364509</span>K(<span class="number">3774912</span>K), <span class="number">1.0112290</span> secs]<span class="number">2015-10-24</span>T<span class="number">00:55:41.98</span>8+0800: <span class="number">93743.332</span>: [Class Histogram (before full gc):</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:      <span class="number">94519264</span>     <span class="number">4536924672</span>  java.nio.HeapByteBuffer</span><br><span class="line">   2:      <span class="number">16569138</span>     <span class="number">4369282384</span>  [B</span><br><span class="line">   3:      <span class="number">10057767</span>      <span class="number">482772816</span>  edu.stanford.ppl.concurrent.SnapTreeMap$Node</span><br><span class="line">   4:       <span class="number">8381272</span>      <span class="number">335250880</span>  org.apache.cassandra.db.ExpiringColumn</span><br><span class="line">   5:       <span class="number">5873894</span>      <span class="number">234955760</span>  org.apache.cassandra.io.sstable.IndexHelper$IndexInfo</span><br><span class="line">   6:       <span class="number">1515892</span>      <span class="number">145525632</span>  edu.stanford.ppl.concurrent.CopyOnWriteManager$COWEpoch</span><br><span class="line"></span><br><span class="line"><span class="number">2015-10-24</span>T<span class="number">00:55:50.56</span>9+0800: <span class="number">93751.914</span>: [CMSCMS: Large block <span class="number">0x00000005</span>ae76daa8</span><br><span class="line">: <span class="number">7693343</span>K-&gt;<span class="number">2942262</span>K(<span class="number">12582912</span>K), <span class="number">15.9221830</span> secs]<span class="number">2015-10-24</span>T<span class="number">00:56:06.49</span>1+0800: <span class="number">93767.836</span>: [Class Histogram (after full gc):</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:      <span class="number">12886333</span>     <span class="number">1316594672</span>  [B</span><br><span class="line">   2:      <span class="number">15611806</span>      <span class="number">749366688</span>  java.nio.HeapByteBuffer</span><br><span class="line">   3:       <span class="number">5714973</span>      <span class="number">228598920</span>  org.apache.cassandra.io.sstable.IndexHelper$IndexInfo</span><br><span class="line">   4:       <span class="number">1853317</span>       <span class="number">88959216</span>  edu.stanford.ppl.concurrent.SnapTreeMap$Node</span><br><span class="line">   5:       <span class="number">2448358</span>       <span class="number">78347456</span>  java.util.concurrent.ConcurrentHashMap$HashEntry</span><br><span class="line">   6:       <span class="number">2427734</span>       <span class="number">77687488</span>  com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap$Node</span><br><span class="line">   7:       <span class="number">1850344</span>       <span class="number">74013760</span>  org.apache.cassandra.db.ExpiringColumn</span><br><span class="line">   8:       <span class="number">2433031</span>       <span class="number">58392744</span>  org.apache.cassandra.db.RowIndexEntry</span><br><span class="line">   9:       <span class="number">2427734</span>       <span class="number">58265616</span>  com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap$WeightedValue</span><br><span class="line">  10:       <span class="number">2427651</span>       <span class="number">58263624</span>  org.apache.cassandra.cache.KeyCacheKey</span><br><span class="line">  11:           886       <span class="number">47000280</span>  [Ljava.util.concurrent.ConcurrentHashMap$HashEntry<span class="comment">;</span></span><br><span class="line">  12:         47596       <span class="number">29251952</span>  [Ljava.lang.Object<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p><a href="http://stackoverflow.com/questions/21992943/persistant-gc-issues-with-cassandra-long-app-pauses" target="_blank" rel="external">http://stackoverflow.com/questions/21992943/persistant-gc-issues-with-cassandra-long-app-pauses</a>  </p>
<p>在20:49的时候有三个节点几乎同时在做CMS,只持续了20s.并且在21:55分又开始同时CMS,但这个时候每个节点都做了多次的CMS.<br>这次的CMS都差不多在22:10分结束, 但是最后204在22:44分又做了一次41次collection,花费了1600s=30分钟! 报警发生在10:55.<br><img src="http://img.blog.csdn.net/20151104104302323" alt="c_gc3"></p>
<p>观察202, 在21:55分开始CMS后的一端时间貌似监控数据丢失了. 直到CMS在22:11完成后, 监控数据才有.<br><img src="http://img.blog.csdn.net/20151104104319137" alt="c_202"></p>
<p>在225上, 可以看到21:55分确实做了CMS(圆圈圈起来的):<br><img src="http://img.blog.csdn.net/20151104104335018" alt="c_225"></p>
<p>当GC发生时, read请求不会路由到这些发生GC的节点, 如果有请求过来, 因为JVM正在做GC, 响应会很慢, 所以可以看到第四张图read request latency变长.<br>即使请求路由到这些节点,也会超时,所以C<em>的Driver会选择其他节点, 所以请求到这些节点的数量也会减少, 所以看到第三张图read requests数量减少.<br>同样因为GC的原因, 节点响应很慢, 即使有数据写到这些节点, 成功完成一次写请求需要的时间变长, 即第三张图write request latency变长.<br>正如 <strong>读请求数变少, 读延迟变长, 当写延迟变长, 写请求数也同样减少</strong>(即第一张图) 图中粉色的是202, 黄色的是225.<br>或者 <em>*GC的时候, 响应变慢, 导致读写延迟都增加, 路由到节点的读写请求数也变少</em></em>.<br><img src="http://img.blog.csdn.net/20151104113357712" alt="gc_read_slow"></p>
<p>注意第三图虽然202,225读请求数减少, 但是这时却有其他节点的读请求数增加. 这也解释了从这些节点读数据被转移到了从其他有副本的节点读取.  </p>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2016/07/07/Cassandra-GC-CMS/">Cassandra CMS GC</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2016年07月07日 - 00时00分</p>
  <p><span>最后更新:</span>2016年07月28日 - 17时26分</p>
  <p>
    <span>原始链接:</span><a href="/2016/07/07/Cassandra-GC-CMS/" title="Cassandra CMS GC">http://github.com/zqhxuyuan/2016/07/07/Cassandra-GC-CMS/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2016/07/07/Cassandra-GC-CMS/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2016/07/07/Cassandra-GC-G1/">
        Cassandra G1 GC
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2016/06/30/Hello-Storm/">
        用实例理解Storm的Stream概念
      </a>
    </div>
  
</nav>

  
  
    <div class ="post-donate">
	<br/>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   这么长的文章我都读完了，看起来作者写的很辛苦哇！给作者赏杯咖啡喝，支持作者继续写作😁
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<img src="/img/zhifubao.png" alt="支付宝打赏"> 
		<img src="/img/weixin.png" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#GC_Background"><span class="toc-number">1.</span> <span class="toc-text">GC Background</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cassandra_&_GCInspector"><span class="toc-number">2.</span> <span class="toc-text">Cassandra & GCInspector</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem_1:_进程假死,_很长时间的GC_for_CMS,_最终OOM_[202@2015-10-21_16:19,_21:10]"><span class="toc-number"></span> <span class="toc-text">Problem 1: 进程假死, 很长时间的GC for CMS, 最终OOM [202@2015-10-21 16:19, 21:10]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Zabbix监控"><span class="toc-number">1.</span> <span class="toc-text">Zabbix监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#system-log_&_gc-log_关于GC的吻合"><span class="toc-number">2.</span> <span class="toc-text">system.log & gc.log 关于GC的吻合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GC_Log分析"><span class="toc-number">3.</span> <span class="toc-text">GC Log分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YGC"><span class="toc-number">4.</span> <span class="toc-text">YGC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#很长的FGC"><span class="toc-number">4.1.</span> <span class="toc-text">很长的FGC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#最终OOM时"><span class="toc-number">4.2.</span> <span class="toc-text">最终OOM时</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GC问题再现:_[203@2015-10-28_19:55]"><span class="toc-number">5.</span> <span class="toc-text">GC问题再现: [203@2015-10-28 19:55]</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem_2:_GC引起的读超时?_[229@2015-10-22_17:06-08]"><span class="toc-number"></span> <span class="toc-text">Problem 2: GC引起的读超时? [229@2015-10-22 17:06-08]</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC_Question"><span class="toc-number"></span> <span class="toc-text">GC Question</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tombstone"><span class="toc-number">1.</span> <span class="toc-text">Tombstone</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMS_and_Heap_Memory_Relation"><span class="toc-number">2.</span> <span class="toc-text">CMS and Heap Memory Relation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ParNew_promotion_failed"><span class="toc-number">3.</span> <span class="toc-text">ParNew promotion failed</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2016/07/07/Cassandra-GC-CMS/" data-title="Cassandra CMS GC" data-url="http://github.com/zqhxuyuan/2016/07/07/Cassandra-GC-CMS/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2016/07/07/Cassandra-GC-G1/" title="上一篇: Cassandra G1 GC">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2016/06/30/Hello-Storm/" title="下一篇: 用实例理解Storm的Stream概念">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>