<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½">
<meta property="og:url" content="http://github.com/zqhxuyuan/index.html">
<meta property="og:site_name" content="ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/avatar.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">zqhxuyuan</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						<li>å‹æƒ…é“¾æ¥</li>
						
						
						<li>å…³äºæˆ‘</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives/">æ‰€æœ‰æ–‡ç« </a></li>
				        
							<li><a href="/tags/">æ ‡ç­¾äº‘</a></li>
				        
							<li><a href="/about/">å…³äºæˆ‘</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/cassandra/" style="font-size: 13.33px;">cassandra</a> <a href="/tags/drill/" style="font-size: 20px;">drill</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/spark/" style="font-size: 16.67px;">spark</a> <a href="/tags/storm/" style="font-size: 16.67px;">storm</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">BIG</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="å›åˆ°ä¸»é¡µ">zqhxuyuan</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="/img/avatar.png" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="å›åˆ°ä¸»é¡µ">zqhxuyuan</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives/">æ‰€æœ‰æ–‡ç« </a></li>
		        
					<li><a href="/tags/">æ ‡ç­¾äº‘</a></li>
		        
					<li><a href="/about/">å…³äºæˆ‘</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-2015-11-29-StreamCQL-application" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/02/2015-11-29-StreamCQL-application/" class="article-date">
  	<time datetime="2015-12-02T05:36:53.000Z" itemprop="datePublished">2015-12-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/02/2015-11-29-StreamCQL-application/">StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <a id="more"></a>
<h2 id="å‰æˆ:_CQLä»£ç ç»“æ„">å‰æˆ: CQLä»£ç ç»“æ„</h2><p>ä¹‹å‰æˆ‘ä»¬å¹¶æ²¡æœ‰æ¢³ç†CQLéƒ¨åˆ†çš„ä»£ç ç»“æ„, åœ¨åˆ†æäº†å·®ä¸å¤šçš„ä»£ç ä¹‹å, æ¥çœ‹çœ‹æ¯ä¸ªéƒ¨åˆ†éƒ½ä¸€ä¸€å¯¹åº”:  </p>
<p><img src="http://img.blog.csdn.net/20151130093405880" alt="cql"></p>
<p>è¿˜æ²¡æœ‰æ¶‰åŠçš„åŒ…æ‹¬: PhysicalPlan,ç‰©ç†è®¡åˆ’/é€»è¾‘è®¡åˆ’ä¼˜åŒ–å™¨,executorsæ‰§è¡Œå™¨.    </p>
<h2 id="æ­£æ–‡:_submitApplication">æ­£æ–‡: submitApplication</h2><p>å†ç»åƒè¾›ä¸‡è‹¦, ç»ˆäºå›åˆ°SubmitTaskçš„submitApplication, åˆ›å»ºç‰©ç†è®¡åˆ’Executor,å¹¶æ‰§è¡ŒApplication.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> PhysicalPlanExecutor().execute(context.getApp());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="api-Application_-&gt;_application-Application">api.Application -&gt; application.Application</h3><p>apiçš„Applicationæ˜¯æµå¤„ç†æ‰§è¡Œè®¡åˆ’åº”ç”¨ç¨‹åº, å°è£…çš„æ˜¯CQLè¯­å¥æ„å»ºè€Œæˆçš„åº”ç”¨ç¨‹åº:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;                      </span><br><span class="line">    <span class="keyword">private</span> String applicationId = <span class="keyword">null</span>;                    <span class="comment">//åº”ç”¨id</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName = <span class="keyword">null</span>;                  <span class="comment">//åº”ç”¨åç§°</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, String&gt; confs;                  <span class="comment">//æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ç”¨åˆ°çš„é…ç½®å±æ€§,ä¹ŸåŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> String[] userFiles;                             <span class="comment">//ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ çš„ä¸€äº›æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;UserFunction&gt; userFunctions;               <span class="comment">//ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°,udfå’Œudaféƒ½åœ¨è¿™ä¸ªé‡Œé¢</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Schema&gt; schemas = <span class="keyword">new</span> ArrayList&lt;Schema&gt;(); <span class="comment">//æ‰§è¡Œè®¡åˆ’ä¸­çš„æ‰€æœ‰çš„schema</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Operator&gt; operators = <span class="keyword">null</span>;                <span class="comment">//æ‰§è¡Œè®¡åˆ’ä¸­æ‰€æœ‰çš„æ“ä½œ,åŒ…å«è¾“å…¥ã€è¾“å‡ºå’Œè®¡ç®—æ“ä½œ      </span></span><br><span class="line">    <span class="keyword">private</span> List&lt;OperatorTransition&gt; opTransition = <span class="keyword">null</span>;   <span class="comment">//æ•´ä¸ªæ‰§è¡Œè®¡åˆ’ä¸­æ‰€æœ‰çš„è¿æ¥çº¿ï¼Œå®šä¹‰äº†operatorä¹‹é—´çš„è¿æ¥å…³ç³»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿˜è®°å¾—ä¸Šä¸€ç¯‡ä¸­åœ¨buildApplicationæ—¶,ç”±SplitContextæ‹†åˆ†ç®—å­,ç»„åˆç®—å­ä¼šæŠŠoperatorså’Œtransitionséƒ½è®¾ç½®åˆ°Applicationé‡Œå—?  </p>
</blockquote>
<p>application.Applicationé’ˆå¯¹Schemaå’ŒOperatoré‡‡ç”¨Managerç®¡ç†ç±»(å®é™…ä¸Šåº•å±‚çš„å­˜å‚¨ç»“æ„éƒ½æ˜¯Map)æ¥æ“ä½œ:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String appName;                 <span class="comment">//åº”ç”¨ç¨‹åºåç§°</span></span><br><span class="line">    <span class="keyword">private</span> EventTypeMng streamSchema;      <span class="comment">//æ‰€æœ‰Schemaé›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> OperatorMng operatorManager;    <span class="comment">//ç®—å­é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> StreamingConfig conf;           <span class="comment">//ç³»ç»Ÿçº§åˆ«çš„é…ç½®å±æ€§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Applicationåœ¨<code>API</code>å’Œ<code>ç‰©ç†è®¡åˆ’</code>æ˜¯ä¸åŒçš„å¯¹è±¡, åŒæ ·APIé˜¶æ®µçš„<code>Operator</code>åœ¨ç‰©ç†è®¡åˆ’ä¸­å¯¹åº”çš„æ˜¯<code>IRichOperator</code>.  </p>
<h4 id="IRichOperator">IRichOperator</h4><p>OperatorMngç®¡ç†çš„ç®—å­åŒ…æ‹¬è¾“å…¥ç®—å­(addInputStream),è¾“å‡ºç®—å­(addOutputStream),åŠŸèƒ½ç®—å­(addFunctionStream).  </p>
<blockquote>
<p>è™½ç„¶ä¸¤ä¸ªOperatorå¤„äºä¸åŒçš„é˜¶æ®µ, ä½†æ˜¯æ€»çš„æ¥è¯´éƒ½å¯ä»¥åˆ†ä¸ºè¾“å…¥,è¾“å‡ºå’ŒFunction.  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â‘  application â¬‡ï¸                                            â‘¡ api â¬‡ï¸</span><br><span class="line">IRichOperator (com.huawei.streaming.operator)               Operator (com.huawei.streaming.api.opereators)</span><br><span class="line">    |-- AbsOperator                                             |-- FunctionStreamOperator</span><br><span class="line">        |-- FunctionOperator                                    |-- InnerOutputSourceOperator      </span><br><span class="line">            |-- JoinFunctionOp                                  |-- SplitterOperator</span><br><span class="line">                |-- DataSourceFunctionOp                        |-- OutputStreamOperator</span><br><span class="line">            |-- AggFunctionOp                                   |-- InputStreamOperator</span><br><span class="line">            |-- SplitOp                                         |-- InnerInputSourceOperator</span><br><span class="line">            |-- UnionFunctionOp                                 |-- InnerFunctionOperator</span><br><span class="line">            |-- SelfJoinFunctionOp                                      |-- FunctorOperator</span><br><span class="line">            |-- FunctorOp                                               |-- UnionOperator</span><br><span class="line">            |-- FilterFunctionOp                                        |-- FilterOperator</span><br><span class="line">        |-- OutputOperator                                              |-- BasicAggFunctionOperator</span><br><span class="line">        |-- FunctionStreamOperator                                              |-- JoinFunctionOperator</span><br><span class="line">        |-- InputOperator                                                       |-- AggregateOperator</span><br><span class="line">                                                                                |-- BaseDataSourceOperator</span><br></pre></td></tr></table></figure>
<p><code>IRichOperatoræµå¤„ç†ç®—å­</code>åŸºæœ¬æ¥å£: æ‰€æœ‰çš„æµå¤„ç†ç›¸å…³çš„ç®—å­å®ç°ï¼Œéƒ½æ¥æºäºè¿™ä¸ªç®—å­, æ‰€æœ‰çš„å¤–éƒ¨Stormå®ç°å‡ä¾èµ–äºè¿™ä¸ªæ¥å£  </p>
<p>æ­£å¸¸çš„CQL insertè¯­å¥åªæœ‰ä¸€ä¸ªè¾“å‡º,æ‰€ä»¥åœ¨å‰é¢çš„SplitContextä¸­ä¼šæœ‰ä¸€ä¸ªoutputStreamNameå’Œä¸€ç³»åˆ—çš„operatorså’Œtransitions.<br>ä½†æ˜¯è¿™é‡Œå¯¹äºIRichOperatoræµç®—å­, å®ƒæ˜¯æ„æˆStormçš„Topologyç»„ä»¶,å°±å¿…é¡»è€ƒè™‘ç®—å­ä¹‹é—´æ•°æ®çš„æµåŠ¨,ä¸€ä¸ªBoltå¯èƒ½æœ‰å¤šä¸ªè¾“å…¥å’Œè¾“å‡º.    </p>
<p><img src="http://img.blog.csdn.net/20151201165952194" alt="stream_inout"></p>
<blockquote>
<p>å¯¹äºä¸€ä¸ªç®—å­è€Œè¨€,è¾“å…¥æ•°æ®å¯ä»¥æœ‰å¤šä¸ª.ä½†æ˜¯è¾“å‡ºæ˜¯åªæœ‰ä¸€ä¸ª! è¿™å°±å¥½æ¯”æœ€ç»ˆçš„selectåªä¼šæœ‰ä¸€ä¸ªè¾“å‡ºschema: selectè¾“å‡ºçš„æ•°æ®ä½œä¸ºç®—å­çš„è¾“å‡º.<br>æ‰€ä»¥IRichOperatorçš„è¾“å…¥getInputStreamå’ŒgetInputSchemaéƒ½æ˜¯é›†åˆ, è€Œè¾“å‡ºçš„getOutputStreamå’ŒgetOutputSchemaéƒ½æ˜¯å•ä¸€çš„.<br>Update: è¾“å…¥è¾“å‡ºè¿™é‡Œå…¶å®çœ‹æµï¼Œåæ­£æ˜¯ä¸€ä¸ªæµä¸€ä¸ªåç§°ã€‚éƒ½æ˜¯å…è®¸å¤šè¾“å…¥å¤šè¾“å‡ºçš„ã€‚ä¸€ä¸ªç®—å­å°±æ˜¯ä¸€ä¸ªæµï¼Œä¸€ä¸ªç®—å­çš„å¤šä¸ªå®ä¾‹éƒ½å±äºä¸€ä¸ªæµã€‚  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRichOperator</span> <span class="keyword">extends</span> <span class="title">IOperator</span>, <span class="title">Configurable</span></span>&#123;     <span class="comment">//â‘  æµå¤„ç†ç®—å­åŸºæœ¬æ¥å£</span></span><br><span class="line">    <span class="function">String <span class="title">getOperatorId</span><span class="params">()</span></span>;                     <span class="comment">//è·å–ç®—å­id</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getParallelNumber</span><span class="params">()</span></span>;                    <span class="comment">//è·å–ç®—å­å¹¶å‘åº¦</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">getInputStream</span><span class="params">()</span></span>;              <span class="comment">//è·å–è¾“å…¥æµåç§°, å¤šä¸ªè¾“å…¥æµ</span></span><br><span class="line">    <span class="function">String <span class="title">getOutputStream</span><span class="params">()</span></span>;                   <span class="comment">//è·å–è¾“å‡ºæµåç§°</span></span><br><span class="line">    Map&lt;String, IEventType&gt; getInputSchema();   <span class="comment">//è·å–è¾“å…¥schema  â¬…ï¸ &lt;keyæ˜¯è¾“å…¥æµåç§°,IEventTypeæ˜¯è¾“å…¥æµçš„Schema&gt;</span></span><br><span class="line">    <span class="function">IEventType <span class="title">getOutputSchema</span><span class="params">()</span></span>;               <span class="comment">//è·å–è¾“å‡ºschema  â¬…ï¸ </span></span><br><span class="line">    Map&lt;String, GroupInfo&gt; getGroupInfo();      <span class="comment">//è·å–åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Operator</span> </span>&#123;                         <span class="comment">// â‘¡ æ¯ä¸ªè®¡ç®—å•å…ƒæˆä¸ºä¸€ä¸ªOperator,å®šä¹‰äº†å„ç±»æ“ä½œ.åˆ†ä¸ºSourceå’ŒInnerFunction</span></span><br><span class="line">    <span class="keyword">private</span> String id;                          <span class="comment">//ç®—å­ID</span></span><br><span class="line">    <span class="keyword">private</span> String name;                        <span class="comment">//ç®—å­åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> parallelNumber;                 <span class="comment">//å¹¶è¡Œåº¦</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, String&gt; args;       <span class="comment">//æ¯ä¸ªoperatorçš„å‚æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorTransition</span> </span>&#123;               <span class="comment">// â‘¢ å„ç§Operatorçš„è¿æ¥å…³ç³»,å®šä¹‰äº†ä»ä¸€ä¸ªoperatoråˆ°å¦å¤–ä¸€ä¸ªoperatorçš„è¿æ¥</span></span><br><span class="line">    <span class="keyword">private</span> String id;                          <span class="comment">//å½“å‰è¿æ¥çš„id</span></span><br><span class="line">    <span class="keyword">private</span> String streamName;                  <span class="comment">//æµåç§°</span></span><br><span class="line">    <span class="keyword">private</span> String fromOperatorId;              <span class="comment">//å‘èµ·è¿æ¥çš„Operator id</span></span><br><span class="line">    <span class="keyword">private</span> String toOperatorId;                <span class="comment">//æ¥æ”¶è¿æ¥çš„Operator id</span></span><br><span class="line">    <span class="keyword">private</span> DistributeType distributedType;     <span class="comment">//æ•°æ®è·å–ç±»å‹,ä»…ä»…åœ¨ésourceOperatorä¸­å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">private</span> String distributedFields;           <span class="comment">//æ•°æ®åˆ†å‘å­—æ®µ, ä»…åœ¨distributedTypeä¸ºfieldçš„æ—¶å€™ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="keyword">private</span> String schemaName;                  <span class="comment">//æµä¸Šè¿›è¡Œæ•°æ®ä¼ è¾“çš„æ—¶å€™çš„schemaåç§°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿˜è®°å¾—ä¸Šä¸€ç« åœ¨åˆ›å»ºTransitionæ—¶ä¼šæŒ‡å®šåˆ†ç»„å­—æ®µå’Œåˆ†ç»„ç­–ç•¥å—? å’Œè¿™é‡Œçš„GroupByåº”è¯¥æ˜¯ä¼šæœ‰ç‚¹è¡€ç¼˜å…³ç³»çš„. å½“ç„¶ç®—å­è¿˜å°‘ä¸äº†è¾“å…¥è¾“å‡ºSchema.   </p>
</blockquote>
<h4 id="PhysicalPlanExecutor_-&gt;_ExecutorPlanGenerator">PhysicalPlanExecutor -&gt; ExecutorPlanGenerator</h4><p>PhysicalPlanExecutor.executeä¼ å…¥çš„æ˜¯APIçš„Application, è€Œsubmit(app)çš„appæ˜¯application.Application.<br>æ€ä¹ˆè½¬æ¢: é€šè¿‡ExecutorPlanGeneratorç‰©ç†è®¡åˆ’ç”Ÿæˆå™¨ç”Ÿæˆå¯æ‰§è¡Œçš„è®¡åˆ’. å¯æ‰§è¡ŒæŒ‡çš„æ˜¯å¯ä»¥è¿è¡Œåœ¨Stormå¼•æ“.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Application apiApplication)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"start to execute application &#123;&#125;"</span>, apiApplication.getApplicationId());        </span><br><span class="line">    parseUserDefineds(apiApplication, isStartFromDriver);   <span class="comment">//â‘  å‡†å¤‡å·¥ä½œ</span></span><br><span class="line">    com.huawei.streaming.application.Application app = generatorPlan(apiApplication);   <span class="comment">// â¬…ï¸ API.App-&gt;application.App</span></span><br><span class="line">    submit(app);                    <span class="comment">//â‘£ æäº¤Application</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”±ç‰©ç†æ‰§è¡Œè®¡åˆ’api.Applicationç”Ÿæˆå¯æ‰§è¡Œè®¡åˆ’application.Application(æœ€ç»ˆç”Ÿæˆçš„ï¼Œå¯ä»¥æäº¤çš„åº”ç”¨ç¨‹åº)</span></span><br><span class="line"><span class="keyword">private</span> com.huawei.streaming.application.<span class="function">Application <span class="title">generatorPlan</span><span class="params">(Application apiApplication)</span> </span>&#123;</span><br><span class="line">    preExecute(apiApplication);     <span class="comment">//æ‰§è¡Œå™¨æ‰§è¡Œä¹‹å‰çš„é’©å­</span></span><br><span class="line">    <span class="keyword">new</span> PhysicPlanChecker().check(apiApplication);</span><br><span class="line">    <span class="comment">//â‘¡ ç”¨æˆ·è‡ªå®šä¹‰çš„å¤„ç†: æ‰§è¡Œè®¡åˆ’çš„ç»„è£…, æ„å»ºapplication, è¡¨è¾¾å¼çš„è§£æè¢«å»¶è¿Ÿåˆ°è¿™é‡Œæ¥å®ç°</span></span><br><span class="line">    com.huawei.streaming.application.Application app = generator.generate(apiApplication);  </span><br><span class="line">    preSubmit(app);                 <span class="comment">//æäº¤æ‰§è¡Œè®¡åˆ’ä¹‹å‰çš„é’©å­</span></span><br><span class="line">    executorChecker.check(app);     <span class="comment">//â‘¢ æ‰§è¡Œè®¡åˆ’æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘ å‡†å¤‡å·¥ä½œ<code>parseUserDefineds</code>: æ³¨å†ŒjaråŒ…,æ³¨å†Œå‡½æ•°,æ‰“åŒ…ç­‰(ç±»ä¼¼stormä¸­éœ€è¦ä¸Šä¼ jaråŒ…).    </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">24</span> | INFO  | [main] | ğŸ‘‰ start to execute application example | com.huawei.streaming.cql.executor.PhysicalPlanExecutor (PhysicalPlanExecutor.java:<span class="number">127</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">25</span> | INFO  | [main] | start to unzip jar stream-storm-<span class="number">1.0</span>-jar-with-dependencies.jar | com.huawei.streaming.cql.executor.mergeuserdefinds.JarExpander (JarExpander.java:<span class="number">79</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">25</span> | INFO  | [main] | unzip jar /<span class="keyword">private</span>/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/da6d53114b1f49458c0e6329553b1ff9/stream-storm-<span class="number">1.0</span>-jar-with-dependencies.jar to /<span class="keyword">private</span>/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/da6d53114b1f49458c0e6329553b1ff9/jartmp | com.huawei.streaming.cql.executor.mergeuserdefinds.JarExpander (JarExpander.java:<span class="number">91</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">30</span> | INFO  | [main] | finished to unzip jar to dir | com.huawei.streaming.cql.executor.mergeuserdefinds.JarExpander (JarExpander.java:<span class="number">84</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">30</span> | INFO  | [main] | start to copy ch | com.huawei.streaming.cql.executor.mergeuserdefinds.JarFilesMerger (JarFilesMerger.java:<span class="number">82</span>)</span><br><span class="line">...</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">38</span> | INFO  | [main] | finished to package jar | com.huawei.streaming.cql.executor.mergeuserdefinds.JarPacker (JarPacker.java:<span class="number">68</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | ğŸ‘‰ start to generator executor application <span class="keyword">for</span> app example | com.huawei.streaming.cql.executor.ExecutorPlanGenerator (ExecutorPlanGenerator.java:<span class="number">102</span>)</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„å¯æ‰§è¡Œè®¡åˆ’ä¼š: â‘ è®¾ç½®ç³»ç»Ÿé…ç½®å‚æ•°, è§£æApplicationä¸­çš„â‘¡<code>Schema</code>å’Œâ‘¢<code>Operators</code>, æœ€ç»ˆè¿”å›çš„æ˜¯å¯æ‰§è¡Œçš„Application.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> com.huawei.streaming.application.<span class="function">Application <span class="title">generate</span><span class="params">(Application vap)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"start to generator executor application for app "</span> + vap.getApplicationId());</span><br><span class="line">    apiApplication = vap;           <span class="comment">//è¿™ä¸ªæ˜¯APIçš„Application</span></span><br><span class="line">    createEmptyApplication(vap.getApplicationId());</span><br><span class="line">    parseUserDefineds(vap);         <span class="comment">//â‘  ç”¨æˆ·è‡ªå®šä¹‰çš„å¤„ç†(ç³»ç»Ÿé…ç½®å‚æ•°)</span></span><br><span class="line">    parseSchemas();                 <span class="comment">//â‘¡ è§£ææ‰€æœ‰çš„Schemaï¼Œæ„å»ºschemaä¿¡æ¯</span></span><br><span class="line">    parseOperators();               <span class="comment">//â‘¢ è§£ææ‰€æœ‰çš„Operator,æ„å»ºOperatorInfo. æ•´ç†Operatorä¸­çš„ä¸Šä¸‹çº§å…³ç³»</span></span><br><span class="line">    <span class="keyword">return</span> executorApp;             <span class="comment">//è¿”å›çš„æ˜¯å¯æ‰§è¡Œçš„Application</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="parseSchemas:_Schema_-&gt;_TupleEventType">parseSchemas: Schema -&gt; TupleEventType</h3><p>åœ¨ç¬¬ä¸€ç¯‡ä¸­Topologyçš„CQLè¯­å¥:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s(<span class="keyword">id</span> <span class="built_in">INT</span>, <span class="keyword">name</span> <span class="keyword">STRING</span>, <span class="keyword">type</span> <span class="built_in">INT</span>) <span class="keyword">SOURCE</span> randomgen PROPERTIES ( timeUnit = <span class="string">"SECONDS"</span>, <span class="keyword">period</span> = <span class="string">"1"</span>, eventNumPerperiod = <span class="string">"1"</span>, isSchedule = <span class="string">"true"</span> );</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM rs(<span class="keyword">type</span> <span class="built_in">INT</span>, cc <span class="built_in">INT</span>) SINK consoleOutput;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs               #<span class="keyword">INSERT</span> <span class="keyword">STATEMENT</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">as</span> cc        #<span class="keyword">SELECT</span> <span class="keyword">STATEMENT</span>      </span><br><span class="line"><span class="keyword">FROM</span> s[<span class="keyword">RANGE</span> <span class="number">20</span> SECONDS BATCH]      #<span class="keyword">FROM</span> CLAUSE</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span>;</span>         #WHERE CLAUSE/GROUPBY CLAUSE</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æœ‰ä¸¤ä¸ªæµ,åˆ†åˆ«æ˜¯è¾“å…¥æµs, è¾“å‡ºæµrs. å› æ­¤ä¼šå°†è¿™ä¸¤ä¸ªSchemaæ·»åŠ åˆ°å¯æ‰§è¡ŒApplicationä¸­.       </p>
<blockquote>
<p>å¯¹äºè¾“å…¥è¾“å‡ºè€Œè¨€,æœ€é‡è¦çš„å°±æ˜¯Schemaäº†, åœ¨è¾“å…¥å’Œè¾“å‡ºè¿™ä¸€å¯¹åŒèƒèƒçœ¼ä¸­,æ•°æ®è¿›æ¥å’Œå‡ºå»çš„æ ¼å¼éå¸¸é‡è¦.<br>å› ä¸ºå¤–éƒ¨æ•°æ®è¿›æ¥,å’Œæš´éœ²æ•°æ®ç»™å¤–éƒ¨,æœ€é‡è¦çš„æ˜¯æ ¼å¼. ä½ ä¸­é—´ä¸ç®¡æ€ä¹ˆå¤„ç†,å®ƒä»¬éƒ½ä¸ç®¡. Only Schema! Give Me the Data!  </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | AddEventType enter, the eventtypeName is:s. | com.huawei.streaming.event.EventTypeMng (EventTypeMng.java:<span class="number">73</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | AddEventType enter, the eventtypeName is:rs. | com.huawei.streaming.event.EventTypeMng (EventTypeMng.java:<span class="number">73</span>)</span><br></pre></td></tr></table></figure>
<p>parseSchemaToIEventä¼šå°†APIçš„Applicationä¸­æ‰€æœ‰çš„Schemaéƒ½è½¬æ¢ä¸ºIEventäº‹ä»¶:TupleEventType.<br>Schemaä¸­çš„Columnå¯¹åº”TupleEventTypeçš„Attribute. Schemaçš„streamName/idå¯¹åº”äº†ä¸‹é¢çš„name/äº‹ä»¶ç±»å‹.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TupleEventType</span> <span class="keyword">implements</span> <span class="title">IEventType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;                                <span class="comment">//schemaName,è¡¨å</span></span><br><span class="line">    <span class="keyword">private</span> Attribute[] schema;                         <span class="comment">//schemas, æ‰€æœ‰åˆ—</span></span><br><span class="line">    <span class="keyword">private</span> String[] attNames;                          <span class="comment">//æ‰€æœ‰åˆ—çš„åˆ—å</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt; ? &gt;[] attTypes;                      <span class="comment">//æ‰€æœ‰åˆ—çš„åˆ—ç±»å‹</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Integer&gt; attid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Schemaçš„ç®¡ç†ç±»ç”¨Mapç»“æ„ä¿å­˜schemaName/eventTypeNameå’Œå¯¹åº”çš„Schema/TupleEventType: è¡¨å-&gt;è¡¨ç»“æ„.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventTypeMng</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IEventType&gt; schemas;            <span class="comment">//MAP: æ•°æ®ç±»å‹åç§° =&gt; å…·ä½“æ•°æ®ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEventType</span><span class="params">(IEventType schema)</span> </span>&#123;       <span class="comment">//â¬…ï¸ executorApp.addEventSchema(tupleEventType)</span></span><br><span class="line">        schemas.put(schema.getEventTypeName(), schema); <span class="comment">//æ•°æ®ç±»å‹|äº‹ä»¶ç±»å‹|è¡¨åschemaName|streamNameæµåç§°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="parseOperators:_ç®—å­è§£æ">parseOperators: ç®—å­è§£æ</h3><blockquote>
<p>å‰é¢ç¬¬ä¸€ç¯‡çš„æ—¶å€™submitä¹‹å‰æ¯æ¡CQLè¯­å¥éƒ½æœ‰start to parse cqlè¿‡ä¸€æ¬¡äº†,è¿™é‡Œä¸ºä»€ä¹ˆè¿˜ä¼šå†æ¬¡parse?<br>ç­”: å‰é¢åªæ˜¯LazyTaskæ‡’è§£æ,å…¶å®è¿˜æ˜¯æ²¡æœ‰å¼€å§‹çš„. é‚£ä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œæ‰å¼€å§‹? å› ä¸ºè§£æå®Œschemaå, å°±è¯¥è½®åˆ°operatorçš„è§£æäº†.<br>ä¸è¿‡æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯, æœ€å¼€å§‹çš„parseæ˜¯å¯¹æ•´ä¸ªCQLè¯­å¥, è¿™é‡Œåªè§£æäº†éƒ¨åˆ†, æ¯”å¦‚è¡¨è¾¾å¼,groupby,èšåˆ.  <code>WHYYY?</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">è§£æç®—å­: <span class="number">1</span>)è§£æäºŒå…ƒè¡¨è¾¾å¼(å±æ€§å€¼è¡¨è¾¾å¼) id &gt; <span class="number">5</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | start to parse cql : (s.id &gt; <span class="number">5</span>) | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.java:<span class="number">44</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.java:<span class="number">69</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | start to create binary Expressions. | com.huawei.streaming.cql.executor.expressioncreater.PropertyValueExpressionCreator (BinaryExpressionCreator.java:<span class="number">54</span>)  â¬…ï¸</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Parse Completed, cql : s.type,  count( s.id )  | com.huawei.streaming.cql.semanticanalyzer.parser.SelectClauseParser (SelectClauseParser.java:<span class="number">68</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>)è§£æ group by</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | start to parse cql : s.type | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:<span class="number">45</span>)   â¬…ï¸</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:<span class="number">68</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | start to parse cql : s.type | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:<span class="number">45</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:<span class="number">68</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>)èšåˆç®—å­ count(id)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | start to create aggregate service | com.huawei.streaming.cql.executor.operatorviewscreater.AggregateServiceViewCreator (AggregateServiceViewCreator.java:<span class="number">89</span>)  â¬…ï¸</span><br></pre></td></tr></table></figure>
<p>ä¸ä»…ä»…æ˜¯Driver.runè°ƒç”¨äº†ApplicationParser.parse. ä»è°ƒç”¨æ ‘è¿˜èƒ½çœ‹åˆ°æœ‰XXXInfoCreator,ViewCreator.(<code>è¿˜è®°å¾—èšåˆä¹Ÿæ˜¯ä¸€ç§æŸ¥è¯¢å—</code>)</p>
<p><img src="http://img.blog.csdn.net/20151130172800418" alt="stream-opinfo"></p>
<p>ç®—å­è§£æ: è¿™é‡Œçš„è§£ææ˜¯ä¸ºäº†ä½¿å¾—è¾“å…¥å’Œè¾“å‡ºç®—å­ç»Ÿä¸€ï¼Œé¿å…ç”¨æˆ·è‡ªå®šä¹‰å’Œç³»ç»Ÿå†…ç½®çš„ç®—å­å¯¹å¤–è¡¨ç°ä¸ä¸€è‡´å¤„ç†èµ·æ¥çš„éº»çƒ¦<br>ç”±äºè¾“å…¥å’Œè¾“å‡ºç®—å­ä¸­å­˜åœ¨ç‰¹ä¾‹ï¼Œå³é’ˆå¯¹æ–‡ä»¶ï¼Œtcpï¼Œkafkaç­‰ç¼–å†™äº†ç‰¹ä¾‹, æ‰€ä»¥éœ€è¦â‘ é¦–å…ˆå°†ä»–ä»¬æŠ½è±¡åŒ–ï¼Œä¹‹åå†æ¥å¤„ç†  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseOperators</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Map&lt;String, Operator&gt; opts = formatOperators();                     <span class="comment">//â‘  è¾“å…¥è¾“å‡ºç®—å­æŠ½è±¡åŒ–</span></span><br><span class="line">    Map&lt;String, AbsOperator&gt; opMappings = createOperatorInfos(opts);    <span class="comment">//â‘¡ ç®—å­è§£æ â¬…ï¸  Operator -&gt; AbsOperator</span></span><br><span class="line">    combineOperators(opMappings);                                       <span class="comment">//â‘¢ æ•´ç†ç®—å­é¡ºåº</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, AbsOperator&gt; et : opMappings.entrySet())&#123;        <span class="comment">//â‘£ æ·»åŠ ç®—å­åˆ°Application</span></span><br><span class="line">        IRichOperator operator = et.getValue();</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œä¹Ÿç®—æ˜¯input</span></span><br><span class="line">        <span class="keyword">if</span> (operator <span class="keyword">instanceof</span> InputOperator)&#123;</span><br><span class="line">            executorApp.addInputStream(operator);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œä¹Ÿç®—æ˜¯output</span></span><br><span class="line">        <span class="keyword">if</span> (operator <span class="keyword">instanceof</span> OutputOperator)&#123;</span><br><span class="line">            executorApp.addOutputStream(operator);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸æ˜¯è¾“å…¥è¾“å‡º,å°±æ˜¯åŠŸèƒ½ç®—å­</span></span><br><span class="line">        executorApp.addFunctionStream(operator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¡ Operatoræ˜¯ç®—å­, AbsOperatoråˆ™æ˜¯æµå¤„ç†ç®—å­(ç»§æ‰¿IRichOperator).å®ƒä»¬çš„è½¬æ¢ç”±createOperatorInfos-&gt;OperatorInfoCreatorFactoryå®Œæˆ.<br>â‘£ å’ŒSchemaçš„ç®¡ç†ä¸€æ ·,ç®—å­çš„ç®¡ç†ç±»OperatorMngç”¨ä¸‰ä¸ªMapåˆ†åˆ«ç®¡ç†è¾“å…¥,è¾“å‡º,åŠŸèƒ½ç®—å­. Mapçš„keyæ˜¯operatorId,valueæ˜¯Operatorç®—å­æœ¬èº«.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorMng</span></span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> List&lt;IRichOperator&gt; sortedFunctions;        <span class="comment">//DFGæ’åºåçš„åŠŸèƒ½ç®—å­åˆ—è¡¨ï¼Œä½œä¸ºåˆ›å»ºStormæ‹“æ‰‘é¡ºåºçš„åŸºç¡€(è¾“å‡ºå’ŒåŠŸèƒ½ç®—å­ç»„æˆ--&gt;Bolt)</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichOperator&gt; inputs;          <span class="comment">//è¾“å…¥ç®—å­ --&gt; Spout</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichOperator&gt; functions;       <span class="comment">//åŠŸèƒ½ç®—å­ --&gt; Bolt</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichOperator&gt; outputs;         <span class="comment">//è¾“å‡ºç®—å­ --&gt; Bolt</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šé¢parseOperatorsçš„ä¸¤ä¸ªMap:optså’ŒopMappingä»¥åŠOperatorMngçš„ä¸‰ä¸ªMapçš„Key,Valueéƒ½æ˜¯operatorID-&gt;AbsOperatorå®ä¾‹.  </p>
</blockquote>
<h4 id="createOperatorInfos">createOperatorInfos</h4><p>operatorsæ˜¯APIä¸­çš„ç®—å­, è¦è½¬æ¢ä¸ºå¯æ‰§è¡Œè®¡åˆ’å¯¹åº”çš„ç®—å­, é€šè¿‡OperatorInfoCreatorFactoryå·¥å‚ç±»æ ¹æ®operatorä¸Šçš„æ³¨è§£<br>å…ˆå–å¾—OperatorInfoCreatorçš„å…·ä½“å®ç°ç±»,å†è°ƒç”¨createInstance, åœ¨å…·ä½“çš„OperatorInfoCreatorå®ç°ç±»ä¸­æ‰å®Œæˆè½¬æ¢.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, AbsOperator&gt; createOperatorInfos(Map&lt;String, Operator&gt; operators) &#123;</span><br><span class="line">    Map&lt;String, AbsOperator&gt; opMappings = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">for</span> (Operator op : operators.values()) &#123;</span><br><span class="line">        AbsOperator opinfo = createOperatorInfo(op);</span><br><span class="line">        opMappings.put(opinfo.getOperatorId(), opinfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> opMappings;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> AbsOperator <span class="title">createOperatorInfo</span><span class="params">(Operator operator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> OperatorInfoCreatorFactory.createOperatorInfo(apiApplication, operator, executorApp.getStreamSchema(), <span class="keyword">this</span>.systemConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾Operatoræ˜¯AggregateOperator,å®ƒçš„æ³¨è§£æ˜¯AggregaterInfoCreator.æ‰€ä»¥æœ€ç»ˆè°ƒç”¨çš„æ˜¯AggregaterInfoCreator.createInstanceåˆ›å»ºAggFunctionOp.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@OperatorInfoCreatorAnnotation</span>(<span class="type">AggregaterInfoCreator</span>.<span class="keyword">class</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AggregateOperator</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BasicAggFunctionOperator</span></span></span><br></pre></td></tr></table></figure>
<p>æ¥å£OperatorInfoCreatoråˆ›å»ºæ¯ä¸ªç®—å­çš„å®ä¾‹, createInstanceå‚æ•°åˆ†åˆ«æ˜¯: æ‰§è¡Œè®¡åˆ’ä¿¡æ¯,xmlæ‰§è¡Œè®¡åˆ’ä¸­çš„ç®—å­ä¿¡æ¯(å“ªé‡Œçš„xml?),schemaä¿¡æ¯,ç³»ç»Ÿé…ç½®ä¿¡æ¯.<br>ä¸‹å›¾æ˜¯OperatorInfoCreatorçš„å®ç°ç±», åˆ›å»ºçš„ç®—å­å®ä¾‹é™¤äº†FunctionOperator,è¿˜æœ‰InputOperator,OutputOperator,FunctionStreamOperator.  </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">OperatorInfoCreator</span> (c.h.s.c.e.operatorinfocreater)     åˆ›å»ºçš„ç®—å­å®ä¾‹               çˆ¶ç±»</span><br><span class="line">    |-- <span class="constant">AggregaterInfoCreator</span>                           <span class="constant">AggFunctionOp</span>           <span class="prompt">&gt;&gt; </span><span class="constant">FunctionOperator</span></span><br><span class="line">    |-- <span class="constant">DataSourceInfoOperatorCreator</span>                   <span class="constant">FunctionOperator</span>        -- <span class="constant">FunctionOperator</span></span><br><span class="line">    |-- <span class="constant">FunctorInfoCreator</span>                              <span class="constant">FunctorOp</span>               <span class="prompt">&gt;&gt; </span><span class="constant">FunctionOperator</span></span><br><span class="line">    |-- <span class="constant">FilterInfoCreator</span>                               <span class="constant">FilterFunctionOp</span>        <span class="prompt">&gt;&gt; </span><span class="constant">FunctionOperator</span>     </span><br><span class="line">    |-- <span class="constant">InputInfoCreator</span>                                                           <span class="constant">InputOperator</span></span><br><span class="line">    |-- <span class="constant">UnionInfoCreator</span>                                <span class="constant">UnionFunctionOp</span>         <span class="prompt">&gt;&gt; </span><span class="constant">FunctionOperator</span></span><br><span class="line">    |-- <span class="constant">OutputInfoCreator</span>                                                          <span class="constant">OutputOperator</span></span><br><span class="line">    |-- <span class="constant">SplitterInfoCreator</span>                             <span class="constant">SplitOp</span>                 <span class="prompt">&gt;&gt; </span><span class="constant">FunctionOperator</span></span><br><span class="line">    |-- <span class="constant">JoinInfoOperatorCreator</span>                         <span class="constant">JoinFunctionOp</span>          <span class="prompt">&gt;&gt; </span><span class="constant">FunctionOperator</span></span><br><span class="line">    |-- <span class="constant">FunctionStreamInfoCreator</span>                                                  <span class="constant">FunctionStreamOperator</span></span><br></pre></td></tr></table></figure>
<p>ä»¥AggregaterInfoCreatorå°†<code>AggregateOperator</code>è½¬æ¢ä¸º<code>AggFunctionOp</code>ä¸ºä¾‹: ç”±äºAggregateOperatoræœ¬èº«åŒ…å«äº†Windowå¯¹è±¡<br>ä»¥åŠfilterBeforeAggregate,filterAfterAggregateç­‰å­—ç¬¦ä¸², æ‰€ä»¥æ ¹æ®è¿™äº›æ•°æ®æ„é€ ç›¸åº”çš„å¯¹è±¡,å¹¶æœ€ç»ˆæ„é€ å‡ºAggFunctionOp.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbsOperator <span class="title">createInstance</span><span class="params">(Application vapp, Operator operator, EventTypeMng streamschema, Map&lt;String, String&gt; systemConfig)</span> </span>&#123;</span><br><span class="line">    LOG.debug(<span class="string">"start to create aggregate operator"</span>);        <span class="comment">//LOG</span></span><br><span class="line">    prepare(vapp, operator, systemConfig);</span><br><span class="line">    <span class="comment">//çª—å£,è¿‡æ»¤,è¡¨è¾¾å¼     </span></span><br><span class="line">    WindowViewCreator creater = <span class="keyword">new</span> WindowViewCreator();</span><br><span class="line">    IWindow window = creater.create(inputSchemas, aggOperator.getWindow(), <span class="keyword">this</span>.applicationConfig);</span><br><span class="line">    FilterView filterView = createFilterView();</span><br><span class="line">    IExpression bexpr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (filterView != <span class="keyword">null</span>) bexpr = filterView.getBoolexpr();</span><br><span class="line">    <span class="comment">//èšåˆç»“æœåˆå¹¶     </span></span><br><span class="line">    AggResultSetParameters pars = createResultSetMergeParmeters(streamschema, window, bexpr);</span><br><span class="line">    IAggResultSetMerge resultSetMerge = <span class="keyword">new</span> AggResultSetMergeViewCreator(pars).create();        <span class="comment">// â¬…ï¸ </span></span><br><span class="line">    <span class="comment">//èšåˆç®—å­</span></span><br><span class="line">    AggFunctionOp aggFunctionOp = <span class="keyword">new</span> AggFunctionOp(window, filterView, resultSetMerge, OutputTypeAnalyzer.createOutputType(aggOperator.getWindow()));</span><br><span class="line">    <span class="comment">//ç³»ç»Ÿå‚æ•°</span></span><br><span class="line">    StreamingConfig config = <span class="keyword">new</span> StreamingConfig();</span><br><span class="line">    <span class="keyword">if</span> (operator.getArgs() != <span class="keyword">null</span>) config.putAll(operator.getArgs());</span><br><span class="line">    config.putAll(<span class="keyword">this</span>.applicationConfig);</span><br><span class="line">    aggFunctionOp.setConfig(config);</span><br><span class="line">    <span class="comment">//è®¾ç½®å¹¶è¡Œåº¦å’ŒID,å®Œæˆæµç®—å­çš„æ„å»º</span></span><br><span class="line">    <span class="keyword">return</span> OperatorInfoCreatorFactory.buildStreamOperator(operator, aggFunctionOp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ç”ŸæˆAggFunctionOpåŠ¨ç”¨äº†WindowViewCreatoråˆ›å»ºWindow,FilterView,AggResultSetMergeViewCreatoråˆ›å»ºIAggResultSetMerge. æœ€åç»„è£…æˆAggFunctionOp.   </p>
<blockquote>
<p>ä¸Šä¸€ç« AggregateSplitteræ‹†åˆ†ç®—å­çš„æ—¶å€™è§£æFromå­å¥æ—¶å°±åˆ›å»ºäº†FilterBeforeWindowçš„FilterOperatorå’ŒAggregateOperator,<br>è¿™é‡Œä¹Ÿæœ‰Windowå’ŒFilter,ä¸è¿‡æ˜¯FilterBeforeAggregate. è¿™ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«å¯¹åº”äº†AggregateOperatorçš„Windowå¯¹è±¡å’ŒfilterBeforeAggregateå­—ç¬¦ä¸².<br>è¿™æ˜¯å› ä¸ºæ‹†åˆ†ç®—å­çš„æ—¶å€™åˆ›å»ºçš„FilterOperatoræ˜¯FilterBeforeWindow, åˆ›å»ºçš„AggregateOperatoræœ¬èº«åŒ…å«äº†FilterBeforeAggregateå’ŒWindow.   </p>
<p>IAggResultSetMergeè¡¨ç¤ºèšåˆç»“æœåˆå¹¶. å°†IAggResultSetMergeè®¾ç½®ç»™AggFunctionOp, åé¢åˆå§‹åŒ–Opçš„æ—¶å€™ä¼šç”¨åˆ°è¿™ä¸ªå¯¹è±¡æ¥åˆ›å»ºå¤„ç†è§†å›¾.<br>A.ç»“åˆå‰é¢çš„ä»£ç é˜…è¯»ä½“éªŒ, æ¯”å¦‚ç¬¬ä¸€ç« åˆ›å»ºå®ŒTaskå’ŒSemanticAnalyzeréƒ½ä¼šåˆå§‹åŒ–.è¿™é‡Œåˆ›å»ºå®ŒOpä¹Ÿä¼šåˆå§‹åŒ–æµè®¡ç®—ç®—å­.<br>B.å®é™…ä¸Šå¯¹è±¡åˆ›å»ºå®Œä¸å°±æ˜¯è¢«ä½¿ç”¨å˜›! å¦‚æœæœ‰ä¾èµ–çš„å¯¹è±¡,å¯ä»¥è®¾ç½®åˆ°æ„é€ å‡½æ•°ä¸­,åœ¨å®é™…ä½¿ç”¨å¯¹è±¡çš„æ—¶å€™è·å–ä¾èµ–å¯¹è±¡è¿›è¡Œå¿…è¦è®¡ç®—,å……åˆ†ä½“ç°JAVAçš„é¢å‘å¯¹è±¡æ€æƒ³.<br>C.æ•°æ®çš„ä¼ é€’:ä»è¯­æ³•è§£æç»“æœåˆ°è¯­ä¹‰è§£æç»“æœåˆ°æ‹†åˆ†çš„ç®—å­å†åˆ°è¿™é‡Œçš„æµè®¡ç®—ç®—å­. æ•°æ®éƒ½æ˜¯å±‚å±‚ä¼ é€’å¹¶ä¸æ–­æ›´æ–°æˆ–æ·»åŠ æ–°çš„æ•°æ®ç»“æ„æ»¡è¶³ä¸åŒé˜¶æ®µçš„å¯¹è±¡æ„å»º.     </p>
</blockquote>
<h4 id="combineOperators">combineOperators</h4><blockquote>
<p>ä¸Šä¸€ç¯‡é‡ç‚¹ä»‹ç»äº†æ‹†åˆ†ç®—å­SplitContext(Operator)å’Œç»„åˆç®—å­OperatorCombiner(è¿çº¿). è¿™é‡Œä¹Ÿä¸ä¾‹å¤–,åœ¨åˆ›å»ºå®Œå…·ä½“çš„AbsOperatorç®—å­å,ä¹Ÿéœ€è¦ç»„åˆ.   </p>
</blockquote>
<p>combineOperatorsä¼šå°†ç®—å­ç”¨OperatorTransitionè¿›è¡Œè¿æ¥: æ¢³ç†operatorInfoä¹‹é—´çš„ä¸Šä¸‹çº§å…³ç³»  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineOperators</span><span class="params">(Map&lt;String, AbsOperator&gt; operatorInfos)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ç®—å­ä¹‹é—´çš„è¿æ¥, è·å–ç®—å­é€šè¿‡apiApplication.getOperators(), è·å–è¿çº¿ä¹Ÿæ˜¯é€šè¿‡apiApplication</span></span><br><span class="line">    <span class="keyword">for</span> (OperatorTransition ot : apiApplication.getOpTransition()) &#123;</span><br><span class="line">        <span class="comment">//è·å–è¿æ¥çš„å…¥å£å’Œå‡ºå£ç®—å­</span></span><br><span class="line">        String fromOpId = ot.getFromOperatorId();</span><br><span class="line">        String toOpId = ot.getToOperatorId();</span><br><span class="line">        String streamName = ot.getStreamName();</span><br><span class="line">        DistributeType distributedType = ot.getDistributedType();</span><br><span class="line">        String distributedFields = ot.getDistributedFields();</span><br><span class="line">        <span class="comment">//è¿æ¥çš„Schema, å¯¹äºFromå’ŒToéƒ½æ˜¯ä½¿ç”¨ç›¸åŒçš„Schema</span></span><br><span class="line">        String outputSchemaName = ot.getSchemaName();</span><br><span class="line">        distributedFields = ExecutorUtils.removeStreamName(distributedFields);            </span><br><span class="line">        TupleEventType outputSchema = (TupleEventType)(executorApp.getEventType(outputSchemaName));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//operatorInfosæ˜¯æ‰€æœ‰çš„ç®—å­é›†åˆ, æ ¹æ®ä¼ å…¥çš„fromOpIdæˆ–è€…toOpId,ä»é›†åˆä¸­æ‰¾å‡ºå¯¹åº”çš„ç®—å­</span></span><br><span class="line">        combineFromTransition(operatorInfos, fromOpId, streamName, outputSchema);</span><br><span class="line">        combineToTransition(operatorInfos, toOpId, streamName, distributedType, distributedFields, outputSchema);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FromTransition: è¿çº¿çš„fromç®—å­çš„è¾“å‡ºæ˜¯outputSchema  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineFromTransition</span><span class="params">(Map&lt;String, AbsOperator&gt; operatorInfos, String fromOpId, String streamName, TupleEventType outputSchema)</span></span>&#123;</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_OUTPUT_SCHEMA, outputSchema);</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_OUTPUT_STREAM_NAME, streamName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ToTransition: è¿çº¿çš„toç®—å­çš„è¾“å…¥æ˜¯outputSchema. <code>è¿™é‡ŒoutputSchemaå‘½åä¸ºschemaä¼¼ä¹æ›´å¥½</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineToTransition</span><span class="params">(Map&lt;String, AbsOperator&gt; operatorInfos, String toOpId, String streamName,</span><br><span class="line">    DistributeType distributedType, String distributedFields, TupleEventType outputSchema)</span> </span>&#123;</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_INPUT_STREAM_NAME, streamName);</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_INPUT_SCHEMA, outputSchema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼äºGraphä¸­çš„é¡¶ç‚¹A -&gt; è¾¹ -&gt; é¡¶ç‚¹B. Transitionå°±ç±»ä¼¼äºè¾¹, è¿æ¥ç€å·¦å³ä¸¤è¾¹çš„ç®—å­, åˆ†åˆ«æ˜¯Fromç®—å­å’ŒToç®—å­.  </p>
<h2 id="StormApplication">StormApplication</h2><p>SubmitTask.submitApplication -&gt; PhysicalPlanExecutor.execute -&gt; PhysicalPlanExecutor.submit(application.Application) -&gt;<br>StormApplication.launch -&gt; createTopology åˆ›å»ºæ‹“æ‰‘, å¯¹äºStormçš„ç¨‹åºè€Œè¨€, æ„æˆæ‹“æ‰‘çš„ç»„ä»¶åŒ…æ‹¬Spoutså’ŒBolts.<br>è¿™äº›æ•°æ®éƒ½æ¥è‡ªäºApplicationçš„è¾“å…¥,è¾“å‡ºå’ŒåŠŸèƒ½ç®—å­. ç”±äºStormåªæœ‰ä¸¤ç§ç»„ä»¶Spoutå’ŒBolt, æ‰€ä»¥è¾“å…¥ç®—å­å½’äºSpout,è¾“å‡ºå’ŒåŠŸèƒ½ç®—å­éƒ½å±äºBolt.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createSpouts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt; ? extends IRichOperator&gt; sources = getInputStreams(); <span class="comment">//è·å¾—æ‰€æœ‰æºç®—å­ä¿¡æ¯: OperatorMng.inputs â¬…ï¸</span></span><br><span class="line">    checkInputStreams(sources);</span><br><span class="line">    <span class="keyword">for</span> (IRichOperator input : sources) &#123;</span><br><span class="line">        StormSpout spout = <span class="keyword">new</span> StormSpout();                    <span class="comment">//å°†ç®—å­è®¾ç½®åˆ°ä¸ºStormSpoutä¸­</span></span><br><span class="line">        spout.setOperator(input);                               <span class="comment">//Spoutæ¥æ”¶æ•°æ®æ—¶,å°†ä½¿ç”¨è®¾ç½®çš„ç®—å­å¼€å§‹å¤„ç†</span></span><br><span class="line">        builder.setSpout(input.getOperatorId(), spout, input.getParallelNumber());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createBolts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;IRichOperator&gt; orderedFunOp = genFunctionOpsOrder();   <span class="comment">//è·å–å·²ç»æ’å¥½åºçš„åŠŸèƒ½ç®—å­,åŒ…å«outputç®—å­  â¬…ï¸</span></span><br><span class="line">    <span class="keyword">for</span> (IRichOperator operator : orderedFunOp) &#123;</span><br><span class="line">        setOperatorGrouping(operator);                          <span class="comment">//è®¾ç½®Boltçš„åˆ†ç»„ç­–ç•¥  â¬…ï¸</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å“ªäº›Operatorç®—å­ä¼šä½œä¸ºBolt, OutpoutBolt, Spoutéƒ½æ˜¯ç”±OperatorMngç®¡ç†çš„æ¯”å¦‚getInputStreams,genFunctionOpsOrder<br>è¿™æ ·åˆ›å»ºçš„Boltä¼šç›´æ¥ä¾èµ–äºå¯¹åº”çš„Operator, åœ¨å¤„ç†Boltæ—¶,å°±ä¸éœ€è¦å†åˆ¤æ–­æ˜¯å“ªä¸€ç§ç±»å‹çš„Operatoräº†.<br>æ‰€ä»¥æ­£æ˜¯ç”±äºå¯¹ç®—å­çš„ç§ç±»è¿›è¡Œäº†åˆ†ç¦»(è¾“å…¥,è¾“å‡º,åŠŸèƒ½)æ‰ä½¿å¾—å¤„ç†Stormçš„componentæ—¶å˜å¾—å®¹æ˜“.<br>ä¸€æ—¦æ ¹æ®ç®—å­åˆ›å»ºå¹¶ç»„ç»‡å®Œæ„æˆTopologyçš„Spoutså’ŒBolts, å°±å¯ä»¥æäº¤æ‹“æ‰‘ç»™Stormé›†ç¾¤æ‰§è¡Œäº†. DONEğŸ˜„  </p>
</blockquote>
<h3 id="Bolt_Grouping">Bolt Grouping</h3><p>åœ¨å¼€å‘Stormåº”ç”¨ç¨‹åºæ—¶, ä¸€èˆ¬æ˜¯åœ¨Stormçš„Topologyä»£ç ä¸­åˆ›å»ºBoltå¹¶ç›´æ¥è®¾ç½®Boltçš„åˆ†ç»„ç­–ç•¥.<br>å‡è®¾æœ‰è¿™æ ·çš„Topology, Bolt1è¾“å‡ºåˆ°Bolt3å’ŒBolt4, Bolt2è¾“å‡ºåˆ°Bolt3(ä¸€ä¸ªBoltå¯ä»¥æœ‰å¤šä¸ªè¾“å‡º,ä¹Ÿå¯ä»¥ç”±å¤šä¸ªè¾“å…¥).    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">             |------ |Bolt4|</span><br><span class="line">|Bolt1| -----|</span><br><span class="line">             |------ |Bolt3|</span><br><span class="line">|Bolt2| -----|</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bolt1æœ‰ä¸¤ä¸ªè¾“å‡ºæµ, è¾“å‡ºå­—æ®µéƒ½æ˜¯ä¸€æ ·çš„, ä¸¤ä¸ªè¾“å‡ºæµçš„åç§°stream-idä¸ä¸€æ ·</span></span><br><span class="line">builder.setBolt(<span class="string">"bolt1"</span>, <span class="keyword">new</span> Bolt1(), <span class="number">2</span>)        </span><br><span class="line">            declarer.declareStream(<span class="string">"streamA"</span>, <span class="keyword">new</span> Fields(<span class="string">"f1"</span>,<span class="string">"f2"</span>))</span><br><span class="line">            declarer.declareStream(<span class="string">"streamB"</span>, <span class="keyword">new</span> Fields(<span class="string">"f1"</span>,<span class="string">"f2"</span>))</span><br><span class="line"><span class="comment">//Bolt2åªæœ‰ä¸€ä¸ªè¾“å‡ºæµ</span></span><br><span class="line">builder.setBolt(<span class="string">"bolt2"</span>, <span class="keyword">new</span> Bolt2(), <span class="number">2</span>)</span><br><span class="line">            declarer.declareStream(<span class="string">"streamC"</span>, <span class="keyword">new</span> Fields(<span class="string">"f1"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bolt3æ¥æ”¶Bolt1çš„streamAæµä½¿ç”¨å­—æ®µåˆ†ç»„, æ¥æ”¶Bolt2çš„streamCæµä½¿ç”¨shuffleåˆ†ç»„</span></span><br><span class="line">builder.setBolt(<span class="string">"bolt3"</span>, <span class="keyword">new</span> Bolt3(), <span class="number">4</span>)</span><br><span class="line">        .fieldsGrouping(<span class="string">"bolt1"</span>, <span class="string">"streamA"</span>, <span class="keyword">new</span> Field(<span class="string">"f1"</span>))</span><br><span class="line">        .shuffleGrouping(<span class="string">"bolt2"</span>, <span class="string">"streamC"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bolt4æ¥æ”¶Bolt1çš„streamBæµä½¿ç”¨å­—æ®µåˆ†ç»„, åˆ†ç»„å­—æ®µæ˜¯Bolt1äº§ç”Ÿçš„f2å­—æ®µ.  </span></span><br><span class="line">builder.setBolt(<span class="string">"bolt4"</span>, <span class="keyword">new</span> Bolt4(), <span class="number">3</span>)</span><br><span class="line">        .fieldsGrouping(<span class="string">"bolt1"</span>, <span class="string">"streamB"</span>, , <span class="keyword">new</span> Field(<span class="string">"f2"</span>))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>setBoltæ—¶è®¾ç½®çš„componentId/operatorIdéƒ½æ˜¯è‡ªå·±Bolt, åˆ†ç»„æ—¶çš„componentIdåˆ™æ˜¯è¾“å…¥çš„componentId/operatorId.  </p>
</blockquote>
<p>é€šè¿‡è§£æCQLçš„åˆ†ç»„ä»¥åŠç®—å­/ç»„ä»¶ä¹‹é—´çš„è¿æ¥, ç°åœ¨å°±ä¸éœ€è¦åœ¨Topologyå†™æ­»äº†. å› æ­¤éœ€è¦æ¡†æ¶èƒ½å¤ŸåŠ¨æ€åœ°æ„å»ºTopology.  </p>
<blockquote>
<p>ä¸ºä»€ä¹ˆIRichOperatorçš„getInputStream()å’ŒgetOutputStream()è¡¨ç¤ºçš„æ˜¯è¾“å…¥æµå’Œè¾“å‡ºæµçš„åç§°, è€Œä¸æ˜¯è¾“å…¥æµå¯¹è±¡å’Œè¾“å‡ºæµå¯¹è±¡(æ¯”å¦‚ç®—å­æœ¬èº«).<br>è¿™æ˜¯å› ä¸ºOperatorç®—å­ä¼šç”¨äºTopologyçš„Spout/Bolt, åˆ›å»ºå®ŒSpout/Boltä¹‹å, ç”¨äºæ„å»ºTopologyå…¶ä»–å¿…è¦çš„ä¿¡æ¯é™¤äº†åˆ†ç»„å¤–,<br>è¿˜æœ‰Stormçš„component-idå¯¹åº”ç®—å­çš„id å’Œ Stormçš„stream-idå¯¹åº”ç®—å­çš„è¾“å…¥/è¾“å‡ºæµåç§°  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setOperatorGrouping</span><span class="params">(IRichOperator operator)</span> </span>&#123;</span><br><span class="line">    BoltDeclarer bolt = createBoltDeclarer(operator);</span><br><span class="line">    <span class="comment">//ä¸€ä¸ªBoltå¯èƒ½æœ‰å¤šä¸ªè¾“å…¥å³å¤šä¸ªInputStream, åŒæ—¶è¾“å‡ºä¹Ÿå¯èƒ½æœ‰å¤šä¸ª: è®¾ç½®ä¸åŒçš„Groupingç­–ç•¥</span></span><br><span class="line">    <span class="comment">//æ³¨æ„: Boltè®¾ç½®åˆ†ç»„æ—¶çš„componentIdæ˜¯å…¶è¾“å…¥æºçš„ComponentId,è€Œä¸æ˜¯è‡ªå·±çš„componentId, è‡ªå·±æ˜¯åœ¨builder.setBoltæ—¶è®¾ç½®çš„</span></span><br><span class="line">    <span class="keyword">for</span> (String strname : operator.getInputStream()) &#123;              <span class="comment">//strnameæ˜¯å½“å‰ç®—å­çš„è¾“å…¥æµåç§°</span></span><br><span class="line">        GroupInfo groupInfo = operator.getGroupInfo().get(strname); <span class="comment">//ç®—å­çš„åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">        setBoltGrouping(bolt, strname, groupInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBoltGrouping</span><span class="params">(BoltDeclarer bolt, String strname, GroupInfo groupInfo)</span> </span>&#123;        </span><br><span class="line">    DistributeType distribute = groupInfo.getDitributeType();</span><br><span class="line">    <span class="keyword">switch</span> (distribute) &#123;</span><br><span class="line">        <span class="keyword">case</span> FIELDS:</span><br><span class="line">            Fields fields = <span class="keyword">new</span> Fields(groupInfo.getFields());</span><br><span class="line">            <span class="comment">//æ ¹æ®è¾“å…¥æµçš„åç§°, è·å–è¿™ä¸ªè¾“å…¥æµæ˜¯ä¸ªä»€ä¹ˆç®—å­, ä¸ºçš„æ˜¯è·å¾—è¿™ä¸ªè¾“å…¥ç®—å­çš„operatorId,ä½œä¸ºåˆ†ç»„ç­–ç•¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">            IRichOperator operator = getOperatorByOutputStreamName(strname);</span><br><span class="line">            <span class="comment">//å­—æ®µåˆ†ç»„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤º: componentId, streamId, fields. è¿™é‡Œçš„componentIdè¡¨ç¤ºä»å“ªä¸ªæ•°æ®æºæ¥å…¥æ•°æ®,è€Œä¸æ˜¯å½“å‰ç®—å­çš„operatorId</span></span><br><span class="line">            bolt.fieldsGrouping(operator.getOperatorId(), strname, fields);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//... å…¶ä»–åˆ†ç»„ç±»å‹ ...   </span></span><br><span class="line">        <span class="keyword">default</span>:               </span><br><span class="line">            setDefaultBoltGrouping(bolt, strname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDefaultBoltGrouping</span><span class="params">(BoltDeclarer bolt, String strname)</span> </span>&#123;</span><br><span class="line">    IRichOperator operator = getOperatorByOutputStreamName(strname);</span><br><span class="line">    <span class="comment">//shuffleåˆ†ç»„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤º: è¾“å…¥æµçš„operatorId/componentId, streamId</span></span><br><span class="line">    bolt.shuffleGrouping(operator.getOperatorId(), strname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Operatorç®—å­çš„idä¼šä½œä¸ºStormä¸­Spout/Boltçš„component-id, è€ŒOperatorçš„è¾“å…¥æµ/è¾“å‡ºæµåç§°æ˜¯ä½œä¸ºSpout/Boltçš„stream-id.<br>component-idåªæ˜¯ç”¨äºåŒºåˆ«ä¸åŒçš„ç»„ä»¶,æˆ–è€…ç”¨äºä»å“ªä¸ªè¾“å…¥ç»„ä»¶è·å–æ•°æ®. è€Œstream-idåˆ™å¯ä»¥ä½œä¸ºåˆ†æµ/å¤šæµ/åˆå¹¶æµç­‰.  </p>
</blockquote>
<h3 id="Bolt_Creation">Bolt Creation</h3><p>createBoltsè®¾ç½®Operatorçš„åˆ†ç»„ç­–ç•¥, é¦–å…ˆåˆ›å»ºIRichBolt,å¹¶è¿”å›Boltçš„å£°æ˜BoltDeclarer,ä»¥ä¾¿åç»­æ“ä½œå¯ä»¥åœ¨BoltDeclarerç»§ç»­è¿›è¡Œ(æ¯”å¦‚ä¸Šé¢çš„åˆ†ç»„ç­–ç•¥).  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BoltDeclarer <span class="title">createBoltDeclarer</span><span class="params">(IRichOperator operator)</span></span>&#123;</span><br><span class="line">    IRichBolt bolt;</span><br><span class="line">    <span class="keyword">if</span> ((operator <span class="keyword">instanceof</span> FunctionOperator) || (operator <span class="keyword">instanceof</span> FunctionStreamOperator)) &#123;</span><br><span class="line">        bolt = createStormBolt(operator);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        bolt = createOutputStormBolt(operator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.setBolt(operator.getOperatorId(), bolt, operator.getParallelNumber());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> IRichBolt <span class="title">createOutputStormBolt</span><span class="params">(IRichOperator f)</span></span>&#123;</span><br><span class="line">    StormOutputBolt outputbolt = <span class="keyword">new</span> StormOutputBolt();     </span><br><span class="line">    outputbolt.setOperator(f);          <span class="comment">//ç±»ä¼¼äºStormSpoutå°†ç®—å­èµ‹å€¼,çœŸæ­£æ‰§è¡Œæ—¶ä¼šä½¿ç”¨ç®—å­è¿›è¡Œæ“ä½œ</span></span><br><span class="line">    <span class="keyword">return</span> outputbolt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StormSpout,StormBolt,StormOutputBoltéƒ½æ˜¯å¯¹Stormçš„ç»„ä»¶çš„å°è£…. é™¤äº†ç»§æ‰¿å„è‡ªçš„IRichSpoutå’ŒIRichBoltå¤–,è¿˜è¦å®ç°StreamAdapteræ¥å£çš„setOperatoræ–¹æ³•.<br>æµå¤„ç†ç®—å­é€‚é…æ¥å£: ä¾é è¿™ä¸ªæ¥å£ï¼Œå°†æµå¤„ç†çš„ç®—å­æ³¨å…¥åˆ°å…·ä½“çš„Stormçš„Spout/Boltä¸­. <code>åˆ›å»ºBoltä¸ºå•¥ä¸ç”¨æ„é€ å‡½æ•°ä¸€å¥è¯çš„äº‹å„¿: new StormBolt(operator)</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StormSpout</span> <span class="keyword">implements</span> <span class="title">IRichSpout</span>, <span class="title">StreamAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IRichOperator input;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOperator</span><span class="params">(IRichOperator operator)</span></span>&#123;</span><br><span class="line">        input = operator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StormOutputBolt</span> <span class="keyword">implements</span> <span class="title">IRichBolt</span>, <span class="title">StreamAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector outputCollector;</span><br><span class="line">    <span class="keyword">private</span> OutputOperator output;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOperator</span><span class="params">(IRichOperator operator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.output = (OutputOperator)operator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StormBoltçš„executeæ–¹æ³•  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input)</span> </span>&#123;</span><br><span class="line">    String sourceStreamName = input.getSourceStreamId();        <span class="comment">//è·å–Tupleçš„è¾“å…¥æµstream-id</span></span><br><span class="line">    List&lt;String&gt; inStreams = functionStream.getInputStream();   <span class="comment">//è¾“å…¥æµåç§°åˆ—è¡¨,å› ä¸ºä¸€ä¸ªBoltå¯ä»¥æœ‰å¤šä¸ªè¾“å…¥æµ</span></span><br><span class="line">    <span class="keyword">for</span> (String streamName : inStreams) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!sourceStreamName.equals(streamName)) <span class="keyword">continue</span>;     <span class="comment">//åªæœ‰Tupleçš„è¾“å…¥æµstream-idå’ŒIRichOperatorçš„è¾“å…¥æµåç§°ç›¸åŒæ—¶,æ‰å¤„ç†è¿™ä¸ªTuple</span></span><br><span class="line">        TupleEvent event = TupleTransform.tupeToEvent(input, functionStream.getInputSchema().get(streamName));</span><br><span class="line">        functionStream.execute(streamName, event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | start to submit application example | com.huawei.streaming.cql.executor.PhysicalPlanExecutor (PhysicalPlanExecutor.java:<span class="number">201</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | reset submit jar to /<span class="keyword">private</span>/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/example<span class="number">.5f</span>8ed0baaeb243a49308fd75144cf715.jar | com.huawei.streaming.storm.StormApplication (StormApplication.java:<span class="number">314</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Using defaults.yaml from resources | backtype.storm.utils.Utils (Utils.java:<span class="number">253</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | The baseSleepTimeMs [<span class="number">2000</span>] the maxSleepTimeMs [<span class="number">60000</span>] the maxRetries [<span class="number">5</span>] | backtype.storm.utils.StormBoundedExponentialBackoffRetry (StormBoundedExponentialBackoffRetry.java:<span class="number">47</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Using defaults.yaml from resources | backtype.storm.utils.Utils (Utils.java:<span class="number">253</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | GenFunctionOpsOrder enter. | com.huawei.streaming.application.OperatorMng (OperatorMng.java:<span class="number">205</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Using defaults.yaml from resources | backtype.storm.utils.Utils (Utils.java:<span class="number">253</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Generated ZooKeeper secret payload <span class="keyword">for</span> MD5-digest: -<span class="number">5668598407594625313</span>:-<span class="number">5703359794945963404</span> | backtype.storm.StormSubmitter (StormSubmitter.java:<span class="number">82</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">39</span> | INFO  | [main] | Uploading topology jar /<span class="keyword">private</span>/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/example<span class="number">.5f</span>8ed0baaeb243a49308fd75144cf715.jar to assigned location: storm-local/nimbus/inbox/stormjar-a5b95134-e3f2-<span class="number">431</span>d-b675-<span class="number">924</span>d8c468cf3.jar | backtype.storm.StormSubmitter (StormSubmitter.java:<span class="number">371</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">40</span> | INFO  | [main] | Successfully uploaded topology jar to assigned location: storm-local/nimbus/inbox/stormjar-a5b95134-e3f2-<span class="number">431</span>d-b675-<span class="number">924</span>d8c468cf3.jar | backtype.storm.StormSubmitter (StormSubmitter.java:<span class="number">396</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">40</span> | INFO  | [main] | Finished submitting topology: example | backtype.storm.StormSubmitter (StormSubmitter.java:<span class="number">248</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">40</span> | INFO  | [main] | <span class="keyword">delete</span> user packed jar after submit | com.huawei.streaming.cql.executor.PhysicalPlanExecutor (PhysicalPlanExecutor.java:<span class="number">156</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">40</span> | INFO  | [main] | unRegister jars from <span class="keyword">class</span> loader. | com.huawei.streaming.cql.DriverContext (DriverContext.java:<span class="number">427</span>)</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storm/">storm</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-15-drill-fragments" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-15-drill-fragments/" class="article-date">
  	<time datetime="2015-12-01T10:24:56.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-15-drill-fragments/">Apache Drillæºç é˜…è¯»(5) Fragment</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="Foreman-runPhysicalPlanè¿è¡Œç‰©ç†è®¡åˆ’">Foreman.runPhysicalPlanè¿è¡Œç‰©ç†è®¡åˆ’</h2><p>åœ¨æŸ¥è¯¢ä¸€èŠ‚ä¸­è¯´è¿‡: <code>æœ‰äº†ç‰©ç†è®¡åˆ’,æ‰€æœ‰çš„ç»Ÿè®¡ä¿¡æ¯,æœ€ä¼˜ç«¯ç‚¹,Foremanä¸­çš„Parallellizerä¼šå°†ç‰©ç†è®¡åˆ’è½¬æ¢ä¸ºå¤šä¸ªfragments</code><br>å°†ç‰©ç†è®¡åˆ’è½¬æ¢ä¸ºfragmentsæ˜¯åœ¨Foremanä¸­, å°±æ˜¯åœ¨runPhysicalPlançš„ç¬¬ä¸€æ­¥getQueryWorkUnitä¸­  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function">QueryWorkUnit <span class="title">getQueryWorkUnit</span><span class="params">(<span class="keyword">final</span> PhysicalPlan plan)</span> <span class="keyword">throws</span> ExecutionSetupException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> PhysicalOperator rootOperator = plan.getSortedOperators(<span class="keyword">false</span>).iterator().next();   <span class="comment">// ç‰©ç†è®¡åˆ’çš„æ ¹èŠ‚ç‚¹ç‰©ç†æ“ä½œç¬¦ä¸ºScreen</span></span><br><span class="line">  <span class="keyword">final</span> Fragment rootFragment = rootOperator.accept(MakeFragmentsVisitor.INSTANCE, <span class="keyword">null</span>);   <span class="comment">// â‘ é€’å½’è°ƒç”¨æ ‘å…¥å£,ä»ä¸Šåˆ°ä¸‹è°ƒç”¨æ¯ä¸ªæ“ä½œç¬¦çš„acceptæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> SimpleParallelizer parallelizer = <span class="keyword">new</span> SimpleParallelizer(queryContext);   <span class="comment">// å¹¶è¡Œ, ç”¨æ¥è®¾ç½®fragmentsçš„å¹¶è¡Œåº¦</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> QueryWorkUnit queryWorkUnit = parallelizer.getFragments(</span><br><span class="line">      queryContext.getOptions().getOptionList(), queryContext.getCurrentEndpoint(),</span><br><span class="line">      queryId, queryContext.getActiveEndpoints(), drillbitContext.getPlanReader(), rootFragment,</span><br><span class="line">      initiatingClient.getSession(), queryContext.getQueryContextInfo());</span><br><span class="line">  <span class="keyword">return</span> queryWorkUnit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨debugä¸€èŠ‚,æˆ‘ä»¬çŸ¥é“DrillRel drel, Prel prel, PhysicalOperator pop, PhysicalPlan planå„ä¸ªå˜é‡çš„å€¼.<br>ä¸Šé¢é€šè¿‡PhysicalPlanè·å¾—çš„rootOperatorå°±æ˜¯PhysicalOperator popæ ¹èŠ‚ç‚¹, å³<code>rootOperator=Screen</code>.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-pop.png" alt=""></p>
<p>rootOperator.acceptåè¿”å›çš„æ˜¯rootFragment.  ç„¶åé€šè¿‡rootåˆå¼€å§‹é€’å½’éå†äº†(è·Ÿdebugä¸€èŠ‚rootLOP.acceptä¸€æ ·).<br>ä¸‹é¢æ˜¯MakeFragmentsVisitorè®¿é—®å™¨å½“è®¿é—®åˆ°çš„æ˜¯ä¸€ä¸ªæ“ä½œç¬¦æ—¶, é¦–å…ˆå°†å½“å‰æ“ä½œç¬¦åŠ å…¥åˆ°Fragmentä¸­, ç„¶åéå†å…¶å­©å­èŠ‚ç‚¹.  </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Fragment <span class="title">visitOp</span>(<span class="params">PhysicalOperator op, Fragment <span class="keyword">value</span></span>)  throws ForemanSetupException</span>&#123;</span><br><span class="line">  <span class="keyword">value</span> = ensureBuilder(<span class="keyword">value</span>);</span><br><span class="line">  <span class="keyword">value</span>.addOperator(op);</span><br><span class="line">  <span class="keyword">for</span> (PhysicalOperator child : op) &#123;</span><br><span class="line">    child.accept(<span class="keyword">this</span>, <span class="keyword">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯Screen-&gt;..-&gt;Scançš„é€’å½’è°ƒç”¨ç¤ºä¾‹æ ‘:  </p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">rootOperator</span><span class="string">.</span><span class="comment">accept(v</span><span class="string">,</span><span class="comment">null)</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">Screen</span><span class="string">.</span><span class="comment">accept(visitor</span><span class="string">,</span> <span class="comment">null)</span></span><br><span class="line">                          <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">MakeFragmentsVisitor</span><span class="string">.</span><span class="comment">visitOp</span></span><br><span class="line">                                        <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">value=new</span> <span class="comment">Fragment</span> </span><br><span class="line">                                        <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">value</span><span class="string">.</span><span class="comment">addOperator(Screen)</span></span><br><span class="line">                                        <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">child</span> <span class="comment">:</span> <span class="title">[</span><span class="comment">EasyGroupScan</span><span class="title">]</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">accept(visitor</span><span class="string">,</span> <span class="comment">value)</span>    <span class="comment">æˆ‘ä»¬çœç•¥äº†ä¸­é—´çš„ä¸€äº›èŠ‚ç‚¹</span><span class="string">,</span><span class="comment">å‡è®¾Screençš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯Scan</span></span><br><span class="line">                                                     <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">EasyGroupScan</span><span class="string">.</span><span class="comment">accept(visitor</span><span class="string">,</span> <span class="comment">value)</span></span><br><span class="line">                                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">MakeFragmentsVisitor</span><span class="string">.</span><span class="comment">visitOp</span></span><br><span class="line">                                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">value</span><span class="string">.</span><span class="comment">addOperator(EasyGroupScan)</span></span><br><span class="line">                                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">EasyGroupScan</span> <span class="comment">has</span> <span class="comment">no</span> <span class="comment">child</span></span><br><span class="line">                                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">return</span> <span class="comment">value</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>é€’å½’è°ƒç”¨æ ‘æœ‰ç‚¹ç±»ä¼¼äºè®¾è®¡æ¨¡å¼ä¸­çš„è®¿é—®è€…æ¨¡å¼(Visitor Pattern).  </p>
</blockquote>
<p>è¿”å›å€¼<code>Fragment rootFragment = rootOperator.accept(MakeFragmentsVisitor.INSTANCE, null);</code><br>å› ä¸ºå‚æ•°æ˜¯null, æ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨rootOperator.acceptçš„æ—¶å€™å°±åˆ›å»ºäº†æ–°çš„Fragment. æ¥ä¸‹æ¥child.accept,<br>å› ä¸ºæŠŠvalue : Fragmentä¼ å…¥, æ‰€ä»¥ä¸ä¼šå†æ„é€ Fragmentäº†(é™¤éå‡ºç°Exchangeçš„æ—¶å€™æ‰ä¼šnewä¸€ä¸ªæ–°çš„Fragment).<br>æ³¨æ„åœ¨æ¯æ¬¡é€’å½’è°ƒç”¨child.acceptä¹‹å‰, æŠŠå½“å‰çš„ç‰©ç†æ“ä½œç¬¦åŠ å…¥åˆ°Fragmentä¸­.<br>ä¹Ÿå°±æ˜¯è¯´ç‰©ç†è®¡åˆ’ç»„æˆçš„DAGå›¾çš„æ¯ä¸ªç‰©ç†æ“ä½œç¬¦éƒ½ä¼šåŠ å…¥åˆ°Fragmentä¸­, è¿™ä¸ªFragmentå¹¶ä¸ä»£è¡¨DAGå›¾ä¸­çš„æŸä¸ªèŠ‚ç‚¹(æ¯”å¦‚æ ¹èŠ‚ç‚¹), è€Œæ˜¯åŒ…å«äº†æ‰€æœ‰çš„æ“ä½œç¬¦.<br>è¿™å’Œå‰é¢çš„DrillRel, Prel, PhysicalOperator, PhysicalPlanä¸ä¸€æ ·:å®ƒä»¬çš„å€¼æ˜¯DAGå›¾çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹,ç„¶åé€šè¿‡inputæˆ–è€…childåµŒå¥—åŒ…å«å…¶ä»–èŠ‚ç‚¹.  </p>
<p>å½“ç„¶Fragmentä¸­è¦æœ‰æ ¹ç‰©ç†æ“ä½œç¬¦, è¿™æ ·æŠŠæ ¹æ‹å‡ºæ¥, å…¶ä»–æ‰€æœ‰çš„æ“ä½œç¬¦ä¹Ÿéƒ½èƒ½æ‰¾åˆ°äº†.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Fragment</span>.<span class="title">ExchangeFragmentPair</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> PhysicalOperator root;</span><br><span class="line">  <span class="keyword">private</span> ExchangeFragmentPair sendingExchange;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ExchangeFragmentPair&gt; receivingExchangePairs = Lists.newLinkedList();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the given operator as root operator of this fragment. If root operator is already set, then this method call is a no-op.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOperator</span><span class="params">(PhysicalOperator o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">      root = o;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSendExchange</span><span class="params">(Exchange e, Fragment sendingToFragment)</span> <span class="keyword">throws</span> ForemanSetupException</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (sendingExchange != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> ForemanSetupException(<span class="string">"Fragment was trying to add a second SendExchange.  "</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      addOperator(e);</span><br><span class="line">      sendingExchange = <span class="keyword">new</span> ExchangeFragmentPair(e, sendingToFragment);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addReceiveExchange</span><span class="params">(Exchange e, Fragment fragment)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.receivingExchangePairs.add(<span class="keyword">new</span> ExchangeFragmentPair(e, fragment));</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MakeFragmentsVisitorå¦‚æœè®¿é—®åˆ°çš„æ˜¯ä¸€ä¸ªExchangeæ“ä½œç¬¦, Exchangeä¼šå’ŒFragmentç»„æˆä¸€ä¸ªExchangeFragmentPair.  </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Fragment <span class="title">visitExchange</span>(<span class="params">Exchange exchange, Fragment <span class="keyword">value</span></span>) throws ForemanSetupException </span>&#123;</span><br><span class="line">  Fragment next = getNextBuilder();           <span class="comment">// æ€»æ˜¯ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„Fragment:next</span></span><br><span class="line">  <span class="keyword">value</span>.addReceiveExchange(exchange, next);   <span class="comment">// å°†Exchangeæ“ä½œç¬¦å’Œæ–°çš„Fragmentç»„æˆä¸€ä¸ªExchangeFragmentPair, æ·»åŠ åˆ°åŸæ¥Fragmentçš„listä¸­</span></span><br><span class="line">  next.addSendExchange(exchange, <span class="keyword">value</span>);      <span class="comment">// Exchangeæ“ä½œç¬¦å’ŒåŸæ¥çš„Fragmentä¹Ÿä¼šç»„æˆä¸€ä¸ªExchangeFragmentPair,ä¸è¿‡ç”¨äºå‘é€</span></span><br><span class="line">  exchange.getChild().accept(<span class="keyword">this</span>, next);     <span class="comment">// Exchangeä¸‹é¢çš„å­©å­èŠ‚ç‚¹, ç”¨çš„Fragmentæ˜¯æ–°çš„é‚£ä¸€ä¸ª</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">value</span>;                               <span class="comment">// ä½†æ˜¯æˆ‘ä»¬æœ€åè¿”å›çš„, ä»ç„¶æ˜¯ç¬¬ä¸€æ¬¡æ–°å»ºçš„é‚£ä¸€ä¸ªFragment</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶, valueä¸€å®šä¸ä¸ºç©º: The simple fragmenter was called without a FragmentBuilder value.<br>This will only happen if the initial call to SimpleFragmenter  is by a Exchange node.<br>This should never happen since an Exchange node should never be the root node of a plan<br>ä¸€ä¸ªExchangeèŠ‚ç‚¹æ°¸è¿œä¸èƒ½æ˜¯ä¸€ä¸ªè®¡åˆ’çš„æ ¹èŠ‚ç‚¹.  Exchangeå‰æ˜¯ä¸€ä¸ªMajor Fragment, Exchangeåä¹Ÿæ˜¯ä¸€ä¸ªMajor Fragment.  </p>
<blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆå…ˆæ˜¯Receiver,ç„¶åæ˜¯Sender, æˆ‘ä»¬å…ˆçœ‹ä¸‹å®˜ç½‘ä¸­çš„æ¦‚å¿µ,ä»¥åŠä¸¾ä¸ªå¸¦æœ‰Exchangeçš„ä¾‹å­: </p>
</blockquote>
<h2 id="fragments_theory">fragments theory</h2><blockquote>
<p><a href="http://drill.apache.org/docs/drill-query-execution/" target="_blank" rel="external">http://drill.apache.org/docs/drill-query-execution/</a><br>A parallelizer in the Foreman transforms the physical plan into multiple phases, called major and minor fragments.<br>These fragments create a multi-level execution tree that rewrites the query and executes it in<br>parallel against the configured data sources, sending the results back to the client or application.</p>
<p>å¹¶è¡ŒåŒ–ä¼šå°†ç‰©ç†è®¡åˆ’åˆ†æˆå¤šä¸ªé˜¶æ®µ. ä»€ä¹ˆæ—¶å€™éœ€è¦å¹¶è¡Œ? ä»»åŠ¡æ˜¯å¯ä»¥åˆ†è§£çš„æ—¶å€™, ä»»åŠ¡ä¹‹é—´æ²¡æœ‰å…³è”, æ¯”å¦‚Hadoopçš„MapReduceå°±æ˜¯å¯å¹¶è¡ŒåŒ–çš„.<br>è¿™äº›é˜¶æ®µå«åšmajoræˆ–è€…minor fragmens. å®ƒä»¬ç»„æˆäº†ä¸€ä¸ªå¤šå±‚çš„æ‰§è¡Œæ ‘, é‡å†™æŸ¥è¯¢, å¹¶ä¸”èƒ½å¤Ÿå¹¶è¡Œåœ°åœ¨æ•°æ®æºä¸Šæ‰§è¡Œ.  </p>
<p>ä»¥ä¼ ç»ŸDAGå›¾çš„æ–¹å¼, åªæœ‰å‰é¢çš„èŠ‚ç‚¹å¤„ç†å®Œå,åé¢çš„èŠ‚ç‚¹æ‰ä¼šç»§ç»­è¿è¡Œ. è€Œç”¨å¹¶è¡ŒåŒ–çš„æ–¹å¼,æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œå®Œä¸€éƒ¨åˆ†æ•°æ®,åé¢çš„èŠ‚ç‚¹å°±å¯ä»¥æ¥ç€è¿™äº›æ•°æ®è¿›è¡Œè®¡ç®—.</p>
</blockquote>
<p><img src="http://drill.apache.org/docs/img/execution-tree.PNG" alt=""></p>
<h2 id="Major_Fragments">Major Fragments</h2><blockquote>
<p>Drill separates major fragments by an exchange operator. An exchange is a change in data location and/or parallelization of the physical plan.<br>An exchange is composed of a sender and a receiver to allow data to move between nodes  </p>
<p>Drillç”¨äº¤æ¢æ“ä½œç¬¦æ¥åˆ†éš”major fragments. ä¸€ä¸ªäº¤æ¢æ“ä½œç¬¦æ˜¯æ•°æ®ä½ç½®çš„äº¤æ¢, æˆ–è€…ç‰©ç†è®¡åˆ’å¹¶è¡Œåº¦çš„å˜æ›´.<br>ä¸€ä¸ªäº¤æ¢æ“ä½œç¬¦ç”±ä¸€ä¸ªå‘é€å™¨å’Œä¸€ä¸ªæ¥æ”¶å™¨ç»„æˆ, ä»¥è¿è¡Œæ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œç§»åŠ¨. </p>
<p>Major fragments do not actually perform any query tasks. Each major fragment is divided into one or multiple minor fragments<br>that actually execute the operations required to complete the query and return results back to the client. </p>
<p>Major Fragmentsä¸æ‰§è¡Œä»»ä½•çš„æŸ¥è¯¢ä»»åŠ¡, æ¯ä¸ªmajor fragmentsä¼šåˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªminor fragments.<br>Minor Fragmentsä¼šæ‰§è¡Œå®Œæˆè¿™ä¸ªæŸ¥è¯¢éœ€è¦çš„æ“ä½œ, å¹¶ä¸”è¿”å›ç»“æœç»™å®¢æˆ·ç«¯.  </p>
</blockquote>
<p><img src="http://drill.apache.org/docs/img/ex-operator.png" alt=""></p>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä¼šäº§ç”ŸMajor Fragments: è¯»å–çš„æ˜¯HDFSä¸Šçš„æ–‡ä»¶æ—¶(count(*)æ— æ¡ä»¶æŸ¥è¯¢å³ä½¿æ˜¯hdfsæ–‡ä»¶ä¹Ÿæ²¡æœ‰exchange).  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- <span class="operator"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> hdfs.<span class="string">`/user/hive/warehouse/test.db/koudai`</span></span><br><span class="line">+ <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> hdfs.<span class="string">`/user/hive/warehouse/test.db/koudai`</span> <span class="keyword">where</span> sequence_id <span class="keyword">like</span> <span class="string">'%12%'</span></span><br><span class="line">+ <span class="keyword">select</span> <span class="keyword">t</span>.event_result_map.<span class="keyword">map</span> <span class="keyword">from</span> hdfs.<span class="string">`/user/hive/warehouse/test.db/koudai`</span> <span class="keyword">t</span> <span class="keyword">where</span> <span class="keyword">t</span>.sequence_id=<span class="string">'1433300095954-25887486'</span></span><br><span class="line">+ <span class="keyword">select</span> <span class="keyword">t</span>.sequence_id <span class="keyword">from</span> hdfs.<span class="string">`/user/hive/warehouse/test.db/koudai`</span> <span class="keyword">t</span> <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">+ <span class="keyword">select</span> * <span class="keyword">from</span> hdfs.<span class="string">`/user/hive/warehouse/test.db/koudai`</span> <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">- <span class="keyword">select</span> * <span class="keyword">from</span> cp.<span class="string">`employee.json`</span> <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">- <span class="keyword">select</span> * <span class="keyword">from</span> dfs.<span class="string">`/Users/zhengqh/data/hive_alltypes.parquet`</span> <span class="keyword">limit</span> <span class="number">1</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸ºä»€ä¹ˆæ— æ¡ä»¶çš„count(<em>)æŸ¥è¯¢æ²¡æœ‰exchange. è§‚å¯ŸOperator,å‘ç°countæŸ¥è¯¢åº•å±‚çš„scanæ˜¯DIRECT_SUB_SCAN,<br>è€Œparquetçš„å…¶ä»–æŸ¥è¯¢(å¸¦æ¡ä»¶çš„count,where,limit,</em>)ç”¨çš„æ˜¯PARQUET_ROW_GROUP_SCAN. åé¢çš„cpå’Œæœ¬åœ°æŸ¥è¯¢åˆ™æ²¡æœ‰Exchange.    </p>
</blockquote>
<p>ä¸‹å›¾ä¸­ç™½è‰²çš„UnionExchangeåˆ†éš”äº†ä¸¤ä¸ªMajor Fragments. totalFragmentsçš„ä¸ªæ•°æŒ‡çš„æ˜¯æ‰€æœ‰çš„minor framgnet.<br>å¯¹æ¯”DAGå›¾å’ŒOperator Profiles. å¯ä»¥çœ‹åˆ°Exchangeå¯¹åº”çš„Operatoræ˜¯Receiverå’ŒSender.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill24.png" alt=""> <img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill26.png" alt=""></p>
<blockquote>
<p>æ³¨æ„å·¦ä¾§çš„UnionExchangeåœ¨å³ä¾§ä¸­è¢«åˆ†æˆäº†Receiverå’ŒSender.  </p>
</blockquote>
<p>ç¬¬ä¸€ä¸ªMajor framgnetåœ¨UnionExchangeçš„ä¸Šæ–¹, å³Screen, åªæœ‰ä¸€ä¸ªmior Fragment.<br>ç¬¬äºŒä¸ªMajor framgnetåŒ…æ‹¬äº†å¤šä¸ªæ“ä½œç¬¦, æœ‰2ä¸ªminor Fragments. </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill25.png" alt=""></p>
<h2 id="Receiver+Sender">Receiver+Sender</h2><p>ä»¥ä¸Šå›¾ä¸­çš„Screen-&gt;UnionExchange-&gt;Project-&gt;â€¦-&gt;Scançš„é¡ºåºåˆ†æä¸‹UnionExchange:  </p>
<p>åœ¨è®¿é—®æ ¹æ“ä½œç¬¦visitOp(Screen,null)æ—¶, MakeFragmentsVisitorä¼šæ–°å»ºä¸€ä¸ªFragment, è®¾ç½®Fragmentçš„root=Screen.<br>æ¥ç€å› ä¸ºScreençš„Childæ˜¯UninonExchange,è°ƒç”¨çš„æ˜¯MakeFragmentsVisitorçš„visitExchange(UnionExchange,Fragment value).<br>ç¬¬äºŒä¸ªå‚æ•°Fragment valueæ˜¯è®¿é—®Screenæ—¶åˆ›å»ºçš„ç¬¬ä¸€ä¸ªFragment, ç¬¬ä¸€ä¸ªFragment valueä¸€å®šä¸ä¸ºç©º, å› ä¸ºä¸å…è®¸æ ¹èŠ‚ç‚¹æ˜¯Exchange.  </p>
<p>å› ä¸ºExchangeæ˜¯ç”¨æ¥åˆ†éš”Major Fragmentçš„, æ‰€ä»¥åœ¨Exchangeä¹‹å‰å’Œä¹‹åéƒ½è¦æœ‰ä¸€ä¸ªMajor Fragment,ä¹‹å‰å°±æ˜¯ç¬¬ä¸€ä¸ªFragmentäº†.<br>é‡ç‚¹çœ‹ä¸‹visitExchangeçš„ä¸‹é¢çš„é€»è¾‘, ç†æ¸…åˆ°åº•ç¬¬ä¸€ä¸ªFragment valueå’Œä¸‹ä¸€ä¸ªFragment nextåˆ†åˆ«æ·»åŠ çš„æ˜¯ä»€ä¹ˆç»„ä»¶.  </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value.addReceiveExchange(exchange, <span class="keyword">next</span>);   // <span class="keyword">first</span> <span class="built_in">add</span> Receiver from <span class="keyword">next</span></span><br><span class="line"><span class="keyword">next</span>.addSendExchange(exchange, value);      // <span class="keyword">next</span> <span class="built_in">add</span> Sender <span class="keyword">to</span> <span class="keyword">first</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„æˆ‘ä»¬çš„DAGå›¾ä»ä¸Šåˆ°ä¸‹,ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯Screen,æœ€ä¸‹é¢çš„èŠ‚ç‚¹æ˜¯Scan, æ‰€ä»¥ä¸Šé¢çš„æ˜¯ä½œä¸ºæ¥æ”¶æ•°æ®çš„ä¸€æ–¹,ä¸‹é¢çš„æ˜¯å‘é€æ•°æ®çš„ä¸€æ–¹.<br>è€Œfirst Fragmentå³ä¸Šé¢çš„value, æ˜¯åœ¨ä¸Šæ–¹çš„,é‚£ä¹ˆå°±æ˜¯ä½œä¸ºæ¥æ”¶æ–¹Receiverçš„.<br>è€Œä¸”æœ€åè¿”å›ç»™å®¢æˆ·ç«¯çš„ä¹Ÿæ˜¯ä¸Šå±‚çš„,å®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“å’ŒScreenç›¸å…³çš„é‚£ä¸ªFragment,å³è¿”å›å€¼æ˜¯value.   </p>
<p>ç¬¬ä¸€ä¸ªFragment valueæ·»åŠ ä¸€ä¸ªReceive Exchange, åªæ˜¯æŠŠæ–°å»ºçš„ExchangeFragmentPairåŠ å…¥åˆ°valueçš„List<exchangefragmentpair> receivingExchangePairsä¸­.<br>è€Œç¬¬äºŒä¸ªFragment nextæˆ‘ä»¬å·²ç»çŸ¥é“äº†åœ¨visitExchangeæ—¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Fragment. å¯¹äºæ¯ä¸€ä¸ªå…¨æ–°çš„Fragment, éƒ½è¦è®¾ç½®rootèŠ‚ç‚¹æ“ä½œç¬¦.    </exchangefragmentpair></p>
<p>å®é™…ä¸Šè§‚å¯Ÿå‰é¢çš„DAGå›¾å’ŒOperator Profiles,ä½ ä¼šå‘ç°UnionExchangeçš„UNORDERED_RECEIVERçš„ç¼–å·æ˜¯00-xx-01,å› æ­¤æ˜¯å±äºç¬¬ä¸€ä¸ªFragmentçš„.<br>è€ŒSINGLE_SENDERçš„ç¼–å·æ˜¯01-xx-00, åˆ™æ˜¯å±äºç¬¬äºŒä¸ªFragment. å› æ­¤ç¬¬äºŒä¸ªFragmentçš„rootå°±æ˜¯SINGLE_SENDER. </p>
<p>ä¸Šé¢ä¸¤ä¸ªvalueå’Œnextäº’ç›¸æ·»åŠ å¯¹æ–¹, å®é™…ä¸Šæ˜¯ä¸ºäº†åœ¨ä¸Šä¸‹æ–‡ä¸­éƒ½èƒ½æ‰¾åˆ°å¯¹æ–¹. å¦åˆ™å¦‚æœåªæ˜¯valueæ·»åŠ äº†next. åˆ™åœ¨nextæ—¶å°±æ— æ³•æ‰¾åˆ°valueçš„.  </p>
<table>
<thead>
<tr>
<th>Fragment</th>
<th>root</th>
<th>sendingExchange</th>
<th>receivingExchangePairs</th>
<th>Explain</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>Screen</td>
<td>Ã—</td>
<td>ExchangeFragmentPair(e,next)</td>
<td>valueçš„æ¥æ”¶è€…æ˜¯next</td>
<td>Reciever</td>
</tr>
<tr>
<td>next</td>
<td>SINGLE_SENDER</td>
<td>ExchangeFragmentPair(e,value)</td>
<td>Ã—</td>
<td>nextè¦å‘é€ç»™value</td>
<td>Sender</td>
</tr>
</tbody>
</table>
<p>çœ‹çœ‹UnionExchangeçš„å‡ ä¸ªç›¸å…³æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnionExchange</span> <span class="keyword">extends</span> <span class="title">AbstractExchange</span></span>&#123;</span><br><span class="line">  <span class="comment">// Ephemeral info for generating execution fragments. è¿™å‡ ä¸ªå˜é‡æ˜¯AbstractExchangeä¸­çš„,ä¸ºäº†é˜…è¯»çš„æ–¹ä¾¿æ”¾åœ¨è¿™é‡Œ</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> senderMajorFragmentId;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">int</span> receiverMajorFragmentId;</span><br><span class="line">  <span class="keyword">protected</span> List&lt;DrillbitEndpoint&gt; senderLocations;</span><br><span class="line">  <span class="keyword">protected</span> List&lt;DrillbitEndpoint&gt; receiverLocations;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setupSenders</span><span class="params">(List&lt;DrillbitEndpoint&gt; senderLocations)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.senderLocations = senderLocations;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupReceivers</span><span class="params">(List&lt;DrillbitEndpoint&gt; receiverLocations)</span> <span class="keyword">throws</span> PhysicalOperatorSetupException </span>&#123;</span><br><span class="line">    Preconditions.checkArgument(receiverLocations.size() == <span class="number">1</span>, <span class="string">"Union Exchange only supports a single receiver endpoint."</span>);</span><br><span class="line">    <span class="keyword">super</span>.setupReceivers(receiverLocations);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Sender <span class="title">getSender</span><span class="params">(<span class="keyword">int</span> minorFragmentId, PhysicalOperator child)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SingleSender(receiverMajorFragmentId, child, receiverLocations.get(<span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Receiver <span class="title">getReceiver</span><span class="params">(<span class="keyword">int</span> minorFragmentId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UnorderedReceiver(senderMajorFragmentId, PhysicalOperatorUtil.getIndexOrderedEndpoints(senderLocations), <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢getSenderå’ŒgetReceiverçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯minorFragmentId. newä¸€ä¸ªSenderæˆ–è€…Receiveréƒ½è¦çŸ¥é“å¯¹æ–¹çš„MajorFragmentId.<br>æ¯”å¦‚SingleSenderè¦çŸ¥é“Receiverçš„MajorFragmentId,ä»¥åŠæ¥æ”¶è€…çš„ä¸€ä¸ªLocation. UnorderReceiverè¦çŸ¥é“Senderçš„MajorId,ä»¥åŠæ‰€æœ‰å‘é€è€…çš„Locations.     </p>
<p>SingleSender: <code>Sender that pushes all data to a single destination node.</code> å‘é€è€…ä¼šå‘é€æ‰€æœ‰çš„æ•°æ®åˆ°ä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹,é‚£ä¹ˆå½“ç„¶è¦æŒ‡å®šè¿™ä¸ªç›®æ ‡èŠ‚ç‚¹äº†.<br>è¿™ä¸ªç›®æ ‡èŠ‚ç‚¹åº”è¯¥æ˜¯è·Ÿä¸Šè¡¨ä¸­çš„sendingExchangeå˜é‡ç›¸å…³çš„, å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œçš„root=SINGLE_SENDER. å½“ç„¶ç›®æ ‡èŠ‚ç‚¹æŒ‡çš„åº”è¯¥æ˜¯Drillbitçº§åˆ«,è€Œä¸æ˜¯Operatoräº†.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SingleSender</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractSender</span> &#123;</span></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Create a SingleSender which sends data to fragment identified by given MajorFragmentId and MinorFragmentId, and running at given endpoint</span><br><span class="line">   *</span><br><span class="line">   * @param oppositeMajorFragmentId MajorFragmentId of the receiver fragment.</span><br><span class="line">   * @param oppositeMinorFragmentId MinorFragmentId of the receiver fragment.</span><br><span class="line">   * @param child Child operator</span><br><span class="line">   * @param destination Drillbit endpoint where the receiver fragment is running.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="annotation">@JsonCreator</span></span><br><span class="line">  public <span class="type">SingleSender</span>(<span class="annotation">@JsonProperty</span>(<span class="string">"receiver-major-fragment"</span>) int oppositeMajorFragmentId,</span><br><span class="line">                      <span class="annotation">@JsonProperty</span>(<span class="string">"receiver-minor-fragment"</span>) int oppositeMinorFragmentId,</span><br><span class="line">                      <span class="annotation">@JsonProperty</span>(<span class="string">"child"</span>) <span class="type">PhysicalOperator</span> child,</span><br><span class="line">                      <span class="annotation">@JsonProperty</span>(<span class="string">"destination"</span>) <span class="type">DrillbitEndpoint</span> destination) &#123;</span><br><span class="line">    <span class="keyword">super</span>(oppositeMajorFragmentId, child,</span><br><span class="line">        <span class="type">Collections</span>.singletonList(<span class="keyword">new</span> <span class="type">MinorFragmentEndpoint</span>(oppositeMinorFragmentId, destination)));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>MinorFragmentEndpoint represents fragment&#39;s MinorFragmentId and Drillbit endpoint to which the fragment is assigned for execution.</code><br>DrillbitEndpointæ˜¯è¿è¡Œâ€™Drillbitâ€™æœåŠ¡çš„èŠ‚ç‚¹(é›†ç¾¤çš„è®¡ç®—èŠ‚ç‚¹). MinorFragmentEndpointæ˜¯fragmentè¦æ‰§è¡Œåœ¨å“ªä¸ªDrillbitèŠ‚ç‚¹,æ›´ç»†ç²’åº¦(Container?).  </p>
<p>å¯¹äºRecieverè€Œè¨€, å®ƒå¯ä»¥æœ‰å¤šä¸ªSender. </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UnorderedReceiver</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractReceiver</span>&#123;</span></span><br><span class="line">  <span class="annotation">@JsonCreator</span></span><br><span class="line">  public <span class="type">UnorderedReceiver</span>(<span class="annotation">@JsonProperty</span>(<span class="string">"sender-major-fragment"</span>) int oppositeMajorFragmentId,</span><br><span class="line">                           <span class="annotation">@JsonProperty</span>(<span class="string">"senders"</span>) <span class="type">List</span>&lt;<span class="type">MinorFragmentEndpoint</span>&gt; senders,</span><br><span class="line">                           <span class="annotation">@JsonProperty</span>(<span class="string">"spooling"</span>) boolean spooling) &#123;</span><br><span class="line">    <span class="keyword">super</span>(oppositeMajorFragmentId, senders, spooling);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢è§£é‡Šä¸‹FragmentLeafè¿™ä¸ªæ¥å£ä¸‹éƒ½æœ‰å“ªäº›å®ç°ç±». </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill27.png" alt=""></p>
<p>FragmentLeafæ˜¯ä¸€ä¸ªFragmentçš„å¶å­èŠ‚ç‚¹, Fragmentå’ŒDAGå›¾çš„å¶å­èŠ‚ç‚¹æ˜¯æœ‰ç‚¹å·®åˆ«å‘¢çš„. å› ä¸ºä¸€ä¸ªDAGå›¾ä¼šåŒ…æ‹¬å¤šä¸ªFragment.<br>1.æ¥æ”¶è€…æ˜¯ä¸€ä¸ªFragmentçš„å¶å­, å› ä¸ºExchangeä¼šåˆ†éš”Fragment. Fragmentçš„ä¸Šæ–¹æ˜¯æ¥æ”¶è€…,æ˜¯ä¸Šé¢ä¸€ä¸ªFragmentçš„å¶å­èŠ‚ç‚¹.<br>2.æ•´ä¸ªDAGå›¾çš„å¶å­èŠ‚ç‚¹é€šå¸¸æ˜¯Scan,æ˜¯ç»„æˆDAGæœ€ä¸‹é¢çš„é‚£ä¸ªFragmentçš„å¶å­èŠ‚ç‚¹.   </p>
<p>Fragmentçš„Rootæ˜¯ä¸€ä¸ªFragmentçš„æ ¹èŠ‚ç‚¹<br>1.å‘é€è€…æ˜¯ä¸€ä¸ªFragmentçš„æ ¹èŠ‚ç‚¹, å³Exchangeåˆ†éš”çš„ä¸‹é¢ä¸€ä¸ªFragmentçš„æ ¹èŠ‚ç‚¹,è€ŒFragmentä¸‹å‘æ˜¯ä¸€ä¸ªSender.<br>2.æ•´ä¸ªDAGå›¾çš„æ ¹èŠ‚ç‚¹é€šå¸¸æ˜¯Screen.  </p>
<h2 id="QueryWorkUnit">QueryWorkUnit</h2><p>åœ¨è¿è¡Œç‰©ç†è®¡åˆ’çš„ç¬¬ä¸€å¥æ˜¯æ ¹æ®ç‰©ç†è®¡åˆ’å¾—åˆ°QueryWorkUnit:    </p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> QueryWorkUnit work = getQueryWorkUnit(plan);</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;PlanFragment&gt; planFragments = work.getFragments();</span><br><span class="line"><span class="keyword">final</span> PlanFragment rootPlanFragment = work.getRootFragment();</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢çš„å·¥ä½œå•å…ƒåŒ…å«äº†ä¸‰ä¸ªç»„ä»¶, å¯¹äºæœ¬åœ°è€Œè¨€çš„æ ¹Fragmentå’Œæ ¹æ“ä½œç¬¦.  è¿™é‡Œçš„æœ¬åœ°æŒ‡çš„æ˜¯Foreman.  </p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryWorkUnit</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PlanFragment rootFragment; // <span class="keyword">for</span> <span class="keyword">local</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> FragmentRoot rootOperator; // <span class="keyword">for</span> <span class="keyword">local</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;PlanFragment&gt; fragments;  // Major+Minor Fragments</span><br></pre></td></tr></table></figure>
<p>è€ŒPlanFragmentæ—¢æ˜¯Planåˆæ˜¯Fragment.  å‰é¢æˆ‘ä»¬çŸ¥é“Fragmentç”±Exchangeåˆ†æˆäº†å¤šä¸ªMajor Fragment.<br>åœ¨éå†ç‰©ç†æ“ä½œç¬¦æ—¶, ä¼šå°†ç‰©ç†æ“ä½œç¬¦åŠ å…¥åˆ°å¯¹åº”çš„Fragmentä¸­.  </p>
<h3 id="Protobuf">Protobuf</h3><p>å¿…é¡»ä¸ŠProtobufè¿™é“èœäº†. å¯¹äºç†è§£ä¸åŒç»„ä»¶ä¹‹é—´çš„å…³ç³»æ˜¯æœ‰ä½œç”¨çš„.  å…¶å®å‰é¢RPCéƒ¨åˆ†ä¹Ÿæ˜¯ç”¨åˆ°äº†protobuf.<br>PlanFragmentçš„protobufå®šä¹‰åœ¨BitControl.protoä¸­. FragmentHandleåœ¨ExecutionProtos.protoä¸­  </p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">PlanFragment</span> </span>&#123;</span><br><span class="line">  <span class="keyword">optional</span> FragmentHandle handle = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">float</span> network_cost = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">float</span> cpu_cost = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">float</span> disk_cost = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">float</span> memory_cost = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> fragment_json = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">bool</span> leaf_fragment = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">optional</span> DrillbitEndpoint assignment = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">optional</span> DrillbitEndpoint foreman = <span class="number">11</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">int64</span> mem_initial = <span class="number">12</span> [default = <span class="number">20000000</span>]; <span class="comment">// 20 megs</span></span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">int64</span> mem_max = <span class="number">13</span> [default = <span class="number">2000000000</span>]; <span class="comment">// 20 gigs</span></span><br><span class="line">  <span class="keyword">optional</span> exec.shared.UserCredentials credentials = <span class="number">14</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> options_json = <span class="number">15</span>;</span><br><span class="line">  <span class="keyword">optional</span> QueryContextInformation context = <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">repeated</span> Collector collector = <span class="number">17</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">FragmentHandle</span> </span>&#123;</span><br><span class="line">	<span class="keyword">optional</span> exec.shared.QueryId query_id = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">optional</span> <span class="built_in">int32</span> major_fragment_id = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">optional</span> <span class="built_in">int32</span> minor_fragment_id = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ—¥å¿—ä¸€èŠ‚, å…¶ä¸­Root Fragment(rootFragmentå¯¹è±¡)æ‰“å°çš„ä¿¡æ¯å¦‚ä¸‹, å¯ä»¥çœ‹åˆ°æ­£å¥½å¯¹åº”äº†ä¸Šé¢çš„PlanFragmentçš„åè®®æ ¼å¼:  </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">handle &#123;				â†’ FragmentHandle</span><br><span class="line">  query_id &#123;</span><br><span class="line">    part1: <span class="number">3053657859282349058</span></span><br><span class="line">    part2: -<span class="number">8863752500417580646</span></span><br><span class="line">  &#125;</span><br><span class="line">  major_fragment_id: <span class="number">0</span></span><br><span class="line">  minor_fragment_id: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">fragment_json: <span class="string">"&#123;		â†’ fragment_json</span><br><span class="line">  ...</span><br><span class="line">&#125;"</span></span><br><span class="line">leaf_fragment: <span class="literal">true</span></span><br><span class="line">assignment &#123;			â†’ DrillbitEndpoint</span><br><span class="line">  address: <span class="string">"localhost"</span></span><br><span class="line">  user_port: <span class="number">31010</span></span><br><span class="line">  control_port: <span class="number">31011</span></span><br><span class="line">  data_port: <span class="number">31012</span></span><br><span class="line">&#125;</span><br><span class="line">foreman &#123;				â†’ DrillbitEndpoint</span><br><span class="line">  address: <span class="string">"localhost"</span></span><br><span class="line">  user_port: <span class="number">31010</span></span><br><span class="line">  control_port: <span class="number">31011</span></span><br><span class="line">  data_port: <span class="number">31012</span></span><br><span class="line">&#125;</span><br><span class="line">context &#123;</span><br><span class="line">  query_start_time: <span class="number">1436498522273</span></span><br><span class="line">  time_zone: <span class="number">299</span></span><br><span class="line">  default_schema_name: <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="QueryContext_&amp;_DrillbitContext"><strong>QueryContext &amp; DrillbitContext</strong></h3><p>è®¡ç®—fragmentsè¦æ ¹æ®æŸ¥è¯¢çš„ä¸Šä¸‹æ–‡QueryContext,ä»¥åŠDrillbitContext.<br>queryContext.getCurrentEndpoint()è¡¨ç¤ºForemanèŠ‚ç‚¹, queryContext.getActiveEndpoints()è¡¨ç¤ºå‚ä¸è®¡ç®—çš„å…¶ä»–èŠ‚ç‚¹.<br>æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹è·å–æ´»åŠ¨çš„Endpointsæ˜¯æ€ä¹ˆåšå¾—, å› ä¸ºDrillæ˜¯åˆ†å¸ƒå¼çš„è®¡ç®—å¼•æ“,æ·»åŠ è®¡ç®—èŠ‚ç‚¹èƒ½å¤Ÿè®©è®¡ç®—èƒ½åŠ›æé«˜.<br>é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°çš„, é€šè¿‡ZKçš„Watcheræœºåˆ¶, å¦‚æœæœ‰èŠ‚ç‚¹å¢åŠ è¿›æ¥,è·å–å¯ç”¨çš„è®¡ç®—èŠ‚ç‚¹æ—¶å°±æ˜¯åŠ¨æ€å®æ—¶çš„.   </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">queryContext.getActiveEndpoints()</span><br><span class="line">            <span class="string">|</span></span><br><span class="line">            <span class="string">|--&gt;drillbitContext.getBits()</span></span><br><span class="line">                      <span class="string">|     </span></span><br><span class="line">                      <span class="string">|--&gt;ClusterCoordinator.getAvailableEndpoints()</span></span><br><span class="line">                                 <span class="string">|</span></span><br><span class="line">                                 <span class="string">|&lt;--ZKClusterCoordinator.endpoints</span></span><br><span class="line">                                               <span class="string">|</span></span><br><span class="line">                                               <span class="string">|&lt;--updateEndpoints()</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“äº†é€šè¿‡ZKå®æ—¶è·å–åŠ¨æ€çš„è®¡ç®—èŠ‚ç‚¹, ä½†æ˜¯ä»»åŠ¡æ˜¯æ€ä¹ˆåˆ†é…åˆ°è®¡ç®—èŠ‚ç‚¹ä¸Šçš„. æˆ‘ä»¬èƒ½ä¸èƒ½è‡ªå®šä¹‰è½¬å‘è§„åˆ™??  </p>
</blockquote>
<h3 id="SimpleParallelizer">SimpleParallelizer</h3><p>ç”±SimpleParallelizerè·å¾—Fragments, å‚æ•°activeEndpointså°±æ˜¯ä¸Šé¢ä»ä¸Šä¸‹æ–‡ä¸­å¾—åˆ°çš„é›†ç¾¤ä¸­å¯ç”¨çš„Drillbitè®¡ç®—èŠ‚ç‚¹.<br>rootFragmentæ˜¯rootOperatorè¿”å›çš„Fragment, ç‰©ç†è®¡åˆ’çš„rootOperatorä¸€èˆ¬æ˜¯Screen. è¿™é‡Œçš„FragmentæŒ‡çš„æ˜¯ç”±Exchangeåˆ†å‰²çš„Major Fragment.  </p>
<p>è¯¥æ–¹æ³•æ ¹æ®æä¾›çš„Fragmentæ ‘ç”Ÿæˆåˆ†é…å¥½çš„Fragmentsé›†åˆ, å°±æ˜¯PlanFragment Protobufå¯¹è±¡é›†åˆ, ä¼šè¢«åˆ†é…åˆ°å•ç‹¬çš„èŠ‚ç‚¹.<br>è¿”å›çš„Fragments(æ³¨æ„æ˜¯å¤æ•°å½¢å¼), åˆ™æ˜¯Major+Minorçº§åˆ«çš„Fragmentäº†.  è€ŒMinor Fragmentså¯ä»¥æœ‰å¤šä¸ª, æ˜¯å¯ä»¥å¹¶è¡Œå¤„ç†çš„.  </p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯Fragmentæ ‘?  å°±æ˜¯æ–‡æ¡£ä¸­æåˆ°çš„å°†ç‰©ç†è®¡åˆ’è½¬æˆå¤šä¸ªFragments,è¿™äº›Fragmentsç»„æˆäº†ä¸€æ£µæ ‘.  </p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">final</span> QueryWorkUnit queryWorkUnit = parallelizer.getFragments(</span><br><span class="line">      queryContext.getOptions().getOptionList(), queryContext.getCurrentEndpoint(),</span><br><span class="line">      queryId, queryContext.getActiveEndpoints(), drillbitContext.getPlanReader(), rootFragment,</span><br><span class="line">      initiatingClient.getSession(), queryContext.getQueryContextInfo());</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Generate a set of assigned fragments based on the provided fragment tree. Do not allow parallelization stages to go beyond the global max width.</span><br><span class="line"> * <span class="doctag">@param</span> foremanNode       The driving/foreman node for this query.  (this node) æœ¬æ¬¡æŸ¥è¯¢çš„é©±åŠ¨èŠ‚ç‚¹/ForemanèŠ‚ç‚¹.</span><br><span class="line"> * <span class="doctag">@param</span> activeEndpoints   The list of endpoints to consider for inclusion in planning this query. è¦è®¡åˆ’æœ¬æ¬¡æŸ¥è¯¢, éœ€è¦è€ƒè™‘åŒ…æ‹¬åœ¨å†…çš„è®¡ç®—èŠ‚ç‚¹</span><br><span class="line"> * <span class="doctag">@param</span> reader                  Tool used to read JSON plans è¯»å–JSONæ ¼å¼çš„ç‰©ç†è®¡åˆ’</span><br><span class="line"> * <span class="doctag">@param</span> rootFragment      The root node of the PhysicalPlan that we will be parallelizing. ç‰©ç†è®¡åˆ’çš„æ ¹èŠ‚ç‚¹(å¯¹åº”çš„Fragment), ä¼šå¹¶è¡Œå¤„ç†. </span><br><span class="line"> * <span class="doctag">@return</span> The list of generated PlanFragment protobuf objects to be assigned out to the individual nodes.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> QueryWorkUnit getFragments(OptionList options, DrillbitEndpoint foremanNode, QueryId queryId, Collection&lt;DrillbitEndpoint&gt; activeEndpoints, </span><br><span class="line">    PhysicalPlanReader reader, Fragment rootFragment, UserSession session, QueryContextInformation queryContextInfo)  &#123;</span><br><span class="line">  <span class="keyword">final</span> PlanningSet planningSet = <span class="keyword">new</span> PlanningSet();</span><br><span class="line">  initFragmentWrappers(rootFragment, planningSet);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Set&lt;Wrapper&gt; leafFragments = constructFragmentDependencyGraph(planningSet);</span><br><span class="line">  <span class="comment">// Start parallelizing from leaf fragments</span></span><br><span class="line">  <span class="keyword">for</span> (Wrapper wrapper : leafFragments) &#123;</span><br><span class="line">    parallelizeFragment(wrapper, planningSet, activeEndpoints);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> generateWorkUnit(options, foremanNode, queryId, reader, rootFragment, planningSet, session, queryContextInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“rootFragmentåªæ˜¯ä»£è¡¨äº†DAGå›¾æœ€é¡¶ä¸Šçš„é‚£ä¸ªMajor Fragment, åœ¨ä¸‹é¢çš„è¿­ä»£ä¸­,è¦ç»™DAGå›¾ä¸­çš„æ¯ä¸ªMajor Fragmentéƒ½æ·»åŠ åˆ°planningSetä¸­.  </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// For every fragment, create a Wrapper in PlanningSet.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initFragmentWrappers</span>(<span class="params">Fragment rootFragment, PlanningSet planningSet</span>) </span>&#123;</span><br><span class="line">  planningSet.<span class="keyword">get</span>(rootFragment);</span><br><span class="line">  <span class="keyword">for</span>(ExchangeFragmentPair fragmentPair : rootFragment) &#123;</span><br><span class="line">    initFragmentWrappers(fragmentPair.getNode(), planningSet);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆ‘ä»¬å†ç»™å‡ºFragmentçš„è¿­ä»£æ–¹æ³•iterator.  forå¾ªç¯è¿­ä»£çš„æ˜¯receivingExchangePairs.<br>å‰é¢åˆ†æè¿‡ä¸Šä¸€ä¸ªFragmentä½œä¸ºæ¥æ”¶è€…æ¥æ”¶ä¸‹ä¸€ä¸ªFragmentå‘é€çš„æ•°æ®: <code>value.addReceiveExchange(exchange, next);</code><br>é‚£ä¹ˆExchangeFragmentPairçš„Nodeå°±æ˜¯next, å³ä¸‹ä¸€ä¸ªMajor Fragment, ç„¶åç»§ç»­é€’å½’ä¸‹å».  </p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class <span class="type">Fragment</span> implements <span class="type">Iterable</span>&lt;<span class="type">Fragment</span>.<span class="type">ExchangeFragmentPair</span>&gt; &#123;</span><br><span class="line">  private final <span class="type">List</span>&lt;<span class="type">ExchangeFragmentPair</span>&gt; receivingExchangePairs = <span class="type">Lists</span>.newLinkedList();</span><br><span class="line"></span><br><span class="line">  public <span class="type">void</span> addReceiveExchange(<span class="type">Exchange</span> e, <span class="type">Fragment</span> fragment) &#123;</span><br><span class="line">    this.receivingExchangePairs.add(new <span class="type">ExchangeFragmentPair</span>(e, fragment));</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="type">Iterator</span>&lt;<span class="type">ExchangeFragmentPair</span>&gt; <span class="keyword">iterator</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> this.receivingExchangePairs.<span class="keyword">iterator</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="PlanningSet+Wrapper">PlanningSet+Wrapper</h3><p>æ—¢ç„¶ç”¨åˆ°äº†ReceiveExchange, ä¸‹é¢é©¬ä¸Šå°±ç”¨åˆ°äº†SendingExchange.  æ·»åŠ æ˜¯åœ¨: <code>next.addSendExchange(exchange, value);</code><br>ä¸‹é¢ç”¨çš„ä¸æ˜¯ExchangeFragmentPairçš„Fragmentäº†, è€Œæ˜¯Fragmentçš„Exchange. è¿™é‡Œè¦åšåˆ°çš„æ˜¯è®¾ç½®MajorFragmentId.<br>å› ä¸ºç”±Exchangeåˆ†å‰²çš„Major Fragment, å®ƒä»¬çš„IDåˆ†åˆ«æ˜¯00,01,02ç­‰ç­‰.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlanningSet</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Wrapper</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Fragment, Wrapper&gt; fragmentMap = Maps.newHashMap();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> majorFragmentIdIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Wrapper <span class="title">get</span><span class="params">(Fragment node)</span> </span>&#123;</span><br><span class="line">    Wrapper wrapper = fragmentMap.get(node);</span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> majorFragmentId = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// If there is a sending exchange, we need to number other than zero.</span></span><br><span class="line">      <span class="keyword">if</span> (node.getSendingExchange() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// assign the upper 16 bits as the major fragment id.</span></span><br><span class="line">        majorFragmentId = node.getSendingExchange().getChild().getOperatorId() &gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="comment">// if they are not assigned, that means we mostly likely have an externally generated plan.  in this case, come up with a major fragmentid.</span></span><br><span class="line">        <span class="keyword">if</span> (majorFragmentId == <span class="number">0</span>)   majorFragmentId = majorFragmentIdIndex;</span><br><span class="line">      &#125;</span><br><span class="line">      wrapper = <span class="keyword">new</span> Wrapper(node, majorFragmentId);  <span class="comment">// Wrapperç”±Fragmentå’Œmajorç¼–å·ç»„æˆ</span></span><br><span class="line">      fragmentMap.put(node, wrapper);</span><br><span class="line">      majorFragmentIdIndex++;  <span class="comment">// åªæœ‰è°ƒç”¨Major Fragmentæ—¶, æ¯é‡åˆ°æ–°çš„Major, ç´¢å¼•ç¼–å·+1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> wrapper;  <span class="comment">// planningSet.getå¹¶æ²¡æœ‰ç”¨è¿”å›å€¼åšä»€ä¹ˆäº‹æƒ…. å…¶å®ä¸»è¦æ˜¯æ”¾åˆ°Mapä¸­, ç”±è¿­ä»£å™¨è®¿é—®æ‰€æœ‰çš„Wrapper.  </span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Iterator&lt;Wrapper&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.fragmentMap.values().iterator();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Wrapper: <code>A wrapping class that allows us to add additional information to each fragment node for planning purposes</code><br>å®ƒçš„æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡æ˜¯ç”±PlanningSetæŒ‡å®šMajorFragmentå’ŒMajorFragmentId. å®ƒçš„å…¶ä½™å±æ€§éœ€è¦åœ¨ä¸‹é¢ä¸­è®¾ç½®è¿›æ¥.  </p>
<p>å…ˆæ¥çœ‹ä¸‹Exchangeçš„å¹¶è¡Œä¾èµ–:  å‘é€è€…å’Œæ¥æ”¶è€…æ˜¯å¦ç›¸äº’ä¾èµ–.  </p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Exchanges are <span class="keyword">fragment</span> boundaries <span class="keyword">in</span> physical operator tree. It is divided into two parts. First part is Sender</span><br><span class="line"> * which becomes part of the sending <span class="keyword">fragment</span>. Second part is Receiver which becomes part of the <span class="keyword">fragment</span> that receives the data.</span><br><span class="line"> * Exchangeæ˜¯ç‰©ç†æ“ä½œç¬¦æ ‘çš„Fragmentè¾¹ç•Œ. ç¬¬ä¸€éƒ¨åˆ†Sender,å®ƒæ˜¯å‘é€è€…Fragmentçš„ä¸€éƒ¨åˆ†, ç¬¬äºŒéƒ¨åˆ†Recieveræ˜¯æ¥æ”¶è€…Fragmentçš„ä¸€éƒ¨åˆ†. </span><br><span class="line"> * Assignment dependency describes whether sender fragments depend <span class="keyword">on</span> receiver <span class="keyword">fragment</span>'s endpoint assignment <span class="keyword">for</span></span><br><span class="line"> * determining its parallelization and endpoint assignment and vice versa.</span><br><span class="line"> * åˆ†é…ä¾èµ–æè¿°äº†å‘é€è€…Fragmentæ˜¯å¦ä¾èµ–äºæ¥æ”¶è€…Fragmentçš„èŠ‚ç‚¹åˆ†é…ä»»åŠ¡, ä»¥ä¾¿äºå†³å®šå¹¶è¡Œåº¦å’Œå¦‚ä½•åˆ†é…å·¥ä½œåˆ°èŠ‚ç‚¹ä¸Š. åè¿‡æ¥ä¸€æ ·.   </span><br><span class="line"> */</span><br><span class="line">public enum ParallelizationDependency &#123;</span><br><span class="line">  SENDER_DEPENDS_ON_RECEIVER, // Sending <span class="keyword">fragment</span> depends <span class="keyword">on</span> receiving <span class="keyword">fragment</span> <span class="keyword">for</span> parallelization</span><br><span class="line">  RECEIVER_DEPENDS_ON_SENDER, // Receiving <span class="keyword">fragment</span> depends <span class="keyword">on</span> sending <span class="keyword">fragment</span> <span class="keyword">for</span> parallelization (<span class="keyword">default</span> value).</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®PlanningSetæ„é€ ä¾èµ–å›¾:  </p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">final</span> <span class="built_in">Set</span>&lt;Wrapper&gt; leafFragments = constructFragmentDependencyGraph(planningSet);</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/** æ ¹æ®Exchangeçš„äº²å¯†ç¨‹åºåˆ†å‰²ä¸¤ä¸ªfragments, å¹¶ä¸”è®¾ç½®fragmentçš„ä¾èµ–å…³ç³».  </span><br><span class="line"> * Based on </span>the<span class="markdown"> affinity of </span>the<span class="markdown"> Exchange that separates two fragments, setup fragment dependencies.</span><br><span class="line"> * @return Returns </span>a<span class="markdown"> list of leaf fragments in fragment dependency graph. */</span></span></span><br><span class="line">private <span class="literal">static</span> <span class="built_in">Set</span>&lt;Wrapper&gt; constructFragmentDependencyGraph(PlanningSet planningSet) &#123;</span><br><span class="line">  <span class="comment">// Set up dependency of fragments based on the affinity of exchange that separates the fragments.</span></span><br><span class="line">  <span class="keyword">for</span>(Wrapper currentFragmentWrapper : planningSet) &#123;  <span class="comment">// PlanningSetåŒ…å«äº†æ‰€æœ‰çš„Major Fragmentç»„æˆçš„Wrapper,å¾ªç¯æ¯ä¸€ä¸ªWrapper</span></span><br><span class="line">    ExchangeFragmentPair sendingExchange = currentFragmentWrapper.getNode().getSendingExchangePair();  <span class="comment">//æ¯ä¸ªMajorFragmentè¦å‘é€çš„ç›®æ ‡</span></span><br><span class="line">    <span class="keyword">if</span> (sendingExchange != <span class="keyword">null</span>) &#123;  <span class="comment">// SendingExchangeä¸ä¸ºç©ºçš„, æ¯”å¦‚next, è€Œä¸æ˜¯DAGå›¾çš„ç¬¬ä¸€ä¸ªFragment. å› ä¸ºåªæœ‰nextæ‰æ˜¯å‘é€è€…</span></span><br><span class="line">      ParallelizationDependency dependency = sendingExchange.getExchange().getParallelizationDependency();  <span class="comment">// ä¾èµ–å…³ç³»è®°å½•åœ¨Exchangeä¸­, è€Œä¸æ˜¯Fragmentä¸­</span></span><br><span class="line">      Wrapper receivingFragmentWrapper = planningSet.<span class="literal">get</span>(sendingExchange.getNode());  <span class="comment">// ç›®æ ‡èŠ‚ç‚¹, å®é™…ä¸Šå°±æ˜¯æ¥æ”¶è€…äº†</span></span><br><span class="line">      <span class="comment">// æ ¹æ®ä¾èµ–å…³ç³», åˆ¤æ–­è¦åŠ åˆ°å“ªä¸ªWrapperä¸­, å®é™…ä¸Šæ˜¯å“ªä¸ªFragmentä¸­. å› ä¸ºWrapperç”±MajorFragmentç»„æˆ.  </span></span><br><span class="line">      <span class="keyword">if</span> (dependency == ParallelizationDependency.RECEIVER_DEPENDS_ON_SENDER) &#123;     <span class="comment">// Receiverä¾èµ–Sender</span></span><br><span class="line">        receivingFragmentWrapper.addFragmentDependency(currentFragmentWrapper);   <span class="comment">// Receiverçš„ä¾èµ–å…³ç³»å›¾ä¸­æœ‰å½“å‰Major Fragment</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dependency == ParallelizationDependency.SENDER_DEPENDS_ON_RECEIVER) &#123;  <span class="comment">// Senderä¾èµ–Reciever</span></span><br><span class="line">        currentFragmentWrapper.addFragmentDependency(receivingFragmentWrapper);   <span class="comment">// å½“å‰èŠ‚ç‚¹åˆšå¥½æ˜¯Sender, æ‰€ä»¥å®ƒä¾èµ–äº†æ¥æ”¶è€…</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¸Šé¢çš„æ·»åŠ Fragmentä¾èµ–å›¾, ä¸‹é¢çš„Wrapperæ‰å¯ä»¥è·å¾—ä¾èµ–å›¾, æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹.  </span></span><br><span class="line">  <span class="comment">// Identify leaf fragments. Leaf fragments are fragments that have no other fragments depending on them for parallelization info. </span></span><br><span class="line">  <span class="comment">// First assume all fragments are leaf fragments. Go through the fragments one by one and  remove the fragment on which the current fragment depends on.</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Set</span>&lt;Wrapper&gt; roots = Sets.newHashSet();</span><br><span class="line">  <span class="keyword">for</span>(Wrapper w : planningSet) &#123;</span><br><span class="line">    roots.add(w);  <span class="comment">// æ‰€æœ‰çš„Major Fragment</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(Wrapper wrapper : planningSet) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;Wrapper&gt; fragmentDependencies = wrapper.getFragmentDependencies();  <span class="comment">// æ¯ä¸ªMajor Fragmentçš„ä¾èµ–å›¾</span></span><br><span class="line">    <span class="keyword">if</span> (fragmentDependencies != <span class="keyword">null</span> &amp;&amp; fragmentDependencies.size() &gt; <span class="number">0</span>) </span><br><span class="line">      <span class="keyword">for</span>(Wrapper dependency : fragmentDependencies)   <span class="comment">// å®ƒçš„æ‰€æœ‰ä¾èµ–è€…</span></span><br><span class="line">        <span class="keyword">if</span> (roots.contains(dependency)) </span><br><span class="line">          roots.remove(dependency);  <span class="comment">// ä»rootsä¸­ç§»é™¤</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> roots;  <span class="comment">// è¿”å›å€¼æ˜¯leaf fragments. </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ–¹æ³•rootsè¿”å›çš„æ˜¯leaf fragments. åœ¨è¿™ä¹‹å‰é¦–å…ˆå¯¹æ¯ä¸ªMajor Fragmentséƒ½è®¾ç½®äº†ä¾èµ–å›¾. ç„¶åæŠŠéå¶å­èŠ‚ç‚¹ä»æ‰€æœ‰çš„Majorä¸­åˆ é™¤.<br>å¶å­èŠ‚ç‚¹çš„å®šä¹‰æ˜¯: æ²¡æœ‰ä¾èµ–å…¶ä»–ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹. ä¸€æ—¦ä¸€ä¸ªèŠ‚ç‚¹æœ‰ä¾èµ–æŸä¸€ä¸ªèŠ‚ç‚¹, å®ƒå°±ä¸æ˜¯å¶å­èŠ‚ç‚¹äº†.  </p>
<p>è·å¾—å¶å­Fragmentå, å¯¹æ¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹è¿›è¡Œå¹¶è¡Œå¤„ç†. å¤„ç†çš„æ—¶å€™å…ˆå¤„ç†ä¾èµ–çš„,ç„¶åæ‰å¤„ç†è‡ªå·±.æ‰€ä»¥ä¹Ÿæ˜¯é€’å½’çš„è¿‡ç¨‹    </p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  // Start parallelizing <span class="keyword">from</span> leaf fragments ä»å¶å­èŠ‚ç‚¹å¼€å§‹å¹¶è¡Œå¤„ç†</span><br><span class="line">  <span class="keyword">for</span> (Wrapper wrapper : leafFragments) &#123;</span><br><span class="line">    parallelizeFragment(wrapper, planningSet, activeEndpoints);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">// Helper method <span class="keyword">for</span> parallelizing a given <span class="keyword">fragment</span>. Dependent fragments are parallelized first before  parallelizing the given <span class="keyword">fragment</span>.</span><br><span class="line">private void parallelizeFragment(Wrapper <span class="keyword">fragment</span>Wrapper, PlanningSet planningSet, Collection<span class="variable">&lt;DrillbitEndpoint&gt;</span> activeEndpoints)  &#123;</span><br><span class="line">  // First parallelize fragments <span class="keyword">on</span> which this <span class="keyword">fragment</span> depends <span class="keyword">on</span>.</span><br><span class="line">  final List<span class="variable">&lt;Wrapper&gt;</span> <span class="keyword">fragment</span>Dependencies = <span class="keyword">fragment</span>Wrapper.getFragmentDependencies();</span><br><span class="line">  if (<span class="keyword">fragment</span>Dependencies != null &amp;&amp; <span class="keyword">fragment</span>Dependencies.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(Wrapper dependency : <span class="keyword">fragment</span>Dependencies) &#123;</span><br><span class="line">      parallelizeFragment(dependency, planningSet, activeEndpoints);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Fragment <span class="keyword">fragment</span> = <span class="keyword">fragment</span>Wrapper.getNode();</span><br><span class="line"></span><br><span class="line">  // Step <span class="number">1</span>: Find stats. Stats include various factors including cost of physical operators, parallelizability of work <span class="keyword">in</span> physical operator and affinity of physical operator <span class="keyword">to</span> certain nodes.</span><br><span class="line">  <span class="keyword">fragment</span>.getRoot().accept(new StatsCollector(planningSet), <span class="keyword">fragment</span>Wrapper);</span><br><span class="line"></span><br><span class="line">  // Step <span class="number">2</span>: Find the parallelization width of <span class="keyword">fragment</span></span><br><span class="line">  </span><br><span class="line">  List<span class="variable">&lt;DrillbitEndpoint&gt;</span> assignedEndpoints = findEndpoints(activeEndpoints, parallelizationInfo.getEndpointAffinityMap(), <span class="keyword">fragment</span>Wrapper.getWidth());</span><br><span class="line">  <span class="keyword">fragment</span>Wrapper.assignEndpoints(assignedEndpoints);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°è¦åˆ†é…çš„DrillBitå,å°±ä¸ºFragmentåˆ†é…è®¡ç®—èŠ‚ç‚¹ . ä¸€ä¸ªFragmentçš„Sendingåªæœ‰æœ€å¤šä¸€ä¸ª,å¯ä»¥æœ‰å¤šä¸ªReceiver.   </p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void assignEndpoints(List<span class="tag">&lt;DrillbitEndpoint&gt;</span> assignedEndpoints)  &#123;</span><br><span class="line">  endpoints.addAll(assignedEndpoints);</span><br><span class="line"></span><br><span class="line">  // Set scan <span class="operator">and</span> store endpoints.</span><br><span class="line">  AssignEndpointsToScanAndStore visitor = new AssignEndpointsToScanAndStore();</span><br><span class="line">  <span class="keyword">node</span>.<span class="identifier"></span><span class="title">getRoot</span>().accept(visitor, endpoints);</span><br><span class="line"></span><br><span class="line">  // Set the endpoints for this (one at most) sending exchange.</span><br><span class="line">  if (<span class="keyword">node</span>.<span class="identifier"></span><span class="title">getSendingExchange</span>() != null) &#123;</span><br><span class="line">    <span class="keyword">node</span>.<span class="identifier"></span><span class="title">getSendingExchange</span>().setupSenders(majorFragmentId, endpoints);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Set the endpoints for each incoming exchange within this fragment.</span><br><span class="line">  for (ExchangeFragmentPair e : <span class="keyword">node</span>.<span class="identifier"></span><span class="title">getReceivingExchangePairs</span>()) &#123;</span><br><span class="line">    e.getExchange().setupReceivers(majorFragmentId, endpoints);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ååŸºäºä¸Šé¢çš„å·¥ä½œ, ç”ŸæˆWorkUnit, QueryWorkUnitåªæ˜¯å°è£…äº†rootOperator,rootFragment,fragmentsçš„å¯¹è±¡.  æ³¨æ„ä¸‹é¢æ˜¯ä¸ªåŒå±‚å¾ªç¯,<br>å¤–å±‚çš„æ˜¯å¯¹æ¯ä¸ªMajorFragment,å†…å±‚åˆ™å¯¹æ¯ä¸ªMinorFragment. å¦‚æœä¸æ˜¯æ ¹èŠ‚ç‚¹,åˆ™æŠŠåˆ›å»ºçš„PlanFragmentåŠ å…¥åˆ°fragmentsä¸­.<br>PlanFragmentä¸€ä¸ªé‡è¦çš„å¯¹è±¡æ˜¯FragmentHandle,é¡¾åæ€ä¹‰æ˜¯Fragmentçš„å¤„ç†ç±», å®ƒåªå°è£…äº†Major,Minorçš„FragmentID,ä»¥åŠæŸ¥è¯¢ID.  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> QueryWorkUnit generateWorkUnit(OptionList <span class="keyword">options</span>, DrillbitEndpoint foremanNode, QueryId queryId,</span><br><span class="line">    PhysicalPlanReader reader, Fragment rootNode, PlanningSet planningSet, UserSession session, QueryContextInformation queryContextInfo) &#123;</span><br><span class="line">  List&lt;PlanFragment&gt; fragments = Lists.newArrayList();</span><br><span class="line">  PlanFragment rootFragment = <span class="keyword">null</span>;</span><br><span class="line">  FragmentRoot rootOperator = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now we generate all the individual plan fragments and associated assignments. Note, we need all endpoints</span></span><br><span class="line">  <span class="comment">// assigned before we can materialize, so we start a new loop here rather than utilizing the previous one.</span></span><br><span class="line">  <span class="keyword">for</span> (Wrapper wrapper : planningSet) &#123;</span><br><span class="line">    Fragment node = wrapper.getNode();</span><br><span class="line">    <span class="keyword">final</span> PhysicalOperator physicalOperatorRoot = node.getRoot();</span><br><span class="line">    <span class="keyword">boolean</span> isRootNode = rootNode == node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a fragment is self driven if it doesn't rely on any other exchanges.</span></span><br><span class="line">    <span class="keyword">boolean</span> isLeafFragment = node.getReceivingExchangePairs().<span class="keyword">size</span>() == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a minorFragment for each major fragment.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> minorFragmentId = <span class="number">0</span>; minorFragmentId &lt; wrapper.getWidth(); minorFragmentId++) &#123;</span><br><span class="line">      IndexedFragmentNode iNode = <span class="keyword">new</span> IndexedFragmentNode(minorFragmentId, wrapper);</span><br><span class="line">      wrapper.resetAllocation();</span><br><span class="line">      PhysicalOperator op = physicalOperatorRoot.accept(Materializer.INSTANCE, iNode);</span><br><span class="line">      FragmentRoot root = (FragmentRoot) op;</span><br><span class="line">      FragmentHandle handle = FragmentHandle.newBuilder() <span class="comment">//</span></span><br><span class="line">          .setMajorFragmentId(wrapper.getMajorFragmentId()) <span class="comment">//</span></span><br><span class="line">          .setMinorFragmentId(minorFragmentId) <span class="comment">//</span></span><br><span class="line">          .setQueryId(queryId) <span class="comment">//</span></span><br><span class="line">          .build();</span><br><span class="line">      PlanFragment fragment = PlanFragment.newBuilder() <span class="comment">//</span></span><br><span class="line">          .setForeman(foremanNode) <span class="comment">//</span></span><br><span class="line">          .setFragmentJson(reader.writeJson(root)) <span class="comment">//</span></span><br><span class="line">          .setHandle(handle) <span class="comment">//</span></span><br><span class="line">          .setAssignment(wrapper.getAssignedEndpoint(minorFragmentId)) <span class="comment">//</span></span><br><span class="line">          .setLeafFragment(isLeafFragment) <span class="comment">//</span></span><br><span class="line">          .setContext(queryContextInfo)</span><br><span class="line">          .setMemInitial(wrapper.getInitialAllocation())<span class="comment">//</span></span><br><span class="line">          .setMemMax(wrapper.getMaxAllocation())</span><br><span class="line">          .setOptionsJson(reader.writeJson(<span class="keyword">options</span>))</span><br><span class="line">          .setCredentials(session.getCredentials())</span><br><span class="line">          .addAllCollector(CountRequiredFragments.getCollectors(root))</span><br><span class="line">          .build();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isRootNode) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Root fragment:\n &#123;&#125;"</span>, DrillStringUtils.unescapeJava(fragment.toString()));</span><br><span class="line">        rootFragment = fragment;</span><br><span class="line">        rootOperator = root;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">"Remote fragment:\n &#123;&#125;"</span>, DrillStringUtils.unescapeJava(fragment.toString()));</span><br><span class="line">        fragments.add(fragment);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> QueryWorkUnit(rootOperator, rootFragment, fragments);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æäº¤å¹¶æ‰§è¡ŒFragments">æäº¤å¹¶æ‰§è¡ŒFragments</h2><p>ç°åœ¨ä¸»çº¿å›åˆ°Foremançš„runPhysicalPlan, åœ¨æäº¤Fragmentsæ‰§è¡Œå‰, å…ˆæ·»åŠ äº†ä¸¤ä¸ªç›‘å¬å™¨åˆ°DrillbitContextå¯¹åº”çš„WorkBuså’Œé›†ç¾¤åè°ƒå™¨.<br>ç„¶åè®¾ç½®RootFragmentå’ŒéRootFragment. è®¾ç½®æ ¹èŠ‚ç‚¹éœ€è¦QueryWorkUnitçš„rootFragmentå’ŒrootOperator.  éæ ¹èŠ‚ç‚¹åªéœ€è¦planFragments.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">runPhysicalPlan</span><span class="params">(<span class="keyword">final</span> PhysicalPlan plan)</span> <span class="keyword">throws</span> ExecutionSetupException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> QueryWorkUnit work = getQueryWorkUnit(plan);</span><br><span class="line">  <span class="keyword">final</span> List&lt;PlanFragment&gt; planFragments = work.getFragments();</span><br><span class="line">  <span class="keyword">final</span> PlanFragment rootPlanFragment = work.getRootFragment();</span><br><span class="line"></span><br><span class="line">  drillbitContext.getWorkBus().addFragmentStatusListener(queryId, queryManager.getFragmentStatusListener());</span><br><span class="line">  drillbitContext.getClusterCoordinator().addDrillbitStatusListener(queryManager.getDrillbitStatusListener());</span><br><span class="line">  logger.debug(<span class="string">"Submitting fragments to run."</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up the root fragment first so we'll have incoming buffers available.</span></span><br><span class="line">  setupRootFragment(rootPlanFragment, work.getRootOperator());</span><br><span class="line">  setupNonRootFragments(planFragments);</span><br><span class="line">  drillbitContext.getAllocator().resetFragmentLimits(); <span class="comment">// TODO a global effect for this query?!?</span></span><br><span class="line"></span><br><span class="line">  moveToState(QueryState.RUNNING, <span class="keyword">null</span>);</span><br><span class="line">  logger.debug(<span class="string">"Fragments running."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-14-drill-logical" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-14-drill-logical/" class="article-date">
  	<time datetime="2015-12-01T10:23:52.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-14-drill-logical/">Apache Drillæºç é˜…è¯»(4) é€»è¾‘è®¡åˆ’</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>åœ¨å‰é¢è¯´è¿‡, Calciteçš„SQLèŠ‚ç‚¹è½¬æ¢ä¸ºDrillçš„DrillRelèŠ‚ç‚¹,åœ¨DefaultSqlHandler.convertToDrelä¼šåŒ…è£…ä¸Šä¸€ä¸ªScreen: DrillScreenRel  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function">DrillRel <span class="title">convertToDrel</span><span class="params">(RelNode relNode, RelDataType validatedRowType)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Put a non-trivial topProject to ensure the final output field name is preserved, when necessary.</span></span><br><span class="line">      DrillRel topPreservedNameProj = addRenamedProject((DrillRel) convertedRelNode, validatedRowType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DrillScreenRel(topPreservedNameProj.getCluster(), topPreservedNameProj.getTraitSet(), topPreservedNameProj);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆconvertToDrelä¸­çš„RelNodeä»¥åŠæ›´æ—©ä¹‹å‰çš„SqlNodeåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„? ä¸ºäº†è§£å¼€è¿™ä¸ªè°œé¢˜,æˆ‘ä»¬è¦debugä¸‹drillçš„æºç æ‰èƒ½çŸ¥æ™“. </p>
<h2 id="sqlline">sqlline</h2><p>SQLè¯­å¥: </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> department_id,<span class="keyword">count</span>(*) cnt  	â†’ <span class="keyword">Project</span></span><br><span class="line"><span class="keyword">from</span> cp.<span class="string">`employee.json`</span> 			â†’ <span class="keyword">Scan</span> 		</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> department_id 				â†’ HashAgg</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span> 				â†’ <span class="keyword">Sort</span></span></span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„ç‰©ç†è®¡åˆ’:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>-<span class="number">00</span>    Screen : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">1023.2299999999999</span> rows, <span class="number">10798.630541406654</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">361</span></span><br><span class="line"><span class="number">00</span>-<span class="number">01</span>      Project(department_id=[$<span class="number">0</span>], cnt=[$<span class="number">1</span>]) : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">1018.5999999999999</span> rows, <span class="number">10794.000541406655</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">360</span></span><br><span class="line"><span class="number">00</span>-<span class="number">02</span>        SelectionVectorRemover : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">1018.5999999999999</span> rows, <span class="number">10794.000541406655</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">359</span></span><br><span class="line"><span class="number">00</span>-<span class="number">03</span>          Sort(sort0=[$<span class="number">1</span>], dir0=[DESC]) : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">972.3</span> rows, <span class="number">10747.700541406655</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8889.6</span> memory&#125;, id = <span class="number">358</span></span><br><span class="line"><span class="number">00</span>-<span class="number">04</span>            HashAgg(group=[&#123;<span class="number">0</span>&#125;], cnt=[COUNT()]) : rowType = RecordType(ANY department_id, BIGINT cnt): rowcount = <span class="number">46.3</span>, cumulative cost = &#123;<span class="number">926.0</span> rows, <span class="number">9723.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">8148.800000000001</span> memory&#125;, id = <span class="number">357</span></span><br><span class="line"><span class="number">00</span>-<span class="number">05</span>              Scan(groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.json, numFiles=<span class="number">1</span>, columns=[`department_id`], files=[classpath:/employee.json]]]) : rowType = RecordType(ANY department_id): rowcount = <span class="number">463.0</span>, cumulative cost = &#123;<span class="number">463.0</span> rows, <span class="number">463.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">356</span></span><br></pre></td></tr></table></figure>
<p>å¯è§†åŒ–çš„è®¡åˆ’å›¾:</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill21.png" alt=""></p>
<h2 id="Debug">Debug</h2><p>ä½¿ç”¨<code>mvn clean install -DskipTests</code>ç¼–è¯‘æºç å·¥ç¨‹å, åœ¨drill-jdbcçš„testå·¥ç¨‹ä¸‹çš„DrillResultSetTestæµ‹è¯•ç±»ä¸‹æ–°å»ºä¸€ä¸ªæµ‹è¯•æ–¹æ³•: </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">testQueryCP</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">  Connection connection = <span class="keyword">new</span> Driver().connect( <span class="string">"jdbc:drill:zk=local"</span>, JdbcAssert.getDefaultProperties() );</span><br><span class="line">  Statement statement = connection.createStatement();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//SQL</span></span><br><span class="line">  ResultSet resultSet = statement.executeQuery( <span class="string">"select department_id,count(*) cnt from cp.`employee.json` group by department_id order by count(*) desc"</span> );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ç‰©ç†è®¡åˆ’</span></span><br><span class="line">  <span class="comment">//ResultSet resultSet = statement.executeQuery( "explain plan for select department_id,count(*) cnt from cp.`employee.json` group by department_id order by count(*) desc" );</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//é€»è¾‘è®¡åˆ’</span></span><br><span class="line">  <span class="comment">//ResultSet resultSet = statement.executeQuery( "explain plan without implementation for select department_id,count(*) cnt from cp.`employee.json` group by department_id order by count(*) desc" );</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨DrillSqlWorker.getPlançš„<code>sqlNode = planner.parse(sql)</code>æ‰“ä¸Šæ–­ç‚¹: </p>
<h3 id="SqlNode">SqlNode</h3><p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-sqlnode.png" alt=""></p>
<p>è¿™é‡Œçš„sqlNodeæ˜¯ä¸€ä¸ªSqlOrderByè§£ææ ‘èŠ‚ç‚¹.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parse tree node that represents an "ORDER BY" on a query other than a "SELECT" (e.g. "VALUES" or "UNION").</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SqlOrderBy</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">SqlCall</span> &#123;</span></span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNode</span> query;</span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNodeList</span> orderList;</span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNode</span> offset;</span><br><span class="line">  public <span class="keyword">final</span> <span class="type">SqlNode</span> fetch;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­queryèŠ‚ç‚¹æ˜¯SqlSelect. ä¸€ä¸ªå®Œæ•´çš„selectè¯­å¥æœ‰å¤šä¸ªéƒ¨åˆ†ç»„æˆ:  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A SqlSelect is a node of a parse tree which represents a select statement.</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SqlSelect</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">SqlCall</span> &#123;</span></span><br><span class="line">  <span class="type">SqlNodeList</span> keywordList;</span><br><span class="line">  <span class="type">SqlNodeList</span> selectList;</span><br><span class="line">  <span class="type">SqlNode</span> from;</span><br><span class="line">  <span class="type">SqlNode</span> where;</span><br><span class="line">  <span class="type">SqlNodeList</span> groupBy;</span><br><span class="line">  <span class="type">SqlNode</span> having;</span><br><span class="line">  <span class="type">SqlNodeList</span> windowDecls;</span><br><span class="line">  <span class="type">SqlNodeList</span> orderBy;</span><br><span class="line">  <span class="type">SqlNode</span> offset;</span><br><span class="line">  <span class="type">SqlNode</span> fetch;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ä¸Šé¢çš„sqlNodeæœ‰è‡ªå·±çš„orderListå³count(*) desc, æ‰€ä»¥SqlSelectä¸­çš„order byä¸ºnull.  </p>
<blockquote>
<p>æ³¨æ„åˆ°ç±»åå­—åé¢è·Ÿçš„@æ•°å­—å—, è¿™æ˜¯ä¸€ä¸ªå¯¹è±¡çš„å­—ç¬¦ä¸²å€¼è¡¨ç¤ºå½¢å¼:Class@1234,<br>å…¶ä¸­æ•°å­—è¿˜ä»£è¡¨äº†åˆ›å»ºå¯¹è±¡çš„é¡ºåº. æ•°å­—è¶Šå¤§, åˆ™å¯¹è±¡åˆ›å»ºçš„æ—¶é—´è¶Šæ™š.  </p>
</blockquote>
<h3 id="â‘ RelNode">â‘ RelNode</h3><p>RelNodeæ˜¯Calciteçš„å…³ç³»è¡¨è¾¾å¼èŠ‚ç‚¹, å®ƒæ¯”SqlNodeè¿˜è¦æ›´ä¸Šå±‚. ä¸‹é¢æ˜¯relåœ¨debugæ—¶å€™çš„value  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rel<span class="preprocessor">#<span class="number">13</span>:LogicalSort.NONE.ANY([]).[<span class="number">1</span> DESC]</span></span><br><span class="line">  (input=rel<span class="preprocessor">#<span class="number">11</span>:LogicalAggregate.NONE.ANY([]).[]</span></span><br><span class="line">  	(input=rel<span class="preprocessor">#<span class="number">9</span>:LogicalProject.NONE.ANY([]).[]</span></span><br><span class="line">  		(input=rel<span class="preprocessor">#<span class="number">4</span>:EnumerableTableScan.ENUMERABLE.ANY([]).[]</span></span><br><span class="line">  			(table=[cp, employee.json]),department_id=$<span class="number">1</span>),group=&#123;<span class="number">0</span>&#125;,cnt=COUNT()</span><br><span class="line">  	),</span><br><span class="line">  	sort0=$<span class="number">1</span>,</span><br><span class="line">  	dir0=DESC</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾ä¸­relçš„åˆå§‹å€¼æ˜¯LogicalSort, ç„¶åé€šè¿‡inputæŒ‡é’ˆ, ä¸æ–­åœ°åµŒå¥—. å’Œä¸‹å›¾çš„inputåµŒå¥—ä¸€ä¸€å¯¹åº”.<br><code>LogicalSort &gt; LogicalAggregate &gt; LogicalProject &gt; EnumerableTableScan</code>  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-RelNode.png" alt=""></p>
<blockquote>
<p>ä»ä¸Šé¢å‡ ä¸ªå¯¹è±¡åé¢@ä»£è¡¨çš„æ•°å­—å¯ä»¥çœ‹å‡º, è¿™å‡ ä¸ªå¯¹è±¡, ä¾æ¬¡åˆ›å»ºçš„æ—¶é—´è¶Šæ¥è¶Šæ™š.  </p>
</blockquote>
<h3 id="â‘¡DrillRel_drel">â‘¡DrillRel drel</h3><p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-DrillRel.png" alt=""></p>
<p>CalCiteçš„RelNodeè½¬æ¢ä¸ºDrillçš„DrillRel, drelçš„å€¼æ˜¯DrillScreenRel. å®ƒçš„inputä¹Ÿæ˜¯åµŒå¥—çš„:<br><code>DrillScreenRel &gt; DrillSortRel &gt; DrillAggregateRel &gt; DrillScanRel</code>  </p>
<p>è™½ç„¶DrillRel drelçš„å€¼æ˜¯DrillScreenRel, ä»¥åŠæ¥ä¸‹æ¥çš„DrillRel, å®ƒä»¬éƒ½ä»£è¡¨çš„æ˜¯é€»è¾‘è®¡åˆ’çš„è¡¨è¾¾å¼æ ‘.  </p>
<h3 id="â‘¢Prel">â‘¢Prel</h3><p>ç‰©ç†è®¡åˆ’çš„inputåµŒå¥—: <code>ScreenPrel &gt;&gt; ProjectPrel &gt;&gt; SelectionVectorRemoverPrel &gt; SortPrel &gt; HashAggPrel &gt; ScanPrel</code><br>å¯ä»¥çœ‹åˆ°ç‰©ç†è®¡åˆ’ä¼šæ¯”é€»è¾‘è®¡åˆ’å¤šä¸€äº›èŠ‚ç‚¹, å¹¶ä¸”ä¸Šé¢çš„åµŒå¥—å’ŒWEBUIä¸Šçš„ç‰©ç†è®¡åˆ’å’Œå›¾æ˜¯èƒ½å¤Ÿå¯¹åº”ä¸Šæ¥çš„.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-Prel.png" alt=""></p>
<h3 id="PhysicalOperator_pop">PhysicalOperator pop</h3><p>popä¸å†æ˜¯inputåµŒå¥—, è€Œæ˜¯childåµŒå¥—äº†, å› ä¸ºpopä»planè¿‡æ¥,æ‰€ä»¥å®ƒå’ŒPrelç±»ä¼¼  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-pop.png" alt=""></p>
<h3 id="â‘£PhysicalPlan_plan">â‘£PhysicalPlan plan</h3><p>æœ€åçš„ç‰©ç†è®¡åˆ’æ˜¯ä¸€å¼ DAGå›¾, å³Drill Plan(æ³¨æ„å’ŒDrill PhysicalPlanä¸ä¸€æ ·). </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-plan.png" alt=""></p>
<p>å›¾ä¸­æ ¹èŠ‚ç‚¹rootså’Œå¶å­èŠ‚ç‚¹leaves. è¿™é‡Œçš„æ ¹æ˜¯Screen, å³DAGå›¾çš„æœ€ä¸Šé¢ä¸€ä¸ªå±å¹•è¾“å‡ºèŠ‚ç‚¹, å¶å­åªæœ‰ä¸€ä¸ª, å³DAGå›¾çš„æœ€åº•ä¸‹æ‰«æèŠ‚ç‚¹.  </p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">RelNode rel = convertToRel<span class="list">(<span class="keyword">validated</span>)</span><span class="comment">;</span></span><br><span class="line">rel = preprocessNode<span class="list">(<span class="keyword">rel</span>)</span><span class="comment">;</span></span><br><span class="line">log<span class="list">(<span class="string">"Optiq Logical"</span>, rel)</span><span class="comment">;					â†’ â‘ </span></span><br><span class="line"></span><br><span class="line">DrillRel drel = convertToDrel<span class="list">(<span class="keyword">rel</span>, validatedRowType)</span><span class="comment">;</span></span><br><span class="line">log<span class="list">(<span class="string">"Drill Logical"</span>, drel)</span><span class="comment">;					â†’ â‘¡</span></span><br><span class="line"></span><br><span class="line">Prel prel = convertToPrel<span class="list">(<span class="keyword">drel</span>)</span><span class="comment">;			â†’ â‘¢</span></span><br><span class="line">log<span class="list">(<span class="string">"Drill Physical"</span>, prel)</span><span class="comment">;				</span></span><br><span class="line"></span><br><span class="line">PhysicalOperator pop = convertToPop<span class="list">(<span class="keyword">prel</span>)</span><span class="comment">;</span></span><br><span class="line">PhysicalPlan plan = convertToPlan<span class="list">(<span class="keyword">pop</span>)</span><span class="comment">;    	â†’ â‘£</span></span><br><span class="line">log<span class="list">(<span class="string">"Drill Plan"</span>, plan)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>å…¶å®WebUIä¸Šçš„å¯è§†åŒ–Planå›¾å°±æ˜¯è¿™é‡Œçš„graphå¯¹è±¡.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill23.png" alt=""></p>
<h2 id="ä»DrillScreenRelå…¥æ‰‹">ä»DrillScreenRelå…¥æ‰‹</h2><p>åœ¨ new DrillScreenRelæ·»åŠ å‰åæ‰“ä¸Šæ–­ç‚¹, éªŒè¯æ·»åŠ ScreenèŠ‚ç‚¹çš„å˜åŒ–:   </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-noscreen.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨è¿˜æ²¡æœ‰æ·»åŠ Screenæ—¶, convertedRelNodeå’ŒtopPreservedNameProjä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸€æ ·çš„, å› ä¸ºå®ƒä»¬çš„å¯¹è±¡ç¼–å·éƒ½æ˜¯: DrillSortRel@7614<br>æ·»åŠ Screenå, å³DrillRel dreå˜æˆäº†DrillScreenRel@7665, è€Œå…¶inputåŸŸä»ç„¶æ˜¯DrillSortRel@7614. è¯´æ˜ç¡®å®å°è£…äº†ä¸Šé¢çš„èŠ‚ç‚¹å¯¹è±¡.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-screen.png" alt=""></p>
<p>DrillRel drelæ˜¯é€»è¾‘è®¡åˆ’, å¯ä»¥é€šè¿‡explain plan withou implementation for <query>å¾—åˆ°æŸ¥è¯¢çš„é€»è¾‘è®¡åˆ’(å’Œä¸Šå›¾æ˜¯å¯¹åº”çš„): </query></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">+------+------+</span><br><span class="line">| <span class="atom">text</span> | <span class="atom">json</span> |</span><br><span class="line">+------+------+</span><br><span class="line">| <span class="name">DrillScreenRel</span></span><br><span class="line">  <span class="name">DrillSortRel</span>(<span class="atom">sort0</span>=[$<span class="number">1</span>], <span class="atom">dir0</span>=[<span class="name">DESC</span>])</span><br><span class="line">    <span class="name">DrillAggregateRel</span>(<span class="atom">group</span>=[&#123;<span class="number">0</span>&#125;], <span class="atom">cnt</span>=[<span class="name">COUNT</span>()])</span><br><span class="line">      <span class="name">DrillScanRel</span>(<span class="atom">table</span>=[[<span class="atom">cp</span>, <span class="atom">employee</span>.<span class="atom">json</span>]], <span class="atom">groupscan</span>=[<span class="name">EasyGroupScan</span> [<span class="atom">selectionRoot</span>=<span class="atom">classpath</span>:/<span class="atom">employee</span>.<span class="atom">json</span>, <span class="atom">numFiles</span>=<span class="number">1</span>, <span class="atom">columns</span>=[<span class="string">`department_id`</span>], <span class="atom">files</span>=[<span class="atom">classpath</span>:/<span class="atom">employee</span>.<span class="atom">json</span>]]])</span><br><span class="line"></span><br><span class="line">  <span class="string">"query"</span> : [ &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"scan"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"storageengine"</span> : <span class="string">"cp"</span>,</span><br><span class="line">    <span class="string">"selection"</span> : &#123;</span><br><span class="line">      <span class="string">"format"</span> : &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"named"</span>,</span><br><span class="line">        <span class="string">"name"</span> : <span class="string">"json"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"files"</span> : [ <span class="string">"classpath:/employee.json"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"groupingaggregate"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"input"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"keys"</span> : [ &#123;</span><br><span class="line">      <span class="string">"ref"</span> : <span class="string">"`department_id`"</span>,</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"`department_id`"</span></span><br><span class="line">    &#125; ],</span><br><span class="line">    <span class="string">"exprs"</span> : [ &#123;</span><br><span class="line">      <span class="string">"ref"</span> : <span class="string">"`cnt`"</span>,</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"count(1) "</span></span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"order"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="string">"input"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"within"</span> : <span class="atom">null</span>,</span><br><span class="line">    <span class="string">"orderings"</span> : [ &#123;</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"`cnt`"</span>,</span><br><span class="line">      <span class="string">"order"</span> : <span class="string">"DESC"</span>,</span><br><span class="line">      <span class="string">"nullDirection"</span> : <span class="string">"UNSPECIFIED"</span></span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"op"</span> : <span class="string">"store"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">4</span>,</span><br><span class="line">    <span class="string">"input"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="string">"target"</span> : <span class="atom">null</span>,</span><br><span class="line">    <span class="string">"storageEngine"</span> : <span class="string">"--SCREEN--"</span></span><br><span class="line">  &#125; ]</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æˆ‘ä»¬debugå‡ºæ¥RelNode relæ˜¯LogicalSort, å…¶inputåµŒå¥—ä¾æ¬¡æ˜¯: LogicalAggregate &gt; LogicalProject &gt; EnumerableTableScan<br>ç»è¿‡logicalPlanningVolcano()å¤„ç†, ä¼šå°†CalCiteçš„LogicalSortæ“ä½œç¬¦èŠ‚ç‚¹è½¬æ¢ä¸ºDrillè®¤è¯†çš„DrillSortRelèŠ‚ç‚¹.<br>è€Œä¸”topPreservedNameProj=DrillSortRel@7614, æ‰€ä»¥åˆ›å»ºDrillScreenRelæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆçœ‹:  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> new DrillScreenRel(<span class="keyword">cluster</span>, trait, DrillSortRel@7614)</span><br><span class="line"></span><br><span class="line">public DrillScreenRel(RelOptCluster <span class="keyword">cluster</span>, RelTraitSet traitSet, RelNode <span class="keyword">input</span>) &#123;</span><br><span class="line">  super(DRILL_LOGICAL, <span class="keyword">cluster</span>, traitSet, <span class="keyword">input</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºDrillScreenRelæ„é€ å‡½æ•°è€Œè¨€, è¾“å…¥RelNode input=DrillSortRelå¯¹è±¡. å…¶å®ä»æˆ‘ä»¬debugå‡ºæ¥çš„å˜é‡ä¹Ÿæ˜¯è¿™ä¹ˆä¸€å›äº‹çš„.<br>å³DrillScreenRelçš„inputæ˜¯DrillSortRel, DrillSortRelçš„inputæ˜¯DrillAggregateRel, DrillAggregateRelçš„inputæ˜¯DrillScanRel.<br><code>DrillScreenRel[4] &gt; DrillSortRel[1] &gt; DrillAggregateRel[2] &gt; DrillScanRel[3]</code>  åºå·è¡¨ç¤ºåˆ›å»ºæ—¶é—´é¡ºåº.  </p>
<p>è¿™é‡Œåªæ˜¯åˆ›å»ºå¯¹è±¡, ç”±äºDrillXXXReléƒ½å®ç°äº†DrillRel, è€ŒDrillRelå®šä¹‰äº†implementæ¥å£æ–¹æ³•, æˆ‘ä»¬æ‰¾åˆ°äº†DrillImplementor.<br>æ¯”è¾ƒé‡è¦çš„æ˜¯å…¥å£æ–¹æ³•æ˜¯go, å®ƒç”±ExplainHandler, åªæœ‰åœ¨é€»è¾‘è®¡åˆ’çš„æ—¶å€™æ‰ä¼šè°ƒç”¨åˆ°(æ‰€ä»¥åœ¨debugæ—¶è¦ç”¨é€»è¾‘è®¡åˆ’SQLè¯­å¥æ‰èƒ½è¿›å…¥DrillImplementor).  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-go.png" alt=""></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">LogicalExplain</span>&#123;</span><br><span class="line">  <span class="keyword">public</span> String text;</span><br><span class="line">  <span class="keyword">public</span> String json;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LogicalExplain</span>(<span class="params">RelNode node, SqlExplainLevel level, QueryContext context</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.text = RelOptUtil.toString(node, level);</span><br><span class="line">    DrillImplementor implementor = <span class="keyword">new</span> DrillImplementor(<span class="keyword">new</span> DrillParseContext(context.getPlannerSettings()), ResultMode.LOGICAL);</span><br><span class="line">    implementor.go( (DrillRel) node);</span><br><span class="line">    LogicalPlan plan = implementor.getPlan();</span><br><span class="line">    <span class="keyword">this</span>.json = plan.unparse(context.getConfig());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span>(<span class="params">DrillRel root</span>) </span>&#123;</span><br><span class="line">  LogicalOperator rootLOP = root.implement(<span class="keyword">this</span>);</span><br><span class="line">  System.<span class="keyword">out</span>.println(<span class="string">"ROOTLOP:"</span> + rootLOP);</span><br><span class="line">  rootLOP.accept(<span class="keyword">new</span> AddOpsVisitor(), <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°rootæ˜¯é€»è¾‘è®¡åˆ’èŠ‚ç‚¹=DrillScreenRel, è°ƒç”¨implementåè¿”å›çš„æ˜¯é€»è¾‘æ“ä½œç¬¦. é‚£ä¹ˆè¿™ä¸ªrootLOPæ˜¯ä»€ä¹ˆä¸œä¸œ?  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-rootLOP.png" alt=""></p>
<p>è°ƒç”¨rootçš„implement, thisä¸ºDrillImplementor. çœ‹ä¸‹DrillScreenRelçš„implementå®ç°:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DrillScreenRel:</span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogicalOperator <span class="title">implement</span><span class="params">(DrillImplementor implementor)</span> </span>&#123;</span><br><span class="line">    LogicalOperator childOp = implementor.visitChild(<span class="keyword">this</span>, <span class="number">0</span>, getInput());</span><br><span class="line">    <span class="keyword">return</span> Store.builder().setInput(childOp).storageEngine(<span class="string">"--SCREEN--"</span>).build();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­getInput()å°±æ˜¯åˆ›å»ºDrillScreenRelæ—¶çš„æœ€åä¸€ä¸ªå‚æ•°input, é‚£ä¹ˆè¿™é‡Œå°±æ˜¯DrillSortRel.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DrillImplementor:</span><br><span class="line">  <span class="keyword">public</span> LogicalOperator visitChild(DrillRel parent, <span class="keyword">int</span> ordinal, RelNode child) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((DrillRel) child).implement(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>childå°±æ˜¯DrillScreenRelçš„getInput()å³DrillSortRel. ç„¶åè°ƒç”¨DrillSortRelçš„implement. ä»¥æ­¤ç±»æ¨, æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹. </p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">DrillImplementor</span><span class="string">.</span><span class="comment">go</span></span><br><span class="line">   <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">root</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillScreenRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                           <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="string">,</span><span class="comment">DrillSortRel)</span></span><br><span class="line">                                  <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillSortRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="string">,</span><span class="comment">DrillAggregateRel)</span></span><br><span class="line">                                                                   <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillAggregateRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="string">,</span><span class="comment">DrillScanRel)</span></span><br><span class="line">                                                                                                  <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">child</span><span class="string">.</span><span class="comment">implement</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">DrillScanRel</span><span class="string">.</span><span class="comment">implement</span></span><br><span class="line">                                                                                                                         <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">ä¸å†visitChildäº†</span><span class="string">,</span><span class="comment">å› ä¸ºScanæ˜¯å¶å­èŠ‚ç‚¹</span><span class="string">,</span><span class="comment">NO</span><span class="literal">-</span><span class="comment">MORE</span><span class="literal">-</span><span class="comment">CHILD</span></span><br><span class="line">                                                                                                                         <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">implementor</span><span class="string">.</span><span class="comment">registerSource(table)</span></span><br><span class="line">                                                                                                                         <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">è¿”å›Scan</span> <span class="comment">LogicalOperator</span></span><br><span class="line">                                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">GroupingAggregate</span><span class="string">.</span><span class="comment">setInput(implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="comment">))=GroupingAggregate</span><span class="string">.</span><span class="comment">setInput(Scan)</span> </span><br><span class="line">                                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">è¿”å›GroupingAggregate</span> <span class="comment">LogicalOperator</span> </span><br><span class="line">                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">Order</span><span class="string">.</span><span class="comment">setInput(implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="comment">))=Order</span><span class="string">.</span><span class="comment">setInput(GroupingAggregate)</span></span><br><span class="line">                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">è¿”å›Order</span> <span class="comment">LogicalOperator</span> </span><br><span class="line">                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">Store</span><span class="string">.</span><span class="comment">setInput(implementor</span><span class="string">.</span><span class="comment">visitChild(</span><span class="string">.</span><span class="string">.</span><span class="comment">))=Store</span><span class="string">.</span><span class="comment">setInput(Order)</span> <span class="title">[</span><span class="comment">â‘ </span><span class="title">]</span></span><br><span class="line">    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">rootLOP</span><span class="string">.</span><span class="comment">accept</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">Store</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">    <span class="comment">						|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(Store)</span></span><br><span class="line">                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">o</span> <span class="comment">:</span> <span class="comment">Store</span><span class="string">.</span><span class="comment">getInput=Order</span></span><br><span class="line">                                <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">o</span> <span class="comment">:</span> <span class="comment">=</span> <span class="comment">Order</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">                                              <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(Order)</span></span><br><span class="line">                                              <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">o</span> <span class="comment">:</span> <span class="comment">Order</span><span class="string">.</span><span class="comment">getInput=GroupingAggregate</span> </span><br><span class="line">                                                  <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">o</span> <span class="comment">:</span> <span class="comment">GroupingAggregate</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">                                                             <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(GroupingAggregate)</span></span><br><span class="line">                                                             <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">for</span> <span class="comment">o</span> <span class="comment">:</span> <span class="comment">GroupingAggregate</span><span class="string">.</span><span class="comment">getInput=Scan</span></span><br><span class="line">                                                                 <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">o</span> <span class="comment">:</span> <span class="comment">Scan</span><span class="string">.</span><span class="comment">accept</span></span><br><span class="line">                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">planBuilder</span><span class="string">.</span><span class="comment">addLogicalOperator(Scan)</span></span><br><span class="line">                                                                            <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">Scan</span> <span class="comment">has</span> <span class="comment">not</span> <span class="comment">inputs</span><span class="string">.</span> <span class="comment">END</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">	|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">END</span> <span class="comment">OF</span> <span class="comment">GO</span></span><br></pre></td></tr></table></figure>
<p>DONE with planBuilder which is builder of logical plan.<br>è°ƒç”¨å®ŒDrillImplementor.go, å°±æŠŠplanBuilderæ„é€ å®Œæ¯•, æ¥ç€è°ƒç”¨getPlanå°±å¯ä»¥è·å¾—planBuilderçš„è¾“å‡ºäº†.  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-13-drill-phyplan" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-13-drill-phyplan/" class="article-date">
  	<time datetime="2015-12-01T10:22:26.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-13-drill-phyplan/">Apache Drillæºç é˜…è¯»(3) ç‰©ç†è®¡åˆ’</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>DrillBitå„ä¸ªè§’è‰²:<br>UserServerå¤„ç†RUN_QUERY_VALUEå®¢æˆ·ç«¯çš„æŸ¥è¯¢è¯·æ±‚,ä¼šå°†ä»»åŠ¡åˆ†æ´¾ç»™UserWorkerå¤„ç†, ç”±workeræäº¤å·¥ä½œ:<br>æ˜¾ç„¶workerè¦åœ¨æ„é€ UserServerçš„æ—¶å€™ä¹Ÿä¸€èµ·æ„é€ å‡ºæ¥, è¿™æ ·åœ¨æ”¶åˆ°ä»»åŠ¡çš„æ—¶å€™, ç¡®ä¿ç«‹å³æœ‰å·¥äººæ¥æ‰‹è¿™ä»½å·¥ä½œ.<br>UserServerçš„æ„é€ åœ¨ServiceEngine,è€ŒæœåŠ¡å¼•æ“æ˜¯ç”±DrillBitåˆ›å»ºçš„.<br>UserWorkeræ˜¯ç”±WorkerManagerç®¡ç†çš„, è€ŒWorkerManagerä¹Ÿæ˜¯ç”±DrillBitåˆ›å»ºçš„.<br>æ‰€ä»¥å¯åŠ¨DrillBitæœåŠ¡å,å‚ä¸è®¡ç®—çš„è§’è‰²éƒ½å·²ç»å‡†å¤‡å¥½äº†.  </p>
<table>
<thead>
<tr>
<th>Role</th>
<th>Explain</th>
</tr>
</thead>
<tbody>
<tr>
<td>WorkerBee</td>
<td>å·¥èœ‚, çœŸæ­£å¹²æ´»çš„</td>
</tr>
<tr>
<td>UserWorker</td>
<td>ç”¨æˆ·æ“ä½œçš„(å·¥äºº), é€šè¿‡WorkerBeeæ„æˆ</td>
</tr>
<tr>
<td>WorkerManager</td>
<td>å·¥äººç®¡ç†å‘˜,è´Ÿè´£é€‰æ‹©ä¸€ä¸ªå·¥äººæ¥å·¥ä½œ</td>
</tr>
<tr>
<td>UserServer</td>
<td>ç”¨æˆ·æ“ä½œçš„æœåŠ¡ç«¯,ä¼šå°†å·¥ä½œäº¤ç»™UserWorker,å®ƒéœ€è¦ä¸€ä¸ªUserWorker</td>
</tr>
<tr>
<td>Foreman</td>
<td>åŒ…å·¥å¤´,ç›‘å·¥.ç”±UserWorkeråˆ›å»ºå‡ºæ¥. å› ä¸ºUserWorkeråº•å±‚æ˜¯WorkerBee,æ‰€ä»¥ä¼šå°†WorkerBeeå’ŒForemanå…³è”èµ·æ¥</td>
</tr>
<tr>
<td>ServiceEngine</td>
<td>æœåŠ¡å¼•æ“,ç®¡ç†UserServer,Controller</td>
</tr>
<tr>
<td>DrillBit</td>
<td>Drillçš„æœåŠ¡ç«¯æ§åˆ¶è¿›ç¨‹,ç®¡ç†ServiceEngine,WorkerManager</td>
</tr>
<tr>
<td>BootStrapContext</td>
<td>å¯åŠ¨DrillBitçš„ä¸Šä¸‹æ–‡,åŒ…æ‹¬é…ç½®ä¿¡æ¯,åº¦é‡æ³¨å†Œ</td>
</tr>
<tr>
<td>DrillbitContext</td>
<td>DrillBitå·¥ä½œæ—¶å€™çš„ä¸Šä¸‹æ–‡</td>
</tr>
<tr>
<td>Controller</td>
<td>ä¸åŒDrillBitèŠ‚ç‚¹çš„é€šä¿¡</td>
</tr>
<tr>
<td>ControllServer</td>
<td>ä¸åŒèŠ‚ç‚¹é—´æ¶ˆæ¯ä¼ è¾“,è¿æ¥ç­‰çš„RPCæœåŠ¡ç«¯</td>
</tr>
<tr>
<td>DataServer</td>
<td>è´Ÿè´£æ•°æ®äº¤äº’çš„RPCæœåŠ¡ç«¯</td>
</tr>
</tbody>
</table>
<h2 id="å·¥äººå’Œç›‘å·¥çš„é‚£äº›äº‹">å·¥äººå’Œç›‘å·¥çš„é‚£äº›äº‹</h2><p>é¦–å…ˆçœ‹ä¸‹UserWorkeræ˜¯æ€ä¹ˆæäº¤ä¸€ä¸ªä»»åŠ¡çš„:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> UserWorker&#123;</span><br><span class="line">  <span class="keyword">private</span> final WorkerBee bee;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> QueryId <span class="title">submitWork</span><span class="params">(UserClientConnection connection, RunQuery query)</span> </span>&#123;</span><br><span class="line">    ThreadLocalRandom r = ThreadLocalRandom.current();</span><br><span class="line">    <span class="comment">// create a new queryid where the first four bytes are a growing time (each new value comes earlier in sequence).  Last 12 bytes are random.</span></span><br><span class="line">    <span class="keyword">long</span> time = (<span class="keyword">int</span>) (System.currentTimeMillis()/<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">long</span> p1 = ((Integer.MAX_VALUE - time) &lt;&lt; <span class="number">32</span>) + r.nextInt();</span><br><span class="line">    <span class="keyword">long</span> p2 = r.nextLong();</span><br><span class="line">    QueryId id = QueryId.newBuilder().setPart1(p1).setPart2(p2).build();</span><br><span class="line">    incrementer.increment(connection.getSession());</span><br><span class="line">    Foreman foreman = <span class="keyword">new</span> Foreman(bee, bee.getContext(), connection, id, query);</span><br><span class="line">    bee.addNewForeman(foreman);</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿”å›çš„QueryIdä¼šç”±UserServeré€šè¿‡RPCå‘é€ç»™å®¢æˆ·ç«¯, è¡¨ç¤ºå®¢æˆ·ç«¯è¿™ä¸€æ¬¡çš„æŸ¥è¯¢æ ‡è¯†. æœåŠ¡ç«¯å·²ç»æ¥å—äº†è¿™æ¬¡æŸ¥è¯¢.<br>ä½†æ˜¯æœåŠ¡ç«¯è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢ä»»åŠ¡, åç»­å¦‚æœå®¢æˆ·ç«¯éœ€è¦æŸ¥è¯¢ç»“æœ, å¯ä»¥å‡­è¿™ä¸ªQueryId, å°±å¯ä»¥å‘æœåŠ¡ç«¯è¦æ•°æ®ç»“æœ.  </p>
<p>WorkerBeeä»åå­—ä¸Šçœ‹æ˜¯å·¥ä½œçš„èœœèœ‚, å·¥èœ‚ä¸€ç›´é»˜é»˜æ— é—»åœ°å·¥ä½œ. å®ƒä¸ºæ¯èœ‚ForemanæœåŠ¡.<br>ç°åœ¨æˆ‘ä»¬ç”±UserWorkeråˆ›å»ºäº†ä¸€ä¸ªForeman. å·¥èœ‚æŠŠå®ƒåŠ è¿›æ¥.    </p>
<blockquote>
<p>é—®é¢˜:<br>1.ä¸ºä»€ä¹ˆä¸æ˜¯ç”±Foremanç®¡ç†WorkerBee,è€Œæ˜¯è®©WorkerBee(å·¥èœ‚)ä¸»åŠ¨æŠŠForeman(ç›‘å·¥)åŠ è¿›æ¥?<br>2.ä¸ºä»€ä¹ˆForemanä½œä¸ºä¸€ä¸ªè¿›ç¨‹,ä¸æ˜¯è‡ªå·±å¯åŠ¨,è€Œæ˜¯è¦ç”±å·¥äººæ¥å¯åŠ¨?  </p>
</blockquote>
<p>Foremanè´Ÿè´£ç®¡ç†ä¸€æ¬¡æŸ¥è¯¢çš„æ‰€æœ‰fragments, Foremanä¼šä½œä¸ºæ ¹èŠ‚ç‚¹/é©±åŠ¨èŠ‚ç‚¹  </p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Foreman manages all the fragments (local and remote) for a single query where this is the driving/root node.</span><br><span class="line"> * The flow is as follows:</span><br><span class="line"> * - Foreman is submitted as a runnable.  è¢«æäº¤ä¸ºå¯æ‰§è¡Œçš„</span><br><span class="line"> * - Runnable does query planning. åšä»€ä¹ˆ: æŸ¥è¯¢è®¡åˆ’</span><br><span class="line"> * - state changes from PENDING to RUNNING çŠ¶æ€æ”¹å˜</span><br><span class="line"> * - Runnable sends out starting fragments å‘å°„èµ·å§‹fragments</span><br><span class="line"> * - Status listener are activated ç›‘å¬å™¨è¢«æ¿€æ´»</span><br><span class="line"> * - The Runnable's run() completes, but the Foreman stays around çº¿ç¨‹çš„runæ–¹æ³•ç»“æŸ,è€ŒForemanè¿˜åœç•™...åšä»€ä¹ˆ, çœ‹ä¸‹é¢çš„</span><br><span class="line"> * - Foreman listens for state change messages. ç›‘å¬çŠ¶æ€æ”¹å˜çš„æ¶ˆæ¯</span><br><span class="line"> * - state change messages can drive the state to FAILED or CANCELED, in which case çŠ¶æ€æ¶ˆæ¯ä¼šé©±åŠ¨/æ›´æ–°Foremançš„çŠ¶æ€</span><br><span class="line"> *   messages are sent to running fragments to terminate æ¶ˆæ¯ä¼šä½¿å¾—æ­£åœ¨è¿è¡Œçš„fragmentsç»ˆç»“</span><br><span class="line"> * - when all fragments complete, state change messages drive the state to COMPLETED å½“æ‰€æœ‰çš„fragmentså®Œæˆå, çŠ¶æ€æ”¹å˜çš„æ¶ˆæ¯æ›´æ–°Formemançš„çŠ¶æ€ä¸ºå·²å®Œæˆ</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foreman</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> QueryId queryId; <span class="comment">//the id for the query</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> RunQuery queryRequest; <span class="comment">//the query to execute</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> QueryContext queryContext;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> QueryManager queryManager; <span class="comment">// handles lower-level details of query execution</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> WorkerBee bee; <span class="comment">// provides an interface to submit tasks, used to submit additional work</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DrillbitContext drillbitContext;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> UserClientConnection initiatingClient; <span class="comment">// used to send responses</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sets up the Foreman, but does not initiate any execution. è®¾ç½®Foreman, ä½†æ˜¯å¹¶æ²¡æœ‰åˆå§‹åŒ–ä»»ä½•çš„æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">public</span> Foreman(<span class="keyword">final</span> WorkerBee bee, <span class="keyword">final</span> DrillbitContext drillbitContext, <span class="keyword">final</span> UserClientConnection connection, <span class="keyword">final</span> QueryId queryId, <span class="keyword">final</span> RunQuery queryRequest) &#123;</span><br><span class="line">    <span class="keyword">this</span>.bee = bee;</span><br><span class="line">    <span class="keyword">this</span>.queryId = queryId;</span><br><span class="line">    <span class="keyword">this</span>.queryRequest = queryRequest;</span><br><span class="line">    <span class="keyword">this</span>.drillbitContext = drillbitContext;</span><br><span class="line">    <span class="keyword">this</span>.initiatingClient = connection;</span><br><span class="line">    <span class="keyword">this</span>.closeFuture = initiatingClient.getChannel().closeFuture();</span><br><span class="line">    closeFuture.addListener(closeListener);</span><br><span class="line">    queryContext = <span class="keyword">new</span> QueryContext(connection.getSession(), drillbitContext);</span><br><span class="line">    queryManager = <span class="keyword">new</span> QueryManager(queryId, queryRequest, drillbitContext.getPersistentStoreProvider(), stateListener, <span class="keyword">this</span>);</span><br><span class="line">    recordNewState(QueryState.PENDING);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Foremançš„runæ–¹æ³•æ ¹æ®RunQueryçš„ç±»å‹æ‰§è¡Œä¸åŒçš„æ–¹æ³•,æ¯”å¦‚SQLç±»å‹,åˆ™è¦è´Ÿè´£å°†SQLè¯­å¥é€šè¿‡Calciteè§£ææˆé€»è¾‘è®¡åˆ’,ç”Ÿæˆç‰©ç†è®¡åˆ’,æœ€åè¿è¡Œç‰©ç†è®¡åˆ’.  </p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> runSQL(<span class="keyword">final</span> <span class="keyword">String</span> sql) <span class="keyword">throws</span> ExecutionSetupException &#123;</span><br><span class="line">  <span class="keyword">final</span> DrillSqlWorker sqlWorker = <span class="keyword">new</span> DrillSqlWorker(queryContext);</span><br><span class="line">  <span class="keyword">final</span> Pointer&lt;<span class="keyword">String</span>&gt; textPlan = <span class="keyword">new</span> Pointer&lt;&gt;();</span><br><span class="line">  <span class="keyword">final</span> PhysicalPlan plan = sqlWorker.getPlan(sql, textPlan);</span><br><span class="line">  queryManager.setPlanText(textPlan.value);</span><br><span class="line">  runPhysicalPlan(plan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="SQL_Parser">SQL Parser</h2><p>Calciteçš„plannerå¯¹SQLè¿›è¡Œparseè§£æ, ç”ŸæˆSqlNodeèŠ‚ç‚¹,  å¯¹äºä¸åŒçš„SqlNodeç±»å‹, ç”±ä¸åŒçš„Handlerè¿›è¡Œè¿›è¡Œè§£æ.   </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrillSqlWorker</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Planner planner;  <span class="comment">//è¿™ä¸¤ä¸ªPlanneréƒ½æ˜¯Calciteçš„,è´Ÿè´£è§£ææˆé€»è¾‘è®¡åˆ’</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HepPlanner hepPlanner;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> QueryContext context;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function">PhysicalPlan <span class="title">getPlan</span><span class="params">(String sql, Pointer&lt;String&gt; textPlan)</span> <span class="keyword">throws</span> ForemanSetupException </span>&#123;</span><br><span class="line">    SqlNode sqlNode = planner.parse(sql);  <span class="comment">//å°†SQLè¯­å¥è§£ææˆSqlNodeè§£ææ ‘â‘ </span></span><br><span class="line">    AbstractSqlHandler <span class="keyword">handler</span>;</span><br><span class="line">    SqlHandlerConfig config = <span class="keyword">new</span> SqlHandlerConfig(hepPlanner, planner, context);</span><br><span class="line">    <span class="keyword">switch</span>(sqlNode.getKind())&#123;</span><br><span class="line">    <span class="keyword">case</span> EXPLAIN:</span><br><span class="line">      <span class="keyword">handler</span> = <span class="keyword">new</span> ExplainHandler(config);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SET_OPTION:</span><br><span class="line">      <span class="keyword">handler</span> = <span class="keyword">new</span> SetOptionHandler(context);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OTHER:</span><br><span class="line">      <span class="keyword">if</span>(sqlNode <span class="keyword">instanceof</span> SqlCreateTable) &#123;</span><br><span class="line">        <span class="keyword">handler</span> = ((DrillSqlCall)sqlNode).getSqlHandler(config, textPlan);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (sqlNode <span class="keyword">instanceof</span> DrillSqlCall) &#123;</span><br><span class="line">        <span class="keyword">handler</span> = ((DrillSqlCall)sqlNode).getSqlHandler(config);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">handler</span> = <span class="keyword">new</span> DefaultSqlHandler(config, textPlan);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="keyword">handler</span>.<span class="title">getPlan</span><span class="params">(sqlNode)</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The Drillbit that receives the query from a client or application becomes the Foreman for the query and drives the entire query.<br>A parser in the Foreman parses the SQL[â‘ ], applying custom rules[â‘¡] to convert specific SQL operators into a specific logical operator syntax that Drill understands.<br>This collection of logical operators forms a logical plan. The logical plan describes the work required to generate the query results and defines what data sources and operations to apply.  </p>
<p>Foremanä¸­çš„parserè§£æSQL, å¹¶è¿ç”¨å®šåˆ¶çš„è§„åˆ™, å°†SQLæ“ä½œç¬¦(Calciteçš„èŠ‚ç‚¹)è½¬æ¢æˆDrillè®¤è¯†çš„é€»è¾‘æ“ä½œç¬¦(Drillçš„èŠ‚ç‚¹DrillRel).<br>è½¬æ¢åçš„é€»è¾‘æ“ä½œç¬¦é›†åˆä¼šç»„æˆä¸€ä¸ªé€»è¾‘è®¡åˆ’.  æ³¨æ„ä¸Šé¢çš„sqlNode=planner.parse(sql)å¯¹åº”çš„æ˜¯SQLæ“ä½œç¬¦, è½¬æ¢æˆDrillRelNodeåœ¨Handlerçš„getPlanä¸­å®Œæˆ.  </p>
</blockquote>
<h2 id="SqlNode(Calcite_SQLæ“ä½œç¬¦)">SqlNode(Calcite SQLæ“ä½œç¬¦)</h2><p>Calciteçš„ç¼–ç¨‹APIä¸»è¦åŒ…æ‹¬äº†: Operator, Rule, RelationExpression, SqlNode.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/calcite1.png" alt=""></p>
<h3 id="Whatâ€™s_Rule?">Whatâ€™s Rule?</h3><p>Calciteçš„plannerå¯¹SQLè¿›è¡Œparseè§£æ, é™¤äº†ç”¨åˆ°Calciteè‡ªèº«çš„ä¸€äº›è§„åˆ™å¤–, Drillä¹Ÿä¼šé™„åŠ ä¸€äº›è§„åˆ™getRulesç»™å®ƒ. å®šä¹‰åœ¨DrillSqlWorkerçš„æ„é€ å‡½æ•°ä¸­.<br>è§„åˆ™åŒ…æ‹¬ç‰©ç†è®¡åˆ’, é€»è¾‘è®¡åˆ’, è½¬æ¢è§„åˆ™.  å…¶ä¸­é€»è¾‘è®¡åˆ’åŒ…æ‹¬åŸºæœ¬è§„åˆ™,ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™. ç‰©ç†è®¡åˆ’åŒ…æ‹¬ç‰©ç†è§„åˆ™,å­˜å‚¨æ’ä»¶çš„è§„åˆ™. æ¯”å¦‚hiveæ’ä»¶æœ‰è‡ªå·±çš„SQLæ‰§è¡Œè½¬æ¢è§„åˆ™.  </p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="component">public DrillSqlWorker(QueryContext context) &#123;</span><br><span class="line">  FrameworkConfig config = Frameworks<span class="string">.newConfigBuilder()</span> ...</span><br><span class="line">      <span class="string">.ruleSets(getRules(context))...</span>  //Drillé™„åŠ çš„è§„åˆ™â‘¡</span><br><span class="line">      <span class="string">.build()</span>;</span><br><span class="line">  this<span class="string">.planner</span> = Frameworks<span class="string">.getPlanner(config)</span>;    </span><br><span class="line">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="component">private RuleSet[] getRules(QueryContext context) &#123;</span><br><span class="line">  StoragePluginRegistry storagePluginRegistry = context<span class="string">.getStorage()</span>;</span><br><span class="line">  RuleSet drillLogicalRules = DrillRuleSets<span class="string">.mergedRuleSets(DrillRuleSets.getDrillBasicRules(context)</span>, DrillRuleSets<span class="string">.getJoinPermRules(context)</span>, DrillRuleSets<span class="string">.getDrillUserConfigurableLogicalRules(context))</span>;</span><br><span class="line">  RuleSet drillPhysicalMem = DrillRuleSets<span class="string">.mergedRuleSets(DrillRuleSets.getPhysicalRules(context)</span>, storagePluginRegistry<span class="string">.getStoragePluginRuleSet())</span>;</span><br><span class="line">  // Following is used in LOPT join OPT.</span><br><span class="line">  RuleSet logicalConvertRules = DrillRuleSets<span class="string">.mergedRuleSets(DrillRuleSets.getDrillBasicRules(context)</span>, DrillRuleSets<span class="string">.getDrillUserConfigurableLogicalRules(context))</span>;</span><br><span class="line">  RuleSet[] allRules = new RuleSet[] &#123;drillLogicalRules, drillPhysicalMem, logicalConvertRules&#125;</span>;</span><br><span class="line">  return allRules;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘è®¡åˆ’çš„åŸºæœ¬è§„åˆ™, è¿™äº›è§„åˆ™æ˜¯é€šç”¨çš„, ä¸éœ€è¦åœ¨ç‰©ç†è®¡åˆ’é˜¶æ®µå®Œæˆ, é€šç”¨çš„è§„åˆ™å°½æ—©åš.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get an immutable list of rules that will always be used when running logical planning.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">RuleSet <span class="title">getDrillBasicRules</span><span class="params">(QueryContext context)</span> </span>&#123;</span><br><span class="line">    DRILL_BASIC_RULES = <span class="keyword">new</span> DrillRuleSet(ImmutableSet.&lt;RelOptRule&gt; builder().add( <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Add support for Distinct Union (by using Union-All followed by Distinct)</span></span><br><span class="line">    UnionToDistinctRule.INSTANCE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add support for WHERE style joins. æ·»åŠ æ”¯æŒwhereç±»å‹çš„join</span></span><br><span class="line">    DrillFilterJoinRules.DRILL_FILTER_ON_JOIN,</span><br><span class="line">    DrillFilterJoinRules.DRILL_JOIN,</span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªwhereç±»å‹çš„joinè§„åˆ™è½¬æ¢: <a href="http://blog.aliyun.com/733" target="_blank" rel="external">http://blog.aliyun.com/733</a><br>SELECT * FROM A JOIN B ON A.ID=B.ID WHERE A.AGE&gt;10 AND B.AGE&gt;5<br><code>Predict Push Down</code>: åœ¨é‡æœ‰JOINè¿ç®—æ—¶,ç”¨æˆ·å¾ˆæœ‰å¯èƒ½è¿˜è¦åœ¨JOINä¹‹ååšWHEREè¿ç®—,æ­¤æ—¶å°±è¦ä»ä»£æ•°é€»è¾‘ä¸Šåˆ†æ,<br>WHEREä¸­è®¡ç®—çš„æ¡ä»¶æ˜¯å¦å¯ä»¥è¢«æå‰åˆ°JOINä¹‹å‰è¿ç®—,ä»¥æ­¤æ¥å‡å°‘JOINè¿ç®—çš„æ•°æ®é‡,æå‡æ•ˆç‡  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill17.png" alt=""></p>
<p>é‚£ä¹ˆDrillçš„FilterJoinè§„åˆ™æ˜¯æ€ä¹ˆæ ·çš„å‘¢?  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> DrillFilterJoinRules &#123;</span><br><span class="line">  <span class="comment">/** Predicate that always returns true for any filter in OUTER join, and only true for EQUAL or IS_DISTINCT_FROM over RexInputRef in INNER join.</span><br><span class="line">   * With this predicate, the filter expression that return true will be kept in the JOIN OP.</span><br><span class="line">   * Example:  INNER JOIN,   L.C1 = R.C2 and L.C3 + 100 = R.C4 + 100 will be kepted in JOIN.</span><br><span class="line">   *                         L.C5 &lt; R.C6 will be pulled up into Filter above JOIN. </span><br><span class="line">   *           OUTER JOIN,   Keep any filter in JOIN.</span><br><span class="line">  */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FilterJoinRule.Predicate EQUAL_IS_DISTINCT_FROM =</span><br><span class="line">      <span class="keyword">new</span> FilterJoinRule.Predicate() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">boolean</span> apply(<span class="keyword">Join</span> <span class="keyword">join</span>, JoinRelType joinType, RexNode exp) &#123;</span><br><span class="line">          <span class="comment">// In OUTER join, we could not pull-up the filter. All we can do is keep the filter with JOIN, and then decide whether the filter could be pushed down into LEFT/RIGHT.</span></span><br><span class="line">          <span class="keyword">if</span> (joinType != JoinRelType.INNER) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          List&lt;RexNode&gt; tmpLeftKeys = Lists.newArrayList();</span><br><span class="line">          List&lt;RexNode&gt; tmpRightKeys = Lists.newArrayList();</span><br><span class="line">          List&lt;RelDataTypeField&gt; sysFields = Lists.newArrayList();</span><br><span class="line">          RexNode remaining = RelOptUtil.splitJoinCondition(sysFields, <span class="keyword">join</span>.getLeft(), <span class="keyword">join</span>.getRight(), exp, tmpLeftKeys, tmpRightKeys, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">          <span class="keyword">if</span> (remaining.isAlwaysTrue())  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Rule that pushes predicates from a Filter into the Join below them. */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FilterJoinRule DRILL_FILTER_ON_JOIN =</span><br><span class="line">      <span class="keyword">new</span> FilterJoinRule.FilterIntoJoinRule(<span class="keyword">true</span>, RelFactories.DEFAULT_FILTER_FACTORY,</span><br><span class="line">          RelFactories.DEFAULT_PROJECT_FACTORY, EQUAL_IS_DISTINCT_FROM);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œæœ€å¥½è¦ç†è§£ä¸‹Calciteçš„ä¸€äº›æ¦‚å¿µ, è¦ä¸ç„¶ç†è§£èµ·æ¥æœ‰ä¸€å®šå›°éš¾.<br>å‚è€ƒ<a href="http://blog.csdn.net/yunlong34574/article/details/46375733" target="_blank" rel="external">http://blog.csdn.net/yunlong34574/article/details/46375733</a>äº†è§£ä¸‹optiq-javabenè¿™ä¸ªé¡¹ç›®çš„æºç .<br>ç„¶åå‚è€ƒè¿™é‡Œäº†è§£ä¸‹æŸ¥è¯¢ä¸‹æ¨ä¼˜åŒ–:<a href="https://datapsyche.wordpress.com/2014/08/06/optiq-query-push-down-concept" target="_blank" rel="external">https://datapsyche.wordpress.com/2014/08/06/optiq-query-push-down-concept</a>  </p>
</blockquote>
<h3 id="Calcite_FilterJoinRule">Calcite FilterJoinRule</h3><p>ä¸‹é¢å¼•ç”¨äº†Optiqä½œè€…çš„Apache Calcite Overviewçš„ä¸€ä¸ªç¤ºä¾‹:  </p>
<p>ä¸¤å¼ è¡¨è¿›è¡Œjoinåæœ‰ä¸€ä¸ªwhereè¿‡æ»¤æ¡ä»¶, æ²¡æœ‰ä½¿ç”¨è§„åˆ™çš„è¯, åˆ™è¦joinå®Œåæ‰è¿›è¡Œè¿‡æ»¤:  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/calcite2.png" alt=""></p>
<p>ä½¿ç”¨FilterJoinRuleå, æŠŠFilteræå‰åˆ°Joinä¹‹å‰, æ‰«æä¹‹åç«‹åˆ»è¿›è¡Œ, è¿™æ ·å‡å°‘äº†joinçš„æ•°æ®é‡:  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/calcite3.png" alt=""></p>
<p>é‚£ä¹ˆæ€ä¹ˆå®šä¹‰ä¸€ä¸ªè§„åˆ™å‘¢?  cal.relsæ˜¯ä¸€ä¸ªRelationExpressionæ•°ç»„, è°ƒç”¨onMatchæ—¶, rels=[Join,Filter,Scan]<br>å› æ­¤æˆ‘ä»¬è¦è·å¾—call.relsä¸­çš„Joinå’ŒFilter. ä½¿ç”¨æ•°ç»„ç´¢å¼•rel(0)è¡¨ç¤ºJoin, rel(1)è¡¨ç¤ºFilter.<br>æœ€åè°ƒç”¨call.transform(newJoin)å°†åŸå§‹çš„RelationExpressionè½¬æ¢æˆæ–°çš„RelExp.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/calcite4.png" alt=""></p>
<blockquote>
<p>æ³¨æ„è½¬æ¢åçš„å³å›¾Joinâ€™,Filterâ€™ä¸Šé¢çš„å¼•å·è¡¨ç¤ºnew. å’ŒåŸæ¥çš„Join,Filteræ˜¯ä¸ä¸€æ ·çš„å˜é‡äº†.  </p>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬è¿›å…¥Calciteçš„æºç çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆåšçš„. å†…éƒ¨ç±»FilterIntoJoinRuleçš„æ„é€ å‡½æ•°å‚æ•°:  </p>
<p>filterFactoryå’ŒprojectFactoryåˆ†åˆ«æ˜¯FilterFactoryImpl,ProjectFactoryImpl.<br>ä½œä¸ºå·¥å‚ç±»,å®ƒä»¬çš„createæ–¹æ³•ä¼šè°ƒç”¨LogicalFilter,LogicalProjectçš„createæ–¹æ³•è¿”å›RelNode.  </p>
<p>é‚£ä¹ˆé—®é¢˜æ˜¯è¿™é‡Œä¼ å…¥çš„ä¸ºä»€ä¹ˆæ˜¯Filterå’ŒProjectå‘¢? Filteræ˜¾ç„¶éœ€è¦,å› ä¸ºæˆ‘ä»¬çš„è§„åˆ™å°±æ˜¯é’ˆå¯¹Filterå’ŒJoinè¿›è¡Œä¼˜åŒ–çš„.<br>Projectå‘¢? Filterè‚¯å®šæ˜¯é’ˆå¯¹æŸä¸ªå­—æ®µè¿›è¡Œè¿‡æ»¤çš„, è¿™é‡Œçš„è¿‡æ»¤å­—æ®µå°±å¯ä»¥è®¤ä¸ºæ˜¯å…ˆProjectæŠŠç»“æœæŸ¥å‡ºæ¥,æ‰æœ‰æœºä¼šè¿›è¡Œè¿‡æ»¤.  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Rule that tries to push filter expressions into a join condition and into the inputs of the join. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> FilterIntoJoinRule <span class="keyword">extends</span> FilterJoinRule &#123;</span><br><span class="line">  <span class="keyword">public</span> FilterIntoJoinRule(<span class="keyword">boolean</span> smart, RelFactories.FilterFactory filterFactory, RelFactories.ProjectFactory projectFactory, Predicate predicate) &#123;</span><br><span class="line">    <span class="keyword">super</span>(</span><br><span class="line">        operand(Filter.<span class="keyword">class</span>,</span><br><span class="line">            operand(<span class="keyword">Join</span>.<span class="keyword">class</span>, RelOptRule.<span class="keyword">any</span>())),</span><br><span class="line">        <span class="string">"FilterJoinRule:filter"</span>, smart, filterFactory, projectFactory, predicate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @Override <span class="keyword">public</span> <span class="keyword">void</span> onMatch(RelOptRuleCall <span class="keyword">call</span>) &#123;</span><br><span class="line">    Filter filter = <span class="keyword">call</span>.rel(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">Join</span> <span class="keyword">join</span> = <span class="keyword">call</span>.rel(<span class="number">1</span>);</span><br><span class="line">    perform(<span class="keyword">call</span>, filter, <span class="keyword">join</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onMatchæ–¹æ³•å’Œä¸Šé¢çš„å›¾æ˜¯ä¸€æ ·çš„. è€Œå…·ä½“çš„call.transformåˆ™åœ¨FilterJoinRuleçš„performä¸­å®Œæˆ.  æˆ‘ä»¬å…ˆçœ‹ä¸‹FilterIntoJoinRuleç±»ä¸Šé¢çš„æ³¨é‡Š:<br>å°è¯•ç€æŠŠfilterè¡¨è¾¾å¼pushåˆ°ä¸€ä¸ªjoinæ¡ä»¶é‡Œé¢, å¹¶ä¸”pushåˆ°joinçš„è¾“å…¥. å‡è®¾joinçš„è¾“å…¥æ˜¯Scan,åˆ™filerä¼špushåˆ°Scanåé¢.  </p>
<p>å†æ¥çœ‹çœ‹FilterJoinRuleç±»ä¸Šé¢çš„æ³¨é‡Š: <code>Planner rule that pushes filters above and within a join node into the join node and/or its children nodes.</code> </p>
<p>å‘ä¸Šæå‡filters(ä¸ºä»€ä¹ˆæ˜¯å‘ä¸Š, å‘ä¸Šå‘ä¸‹çš„æ–¹å‘æ˜¯ä»€ä¹ˆ? Scanæ˜¯è¾“å…¥æº,åˆ™Scanåœ¨ä¸Š, Scan-Join-Filterè½¬æ¢ä¸ºScan-Filter-Join,åˆ™Filterå‘ä¸Šæå‡äº†ä¸€ä¸ªç­‰çº§),<br>withinè¡¨ç¤ºåœ¨ä¸€ä¸ªjoinèŠ‚ç‚¹å†…éƒ¨, åŸå…ˆæ˜¯Scan-Join-Filter, ç¬¬ä¸€æ­¥æ˜¯æŠŠFilteråˆå¹¶åˆ°Joiné‡Œé¢: Scan-Join(Filter)<br>æˆ–è€…joinèŠ‚ç‚¹çš„å­èŠ‚ç‚¹, ä»Treeçš„è§’åº¦æ¥çœ‹, Joinä¸‹é¢æ˜¯ä¸¤å¼ æ•°æ®æºè¡¨,æ•°æ®æºå°±æ˜¯Joinçš„childrenèŠ‚ç‚¹.<br>æˆ‘ä»¬å¯ä»¥æŠŠFilterwithinåˆ°Joinçš„å­©å­èŠ‚ç‚¹å³Scanä¸­. å³ç¬¬äºŒæ­¥å°±æ˜¯: Scan(Filter)-Join. DAGå›¾å°±æ˜¯: Scan-Filter-Join. Wow!!!</p>
<p>1.æŠŠleft,rightè¡¨è§£æå‡ºæ¥å³join.left,join.right. ä»¥åŠleftFitlers,rightFilters.<br>2.æ ¹æ®leftFilterså’Œleft, rightFilterså’Œrightåˆ›å»ºæ–°çš„leftRel,rightRelèŠ‚ç‚¹<br>3.åˆ›å»ºæ–°çš„joinèŠ‚ç‚¹,å¹¶ä¸”å¼•ç”¨æ–°çš„å­©å­èŠ‚ç‚¹(å³ä¸Šé¢çš„leftRel,rightRel)<br>4.è°ƒç”¨callçš„transformTo,å‚æ•°æ˜¯æœ€æ–°çš„joinèŠ‚ç‚¹.   </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// create FilterRels on top of the children if any filters were pushed to them</span></span><br><span class="line">  <span class="keyword">final</span> RexBuilder rexBuilder = <span class="keyword">join</span>.getCluster().getRexBuilder();</span><br><span class="line">  RelNode leftRel = RelOptUtil.createFilter(<span class="keyword">join</span>.getLeft(), leftFilters, filterFactory);</span><br><span class="line">  RelNode rightRel = RelOptUtil.createFilter(<span class="keyword">join</span>.getRight(), rightFilters, filterFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create the new join node referencing the new children and containing its new join filters (if there are any)</span></span><br><span class="line">  <span class="keyword">final</span> RexNode joinFilter = RexUtil.composeConjunction(rexBuilder, joinFilters, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  RelNode newJoinRel = <span class="keyword">join</span>.<span class="keyword">copy</span>(<span class="keyword">join</span>.getTraitSet(), joinFilter, leftRel, rightRel, joinType, <span class="keyword">join</span>.isSemiJoinDone());</span><br><span class="line">  <span class="keyword">call</span>.getPlanner().onCopy(<span class="keyword">join</span>, newJoinRel);</span><br><span class="line">  <span class="keyword">if</span> (!leftFilters.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">call</span>.getPlanner().onCopy(filter, leftRel);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!rightFilters.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">call</span>.getPlanner().onCopy(filter, rightRel);</span><br><span class="line">  &#125;        </span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a FilterRel on top of the join if needed</span></span><br><span class="line">  RelNode newRel = RelOptUtil.createFilter(newJoinRel,</span><br><span class="line">          RexUtil.fixUp(rexBuilder, aboveFilters, newJoinRel.getRowType()),</span><br><span class="line">          filterFactory);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">call</span>.transformTo(newRel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æˆ‘ä»¬å®ç°äº†è‡ªå®šä¹‰è§„åˆ™çš„onMatchæ–¹æ³•, é‚£ä¹ˆè°æ¥è°ƒç”¨å®ƒå‘¢:   </p>
<p>RelOptPlannerå®ç°ç±»VolcanoPlanner.fireRules-&gt;RelOptRuleçš„å®ç°ç±»VolcanoRuleCall.match-&gt;matchRecurse-&gt;onMatch-&gt;getRule().onMatch(this);  </p>
<blockquote>
<p>Volcanoçš„æ„æ€æ˜¯ç«å±±ä¼¼çš„,çŒ›çƒˆçš„. ç”±æ­¤è¯´æ˜è§„åˆ™å¾ˆå¤šçš„è¯, matchè°ƒç”¨ä¼šæ˜¯å¾ˆå‡¶çŒ›çš„. </p>
</blockquote>
<h2 id="Drill_FilterJoin_Example">Drill FilterJoin Example</h2><p>æ‰§è¡Œä¸‹é¢çš„SQLè¯­å¥, ç¬¬ä¸€æ¬¡ä¸åŠ where,ç¬¬äºŒæ¬¡æ·»åŠ whereè¿‡æ»¤æ¡ä»¶, ç¬¬ä¸‰æ¬¡whereæ˜¯å­—æ®µæ¯”è¾ƒ</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">FROM</span> dfs.`<span class="regexp">/home/</span>hadoop<span class="regexp">/soft/</span>apache-drill-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/sample-data/</span>nation.parquet` nations</span><br><span class="line"><span class="keyword">join</span> dfs.`<span class="regexp">/home/</span>hadoop<span class="regexp">/soft/</span>apache-drill-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/sample-data/</span>region.parquet` regions</span><br><span class="line">on nations.N_REGIONKEY = regions.R_REGIONKEY</span><br><span class="line"></span><br><span class="line">select * <span class="keyword">FROM</span> dfs.`<span class="regexp">/home/</span>hadoop<span class="regexp">/soft/</span>apache-drill-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/sample-data/</span>nation.parquet` nations</span><br><span class="line"><span class="keyword">join</span> dfs.`<span class="regexp">/home/</span>hadoop<span class="regexp">/soft/</span>apache-drill-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/sample-data/</span>region.parquet` regions</span><br><span class="line">on nations.N_REGIONKEY = regions.R_REGIONKEY</span><br><span class="line">where nations.N_NATIONKEY&gt;<span class="number">10</span> and regions.R_NAME=<span class="string">'AMERICA'</span></span><br><span class="line"></span><br><span class="line">select * <span class="keyword">FROM</span> dfs.`<span class="regexp">/home/</span>hadoop<span class="regexp">/soft/</span>apache-drill-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/sample-data/</span>nation.parquet` nations</span><br><span class="line"><span class="keyword">join</span> dfs.`<span class="regexp">/home/</span>hadoop<span class="regexp">/soft/</span>apache-drill-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/sample-data/</span>region.parquet` regions</span><br><span class="line">on nations.N_REGIONKEY = regions.R_REGIONKEY</span><br><span class="line">where nations.N_NAME&lt;regions.R_NAME</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯å¯¹åº”ç‰©ç†è®¡åˆ’å¯è§†åŒ–å›¾, å›¾1åœ¨Scanå’ŒJOINä¹‹é—´æœ‰Project:  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill18.png" alt="">   </p>
<p>å›¾2è™½ç„¶whereè¿‡æ»¤åœ¨joinä¹‹å, ä½†æ˜¯ç»è¿‡ä¼˜åŒ–å, ä¼šå…ˆäºjoinæ‰§è¡Œçš„: å³filterä¹‹åæ‰è¿›è¡Œjoin  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill19.png" alt="">   </p>
<p>å›¾3å°±æ²¡è¿™ä¹ˆå¹¸è¿äº†,è¦åœ¨joinä¹‹åæ‰èƒ½filter.</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill20.png" alt="">   </p>
<hr>
<h2 id="DrillRel(Drillé€»è¾‘æ“ä½œç¬¦)">DrillRel(Drillé€»è¾‘æ“ä½œç¬¦)</h2><p>getPlançš„å‚æ•°SqlNodeåœ¨å‰é¢é€šè¿‡Calciteçš„è§£æ, ç»“æœæ˜¯ä¸€é¢—SQL parse tree(ä¸è¦ä»¥ä¸ºNodeå°±åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹),<br>ä½†å®ƒè¿˜åªæ˜¯Calciteè®¤è¯†çš„SQLæ“ä½œç¬¦, æˆ‘ä»¬è¦å°†å®ƒè½¬æ¢ä¸ºDrillèƒ½å¤Ÿè®¤è¯†çš„é€»è¾‘æ“ä½œç¬¦å³DrillRel.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public PhysicalPlan getPlan(SqlNode sqlNode) throws ValidationException, RelConversionException, IOException, ForemanSetupException &#123;</span><br><span class="line">  SqlNode rewrittenSqlNode = rewrite(sqlNode)<span class="comment">;</span></span><br><span class="line">  TypedSqlNode validatedTypedSqlNode = validateNode(rewrittenSqlNode)<span class="comment">;</span></span><br><span class="line">  SqlNode validated = validatedTypedSqlNode.getSqlNode()<span class="comment">;</span></span><br><span class="line">  RelDataType validatedRowType = validatedTypedSqlNode.getType()<span class="comment">;</span></span><br><span class="line">  RelNode rel = convertToRel(validated)<span class="comment">;</span></span><br><span class="line">  rel = preprocessNode(rel)<span class="comment">;</span></span><br><span class="line">  log("Optiq Logical", rel)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  DrillRel drel = convertToDrel(rel, validatedRowType)<span class="comment">;</span></span><br><span class="line">  log("Drill Logical", drel)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  Prel prel = convertToPrel(drel)<span class="comment">;</span></span><br><span class="line">  log("Drill Physical", prel)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  PhysicalOperator pop = convertToPop(prel)<span class="comment">;</span></span><br><span class="line">  PhysicalPlan plan = convertToPlan(pop)<span class="comment">;</span></span><br><span class="line">  log("Drill Plan", plan)<span class="comment">;</span></span><br><span class="line">  return plan<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Relational Expression(Rel)</strong></p>
<p>åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ä¹Ÿè¯´äº†: <code>æ‰§è¡Œè®¡åˆ’æ€»æ˜¯åŒ…å«ä¸€ä¸ªScreen Operator,ç”¨æ¥é˜»å¡å¹¶ä¸”ç­‰å¾…è¿”å›çš„æ•°æ®. è¿”å›çš„DrillRelå°±æ˜¯é€»è¾‘è®¡åˆ’.</code><br>SqlNode,RelNodeæ˜¯Calciteçš„èŠ‚ç‚¹, DrillRelæ˜¯Drillçš„å…³ç³»è¡¨è¾¾å¼èŠ‚ç‚¹,åœ¨æœ€å¤–å±‚åŒ…è£…äº†ä¸€ä¸ªScreenç”¨äºå±å¹•è¾“å‡º.    </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function">DrillRel <span class="title">convertToDrel</span><span class="params">(RelNode relNode, RelDataType validatedRowType)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Put a non-trivial topProject to ensure the final output field name is preserved, when necessary.</span></span><br><span class="line">      DrillRel topPreservedNameProj = addRenamedProject((DrillRel) convertedRelNode, validatedRowType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DrillScreenRel(topPreservedNameProj.getCluster(), topPreservedNameProj.getTraitSet(), topPreservedNameProj);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Screen Nodeå’Œå…¶ä»–ä¸€äº›DrillRelçš„æ„é€ å‡½æ•°, å…¶ä¸­inputæŒ‡å®šäº†Screençš„è¾“å…¥,è¡¨ç¤ºç”¨ScreenèŠ‚ç‚¹åŒ…è£…ä¸ŠåŸå…ˆçš„èŠ‚ç‚¹, ä½¿å…¶æˆä¸ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DrillScreenRel</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">DrillScreenRelBase</span> <span class="title">implements</span> <span class="title">DrillRel</span> &#123;</span></span><br><span class="line">  public <span class="type">DrillScreenRel</span>(<span class="type">RelOptCluster</span> cluster, <span class="type">RelTraitSet</span> traitSet, <span class="type">RelNode</span> input) &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="type">DRILL_LOGICAL</span>, cluster, traitSet, input);</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="type">LogicalOperator</span> implement(<span class="type">DrillImplementor</span> implementor) &#123;</span><br><span class="line">    <span class="type">LogicalOperator</span> childOp = implementor.visitChild(<span class="keyword">this</span>, <span class="number">0</span>, getInput());</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Store</span>.builder().setInput(childOp).storageEngine(<span class="string">"--SCREEN--"</span>).build();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ç»§æ‰¿å…³ç³»: DrillScreenRel &gt;&gt; DrillRel &gt;&gt; DrillRelNode &gt;&gt; RelNode<br>å…¶ä¸­DrillRelæ˜¯é€»è¾‘è®¡åˆ’çš„å…³ç³»è¡¨è¾¾å¼. å­ç±»è¦å®ç°implementæ–¹æ³•, è¿”å›é€»è¾‘æ“ä½œç¬¦.  </p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Relational expression that is implemented in Drill.</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DrillRel</span> <span class="keyword">extends</span> <span class="title">DrillRelNode</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Calling convention for relational expressions that are "implemented" by generating Drill logical plans</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Convention DRILL_LOGICAL = <span class="keyword">new</span> Convention.Impl(<span class="string">"LOGICAL"</span>, DrillRel.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">  LogicalOperator implement(DrillImplementor implementor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill13-2.png" alt="">  <img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill13-1.png" alt=""></p>
<h2 id="DrillRel_Nodes_Tree_â†’_Drill_LogicalPlan">DrillRel Nodes Tree â†’ Drill LogicalPlan</h2><p>DrillImplementor: <code>Context for converting a tree of DrillRel nodes into a Drill logical plan</code>  </p>
<h2 id="ç‰©ç†è®¡åˆ’Prel">ç‰©ç†è®¡åˆ’Prel</h2><p>ç„¶åå°†é€»è¾‘è®¡åˆ’è½¬æ¢ä¸ºç‰©ç†è®¡åˆ’, å°†DrillRelè½¬æ¢ä¸ºPrel. æœ€åæ‰æ˜¯Drillçš„Plan. æ³¨æ„Drillçš„ç‰©ç†è®¡åˆ’å’Œæœ€ç»ˆçš„Planæ˜¯æœ‰ç‚¹å·®åˆ«çš„.  </p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="type">Prel</span> convertToPrel(<span class="type">RelNode</span> drel) &#123;</span><br><span class="line">  <span class="type">Prel</span> phyRelNode = (<span class="type">Prel</span>) planner.transform(<span class="type">DrillSqlWorker</span>.<span class="type">PHYSICAL_MEM_RULES</span>, traits, drel);</span><br><span class="line"></span><br><span class="line">  /*  <span class="type">The</span> order <span class="keyword">of</span> the following transformation <span class="keyword">is</span> important */</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">   * <span class="number">0</span>.) <span class="type">For</span> select * <span class="keyword">from</span> join query, we need insert project on top <span class="keyword">of</span> scan <span class="keyword">and</span> a top project just</span><br><span class="line">   * under screen operator. <span class="type">The</span> project on top <span class="keyword">of</span> scan will rename <span class="keyword">from</span> * to <span class="type">T1</span>*, <span class="keyword">while</span> the top project</span><br><span class="line">   * will rename <span class="type">T1</span>* to *, before it output the final <span class="literal">result</span>. <span class="type">Only</span> the top project will allow</span><br><span class="line">   * duplicate columns, since user could <span class="string">"explicitly"</span> ask <span class="keyword">for</span> duplicate columns ( select *, col, *).</span><br><span class="line">   * <span class="type">The</span> rest <span class="keyword">of</span> projects will remove the duplicate column <span class="keyword">when</span> we generate <span class="type">POP</span> <span class="keyword">in</span> json format.</span><br><span class="line">   */</span><br><span class="line">  phyRelNode = <span class="type">StarColumnConverter</span>.insertRenameProject(phyRelNode);  //* <span class="keyword">is</span> star, <span class="keyword">and</span> this column should convert</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è½¬æ¢çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚, è€Œä¸”è½¬æ¢çš„é¡ºåºä¹Ÿå¾ˆé‡è¦. å…ˆçœ‹ç¬¬ä¸€ä¸ª, åœ¨select * from joinè¿™ç§æƒ…å†µä¸‹, è¦æ’å…¥ä¸¤ä¸ªProject.<br>ä¸€ä¸ªæ˜¯scan(bottom)ä¹‹ä¸Š, ä¸€ä¸ªæ˜¯screen(top)ä¹‹ä¸‹. æ¯”å¦‚ä¸‹é¢çš„SQLè¯­å¥:    </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select <span class="keyword">*</span> from dfs.`/usr/install/apache-drill-1.1.0/sample-data/nation.parquet` nations</span><br><span class="line">join dfs.`/usr/install/apache-drill-1.1.0/sample-data/region.parquet` regions</span><br><span class="line">on nations.N_REGIONKEY = regions.R_REGIONKEY;</span><br><span class="line">+--------------+-----------------+--------------+-----------------------+--------------+--------------+-----------------------+</span><br><span class="line">|<span class="string"> N_NATIONKEY  </span>|<span class="string">     N_NAME      </span>|<span class="string"> N_REGIONKEY  </span>|<span class="string">       N_COMMENT       </span>|<span class="string"> R_REGIONKEY  </span>|<span class="string">    R_NAME    </span>|<span class="string">       R_COMMENT       </span>|</span><br><span class="line">+--------------+-----------------+--------------+-----------------------+--------------+--------------+-----------------------+</span><br><span class="line">|<span class="string"> 0            </span>|<span class="string"> ALGERIA         </span>|<span class="string"> 0            </span>|<span class="string">  haggle. carefully f  </span>|<span class="string"> 0            </span>|<span class="string"> AFRICA       </span>|<span class="string"> lar deposits. blithe  </span>|</span><br><span class="line">|<span class="string"> 1            </span>|<span class="string"> ARGENTINA       </span>|<span class="string"> 1            </span>|<span class="string"> al foxes promise sly  </span>|<span class="string"> 1            </span>|<span class="string"> AMERICA      </span>|<span class="string"> hs use ironic, even   </span>|</span><br></pre></td></tr></table></figure>
<p>ç‰©ç†è®¡åˆ’: </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>-<span class="number">00</span>    Screen : rowType = RecordType(ANY *, ANY *<span class="number">0</span>): rowcount = <span class="number">25.0</span>, cumulative cost = &#123;<span class="number">62.5</span> rows, <span class="number">402.5</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">2432</span></span><br><span class="line"><span class="number">00</span>-<span class="number">01</span>   â‘¤ ProjectAllowDup(*=[$<span class="number">0</span>], *<span class="number">0</span>=[$<span class="number">1</span>]) : rowType = RecordType(ANY *, ANY *<span class="number">0</span>): rowcount = <span class="number">25.0</span>, cumulative cost = &#123;<span class="number">60.0</span> rows, <span class="number">400.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">2431</span></span><br><span class="line"><span class="number">00</span>-<span class="number">02</span>   â‘£   Project(T0Â¦Â¦*=[$<span class="number">0</span>], T1Â¦Â¦*=[$<span class="number">2</span>]) : rowType = RecordType(ANY T0Â¦Â¦*, ANY T1Â¦Â¦*): rowcount = <span class="number">25.0</span>, cumulative cost = &#123;<span class="number">60.0</span> rows, <span class="number">400.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">2430</span></span><br><span class="line"><span class="number">00</span>-<span class="number">03</span>   â‘¢     HashJoin(condition=[=($<span class="number">1</span>, $<span class="number">3</span>)], joinType=[inner]) : rowType = RecordType(ANY T0Â¦Â¦*, ANY N_REGIONKEY, ANY T1Â¦Â¦*, ANY R_REGIONKEY): rowcount = <span class="number">25.0</span>, cumulative cost = &#123;<span class="number">60.0</span> rows, <span class="number">400.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">2429</span></span><br><span class="line"><span class="number">00</span>-<span class="number">05</span>   â‘        Project(T0Â¦Â¦*=[$<span class="number">0</span>], N_REGIONKEY=[$<span class="number">1</span>]) : rowType = RecordType(ANY T0Â¦Â¦*, ANY N_REGIONKEY): rowcount = <span class="number">25.0</span>, cumulative cost = &#123;<span class="number">25.0</span> rows, <span class="number">50.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">2426</span></span><br><span class="line"><span class="number">00</span>-<span class="number">07</span>              Scan(groupscan=[ParquetGroupScan [entries=[ReadEntryWithPath [path=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/nation.parquet]], selectionRoot=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/nation.parquet, numFiles=<span class="number">1</span>, columns=[`*`]]]) : rowType = (DrillRecordRow[*, N_REGIONKEY]): rowcount = <span class="number">25.0</span>, cumulative cost = &#123;<span class="number">25.0</span> rows, <span class="number">50.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">2425</span></span><br><span class="line"><span class="number">00</span>-<span class="number">04</span>   â‘¡       Project(T1Â¦Â¦*=[$<span class="number">0</span>], R_REGIONKEY=[$<span class="number">1</span>]) : rowType = RecordType(ANY T1Â¦Â¦*, ANY R_REGIONKEY): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">2428</span></span><br><span class="line"><span class="number">00</span>-<span class="number">06</span>              Scan(groupscan=[ParquetGroupScan [entries=[ReadEntryWithPath [path=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/region.parquet]], selectionRoot=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/region.parquet, numFiles=<span class="number">1</span>, columns=[`*`]]]) : rowType = (DrillRecordRow[*, R_REGIONKEY]): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">2427</span></span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„å¯è§†åŒ–å›¾:  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill14.png" alt=""></p>
<p>ç‰©ç†è®¡åˆ’ä¸­çš„$0, $1â€¦è¿™äº›æ•°å­—ä»£è¡¨çš„æ˜¯asåçš„å˜é‡,å¦‚æœæ˜¯joinæœ‰å¯èƒ½åˆ—åç›¸åŒ,æ‰€ä»¥ä¹Ÿè¦æ·»åŠ projecté‡å‘½åé˜²æ­¢åç§°å†²çª:    </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">â‘  select T<span class="number">0</span>.* <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.N_REGIONKEY <span class="keyword">as</span> <span class="variable">$1</span> from nations T<span class="number">0</span> </span><br><span class="line">â‘¡ select T1.* <span class="keyword">as</span> <span class="variable">$0</span>, T1.R_REGIONKEY <span class="keyword">as</span> <span class="variable">$1</span> from regions T1</span><br><span class="line">â‘¢ select T<span class="number">0</span>.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$1</span>, T1.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$2</span>, T1.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$3</span> </span><br><span class="line">   from (select T<span class="number">0</span>.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$1</span> from nations) T<span class="number">0</span></span><br><span class="line">   join (select T1.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$2</span>, T1.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$3</span> from regions) T1</span><br><span class="line">   on T<span class="number">0</span>.<span class="variable">$1</span> = T1.<span class="variable">$3</span> </span><br><span class="line">â‘£ select <span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>,<span class="variable">$2</span> <span class="keyword">as</span> <span class="variable">$1</span> from ( </span><br><span class="line">     select T<span class="number">0</span>.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$1</span>, T1.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$2</span>, T1.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$3</span> </span><br><span class="line">     from (select T<span class="number">0</span>.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$1</span> from nations) T<span class="number">0</span></span><br><span class="line">     join (select T1.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$2</span>, T1.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$3</span> from regions) T1</span><br><span class="line">     on T<span class="number">0</span>.<span class="variable">$1</span> = T1.<span class="variable">$3</span></span><br><span class="line">   )</span><br><span class="line">â‘¤ select <span class="variable">$0</span> <span class="keyword">as</span> *, <span class="variable">$1</span> <span class="keyword">as</span> *<span class="number">0</span> from(  </span><br><span class="line">     select <span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>,<span class="variable">$2</span> <span class="keyword">as</span> <span class="variable">$1</span> from ( </span><br><span class="line">       select T<span class="number">0</span>.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$1</span>, T1.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$2</span>, T1.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$3</span> </span><br><span class="line">       from (select T<span class="number">0</span>.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$0</span>, T<span class="number">0</span>.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$1</span> from nations) T<span class="number">0</span></span><br><span class="line">       join (select T1.<span class="variable">$0</span> <span class="keyword">as</span> <span class="variable">$2</span>, T1.<span class="variable">$1</span> <span class="keyword">as</span> <span class="variable">$3</span> from regions) T1</span><br><span class="line">       on T<span class="number">0</span>.<span class="variable">$1</span> = T1.<span class="variable">$3</span></span><br><span class="line">     )</span><br><span class="line">   )</span><br><span class="line">   select *,*<span class="number">0</span> from ...</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„StarColumnè§„åˆ™æœ‰ç‚¹å¤æ‚, æˆ‘ä»¬çœ‹ä¸‹Joinåˆ—å†²çªçš„è§„åˆ™. å¯¹åº”ä¸Šé¢çš„â‘¢JOIN. å°†æ‰€æœ‰çš„åˆ—éƒ½é‡å‘½åäº†($0,$1,$2,$3, ç„¶åä»¥$1,$3è¿›è¡Œjoin).  </p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * <span class="number">1.</span>)</span><br><span class="line"> * <span class="built_in">Join</span> might cause naming conflicts from its <span class="built_in">left</span> <span class="keyword">and</span> <span class="built_in">right</span> child.</span><br><span class="line"> * <span class="keyword">In</span> such <span class="keyword">case</span>, we have <span class="keyword">to</span> insert Project <span class="keyword">to</span> rename the conflicting names.</span><br><span class="line"> */</span><br><span class="line">phyRelNode = JoinPrelRenameVisitor.insertRenameProject(phyRelNode);</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ³¨é‡Šä¸­è¯´çš„joinæœ‰leftæˆ–è€…right child. æ³¨æ„childè¿™ä¸ªè¯çš„å«ä¹‰. joinä½œä¸ºæ ¹, è€Œleftå’Œrightè¡¨åˆ†åˆ«æ˜¯æ ¹çš„å·¦å³å­èŠ‚ç‚¹.    </p>
<blockquote>
<p>ä¸ºäº†é˜²æ­¢åç§°å†²çª, æ·»åŠ project, è¿™æ ·å°±å’Œä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„å¯è§†åŒ–Planå›¾æ˜¯ä¸€ä¸€å¯¹åº”çš„äº†.<br>é‚£ä¹ˆæ€è€ƒä¸‹: è¿™é‡Œçš„joinæ’å…¥çš„Projectæ˜¯åœ¨â‘ å’Œâ‘¡,è¿˜æ˜¯â‘£??<br>æˆ‘è§‰å¾—æ˜¯åœ¨â‘£è¿™é‡Œ, å› ä¸ºâ‘ å’Œâ‘¡å·²ç»åœ¨ä¸Šé¢ç¬¬ä¸€ä¸ªè½¬æ¢è§„åˆ™StarColumnConverterä¸­è¿ç”¨è¿‡äº†.  </p>
</blockquote>
<p>insertæ“ä½œè®©ä¼ å…¥çš„phyRelNodeèŠ‚ç‚¹è°ƒç”¨å®ƒçš„acceptæ–¹æ³•, å¹¶æ¥æ”¶JoinPrelRenameVisitorå®ä¾‹å¯¹è±¡.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JoinPrelRenameVisitor</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BasePrelVisitor&lt;Prel</span>, <span class="title">Void</span>, <span class="title">RuntimeException&gt;</span>&#123;</span></span><br><span class="line">  <span class="keyword">private</span> static <span class="type">JoinPrelRenameVisitor</span> <span class="type">INSTANCE</span> = <span class="keyword">new</span> <span class="type">JoinPrelRenameVisitor</span>();</span><br><span class="line"></span><br><span class="line">  public static <span class="type">Prel</span> insertRenameProject(<span class="type">Prel</span> prel)&#123;</span><br><span class="line">    <span class="keyword">return</span> prel.accept(<span class="type">INSTANCE</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„Prelé€šè¿‡å±‚å±‚çš„è§„åˆ™åµŒå¥—, æœ€ç»ˆè¿”å›çš„è¿˜æ˜¯ä¸€ä¸ªPrel, ä¹Ÿå°±æ˜¯è¯´,æ¯æ¬¡è¿ç”¨ä¸€ä¸ªè§„åˆ™,éƒ½è¦æŠŠå½“å‰æœ€æ–°å€¼ä¼ è¿›æ¥. Prelä¹Ÿå®ç°äº†DrillRelNodeæ¥å£.<br>DrillRelNodeå†ç»“åˆä¸ŠVisitor, æœ‰ç§å±‚å±‚åµŒå¥—çš„æ„Ÿè§‰.é¦–å…ˆæ³¨å†Œæ“ä½œç¬¦çš„è§„åˆ™,ä»è€Œæ„æˆä¸€å¼ å›¾,æœ€åæ ¹æ®DAGå›¾è®¿é—®æ¯ä¸ªæ“ä½œç¬¦çš„æ—¶å€™,å†è¿ç”¨ä¸Šè§„åˆ™. </p>
<p>å‡è®¾ä¸Šé¢JoinPrelRenameVisitorçš„insertRenameProjectçš„Prelæ˜¯JoinPrel</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill15.png" alt=""></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinPrel</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">DrillJoinRelBase</span> <span class="title">implements</span> <span class="title">Prel</span>&#123;</span></span><br><span class="line">  public &lt;<span class="type">T</span>, <span class="type">X</span>, <span class="type">E</span> <span class="keyword">extends</span> <span class="type">Throwable</span>&gt; <span class="type">T</span> accept(<span class="type">PrelVisitor</span>&lt;<span class="type">T</span>, <span class="type">X</span>, <span class="type">E</span>&gt; logicalVisitor, <span class="type">X</span> value) <span class="keyword">throws</span> <span class="type">E</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> logicalVisitor.visitJoin(<span class="keyword">this</span>, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="type">Iterator</span>&lt;<span class="type">Prel</span>&gt; iterator() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">PrelUtil</span>.iter(getLeft(), getRight());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>accept()çš„å‚æ•°logicalVisitoræ˜¾ç„¶å°±æ˜¯JoinPrelRenameVisitoräº†. thisæ˜¯å½“å‰å¯¹è±¡å³JoinPrel.<br>é‚£ä¹ˆå°±è¦è°ƒç”¨JoinPrelRenameVisitorçš„visitJoinæ–¹æ³•. ä½ çœ‹åˆå›åˆ°Visitoræ¥äº†.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">JoinPrelRenameVisitor</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BasePrelVisitor&lt;Prel</span>, <span class="title">Void</span>, <span class="title">RuntimeException&gt;</span>&#123;</span></span><br><span class="line"></span><br><span class="line">  public <span class="type">Prel</span> visitJoin(<span class="type">JoinPrel</span> prel, <span class="type">Void</span> value) <span class="keyword">throws</span> <span class="type">RuntimeException</span> &#123;</span><br><span class="line">    <span class="type">List</span>&lt;<span class="type">RelNode</span>&gt; children = <span class="type">Lists</span>.newArrayList();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">Prel</span> child : prel)&#123;</span><br><span class="line">      child = child.accept(<span class="keyword">this</span>, <span class="literal">null</span>);</span><br><span class="line">      children.add(child);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> int leftCount = children.get(<span class="number">0</span>).getRowType().getFieldCount();</span><br><span class="line">    <span class="type">List</span>&lt;<span class="type">RelNode</span>&gt; reNamedChildren = <span class="type">Lists</span>.newArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="type">RelNode</span> left = prel.getJoinInput(<span class="number">0</span>, children.get(<span class="number">0</span>));</span><br><span class="line">    <span class="type">RelNode</span> right = prel.getJoinInput(leftCount, children.get(<span class="number">1</span>));</span><br><span class="line">    reNamedChildren.add(left);</span><br><span class="line">    reNamedChildren.add(right);</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">Prel</span>) prel.copy(prel.getTraitSet(), reNamedChildren);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JoinPrelæ˜¯ä¸ªè¿­ä»£å™¨, å› æ­¤ç”¨for-loopæ–¹å¼å¯ä»¥éå†å®ƒçš„èŠ‚ç‚¹: å³å‚ä¸joinçš„leftå’Œrightè¡¨(å®ç°äº†iteratoræ–¹æ³•).<br>JoinPrelçš„getJoinInputæ–¹æ³•å‚æ•°æ˜¯offsetå’ŒRelNode. offsetè¡¨ç¤ºjoinä¹‹ååˆ—çš„ç´¢å¼•(ä¸¤å¼ è¡¨joinåçš„æ‰€æœ‰åˆ—). </p>
<p>å‡è®¾æˆ‘ä»¬ç”¨ä¸¤å¼ ä¸€æ ·çš„è¡¨è¿›è¡Œjoin,å¯ä»¥çœ‹åˆ°ç›¸åŒçš„åˆ—, å³è¾¹çš„è¡¨ä¼šè¢«é‡å‘½å:  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select * from dfs.<span class="code">`/usr/install/apache-drill-1.1.0/sample-data/region.parquet`</span> region1</span><br><span class="line">join dfs.<span class="code">`/usr/install/apache-drill-1.1.0/sample-data/region.parquet`</span> regions</span><br><span class="line"><span class="header">on region1.R_REGIONKEY = regions.R_REGIONKEY;</span><br><span class="line">+--------------+--------------+-----------------------+---------------+--------------+-----------------------+</span></span><br><span class="line"><span class="header">| R_REGIONKEY  |    R_NAME    |       R_COMMENT       | R_REGIONKEY0  |   R_NAME0    |      R_COMMENT0       |</span><br><span class="line">+--------------+--------------+-----------------------+---------------+--------------+-----------------------+</span></span><br><span class="line">| 0            | AFRICA       | lar deposits. blithe  | 0             | AFRICA       | lar deposits. blithe  |</span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«è°ƒç”¨ä¸¤æ¬¡getJoinInput,ä¼ å…¥ä¸åŒçš„offsetå’Œinput, è¿™ä¸¤ä¸ªç»“æœä¸€å®šæ˜¯ä¸åŒçš„.   </p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check to make sure that the fields of the inputs are the same as the output field names.  If not, insert a project renaming them.</span></span><br><span class="line">public RelNode getJoinInput(<span class="built_in">int</span> offset, RelNode input) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; fields = getRowType().getFieldNames();</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; inputFields = input.getRowType().getFieldNames();</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; outputFields = fields.subList(offset, offset + inputFields.size());</span><br><span class="line">  <span class="keyword">if</span> (!outputFields.equals(inputFields)) &#123;</span><br><span class="line">    <span class="comment">// Ensure that input field names are the same as output field names.</span></span><br><span class="line">    <span class="comment">// If there are duplicate field names on left and right, fields will get lost.</span></span><br><span class="line">    <span class="comment">// In such case, we need insert a rename Project on top of the input.</span></span><br><span class="line">    <span class="keyword">return</span> rename(input, input.getRowType().getFieldList(), outputFields);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šé¢çš„å¤„ç†ä¸çŸ¥é“ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿›å…¥iféƒ¨åˆ†.  å‡è®¾æœ‰ä¸¤å¼ è¡¨éƒ½æ˜¯A,B,Cä¸‰åˆ—.<br>leftè¡¨ä¸å¯èƒ½æœ‰é‡å¤çš„åˆ—å, rightè¡¨ç›¸å¯¹äºleftè€Œè¨€,ä¸‰ä¸ªåˆ—éƒ½æ˜¯é‡å¤çš„. è°ƒç”¨getJoinInput(3, rightNode){}<br>inputFields=[A,B,C], fields=[A,B,C,A,B,C]. outputFields=[A,B,C],ä¸æ˜¯ç›¸ç­‰çš„å—??</p>
</blockquote>
<p>çœ‹ä¸‹ç›¸åŒè¡¨çš„joinçš„å¯è§†åŒ–æ ‘, å¯¹æ¯”ä¸€ä¸‹å°±çŸ¥é“äº†, åœ¨00-04ä¸­åŠ äº†Project:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>-<span class="number">00</span>    Screen : rowType = RecordType(ANY *, ANY *<span class="number">0</span>): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">20.5</span> rows, <span class="number">120.5</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">1299</span></span><br><span class="line"><span class="number">00</span>-<span class="number">01</span>      ProjectAllowDup(*=[$<span class="number">0</span>], *<span class="number">0</span>=[$<span class="number">1</span>]) : rowType = RecordType(ANY *, ANY *<span class="number">0</span>): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">20.0</span> rows, <span class="number">120.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">1298</span></span><br><span class="line"><span class="number">00</span>-<span class="number">02</span>        Project(T0Â¦Â¦*=[$<span class="number">0</span>], T1Â¦Â¦*=[$<span class="number">2</span>]) : rowType = RecordType(ANY T0Â¦Â¦*, ANY T1Â¦Â¦*): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">20.0</span> rows, <span class="number">120.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">1297</span></span><br><span class="line"><span class="number">00</span>-<span class="number">03</span>          HashJoin(condition=[=($<span class="number">1</span>, $<span class="number">3</span>)], joinType=[inner]) : rowType = RecordType(ANY T0Â¦Â¦*, ANY R_REGIONKEY, ANY T1Â¦Â¦*, ANY R_REGIONKEY0): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">20.0</span> rows, <span class="number">120.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">88.0</span> memory&#125;, id = <span class="number">1296</span></span><br><span class="line"><span class="number">00</span>-<span class="number">04</span>            Project(T1Â¦Â¦*=[$<span class="number">0</span>], R_REGIONKEY0=[$<span class="number">1</span>]) : rowType = RecordType(ANY T1Â¦Â¦*, ANY R_REGIONKEY0): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">1295</span></span><br><span class="line"><span class="number">00</span>-<span class="number">06</span>              Project(T1Â¦Â¦*=[$<span class="number">0</span>], R_REGIONKEY=[$<span class="number">1</span>]) : rowType = RecordType(ANY T1Â¦Â¦*, ANY R_REGIONKEY): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">1294</span></span><br><span class="line"><span class="number">00</span>-<span class="number">08</span>                Scan(groupscan=[ParquetGroupScan [entries=[ReadEntryWithPath [path=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/region.parquet]], selectionRoot=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/region.parquet, numFiles=<span class="number">1</span>, columns=[`*`]]]) : rowType = (DrillRecordRow[*, R_REGIONKEY]): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">1293</span></span><br><span class="line"><span class="number">00</span>-<span class="number">05</span>            Project(T0Â¦Â¦*=[$<span class="number">0</span>], R_REGIONKEY=[$<span class="number">1</span>]) : rowType = RecordType(ANY T0Â¦Â¦*, ANY R_REGIONKEY): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">1292</span></span><br><span class="line"><span class="number">00</span>-<span class="number">07</span>              Scan(groupscan=[ParquetGroupScan [entries=[ReadEntryWithPath [path=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/region.parquet]], selectionRoot=file:/usr/install/apache-drill-<span class="number">1.1</span><span class="number">.0</span>/sample-data/region.parquet, numFiles=<span class="number">1</span>, columns=[`*`]]]) : rowType = (DrillRecordRow[*, R_REGIONKEY]): rowcount = <span class="number">5.0</span>, cumulative cost = &#123;<span class="number">5.0</span> rows, <span class="number">10.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">1291</span></span><br></pre></td></tr></table></figure>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill16.png" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-12-drill-rpc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-12-drill-rpc/" class="article-date">
  	<time datetime="2015-12-01T10:21:46.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-12-drill-rpc/">Apache Drillæºç é˜…è¯»(2) åˆ†æä¸€æ¬¡æŸ¥è¯¢è¿‡ç¨‹ä»¥åŠRPC</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="ä¸€æ¬¡Queryçš„ç”Ÿå‘½å‘¨æœŸ">ä¸€æ¬¡Queryçš„ç”Ÿå‘½å‘¨æœŸ</h2><p>Foremançº¿ç¨‹çš„runæ–¹æ³•ä¸­çš„queryRequestæ˜¯org.apache.drill.exec.proto.UserProtosçš„RunQuery<br>å¯ä»¥è®¤ä¸ºå°±æ˜¯ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢è¯­å¥,åªä¸è¿‡ç”±äºæ˜¯åˆ†å¸ƒå¼,å®¢æˆ·ç«¯è¾“å…¥çš„æŸ¥è¯¢,ä¼šé€šè¿‡RPCåœ¨Foremanä¸Šæ‰§è¡Œ<br>protobufferæ–‡ä»¶çš„å®šä¹‰åœ¨drill-protocol/src/main/protobufä¸‹,æ¯”å¦‚User.protoå¯¹åº”äº†UserProtos</p>
<p>å…³é”®çœ‹ä¸‹run()ä¸Šé¢çš„æ³¨é‡Š. ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨: åœ¨æŸ¥è¯¢å»ºç«‹èµ·æ¥çš„æ—¶å€™<br>ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼è°ƒç”¨: æ‰§è¡Œçº¿ç¨‹æ± . åŠŸèƒ½æ˜¯ä»€ä¹ˆ: å®Œæˆè¿œç¨‹æ‰§è¡Œ<br>æ³¨æ„è¿™ä¸ªæ–¹æ³•çš„ç»“æŸå¹¶ä¸ä»£è¡¨æŸ¥è¯¢ç”Ÿå‘½å‘¨æœŸçš„Foremanè§’è‰²çš„ç»“æŸ.  </p>
<blockquote>
<p>Called by execution pool to do query setup, and kick off remote execution.<br>Note that completion of this function is not the end of the Foremanâ€™s role in the queryâ€™s lifecycle.</p>
</blockquote>
<p><a href="https://tnachen.wordpress.com/2013/11/05/lifetime-of-a-query-in-drill-alpha-release/" target="_blank" rel="external">https://tnachen.wordpress.com/2013/11/05/lifetime-of-a-query-in-drill-alpha-release/</a><br><a href="http://yangyoupeng-cn-fujitsu-com.iteye.com/blog/1974556" target="_blank" rel="external">http://yangyoupeng-cn-fujitsu-com.iteye.com/blog/1974556</a></p>
<h3 id="Client">Client</h3><p>The SELECT statement in particular is querying a HDFS data file, with a specific WHERE clause filtering based on the expression clause.</p>
<p>From the client, it submits this statement into Sqlline, which is a simple Java-based console that is able to talk to a JDBC driver, passes the SELECT statement into Optiq.</p>
<p>Optiq is a library that Drill utilizes for query parsing and planning, which it provides pluggable transformation rules that can map a SQL token into any specific object you want. Optiq also embeds a cost-based query optimizer, which we utilize for it for choosing the best order of SQL operators in the statement without any other statistics. We implemented custom Optiq rules that maps specific SQL operators (WHERE, LIMIT, etc) and each rule converts its operator into our specific Logical Operator syntax that Drill understands.</p>
<p>This collection of Logical operators with its own configurations forms a Drill Logical plan. Drillâ€™s logical plan sole purpose is to describe logically what work Drill needs to perform to produce the Query results, without any optimizations or distribution.</p>
<p>Once the client generates this logical plan, it looks up one of the DrillBit host/port information and passes the logical plan to that DrillBit.</p>
<blockquote>
<p>Drill logical plançš„å”¯ä¸€çš„ç›®æ ‡å°±æ˜¯Drillçš„æ•°æ®æµçš„å·¥ä½œæµç¨‹ï¼Œè€Œæ²¡æœ‰åšä»»ä½•çš„ä¼˜åŒ–ï¼Œå’Œåˆ†å¸ƒå¼è®¡ç®—çš„åˆ†å‘ç­‰å·¥ä½œ<br>ä¸€æ—¦clientäº§ç”Ÿäº†logical planï¼Œé‚£ä¹ˆä»–ä¼šæŸ¥è¯¢å…¶ä¸­ä¸€ä¸ªå·²ç»é…ç½®å¥½çš„DrillBitçš„host/portçš„ä¿¡æ¯ï¼Œ<br>ç„¶åå°†logical planä¼ é€’ç»™DrillBit(è¿™ä¸ªæ¥æ”¶æŸ¥è¯¢çš„DrillBitå°±æ˜¯Foreman)  </p>
</blockquote>
<h3 id="Running_Logical_Plan">Running Logical Plan</h3><p>Any DrillBit in the cluster can initiate a query, and that DrillBit becomes the Drill process that is responsible for sending back the results back to the client.</p>
<blockquote>
<p>åœ¨é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªDrillBitéƒ½èƒ½è¿è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼Œè€Œæ‰§è¡ŒæŸ¥è¯¢çš„DrillBitè¦è´Ÿè´£å°†æŸ¥è¯¢ç»“æœè¿”å›ç»™client  </p>
</blockquote>
<p>Once the UserServer that is listening to the User submission gets the logical plan, it passes it through Foreman that is responsible for turning this plan into an actual execution plan and submits the plan information for execution.</p>
<blockquote>
<p>UserServerä¼šç›‘å¬å®¢æˆ·ç«¯æäº¤çš„æŸ¥è¯¢ä»»åŠ¡,ä¸€æ—¦è·å–åˆ°é€»è¾‘è®¡åˆ’,å®ƒä¼šæŠŠé€»è¾‘è®¡åˆ’ä¼ ç»™Foreman.<br>Foremanä¼šè°ƒä¼˜è¯¥planï¼Œå¹¶ä¸”è½¬æ¢ä¸ºå®é™…æ‰§è¡Œçš„è®¡åˆ’ï¼Œå¹¶æäº¤è¯¥è®¡åˆ’çš„ä¿¡æ¯ç”¨äºåé¢çš„æ‰§è¡Œ.</p>
</blockquote>
<p>Inside of Foreman, the first operation it does is to transform the logical plan into a physical plan via Drillâ€™s Optimizer. Drillâ€™s current version of Optimizer is very basic, which simply transforms each logical operator directly into one or more phyiscal operators without much optimization rules looking into the association of other operators.</p>
<p>The physical plan is simple a DAG of physical operators, and each child/parent relationship implies how data flows through the graph. As we are inspired by Googleâ€™s Dremel paper, the take away we saw that implemented which is a MPP style multi-level execution tree, where in this execution tree each node represents a different DrillBit process and they each depend on each other results for computation.</p>
<blockquote>
<p>ç‰©ç†è®¡åˆ’æ˜¯physical operatorsçš„æœ‰å‘æ— ç¯å›¾.æ¯ä¸€å­èŠ‚ç‚¹æˆ–è€…çˆ¶èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»éƒ½æŒ‡æ˜äº†æ•°æ®å¦‚ä½•åœ¨DAGå›¾ä¸­æµåŠ¨<br>åœ¨è¿™ä¸ªæ‰§è¡Œæ ‘ä¸­ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä»£è¡¨ä¸€ä¸ªä¸åŒçš„DrillBitè®¡ç®—è¿‡ç¨‹ï¼Œä»–ä»¬ç›¸äº’ä¾èµ–å½¼æ­¤çš„è®¡ç®—ç»“æœ</p>
</blockquote>
<p>As we want to break this physical plan into a multi-level execution tree that involves multiple DrillBits, we first need to collect information about each physical operator. Each physical operator with the given operator configuration can return estimated stats about Network/Cpu/Memory/Disk and Row size and count. It also can return a list of preferred DrillBits that it wants to get executed on, which we call endpoint affinities.</p>
<blockquote>
<p>å°†ç‰©ç†è®¡åˆ’åˆ†è§£æˆå¤šä¸ªDrillBitså‚ä¸çš„å¤šå±‚çº§çš„æ‰§è¡Œæ ‘ï¼Œé¦–å…ˆè¦æœé›†æ¯ä¸€ä¸ªphysical operatorsçš„ä¿¡æ¯<br>æ ¹æ®ç»™å®šçš„æ“ä½œç¬¦çš„é…ç½®ä¿¡æ¯,æ¯ä¸ªphysical operatorsä¼šè¿”å›é¢„ä¼°çš„ç»Ÿè®¡ä¿¡æ¯,RowSizeè¡Œçš„å¤§å°,Countæ•°é‡<br><strong>å®ƒä¹Ÿèƒ½å¤Ÿè¿”å›ä¸€ä¸ªå°†è¦æ‰§è¡Œè¯¥operatorçš„DrilBitåˆ—è¡¨,ç§°ä½œè·ç¦»æœ€è¿‘/æœ€ä¼˜çš„ç«¯ç‚¹</strong></p>
<p>ç±»ä¼¼HDFSä¸­çš„è¯»æ“ä½œ,è¯»å–HDFSå—æ—¶,NNä¼šè¿”å›è¿™ä¸ªå—çš„DNåˆ—è¡¨,å®¢æˆ·ç«¯è¯»å–ç¦»è‡ªå·±æœ€è¿‘çš„DNçš„æ•°æ®å—</p>
</blockquote>
<p>One example Endpoint affinity is where a Parquet Scan opreator will want to initiate this query closet to where the Parquet file is stored, and it can look up the Parquet fileâ€™s Metadata information that stores the HDFS data node host and return that as a preferred endpoint if we have a DrillBit running there.</p>
<blockquote>
<p>æ¯”å¦‚ä¸€ä¸ªParquetæ‰«ææ“ä½œç¬¦ä¼šåœ¨ç¦»ä¿å­˜ç€Parquetæ–‡ä»¶æœ€è¿‘çš„DrillBitä¸Šé¢å‘èµ·æŸ¥è¯¢<br>ä»–å¯ä»¥æŸ¥è¯¢Parquetæ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯: å…ƒæ•°æ®ä¿å­˜äº†HDFSçš„DNèŠ‚ç‚¹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæœ€ä¼˜çš„endpoint  </p>
<p>Parquetæ–‡ä»¶æ˜¯ç±»ä¼¼JSONé‚£æ ·æœ‰è€…self-describeæ ¼å¼çš„æ–‡ä»¶,å³æ–‡ä»¶æœ¬èº«å«æœ‰schema,å°½ç®¡schemaæ˜¯freeçš„.<br>ç”±äºParquetä¿å­˜åœ¨HDFSä¸Š,HDFSä¸Šçš„æ–‡ä»¶æ˜¯æœ‰å‰¯æœ¬çš„. è€ŒScanæ“ä½œç¬¦æ˜¯è¦è®¿é—®æ–‡ä»¶çš„,<br>æ‰€ä»¥Scanæ“ä½œç¬¦ä¼šé€‰æ‹©ç¦»è‡ªå·±è¿™ä¸ªæ“ä½œç¬¦æœ€è¿‘çš„DNä¸Šçš„Parquetæ–‡ä»¶å‰¯æœ¬æ—¶,æ˜¯æœ€ä¼˜çš„æƒ…å†µ.<br>å½“ç„¶å¯¹äºæœ€ä¼˜çš„ç«¯ç‚¹çš„å‰ææ˜¯è¿™ä¸ªèŠ‚ç‚¹å®‰è£…äº†DrillBitæœåŠ¡. å› ä¸ºDrillæ˜¯æ“ä½œç¬¦çš„è½½ä½“.  </p>
<p>ä¹Ÿå°±æ˜¯è¯´,é›†ç¾¤çš„DrillBitæœåŠ¡å¯ä»¥æ‰§è¡Œä¸€ä¸ªç‰©ç†è®¡åˆ’åˆ†è§£å‡ºæ¥çš„physical operators<br>physical operatorså¯ä»¥è¢«é›†ç¾¤çš„å¤šä¸ªDrillbitæ‰§è¡Œ.<br>é€šå¸¸DrillBitè®¡ç®—èŠ‚ç‚¹ä¸Šä¹Ÿè¿è¡Œç€DNè¿™æ ·çš„æ•°æ®å­˜å‚¨èŠ‚ç‚¹,è€Œæ“ä½œç¬¦éœ€è¦å­˜å‚¨çš„æ•°æ®èµ„æº<br>æ‰€ä»¥æ“ä½œç¬¦ä¼šé€‰æ‹©ç¦»å­˜å‚¨èµ„æºæœ€è¿‘çš„Drillbit,è¿™æ ·çš„Drillbitæ˜¯æœ€ä¼˜çš„endpoint.  </p>
</blockquote>
<p>With the physical plan, all the stats and endpoint affinities, the Parallellizer in Foreman transforms this plan into a number of fragments. Each fragment is simply a self contained Physical plan that is designed to run on each DrillBit node. In any given Physical plan, there will be only one Root Fragment that is going to run in the initiating DrillBit, possibly one or more Leaf fragments and possibly one or more intermediate fragments.</p>
<blockquote>
<p>æœ‰äº†ç‰©ç†è®¡åˆ’,æ‰€æœ‰çš„ç»Ÿè®¡ä¿¡æ¯,æœ€ä¼˜ç«¯ç‚¹,Foremanä¸­çš„Parallellizerä¼šå°†ç‰©ç†è®¡åˆ’è½¬æ¢ä¸ºå¤šä¸ªfragments.<br>æ¯ä¸€ä¸ªFragmentè‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªç‰©ç†è®¡åˆ’, å®ƒä»¬åŒæ ·ä¼šè¢«åˆ†é…åˆ°DrillBitèŠ‚ç‚¹ä¸Šé¢è¿è¡Œ.<br>ä»»ä½•ä¸€ä¸ªç‰©ç†è®¡åˆ’(ç»è¿‡Foremanè½¬æ¢åçš„æ¯ä¸€ä¸ªFragment)åªæœ‰ä¸€ä¸ªRootFragment,å¤šä¸ªä¸­é—´æˆ–Leaf Fragment.</p>
</blockquote>
<h3 id="Running_Fragments">Running Fragments</h3><p>The Root fragment will be submitted to the Worker manager in its current DrillBit, the intermediate fragments will be stored in the HazelCast distributed cache, and all the leaf fragments will be sent directly to the DrillBits assigned via our BitCom through our RPC layer with Protobuf messages.</p>
<blockquote>
<p>Rootfragmentä¼šè¢«æäº¤ç»™å®ƒæ‰€åœ¨çš„å½“å‰DrillBitä¸Šçš„WorkerManager.ä¸­é—´fragmentä¿å­˜åœ¨Hazelcaståˆ†å¸ƒå¼ç¼“å­˜,<br>æ‰€æœ‰çš„leaf fragmentä¼šç›´æ¥é€šè¿‡BitCom(RPCå±‚æ¬¡çš„ä¸œè¥¿ï¼Œåè®®æ˜¯Protobuf)å‘é€ç»™å…¶ä»–DrillBits  </p>
<p>åœ¨WEBé¡µé¢å¯ä»¥çœ‹åˆ°çš„æ˜¯Majorå’ŒMinorFragment.é‚£ä¹ˆè¿™é‡Œçš„Root,Intermediate,Leaf Fragmentæ˜¯æ€ä¹ˆYYå‡ºæ¥çš„?</p>
</blockquote>
<p>The Worker Manager once receives this Root Fragment starts running this plan, which always contains a Screen Operator that blocks and wait for Records to be returned. If a plan also has multiple Drillbits involved, then it will also contain a exchange operator that sets up a Receiver that waits for incoming Records from the wire.</p>
<blockquote>
<p>Worker Managerä¸€æ—¦æ¥å—åˆ°Root Fragmentå°±ä¼šè¿è¡Œè¿™ä¸ªplan,å¹¶ä¸”æ€»æ˜¯ä¼šåŒ…å«ä¸€ä¸ªScreen Operator,ç”¨æ¥é˜»å¡å¹¶ä¸”ç­‰å¾…è¿”å›çš„æ•°æ®.<br>å¦‚æœè¯¥planéœ€è¦å¦å¤–å¤šä¸ªDrillBitå‚ä¸,è¿™äº›DrillBitç»„æˆä¸€ä¸ªwireï¼ŒWorker Managerä¹ŸåŒæ—¶ä¼šåŒ…å«ä¸€ä¸ªexchange operatorï¼Œè¯¥exchange operatorå¯åŠ¨äº†ä¸€ä¸ªReceiverç”¨ä»¥ç­‰å¾…wireä¸­çš„æ•°æ®</p>
<p>wireç±»ä¼¼HDFSä¸­DNç»„æˆçš„pipeline.å½“å®¢æˆ·ç«¯å†™æ•°æ®æ—¶,å‚ä¸å­˜å‚¨çš„DNå½¢æˆä¸€ä¸ªç®¡é“,æ•°æ®åŒ…åœ¨ç®¡é“ä¸­æµåŠ¨.<br>åªæœ‰æ‰€æœ‰çš„DNèŠ‚ç‚¹è¿”å›ackåº”ç­”ç»™å®¢æˆ·ç«¯æ—¶,æ‰è®¤ä¸ºæ•°æ®å†™å…¥æˆåŠŸ. è¿™é‡Œå‚ä¸è®¡ç®—çš„DrillBitèŠ‚ç‚¹ä¹Ÿä¸€æ ·.<br>Exchangeæ“ä½œç¬¦ç±»ä¼¼äºå®¢æˆ·ç«¯,åªæœ‰wireä¸­çš„DrillBitæ•°æ®è·å–å®Œæ¯•,è¿”å›ç»™Receiver,æ‰è®¤ä¸ºè®¡ç®—å®Œæˆ.  </p>
</blockquote>
<p>The Leaf fragments that are sent via the wire will be executed as soon as they arrive. The fragment will be parsed into a DAG with Physical operators, and setups the execution/data flow. Each Physical operator imposes a Pull style messaging, where starting from the bottom of the tree it pulls itâ€™s parent for Records and the parent will return an Outcome status. The operators is designed to handle each possible outcome status, which can be STOP, OK, OK_WITH_NEW_SCHEMA, NONE. Since Drill supports flexible schema, which in other words can tolerate schema changes in the same dataset, the operators needs to handle what happens when there is a new schema for this set of records. Seeing the benefits of columnar storage:<a href="http://the-paper-trail.org/blog/columnar-storage/" target="_blank" rel="external">http://the-paper-trail.org/blog/columnar-storage/</a>. Drill also implemented its own in memory columnar format which we called ValueVectors. A ValueVector is simply a collection of bytes that represent a run of values within the same column. Each pull of messages in each Physical operator returns a RecordBatch that can contain one or more ValueVectors per column with schema.</p>
<blockquote>
<p>é€šè¿‡wireè¢«å‘é€çš„å¶å­Fragmentä¸€æ—¦åˆ°è¾¾ç›®çš„DrillBitå°±ä¼šè¢«ç«‹å³æ‰§è¡Œ.å¶å­Fragmentä¼šè¢«è§£æä¸ºç”±ç‰©ç†æ“ä½œç¬¦ç»„æˆçš„DAG.<br>æ¯ä¸€ä¸ªç‰©ç†æ“ä½œç¬¦éƒ½ä¼šåˆ©ç”¨ä¸€ä¸ªPullç±»å‹çš„æ¶ˆæ¯æœºåˆ¶ï¼Œä»æ ‘çš„åº•éƒ¨å¼€å§‹ï¼Œoperatorä¼šä»ä»–çš„parent operatorä¸­æ‹‰å–Recordsï¼Œ<br>è€Œä»–çš„parent operatoråˆ™è¿”å›ä¸€ä¸ªOutcome statusæ¶ˆæ¯. operatorsè¢«è®¾è®¡ä¸ºèƒ½å¤„ç†æ¯ä¸€ç§å¯èƒ½çš„ç»“æœçŠ¶æ€.<br>å› ä¸ºDrillæ”¯æŒåŠ¨æ€schemaï¼Œä¹Ÿå°±æ˜¯è¯´Drillå…è®¸åœ¨åŒä¸€ä¸ªæ•°æ®é›†ä¸­schemaå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥Drillè¦èƒ½å¤Ÿå¤„ç†å½“schemaå‘ç”Ÿå˜åŒ–çš„æƒ…å†µ  </p>
<p>DrillåŒæ—¶å®ç°äº†ä»–è‡ªå·±çš„åˆ—å¼å†…å­˜æ•°æ®ç»“æ„:ValueVectorï¼Œå®ƒæ˜¯ä¸€ä¸ªbytesé›†åˆï¼Œä»£è¡¨äº†ä¸€ä¸ªcolumnå†…çš„æ•°æ®.<br>åœ¨æ¯ä¸€ä¸ªPhysical operator pullçš„æ¶ˆæ¯ä¸­ä¼šè¿”å›ä¸€ä¸ªRecordBatch: å¯¹äºæ¯ä¸ªåˆ—éƒ½ä¼šåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªValueVector</p>
</blockquote>
<p>At the very tip of the Leaf fragment in my slideshow example is the Scan operator, which is configured to look up a Parquet file and run it through the Parquet Storage Engine. The Storage engine is simply responsible for pulling in data from the data source, and converting them into ValueVectors and passes that back to its child as a RecordBatch.</p>
<blockquote>
<p>ä»æ•°æ®æºä¸­æ‹‰å–æ•°æ®ï¼ŒæŠŠæ•°æ®è½¬æ¢ä¸ºValueVectorsï¼Œç„¶åå°†è¿™äº›ValueVectorä½œä¸ºRecordBatchä¼ é€’å›ä»–çš„child</p>
<p>FragmentTreeä»åº•åˆ°ä¸Š, åº•éƒ¨æ˜¯Parent, è¶Šå¾€ä¸Šå°±æ˜¯Child. childä¼šæ‹‰å–parentçš„è®°å½•.<br>è€Œä»ä¸Šåˆ°ä¸‹æ¥çœ‹,Fragmentåˆ†è§£ä¸ºRootFragment-&gt;Intermediate-&gt;LeafFragment.<br>è¿™ä¼¼ä¹æœ‰ç‚¹çŸ›ç›¾,leafæ˜¯parent,å¾€ä¸Šåˆ™æ˜¯child. è€Œæœ€ä¸Šé¢åˆæ˜¯root fragment.  </p>
<p>æ‰«ææ“ä½œç¬¦çš„æ­¥éª¤:<br>1.Leaf Fragmentæ‹‰å–æ•°æ®æºçš„æ•°æ®<br>2.å°†æ•°æ®è½¬æ¢ä¸ºValueVectors<br>3.ç»„è£…æˆRecordBatch<br>4.ä¼ é€’ç»™å®ƒçš„å­©å­,å³ä¸Šä¸€å±‚</p>
</blockquote>
<p>Eventually the Leaf fragment will take this batch, and through the Sender operator send it to the Intermediate DrillBit.</p>
<blockquote>
<p>æœ€ç»ˆï¼Œæ‰€æœ‰çš„Leaf fragmentå°†ä¼šæ¥ç®¡è¿™äº›batchæ•°æ®ï¼Œé€šè¿‡Sender operatorå‘é€ç»™ä¸­é—´DrillBit<br>å¯¹äºæ•°æ®æº,å®ƒä»¬åªæš´éœ²ç»™ç‰©ç†è®¡åˆ’å½¢æˆçš„æ‰€æœ‰Leaf Fragment.è¿™äº›Leaf Fragmentè´Ÿè´£è¯»å–æ•°æ®.  </p>
</blockquote>
<p>The Intermediate DrillBit once receives a RecordBatch for the first time, will lookup the fragment from HazelCast by its fragment id from RecordBatch, and setup the Receiver and Physical opreators necessary for processing in this DrillBit.</p>
<blockquote>
<p>ä¸­é—´fragmentä¸€æ—¦ç¬¬ä¸€æ¬¡æ¥å—åˆ°ä¸€ä¸ªRecordBatchï¼Œä¼šä»HazleCastä¸­é€šè¿‡RecordBatchä¸­ä¿ç•™çš„fragment id<br>æŸ¥è¯¢ç›¸åº”çš„fragmentï¼Œå¹¶ä¸”è®¾ç½®Receiverä»¥åŠå¿…è¦çš„physical operatoræ¥ç»§ç»­åœ¨DrillBitä¸­è¿›è¡Œå¤„ç†è®¡ç®—</p>
</blockquote>
<p>The intermediate fragment contains a Filtering operator, and inside this operator once it receives a RecordBatch it looks up the new schema and passes that to our CodeGeneration with the specified filter expression and type information, and generate a specific code that does the filtering. This is designed to avoid casting, run tight loops and leverage prefetching as we can eliminate function calls. This is a very common approach looking at the Hiveâ€™s new vectorized query engine via Stinger initiative or in Impala.</p>
<blockquote>
<p><strong>ä¸­é—´FragmentåŒ…å«ä¸€ä¸ªFiltering operatorï¼Œåœ¨è¿™ä¸ªFiltering operatorå†…éƒ¨ï¼Œä¸€æ—¦ä»–æ¥æ”¶åˆ°ä¸€ä¸ªRecordBatchï¼Œä»–å°±ä¼šæŸ¥æ‰¾æ–°çš„schemaï¼Œå¹¶ä¸”å°†schemaä¼ é€’ç»™CodeGeneration,åŒæ—¶è¿˜ä¼šä¼ é€’ä¸€ä¸ªç‰¹æ®Šå®šä¹‰çš„filter expressionï¼Œtype informationï¼Œå€Ÿæ­¤äº§ç”Ÿä¸€æ®µç‰¹æ®Šçš„codeæ¥å®Œæˆfilter æ“ä½œã€‚é€šè¿‡è®¾è®¡æˆé¿å…castingï¼Œè¿è¡Œè½»é‡çº§çš„loopï¼Œä»¥åŠè¿›è¡Œprefetchingï¼Œæ¥å‡å°‘æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ç§æ–¹å¼åœ¨Hiveçš„æ–°vectoried query engineï¼ˆé€šè¿‡Stinger initiativeï¼‰ä»¥åŠimpalaä¸­å¾ˆæ™®é</strong></p>
</blockquote>
<p>The intermediate fragment eventually streams a batch at a time as soon as it is available to the Root DrillBit, which the Screen operator receives and returns it to the Client.</p>
<blockquote>
<p>ä¸­é—´fragmentæœ€ç»ˆä¼šè®®batchä¸ºå•å…ƒï¼Œä¸€æ¬¡å‘é€ä¸€ä¸ªbatchç»™Root DrillBit(å°±æ˜¯Foreman),<br>åœ¨Root DrillBitä¸­ä¼šç”±Screen operatoræ¥æ¥æ”¶ç›¸å…³æ•°æ®ï¼Œå¹¶ä¸”è¿”å›ç»™client(æ¥æ”¶æŸ¥è¯¢çš„ä¹Ÿè´Ÿè´£è¿”å›æŸ¥è¯¢ç»“æœ    )</p>
</blockquote>
<p>DrillClient that receives the RecordBatch, simply transforms our own columnar ValueVectors into Rows and shows the result to the client.</p>
<blockquote>
<p>DrillClientæ¥æ”¶RecordBatchï¼Œç®€å•å°†ValueVectorè½¬æ¢æˆRowså¹¶ä¸”æ˜¾ç¤ºç»™client</p>
</blockquote>
<p>This is overall what the flow looks like in our Drill alpha release, and we will be continuing to validate this architecture through diagnostic and benchmarking, and also provide more operators and storage engine so we can do much more interesting data analysis.</p>
<h2 id="Physical_Operator">Physical Operator</h2><p>å‰é¢æœ‰é€»è¾‘æ“ä½œç¬¦LogicalOperatoræ¥å£,åŒæ ·ä¹Ÿæœ‰ç‰©ç†æ“ä½œç¬¦PhysicalOperatoræ¥å£  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill6.png" alt=""></p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸‹HasAffinityæœ‰æœ€ä¼˜èŠ‚ç‚¹,æ–¹æ³•getOperatorAffinityè¿”å›æœ€ä¼˜çš„EndPointåˆ—è¡¨<br>æè¿°äº†ä¸€ä¸ªç‰©ç†æ“ä½œç¬¦å¯¹ä¸€äº›ç‰¹å®šçš„DrillBitèŠ‚ç‚¹æœ‰äº²å’Œæ€§çš„, ç”¨äºåˆ†é…å†³ç­–.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Describes a physical operator that has affinity to particular nodes. Used for assignment decisions.</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HasAffinity</span> <span class="keyword">extends</span> <span class="title">PhysicalOperator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;EndpointAffinity&gt; <span class="title">getOperatorAffinity</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EndpointAffinity</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DrillbitEndpoint endpoint;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">double</span> affinity = <span class="number">0.0</span>d;</span><br></pre></td></tr></table></figure>
<p>EndpointAffinity captures affinity value for a given single Drillbit endpoint.<br>EndpointAffinityæœ‰DrillbitEndpointçš„å¼•ç”¨, æ³¨é‡Šä¸­æåˆ°affinity value,æ‰€ä»¥æ˜¯ä¸æ˜¯å¤Ÿäº²å’Œæ˜¯å¯ä»¥è®¡ç®—å‡ºæ¥çš„.<br>åˆå§‹æ—¶è¿™ä¸ªå€¼æ˜¯0,è°ƒç”¨addAffinity()å¯ä»¥ç»™Drillbit endpointæ·»åŠ ä¸€ä¸ªäº²å’ŒåŠ›çš„å€¼.  </p>
<p>DrillBit Endpointå¯¹è±¡è¢«å®šä¹‰ä¸ºprotobuf,åœ¨Coordination.protoä¸­:  </p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">DrillbitEndpoint</span></span>&#123;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> address = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">int32</span> user_port = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">int32</span> control_port = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">int32</span> data_port = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">optional</span> Roles roles = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Drillbitå¯ä»¥è®¤ä¸ºæ˜¯Drillçš„è®¡ç®—èŠ‚ç‚¹. åœ¨binä¸‹çš„drillbit.sh startå¯åŠ¨ä¸€ä¸ªDrillæœåŠ¡.  </p>
<p>LogicalPlanæœ‰ä¸€å®šçš„æ ¼å¼:head,storageengine,query. åŒæ ·PyhsicalPlanä¹Ÿæœ‰,å®ƒä»¬çš„headæ˜¯ç›¸åŒçš„.<br>PhysicalPlançš„æ„é€ å‡½æ•°æ˜¯ä¸€ç³»åˆ—çš„ç‰©ç†æ“ä½œç¬¦,è€ŒLogicalPlançš„æ„é€ å‡½æ•°æ˜¯é€»è¾‘æ“ä½œç¬¦é›†åˆ.ç›®çš„éƒ½æ˜¯æ„é€ ä¸€å¼ DAGå›¾.  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@JsonPropertyOrder</span>(&#123; <span class="string">"head"</span>, <span class="string">"graph"</span> &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhysicalPlan</span> &#123;</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(PhysicalPlan.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">  PlanProperties properties;</span><br><span class="line">  Graph&lt;PhysicalOperator, Root, Leaf&gt; graph;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@JsonCreator</span></span><br><span class="line">  <span class="keyword">public</span> PhysicalPlan(<span class="annotation">@JsonProperty</span>(<span class="string">"head"</span>) PlanProperties properties, <span class="annotation">@JsonProperty</span>(<span class="string">"graph"</span>) List&lt;PhysicalOperator&gt; operators)&#123;</span><br><span class="line">    <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    <span class="keyword">this</span>.graph = Graph.newGraph(operators, Root.<span class="keyword">class</span>, Leaf.<span class="keyword">class</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="æŸ¥è¯¢è¿‡ç¨‹åˆ†æ">æŸ¥è¯¢è¿‡ç¨‹åˆ†æ</h2><p>åœ¨å®˜æ–¹çš„è®¾è®¡æ–‡æ¡£ä¸­<a href="http://drill.apache.org/docs/rpc-overview/" target="_blank" rel="external">http://drill.apache.org/docs/rpc-overview/</a>å¯¹RPCåªæ˜¯å¯¥å¯¥æ•°è¯­,è¿˜æœ‰å¾…è¡¥å…….  </p>
<h3 id="å®¢æˆ·ç«¯æäº¤æŸ¥è¯¢">å®¢æˆ·ç«¯æäº¤æŸ¥è¯¢</h3><p>æˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„Queryæµç¨‹ä¸€æ­¥æ­¥åˆ†æ, é¦–å…ˆæ˜¯å®¢æˆ·ç«¯æäº¤ä¸€ä¸ªæŸ¥è¯¢, ç»è¿‡Optiqç”Ÿæˆé€»è¾‘è®¡åˆ’åä¼šäº¤ç»™DrillClientè¿è¡Œ:  </p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * <span class="type">Submits</span> a <span class="type">Logical</span> plan <span class="keyword">for</span> direct execution (bypasses parsing) æäº¤ä¸€ä¸ªé€»è¾‘è®¡åˆ’,ç›´æ¥æ‰§è¡Œ</span><br><span class="line"> * @param plan the plan to execute</span><br><span class="line"> * @<span class="keyword">return</span> a handle <span class="keyword">for</span> the query <span class="literal">result</span></span><br><span class="line"> */</span><br><span class="line">public <span class="type">List</span>&lt;<span class="type">QueryDataBatch</span>&gt; runQuery(<span class="type">QueryType</span> <span class="keyword">type</span>, <span class="type">String</span> plan) throws <span class="type">RpcException</span> &#123;</span><br><span class="line">  <span class="type">UserProtos</span>.<span class="type">RunQuery</span> query = newBuilder().setResultsMode(<span class="type">STREAM_FULL</span>).setType(<span class="keyword">type</span>).setPlan(plan).build();</span><br><span class="line">  <span class="type">ListHoldingResultsListener</span> listener = new <span class="type">ListHoldingResultsListener</span>(query);</span><br><span class="line">  client.submitQuery(listener, query);  //è¿™ä¸ªclientæ˜¯<span class="type">UserClient</span>,è€Œä¸æ˜¯<span class="type">DrillClient</span>äº†</span><br><span class="line">  <span class="keyword">return</span> listener.getResults();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘è®¡åˆ’å°è£…æˆRunQueryåè®®,ç›‘å¬å™¨ListHoldingResultsListenerç”¨äºå½“è·å–åˆ°ç»“æœåé€šçŸ¥å®¢æˆ·ç«¯å¯ä»¥è·å–æ•°æ®äº†.<br>ç›‘å¬å™¨ç”¨Futureæ¥å°è£…æŸ¥è¯¢çš„ç»“æœé›†åˆ,å¦‚æœç»“æœè¿˜æ²¡æœ‰å‡ºæ¥,è°ƒç”¨future.get()ä¼šè¢«é˜»å¡,è¿™æ˜¯Javaçš„Futureè¯­æ³•æœ¬èº«çš„ç‰¹æ€§.  </p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private class <span class="type">ListHoldingResultsListener</span> implements <span class="type">UserResultsListener</span> &#123;</span><br><span class="line">  private <span class="type">Vector</span>&lt;<span class="type">QueryDataBatch</span>&gt; results = new <span class="type">Vector</span>&lt;&gt;();</span><br><span class="line">  private <span class="type">SettableFuture</span>&lt;<span class="type">List</span>&lt;<span class="type">QueryDataBatch</span>&gt;&gt; future = <span class="type">SettableFuture</span>.create();</span><br><span class="line">  private <span class="type">UserProtos</span>.<span class="type">RunQuery</span> query ;  //æäº¤å¤±è´¥æ—¶, åœ¨é‡æ–°è¿æ¥å, ç”±å®¢æˆ·ç«¯é‡æ–°è¿æ¥</span><br><span class="line"></span><br><span class="line">  public <span class="type">void</span> queryCompleted(<span class="type">QueryState</span> state) &#123;</span><br><span class="line">    future.<span class="type">set</span>(results);</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="type">void</span> dataArrived(<span class="type">QueryDataBatch</span> <span class="literal">result</span>, <span class="type">ConnectionThrottle</span> throttle) &#123;</span><br><span class="line">    results.add(<span class="literal">result</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="type">List</span>&lt;<span class="type">QueryDataBatch</span>&gt; getResults() throws <span class="type">RpcException</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> future.get();</span><br><span class="line">  &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserClientä½œä¸ºç”¨æˆ·çš„å®¢æˆ·ç«¯,ä¼šå‘DrillBitå‘é€ä¸€ä¸ªRUN_QUERYçš„è¯·æ±‚, å‘é€å†…å®¹åœ¨RunQuery queryå¯¹è±¡é‡Œ.  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserClient</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BasicClientWithConnection&lt;RpcType</span>, <span class="title">UserToBitHandshake</span>, <span class="title">BitToUserHandshake&gt;</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">QueryResultHandler</span> queryResultHandler = <span class="keyword">new</span> <span class="type">QueryResultHandler</span>();</span><br><span class="line"></span><br><span class="line">  public void submitQuery(<span class="type">UserResultsListener</span> resultsListener, <span class="type">RunQuery</span> query) &#123;</span><br><span class="line">    send(queryResultHandler.getWrappedListener(connection, resultsListener), <span class="type">RpcType</span>.<span class="type">RUN_QUERY</span>, query, <span class="type">QueryId</span>.<span class="keyword">class</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>connectionå¯¹è±¡æ˜¯å®¢æˆ·ç«¯å»ºç«‹çš„åˆ°æœåŠ¡å™¨ç«¯çš„è¿æ¥, åœ¨UserClientçš„çˆ¶ç±»BasicClientçš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºçš„.<br>è¿™é‡Œç”¨çš„æ˜¯Netty, å®¢æˆ·ç«¯åœ¨åˆ›å»ºè¿‡ç¨‹è¿˜ç»‘å®šäº†å¤šä¸ªHandler: åè®®çš„ç¼–è§£ç ,æ¶ˆæ¯çš„ç¼–è§£ç ,<code>InboundHandleråˆ°è¾¾å¤„ç†å™¨</code>,å®¢æˆ·ç«¯æ¡æ‰‹Handler.   </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicClient&lt;T</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">EnumLite</span>, <span class="title">R</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">RemoteConnection</span>, <span class="title">HANDSHAKE_SEND</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">MessageLite</span>, <span class="title">HANDSHAKE_RESPONSE</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">MessageLite&gt;</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">RpcBus&lt;T</span>, <span class="title">R&gt;</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Bootstrap</span> b;</span><br><span class="line">  <span class="keyword">protected</span> <span class="type">R</span> connection;</span><br><span class="line">  public <span class="type">BasicClient</span>(...) &#123;  </span><br><span class="line">    b = <span class="keyword">new</span> <span class="type">Bootstrap</span>()  </span><br><span class="line">        .handler(<span class="keyword">new</span> <span class="type">ChannelInitializer</span>&lt;<span class="type">SocketChannel</span>&gt;() &#123;</span><br><span class="line">          <span class="keyword">protected</span> void initChannel(<span class="type">SocketChannel</span> ch) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">            connection = initRemoteConnection(ch);</span><br><span class="line">            ch.closeFuture().addListener(getCloseHandler(ch, connection));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ChannelPipeline</span> pipe = ch.pipeline();</span><br><span class="line">            pipe.addLast(<span class="string">"protocol-decoder"</span>, getDecoder(connection.getAllocator()));</span><br><span class="line">            pipe.addLast(<span class="string">"message-decoder"</span>, <span class="keyword">new</span> <span class="type">RpcDecoder</span>(<span class="string">"c-"</span> + rpcConfig.getName()));</span><br><span class="line">            pipe.addLast(<span class="string">"protocol-encoder"</span>, <span class="keyword">new</span> <span class="type">RpcEncoder</span>(<span class="string">"c-"</span> + rpcConfig.getName()));</span><br><span class="line">            pipe.addLast(<span class="string">"handshake-handler"</span>, <span class="keyword">new</span> <span class="type">ClientHandshakeHandler</span>());</span><br><span class="line">            pipe.addLast(<span class="string">"message-handler"</span>, <span class="keyword">new</span> <span class="type">InboundHandler</span>(connection));</span><br><span class="line">            pipe.addLast(<span class="string">"exception-handler"</span>, <span class="keyword">new</span> <span class="type">RpcExceptionHandler</span>(connection));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>send()è°ƒç”¨æœ€ç»ˆä¼šè°ƒç”¨RpcBusçš„åŒåsendæ–¹æ³•, ç¬¬ä¸€ä¸ªå‚æ•°listeneræ˜¯Rpcçš„è¾“å‡ºç›‘å¬å™¨(ç›¸å¯¹Incomeåˆ°è¾¾)<br>å…¶ä¸­å‘é€å†…å®¹RunQuery queryæ˜¯protobufBody, æœ€åä¸€ä¸ªå‚æ•°dataBodiesæ˜¯å¯é€‰çš„.   </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The Rpc Bus deals with incoming and outgoing communication and is used on both the server and the client side of a system.</span></span><br><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcBus&lt;T</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">EnumLite</span>, <span class="title">C</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">RemoteConnection&gt;</span> <span class="title">implements</span> <span class="title">Closeable</span> &#123;</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">CoordinationQueue</span> queue = <span class="keyword">new</span> <span class="type">CoordinationQueue</span>(<span class="number">16</span>, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">  public &lt;<span class="type">SEND</span> <span class="keyword">extends</span> <span class="type">MessageLite</span>, <span class="type">RECEIVE</span> <span class="keyword">extends</span> <span class="type">MessageLite</span>&gt; void send(<span class="type">RpcOutcomeListener</span>&lt;<span class="type">RECEIVE</span>&gt; listener, <span class="type">C</span> connection, <span class="type">T</span> rpcType,</span><br><span class="line">      <span class="type">SEND</span> protobufBody, <span class="type">Class</span>&lt;<span class="type">RECEIVE</span>&gt; clazz, boolean allowInEventLoop, <span class="type">ByteBuf</span>... dataBodies) &#123;</span><br><span class="line">      <span class="type">ChannelListenerWithCoordinationId</span> futureListener = queue.get(listener, clazz, connection);</span><br><span class="line">      <span class="type">OutboundRpcMessage</span> m = <span class="keyword">new</span> <span class="type">OutboundRpcMessage</span>(<span class="type">RpcMode</span>.<span class="type">REQUEST</span>, rpcType, futureListener.getCoordinationId(), protobufBody, dataBodies);</span><br><span class="line">      <span class="type">ChannelFuture</span> channelFuture = connection.getChannel().writeAndFlush(m);</span><br><span class="line">      channelFuture.addListener(futureListener);</span><br><span class="line">      channelFuture.addListener(<span class="type">ChannelFutureListener</span>.<span class="type">FIRE_EXCEPTION_ON_FAILURE</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯å‘èµ·çš„ä¸€æ¬¡æŸ¥è¯¢æ˜¯æ€ä¹ˆæäº¤åˆ°æœåŠ¡ç«¯ä¸Šæ‰§è¡Œ: <code>connection.getChannel().writeAndFlush(m)</code><br>å®¢æˆ·ç«¯é€šè¿‡connectionçš„é€šé“å¾€æœåŠ¡ç«¯å†™å…¥ä¸€ä¸ªRpcæ¶ˆæ¯,  Rpcæ¶ˆæ¯åˆ†ä¸ºåˆ°è¾¾Inboudå’Œè¾“å‡ºOutbound.<br>OutboundRpcMessageå«æœ‰protobufåè®®ä½“,ä»¥åŠæ•°æ®éƒ¨åˆ†. åè®®æœ¬èº«åªæ˜¯å®šä¹‰äº†æ•°æ®çš„æ ¼å¼.  çœŸæ­£çš„æ•°æ®ä¹Ÿè¦ä¸€èµ·å‘é€å‡ºå».<br>è™½ç„¶è¿™é‡Œæ˜¯å®¢æˆ·ç«¯çš„æŸ¥è¯¢è¯·æ±‚, dataBodiesæœ¬èº«æ˜¯æ²¡æœ‰å€¼çš„,å› ä¸ºåœ¨ä¸€å¼€å§‹è°ƒç”¨çš„æ—¶å€™å°±æ²¡æœ‰ä¼ å…¥è¿™ä¸ªå‚æ•°.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill10.png" alt=""></p>
<p>åˆ°æ­¤ä¸ºæ­¢, å®¢æˆ·ç«¯å‘èµ·çš„ä¸€æ¬¡æŸ¥è¯¢è¯·æ±‚å·²ç»å®Œæˆäº†, æ¥ä¸‹å»çš„æµç¨‹äº¤ç»™æœåŠ¡ç«¯å¤„ç†è¿™ä¸ªè¯·æ±‚äº†.<br>è¿™é‡Œç”¨åˆ°ä¸€ä¸ªfutureListener, æ˜¯ä¸ºäº†èƒ½å¤Ÿç›‘å¬æœåŠ¡å™¨ç«¯æ˜¯å¦å·²ç»æŠŠæ•°æ®å‡†å¤‡å¥½äº†.<br>è¿™é‡Œçš„queueä¼šå°†CoordinationIdå’ŒRpcListeneræ”¾åˆ°mapä¸­, å¹¶åœ¨æ¥æ”¶åˆ°æ•°æ®åä»mapä¸­ç§»é™¤.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;V&gt; <span class="function">ChannelListenerWithCoordinationId <span class="title">get</span><span class="params">(RpcOutcomeListener&lt;V&gt; <span class="keyword">handler</span>, Class&lt;V&gt; clazz, RemoteConnection connection)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = circularInt.getNext();</span><br><span class="line">  RpcListener&lt;V&gt; future = <span class="keyword">new</span> RpcListener&lt;V&gt;(<span class="keyword">handler</span>, clazz, i, connection);</span><br><span class="line">  Object old = map.put(i, future);</span><br><span class="line">  <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æœåŠ¡ç«¯å¤„ç†Queryè¯·æ±‚">æœåŠ¡ç«¯å¤„ç†Queryè¯·æ±‚</h3><p>æœåŠ¡ç«¯çš„å¯åŠ¨æ–¹å¼å’Œå®¢æˆ·ç«¯ä¸€æ ·éƒ½æ˜¯é€šè¿‡Netty. å¹¶ä¸”éƒ½æ³¨å†Œäº†ä¸€ä¸ªInboundHandler.<br>å› ä¸ºåœ¨ä¸Šä¸€æ­¥å®¢æˆ·ç«¯å‘é€REQUETè¯·æ±‚, æ‰€ä»¥æœåŠ¡å™¨çš„InboundHandlerèƒ½å¤Ÿæ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">InboundHandler</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">MessageToMessageDecoder&lt;InboundRpcMessage&gt;</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">C</span> connection;</span><br><span class="line">  public <span class="type">InboundHandler</span>(<span class="type">C</span> connection) &#123;</span><br><span class="line">    <span class="keyword">this</span>.connection = connection;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> void decode(<span class="keyword">final</span> <span class="type">ChannelHandlerContext</span> ctx, <span class="keyword">final</span> <span class="type">InboundRpcMessage</span> msg, <span class="keyword">final</span> <span class="type">List</span>&lt;<span class="type">Object</span>&gt; output) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Channel</span> channel = connection.getChannel();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Stopwatch</span> watch = <span class="keyword">new</span> <span class="type">Stopwatch</span>().start();</span><br><span class="line"></span><br><span class="line">      switch (msg.mode) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">REQUEST</span>: &#123;</span><br><span class="line">          <span class="comment">// handle message and ack.</span></span><br><span class="line">          <span class="type">ResponseSender</span> sender = <span class="keyword">new</span> <span class="type">ResponseSenderImpl</span>(connection, msg.coordinationId);</span><br><span class="line">          handle(connection, msg.rpcType, msg.pBody, msg.dBody, sender);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒInboundHandlerç»§æ‰¿çš„æ˜¯Nettyçš„MessageToMessageDecoderæŠ½è±¡ç±»,æ‰€ä»¥è¦åœ¨decodeä¸­é‡å†™æ¥æ”¶çš„é€»è¾‘<br>å¦‚æœæ˜¯ç»§æ‰¿Nettyçš„ChannelInboundHandlerAdapter, åˆ™é‡å†™çš„æ–¹æ³•æ˜¯channelRead, åé¢è¿™ç§åœ¨nettyçš„helloworldä¸­æ¯”è¾ƒå¸¸è§.<br>ä¸ºä»€ä¹ˆéœ€è¦ResponseSender, å› ä¸ºæœåŠ¡ç«¯æ¥æ”¶å®¢æˆ·ç«¯çš„æŸ¥è¯¢è¯·æ±‚, åœ¨è·å–åˆ°ç»“æœå, è¦è´Ÿè´£å°†ç»“æœresponseå‘é€sendç»™å®¢æˆ·ç«¯æ‰ç®—å®Œæˆ.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(C connection, <span class="keyword">int</span> rpcType, ByteBuf pBody, ByteBuf dBody, ResponseSender sender)</span> <span class="keyword">throws</span> RpcException</span>&#123;</span><br><span class="line">  sender.send(handle(connection, rpcType, pBody, dBody));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function">Response <span class="title">handle</span><span class="params">(C connection, <span class="keyword">int</span> rpcType, ByteBuf pBody, ByteBuf dBody)</span> <span class="keyword">throws</span> RpcException</span>;</span><br></pre></td></tr></table></figure>
<p>handleæ˜¯ä¸ªæŠ½è±¡æ–¹æ³•,  è¿™é‡Œå› ä¸ºåœ¨Serverä¸­äº†, æ‰€ä»¥é€‰æ‹©UserServerçš„å®ç°æ–¹æ³•. å®¢æˆ·ç«¯ä¼ å…¥çš„rpcType=RUN_QUERYç­‰äºä¸‹é¢çš„RUN_QUERY_VALUE</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill11.png" alt=""></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserServer</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">BasicServer&lt;RpcType</span>, <span class="title">UserServer</span>.<span class="title">UserClientConnection&gt;</span> &#123;</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">UserWorker</span> worker;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">Response</span> handle(<span class="type">UserClientConnection</span> connection, int rpcType, <span class="type">ByteBuf</span> pBody, <span class="type">ByteBuf</span> dBody)&#123;</span><br><span class="line">    switch (rpcType) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">RpcType</span>.<span class="type">RUN_QUERY_VALUE</span>:</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RunQuery</span> query = <span class="type">RunQuery</span>.<span class="type">PARSER</span>.parseFrom(<span class="keyword">new</span> <span class="type">ByteBufInputStream</span>(pBody));</span><br><span class="line">        <span class="keyword">final</span> <span class="type">QueryId</span> queryId = worker.submitWork(connection, query);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">Response</span>(<span class="type">RpcType</span>.<span class="type">QUERY_HANDLE</span>, queryId);</span><br></pre></td></tr></table></figure>
<p>DrillClientå°†æŸ¥è¯¢äº¤ç»™UserClient, UserServeråˆ™å°†å…·ä½“çš„æŸ¥è¯¢å·¥ä½œäº¤ç»™äº†UserWorker, å®ƒçš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªQueryIdåè®®.<br>æœ€ç»ˆçš„è¿”å›å€¼æ˜¯Response, å¯¹åº”äº†RpcBusçš„sender.send(handle(â€¦)) â€“&gt; sender.send(Response)  </p>
<p>æ³¨æ„æœåŠ¡ç«¯æ¥å—åˆ°æŸ¥è¯¢è¯·æ±‚RUN_QUERYå, äº¤ç»™workerå¤„ç†, workerä¼šç«‹å³è¿”å›è¿™ä¸ªæŸ¥è¯¢å¯¹åº”çš„QueryId. å› æ­¤ä¹Ÿä¸æ˜¯ç«‹å³è¿”å›ç»“æœçš„<br>çœ‹ä¸‹æœåŠ¡ç«¯çš„ResponseSenderçš„å®ç°ç±», å®šä¹‰åœ¨RpcBusä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseSenderImpl</span> <span class="keyword">implements</span> <span class="title">ResponseSender</span> </span>&#123;</span><br><span class="line">  RemoteConnection connection;</span><br><span class="line">  <span class="keyword">int</span> coordinationId;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ResponseSenderImpl</span><span class="params">(RemoteConnection connection, <span class="keyword">int</span> coordinationId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.connection = connection;</span><br><span class="line">    <span class="keyword">this</span>.coordinationId = coordinationId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Response r)</span> </span>&#123;</span><br><span class="line">    OutboundRpcMessage outMessage = <span class="keyword">new</span> OutboundRpcMessage(RpcMode.RESPONSE, r.rpcType, coordinationId, r.pBody, r.dBodies);</span><br><span class="line">    connection.getChannel().writeAndFlush(outMessage);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œçš„coordinationIdæ˜¯å®¢æˆ·ç«¯æ”¾å…¥queueé˜Ÿåˆ—ä¸­futureListenerçš„ä¸€ä¸ªç¼–å·.  è€ŒæœåŠ¡ç«¯è¿”å›çš„QueryIdæ˜¯r.pBody.<br>æœåŠ¡ç«¯ä¹Ÿå°†OutboundRpcMessageé€šè¿‡connectioné€šé“å†™å›å». å³å†™åˆ°å®¢æˆ·ç«¯å», å› ä¸ºæœåŠ¡ç«¯å¹¶æ²¡æœ‰å°†æŸ¥è¯¢ç»“æœç«‹å³è®¡ç®—å‡ºæ¥,<br>æ‰€ä»¥éœ€è¦å°†QueryIdè¿”å›ç»™å®¢æˆ·ç«¯, å¹¶åœ¨é€‚å½“çš„æ—¶å€™å¦‚æœæœåŠ¡ç«¯è·å–åˆ°ç»“æœä¼šé€šçŸ¥å®¢æˆ·ç«¯.  </p>
<p>æœåŠ¡ç«¯å‘é€çš„æ˜¯Response, æ‰€ä»¥ç°åœ¨æœåŠ¡ç«¯çš„æµç¨‹å·²ç»èµ°å®Œäº†(è™½ç„¶workerè¿˜æ²¡æœ‰å®Œæˆ,ä½†æ˜¯å¯¹äºä¸€æ¬¡RPCæ¥è¯´æ˜¯å®Œæˆäº†), è½®åˆ°å®¢æˆ·ç«¯æ¥æ”¶å“åº”.  </p>
<h3 id="å®¢æˆ·ç«¯è·å–æŸ¥è¯¢ç»“æœ">å®¢æˆ·ç«¯è·å–æŸ¥è¯¢ç»“æœ</h3><p>è¿˜æ˜¯åœ¨RpcBusçš„InboundHandlerä¸­.  åªä¸è¿‡è¿™æ¬¡æ˜¯å®¢æˆ·ç«¯æ¥å—åˆ°æœåŠ¡ç«¯å‘é€çš„å“åº”è¯·æ±‚:  </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RESPONSE:</span><br><span class="line">    MessageLite m = getResponseDefaultInstance(msg.rpcType);  <span class="comment">//è¿™é‡Œæ˜¯QueryId</span></span><br><span class="line">    RpcOutcome&lt;?&gt; rpcFuture = queue.getFuture(msg.rpcType, msg.coordinationId, m.getClass());  <span class="comment">//å¯¹åº”ä¸€å¼€å§‹çš„queue.get(...)</span></span><br><span class="line">    Parser&lt;?&gt; parser = m.getParserForType();</span><br><span class="line">    Object <span class="keyword">value</span> = parser.parseFrom(<span class="keyword">new</span> ByteBufInputStream(msg.pBody, msg.pBody.readableBytes()));  <span class="comment">//pBodyåªæ˜¯åè®®æ ¼å¼</span></span><br><span class="line">    rpcFuture.<span class="keyword">set</span>(<span class="keyword">value</span>, msg.dBody);  <span class="comment">//dBodyæ‰æ˜¯æ•°æ®å†…å®¹</span></span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>ä»é˜Ÿåˆ—ä¸­è·å–Future, æœ€åè°ƒç”¨futureçš„setæ–¹æ³•, å°†æ•°æ®è®¾ç½®åˆ°valueä¸­, è¿™æ ·future.get()å°±èƒ½è·å–åˆ°value.  </p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;V&gt; RpcOutcome&lt;V&gt; getFuture(<span class="keyword">int</span> rpcType, <span class="keyword">int</span> coordinationId, <span class="class"><span class="keyword">Class</span>&lt;<span class="title">V</span>&gt; <span class="title">clazz</span>) </span>&#123;</span><br><span class="line">  RpcOutcome&lt;?&gt; rpc = map.remove(coordinationId);</span><br><span class="line">  <span class="keyword">return</span> (RpcOutcome&lt;V&gt;) rpc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Listener_&amp;_Handler">Listener &amp; Handler</h3><table>
<thead>
<tr>
<th>Step</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td>DrillClient.runQuery:</td>
<td>ListHoldingResultsListener</td>
</tr>
<tr>
<td>UserClient.submitQuery:</td>
<td>é€šè¿‡QueryResultHandlerå°†ListHoldingResultsListener&gt;&gt;UserResultsListenerå°è£…ä¸ºSubmissionListener&gt;&gt;RpcOutcomeListener</td>
</tr>
<tr>
<td>RpcBus.send:</td>
<td>å°†RpcOutcomeListenerå°è£…ä¸ºChannelListenerWithCoordinationId&lt;<rpclistener>&gt;RpcOutcome</rpclistener></td>
</tr>
<tr>
<td>InboundHandler.RESPONSE:</td>
<td>ä»é˜Ÿåˆ—ä¸­è·å–RpcOutcome rpcFuture, è®¾ç½®æ•°æ®åˆ°value</td>
</tr>
<tr>
<td>RpcListener.set:</td>
<td>è°ƒç”¨RpcOutcomeListener.success, å³SubmissionListener.success: æ·»åŠ UserResultsListenerè´Ÿè´£ç›‘å¬ç»“æœ</td>
</tr>
<tr>
<td>ListHoldingResultsListener.getResults:</td>
<td>ä»Futureä¸­è·å–ç»“æœ</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Object</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>ListHoldingResultsListener</td>
<td>æŒæœ‰ç»“æœé›†çš„ç›‘å¬å™¨, æ‰€ä»¥è´Ÿè´£æœ€ç»ˆç»“æœçš„è·å–,å½“ç„¶è·å–æ“ä½œä¸åœ¨è¿™é‡Œ, å®ƒåªç®¡å–æ•°æ®</td>
</tr>
<tr>
<td>SubmissionListener</td>
<td>æäº¤ç›‘å¬å™¨, ä½œä¸šæäº¤å, æˆ‘è´Ÿè´£æ‰§è¡Œ, ä½†æ˜¯æ‰§è¡Œçš„åŠ¨ä½œå¹¶ä¸åœ¨è¿™é‡Œå“¦</td>
</tr>
<tr>
<td>UserResultsListener</td>
<td>ç”¨æˆ·çš„ç»“æœé›†ç›‘å¬å™¨, è¿™é‡Œåº”è¯¥æ˜¯è´Ÿè´£ç»“æœçš„äº§ç”Ÿ, ä¸è¿‡å®ƒæ˜¯ä¸ªæ¥å£</td>
</tr>
<tr>
<td>RpcListener</td>
<td>RPCç›‘å¬å™¨,è¦å’Œå…·ä½“æœ¬æ¬¡æŸ¥è¯¢çš„coordinationIdå…³è”èµ·æ¥</td>
</tr>
</tbody>
</table>
<p>ç”¨æˆ·çš„ç»“æœé›†ç›‘å¬å™¨çš„æ–¹æ³•è¡¨ç¤ºäº†æŸ¥è¯¢çš„ä¸€ä¸ªè¿‡ç¨‹:<br>1.QueryIdåˆ°è¾¾, ç”±æœåŠ¡ç«¯äº§ç”ŸQueryId<br>2.æ•°æ®åˆ°è¾¾, å¹¶è¢«ç›‘å¬å™¨æˆåŠŸæ¥æ”¶åˆ°<br>3.æŸ¥è¯¢å®Œæ¯•, ç›‘å¬å™¨ä¸ä¼šå†æ”¶åˆ°ä»»ä½•æ•°æ®</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">interface</span> <span class="type">UserResultsListener</span> &#123;</span><br><span class="line">  /**</span><br><span class="line">   * <span class="type">QueryId</span> <span class="keyword">is</span> available. <span class="type">Called</span> <span class="keyword">when</span> a query <span class="keyword">is</span> successfully submitted to the server.</span><br><span class="line">   * @param queryId sent by the server along &#123;@link org.apache.drill.exec.rpc.<span class="type">Acks</span>.<span class="type">OK</span> <span class="type">Acks</span>.<span class="type">OK</span>&#125;</span><br><span class="line">   */</span><br><span class="line">  <span class="type">void</span> queryIdArrived(<span class="type">QueryId</span> queryId);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> submissionFailed(<span class="type">UserException</span> ex);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * A &#123;@link org.apache.drill.exec.proto.beans.<span class="type">QueryData</span> <span class="type">QueryData</span>&#125; message was received</span><br><span class="line">   * @param <span class="literal">result</span> data batch received</span><br><span class="line">   */</span><br><span class="line">  <span class="type">void</span> dataArrived(<span class="type">QueryDataBatch</span> <span class="literal">result</span>, <span class="type">ConnectionThrottle</span> throttle);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * <span class="type">The</span> query has completed (successsful completion <span class="keyword">or</span> cancellation). <span class="type">The</span> listener will <span class="keyword">not</span> receive <span class="type">any</span> other</span><br><span class="line">   * data <span class="keyword">or</span> <span class="literal">result</span> message. <span class="type">Called</span> <span class="keyword">when</span> the server returns a terminal-non failing- state (<span class="type">COMPLETED</span> <span class="keyword">or</span> <span class="type">CANCELLED</span>)</span><br><span class="line">   */</span><br><span class="line">  <span class="type">void</span> queryCompleted(<span class="type">QueryState</span> state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-10-drill-log" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-10-drill-log/" class="article-date">
  	<time datetime="2015-12-01T10:20:50.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-10-drill-log/">Apache Drillæºç é˜…è¯»(1) ç¯å¢ƒå‡†å¤‡å’ŒæŸ¥çœ‹æ—¥å¿—</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2><p>ä¿®æ”¹logback.xmlçš„æ—¥å¿—çº§åˆ«ä¸ºdebug</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name=<span class="string">"org.apache.drill"</span> additivity=<span class="string">"false"</span>&gt;</span><br><span class="line">  &lt;level value=<span class="string">"debug"</span> /&gt;</span><br><span class="line">  &lt;appender-<span class="keyword">ref</span> <span class="keyword">ref</span>=<span class="string">"FILE"</span> /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">&lt;logger name=<span class="string">"query.logger"</span> additivity=<span class="string">"false"</span>&gt;</span><br><span class="line">  &lt;level value=<span class="string">"debug"</span> /&gt;</span><br><span class="line">  &lt;appender-<span class="keyword">ref</span> <span class="keyword">ref</span>=<span class="string">"QUERY"</span> /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;</span><br><span class="line">  &lt;level value=<span class="string">"debug"</span> /&gt;</span><br><span class="line">  &lt;appender-<span class="keyword">ref</span> <span class="keyword">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å•æœºæ¨¡å¼,è€Œä¸æ˜¯é›†ç¾¤æ¨¡å¼. å¯åŠ¨<code>drill-embedded</code>  </p>
<p>é™¤äº†åœ¨ä¸Šé¢çš„drill-embeddedè§‚å¯Ÿè¾“å‡º, è¿˜è¦è§‚å¯Ÿlogç›®å½•ä¸‹çš„sqlline.logæ–‡ä»¶</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">41</span>,<span class="number">636</span> [main] DEBUG o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Construction started.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">481</span> [main] INFO  o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Construction completed (<span class="number">845</span> ms).</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">481</span> [main] DEBUG o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Startup begun.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">481</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.c</span><span class="class">.l</span><span class="class">.LocalClusterCoordinator</span> - Local Cluster Coordinator started.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">607</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.rpc</span><span class="class">.user</span><span class="class">.UserServer</span> - Server of type UserServer started on port <span class="number">31010</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">650</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.exec</span><span class="class">.rpc</span><span class="class">.control</span><span class="class">.ControlServer</span> - Server of type ControlServer started on port <span class="number">31011</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">688</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.rpc</span><span class="class">.data</span><span class="class">.DataServer</span> - Server of type DataServer started on port <span class="number">31012</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">924</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.common</span><span class="class">.util</span><span class="class">.PathScanner</span> - Classpath scanning took <span class="number">60ms</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">42</span>,<span class="number">924</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.p</span><span class="class">.base</span><span class="class">.PhysicalOperatorUtil</span> - Adding Physical Operator sub types: .................</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">43</span>,<span class="number">047</span> [main] DEBUG org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.common</span><span class="class">.JSONOptions</span> - Creating Deserializer.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">43</span>,<span class="number">146</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.p</span><span class="class">.i</span><span class="class">.OperatorCreatorRegistry</span> - Adding Operator Creator map:..............</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">43</span>,<span class="number">385</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.e</span><span class="class">.f</span><span class="class">.FunctionImplementationRegistry</span> - Generating function registry.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">48</span>,<span class="number">643</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.s</span><span class="class">.h</span><span class="class">.HBaseStoragePluginConfig</span> - Initializing HBase StoragePlugin configuration with zookeeper quorum <span class="string">'localhost'</span>, port <span class="string">'2181'</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">48</span>,<span class="number">977</span> [main] DEBUG o<span class="class">.a</span><span class="class">.d</span><span class="class">.e</span><span class="class">.c</span><span class="class">.l</span><span class="class">.LocalClusterCoordinator</span> - Endpoint registered <span class="tag">address</span>: <span class="string">"localhost"</span></span><br><span class="line">user_port: <span class="number">31010</span></span><br><span class="line">control_port: <span class="number">31011</span></span><br><span class="line">data_port: <span class="number">31012</span></span><br><span class="line">.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">51</span>,<span class="number">700</span> [main] INFO  o<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span> - Startup completed (<span class="number">9218</span> ms).</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">51</span>,<span class="number">741</span> [main] DEBUG o<span class="class">.a</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.client</span><span class="class">.DrillClient</span> - Connecting to server localhost:<span class="number">31010</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å‘½ä»¤è¡Œæ‰§è¡Œdrill-embedded, ä¼šè¿æ¥åˆ°æœ¬åœ°çš„Drill Serverä¸Š.</p>
<p>åœ¨sqllineä¸Šæ‰§è¡Œä¸€æ¡SQLå‘½ä»¤, å¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨çš„æ˜¯FragmentExecutorçº¿ç¨‹çš„runæ–¹æ³•:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: <span class="string">jdbc:</span><span class="string">drill:</span>zk=local&gt; select count(*) from cp.`employee.json`;</span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">02.300</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-<span class="string">a01023a1319a:</span>foreman] DEBUG o.a.h.security.UserGroupInformation - PrivilegedAction <span class="string">as:</span>zhengqh (<span class="string">auth:</span>SIMPLE) <span class="string">from:</span>org.apache.drill.exec.util.ImpersonationUtil.createFileSystem(ImpersonationUtil.<span class="string">java:</span><span class="number">141</span>)</span><br><span class="line"><span class="number">11</span>:<span class="number">22</span>:<span class="number">02.390</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-<span class="string">a01023a1319a:</span><span class="string">frag:</span><span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.h.security.UserGroupInformation - PrivilegedAction <span class="string">as:</span>zhengqh (<span class="string">auth:</span>SIMPLE) <span class="string">from:</span>org.apache.drill.exec.work.fragment.FragmentExecutor.run(FragmentExecutor.<span class="string">java:</span><span class="number">255</span>)</span><br><span class="line">+---------+</span><br><span class="line">| EXPR$<span class="number">0</span>  |</span><br><span class="line">+---------+</span><br><span class="line">| <span class="number">1155</span>    |</span><br><span class="line">+---------+</span><br><span class="line"><span class="number">1</span> row selected (<span class="number">0.221</span> seconds)</span><br></pre></td></tr></table></figure>
<h2 id="æ—¥å¿—åˆ†æ">æ—¥å¿—åˆ†æ</h2><p>sqlline.logæ—¥å¿—æˆ‘ä»¬ä¸€æ®µä¸€æ®µåœ°åˆ†æ</p>
<p>é¦–å…ˆæ³¨å†ŒæŸ¥è¯¢è¯­å¥, å³åœ¨sqllineè¾“å…¥çš„sqlè¯­å¥, ä¼šåˆ†é…ä¸€ä¸ªquery-id. è®¿é—®<a href="http://localhost:8047/profiles" target="_blank" rel="external">http://localhost:8047/profiles</a>å¯ä»¥æ‰¾åˆ°è¿™ä¸ªQuery Job.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">257</span> [main] DEBUG o.a.d.j.impl.DrillStatementRegistry - Adding to open-statements registry: org.apache.drill.jdbc.impl.DrillStatementImpl@<span class="number">4</span>eb2bb3d</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">258</span> [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Query listener created.</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">259</span> [UserServer-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserServer - Received query to run.  Returning query handle.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">273</span> [UserServer-<span class="number">1</span>] DEBUG o.a.d.exec.memory.TopLevelAllocator - New child allocator with initial reservation <span class="number">1048576</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">274</span> [UserServer-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserServer - Sending response with Sender <span class="number">575856913</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">275</span> [Client-<span class="number">1</span>] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Received query ID: <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a.</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">276</span> [Client-<span class="number">1</span>] DEBUG o.a.d.e.rpc.user.QueryResultHandler - Received QueryId <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a successfully. Adding results listener org.apache.drill.jdbc.impl.DrillResultSetImpl$ResultsListener@<span class="number">6f</span>3634b1.</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨äº†Optiqç”ŸæˆLogicalé€»è¾‘è®¡åˆ’, æŸ¥çœ‹SQLè¯­å¥å¯¹åº”çš„é€»è¾‘è®¡åˆ’/ç‰©ç†è®¡åˆ’æ˜¯ä»ä¸‹åˆ°ä¸Šçš„, æ¯”å¦‚ä¸‹é¢çš„TableScan-&gt;Project-&gt;Aggregate<br>å¯¹äº<code>SELECT COUNT(COLUMN) FOME TABLE</code>, å®é™…ä¸Šé€»è¾‘è®¡åˆ’çš„é¡ºåºæ˜¯:<br>FROM TABLE(TableScanæ‰«æ) -&gt; SELECT COLUMN(Projectæ˜ å°„) -&gt; COUNT(Aggregateèšåˆè®¡ç®—)  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">315</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Optiq Logical :</span><br><span class="line">LogicalAggregate(group=[&#123;&#125;], EXPR$<span class="number">0</span>=[COUNT()]): rowcount = <span class="number">10.0</span>, cumulative cost = &#123;<span class="number">211.25</span> rows, <span class="number">201.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">211</span></span><br><span class="line">  LogicalProject($f0=[<span class="number">0</span>]): rowcount = <span class="number">100.0</span>, cumulative cost = &#123;<span class="number">200.0</span> rows, <span class="number">201.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">209</span></span><br><span class="line">    EnumerableTableScan(table=[[cp, employee.json]]): rowcount = <span class="number">100.0</span>, cumulative cost = &#123;<span class="number">100.0</span> rows, <span class="number">101.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> memory&#125;, id = <span class="number">205</span></span><br></pre></td></tr></table></figure>
<p>Optiqçš„é€»è¾‘è®¡åˆ’æœ€ç»ˆä¼šå½¢æˆDrillçš„é€»è¾‘è®¡åˆ’,å†åˆ°Drillçš„ç‰©ç†è®¡åˆ’: Drill Logial -&gt; Drill Physicalçš„è¿‡ç¨‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,320 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - Took 0 ms to build endpoint map</span><br><span class="line">2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - FileWork group (classpath:/employee.json,0) max bytes 474631</span><br><span class="line">2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - Took 2 ms to <span class="operator"><span class="keyword">set</span> endpoint <span class="keyword">bytes</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">323</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] INFO  o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.s.schedule.BlockMapBuilder - <span class="keyword">Get</span> <span class="keyword">block</span> maps: Executed <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span> <span class="keyword">using</span> <span class="number">1</span> threads. <span class="keyword">Time</span>: <span class="number">2</span>ms total, <span class="number">2.240000</span>ms <span class="keyword">avg</span>, <span class="number">2</span>ms <span class="keyword">max</span>.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">323</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] INFO  o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.s.schedule.BlockMapBuilder - <span class="keyword">Get</span> <span class="keyword">block</span> maps: Executed <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span> <span class="keyword">using</span> <span class="number">1</span> threads. Earliest <span class="keyword">start</span>: <span class="number">1.000000</span> Î¼s, Latest <span class="keyword">start</span>: <span class="number">1.000000</span> Î¼s, Average <span class="keyword">start</span>: <span class="number">1.000000</span> Î¼s .</span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">324</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.s.schedule.AffinityCreator - <span class="keyword">Work</span>: [<span class="keyword">File</span>: classpath:/employee.<span class="keyword">json</span> <span class="keyword">start</span>: <span class="number">0</span> <span class="keyword">length</span>: <span class="number">474630</span>] Endpoint: localhost <span class="keyword">Bytes</span>: <span class="number">474630</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">324</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.s.schedule.AffinityCreator - Endpoint localhost has affinity <span class="number">1.0</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">324</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.s.schedule.AffinityCreator - Took <span class="number">0</span> ms <span class="keyword">to</span> <span class="keyword">get</span> <span class="keyword">operator</span> affinity</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">329</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.<span class="keyword">p</span>.s.h.DefaultSqlHandler - VolCalciteRel :</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">331</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.<span class="keyword">p</span>.s.h.DefaultSqlHandler - HepCalciteRel :</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">333</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.<span class="keyword">p</span>.s.h.DefaultSqlHandler - Drill <span class="keyword">Logical</span> :</span><br><span class="line">DrillScreenRel: rowcount = <span class="number">1.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">927.1</span> <span class="keyword">rows</span>, <span class="number">1853.1</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">239</span></span><br><span class="line">  DrillAggregateRel(<span class="keyword">group</span>=[&#123;&#125;], EXPR$<span class="number">0</span>=[<span class="keyword">COUNT</span>()]): rowcount = <span class="number">1.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">927.0</span> <span class="keyword">rows</span>, <span class="number">1853.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">236</span></span><br><span class="line">    DrillProjectRel($f0=[<span class="number">0</span>]): rowcount = <span class="number">463.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">926.0</span> <span class="keyword">rows</span>, <span class="number">1852.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">234</span></span><br><span class="line">      DrillScanRel(<span class="keyword">table</span>=[[cp, employee.<span class="keyword">json</span>]], groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.<span class="keyword">json</span>, numFiles=<span class="number">1</span>, <span class="keyword">columns</span>=[<span class="string">`*`</span>], files=[classpath:/employee.<span class="keyword">json</span>]]]): rowcount = <span class="number">463.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">463.0</span> <span class="keyword">rows</span>, <span class="number">0.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">222</span></span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">368</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.<span class="keyword">d</span>.<span class="keyword">e</span>.<span class="keyword">p</span>.s.h.DefaultSqlHandler - Drill <span class="keyword">Physical</span> :</span><br><span class="line"><span class="number">00</span>-<span class="number">00</span>    Screen : rowType = RecordType(<span class="built_in">BIGINT</span> EXPR$<span class="number">0</span>): rowcount = <span class="number">1.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">1389.1</span> <span class="keyword">rows</span>, <span class="number">7408.1</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">317</span></span><br><span class="line"><span class="number">00</span>-<span class="number">01</span>      StreamAgg(<span class="keyword">group</span>=[&#123;&#125;], EXPR$<span class="number">0</span>=[<span class="keyword">COUNT</span>()]) : rowType = RecordType(<span class="built_in">BIGINT</span> EXPR$<span class="number">0</span>): rowcount = <span class="number">1.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">1389.0</span> <span class="keyword">rows</span>, <span class="number">7408.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">316</span></span><br><span class="line"><span class="number">00</span>-<span class="number">02</span>        <span class="keyword">Project</span>($f0=[<span class="number">0</span>]) : rowType = RecordType(<span class="built_in">INTEGER</span> $f0): rowcount = <span class="number">463.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">926.0</span> <span class="keyword">rows</span>, <span class="number">1852.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">315</span></span><br><span class="line"><span class="number">00</span>-<span class="number">03</span>          <span class="keyword">Scan</span>(groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.<span class="keyword">json</span>, numFiles=<span class="number">1</span>, <span class="keyword">columns</span>=[<span class="string">`*`</span>], files=[classpath:/employee.<span class="keyword">json</span>]]]) : rowType = RecordType(): rowcount = <span class="number">463.0</span>, cumulative <span class="keyword">cost</span> = &#123;<span class="number">463.0</span> <span class="keyword">rows</span>, <span class="number">0.0</span> cpu, <span class="number">0.0</span> io, <span class="number">0.0</span> network, <span class="number">0.0</span> <span class="keyword">memory</span>&#125;, <span class="keyword">id</span> = <span class="number">314</span></span></span><br></pre></td></tr></table></figure>
<p>è®¿é—®<a href="http://localhost:8047/profiles/2a60c5a4-e01a-ac02-84fd-a01023a1319a" target="_blank" rel="external">http://localhost:8047/profiles/2a60c5a4-e01a-ac02-84fd-a01023a1319a</a>æŸ¥çœ‹è¿™ä¸ªä½œä¸šçš„ç‰©ç†è®¡åˆ’<br>å¯ä»¥çœ‹åˆ°ç‰©ç†è®¡åˆ’ä»ä¸‹åˆ°ä¸Šçš„é¡ºåºæ˜¯: Scan-&gt;Project-&gt;StreamAgg. å› ä¸ºç‰©ç†è®¡åˆ’å®é™…ä¸Šæ˜¯ä»é€»è¾‘è®¡åˆ’è®¡ç®—å‡ºæ¥çš„.    </p>
<p>ç„¶åä¼šè¾“å‡ºè¯¦ç»†çš„jsonæ ¼å¼çš„è®¡åˆ’.  graphæœ‰å‡ ä¸ªå­—æ®µpopä»£è¡¨æ“ä½œç±»å‹,@idæ˜¯ç¼–å·,childæ˜¯VisualizedPlanæ ‘ä»ä¸Šåˆ°ä¸‹ç¬¬å‡ å±‚.<br>graphåŸŸçš„fs-scanä»£è¡¨æ‰«ææ–‡ä»¶ç³»ç»Ÿ,æ‰«ææ‰€æœ‰åˆ—*; projectæ˜ å°„å­—æ®µ,$f0å®é™…ä¸Šå°±æ˜¯columnsä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µ;<br>streaming-aggregateçš„è®¡ç®—è¡¨è¾¾å¼count(1), æœ€åé€šè¿‡screenè¾“å‡º    </p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹Webé¡µé¢çš„å¯è§†åŒ–è®¡åˆ’æ•°, å…ˆæ¥ä¸ªæ¯”è¾ƒç›´è§‚çš„æ˜ è±¡<br>ä»¥Scan 00-03ä¸ºä¾‹,00æ˜¯major id,03æ˜¯fs-scançš„@id=3</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill1.png" alt=""></p>
<p>ä¸‹é¢ä¸åŒçš„pop,å¯¹åº”çš„metadataä¹Ÿä¸ä¸€æ ·, æ¯”å¦‚projectæ˜ å°„éœ€è¦è¡¨è¾¾å¼,å› ä¸ºé€‰æ‹©ä¸€ä¸ªåˆ—,æ˜¯å¯ä»¥åœ¨åˆ—ä¸Šåšè®¡ç®—çš„  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">370</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Plan :</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"head"</span> : &#123;</span><br><span class="line">    <span class="string">"version"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"generator"</span> : &#123;</span><br><span class="line">      <span class="string">"type"</span> : <span class="string">"DefaultSqlHandler"</span>,</span><br><span class="line">      <span class="string">"info"</span> : <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"APACHE_DRILL_PHYSICAL"</span>,</span><br><span class="line">    <span class="string">"options"</span> : [ ],</span><br><span class="line">    <span class="string">"queue"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">"resultMode"</span> : <span class="string">"EXEC"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"graph"</span> : [ &#123;</span><br><span class="line">    <span class="string">"pop"</span> : <span class="string">"fs-scan"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="string">"userName"</span> : <span class="string">"zhengqh"</span>,</span><br><span class="line">    <span class="string">"files"</span> : [ <span class="string">"classpath:/employee.json"</span> ],</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">"columns"</span> : [ <span class="string">"`*`"</span> ],</span><br><span class="line">    <span class="string">"selectionRoot"</span> : <span class="string">"classpath:/employee.json"</span>,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"pop"</span> : <span class="string">"project"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"exprs"</span> : [ &#123;</span><br><span class="line">      <span class="string">"ref"</span> : <span class="string">"`$f0`"</span>,</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"0"</span></span><br><span class="line">    &#125; ],</span><br><span class="line">    <span class="string">"child"</span> : <span class="number">3</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"pop"</span> : <span class="string">"streaming-aggregate"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"child"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"keys"</span> : [ ],</span><br><span class="line">    <span class="string">"exprs"</span> : [ &#123;</span><br><span class="line">      <span class="string">"ref"</span> : <span class="string">"`EXPR$0`"</span>,</span><br><span class="line">      <span class="string">"expr"</span> : <span class="string">"count(1) "</span></span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="string">"pop"</span> : <span class="string">"screen"</span>,</span><br><span class="line">    <span class="string">"@id"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="string">"child"</span> : <span class="number">1</span></span><br><span class="line">  &#125; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Drillçš„æ‰§è¡Œå¼•æ“ä¼šå°†é€»è¾‘è®¡åˆ’ç»„æˆä¸€ä¸ªFragmentæ ‘. ä¸‹é¢æ˜¯Root Fragment.<br>å¯¹ç…§WebUI, è¿™ä¸ªQueryåœ¨æœ¬åœ°æµ‹è¯•æ—¶,åªç”Ÿæˆäº†ä¸€ä¸ªFragment.<br>Root Fragmentçš„majorå’Œminor idéƒ½æ˜¯0.  ä¸‹é¢çš„fragment_jsonå’Œä¸Šé¢graphä¸åŒçš„æ˜¯å®ƒæ˜¯åµŒå¥—çš„.  </p>
<blockquote>
<p>ä¸ºä»€ä¹ˆå¯è§†åŒ–çš„Planå¯¹åº”çš„graphæ˜¯æ‰å¹³çš„,è€ŒRoot Fragmentæ˜¯åµŒå¥—çš„?<br>å¯ä»¥è¿™ä¹ˆç†è§£: å¦‚æœå›¾çš„ç»“æ„æ˜¯åµŒå¥—çš„,é‚£ä¹ˆå°±è¦åœ¨Screenè¿™ä¸ªç»„ä»¶é‡Œç”»ä¸Šstreaming-aggregate<br>å¹¶åœ¨streaming-aggregateé‡Œå†ç”»ä¸Šproject,ä»¥æ­¤ç±»æ¨,å°±ä¸å«å›¾äº†,å›¾æ˜¯ä¸€ä¸ªDAGæœ‰å‘æ— ç¯å›¾.<br>è€Œæ ‘å¦‚æœæ˜¯æ‰å¹³çš„,åˆ™åªèƒ½åƒä¸Šé¢çš„å›¾ä¸€æ ·ä¸€ç›´ä¸‹å»,æ²¡æœ‰åˆ†æ”¯. ä½¿ç”¨åµŒå¥—,å°±æœ‰äº†åˆ†æ”¯çš„æ¦‚å¿µäº†.  </p>
</blockquote>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">372</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AssignmentCreator - Took <span class="number">0</span> ms <span class="keyword">to</span> assign <span class="number">1</span> work units <span class="keyword">to</span> <span class="number">1</span> fragments</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">378</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84</span>fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.f.SimpleParallelizer - Root fragment:</span><br><span class="line"> handle &#123;</span><br><span class="line">  query_id &#123;</span><br><span class="line">    part1: <span class="number">3053657859282349058</span></span><br><span class="line">    part2: -<span class="number">8863752500417580646</span></span><br><span class="line">  &#125;</span><br><span class="line">  major_fragment_id: <span class="number">0</span></span><br><span class="line">  minor_fragment_id: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">fragment_json: <span class="string">"&#123;</span><br><span class="line">  "</span>pop<span class="string">" : "</span>screen<span class="string">",</span><br><span class="line">  "</span>@id<span class="string">" : 0,</span><br><span class="line">  "</span>child<span class="string">" : &#123;</span><br><span class="line">    "</span>pop<span class="string">" : "</span>streaming-aggregate<span class="string">",</span><br><span class="line">    "</span>@id<span class="string">" : 1,</span><br><span class="line">    "</span>child<span class="string">" : &#123;</span><br><span class="line">      "</span>pop<span class="string">" : "</span>project<span class="string">",</span><br><span class="line">      "</span>@id<span class="string">" : 2,</span><br><span class="line">      "</span>exprs<span class="string">" : [ &#123;</span><br><span class="line">        "</span>ref<span class="string">" : "</span>`<span class="variable">$f0</span>`<span class="string">",</span><br><span class="line">        "</span>expr<span class="string">" : "</span><span class="number">0</span><span class="string">"</span><br><span class="line">      &#125; ],</span><br><span class="line">      "</span>child<span class="string">" : &#123;</span><br><span class="line">        "</span>pop<span class="string">" : "</span>fs-sub-scan<span class="string">",</span><br><span class="line">        "</span>@id<span class="string">" : 3,</span><br><span class="line">        "</span>userName<span class="string">" : "</span>zhengqh<span class="string">",</span><br><span class="line">        "</span>files<span class="string">" : [ &#123;</span><br><span class="line">          "</span><span class="keyword">start</span><span class="string">" : 0,</span><br><span class="line">          "</span>length<span class="string">" : 474630,</span><br><span class="line">          "</span>path<span class="string">" : "</span>classpath:/employee.json<span class="string">"</span><br><span class="line">        &#125; ],</span><br><span class="line">        "</span>columns<span class="string">" : [ "</span>`*`<span class="string">" ],</span><br><span class="line">        "</span>selectionRoot<span class="string">" : "</span>classpath:/employee.json<span class="string">"</span><br><span class="line">      &#125;,</span><br><span class="line">      "</span>initialAllocation<span class="string">" : 1000000,</span><br><span class="line">      "</span>maxAllocation<span class="string">" : 10000000000,</span><br><span class="line">      "</span>cost<span class="string">" : 463.0</span><br><span class="line">    &#125;,</span><br><span class="line">    "</span>keys<span class="string">" : [ ],</span><br><span class="line">    "</span>exprs<span class="string">" : [ &#123;</span><br><span class="line">      "</span>ref<span class="string">" : "</span>`EXPR<span class="variable">$0</span>`<span class="string">",</span><br><span class="line">      "</span>expr<span class="string">" : "</span>count(<span class="number">1</span>) <span class="string">"</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;"</span></span><br><span class="line">leaf_fragment: <span class="literal">true</span></span><br><span class="line">assignment &#123;</span><br><span class="line">  address: <span class="string">"localhost"</span></span><br><span class="line">  user_port: <span class="number">31010</span></span><br><span class="line">  control_port: <span class="number">31011</span></span><br><span class="line">  data_port: <span class="number">31012</span></span><br><span class="line">&#125;</span><br><span class="line">foreman &#123;</span><br><span class="line">  address: <span class="string">"localhost"</span></span><br><span class="line">  user_port: <span class="number">31010</span></span><br><span class="line">  control_port: <span class="number">31011</span></span><br><span class="line">  data_port: <span class="number">31012</span></span><br><span class="line">&#125;</span><br><span class="line">mem_initial: <span class="number">3000000</span></span><br><span class="line">mem_max: <span class="number">30000000000</span></span><br><span class="line">credentials &#123;</span><br><span class="line">  user_name: <span class="string">"anonymous"</span></span><br><span class="line">&#125;</span><br><span class="line">options_json: <span class="string">"[ ]"</span></span><br><span class="line">context &#123;</span><br><span class="line">  query_start_time: <span class="number">1436498522273</span></span><br><span class="line">  time_zone: <span class="number">299</span></span><br><span class="line">  default_schema_name: <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å’Œfragment_jsonåŒçº§çš„è¿˜æœ‰foreman,è¡¨ç¤ºæ¥å—å®¢æˆ·ç«¯æŸ¥è¯¢ä½œä¸šçš„èŠ‚ç‚¹, å› ä¸ºæ˜¯æœ¬åœ°æ¨¡å¼,æ‰€ä»¥æ˜¯localhost.<br>åˆå§‹åŒ–å†…å­˜mem_initialå’Œæœ€å¤§å†…å­˜mem_maxåœ¨FragmentContextä¸­.  </p>
<p>Fragmentæäº¤åˆ°Foremanå, æŸ¥è¯¢å¼€å§‹è¿è¡Œ, Foremançš„çŠ¶æ€ä»PENDINGåˆ°RUNNING, FragmentExecutorä»AWAITING_ALLOCATIONåˆ°RUNNING.<br>è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µæ˜¯é€šè¿‡ImplCreatoråˆ›å»ºçš„RecordBatch Tree.       </p>
<blockquote>
<p>ä¸Šé¢æˆ‘ä»¬å·²ç»æœ‰äº†Root Fragmentå½¢æˆçš„Treeçš„æ¦‚å¿µ. è¿™é‡Œæ‰¹è®°å½•è¿˜æœ‰æ ‘.<br>ä»€ä¹ˆæ˜¯RecordBatch,é¡¾åæ€ä¹‰æ˜¯æ‰¹è®°å½•. é‚£ä¸ºä»€ä¹ˆåˆæœ‰æ ‘çš„æ¦‚å¿µ?  </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">378</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.d.exec.rpc.control.WorkEventBus - Adding fragment status listener <span class="keyword">for</span> queryId <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">378</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.drill.exec.work.foreman.Foreman - Submitting fragments to run.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">378</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.drill.exec.ops.FragmentContext - Getting initial memory allocation of <span class="number">3000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">378</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.drill.exec.ops.FragmentContext - Fragment max allocation: <span class="number">30000000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">378</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.d.exec.memory.TopLevelAllocator - New child allocator with initial reservation <span class="number">3000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">379</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.d.e.work.batch.IncomingBuffers - Came up with a <span class="built_in">list</span> of <span class="number">0</span> required fragments.  Fragments &#123;&#125;</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">380</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] INFO  o.a.drill.exec.work.foreman.Foreman - State change requested.  PENDING --&gt; RUNNING</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">381</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:foreman] DEBUG o.a.drill.exec.work.foreman.Foreman - Fragments running.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">381</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation <span class="number">1000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">387</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation <span class="number">1000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">387</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation <span class="number">1000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">388</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation <span class="number">1000000</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">388</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.physical.impl.ImplCreator - Took <span class="number">7</span> ms to create RecordBatch tree</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">388</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] INFO  o.a.d.e.w.fragment.FragmentExecutor - <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:<span class="number">0</span>:<span class="number">0</span>: State change requested from AWAITING_ALLOCATION --&gt; RUNNING <span class="keyword">for</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">388</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] INFO  o.a.d.e.w.f.AbstractStatusReporter - State changed <span class="keyword">for</span> <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:<span class="number">0</span>:<span class="number">0.</span> New state: RUNNING</span><br></pre></td></tr></table></figure>
<p>Fragmentçš„çŠ¶æ€ä¼šè¢«QueryManagerç®¡ç†, å…¶ä¸­operator_profileæ˜¯æ“ä½œç®—å­çš„é€‰é¡¹, åŒ…æ‹¬äº†ä¸€äº›å­—æ®µinput_profile, æ“ä½œç®—å­id, æ“ä½œç±»å‹ç­‰ç­‰.<br>ä»€ä¹ˆæ˜¯profile, å…¶å®WEBé¡µé¢<a href="http://localhost:8047/profiles" target="_blank" rel="external">http://localhost:8047/profiles</a>å°±æ˜¯DrillæŸ¥è¯¢ä½œä¸šè¿è¡Œæ—¶çš„profileæ”¶é›†é¡µé¢.<br>åŒ…æ‹¬äº†Query Profile, Fragment Profiles,Operator Profiles,Full JSON Profile.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">389</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.w.f.NonRootStatusReporter - Sending status change message message to remote node: profile &#123;</span><br><span class="line">  state: RUNNING</span><br><span class="line">  minor_fragment_id: <span class="number">0</span></span><br><span class="line">  operator_profile &#123;</span><br><span class="line">    input_profile &#123;</span><br><span class="line">      records: <span class="number">0</span></span><br><span class="line">      batches: <span class="number">0</span></span><br><span class="line">      schemas: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    operator_id: <span class="number">3</span></span><br><span class="line">    operator_type: <span class="number">29</span></span><br><span class="line">    setup_nanos: <span class="number">0</span></span><br><span class="line">    process_nanos: <span class="number">4651000</span></span><br><span class="line">    peak_local_memory_allocated: <span class="number">0</span></span><br><span class="line">    wait_nanos: <span class="number">3000</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">390</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.w.fragment.FragmentExecutor - Starting fragment <span class="number">0</span>:<span class="number">0</span> on localhost:<span class="number">31010</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">392</span> [BitServer-<span class="number">4</span>] DEBUG o.a.d.exec.work.foreman.QueryManager - New fragment status was provided to QueryManager of profile &#123;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æåˆ°çš„RecordBatchåœ¨ä¸‹é¢æœ‰å‡ ä¸ªå®ç°ç±»: ProjectRecordBatch, StreamingAggBatch.</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill2.png" alt="">  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">392</span> [BitServer-<span class="number">4</span>] DEBUG o.a.d.exec.rpc.control.ControlServer - Sending response with Sender <span class="number">762133699</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">408</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.p.i.p.ProjectRecordBatch - Added eval <span class="keyword">for</span> project expression.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">410</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Creating <span class="keyword">new</span> aggregator.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">413</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Next outcome of OK_NEW_SCHEMA</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">413</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Creating <span class="keyword">new</span> aggregator.</span><br><span class="line"></span><br><span class="line">+++++++++++++batch1+++++++++++++</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">414</span> [Client-<span class="number">1</span>] DEBUG o.a.d.e.rpc.user.QueryResultHandler - batchArrived: queryId = part1: <span class="number">3053657859282349058</span> part2: -<span class="number">8863752500417580646</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">415</span> [Client-<span class="number">1</span>] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Received query data batch #<span class="number">1</span>: QueryResultBatch [header=query_id &#123;</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">415</span> [Client-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender <span class="number">955795882</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">416</span> [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Dequeued query data batch #<span class="number">1</span>: QueryResultBatch [header=query_id &#123;</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„batchArrivedè¡¨ç¤ºæ‰¹è®°å½•åˆ°æ¥, é‚£ä¹ˆæ¥ä¸‹å»å°±æ˜¯å¤„ç†åˆ°æ¥çš„æ•°æ®äº†:<br>å¯¹äºbatch, æ€»æ˜¯å…ˆ<code>Received query data batch, ç„¶å</code>Sending response with Sender,<br>æœ€å<code>Dequeued query data batch</code>. å¾ˆæ˜¾ç„¶query data batchä¼šåœ¨é˜Ÿåˆ—ä¸­è¿›è¿›å‡ºå‡º.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++++batch2+++++++++++++</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">419</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Aggregator response RETURN_OUTCOME, records <span class="number">1</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">419</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Aggregator response CLEANUP_AND_RETURN, records <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">421</span> [Client-<span class="number">1</span>] DEBUG o.a.d.e.rpc.user.QueryResultHandler - batchArrived: queryId = part1: <span class="number">3053657859282349058</span> part2: -<span class="number">8863752500417580646</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">421</span> [Client-<span class="number">1</span>] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Received query data batch #<span class="number">2</span>: QueryResultBatch [header=query_id &#123;</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">421</span> [Client-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender <span class="number">1000578767</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">422</span> [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Dequeued query data batch #<span class="number">2</span>: QueryResultBatch [header=query_id &#123;</span></span><br></pre></td></tr></table></figure>
<p>è®¡ç®—å®Œæˆ, å…³é—­ä¸Šä¸‹æ–‡, FragmentExecutorçš„çŠ¶æ€ä»RUNNINGåˆ°FINISHED.  åŒæ ·ä¹Ÿä¼šæ‰“å°profile.<br>è¿™é‡Œæˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†1155è¿™ä¸ªQueryè®¡ç®—å‡ºæ¥çš„ç»“æœäº†.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context <span class="keyword">for</span> org.apache.drill.exec.store.dfs.easy.EasySubScan</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context <span class="keyword">for</span> org.apache.drill.exec.physical.config.Project</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context <span class="keyword">for</span> org.apache.drill.exec.physical.config.StreamingAggregate</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context <span class="keyword">for</span> org.apache.drill.exec.physical.config.Screen</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.apache.drill.exec.memory.Accountor - Fragment <span class="number">0</span>:<span class="number">0</span>  accountor being closed</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] INFO  o.a.d.e.w.fragment.FragmentExecutor - <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:<span class="number">0</span>:<span class="number">0</span>: State change requested from RUNNING --&gt; FINISHED <span class="keyword">for</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">423</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] INFO  o.a.d.e.w.f.AbstractStatusReporter - State changed <span class="keyword">for</span> <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:<span class="number">0</span>:<span class="number">0.</span> New state: FINISHED</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">424</span> [<span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a:frag:<span class="number">0</span>:<span class="number">0</span>] DEBUG o.a.d.e.w.f.NonRootStatusReporter - Sending status change message message to remote node: profile &#123;</span><br><span class="line">  state: FINISHED</span><br><span class="line">  minor_fragment_id: <span class="number">0</span></span><br><span class="line">  operator_profile &#123;</span><br><span class="line">    input_profile &#123;</span><br><span class="line">      records: <span class="number">1155</span></span><br><span class="line">      batches: <span class="number">1</span></span><br><span class="line">      schemas: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    operator_id: <span class="number">3</span></span><br><span class="line">    operator_type: <span class="number">29</span></span><br><span class="line">    setup_nanos: <span class="number">0</span></span><br><span class="line">    process_nanos: <span class="number">22301000</span></span><br><span class="line">    peak_local_memory_allocated: <span class="number">4608</span></span><br><span class="line">    wait_nanos: <span class="number">133000</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>æœ€åFormanä¹Ÿä¼šå…³é—­, Foremançš„çŠ¶æ€ä»RUNNINGåˆ°COMPLETED.  æ‰“å°resultArrivedçš„æ—¶å€™å…¶å®ç»“æœå·²ç»åœ¨sqllineä¸Šè¾“å‡ºäº†.<br>å‰©ä¸‹å°±æ˜¯ä¸€äº›èµ„æºç§»é™¤,æ³¨é”€ä¹‹ç±»çš„å·¥ä½œäº†. å…¶å®å’Œæœ€å¼€å§‹çš„èµ„æºç”³è¯·,æ³¨å†Œæ˜¯å¯¹åº”çš„.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">427</span> [BitServer-<span class="number">4</span>] INFO  o.a.drill.exec.work.foreman.Foreman - State change requested.  RUNNING --&gt; COMPLETED</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">427</span> [BitServer-<span class="number">4</span>] INFO  o.a.drill.exec.work.foreman.Foreman - foreman cleaning up.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">429</span> [BitServer-<span class="number">4</span>] DEBUG o.a.d.exec.rpc.control.WorkEventBus - Removing fragment status listener <span class="keyword">for</span> queryId <span class="number">2</span>a60c5a4-e01a-ac02-<span class="number">84f</span>d-a01023a1319a.</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">430</span> [BitServer-<span class="number">4</span>] DEBUG o.apache.drill.exec.memory.Accountor - Fragment <span class="number">0</span>:<span class="number">0</span>  accountor being closed</span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">446</span> [BitServer-<span class="number">4</span>] DEBUG o.a.d.exec.rpc.control.ControlServer - Sending response with Sender <span class="number">739019148</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">447</span> [Client-<span class="number">1</span>] DEBUG o.a.d.e.rpc.user.QueryResultHandler - resultArrived: queryState: COMPLETED, queryId = part1: <span class="number">3053657859282349058</span></span><br><span class="line">part2: -<span class="number">8863752500417580646</span></span><br><span class="line"></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">448</span> [Client-<span class="number">1</span>] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Received query completion: COMPLETED.</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">448</span> [Client-<span class="number">1</span>] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender <span class="number">264929084</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">479</span> [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [<span class="preprocessor">#<span class="number">3</span>] Query listener closing.</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">22</span>:<span class="number">02</span>,<span class="number">479</span> [main] DEBUG o.a.d.j.impl.DrillStatementRegistry - Removing from open-statements registry: org.apache.drill.jdbc.impl.DrillStatementImpl@<span class="number">4</span>eb2bb3d</span><br></pre></td></tr></table></figure>
<h2 id="Logical_Plané€»è¾‘è®¡åˆ’">Logical Plané€»è¾‘è®¡åˆ’</h2><p><a href="http://drill.apache.org/docs/drill-plan-syntax/" target="_blank" rel="external">http://drill.apache.org/docs/drill-plan-syntax/</a><br><a href="https://docs.google.com/document/d/1QTL8warUYS2KjldQrGUse7zp8eA72VKtLOHwfXy6c7I/edit" target="_blank" rel="external">https://docs.google.com/document/d/1QTL8warUYS2KjldQrGUse7zp8eA72VKtLOHwfXy6c7I/edit</a><br><a href="http://yangyoupeng-cn-fujitsu-com.iteye.com/blog/1971728" target="_blank" rel="external">http://yangyoupeng-cn-fujitsu-com.iteye.com/blog/1971728</a></p>
<p>åœ¨Architectureä¸­æˆ‘ä»¬è§åˆ°è¿™å¼ å›¾äº†</p>
<p><img src="http://drill.apache.org/docs/img/client-phys-plan.png" alt=""></p>
<p>åœ¨DesignDocä¸­æ˜¯ä¸€å¼ æ¯”è¾ƒç²—ç•¥çš„å›¾</p>
<p><img src="http://drill.apache.org/docs/img/slide-15-638.png" alt=""></p>
<p>æ€»çš„æ¥è¯´è¿‡ç¨‹å°±æ˜¯: æŸ¥è¯¢è¯­å¥â€“è§£æå™¨â€“é€»è¾‘è®¡åˆ’â€“ä¼˜åŒ–å™¨â€“ç‰©ç†è®¡åˆ’â€“æ‰§è¡Œå¼•æ“</p>
<p>å…³äºé€»è¾‘è®¡åˆ’æ¯”è¾ƒè¯¦ç»†çš„æ–‡æ¡£ä¹Ÿç»™å‡ºäº†(ä¸Šé¢ç¬¬äºŒä¸ªé“¾æ¥,è¯·è‡ªè¡Œfq).</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill3.png" alt=""></p>
<p>ä»¥Logical Plan Operatorsçš„Scanä¸ºä¾‹</p>
<blockquote>
<p>The Scan operator outputs a stream of records. The â€œstorageengineâ€ argument must refer by name to a storage engine defined in the engines clause of the logical plan. The â€œselectionâ€ argument accepts a JSON object that is used by the data source itself to limit the amount of data actually retrieved. The format and content of this object is specific to the actual input source being used. Examples might include an HBase table name, a MongoDB collection, an HDFS path or a partition of a Hive table. Data sources will use the the selection argument in an implementation-specific way.  The provided â€œrefâ€ argument ensures that all records within the scanned source are held in the provided namespace.<br>{ @idâ€ : &lt; opref &gt;, op: â€œscanâ€,<br>   storageengine: &lt; string &gt;,<br>   selection*: &lt; json &gt;,<br>   ref: &lt; name &gt;<br> }</p>
</blockquote>
<p>Scanæ“ä½œç®—å­ä¼šè¾“å‡ºè®°å½•æµ. å‚æ•°storageengineå¿…é¡»å¼•ç”¨é€»è¾‘è®¡åˆ’ä¸­å®šä¹‰çš„engineå£°æ˜.<br>selectionå‚æ•°æ¥æ”¶JSONå¯¹è±¡,ä¼šè¢«æ•°æ®æºä½¿ç”¨,ç”¨äºé™åˆ¶æ¥æ”¶åˆ°çš„æ•°æ®çš„æ•°é‡.<br>è¿™ä¸ªJSONå¯¹è±¡çš„æ ¼å¼å’Œå†…å®¹å’Œå®é™…çš„æ•°æ®æºæœ‰å…³.æ¯”å¦‚HBaseçš„è¡¨å,MongoDBçš„é›†åˆ,HDFSçš„è·¯å¾„,æˆ–è€…Hiveè¡¨çš„ä¸€ä¸ªåˆ†åŒº.  </p>
<blockquote>
<p>Talk is cheap, Show me the Code. </p>
</blockquote>
<p>åœ¨<code>org.apache.drill.common.logical.data</code>æœ‰å¾ˆå¤šä¸Šæ–‡æåˆ°çš„æ“ä½œç¬¦æ¯”å¦‚Scan,Join,Project,Unionç­‰.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill5.png" alt=""></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@JsonTypeName</span>(<span class="string">"scan"</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Scan</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">SourceOperator</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> storageEngine;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">JSONOptions</span> selection;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@JsonCreator</span></span><br><span class="line">  public <span class="type">Scan</span>(<span class="annotation">@JsonProperty</span>(<span class="string">"storageengine"</span>) <span class="type">String</span> storageEngine, <span class="annotation">@JsonProperty</span>(<span class="string">"selection"</span>) <span class="type">JSONOptions</span> selection) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.storageEngine = storageEngine;</span><br><span class="line">    <span class="keyword">this</span>.selection = selection;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@JsonProperty</span>(<span class="string">"storageengine"</span>)</span><br><span class="line">  public <span class="type">String</span> getStorageEngine() &#123; <span class="keyword">return</span> storageEngine; &#125;</span><br><span class="line"></span><br><span class="line">  public <span class="type">JSONOptions</span> getSelection() &#123;  <span class="keyword">return</span> selection; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  public &lt;<span class="type">T</span>, <span class="type">X</span>, <span class="type">E</span> <span class="keyword">extends</span> <span class="type">Throwable</span>&gt; <span class="type">T</span> accept(<span class="type">LogicalVisitor</span>&lt;<span class="type">T</span>, <span class="type">X</span>, <span class="type">E</span>&gt; logicalVisitor, <span class="type">X</span> value) <span class="keyword">throws</span> <span class="type">E</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> logicalVisitor.visitScan(<span class="keyword">this</span>, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LogicalVisitor</code>æ˜¯é€»è¾‘(æ“ä½œç¬¦)çš„è®¿é—®å™¨. Visitor class designed to traversal of a operator tree.  éå†ä¸€é¢—æ“ä½œç¬¦æ ‘<br>Basis for a number of operator manipulations including fragmentation and materialization. å¯¹ç®—å­çš„ç»´æŠ¤åŒ…æ‹¬åˆ†ç‰‡,åºåˆ—åŒ–</p>
<p>Scanæ“ä½œæ¯”è¾ƒç®€å•, å®ƒç»§æ‰¿çš„æ˜¯SourceOperator:An operator that produces data without any parents.  (zero input operator)</p>
<blockquote>
<p>Operatoråˆ†æˆè‹¥å¹²ç±»ï¼Œæ¯ä¸€ä¸ªoperatoréƒ½æ ‡ç¤ºäº†å®ƒçš„ç±»å‹ï¼Œç›®å‰operatorç±»åŒ…æ‹¬ï¼š<br>0ï¼šå¯ä»¥äº§ç”Ÿä¸ä¾èµ–å…¶ä»–operatorçš„æ•°æ®ï¼Œç±»ä¼¼äºæºæ•°æ®. æ¯”å¦‚Scan,<br>1ï¼šè¯¥operatorå¯ä»¥å¤„ç†ä¸€ä¸ªå•ç‹¬input source, æ¯”å¦‚Project,Order,Limitç­‰<br>Mï¼šå¯ä»¥å¤„ç†å¤šä¸ªinput sourceæ•°æ®<br>Kï¼šè¯¥operatorä¸ä¼šäº§ç”Ÿè¾“å‡ºã€‚ </p>
</blockquote>
<p>æˆ‘ä»¬çŸ¥é“ProjectåŒ…æ‹¬å­—æ®µå’Œè¡¨è¾¾å¼, æ¯”å¦‚count(<em>), å…¶ä¸­</em>æ˜¯refå¼•ç”¨,countæ˜¯exprè¡¨è¾¾å¼</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@JsonTypeName</span>(<span class="string">"project"</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Project</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">SingleInputOperator</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">NamedExpression</span>[] selections;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@JsonPropertyOrder</span>(&#123;<span class="string">"ref"</span>, <span class="string">"expr"</span>&#125;)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">NamedExpression</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">LogicalExpression</span> expr;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">FieldReference</span> ref;</span><br></pre></td></tr></table></figure>
<p>åœ¨org.apache.drill.common.logicalè¿™ä¸ªåŒ…ä¸‹æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»LogicalPlan,å…ˆæ¥çœ‹çœ‹Plançš„å±æ€§æœ‰å“ªäº›</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PlanProperties</span> &#123;</span></span><br><span class="line">  public static <span class="class"><span class="keyword">enum</span> <span class="title">PlanType</span> &#123;<span class="title">APACHE_DRILL_LOGICAL</span>, <span class="title">APACHE_DRILL_PHYSICAL</span>&#125;</span></span><br><span class="line"></span><br><span class="line">  public <span class="constant">PlanType</span> <span class="keyword">type</span>;</span><br><span class="line">  public int version;</span><br><span class="line">  public <span class="constant">Generator</span> generator;</span><br><span class="line">  public <span class="constant">ResultMode</span> resultMode;</span><br><span class="line">  public <span class="constant">JSONOptions</span> options;</span><br><span class="line">  public int queue;</span><br><span class="line"></span><br><span class="line">  public static <span class="class"><span class="keyword">class</span> <span class="title">Generator</span> &#123;</span></span><br><span class="line">    public <span class="constant">String</span> <span class="keyword">type</span>;</span><br><span class="line">    public <span class="constant">String</span> info;</span><br><span class="line"></span><br><span class="line">    public static <span class="class"><span class="keyword">enum</span> <span class="title">ResultMode</span> &#123;</span></span><br><span class="line">      <span class="constant">EXEC</span>, <span class="constant">LOGICAL</span>, <span class="constant">PHYSICAL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="constant">Generator</span>(<span class="variable">@JsonProperty</span>(<span class="string">"type"</span>) <span class="constant">String</span> <span class="keyword">type</span>, <span class="variable">@JsonProperty</span>(<span class="string">"info"</span>) <span class="constant">String</span> info) &#123;</span><br><span class="line">      this.<span class="keyword">type</span> = <span class="keyword">type</span>;</span><br><span class="line">      this.info = info;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”äº†å‰é¢çš„Drill Planä¸­headéƒ¨åˆ†çš„è¾“å‡º(è™½ç„¶å‰é¢æˆ‘ä»¬çœ‹åˆ°çš„Drill Planåº”è¯¥æ˜¯ç‰©ç†è®¡åˆ’,è€Œä¸æ˜¯é€»è¾‘è®¡åˆ’,ä½†æ˜¯headéƒ¨åˆ†æ˜¯ä¸€æ ·çš„)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">head</span>" : <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">version</span>" : <span class="value"><span class="number">1</span></span>,</span><br><span class="line">    "<span class="attribute">generator</span>" : <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>" : <span class="value"><span class="string">"DefaultSqlHandler"</span></span>,</span><br><span class="line">      "<span class="attribute">info</span>" : <span class="value"><span class="string">""</span></span><br><span class="line">    </span>&#125;</span>,</span><br><span class="line">    "<span class="attribute">type</span>" : <span class="value"><span class="string">"APACHE_DRILL_PHYSICAL"</span></span>,</span><br><span class="line">    "<span class="attribute">options</span>" : <span class="value">[ ]</span>,</span><br><span class="line">    "<span class="attribute">queue</span>" : <span class="value"><span class="number">0</span></span>,</span><br><span class="line">    "<span class="attribute">resultMode</span>" : <span class="value"><span class="string">"EXEC"</span></span><br><span class="line">  </span>&#125;</span>,</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘è®¡åˆ’LogicalPlanåŒ…å«äº†ä¸‰ä¸ªéƒ¨åˆ†: head,storage,query.  </p>
<p><a href="http://www.confusedcoders.com/bigdata/apache-drill/understanding-apache-drill-logical-plan" target="_blank" rel="external">http://www.confusedcoders.com/bigdata/apache-drill/understanding-apache-drill-logical-plan</a></p>
<blockquote>
<p>The query node is the actual query that we want to execute on Drill. The query itself is a collection of operations on the data.</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@JsonPropertyOrder</span>(&#123; <span class="string">"head"</span>, <span class="string">"storage"</span>, <span class="string">"query"</span> &#125;)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LogicalPlan</span> </span>&#123;</span><br><span class="line">  <span class="literal">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(LogicalPlan.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">  private <span class="keyword">final</span> PlanProperties properties;</span><br><span class="line">  private <span class="keyword">final</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, StoragePluginConfig&gt; storageEngineMap;</span><br><span class="line">  private <span class="keyword">final</span> Graph&lt;LogicalOperator, SinkOperator, SourceOperator&gt; graph;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="annotation">@JsonCreator</span></span><br><span class="line">  public LogicalPlan(<span class="annotation">@JsonProperty</span>(<span class="string">"head"</span>) PlanProperties head,</span><br><span class="line">      <span class="annotation">@JsonProperty</span>(<span class="string">"storage"</span>) <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, StoragePluginConfig&gt; storageEngineMap,</span><br><span class="line">      <span class="annotation">@JsonProperty</span>(<span class="string">"query"</span>) <span class="built_in">List</span>&lt;LogicalOperator&gt; operators) &#123;</span><br><span class="line">    <span class="keyword">this</span>.storageEngineMap = storageEngineMap != <span class="keyword">null</span> ? storageEngineMap : <span class="keyword">new</span> HashMap&lt;<span class="built_in">String</span>, StoragePluginConfig&gt;();</span><br><span class="line">    <span class="keyword">this</span>.properties = head;</span><br><span class="line">    <span class="keyword">this</span>.graph = Graph.newGraph(operators, SinkOperator.<span class="keyword">class</span>, SourceOperator.<span class="keyword">class</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>queryæ˜¯é€»è¾‘æ“ä½œç¬¦é›†åˆ, å®ƒä»¬å’ŒSink,Sourceæ“ä½œç¬¦ä¸€èµ·æ„æˆäº†ä¸€å¼ é€»è¾‘è®¡åˆ’æ•°æ®æµçš„æ‰§è¡Œå›¾graph.<br>LogicalPlançš„æ„å»ºå™¨çš„build()ä¼šåˆ›å»ºLogicalPlanå¯¹è±¡. è¿™ä¸ªBuilderå¯¹è±¡æä¾›äº†é€»è¾‘è®¡åˆ’çš„ç¼–ç¨‹æ¥å£.  </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogicalPlanBuilder</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> PlanProperties planProperties;</span><br><span class="line">  <span class="keyword">private</span> ImmutableMap.Builder&lt;String, StoragePluginConfig&gt; storageEngines = ImmutableMap.builder();</span><br><span class="line">  <span class="keyword">private</span> ImmutableList.Builder&lt;LogicalOperator&gt; operators = ImmutableList.builder();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogicalPlanBuilder <span class="title">addLogicalOperator</span>(<span class="params">LogicalOperator <span class="keyword">operator</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.operators.add(<span class="keyword">operator</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogicalPlan <span class="title">build</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LogicalPlan(<span class="keyword">this</span>.planProperties, <span class="keyword">this</span>.storageEngines.build(), <span class="keyword">this</span>.operators.build());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨buildä¹‹å‰,è¦æ„å»ºä¸€ä¸ªå®Œæ•´çš„å›¾,è¦è°ƒç”¨ç›¸åº”çš„addXXX()æ–¹æ³•,å› ä¸ºæ–¹æ³•è¿”å›this,æ‰€ä»¥è°ƒç”¨è€…å¯ä»¥é“¾å¼è°ƒç”¨.<br>buildå°±æ˜¯æ„å»ºè€…æ¨¡å¼,ä¸€æ—¦è°ƒç”¨äº†buildæ–¹æ³•,è¿”å›çš„å¯¹è±¡å°±æ˜¯ä¸å¯ä¿®æ”¹çš„.å› æ­¤è¦åœ¨buildå‰å¡«å……æ‰€æœ‰çš„æ•°æ®.  </p>
<h2 id="PhysicalPlanç‰©ç†è®¡åˆ’">PhysicalPlanç‰©ç†è®¡åˆ’</h2><p>æ€ä¹ˆçŸ¥é“å‰é¢æ—¥å¿—ä¸­æ‰“å°çš„Drill Planæ˜¯ç‰©ç†è®¡åˆ’,è€Œä¸æ˜¯é€»è¾‘è®¡åˆ’, é¦–å…ˆå¯ä»¥ä»è°ƒç”¨çš„ç±»DefaultSqlHandler,æœç´¢Drill Plan</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PhysicalPlan getPlan(SqlNode sqlNode) &#123;</span><br><span class="line">  <span class="keyword">final</span> ConvertedRelNode convertedRelNode = validateAndConvert(sqlNode);</span><br><span class="line">  <span class="keyword">final</span> RelDataType validatedRowType = convertedRelNode.getValidatedRowType();</span><br><span class="line">  <span class="keyword">final</span> RelNode queryRelNode = convertedRelNode.getConvertedNode();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log</span>(<span class="string">"Optiq Logical"</span>, queryRelNode, logger);</span><br><span class="line">  DrillRel drel = convertToDrel(queryRelNode, validatedRowType);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log</span>(<span class="string">"Drill Logical"</span>, drel, logger);</span><br><span class="line">  Prel prel = convertToPrel(drel);</span><br><span class="line">  <span class="built_in">log</span>(<span class="string">"Drill Physical"</span>, prel, logger);</span><br><span class="line">  PhysicalOperator pop = convertToPop(prel);</span><br><span class="line">  PhysicalPlan plan = convertToPlan(pop);</span><br><span class="line">  <span class="built_in">log</span>(<span class="string">"Drill Plan"</span>, plan, logger);</span><br><span class="line">  <span class="keyword">return</span> plan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.å¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢çš„getPlanæ–¹æ³•ä¸­, ä¾æ¬¡ç”Ÿæˆçš„è®¡åˆ’æ˜¯: Optiqé€»è¾‘è®¡åˆ’â€“&gt;Drillé€»è¾‘è®¡åˆ’â€“&gt;Drillç‰©ç†è®¡åˆ’<br>2.ç‰©ç†è®¡åˆ’å’Œé€»è¾‘è®¡åˆ’ä¸€æ ·ä¹Ÿæœ‰å¾ˆå¤šoperator, éƒ½åœ¨`org.apache.drill.exec.physicalåŒ…ä¸‹<br>3.Optiqç°åœ¨å˜æˆApacheçš„Calcite, å…¥é—¨æ•™ç¨‹: <a href="http://blog.csdn.net/yunlong34574/article/details/46375733" target="_blank" rel="external">http://blog.csdn.net/yunlong34574/article/details/46375733</a></p>
<p>getPlanè°ƒç”¨æ ‘æ˜¯è¢«Foremançº¿ç¨‹è¿è¡Œ,ç”±Foremanåˆ›å»ºçš„DrillSqlWorkerè°ƒç”¨æ‰§è¡Œçš„.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill4.png" alt=""></p>
<p>çœŸæ­£è¿è¡Œç‰©ç†è®¡åˆ’,è¿˜æ˜¯åœ¨Foremançš„runPhysicalPlanä¸­</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> runSQL(<span class="keyword">final</span> <span class="keyword">String</span> sql) <span class="keyword">throws</span> ExecutionSetupException &#123;</span><br><span class="line">  <span class="keyword">final</span> DrillSqlWorker sqlWorker = <span class="keyword">new</span> DrillSqlWorker(queryContext);</span><br><span class="line">  <span class="keyword">final</span> Pointer&lt;<span class="keyword">String</span>&gt; textPlan = <span class="keyword">new</span> Pointer&lt;&gt;();</span><br><span class="line">  <span class="keyword">final</span> PhysicalPlan plan = sqlWorker.getPlan(sql, textPlan);</span><br><span class="line">  queryManager.setPlanText(textPlan.value);</span><br><span class="line">  runPhysicalPlan(plan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-11-27-StreamCQL-operator" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-11-27-StreamCQL-operator/" class="article-date">
  	<time datetime="2015-12-01T10:03:02.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-11-27-StreamCQL-operator/">StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="å‰æˆ:_buildApplication">å‰æˆ: buildApplication</h2><p>ä¸Šç¯‡åœ¨è§£æSchemaçš„æ—¶å€™åˆ†æäº†CQLä¸­ä¸€äº›å¸¸ç”¨çš„Statement syntaxå’Œå¯¹åº”çš„è¯­æ³•/è¯­ä¹‰è§£æå™¨ç»“æœ,<br>ç°åœ¨ç»§ç»­ApplicationBuilder.buildApplicationä¸­parseSchemasçš„ä¸‹ä¸€æ­¥splitOperators.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    app = <span class="keyword">new</span> Application(applicationName);</span><br><span class="line">    parseSchemas();</span><br><span class="line">    List&lt;SplitContext&gt; splitContexts = splitOperators();            <span class="comment">//æ‹†åˆ†ç®—å­  â¬…ï¸</span></span><br><span class="line">    SplitContext splitContext = combineOperators(splitContexts);    <span class="comment">//ç»„åˆç®—å­, å°†æ‹†åˆ†ç®—å­åˆ—è¡¨è½¬æ¢ä¸ºåªæœ‰ä¸€ä¸ªSplitContext  â¬…ï¸</span></span><br><span class="line">    changeUnionOperators(splitContext);</span><br><span class="line">    changeSchemaAfterAggregate(splitContext);</span><br><span class="line">    app.setOperators(splitContext.getOperators());                  <span class="comment">//æ‹†åˆ†ç»“æœåŒ…å«äº†operatotså’Œtransitions</span></span><br><span class="line">    app.setOpTransition(splitContext.getTransitions());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>combineOperatorsä¼šåˆ›å»ºOperatorCombiner, å¹¶è°ƒç”¨combineæ–¹æ³•å°†splitContextsåˆå¹¶èµ·æ¥,ç»ˆäºæ‰“å°äº†æ—¥å¿—ä¸­çœ‹åˆ°çš„:<code>combine all split contexts</code>(è§£æsubmitä¹‹å).<br>æ„å»ºApplicationçš„ä¸»è¦å·¥ä½œå°±æ˜¯Splitå’ŒCombine,æœ€åå°†SplitContextçš„operatorså’Œtransitionsè®¾ç½®åˆ°Applicationå¯¹è±¡ä¸­,å®Œæˆåº”ç”¨ç¨‹åºçš„æ„å»º,åœ¨è¿™åŸºç¡€ä¸Šå†è¿›è¡Œç‰©ç†ä¼˜åŒ–.    </p>
<p>ä¸ºä»€ä¹ˆè¦å…ˆæ‹†åˆ†, åé¢åˆè¦å†ç»„åˆ?ğŸ˜– ä»¥ä¸‹é¢çš„CQLä¸ºä¾‹:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> stream s1           <span class="keyword">INSERT</span>  </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">type</span>,<span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">count</span>     <span class="keyword">AGGREGATE</span>  </span><br><span class="line"><span class="keyword">from</span> s0 (<span class="keyword">id</span>&gt;<span class="number">10</span>)[<span class="keyword">ROWS</span> <span class="number">10</span>]        <span class="keyword">FROM</span>: FilterBeforeWindow  </span><br><span class="line"><span class="keyword">having</span> <span class="keyword">count</span>(<span class="keyword">id</span>)&gt;<span class="number">10</span>             <span class="keyword">HAVING</span>: Expression  </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">type</span>                   GROUPBY</span></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆéœ€è¦é€šè¿‡ä¹‹å‰åˆ†æçš„AnalyzeContextè§£æå‡ºç³»ç»Ÿä¸­æ‰€æœ‰çš„ç®—å­.<br>â‘  INSERT INTO SELECT, å³INSERTè¯­å¥ä¸­åŒ…å«äº†SELECTå­å¥. å¯¹äºINSERTè€Œè¨€åªè¦ç¡®å®šè¾“å‡ºæµåç§°<br>â‘¡ SELECTè¯­å¥åˆ™åŒ…å«æ¯”è¾ƒå¤šçš„ç®—å­, FilterBeforeWindow,Having,GroupBy,COUNTèšåˆ  </p>
<blockquote>
<p>åªè¦å°†CQLä¸­çš„ç®—å­éƒ½æ‹†åˆ†å‡ºæ¥, æ‰èƒ½è¿›ä¸€æ­¥è¿›è¡Œæ•´ç†. æ‰€ä»¥æ‹†åˆ†ç®—å­çš„å·¥ä½œç±»ä¼¼äºä¸ºæ¯ä¸ªå…³é”®è¯è¿›è¡Œå½’ç±».<br>è¯•æƒ³ä¸€ä¸‹: è¦æ•´ç†å¾ˆå¤šæ‚ä¹±çš„ä¸œè¥¿, é¦–å…ˆå¯¹æ¯ä»¶ç‰©å“è¿›è¡Œå½’ç±», æœ€åå†è¿›è¡Œæ€»çš„æ±‡æ€»ğŸ˜Š.  </p>
</blockquote>
<h2 id="æ­£æ–‡:_Split_and_Combine_Operators">æ­£æ–‡: Split and Combine Operators</h2><p>ç¬¬ä¸€æ­¥SplitOperatorsæ‹†åˆ†ç®—å­: åˆ›å»ºå¯¹åº”çš„Splitter,è°ƒç”¨å…¶splitæ–¹æ³•.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SplitContext&gt; <span class="title">splitOperators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;SplitContext&gt; splitContexts = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">for</span> (AnalyzeContext pContext : parseContexts) &#123;         <span class="comment">//parseContextsæ˜¯è¯­ä¹‰è§£æå™¨ç»“æœåˆ—è¡¨</span></span><br><span class="line">        parseAutoCreatePipeStream(splitContexts, pContext); <span class="comment">//ç”±äºschemaæ¨æ–­çš„å­˜åœ¨,ä¸­é—´çš„æµschemaæ²¡æœ‰é€šè¿‡create inputè¯­å¥å®šä¹‰,æ‰€ä»¥æ˜¾ç¤ºçš„åˆ›å»ºä¸€ä¸ªcreate inputçš„è§£æå†…å®¹</span></span><br><span class="line">        parseSubQueryOperators(splitContexts, pContext);    <span class="comment">//è§£æå­æŸ¥è¯¢</span></span><br><span class="line">        SplitContext context = OperatorSplitter.split(buildUtils, pContext);    <span class="comment">//ç®—å­æ‹†åˆ† â¬…ï¸ </span></span><br><span class="line">        splitContexts.add(context);                         <span class="comment">//æ¯ä¸ªAnalyzeContextæ‹†åˆ†åéƒ½å¯¹åº”ä¸€ä¸ªSplitContext</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> splitContexts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>AnalyzeContextæ˜¯CQLè¯­å¥çš„è¯­ä¹‰è§£æç»“æœ, CQLçš„ä¸Šä¸‹æ–‡ä¿¡æ¯éƒ½å°è£…åœ¨è¯­ä¹‰è§£æç»“æœé‡Œé¢.  ç”±äºè¯­ä¹‰è§£ææ˜¯ä¸ªæ¯”è¾ƒå¤§çš„åˆ‡é¢,<br>éœ€è¦æŠŠè¯­ä¹‰è§£æç»“æœåˆ†æˆæ›´ç»†ç²’åº¦, å³ç®—å­. å¯ä»¥è®¤ä¸ºAnalyzeContext -&gt; SplitContextçš„è½¬æ¢æ˜¯å°†ä»»åŠ¡æ›´åŠ å…·ä½“åŒ–.  </p>
</blockquote>
<p>OperatorSplitterçš„splittersé‡‡ç”¨staticå—æå‰æ·»åŠ äº†ç³»ç»Ÿä¸­ä¹Ÿæœ‰çš„ç®—å­æ‹†åˆ†ç±». ç»“åˆä¸Šé¢çš„splitOperatorså°±æ˜¯ä¸€ä¸ªåŒå±‚å¾ªç¯äº†:<br>é’ˆå¯¹Applicationçš„æ¯ä¸€ä¸ªAnalyzeContext, åˆ¤æ–­å“ªä¸ªSplitterå¯ä»¥è§£æè¿™ä¸ªAnalyzeContext(æ¯ä¸ªAnalyzeContextåªä¼šå¯¹åº”ä¸€ä¸ªSplitter).   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SplitContext <span class="title">split</span><span class="params">(BuilderUtils buildUtils, AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Splitter splitter : splitters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (splitter.validate(parseContext)) &#123;</span><br><span class="line">            <span class="keyword">return</span> createSplitter(splitter.getClass(), buildUtils).split(parseContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªå…·ä½“çš„Splitteréƒ½å®ç°äº†validateæ–¹æ³•æ ¹æ®ä¼ å…¥çš„AnalyzeContextå®ç°ç±»(pContext)ç”¨æ¥éªŒè¯èƒ½å¦è¿›è¡Œè§£æ  </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Splitter                                AnalyzeContext</span><br><span class="line">    |<span class="string">-- SelectSplitter                      </span>|<span class="string">-- SelectAnalyzeContext     </span><br><span class="line">            </span>|<span class="string">-- DataSourceSplitter          </span>|</span><br><span class="line">            |<span class="string">-- AggregateSplitter           </span>|</span><br><span class="line">            |<span class="string">-- JoinSplitter                </span>|</span><br><span class="line">    |<span class="string">-- InsertSplitter                      </span>|<span class="string">-- InsertAnalyzeContext &gt;&gt; InsertOnlyAnalyzeContext</span><br><span class="line">    </span>|<span class="string">-- SourceOperatorSplitter              </span>|<span class="string">-- CreateStreamAnalyzeContext</span><br><span class="line">    </span>|<span class="string">-- MultiInsertSplitter                 </span>|<span class="string">-- MultiInsertStatementAnalyzeContext</span><br><span class="line">    </span>|<span class="string">-- UserOperatorSplitter                </span>|<span class="string">-- InsertUserOperatorStatementAnalyzeContext</span></span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚AggregateSplitterçš„validateæ–¹æ³•ä¼šéªŒè¯æ˜¯ä¸æ˜¯SelectAnalyzeContext.     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(parseContext <span class="keyword">instanceof</span> SelectAnalyzeContext))    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    SelectAnalyzeContext selectAnalyzeContext = (SelectAnalyzeContext)parseContext;</span><br><span class="line">    FromClauseAnalyzeContext clauseContext = selectAnalyzeContext.getFromClauseContext();</span><br><span class="line">    <span class="keyword">if</span> (clauseContext.getJoinexpression() != <span class="keyword">null</span>)          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (clauseContext.getCombineConditions().size() != <span class="number">0</span>)   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;  <span class="comment">//å±äºselect,ç„¶åæ—¢ä¸æ˜¯combineï¼Œåˆä¸æ˜¯joinï¼Œé‚£ä¹ˆå°±æ˜¯aggregate</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ™®é€šçš„selectå¯ä»¥çœ‹åšæ˜¯aggregate,æ¯”å¦‚<code>select count(id) from a where</code>å°±æ˜¯ä¸€ç§èšåˆ. å› ä¸ºselectå­å¥æ˜¯count(id)<br>ä½†æ˜¯å¦‚æœæ˜¯<code>select id from a join b on a.id=b.id</code>å› ä¸ºæœ‰joinæ“ä½œå°±ä¸æ˜¯aggregateäº†.<br>æ‰€ä»¥å¯ä»¥çœ‹åˆ°SelectSplitteré’ˆå¯¹è¿™ä¸¤ç§è¯­å¥åˆ†æˆäº†AggregateSplitterå’ŒJoinSplitter.  </p>
</blockquote>
<p>åªæœ‰éªŒè¯æˆåŠŸ,æ‰å¯ä»¥åœ¨æ­¤Splitterä¸Šè°ƒç”¨split: æ ¹æ®AnalyzeContextåˆ›å»ºOperatorç®—å­, å³æ ¹æ®è¯­ä¹‰åˆ†æç»“æœæ‹†åˆ†å†…å®¹</p>
<h3 id="SourceOperatorSplitter_-&gt;_Input/Output_Operator">SourceOperatorSplitter -&gt; Input/Output Operator</h3><p>SourceOperatorSplitterçš„splitä¼šåˆ›å»ºInputå’ŒOutputç®—å­å’Œä¸´æ—¶çš„pipeç®—å­.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceOperatorSplitter</span> <span class="keyword">implements</span> <span class="title">Splitter</span> </span>&#123;   <span class="comment">//æºç®—å­æ‹†åˆ†,åŒ…æ‹¬è¾“å…¥ç®—å­å’Œè¾“å‡ºç®—å­</span></span><br><span class="line">    <span class="keyword">private</span> SplitContext result = <span class="keyword">new</span> SplitContext();</span><br><span class="line">    <span class="keyword">private</span> CreateStreamAnalyzeContext context;             <span class="comment">//ç”±validateä¿è¯,æ‰€ä»¥ä¸‹é¢çš„splitæ–¹æ³•å¯ä»¥å¼ºè½¬</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SplitContext <span class="title">split</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        context = (CreateStreamAnalyzeContext)parseContext;  <span class="comment">//è¯­ä¹‰è§£æç»“æœ</span></span><br><span class="line">        setParallelNumber();</span><br><span class="line">        addToInput();                       <span class="comment">//åˆ›å»ºè¾“å…¥ç®—å­å¹¶åŠ å…¥åˆ°resultä¸­: InputStreamOperator</span></span><br><span class="line">        addToOutput();                      <span class="comment">//åˆ›å»ºè¾“å‡ºç®—å­å¹¶åŠ å…¥åˆ°resultä¸­: OutputStreamOperator</span></span><br><span class="line">        addToPipe();                        <span class="comment">//è¿æ¥ç®—å­: FilterOperator</span></span><br><span class="line">        result.setParseContext(context);    <span class="comment">//æœ€åéƒ½è¦å°†AnalyzeContextè®¾ç½®åˆ°SplitContextä¸­,è¯´ä¸å®šåé¢è¿˜æ˜¯éœ€è¦å®ƒçš„çˆ¶äº²(context)ç«™å‡ºæ¥æ’‘è…°å‘¢.</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šç¯‡è¯­æ³•ç»“æ„çš„<code>C</code>éƒ¨åˆ†,AnalyzeContext.analyzeä¼šå°†<code>è¯­æ³•è§£æçš„ä¸Šä¸‹æ–‡ç»“æœ</code>è®¾ç½®åˆ°<code>è¯­ä¹‰è§£æç»“æœ</code>ä¸­. è¿™é‡Œåˆ›å»ºçš„<code>ç®—å­</code>åˆ™è¿›ä¸€æ­¥ä¾èµ–äºè¯­ä¹‰è§£æç»“æœ.<br>æ‰€è°“ä»»ä½•äº‹ç‰©éƒ½æ˜¯å¯ä»¥è¿½æœ”åˆ°æºå¤´çš„: <strong><code>StatementContext-&gt;AnalyzeContext-&gt;Operator-&gt;SplitContext-&gt;Application</code></strong>, Operatorå¹¶ä¸æ˜¯ä¸€æ­¥ç™»å¤©,ä¸ç”Ÿä¿±æ¥çš„.<br>å¯ä»¥çœ‹åˆ°contextä¸­çš„RecordReaderClass,DeserializerClass,ReadWriterProperties,SerDePropertiesä¾æ¬¡<code>ç™»åœº</code>å¹¶è¿›å…¥åˆ°Operatorçš„<code>æˆå±€</code>é‡Œ.<br>æ‰€ä»¥Operatoræ²¿è¢­äº†<code>ç¥–å…ˆ</code>çš„ä¸Šä¸‹æ–‡æ•°æ®, ç°åœ¨æ–°çš„ä¸–ç•Œæ ¼å±€å°†æ˜¯ä»¥Operatorä¸º<code>ä¸»è§’</code>çš„äº†, ç¥–å…ˆä»¬å°±å¯ä»¥<code>éšé€€æ±Ÿæ¹–</code>äº†.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addToInput</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.getDeserializerClassName() != <span class="keyword">null</span> &amp;&amp; context.getSerializerClassName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Operator inop = createInputSourceOperator();    <span class="comment">//åˆ›å»ºç®—å­</span></span><br><span class="line">        <span class="keyword">if</span> (inputConverter.validate(inop)) &#123;</span><br><span class="line">            inop = inputConverter.convert(inop);</span><br><span class="line">        &#125;</span><br><span class="line">        result.addOperators(inop);      <span class="comment">//è¿™ä¸ªå¾ˆé‡è¦,å°†æ–°åˆ›å»ºçš„ç®—å­æ·»åŠ åˆ°SplitContextä¸­, åé¢æ‰ä¼šåœ¨è®¾ç½®åˆ°Applicationä¸­ â¬…ï¸ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> InputStreamOperator <span class="title">createInputSourceOperator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String operatorName = getOperatorName(context.getRecordReaderClassName(),<span class="string">"Input"</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºè¾“å…¥æµç®—å­</span></span><br><span class="line">    InputStreamOperator op = <span class="keyword">new</span> InputStreamOperator(buildUtils.getNextOperatorName(operatorName), parallelNumber);</span><br><span class="line">    <span class="comment">//è®¾ç½®è¾“å…¥ç®—å­çš„å±æ€§: ååºåˆ—åŒ–ç±», è¯»å–è®°å½•ç±»</span></span><br><span class="line">    op.setName(context.getStreamAlias());</span><br><span class="line">    op.setDeserializerClassName(context.getDeserializerClassName());</span><br><span class="line">    op.setRecordReaderClassName(context.getRecordReaderClassName());</span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–ç±»çš„å±æ€§å’Œè¯»å–è®°å½•çš„å±æ€§, å¯¹åº”CQLæœ€åŸå§‹çš„properties. </span></span><br><span class="line">    op.setArgs(<span class="keyword">new</span> TreeMap&lt;String, String&gt;());</span><br><span class="line">    op.getArgs().putAll(context.getReadWriterProperties());</span><br><span class="line">    op.getArgs().putAll(context.getSerDeProperties());</span><br><span class="line">    <span class="keyword">return</span> op;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>pipe streamç®—å­å±äºä¸­é—´ç®—å­ï¼Œæœ¬æ¥æ˜¯ä¸ä¼šå¯¹åº”ä»»ä½•ç®—å­ï¼Œåªè¦è§£æå‡ºschemaå³å¯çš„. ä½†æ˜¯ä¸ºäº†å’ŒCQLçš„æ•´ä½“è§„åˆ™ä¸€è‡´ï¼Œä¾¿äºåé¢åˆ›å»ºç®—å­ä¹‹é—´çš„è¿çº¿ï¼Œ<br>æ‰€ä»¥è¿™é‡Œåˆ›å»ºä¸€ä¸ªç©ºçš„filterç®—å­ï¼Œä¸å¸¦ä»»ä½•è¿‡æ»¤ã€‚ è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ä¼˜åŒ–å™¨é˜¶æ®µå°†è¿™ä¸ªfilterç®—å­ä¼˜åŒ–æ‰  </p>
<p>æ¯ä¸ªoperatorçš„å‚æ•°ç”¨ä¸€ä¸ªMap argsæ¥ä¿å­˜, æ¯”å¦‚ä¸Šé¢è¾“å…¥ç®—å­çš„å‚æ•°åŒ…æ‹¬äº†ReadWriterPropertieså’ŒSerDeProperties.<br>å› ä¸ºæ‰§è¡Œå™¨ä¸çŸ¥é“æ¯ä¸ªoperatorä¸­åˆ°åº•éœ€è¦å“ªäº›å‚æ•°ï¼Œæ‰€ä»¥åªèƒ½éƒ½æ”¾åœ¨mapä¸­, ç”±ä¸Šå±‚å®¢æˆ·ç«¯è¿›è¡Œå¡«å……ï¼Œå¹¶åœ¨åº•å±‚è¿è¡Œæ—¶æ£€æµ‹</p>
</blockquote>
<h3 id="InsertSplitter_-&gt;_Insert_Operator">InsertSplitter -&gt; Insert Operator</h3><p>insert intoè¯­å¥çš„AnalyzeContextåŒ…å«äº†outputStreamNameå’Œselectå­å¥, è¾“å‡ºæµå¯ä»¥ç›´æ¥è®¾ç½®åˆ°SplitContextç»“æœä¸­. è€Œselectå­å¥éœ€è¦<br>å†æ¬¡è°ƒç”¨æŸ¥è¯¢ç›¸å…³çš„Splitter(è¿”å›å€¼ä¹Ÿæ˜¯SplitContext), å¹¶å°†å…¶ç»“æœäº§ç”Ÿçš„operatorså’Œtransitionsæ·»åŠ åˆ°insertçš„SplitContextä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertSplitter</span> <span class="keyword">implements</span> <span class="title">Splitter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InsertAnalyzeContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SplitContext <span class="title">split</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        context = (InsertAnalyzeContext)parseContext;</span><br><span class="line">        result.setOutputStreamName(context.getOutputStreamName());</span><br><span class="line">        <span class="comment">//insertä¸­åŒ…å«äº†select, æ‰€ä»¥è¦å…ˆåˆ›å»ºselectç®—å­, è°ƒç”¨SelectSplitter.split</span></span><br><span class="line">        SplitContext selectResult = OperatorSplitter.split(buildUtils, context.getSelectContext());</span><br><span class="line">        <span class="comment">//å°†selectçš„ç»“æœç®—å­å’Œè¿æ¥éƒ½åŠ å…¥åˆ°insertç®—å­ä¸­</span></span><br><span class="line">        result.getOperators().addAll(selectResult.getOperators());</span><br><span class="line">        result.getTransitions().addAll(selectResult.getTransitions());</span><br><span class="line">        result.setParseContext(context);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SourceOperatorSplitterå’ŒInsertSplitterè®¾ç½®åˆ°SplitContext resultä¸­çš„å†…å®¹å¹¶ä¸æ˜¯ä¸€æ ·çš„. è¿™æ˜¯ç”±äºä¸åŒçš„AnalyzeContextæ‰€å­˜å‚¨çš„<br>æ•°æ®ä¹Ÿæ˜¯ä¸åŒçš„, æ•°æ®æºåªéœ€è¦åºåˆ—åŒ–ç±»,è¯»å–ç±»ç­‰. è€Œæ’å…¥è¯­å¥åˆ™æœ‰è¾“å‡ºæµå’Œè¾“å…¥æº(select). æ‰€ä»¥ä½ <code>åƒçš„æ˜¯ä»€ä¹ˆè‰, æŒ¤å‡ºæ¥çš„å¥¶ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„</code>.  </p>
</blockquote>
<h3 id="SelectSplitter">SelectSplitter</h3><p>SelectSplitteråŒ…å«äº†<code>DataSource,â‘ Aggregate,â‘¡JoinSplitter</code>.é’ˆå¯¹selectè¯­å¥çš„æ‹†åˆ†ä»¥åŠSchemaåˆ†ä¸º:  </p>
<p>1ã€æœ€ä¸€èˆ¬çš„selectå­å¥ã€‚<br>åªæœ‰ä¸€ä¸ªschema, è¾“å…¥å’Œè¾“å‡ºéƒ½æ˜¯(åŒ)ä¸€ä¸ªschema, ä¸è®ºæœ‰æ²¡æœ‰çª—å£ï¼Œéƒ½å¿…é¡»æ”¾åœ¨èšåˆç®—å­(AggregateSplitter)ä¸­ã€‚<br>åªè¦æœ‰whereï¼Œå°±éƒ½æ”¾åœ¨functorç®—å­(è¡¨è¾¾å¼)ä¸­ï¼Œåœ¨ä¼˜åŒ–å™¨ä¸­ï¼Œå†è¿›è¡Œè°ƒæ•´ï¼Œå¯ä»¥æ”¹ä¸ºfilteræˆ–è€…ç»§æ‰¿å†èšåˆç®—å­ä¸­ã€‚  </p>
<blockquote>
<p>å•å•ä¸€ä¸ªselectä¸ºä»€ä¹ˆè¦æ·»åŠ èšåˆç®—å­?<br>ç­”: èšåˆä¸ä¸€å®šå°±æ˜¯group by, å¯èƒ½æ˜¯filterè¿‡æ»¤,limité™åˆ¶æ¡æ•°ç­‰.<br>è€Œselectåé¢æ˜¯å¯ä»¥è·Ÿä¸Šfilteræˆ–è€…limitç­‰. èšåˆè¿˜å¯ä»¥æ˜¯count,sumç­‰.  </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                     |<span class="operator"><span class="keyword">SELECT</span>å­å¥</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stream s0 <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> s0 <span class="keyword">where</span> <span class="keyword">id</span>&gt;<span class="number">10</span></span><br><span class="line">                      <span class="comment">---------------        ----------- </span></span><br><span class="line">                      <span class="keyword">Aggregate</span>              Functor(expression)</span></span><br></pre></td></tr></table></figure>
<p>2ã€Join: å¤šä¸ªJoinçš„schemaï¼Œä¸€ä¸ªoutputschema. å…ˆæŸ¥è¯¢å‡ºå¤šä¸ªè¡¨æ‰€æœ‰çš„åˆ—ï¼Œå†åœ¨functorç®—å­ä¸­è¿›è¡Œåˆ—è¿‡æ»¤ã€‚  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">select</span> s0.<span class="keyword">id</span>,s1.<span class="keyword">name</span> <span class="keyword">from</span> s0 <span class="keyword">join</span> s1 <span class="keyword">on</span> s0.<span class="keyword">id</span> = s1.<span class="keyword">id</span></span><br><span class="line">                     <span class="comment">------- -------</span></span><br><span class="line">                     s0å…ƒæ•°æ® s1å…ƒæ•°æ®</span><br><span class="line">                            â¬‡ï¸</span><br><span class="line">       <span class="comment">-----------------------------</span></span><br><span class="line">       Functoråˆ—è¿‡æ»¤</span></span><br></pre></td></tr></table></figure>
<p>3ã€Groupby: èšåˆç®—å­<br>4ã€orderby: åŒä¸€èˆ¬selectå­å¥<br>5ã€Joinè¯­å¥ä¸­ä¸æ”¯æŒèšåˆå’Œgroupbyï¼Œè‡³å°‘ç›®å‰ä¸æ”¯æŒ<br>6ã€ä¸‰ç§è¿‡æ»¤<br>A.çª—å£ä¹‹åçš„è¿‡æ»¤ï¼šwhereï¼Œæ”¾åœ¨èšåˆç®—å­ä¸­<br>B.çª—å£ä¹‹å‰çš„è¿‡æ»¤ï¼šfilterï¼Œå‰é¢åŠ ä¸€ä¸ªfilterç®—å­, ä½†æ˜¯è¿™æ ·å°±ç‰µæ‰¯åˆ°schemaçš„å˜åŒ–ï¼Œè¿™ä¸ªå°±éº»çƒ¦ä¸€äº›äº†ã€‚å…ˆè§£æå‡ºæ‰€æœ‰çš„åˆ—ï¼Œå†è¿›è¡Œè¿‡æ»¤ã€‚<br>C.èšåˆä¹‹åçš„è¿‡æ»¤ï¼šhavingï¼Œæ”¾åœ¨èšåˆç®—å­ä¸­  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> <span class="keyword">type</span>,<span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> s0 <span class="keyword">where</span> code=<span class="string">'test'</span> (<span class="keyword">id</span>&gt;<span class="number">10</span>)[<span class="keyword">ROWS</span> <span class="number">10</span>] <span class="keyword">HAVING</span> <span class="keyword">count</span>(<span class="keyword">id</span>)&gt;<span class="number">100</span> </span><br><span class="line">                              <span class="comment">----------------  -------          --------------------</span></span><br><span class="line">                              Aâ¬‡                Bâ¬‡ï¸              <span class="keyword">C</span>â¬‡ï¸</span><br><span class="line">                              <span class="keyword">Aggregate</span>         Filter+Agg       <span class="keyword">Aggregate</span></span></span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸‹ï¼š<br>1ã€<code>èšåˆç®—å­</code>æ˜¯å¿…é¡»æœ‰çš„ã€‚<br>2ã€Orderbyå¿…é¡»æ”¾åœ¨ç‹¬ç«‹sortç®—å­ä¸­<br>3ã€limitæ”¾åœ¨outputä¸­ä½œä¸ºé™åˆ¶ï¼Œä½†æ˜¯ç›®å‰è¿˜ä¸æ”¯æŒ<br>4ã€<code>ä¸€ä¸ªselectè¯­å¥ï¼Œæ— è®ºå¦‚ä½•æ‹†åˆ†ï¼Œéƒ½åªæœ‰ä¸€ä¸ªè¾“å‡ºschema</code>. (è‡³å°‘ç›®å‰æ˜¯è¿™æ ·,åé¢åœ¨ä¼˜åŒ–å™¨ä¸­ä¼šè¿›è¡Œè°ƒæ•´,å°†whereä¸­çš„ä¸€äº›åˆ—åŠ å…¥åˆ°selectä¸­,è¿›è¡Œä¸€äº›åˆ—å˜æ¢)<br>5ã€Joinæ—¶å€™ï¼Œå…ˆæŸ¥è¯¢è¯¥æµ<code>æ‰€æœ‰åˆ—</code>çš„Joinç»“æœï¼Œä¹‹åå†è¿›è¡Œ<code>åˆ—è¿‡æ»¤</code><br>6ã€Sortã€Joinã€Aggregateç®—å­éƒ½æ˜¯æŒ‰ç…§<code>å­—æ®µ</code>è¿›è¡Œåˆ†å‘ï¼Œå…¶ä»–éƒ½æ˜¯<code>éšæœº</code>åˆ†å‘  </p>
<p>æŠ½è±¡ç±»SelectSplitterçš„splitFromClauseäº¤ç»™å­ç±»(Join,DataSource,AggregatePlitter)è‡ªå·±å»å®ç°:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectSplitter</span> <span class="keyword">implements</span> <span class="title">Splitter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SplitContext result = <span class="keyword">new</span> SplitContext();       <span class="comment">//ç®—å­çš„æ‹†åˆ†ç»“æœ, æ•°æ®ä¸»è¦ç”±AnalyzeContextè€Œæ¥</span></span><br><span class="line">    <span class="keyword">private</span> SelectAnalyzeContext selectAnalyzeContext;      <span class="comment">//AnalyzeContextè¯­ä¹‰è§£æç»“æœ    </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SplitContext <span class="title">split</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        initParameters(parseContext);   <span class="comment">//åˆå§‹åŒ–, ç”±äºSelectè¯­å¥åŒ…å«äº†å¾ˆå¤šå­å¥,å› æ­¤è¿˜è¦åœ¨è¿™é‡Œå®šä¹‰å…¶ä»–å­å¥çš„AnalyzeContext.</span></span><br><span class="line">        setParallelNumber();</span><br><span class="line">        splitFromClause();              <span class="comment">//æŠ½è±¡æ–¹æ³•</span></span><br><span class="line">        result.setParseContext(selectAnalyzeContext);       <span class="comment">//è®¾ç½®åˆ°SplitContextç»“æœä¸­</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SelectClauseAnalyzeContext selectClauseContext; <span class="comment">//æ—¢ç„¶è¦è§£æSlectè¯­å¥,å°±è¦è§£æå®ƒåŒ…å«çš„æ‰€æœ‰å­å¥! æ­£å¦‚å‰é¢çš„insertä¹Ÿè¦å…ˆè·å¾—select!</span></span><br><span class="line">    <span class="keyword">private</span> FromClauseAnalyzeContext fromClauseContext;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initParameters</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        selectAnalyzeContext = (SelectAnalyzeContext)parseContext;</span><br><span class="line">        selectClauseContext = selectAnalyzeContext.getSelectClauseContext();</span><br><span class="line">        fromClauseContext = selectAnalyzeContext.getFromClauseContext();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…³äºå±‚çº§åµŒå¥—: æ¯”å¦‚insertä¸­åµŒå¥—äº†select. æ‰€ä»¥è§£æinsertæ—¶è¦å…ˆè§£æselect,å†æŠŠselectè®¾ç½®åˆ°insertä¸­.<br>åŒæ ·selectè¯­å¥åŒ…å«äº†æ›´å¤šçš„å­å¥,æ¯”å¦‚selectå­å¥,fromå­å¥, æ‰€ä»¥ä¹Ÿè¦æŠŠæ——ä¸‹åŒ…å«çš„æ‰€æœ‰å­å¥éƒ½è§£æå®Œäº†,è‡ªå·±æ‰æ˜¯å®Œæ•´çš„å¯ç”¨çš„.  </p>
</blockquote>
<h3 id="AggregateSplitter_-&gt;_FilterOp_+_AggregateOp_+_Transition">AggregateSplitter -&gt; FilterOp + AggregateOp + Transition</h3><p>AggregateSplitterçš„çˆ¶ç±»æ˜¯SelectSplitter, è€ŒSelectåŒ…å«Fromå­å¥. Fromä¸­å¯ä»¥æœ‰â‘ FilterOperator: <code>filter before window</code><br>æµå‰çš„è¿‡æ»¤: <code>FROM transform (evnetid&gt;10)[range UNBOUNDED]</code>. å…¶ä¸­[]è¡¨ç¤ºwindow, è€Œ[]å‰é¢çš„()åˆ™æ˜¯filterè¿‡æ»¤.<br>â‘¡æ‹†åˆ†AggregateOperator, å› ä¸ºèšåˆç®—å­å¯èƒ½åŒ…æ‹¬å¤šç§èšåˆæ“ä½œ, å¦‚æœå­˜åœ¨åˆ™éƒ½è®¾ç½®åˆ°AggregateOperatorå¯¹åº”çš„å­—æ®µä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">splitFromClause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–Selectä¸­Fromå­å¥çš„è¯­ä¹‰è§£æç»“æœ</span></span><br><span class="line">    FromClauseAnalyzeContext clauseContext = getFromClauseContext();    <span class="comment">//å®šä¹‰åœ¨çˆ¶ç±»SelectSplitterä¸­,åˆå§‹åŒ–æ—¶ç”±Selectè·å–</span></span><br><span class="line">    String streamName = clauseContext.getInputStreams().get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//â‘  åœ¨Windowæ“ä½œå‰å¯ä»¥æœ‰Filteræ“ä½œ, æ‹†åˆ†å‡ºFilterç®—å­, åœ¨çˆ¶ç±»SelectSplitterä¸­å®ç°</span></span><br><span class="line">    FilterOperator fop = splitFiterBeforeWindow(streamName);</span><br><span class="line">    <span class="comment">//â‘¡ èšåˆç®—å­</span></span><br><span class="line">    AggregateOperator aggregateOperator = splitAggregateOperator(clauseContext, streamName);</span><br><span class="line">    <span class="comment">//â‘¢ åˆ›å»ºç®—å­ä¹‹é—´çš„è¿æ¥</span></span><br><span class="line">    OperatorTransition transition = createTransition(fop, aggregateOperator, streamName);</span><br><span class="line">    </span><br><span class="line">    getResult().addOperators(fop);                  <span class="comment">//è¿‡æ»¤ç®—å­</span></span><br><span class="line">    getResult().addOperators(aggregateOperator);    <span class="comment">//èšåˆç®—å­</span></span><br><span class="line">    getResult().addTransitions(transition);         <span class="comment">//ä»è¿‡æ»¤ç®—å­åˆ°èšåˆç®—å­çš„è¿çº¿</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> FilterOperator <span class="title">splitFiterBeforeWindow</span><span class="params">(String streamName)</span> </span>&#123;</span><br><span class="line">    FromClauseAnalyzeContext clauseContext = getFromClauseContext();</span><br><span class="line">    <span class="comment">//æ–°åˆ›å»ºä¸€ä¸ªFilterè¿‡æ»¤ç®—å­, from stream(id&gt;1)[RANGE 10s] å¯ä»¥åœ¨æµä¹‹å,çª—å£ä¹‹å‰çš„ä¸­é—´å­˜åœ¨Filterè¿‡æ»¤: åœ¨è¿›å…¥çª—å£å‰è¿‡æ»¤</span></span><br><span class="line">    FilterOperator fop = <span class="keyword">new</span> FilterOperator(buildUtils.getNextOperatorName(<span class="string">"Filter"</span>), parallelNumber);</span><br><span class="line">    <span class="comment">//ä»Fromè¯­ä¹‰è§£æç»“æœä¸­è·å–filterBeforeWindowå¯¹åº”å½“å‰streamçš„filterè¡¨è¾¾å¼,æ¯”å¦‚ä¸Šé¢çš„id&gt;1</span></span><br><span class="line">    ExpressionDescribe expression = clauseContext.getFilterBeForeWindow().get(streamName);</span><br><span class="line">    fop.setFilterExpression(expression.toString());                     <span class="comment">//è¿‡æ»¤æ¡ä»¶è¡¨è¾¾å¼,æ¯”å¦‚id&gt;1</span></span><br><span class="line">    fop.setOutputExpression(createFilterOutputExpression(streamName));  <span class="comment">//è¾“å‡ºåˆ—</span></span><br><span class="line">    <span class="keyword">return</span> fop;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> AggregateOperator <span class="title">splitAggregateOperator</span><span class="params">(FromClauseAnalyzeContext clauseContext, String streamName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°çš„èšåˆç®—å­</span></span><br><span class="line">    AggregateOperator aggop = <span class="keyword">new</span> AggregateOperator(getBuildUtils().getNextOperatorName(<span class="string">"Aggregator"</span>), getParallelNumber());</span><br><span class="line">    parseWindow(clauseContext, streamName, aggop);  <span class="comment">//è§£æçª—å£. Windowå…¶å®ä¹Ÿæ˜¯Fromçš„ä¸€éƒ¨åˆ†,æ‰€ä»¥éœ€è¦ä»Fromå­å¥ä¸­è·å–Windowsè®¾ç½®åˆ°aggopé‡Œ</span></span><br><span class="line">    parseWhere(aggop);                              <span class="comment">//è§£æè¿‡æ»¤: setFilterBeforeAggregate,åœ¨èšåˆä¹‹å‰çš„è¿‡æ»¤.</span></span><br><span class="line">    aggop.setFilterAfterAggregate(parseHaving());   <span class="comment">//è§£æhaving</span></span><br><span class="line">    aggop.setGroupbyExpression(parseGroupby());     <span class="comment">//è§£æåˆ†ç»„</span></span><br><span class="line">    aggop.setOrderBy(parseOrderBy());               <span class="comment">//è§£ææ’åº</span></span><br><span class="line">    aggop.setLimit(parseLimit());                   <span class="comment">//è§£æé™åˆ¶</span></span><br><span class="line">    aggop.setOutputExpression(getSelectClauseContext().toString());     <span class="comment">//è¾“å‡ºè¡¨è¾¾å¼: selectå…³é”®å­—åé¢çš„éƒ½æ˜¯è¾“å‡º</span></span><br><span class="line">    <span class="keyword">return</span> aggop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>AggregateOperatorå¯¹Selectå­å¥çš„è§£ææœ€åéƒ½æ˜¯å­—ç¬¦ä¸².  </p>
</blockquote>
<table>
<thead>
<tr>
<th>aggregation</th>
<th>setXXX</th>
<th>AnalyzerContext</th>
<th>parseXXX</th>
</tr>
</thead>
<tbody>
<tr>
<td>window</td>
<td>setWindow</td>
<td>FromClauseAnalyzeContext.windows.get(streamName)</td>
<td>parseWindow</td>
</tr>
<tr>
<td>where</td>
<td>setFilterBeforeAggregate</td>
<td>FilterClauseAnalzyeContext whereClauseContext</td>
<td>parseWhere</td>
</tr>
<tr>
<td>having</td>
<td>setFilterAfterAggregate</td>
<td>FilterClauseAnalzyeContext havingClauseContext</td>
<td>parseHaving</td>
</tr>
<tr>
<td>group by</td>
<td>setGroupbyExpression</td>
<td>SelectClauseAnalyzeContext groupbyClauseContext</td>
<td>parseGroupby</td>
</tr>
<tr>
<td>order by</td>
<td>setOrderBy</td>
<td>OrderByClauseAnalyzeContext</td>
<td>parseOrderBy</td>
</tr>
<tr>
<td>limit</td>
<td>setLimit</td>
<td>LimitClauseAnalzyeContext</td>
<td>parseLimit</td>
</tr>
<tr>
<td>output exp</td>
<td>setOutputExpression</td>
<td>SelectClauseAnalyzeContext selectClauseContext</td>
<td>getSelectClauseContext</td>
</tr>
</tbody>
</table>
<p>é€šè¿‡ä¸Šé¢çš„AggregateSplitter.splitæ–¹æ³•,æˆ‘ä»¬çŸ¥é“äº†èšåˆç®—å­ç”±FilterBeforeWindow,Window,FilterBeforeAggregate,Having,GroupBy,OrderBy,Limitç»„æˆ.  </p>
<blockquote>
<p>è¯­æ³•ç»“æ„ä¸­å¹¶æ²¡æœ‰Aggregateè¿™ç§ç±»å‹, ä½†æ˜¯æˆ‘ä»¬å‘ç°Aggregateç”¨åˆ°çš„è¿™äº›å’ŒSelectè¯­å¥ä¸­åŒ…å«çš„å­å¥éƒ½å·®ä¸å¤š. å…¶ä¸­ä¸¤ä¸ªWindowå¯ä»¥è®¤ä¸ºæ˜¯Fromå­å¥.<br>FilterBeforeAggregateæ˜¯Whereå­å¥, è¿™æ ·Selectè¯­å¥çš„æ‰€æœ‰éƒ¨åˆ†å°±å’ŒAggregateéƒ½å»åˆäº†! æ‰€ä»¥è¯´Selectä¹Ÿæ˜¯ä¸€ç§Aggregate! (^_^è¿™ä¸æ˜¯å·§åˆå§) </p>
</blockquote>
<h4 id="AggregateOperator">AggregateOperator</h4><p><img src="http://img.blog.csdn.net/20151126173430754" alt="stream-operators"></p>
<p>AggregateOperatorèšåˆç®—å­:åŒ…å«äº†window,ä»¥åŠwindowå‰åçš„filteræ“ä½œ. å½“ç„¶è¿˜å°‘ä¸äº†count,sumä¹‹ç±»çš„UDAFå‡½æ•°è®¡ç®—å’ŒUDFå‡½æ•°è®¡ç®—(BasicAggFunctionOperator)<br>AggregateOperator &gt;&gt; BasicAggFunctionOperator &gt;&gt; InnerFunctionOperator è¿™äº›ç±»çš„å­—æ®µæ­£å¥½å¯¹åº”äº†èšåˆç®—å­çš„æ‰€æœ‰ç»„æˆéƒ¨åˆ†.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AggregateOperator</span> <span class="keyword">extends</span> <span class="title">BasicAggFunctionOperator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Window window;                  <span class="comment">//çª—å£ ==&gt; Fromå­å¥</span></span><br><span class="line">    <span class="keyword">private</span> String filterBeforeAggregate;   <span class="comment">//filterçš„è¿‡æ»¤æ¡ä»¶ ==&gt; Whereå­å¥</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicAggFunctionOperator</span> <span class="keyword">extends</span> <span class="title">InnerFunctionOperator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String filterAfterAggregate;    <span class="comment">//èšåˆç±»çš„è¿‡æ»¤æ¡ä»¶, è¿™é‡Œéƒ½æ˜¯udafå‡½æ•°, è¿‡æ»¤ä¸€å®šå‘ç”Ÿåœ¨æ•°æ®èšåˆä¹‹å, è¿™é‡Œçš„è¡¨è¾¾å¼ä¸€å®šä½¿ç”¨çš„æ˜¯outputSchemaä¸­çš„åˆ—åç§°</span></span><br><span class="line">    <span class="keyword">private</span> String groupbyExpression;       <span class="comment">//åˆ†ç»„çš„è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="keyword">private</span> String orderBy;                 <span class="comment">//æ’åº: å…è®¸æœ‰å¤šä¸ªå­—æ®µï¼Œä¹‹é—´æŒ‰ç…§é€—å·åˆ†å‰², å…è®¸å‡ºç°udfå’Œudafå‡½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> Integer limit;                  <span class="comment">//çª—å£çš„è¾“å‡ºé™åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerFunctionOperator</span> <span class="keyword">extends</span> <span class="title">Operator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String outputExpression;        <span class="comment">//è¾“å‡ºçš„åˆ—å®šä¹‰,ä¸å…‰æœ‰å•çº¯çš„åˆ—ï¼Œè¿˜æœ‰udfä»¥åŠudafå‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡æ»¤æ¡ä»¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„é€»è¾‘è¡¨è¾¾å¼, å…è®¸æœ‰and,orä»¥åŠå¤§æ‹¬å·å’Œudfå‡½æ•°, ä½†æ˜¯ç»å¯¹ä¸å…è®¸å‡ºç°udafå‡½æ•°ï¼Œå› ä¸ºè¿™æ²¡æœ‰èšåˆæ“ä½œ<br><strong>è¿‡æ»¤å‘ç”Ÿåœ¨æ•°æ®è¿›å…¥çª—å£ä¹‹åï¼Œèšåˆä¹‹å‰</strong>. æ¯”å¦‚ (a&gt;1 and a &lt;100) or (b is not null) å°±æ˜¯whereçš„è¿‡æ»¤ï¼Œ </p>
<p>InnerFunctionOperatoråŠŸèƒ½æ€§ç®—å­ï¼Œä¸»è¦ä¸ºç³»ç»Ÿæä¾›windowï¼Œjoinï¼Œorder byï¼Œgroup byç­‰èšåˆæ“ä½œã€‚<br>è¿™é‡Œçš„åç§°å’ŒoperatoråŒ…ä¸­çš„ä¸ä¸€æ ·. è¿™é‡Œå®šä¹‰çš„è¿™äº›operatorï¼Œä¸»è¦æ˜¯è¿›è¡Œæ‰§è¡Œè®¡åˆ’çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ã€‚<br>æ‰€æœ‰çš„æ•°æ®ç±»å‹å…¨éƒ¨æ˜¯<code>å­—ç¬¦ä¸²ç±»å‹</code>ï¼Œä¹‹åè¿˜è¦ç»è¿‡è¯­æ³•çš„è§£æï¼Œç‰©ç†æ‰§è¡Œè®¡åˆ’çš„ä¼˜åŒ–ä¹‹åï¼Œæ‰ä¼šåœ¨applicationä¸­æäº¤ã€‚ </p>
<h4 id="Transition">Transition</h4><p>åˆ«å¿˜äº†,è¿˜æœ‰createTransitionåˆ›å»ºè¿çº¿å“¦: åœ¨AggregateSplitter.splitFromClauseä¸­fromOpæ˜¯FilterBeforeWindow FilterOperator, toOpæ˜¯AggregateOperator.  </p>
<p>ç®—å­ä¹‹é—´è¿›è¡Œè¿æ¥, æ¶‰åŠåˆ°åˆ†ç»„ç­–ç•¥, Stormä¸­Boltå¯ä»¥æŒ‡å®šæ€ä¹ˆæ ¹æ®è¾“å…¥æºè¿›è¡Œåˆ†ç»„, å³è¾“å…¥æºå°†æ•°æ®æ€ä¹ˆåˆ†æµåˆ°å½“å‰Bolt. åˆ†ç»„æ˜¯æœ‰ä¸€å®šä¾æ®çš„,ä¸èƒ½èƒ¡ä¹±è¿æ¥.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> OperatorTransition <span class="title">createTransition</span><span class="params">(Operator fromOp, Operator toOp, String streamName)</span> </span>&#123;</span><br><span class="line">    FromClauseAnalyzeContext clauseContext = getFromClauseContext();</span><br><span class="line">    DistributeType distype = DistributeType.SHUFFLE;</span><br><span class="line">    String disFields = <span class="keyword">null</span>;</span><br><span class="line">    Schema schema = clauseContext.getInputSchemas().get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæœ‰GroupBy,åˆ†ç»„ç­–ç•¥å°±æ˜¯å­—æ®µåˆ†ç»„(distype=FIELDS), æ¯”å¦‚group by type, åˆ™æŒ‰ç…§typeå­—æ®µåˆ†ç»„(disFields=type).  </span></span><br><span class="line">    <span class="keyword">if</span> (getGroupbyClauseContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        disFields = removeDataSourceColumnsFromGroupbyExpression(schema, getGroupbyClauseContext().toString());</span><br><span class="line">        distype = DistributeType.FIELDS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç°åœ¨æ˜¯åœ¨SelectSpiltterä¸­, æ‰€ä»¥å¯èƒ½æ˜¯Aggregate,Join,DataSourceä¸­ä»»æ„ä¸€ç§.  </span></span><br><span class="line">    <span class="keyword">if</span> (toOp <span class="keyword">instanceof</span> JoinFunctionOperator) &#123;</span><br><span class="line">        List&lt;Schema&gt; inputSchemas = getFromClauseContext().getInputSchemas();</span><br><span class="line">        schema = BaseAnalyzer.getSchemaByName(streamName, inputSchemas);</span><br><span class="line">        <span class="keyword">if</span> (((JoinFunctionOperator)toOp).getJoinType() != JoinType.CROSS_JOIN) &#123;</span><br><span class="line">            disFields = getJoinExpression(schema);</span><br><span class="line">            distype = DistributeType.FIELDS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºèµ·å§‹ç®—å­åˆ°ç»“æŸç®—å­ä¹‹é—´çš„è¿çº¿, å¹¶ç¡®å®šåˆ†ç»„ç­–ç•¥,åˆ†ç»„å­—æ®µ, å‘èµ·è¿æ¥çš„ç®—å­çš„schemaä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OperatorTransition(buildUtils.getNextStreamName(), fromOp, toOp, distype, disFields, schema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç°åœ¨ä¼¼ä¹è¦é€æ­¥ç”¨Stormçš„ä¾‹å­æ¥ç†è§£äº†,å¦åˆ™ç®—å­ä¹‹é—´ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¿æ¥? è¿æ¥ä¹‹åå°±ç¡®å®šäº†ä¸Šæ¸¸ç®—å­æ€ä¹ˆå‘é€æ•°æ®åˆ°ä¸‹æ¸¸ç®—å­. å‡è®¾Stormæœ‰ä¸¤ä¸ªBolt: Bolt1å’ŒBolt2.<br>Bolt1è¿‡æ»¤æ•°æ®,è¾“å‡º(word,count)ä¸¤ä¸ªå­—æ®µ. ä¸ºäº†èƒ½ä½¿å¾—å¯¹Bolt1è¿‡æ»¤åçš„æ•°æ®è¿›è¡Œåˆ†æµ,Bolt2ä½¿ç”¨Bolt1çš„wordå­—æ®µè¿›è¡ŒFieldGrouping. è¿™æ ·Bolt1ç›¸åŒçš„wordå­—æ®µ<br>åªä¼šåˆ°ç›¸åŒçš„Boltä»»åŠ¡ä¸­, ä¸åŒçš„wordå­—æ®µä¼šåˆ†å‘åˆ°ä¸åŒçš„Bolt2ä»»åŠ¡. æ‰€ä»¥å¯ä»¥æŠŠBolt1çœ‹åšè¿‡æ»¤ç®—å­, Bolt2çœ‹åšæ˜¯èšåˆç®—å­, ä¸­é—´å­˜åœ¨åˆ†ç»„è¿æ¥å¯¹Bolt1çš„æ•°æ®åˆ†æµ.  </p>
<p>é‚£ä¹ˆå…·ä½“ä¸‹æ¸¸ç®—å­è¦æ€ä¹ˆæ¥æ”¶ä¸Šæ¸¸ç®—å­çš„æ•°æ®å‘¢? ä¸ç”¨æ‹…å¿ƒ! è¿™é‡Œå…ˆåªæ˜¯åˆ›å»ºè¿æ¥,åªè¦æœ‰è¿æ¥,å°±éƒ½å¥½åŠäº†,æ‰¾å¯¹å…³ç³»æ‰¾å¯¹é—¨è·¯æ˜¯æœ€é‡è¦çš„!</p>
</blockquote>
<h4 id="SplitContext">SplitContext</h4><p>ç°åœ¨ä¸éš¾çœ‹å‡ºSplitContextçš„ä½œç”¨æ˜¯å„ç±»è¯­ä¹‰åˆ†æç»“æœæ‹†åˆ†å†…å®¹. å’Œå‰é¢å‡ ä¸ªXXXContextä¸€æ ·éƒ½åªæ˜¯ä¿å­˜æ•°æ®çš„ä»‹è´¨(è¿˜è®°å¾—StatementContext,AnalyzeContextå—)<br>å¸¸è§çš„CQLè¯­å¥æ ¼å¼<code>insert into stream s0 select</code>ä¸­insertè¯­å¥ç¡®å®šäº†<code>outputStreamName</code>, selectè¯­å¥ç¡®å®šç®—å­æ‹†åˆ†çš„ç»“æœ:<code>operatorså’Œtransitions</code>.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;OperatorTransition&gt; transitions = <span class="keyword">new</span> ArrayList&lt;OperatorTransition&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;Operator&gt; operators = <span class="keyword">new</span> ArrayList&lt;Operator&gt;();</span><br><span class="line">    <span class="keyword">private</span> String outputStreamName;        <span class="comment">//è¾“å‡ºçš„æµåç§°: æŒ‡çš„æ˜¯åœ¨CQLä¸­æ˜¾ç¤ºæŒ‡å®šè¾“å‡ºæµåç§°çš„ã€‚ä¾‹å¦‚insert into ä¹‹ç±»çš„è¯­å¥</span></span><br><span class="line">    <span class="keyword">private</span> AnalyzeContext parseContext;    <span class="comment">//CQLè§£æç»“æœ: é€šè¿‡è¿™ä¸ªç»“æœï¼Œå¯ä»¥è¿›è¡Œå¤šä¸ªCQLä¹‹é—´çš„è¿æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ¯ä¸€æ¡CQLè¯­å¥éƒ½å¯¹åº”ä¸€ä¸ªAnalyzeContext, æ¯ä¸ªAnalyzeContextéƒ½æœ‰ä¸€ä¸ªSplitterç”¨æ¥åˆ›å»ºç®—å­. å³ä½¿ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†Transitionè¿æ¥, ä½†ä¹Ÿæ˜¯åœ¨åŒä¸€ä¸ªCQLè¯­å¥å†…çš„!<br>è€Œä¸€ä¸ªå®Œæ•´çš„Topologyæ˜¯è¦æ±‚èƒ½æŠŠå¤šä¸ªCQLè¯­å¥çš„ä¸Šä¸‹æ–‡éƒ½ä¸²è”èµ·æ¥ç»„æˆä¸€ä¸ªDAGå›¾çš„. æ‰€ä»¥è¿™å°±æ˜¯åœ¨SplitContextä¸­ä¿ç•™AnalyzeContextçš„å«ä¹‰: Itâ€™ time to Combine!  </p>
</blockquote>
<h3 id="OperatorCombiner">OperatorCombiner</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿›è¡Œåˆå¹¶äº†,å› ä¸ºå¦‚æœä»…ä»…æ˜¯æ‹†åˆ†æ¯ä¸€æ¡CQLè¯­å¥, è¿™æ ·æœ€åéƒ½æ˜¯ä¸€æ®µä¸€æ®µçš„,æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›ä¸€æ®µä¸€æ®µæ‹¼æ¥æˆå®Œæ•´çš„å›¾.<br>ç›®å‰åªæœ‰ä¸¤ç§CQLè¯­å¥: ä¸€ç§æ˜¯æµå®šä¹‰create streamè¯­å¥, ä¸€ç§æ˜¯insert intoè¯­å¥. å¯¹äºæµå®šä¹‰æ²¡æœ‰ç®—å­ä¹‹é—´çš„è¿æ¥,ä½†æ˜¯schemaè¿˜æ˜¯éœ€è¦çš„.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SplitContext <span class="title">combine</span><span class="params">(List&lt;SplitContext&gt; splitContexts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; splitContexts.size(); i++) &#123;</span><br><span class="line">        combineSplitContext(splitContexts.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineSplitContext</span><span class="params">(SplitContext context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åŸå§‹æ¯ä¸€æ¡CQLçš„ç®—å­å’Œè¿çº¿ä¸èƒ½è¢«ç ´åçš„! è¦é‡æ–°åŠ å…¥æœ€åçš„è¿”å›ç»“æœä¸­. </span></span><br><span class="line">    result.getOperators().addAll(context.getOperators());</span><br><span class="line">    result.getTransitions().addAll(context.getTransitions());</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯SourceOperatorSplitterå¯¹åº”çš„CreateStreamAnalyzeContext, æ˜¯æ²¡æœ‰transitionçš„.  </span></span><br><span class="line">    <span class="keyword">if</span> (context.getParseContext() <span class="keyword">instanceof</span> CreateStreamAnalyzeContext)&#123;</span><br><span class="line">        addSchemasFromCreateStream(context);    <span class="comment">//æ·»åŠ åˆ°inputStreams,outputStreams,pipeStreams</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå¹¶æ—¶æ–°æ·»åŠ çš„åªæ˜¯CQLä¸CQLä¹‹é—´çš„è¿çº¿! å¯¹äºç®—å­å·²ç»éƒ½æ˜¯å®Œæ•´çš„äº†,ä¸ä¼šç¼ºèƒ³è†Šæ–­è…¿çš„,ä¸éœ€è¦å†æ·»åŠ . â¬…ï¸</span></span><br><span class="line">    createTransition(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTransition</span><span class="params">(SplitContext context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//MultiInsertStatementAnalyzeContext</span></span><br><span class="line">    <span class="comment">//InsertUserOperatorStatementAnalyzeContext</span></span><br><span class="line">    InsertAnalyzeContext insertContext = (InsertAnalyzeContext)context.getParseContext();</span><br><span class="line">    createFromTransition(context, insertContext);</span><br><span class="line">    createToTransition(context, insertContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Splitterä¸­SourceOperatorSplitteræ˜¯æ²¡æœ‰operatorså’Œtransitions, InsertSplitterçš„ç®—å­å’Œè¿çº¿åˆ™ä¾èµ–äºSelectSpitter.<br>æ‰€ä»¥å¦‚æœæ˜¯CreateStreamAnalyzeContextåˆ™ä¸ä¼šè°ƒç”¨createTransition, åªæœ‰ä¸‰ç§insertæ‰ä¼šè°ƒç”¨:Insert,MultiInsert,UDFInsert    </p>
</blockquote>
<p>å°†å¤šä¸ªç®—å­ç»„åˆèµ·æ¥, ç»„å»ºç®—å­ä¹‹é—´çš„ä¸Šä¸‹çº§å…³ç³». ç®—å­ä¹‹é—´çš„è¿çº¿ï¼Œæœ‰ä¸¤ç§æ¥æºï¼š<br>1ã€ç®—å­æ˜¯ç”±<code>ä¸€æ¡CQLè¯­å¥</code>æ‹†åˆ†å‡ºå¤šä¸ªç®—å­ç»„æˆï¼Œè¿™æ ·ï¼Œè¿çº¿å°±å¯ä»¥åœ¨æ‹†åˆ†çš„æ—¶å€™ç¡®å®šã€‚<br>2ã€ç®—å­æ˜¯ç”±<code>å¤šæ¡CQLè¯­å¥</code>ç»„åˆè€Œæ¥ï¼Œé€šè¿‡ä½¿ç”¨<code>insert into select from</code>è¿™æ ·çš„è¯­å¥ï¼Œå°±å¯ä»¥å®ç°å¤šä¸ªç®—å­ä¹‹é—´çš„çº§è”ã€‚<br>ç”šè‡³å¯ä»¥æ”¹å˜ç®—å­ä¹‹é—´çš„è¿æ¥å…³ç³»ã€‚æ¯”å¦‚åœ¨aggregateç®—å­ä¹‹å‰åŠ å…¥unionç®—å­, åœ¨aggregateç®—å­ä¹‹ååŠ å…¥splitç®—å­ã€‚  </p>
<p>ä¸ºæ¯ä¸ª<code>insert into select</code>è¯­å¥è§£æå‡ºæ¥çš„ç»“æœåŠ å…¥ä¸Šä¸‹æ–‡è¿çº¿ã€‚<br>CQLè¯­å¥ä¹‹é—´çš„è¿çº¿ï¼Œå¿…ç„¶ä»inputStreamæˆ–è€…PipeStreamå‘èµ·ï¼Œè¿æ¥åˆ°outputStreamæˆ–è€…PipeStream.  </p>
<p><img src="http://img.blog.csdn.net/20151129160212682" alt="input-pipe-output"></p>
<h4 id="PipeStream">PipeStream</h4><p>splitOperatorsåœ¨æ‹†åˆ†ä¹‹å‰, ä¼šé¦–å…ˆè§£ææ˜¯å¦éœ€è¦åˆ›å»ºä¹‹å‰æ²¡æœ‰å£°æ˜è¿‡çš„æµ. å¦‚æœä¸å­˜åœ¨,åˆ™åˆ›å»ºPipeStream.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAutoCreatePipeStream</span><span class="params">(List&lt;SplitContext&gt; splitContexts, AnalyzeContext pcontext)</span> </span>&#123;</span><br><span class="line">    parseAutoCreatePipeStreamForInsert(splitContexts, pcontext);</span><br><span class="line">    parseAutoCreatePipeStreamForMultiInsert(splitContexts, pcontext);</span><br><span class="line">    parseAutoCreatePipeStreamForUserOperator(splitContexts, pcontext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAutoCreatePipeStreamForInsert</span><span class="params">(List&lt;SplitContext&gt; splitContexts, AnalyzeContext pcontext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pcontext <span class="keyword">instanceof</span> InsertAnalyzeContext) &#123;</span><br><span class="line">        InsertAnalyzeContext ipc = (InsertAnalyzeContext)pcontext;</span><br><span class="line">        <span class="keyword">if</span> (!ipc.isPipeStreamNotCreated()) <span class="keyword">return</span>;      <span class="comment">//å…è®¸ç±»å‹ä¸æ˜¯è¾“å…¥/è¾“å‡ºæµçš„æµä¸å­˜åœ¨   </span></span><br><span class="line">        SplitContext sc = createPipeStreamSplitContext(ipc.getOutputSchema());</span><br><span class="line">        splitContexts.add(sc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> SplitContext <span class="title">createPipeStreamSplitContext</span><span class="params">(Schema schema)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"create pipe Stream while stream is not created!"</span>);</span><br><span class="line">    CreateStreamAnalyzeContext pipe = <span class="keyword">new</span> CreateStreamAnalyzeContext();</span><br><span class="line">    pipe.setSchema(schema);</span><br><span class="line">    pipe.setStreamName(schema.getId());</span><br><span class="line">    <span class="keyword">return</span> OperatorSplitter.split(buildUtils, pipe);    <span class="comment">//è¾“å…¥è¾“å‡ºæµä½¿ç”¨SourceOperatorSplitteræ‹†åˆ†ç®—å­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚ä¸‹é¢çš„<code>multi insert</code>è¯­å¥, å…¶ä¸­teststreamæ˜¯äº‹å…ˆåˆ›å»ºå¥½çš„, è€Œs1,s2,s3éƒ½æ²¡æœ‰åˆ›å»ºè¿‡, åœ¨è§£æçš„æ—¶å€™åˆ¤æ–­è¿™äº›insertå¯¹åº”çš„streamæ²¡æœ‰åˆ›å»ºè¿‡,<br>å°±ä¼šåˆ›å»ºè¿™äº›pipe-stream. å› ä¸ºinsertçš„schemaå–å†³äºselect, æ‰€ä»¥è¿™äº›pipe-streamçš„schemaç­‰äºInsertAnalyzeContextçš„outputSchema.   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM teststream</span><br><span class="line">  <span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s1 <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s2 <span class="keyword">SELECT</span> a</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s3 <span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">10</span></span><br><span class="line">PRARLLEL <span class="number">4</span>;</span></span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­PipeStreamæ˜¯å¦åˆ›å»ºè¿‡åœ¨InsertStatementAnalyzer.analyzeä¸­. åªè¦æ˜¯insertè¯­å¥, å¦‚æœåœ¨ç³»ç»Ÿå·²æœ‰çš„schemasä¸­ä¸å­˜åœ¨, å°±è®¾ç½®setPipeStreamNotCreated=true<br>è¿™æ ·parseAutoCreatePipeStreamForInsertåœ¨åˆ¤æ–­åˆ°isPipeStreamNotCreatedæ‰ä¼šåˆ›å»ºcreatePipeStreamSplitContext. å¦åˆ™schemaå·²ç»å­˜åœ¨å°±ä¸å†éœ€è¦åˆ›å»ºäº†.  </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (checkSchemaExists(streamName)) &#123;</span><br><span class="line">    context.setOutputSchema(getSchemaByName(streamName));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context.setPipeStreamNotCreated(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="From_&amp;_To_Transition">From &amp; To Transition</h4><p>é¦–å…ˆæ‰¾åˆ°insert intoè¯­å¥ä¸­è®¡ç®—å‡ºæ¥çš„è¿çº¿çš„èµ·ç‚¹ã€‚æ‰¾åˆ°å¯¹åº”çš„ç®—å­. ç„¶åæ ¹æ®èµ·ç‚¹çš„schemaåç§°ï¼Œæ‰¾åˆ°å¯¹åº”çš„æµåç§°ï¼Œåˆ›å»ºè¿çº¿  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createFromTransition</span><span class="params">(SplitContext context, InsertAnalyzeContext insertContext)</span> </span>&#123;</span><br><span class="line">    List&lt;OperatorTransition&gt; startTransitions = context.getFirstTransitons();</span><br><span class="line">    <span class="keyword">for</span> (OperatorTransition transition : startTransitions) &#123;</span><br><span class="line">        Operator op = context.getOperatorById(transition.getFromOperatorId());</span><br><span class="line">        String startStreamName = transition.getSchemaName();</span><br><span class="line">        SplitContext fromContext = getFromSplitContext(startStreamName);</span><br><span class="line">        Schema schema = getInputSchema(startStreamName, insertContext);</span><br><span class="line">        String nextStreamName = buildUtils.getNextStreamName();</span><br><span class="line">        </span><br><span class="line">        Operator fromOp = fromContext.getLastOperator();</span><br><span class="line">        OperatorTransition fromtransition = <span class="keyword">new</span> OperatorTransition(nextStreamName, fromOp, op, DistributeType.SHUFFLE, <span class="keyword">null</span>, schema);</span><br><span class="line">        result.addTransitions(fromtransition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createToTransition</span><span class="params">(SplitContext context, InsertAnalyzeContext insertContext)</span> </span>&#123;</span><br><span class="line">    Set&lt;Operator&gt; ops = getLastOperator(context);</span><br><span class="line">    <span class="keyword">for</span> (Operator op : ops) &#123;</span><br><span class="line">        String startStreamName = insertContext.getOutputStreamName();</span><br><span class="line">        SplitContext toContext = getToSplitContext(startStreamName);</span><br><span class="line">        Schema schema = insertContext.getOutputSchema();</span><br><span class="line">        String nextStreamName = buildUtils.getNextStreamName();</span><br><span class="line">        </span><br><span class="line">        Operator toOp = toContext.getFirstOperator();</span><br><span class="line">        OperatorTransition totransition = <span class="keyword">new</span> OperatorTransition(nextStreamName, op, toOp, DistributeType.SHUFFLE, <span class="keyword">null</span>, schema);</span><br><span class="line">        result.addTransitions(totransition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç‰©ç†ä¼˜åŒ–">ç‰©ç†ä¼˜åŒ–</h3><p>æ‹†åˆ†å¹¶ç»„åˆç®—å­å,å› ä¸ºæ¯ä¸ªç®—å­ä¹‹é—´éƒ½é€šè¿‡transitionæ¥è¿æ¥(æ²¡æœ‰é€šè¿‡è¿çº¿è¿æ¥çš„ç®—å­æ˜¯ä¸€ä¸ªå­¤å²›,æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„),æ‰€ä»¥å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–.<br>changeUnionOperators:unionç®—å­æ›¿æ¢å’ŒchangeSchemaAfterAggregate: æ›¿æ¢æ‰€æœ‰çš„havingå’Œorderbyè¿™äº›åœ¨èšåˆä¹‹åçš„è¡¨è¾¾å¼.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhysicOptimizer</span> <span class="keyword">implements</span> <span class="title">Optimizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">optimize</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> AggregateConverter().optimize(app);</span><br><span class="line">        <span class="keyword">new</span> FilterPruner().optimize(app);</span><br><span class="line">        <span class="keyword">new</span> SameStreamCombiner().optimize(app);</span><br><span class="line">        <span class="keyword">new</span> SameTransitionPruner().optimize(app);</span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storm/">storm</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-11-26-StreamCQL-schema" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-11-26-StreamCQL-schema/" class="article-date">
  	<time datetime="2015-12-01T10:02:58.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-11-26-StreamCQL-schema/">StreamCQLæºç é˜…è¯»(2) è¯­æ³•å’Œè¯­ä¹‰è§£æ</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="å‰æˆ:_SemanticAnalyzer">å‰æˆ: SemanticAnalyzer</h2><p>å®¢æˆ·ç«¯æäº¤çš„CQLè¯­å¥ç»è¿‡Application.parseè¿”å›StatementContext(è¯­æ³•è§£æç»“æœ),å†è¿›å…¥è¯­ä¹‰è§£æ.<br>å¦‚æœæ˜¯SubmitTaskä¼šè§¦å‘ä¹‹å‰çš„LazyTaské“¾æ¡ä¾æ¬¡è¿›è¡Œè¯­ä¹‰è§£æ. è¯­ä¹‰è§£æç»“æœAnalyzeContextæœ€åç”¨äºæ„å»ºApplication.<br>è¯­ä¹‰è§£æè·ŸCQLè¯­æ³•ç›¸å…³, ä¸è¿‡é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸‹æ„å»ºApplicationçš„ç¬¬ä¸€æ­¥æ˜¯è§£æschemas.    </p>
<h2 id="æ­£æ–‡ä¸€:_Schema">æ­£æ–‡ä¸€: Schema</h2><p>parseSchemasè§£æSchema: å¾ªç¯æ¯ä¸ªAnalyzeContextçš„getCreatedSchemas,æœ€åè®¾ç½®ä¸ºApplicationçš„schemas.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemas</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Schema&gt; schemas = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">for</span> (AnalyzeContext context : parseContexts) &#123;</span><br><span class="line">        schemas.addAll(context.getCreatedSchemas());</span><br><span class="line">    &#125;</span><br><span class="line">    app.setSchemas(schemas);    <span class="comment">//è®¾ç½®åˆ°Applicationé‡Œ â¬…ï¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="create_stream_schema">create stream schema</h3><p>é‚£ä¹ˆæ¯ä¸ªAnalyzeContextçš„CreatedSchemasæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è®¾ç½®è¿›æ¥çš„? ä»¥AnalyzeContextçš„ä¸€ä¸ªå®ç°ç±»CreateStreamAnalyzeContextä¸ºä¾‹:  </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CreateStreamAnalyzeContext.setSchema(Schema)  (com.huawei.streaming.cql.semanticanalyzer.analyzecontext)</span><br><span class="line">    <span class="string">|--CreatePipeStreamAnalyzer.analyze()  </span></span><br><span class="line">    <span class="string">|--ApplicationBuilder.createPipeStreamSplitContext(Schema)  (com.huawei.streaming.cql.builder)</span></span><br><span class="line">    <span class="string">|--CreateOutputStreamAnalyzer.analyze()  </span></span><br><span class="line">    <span class="string">|--FromClauseAnalyzer.createNewStreamContext(String, Schema)  </span></span><br><span class="line">    <span class="string">|--CreateInputStreamAnalyzer.analyze()       â¬…ï¸</span></span><br></pre></td></tr></table></figure>
<p>AnalyzeContextçš„setSchemaæ–¹æ³•ä¼šè¢«å¯¹åº”çš„SemanticAnalyzerå®ç°ç±»çš„analyzeè°ƒç”¨,æ¯”å¦‚CreateInputStreamAnalyzer:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AnalyzeContext <span class="title">analyze</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//createInputStreamParseContextè¿™ä¸ªæ˜¯ParseContextè¯­æ³•è§£æä¸Šä¸‹æ–‡å¯¹åº”çš„æ˜¯CreateInputStatementContext</span></span><br><span class="line">    String streamName = createInputStreamParseContext.getStreamName();</span><br><span class="line">    ColumnNameTypeListContext columns = createInputStreamParseContext.getColumns();  <span class="comment">//åˆ—çš„ä¿¡æ¯åœ¨è¯­æ³•å†…å®¹ä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢çš„AnalyzeContextå°±æ˜¯CreateStreamAnalyzeContext</span></span><br><span class="line">    getAnalyzeContext().setStreamName(streamName);</span><br><span class="line">    getAnalyzeContext().setSchema(createSchema(streamName, columns));  <span class="comment">//æ ¹æ®streamNameå’Œcolumnsåˆ›å»ºSchema</span></span><br><span class="line">    </span><br><span class="line">    setSerDeDefine();               <span class="comment">//åºåˆ—åŒ–ååºåˆ—åŒ–å®šä¹‰, åŒ…æ‹¬è®¾ç½®ç±»setSerDeClasså’Œå±æ€§setSerDeProperties</span></span><br><span class="line">    setSourceDefine();              <span class="comment">//æ•°æ®æºå®šä¹‰</span></span><br><span class="line">    setParallelNumber();            <span class="comment">//å¹¶è¡Œåº¦</span></span><br><span class="line">    <span class="keyword">return</span> getAnalyzeContext();     <span class="comment">//è¿”å›è¯­ä¹‰åˆ†æçš„ç»“æœ,æ‰€ä»¥ä¸Šé¢å‡ ä¸ªsetåŠ¨ä½œå…¶å®éƒ½æ˜¯å¾€AnalyzeContextè®¾ç½®å†…å®¹çš„.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»RDBMSçš„è§’åº¦æ¥ç†è§£Schema: å¦‚æœæŠŠstreamNameçœ‹åštable, schemaå°±è¡¨ç¤ºè¡¨å…ƒæ•°æ®: è¡¨æ˜¯ç”±åˆ—ç»„æˆçš„.<br>streamNameå’Œcolumnsä¿¡æ¯æœ€åˆéƒ½æ˜¯å­˜æ”¾åœ¨è¯­æ³•å†…å®¹çš„ä¸Šä¸‹æ–‡ä¸­ParseContext, è€Œè¿™é‡Œçš„è¯­ä¹‰åˆ†æä¸Šä¸‹æ–‡AnalyzeContextéœ€è¦æ ¹æ®è¯­æ³•åˆ›å»ºå¯¹åº”çš„è¡¨ç»“æ„.<br>åˆ›å»ºè¡¨å…ƒæ•°æ®createSchemaå¾ˆç®€å•äº†,å°±æ˜¯newä¸€ä¸ªSchema,å¹¶å°†columnsçš„æ¯ä¸€åˆ—åˆ›å»ºä¸€ä¸ªColumnå¯¹è±¡,åŠ å…¥åˆ°Schemaä¸­.<br>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†Schemaçš„æ¥é¾™å»è„‰äº†. å…¶å®è¯­ä¹‰åˆ†æçš„åŸºç¡€æ˜¯è¯­æ³•å†…å®¹, æ ¹æ®è¯­æ³•äº§ç”Ÿçš„æ•°æ®,æ„å»ºè¯­ä¹‰éœ€è¦çš„æ•°æ®ç»“æ„.  </p>
<p>ä»¥è®¾ç½®åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ä¸ºä¾‹:setSerDeDefine()-&gt;setSerDeClass+setSerDeProperties, åªä¸è¿‡æŠŠè¯­æ³•è§£æçš„å†…å®¹å–å‡ºæ¥è®¾ç½®åˆ°è¯­ä¹‰è§£æç»“æœä¸­.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSerDeClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.é¦–å…ˆä»è¯­æ³•è§£æç»“æœä¸­è·å–å‡ºååºåˆ—åŒ–ç±»</span></span><br><span class="line">    ClassNameContext deserClassName = createInputStreamParseContext.getDeserClassName();</span><br><span class="line">    setSerDeByCQL(deserClassName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSerDeByCQL</span><span class="params">(ClassNameContext deserClassName)</span> </span>&#123;</span><br><span class="line">    String newDeserClassName = deserClassName.getClassName();</span><br><span class="line">    <span class="comment">//2.ç„¶åè®¾ç½®åˆ°è¯­ä¹‰è§£æç»“æœä¸­</span></span><br><span class="line">    getAnalyzeContext().setDeserializerClassName(newDeserClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>èƒ½ä¸èƒ½æŠŠè¯­æ³•å’Œè¯­ä¹‰çš„è¿™ä¸¤ä¸ªä¸Šä¸‹æ–‡ç»“æœæ•°æ®åˆå¹¶åœ¨ä¸€èµ·? ä½œè€…åœ¨æ³¨é‡Šä¸­ä¹Ÿæåˆ°äº†è¿™ä¸ªé—®é¢˜. å¦‚æœä¿®æ”¹äº†è¯­æ³•,å¯¹åº”çš„è¯­ä¹‰ä¹Ÿè¦ä¸€èµ·ä¿®æ”¹(SemanticAnalyzerFactory).   </p>
</blockquote>
<h3 id="insert_&amp;_select_schema">insert &amp; select schema</h3><p>å¯¹äºinsertçš„Schemas, æ¥è‡ªäºselect, è€Œselectåˆä¼šå†æ¬¡è°ƒç”¨fromçš„getCreatedSchemas,ä¸‹é¢æ˜¯ä¸‰ä¸ªAnalyzeContextè·å–åˆ›å»ºçš„Schemas:      </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Schema&gt; <span class="title">getCreatedSchemas</span><span class="params">()</span> </span>&#123;                   <span class="comment">// InsertAnalyzeContext</span></span><br><span class="line">    List&lt;Schema&gt; schemas = Lists.newArrayList();</span><br><span class="line">    schemas.addAll(selectContext.getCreatedSchemas());      <span class="comment">// 1.Insertä½¿ç”¨äº†Select â¬…ï¸</span></span><br><span class="line">    schemas.addAll(<span class="keyword">super</span>.getCreatedSchemas());</span><br><span class="line">    <span class="keyword">return</span> schemas;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Schema&gt; <span class="title">getCreatedSchemas</span><span class="params">()</span> </span>&#123;                   <span class="comment">// SelectAnalyzeContext</span></span><br><span class="line">    List&lt;Schema&gt; schemas = Lists.newArrayList();</span><br><span class="line">    schemas.addAll(fromClauseContext.getCreatedSchemas());  <span class="comment">// 2.Selectä½¿ç”¨äº†Fromçš„ â¬…ï¸</span></span><br><span class="line">    schemas.addAll(<span class="keyword">super</span>.getCreatedSchemas());</span><br><span class="line">    <span class="keyword">return</span> schemas;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Schema&gt; <span class="title">getCreatedSchemas</span><span class="params">()</span> </span>&#123;                   <span class="comment">// FromClauseAnalyzeContext</span></span><br><span class="line">    List&lt;Schema&gt; schemas = <span class="keyword">new</span> ArrayList&lt;Schema&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, InsertAnalyzeContext&gt; et : subQueryForStream.entrySet()) &#123;</span><br><span class="line">        String streamName = et.getKey();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputSchemas.size(); i++) &#123;     <span class="comment">// 4.æœ€ç»ˆéƒ½æ˜¯æ¥æºäºè¿™é‡Œçš„</span></span><br><span class="line">            <span class="keyword">if</span> (streamName.equals(inputSchemas.get(i).getStreamName())) &#123;</span><br><span class="line">                schemas.add(inputSchemas.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        InsertAnalyzeContext sp = et.getValue();</span><br><span class="line">        schemas.addAll(sp.getCreatedSchemas());             <span class="comment">// 3.æˆ‘å‹’ä¸ªå»,åˆå›åˆ°äº†Insert â¬…ï¸</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> schemas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯¹äºå…¶ä»–çš„AnalyzeContext, getCreatedSchemasä¸€èˆ¬æ˜¯æ²¡æœ‰çš„. è¡¨ç»“æ„å®é™…ä¸Šåªæœ‰è¾“å…¥è¾“å‡ºæµå’Œinsert/selectè¯­å¥æ‰æœ‰.  </p>
</blockquote>
<h2 id="æ­£æ–‡äºŒ:_CQL_Statement_syntax">æ­£æ–‡äºŒ: CQL Statement syntax</h2><p>ä¸‹é¢ç»“åˆå®˜æ–¹çš„CQLè¯­æ³•æ–‡æ¡£é…åˆä¸Šå¯¹åº”çš„StatementContext,AnalyzeContextä¸€èµ·åˆ†æå¸¸ç”¨çš„å‡ ç§è¯­æ³•ç»“æ„:  </p>
<h3 id="Create_Input_Stream_Statement_syntax">Create Input Stream Statement syntax</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM streamName </span><br><span class="line">columnList [streamComment]      â‘ æ•°æ®åˆ—</span><br><span class="line">[serdeClause]                   â‘¡ååºåˆ—åŒ–</span><br><span class="line">sourceClause                    â‘¢æ•°æ®è¯»å–/æ•°æ®æº</span><br><span class="line">[parallelClause];</span>               â‘£å¯é€‰çš„ç®—å­å¹¶è¡Œåº¦</span><br></pre></td></tr></table></figure>
<p>Create Input Stream è¯­å¥å®šä¹‰äº†è¾“å…¥æµçš„<code>â‘ æ•°æ®åˆ—åç§°,â‘¢æ•°æ®è¯»å–æ–¹å¼å’Œâ‘¡æ•°æ®ååºåˆ—åŒ–æ–¹å¼</code>ã€‚<br>SERDE å®šä¹‰äº†æ•°æ®çš„ååºåˆ—åŒ–æ–¹å¼,å³å¦‚ä½•å°†ä»inputStreamä¸­è¯»å–çš„æ•°æ®è§£ææˆå¯¹åº”çš„å®Œæ•´çš„æµçš„Schemaã€‚<br>ç³»ç»Ÿé…ç½®äº†é»˜è®¤çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç±»,å½“ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ååºåˆ—åŒ–ç±»æ—¶,SERDEå­å¥å¯ä»¥çœç•¥,åŒæ—¶,SERDE çš„ç›¸å…³é…ç½®å±æ€§ä¹Ÿå¯ä»¥çœç•¥ã€‚<br>SOURCE å®šä¹‰äº†æ•°æ®ä»ä»€ä¹ˆåœ°æ–¹è¯»å–,æ¯”å¦‚ä»MQæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æˆ–è€…æ–‡ä»¶ç­‰å…¶ä»–æ–¹å¼è¯»å–ã€‚SOURCE è¯­å¥ä¸€å®šä¸èƒ½çœç•¥ã€‚<br>ParallelClause è¯­å¥æŒ‡å®šäº†è¯¥è¾“å…¥ç®—å­çš„å¹¶å‘æ•°é‡ã€‚</p>
<p>ä½¿ç”¨ç³»ç»Ÿå†…ç½®ååºåˆ—åŒ–ç±»è¯»å–ç®—å­ç¤ºä¾‹  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM example</span><br><span class="line">(eventId <span class="built_in">INT</span>, eventDesc <span class="keyword">STRING</span>)</span><br><span class="line">SERDE simpleSerDe PROPERTIES (separator = <span class="string">"|"</span>)</span><br><span class="line"><span class="keyword">SOURCE</span> TCPClientInput PROPERTIES (<span class="keyword">server</span> = <span class="string">"127.0.0.1"</span>, port = <span class="string">"9999"</span>)</span><br><span class="line"><span class="keyword">Parallel</span> <span class="number">2</span>;</span></span><br></pre></td></tr></table></figure>
<p>è¾“å…¥æµè¯­å¥çš„Contextå³è¾“å…¥æµçš„è¯­æ³•è§£æå†…å®¹å¯¹åº”äº†è¯­æ³•ç»“æ„çš„ç»„æˆéƒ¨åˆ†.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateInputStatementContext</span> <span class="keyword">extends</span> <span class="title">CreateStreamStatementContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ClassNameContext deserClassName;                <span class="comment">//â‘¡ ååºåˆ—åŒ–ç±»: SERDE  </span></span><br><span class="line">    <span class="keyword">private</span> StreamPropertiesContext deserProperties;        <span class="comment">//   ååºåˆ—åŒ–å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> ClassNameContext sourceClassName;               <span class="comment">//â‘¢ æ•°æ®æºç±»: SOURCE  </span></span><br><span class="line">    <span class="keyword">private</span> StreamPropertiesContext sourceProperties;       <span class="comment">//   æ•°æ®æºå±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> ParallelClauseContext parallelNumber;           <span class="comment">//â‘£ å¹¶è¡Œåº¦: PARALLEL  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>streamNameå’Œcolumnsæ˜¯åœ¨çˆ¶ç±»CreateStreamStatementContextä¸­å®šä¹‰çš„.<br>CreateInputStreamAnalyzerè¯­ä¹‰åˆ†æçš„ç»“æœå·²ç»åœ¨ä¸Šé¢åˆ†æè¿‡äº†. æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹insertå’Œselectè¯­æ³•,<br>åˆ†åˆ«æŒ‰ç…§A.è¯­æ³•ç»“æ„å®šä¹‰(statement syntax), B.è¯­æ³•è§£æç»“æœ(statement context), C.è¯­ä¹‰è§£æ(analyze) D.è¯­ä¹‰è§£æç»“æœ(analyze context).<br>æœ€ç»ˆç»“æœéƒ½æ˜¯ä¸ºäº†å¾—åˆ°è¯­ä¹‰è§£æç»“æœ. ä¸€èˆ¬éƒ½æ˜¯è·å–è¯­æ³•è§£æçš„ç»“æœ(StatementContext)ç»è¿‡è®¡ç®—æœ€åè®¾ç½®åˆ°è¯­ä¹‰è§£æç»“æœä¸­(AnalyzeContext).    </p>
</blockquote>
<h3 id="Insert_Statement_syntax">Insert Statement syntax</h3><p><code>A</code>.InsertåŒ…å«ä¸‰ç§<strong>è¯­æ³•ç»“æ„</strong>:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1.Single Insert</span></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM transformTemp <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> transform;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--2.ä¸åŒ…å«å­æŸ¥è¯¢çš„ MultiInsert</span></span><br><span class="line">FROM teststream</span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s1 <span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s2 <span class="keyword">SELECT</span> a</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s3 <span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">10</span> </span><br><span class="line"><span class="keyword">Parallel</span> <span class="number">4</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--3.åŒ…å«å­æŸ¥è¯¢çš„ MultiInsert</span></span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> <span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">as</span> <span class="keyword">id</span>, <span class="string">'sss'</span> <span class="keyword">as</span> <span class="keyword">name</span></span><br><span class="line"><span class="keyword">FROM</span> testStream(<span class="keyword">id</span> &gt;<span class="number">5</span> )[<span class="keyword">RANGE</span> <span class="number">1</span> SECONDS SLIDE] <span class="keyword">GROUP</span> <span class="keyword">BY</span> ss</span><br><span class="line">)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s1 <span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s2 <span class="keyword">SELECT</span> a</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s3 <span class="keyword">SELECT</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">10</span>;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å°†æ•°æ®å¯¼å…¥ä¸€ä¸ªæœªå®šä¹‰çš„æµä¸­,ä½†æ˜¯å¦‚æœæœ‰è¦å°†å¤šä¸ªæµçš„æ•°æ®å¯¼å…¥ä¸€ä¸ªæ–°æµ,è¿™ä¹ˆå‡ ä¸ªå¯¼å…¥è¯­å¥ç”Ÿæˆçš„schemaåˆ—åç§°å’Œåˆ—ç±»å‹å¿…é¡»ç›¸åŒã€‚<br>å…è®¸å°†selectç»“æœå¯¼å…¥åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„æµä¸­,åªè¦è¿™ä¸ªæµä¸æ˜¯è¾“å…¥å’Œè¾“å‡ºæµ,ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨åˆ›å»ºè¯¥æµã€‚  </p>
<p>MultiInsert è¯­å¥ä¸€èˆ¬ç”¨æ¥è¿›è¡Œå•æµæ•°æ®çš„åˆ†å‰²,å®ƒå¯ä»¥å°†ä¸€ä¸ªæµçš„æ•°æ®,æŒ‰ç…§ä¸åŒçš„å¤„ç†è§„åˆ™,åœ¨å¤„ç†å®Œæ¯•ä¹‹å,å‘é€è‡³æŒ‡å®šæµã€‚ä»è€Œè¾¾åˆ°å•æµå˜å¤šæµçš„ç›®çš„ã€‚<br>MultiInsert è¯­å¥åªæœ‰ä¸€ä¸ªFromå­å¥,è¯¥å­å¥ä¸­,åªå…è®¸è¿›è¡Œç®€å•æµçš„å®šä¹‰,ä¸å…è®¸å‡ºç°çª—å£ç­‰å¤æ‚è¯­æ³•ã€‚</p>
<p><code>B</code>.InsertStatementContextå¯¹åº”ç¬¬ä¸€ç§çš„<strong>è¯­æ³•è§£æç»“æœ</strong>(æ²¡æœ‰å¹¶è¡Œåº¦), MultiInsertStatementContextå¯¹åº”2.3ä¸¤ç§çš„å¤šçº§æ’å…¥è¯­æ³•è§£æç»“æœ(æœ‰å¹¶è¡Œåº¦).  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertStatementContext</span> <span class="keyword">extends</span> <span class="title">ParseContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String streamName;                  <span class="comment">//insert into stream s1çš„streamNameæ˜¯s1</span></span><br><span class="line">    <span class="keyword">private</span> SelectStatementContext select;      <span class="comment">//select * from ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiInsertStatementContext</span> <span class="keyword">extends</span> <span class="title">ParseContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> FromClauseContext from;             <span class="comment">//FROM ...</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MultiInsertContext&gt; inserts;   <span class="comment">//insert into ... insert into ...</span></span><br><span class="line">    <span class="keyword">private</span> ParallelClauseContext parallel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>C</code>.insertè¯­å¥çš„<strong>è¯­ä¹‰è§£æ</strong>(multi insertçš„ç±»ä¼¼:è§£æfromä»¥åŠå¤šæ¡insertè¯­å¥):  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertStatementAnalyzer</span> <span class="keyword">extends</span> <span class="title">BaseAnalyzer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InsertAnalyzeContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> InsertStatementContext insertContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AnalyzeContext <span class="title">analyze</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String streamName = insertContext.getStreamName();  <span class="comment">//insertContext: InsertStatementContext</span></span><br><span class="line">        context.setOutputStreamName(streamName);</span><br><span class="line">        <span class="keyword">if</span> (checkSchemaExists(streamName)) &#123;</span><br><span class="line">            context.setOutputSchema(getSchemaByName(streamName));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            context.setPipeStreamNotCreated(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        analyzeSelectStatement();   <span class="comment">//åˆ†æSelectè¯­å¥</span></span><br><span class="line">        createOutputStream();       <span class="comment">//åˆ›å»ºè¾“å‡ºæµ</span></span><br><span class="line">        <span class="keyword">return</span> context;             <span class="comment">//è¿”å›çš„æ˜¯è¯­ä¹‰åˆ†æçš„ç»“æœAnalyzeContext: InsertAnalyzeContext</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>D</code>.è¯­ä¹‰è§£æç»“æœAnalyzeContext: å¯¹äºç¬¬ä¸€ç§çš„insertè¯­å¥(å•æ¡insert),åŒ…å«äº†selectå­å¥.<br>InsertStatementContext è¯­æ³•è§£æç»“æœä¸­å«æœ‰ SelectStatementContext select.<br>InsertAnalyzeContext è¯­ä¹‰è§£æç»“æœä¸­ä¹Ÿå«æœ‰ SelectAnalyzeContext selectContext.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyzeSelectStatement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//insertContext.getSelect()è¿”å›çš„æ˜¯InsertStatementContextä¸­çš„SelectStatementContext, å¯¹åº”åˆ†æå™¨å°±æ˜¯SelectStatementAnalyzer</span></span><br><span class="line">    SemanticAnalyzer selectAnalzyer = SemanticAnalyzerFactory.createAnalyzer(insertContext.getSelect(), getAllSchemas());</span><br><span class="line">    <span class="keyword">if</span> (selectAnalzyer <span class="keyword">instanceof</span> SelectStatementAnalyzer) &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæŸ¥è¯¢è¯­å¥çš„è¯­ä¹‰åˆ†æå™¨, è®¾ç½®æŸ¥è¯¢çš„è¾“å‡ºæµåç§°ä¸ºå½“å‰insertè¯­å¥çš„è¾“å‡ºæµåç§°. </span></span><br><span class="line">        <span class="comment">//æ¯”å¦‚insert into stream s1 select ... è¡¨ç¤ºæŸ¥è¯¢è¯­å¥çš„è¾“å‡ºæ˜¯s1.  </span></span><br><span class="line">        ((SelectStatementAnalyzer)selectAnalzyer).setOutputStreamName(context.getOutputStreamName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//InsertAnalyzeContext contextæ˜¯insertè¯­å¥çš„è¯­ä¹‰è§£æç»“æœ. </span></span><br><span class="line">    <span class="comment">//è¿˜æ˜¯è¦å¯¹æŸ¥è¯¢åˆ†æå™¨SelectStatementAnalyzerç»è¿‡åˆ†æanalyzeå¾—åˆ°æŸ¥è¯¢è¯­ä¹‰è§£æç»“æœSelectAnalyzeContext</span></span><br><span class="line">    context.setSelectContext((SelectAnalyzeContext)selectAnalzyer.analyze());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>insertä¸­åŒ…å«äº†selectè¯­å¥, æ‰€ä»¥åœ¨è¯­ä¹‰è§£æinsertè¯­å¥æ—¶, è¦é¦–å…ˆå¯¹å…¶åŒ…å«çš„selectè¿›è¡Œè¯­ä¹‰è§£æ.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    SelectStatementContext <span class="operator"><span class="keyword">select</span> <span class="comment">-----------------------------</span></span><br><span class="line">          |                                                   â¬‡ï¸</span><br><span class="line">    InsertStatementContext insertContext                      â¬‡ï¸  insertContext.getSelect() = SelectStatementContext</span><br><span class="line">          |                                                   â¬‡ï¸  æ ¹æ®ParaseContextåˆ›å»ºå¯¹åº”çš„SemanticAnalyzer  </span><br><span class="line">InsertStatementAnalyzer.<span class="keyword">analyze</span>()                             â¬‡ï¸  å†è°ƒç”¨è¯­ä¹‰è§£æå™¨çš„<span class="keyword">analyze</span>æ–¹æ³•è¿›è¡Œè¯­ä¹‰è§£æ,è¿”å›å€¼ä¸ºè¯­ä¹‰è§£æç»“æœAnalyzeContext</span><br><span class="line">                       |<span class="comment">--analyzeSelectStatement() -- SelectStatementAnalyzer.analyze()</span></span><br><span class="line">                       |<span class="comment">--createOutputStream()                                |</span></span><br><span class="line">                       |<span class="comment">--InsertAnalyzeContext  &lt;-----------------------------|--SelectAnalyzeContext</span></span><br><span class="line">                               <span class="keyword">context</span>              <span class="keyword">context</span>.setSelectContext</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºè¾“å‡ºæµ, selectçš„schemaä¹Ÿå°±æ˜¯insertçš„schema.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createOutputStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//selectçš„Schemaä¸­åº”è¯¥å·²ç»åŒ…å«äº†å®Œæ•´çš„å…ƒæ•°æ®,æ¯”å¦‚columns, è¿™é‡Œåˆ›å»ºçš„è¾“å‡ºæµåªæ˜¯æ›´æ”¹äº†è¾“å‡ºæµçš„åç§°.  </span></span><br><span class="line">    Schema outputSchema = context.getSelectContext().getSelectClauseContext().getOutputSchema();</span><br><span class="line">    outputSchema.setId(context.getOutputStreamName());          </span><br><span class="line">    outputSchema.setName(context.getOutputStreamName());        </span><br><span class="line">    outputSchema.setStreamName(context.getOutputStreamName());</span><br><span class="line">    context.setOutputSchema(outputSchema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Select_Statement_syntax">Select Statement syntax</h3><p><code>A</code>.æŸ¥è¯¢è¯­å¥çš„è¯­æ³•ç»“æ„:  </p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SelectClause </span><br><span class="line">FromClause </span><br><span class="line"><span class="string">[WhereClause]</span> </span><br><span class="line"><span class="string">[GroupByClause]</span> </span><br><span class="line"><span class="string">[HavingClause]</span> </span><br><span class="line"><span class="string">[OrderbyClause]</span> </span><br><span class="line"><span class="string">[LimitClause]</span> </span><br><span class="line"><span class="string">[ParallelClause]</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Selectè¯­å¥(Statement)ä¸­çš„æ¯ä¸ªå­å¥(Clause)éƒ½æœ‰è‡ªå·±çš„è¯­æ³•ç»“æ„,å› æ­¤éƒ½æœ‰è‡ªå·±çš„è¯­æ³•è§£æå’Œè¯­ä¹‰è§£æ.  </p>
</blockquote>
<p><code>B</code>.Selectè¯­å¥åŒ…å«äº†å¤šä¸ªå­å¥, æ¯”å¦‚select <em> from table. åˆ™`select </em><code>å¯¹åº”selectå­å¥,</code>from table`å¯¹åº”fromå­å¥.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatementContext</span> <span class="keyword">extends</span> <span class="title">ParseContext</span> </span>&#123;  <span class="comment">//â‘¡</span></span><br><span class="line">    <span class="keyword">private</span> SelectClauseContext select;</span><br><span class="line">    <span class="keyword">private</span> FromClauseContext from;                         <span class="comment">//â‘¢</span></span><br><span class="line">    <span class="keyword">private</span> WhereClauseContext where;</span><br><span class="line">    <span class="keyword">private</span> GroupbyClauseContext groupby;</span><br><span class="line">    <span class="keyword">private</span> HavingClauseContext having;</span><br><span class="line">    <span class="keyword">private</span> OrderbyClauseContext orderby;</span><br><span class="line">    <span class="keyword">private</span> LimitClauseContext limit;</span><br><span class="line">    <span class="keyword">private</span> ParallelClauseContext parallel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>C</code>.æŸ¥è¯¢è¯­å¥çš„è¯­ä¹‰åˆ†æ(fromå­å¥çš„è§£æè¦ä¼˜å…ˆäºselectå­å¥).  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatementAnalyzer</span> <span class="keyword">extends</span> <span class="title">BaseAnalyzer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SelectAnalyzeContext context;                   <span class="comment">//â‘  StatementAnalyzerçš„analyzeç»“æœä¸ºAnalyzerContext</span></span><br><span class="line">    <span class="keyword">private</span> SelectStatementContext selectContext;           <span class="comment">//â‘¡ è¯­ä¹‰è§£æStatementAnalyzerä¾èµ–äºè¯­æ³•è§£æStatementContext</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SelectAnalyzeContext <span class="title">analyze</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fromAnalyzer();                                     <span class="comment">//â‘¢</span></span><br><span class="line">        selectAnalyzer();</span><br><span class="line">        resetOutputColumnTypes();</span><br><span class="line">        whereAnalyzer();</span><br><span class="line">        groupbyAnalyzer();</span><br><span class="line">        havingAnalyzer();</span><br><span class="line">        orderByAnalyzer();</span><br><span class="line">        limitAnalyzer();</span><br><span class="line">        parallelAnalyzer();</span><br><span class="line">        dataSourceQueryArgumentsAnalyzer();</span><br><span class="line">        <span class="keyword">return</span> context;                                     <span class="comment">//â‘ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>D</code>.æŸ¥è¯¢çš„è¯­ä¹‰è§£æç»“æœSelectAnalyzeContext(å’ŒSelectWithOutFromAnalyzeContext)    </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä¸€æ¬¡æŸ¥è¯¢: å¸¦æœ‰fromçš„æ¯”å¦‚select <span class="keyword">*</span> from table</span><br><span class="line">SelectAnalyzeContext ---------------|<span class="string"></span><br><span class="line">      </span>|<span class="string">                             </span>|<span class="string">--FromClauseAnalyzeContext fromClauseContext</span><br><span class="line">      </span>|<span class="string">                             </span>|<span class="string">--ParallelClauseAnalyzeContext parallelClauseContext</span><br><span class="line">      </span>|<span class="string">                             </span>|<span class="string">++SelectStatementContext context   //â‘¡</span><br><span class="line">      </span>|</span><br><span class="line">å¤šæ¬¡æŸ¥è¯¢: ä¸å¸¦fromçš„,æ¯”å¦‚å‰é¢multi insert,å¯¹åŒä¸€ä¸ªæµæŸ¥è¯¢å¤šæ¬¡</span><br><span class="line">SelectWithOutFromAnalyzeContext ----|<span class="string"></span><br><span class="line">                                    </span>|<span class="string">--SelectClauseAnalyzeContext selectClauseContext</span><br><span class="line">                                    </span>|<span class="string">--FilterClauseAnalzyeContext whereClauseContext</span><br><span class="line">                                    </span>|<span class="string">--SelectClauseAnalyzeContext groupbyClauseContext</span><br><span class="line">                                    </span>|<span class="string">--OrderByClauseAnalyzeContext orderbyClauseContext</span><br><span class="line">                                    </span>|<span class="string">--FilterClauseAnalzyeContext havingClauseContext</span><br><span class="line">                                    </span>|<span class="string">--LimitClauseAnalzyeContext limitClauseContext</span><br><span class="line">                                    </span>|<span class="string">++MultiSelectContext context</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„contextæ˜¯SelectAnalyzeContext, ä¸åŒè§£æå™¨è§£æçš„ç»“æœä¹Ÿæ˜¯AnalyzeContext,åˆ†åˆ«è®¾ç½®åˆ°SelectAnalyzeContextå¯¹åº”çš„å­—æ®µä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fromAnalyzer</span><span class="params">()</span> </span>&#123;                                         <span class="comment">//    â‘¡         â‘¢</span></span><br><span class="line">    SemanticAnalyzer analyzer = SemanticAnalyzerFactory.createAnalyzer(selectContext.getFrom(), getAllSchemas());</span><br><span class="line">    context.setFromClauseContext((FromClauseAnalyzeContext)analyzer.analyze());</span><br><span class="line">&#125;   <span class="comment">//â‘             â‘¢</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">groupbyAnalyzer</span><span class="params">()</span> </span>&#123;   </span><br><span class="line">    SemanticAnalyzer analyzer = SemanticAnalyzerFactory.createAnalyzer(selectContext.getGroupby(), getInputSchemas());</span><br><span class="line">    context.setGroupbyClauseContext((SelectClauseAnalyzeContext)analyzer.analyze());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>è¯­æ³•è§£æParser</code> - <code>è¯­æ³•è§£æç»“æœParseContext</code> â€“ <code>è¯­ä¹‰è§£æSemanticAnalyzer</code> â€“ <code>è¯­ä¹‰è§£æç»“æœAnalyzeContext</code></p>
<p><img src="http://img.blog.csdn.net/20151127193205608" alt="stream-select"></p>
<h3 id="DataSource_Statement_syntax">DataSource Statement syntax</h3><p>æ•°æ®æºå’Œ From å­å¥ä¸€èµ·ç»“åˆä½¿ç”¨,dataSourceBody è¯­æ³•åœ¨ from å­—å¥ä¸­ä¹Ÿè¿›è¡Œäº†å®šä¹‰  </p>
<p>æ•°æ®æºçš„æŸ¥è¯¢å‚æ•°åˆ†ä¸ºæŸ¥è¯¢Schemaå®šä¹‰(SCHEMA)å’Œæ•°æ®æºæŸ¥è¯¢(QUERY)ä¸¤ä¸ªéƒ¨åˆ†ã€‚<br>Schema çš„å®šä¹‰åŒ Create Input Stream ä¸­çš„ schema å®šä¹‰,ä¸»è¦ç”¨æ¥æŒ‡å®šæ•°æ®æºæŸ¥è¯¢ç»“æœ çš„åˆ—æ•°é‡ã€åç§°ã€ç±»å‹,ä¾¿äºè¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚</p>
<p>RDB æ•°æ®è¯»å–,æ”¯æŒå¤šè¡Œæ•°æ®è¯»å–,åŒæ—¶æ”¯æŒ CQL UDF ä»¥åŠçª—å£å’Œèšåˆè¿ç®—<br>QUERY å†…éƒ¨çš„å‚æ•°é¡ºåºå›ºå®š,ä¸åŒçš„æ•°æ®æº,æœ‰ä¸åŒçš„å‚æ•°ã€‚<br>RDB çš„ SQL ä¸­,å¦‚æœä¸åŒ…å« Where,å°±ä¼šä¸€æ¬¡æŸ¥è¯¢å‡ºå¤šè¡Œè®°å½•ã€‚å’ŒåŸå§‹æµåšäº† Join ä¹‹å,æœ€ç»ˆè¾“å‡ºå¤šæ¡ç»“æœã€‚  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æ•°æ®æºå®šä¹‰</span></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> DATASOURCE rdbdatasource         #dataSourceName</span><br><span class="line"><span class="keyword">SOURCE</span> RDBDataSource                    #className</span><br><span class="line">PROPERTIES (                            #datasourceProperties     </span><br><span class="line"><span class="keyword">url</span> = <span class="string">"jdbc:postgresql://127.0.0.1:1521/streaming"</span>, </span><br><span class="line">username = <span class="string">"55B5B07CF57318642D38F0CEE0666D26"</span>, </span><br><span class="line"><span class="keyword">password</span> = <span class="string">"55B5B07CF57318642D38F0CEE0666D26"</span> );</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--æ•°æ®æºæŸ¥è¯¢</span></span><br><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> rs <span class="keyword">select</span> rdb.<span class="keyword">id</span>,s.<span class="keyword">id</span>,<span class="keyword">count</span>(rdb.<span class="keyword">id</span>),<span class="keyword">sum</span>(s.<span class="keyword">id</span>) </span><br><span class="line"><span class="keyword">from</span> S[<span class="keyword">rows</span> <span class="number">10</span> slide],                  #æ™®é€šçš„æµå¯ä»¥å’ŒDataSourceè¿›è¡Œ<span class="keyword">join</span> </span><br><span class="line">DATASOURCE rdbdatasource                #dataSourceName, å‰é¢å®šä¹‰å¥½çš„æ•°æ®æº</span><br><span class="line">[                                       #dataSourceBody</span><br><span class="line"><span class="keyword">SCHEMA</span> (<span class="keyword">id</span> <span class="built_in">int</span>,<span class="keyword">name</span> <span class="keyword">String</span>,<span class="keyword">type</span> <span class="built_in">int</span>),                                       #dataSourceSchema</span><br><span class="line"><span class="keyword">QUERY</span> (<span class="string">"select rid as id,rname,rtype from rdbtable where id = ? "</span>, s.<span class="keyword">id</span>)    #dataSourceQuery</span><br><span class="line">] rdb                                   #sourceAlias</span><br><span class="line"><span class="keyword">where</span> rdb.<span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%hdd%'</span>             #dataSourceArguments</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> rdb.<span class="keyword">id</span>,s.<span class="keyword">id</span>;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>åŸå§‹æµsçš„idä¼šä½œä¸ºæŸ¥è¯¢æ¡ä»¶,ä¼ å…¥æ•°æ®æºçš„SQLæŸ¥è¯¢è¯­å¥ä¸­, åŒæ—¶æ•°æ®æºæœ¬èº«ä¹Ÿæœ‰è‡ªå·±çš„æŸ¥è¯¢æ¡ä»¶.  </p>
</blockquote>
<p>CreateDataSourceç›¸å…³çš„è¯­æ³•è§£æ,è¯­ä¹‰è§£æå’ŒCreateStreamStatementç±»ä¼¼,å°±ä¸åˆ†æäº†. </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storm/">storm</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-11-24-StreamCQL-task" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-11-24-StreamCQL-task/" class="article-date">
  	<time datetime="2015-12-01T10:02:54.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-11-24-StreamCQL-task/">StreamCQLæºç é˜…è¯»(1) æäº¤ä»»åŠ¡</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>å¤§æ•°æ®ä¸Šçš„æµå¼SQLå¼•æ“â€”StreamCQL: <a href="http://www.csdn.net/article/2015-11-13/2826204" target="_blank" rel="external">http://www.csdn.net/article/2015-11-13/2826204</a></p>
<h1 id="Introduce">Introduce</h1><p>CQLï¼ˆContinuous Query Languageï¼‰ï¼ŒæŒç»­æŸ¥è¯¢è¯­è¨€ï¼Œç”¨äºæ•°æ®æµä¸Šçš„æŸ¥è¯¢è¯­è¨€ã€‚ç›¸å¯¹äºä¼ ç»Ÿçš„SQLï¼ŒCQLåŠ å…¥äº†çª—å£çš„æ¦‚å¿µï¼Œä½¿å¾—æ•°æ®å¯ä»¥ä¸€ç›´ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç”±æ­¤å¯ä»¥å¿«é€Ÿè¿›è¡Œå¤§é‡å†…å­˜è®¡ç®—ï¼ŒCQLçš„è¾“å‡ºç»“æœä¸ºæ•°æ®æµåœ¨æŸä¸€æ—¶åˆ»çš„è®¡ç®—ç»“æœã€‚  </p>
<p>CQLæ˜¯å»ºç«‹åœ¨StormåŸºç¡€ä¸Šçš„ç±»SQLæŸ¥è¯¢è¯­è¨€ï¼Œå®ƒè§£å†³äº†StormåŸç”ŸAPIä½¿ç”¨å¤æ‚ï¼Œä¸Šæ‰‹éš¾åº¦é«˜ï¼Œå¾ˆå¤šåŸºæœ¬åŠŸèƒ½ç¼ºå¤±çš„é—®é¢˜ï¼Œæå‡äº†æµå¤„ç†äº§å“çš„æ˜“ç”¨æ€§ã€‚  </p>
<p>åœ¨CQLè®¾è®¡è¯­æ³•ä¹‹åˆï¼Œé€šè¿‡å‚è€ƒå¸‚é¢ä¸Šç°æœ‰çš„CEPäº§å“çš„è¯­æ³•ï¼Œå‘ç°è¿™äº›äº§å“éƒ½ä¸ç®—æ˜¯å…¨éƒ¨çš„SQLè¯­å¥ï¼Œå³ä»…ä»…ä½¿ç”¨SQLè¯­å¥è¿˜ä¸èƒ½è¿è¡Œï¼Œè¿˜å¿…é¡»ä¾é ä¸€äº›å®¢æˆ·ç«¯çš„ä»£ç ã€‚ è¿™æ ·å°±ç»™ä½¿ç”¨å¸¦æ¥äº†ä¸€äº›ä¸ä¾¿ï¼Œ ç”¨æˆ·å¿…é¡»å­¦ä¹ å®¢æˆ·ç«¯APIï¼Œæ¯”è¾ƒç¹çï¼Œä¸Šæ‰‹éš¾åº¦ä¹Ÿæ¯”è¾ƒå¤§ã€‚  </p>
<p>æ‰€ä»¥ï¼ŒCQLè®¾è®¡ç›®æ ‡å°±æ˜¯ï¼Œç”¨çº¯ç²¹çš„SQLè¯­å¥å†åŠ ä¸Šä¸€äº›å‘½ä»¤ï¼Œå°±å¯ä»¥å®Œæˆæ‰€æœ‰çš„ä»»åŠ¡å‘å¸ƒä»¥åŠæ‰§è¡Œï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡SQLæ¥å£ï¼Œç›´æ¥è¿›è¡Œä»»åŠ¡çš„ä¸‹å‘ï¼Œç»Ÿä¸€äº†å®¢æˆ·ç«¯æ¥å£ã€‚å¯¹äºæœ‰ä¸€å®šSQLåŸºç¡€çš„ç”¨æˆ·ï¼Œåªéœ€è¦æŒæ¡ä¸€äº›CQLæ¯”è¾ƒç‰¹æ®Šçš„è¯­æ³•ï¼Œæ¯”å¦‚çª—å£æˆ–è€…æµå®šä¹‰çš„è¯­æ³•ï¼Œå°±å¯ä»¥å†™å‡ºå¯è¿è¡Œçš„CQLç¨‹åºï¼Œå¤§å¤§é™ä½äº†ä¸Šæ‰‹éš¾åº¦ã€‚  </p>
<p><strong>å…³é”®æ¦‚å¿µ</strong></p>
<p><strong>Stream(æµ)</strong>ï¼šæµæ˜¯ä¸€ç»„ï¼ˆæ— ç©·ï¼‰å…ƒç´ çš„é›†åˆï¼Œæµä¸Šçš„æ¯ä¸ªå…ƒç´ éƒ½å±äºåŒä¸€ä¸ªschemaï¼›æ¯ä¸ªå…ƒç´ éƒ½å’Œé€»è¾‘æ—¶é—´æœ‰å…³ï¼›å³æµåŒ…å«äº†å…ƒç»„å’Œæ—¶é—´çš„åŒé‡å±æ€§ã€‚ç•™ä¸Šçš„ä»»ä½•ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½å¯ä»¥ç”¨Element<tuple,time>çš„æ–¹å¼æ¥è¡¨ç¤ºï¼Œtupleæ˜¯å…ƒç»„ï¼ŒåŒ…å«äº†æ•°æ®ç»“æ„å’Œæ•°æ®å†…å®¹ï¼ŒTimeå°±æ˜¯è¯¥æ•°æ®çš„é€»è¾‘æ—¶é—´ã€‚</tuple,time></p>
<p><strong>Window(çª—å£)</strong>ï¼šçª—å£æ˜¯æµå¤„ç†ä¸­è§£å†³äº‹ä»¶çš„æ— è¾¹ç•Œï¼ˆunboundedï¼‰åŠæµåŠ¨æ€§çš„ä¸€ç§é‡è¦æ‰‹æ®µï¼ŒæŠŠäº‹ä»¶æµåœ¨æŸä¸€æ—¶åˆ»å˜æˆé™æ€çš„è§†å›¾ï¼Œä»¥ä¾¿è¿›è¡Œç±»ä¼¼æ•°æ®åº“è¡¨çš„å„ç§æŸ¥è¯¢æ“ä½œã€‚åœ¨streamä¸Šå¯ä»¥å®šä¹‰windowï¼Œçª—å£æœ‰ä¸¤ç§ç±»å‹ï¼Œæ—¶é—´çª—å£ï¼ˆtime-basedï¼‰å’Œè®°å½•çª—å£ï¼ˆrow-basedï¼‰ã€‚ä¸¤ç§çª—å£éƒ½æ”¯æŒä¸¤ç§æ¨¡å¼ï¼Œæ»‘åŠ¨ï¼ˆslideï¼‰å’Œè·³åŠ¨ï¼ˆtumbleï¼‰ã€‚</p>
<p><strong>Expression(è¡¨è¾¾å¼)</strong>ï¼šç¬¦å·å’Œè¿ç®—ç¬¦çš„ä¸€ç§ç»„åˆï¼ŒCQLè§£æå¼•æ“å¤„ç†è¯¥ç»„åˆä»¥è·å–å•ä¸ªå€¼ã€‚ç®€å•è¡¨è¾¾å¼å¯ä»¥æ˜¯å¸¸é‡ã€å˜é‡æˆ–è€…å‡½æ•°ï¼Œå¯ä»¥ç”¨è¿ç®—ç¬¦å°†ä¸¤ä¸ªæˆ–è€…å¤šä¸ªç®€å•è¡¨è¾¾å¼è”åˆèµ·æ¥æ„æˆæ›´å¤æ‚çš„è¡¨è¾¾å¼ã€‚</p>
<h1 id="QuickStart">QuickStart</h1><p>1.startup zk and storm local  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh <span class="operator"><span class="keyword">start</span></span><br><span class="line"></span><br><span class="line">nohup <span class="keyword">bin</span>/storm nimbus &amp;</span><br><span class="line">nohup <span class="keyword">bin</span>/storm ui &amp;</span><br><span class="line">nohup <span class="keyword">bin</span>/storm supervisor &amp;</span></span><br></pre></td></tr></table></figure>
<p>2.build and run cql client</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">cd</span> <span class="keyword">StreamCQL</span><br><span class="line"></span><span class="keyword">mvn </span>clean install</span><br><span class="line"><span class="label">cd</span> cql-<span class="keyword">binary/target</span><br><span class="line"></span><span class="label">tar</span> xvf <span class="keyword">stream-cql-bianry-1.0.tar.gz</span><br><span class="line"></span><span class="label">cd</span> <span class="keyword">stream-cql-bianry-1.0</span><br><span class="line"></span><span class="keyword">bin/cql</span></span><br></pre></td></tr></table></figure>
<p>3.create first topology:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s(<span class="keyword">id</span> <span class="built_in">INT</span>, <span class="keyword">name</span> <span class="keyword">STRING</span>, <span class="keyword">type</span> <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">SOURCE</span> randomgen PROPERTIES ( timeUnit = <span class="string">"SECONDS"</span>, <span class="keyword">period</span> = <span class="string">"1"</span>, eventNumPerperiod = <span class="string">"1"</span>, isSchedule = <span class="string">"true"</span> );</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM rs(<span class="keyword">type</span> <span class="built_in">INT</span>, cc <span class="built_in">INT</span>)</span><br><span class="line">SINK consoleOutput;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs <span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">as</span> cc</span><br><span class="line"><span class="keyword">FROM</span> s[<span class="keyword">RANGE</span> <span class="number">20</span> SECONDS BATCH]</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span>;</span></span><br><span class="line"></span><br><span class="line">SUBMIT APPLICATION example;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å…¥æµ: éšæœºæ•°,æ¯ç§’ç”Ÿæˆä¸€ä¸ªäº‹ä»¶<br>è¾“å‡ºæµ: æ§åˆ¶å°, æ¯éš”20ç§’è¾“å‡ºä¸€æ¬¡, åªç»Ÿè®¡id&gt;5,æ ¹æ®typeåˆ†ç»„,æ±‚å’Œ<br>æäº¤åº”ç”¨ç¨‹åº, ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªStormçš„Topology.  </p>
</blockquote>
<p>4.A complicate topology:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s1(<span class="keyword">name</span> <span class="keyword">STRING</span>)</span><br><span class="line"><span class="keyword">SOURCE</span> RANDOMGEN PROPERTIES ( timeUnit = <span class="string">"SECONDS"</span>, <span class="keyword">period</span> = <span class="string">"1"</span>, eventNumPerperiod = <span class="string">"1"</span>, isSchedule = <span class="string">"true"</span> );</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM s2(c1 <span class="keyword">STRING</span>)</span><br><span class="line">SINK kafakOutput PROPERTIES ( topic = <span class="string">"cqlOut"</span>, zookeepers = <span class="string">"127.0.0.1:2181"</span>, brokers = <span class="string">"127.0.0.1:9092"</span> );</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s3( c1 <span class="keyword">STRING</span>)</span><br><span class="line"><span class="keyword">SOURCE</span> KafkaInput PROPERTIES (groupid = <span class="string">"cqlClient"</span>, topic = <span class="string">"cqlInput"</span>, zookeepers = <span class="string">"127.0.0.1:2181"</span>, brokers = <span class="string">"127.0.0.1:9092"</span> )</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM s4(c1 <span class="keyword">STRING</span>)</span><br><span class="line">SINK consoleOutput;</span></span><br><span class="line"></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s2 <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> s1;</span></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s4 <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> s3;</span></span><br><span class="line"></span><br><span class="line">SUBMIT APPLICATION cql_kafka_example;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å…¥æµs1 å‘å°„æ•°æ® åˆ°kafkaè¾“å‡ºæµs2<br>kafkaè¾“å…¥æµ å‘å°„æ•°æ® åˆ°æ§åˆ¶å°è¾“å‡ºæµs4</p>
</blockquote>
<p>5.æŸ¥çœ‹æ‹“æ‰‘: <a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a> </p>
<h1 id="Architecture">Architecture</h1><p>StreamCQLçš„ä»£ç ç”±ä¸‰éƒ¨åˆ†ç»„æˆ: cql,streaming,adapteråˆ†åˆ«å¯¹åº”ä¸‹é¢çš„ä¸‰ä¸ªç»„ä»¶.  </p>
<p><img src="http://img.blog.csdn.net/20151125162710289" alt="stream-arch"></p>
<blockquote>
<p>å®¢æˆ·ç«¯æäº¤çš„<code>CQLè¯­å¥</code>ä¼šç”±æ‰§è¡Œè®¡åˆ’ç”Ÿæˆå™¨<code>ExecutorPlanGenerator</code>ç”Ÿæˆ<code>å¯è¿è¡Œçš„ä»»åŠ¡</code>,æœ€ç»ˆç”±<code>Stormé€‚é…å™¨</code>ç»„è£…Topologyæäº¤æ‰§è¡Œ.</p>
</blockquote>
<p>StreamCQLå¯¹åº”çš„Stormæ‹“æ‰‘:  </p>
<p><img src="http://img.blog.csdn.net/20151125162722310" alt="stream-storm"></p>
<blockquote>
<p>è‡³å°‘æœ‰ä¸€ä¸ªè¾“å…¥å’Œè¾“å‡º. Componentä¹‹é—´å¯ä»¥ç»„åˆæ¯”å¦‚Select,Joinç­‰.  </p>
</blockquote>
<p>Window example:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--æŒ‰ç…§typeå¯¹çª—å£å†…æ•°æ®è¿›è¡Œåˆ†ç»„,æ¯ç»„å®¹é‡ä¸º10</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> transformEvent[<span class="keyword">ROWS</span> <span class="number">10</span> SLIDE <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">TYPE</span>];</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">--æ—¶é—´æ’åºçª—,ä¸€èˆ¬ç”¨æ¥è§£å†³æ•°æ®ä¹±åºé—®é¢˜</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> transformEvent[<span class="keyword">RANGE</span> <span class="number">1000</span> MILLISECONDS <span class="keyword">SORT</span> <span class="keyword">BY</span> dte];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--äº‹ä»¶é©±åŠ¨æ—¶é—´æ»‘åŠ¨çª—</span></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs <span class="keyword">sum</span>(OrderPrice),<span class="keyword">avg</span>(OrderPrice),<span class="keyword">count</span>(OrderPrice)</span><br><span class="line"><span class="keyword">FROM</span> transformEvent[<span class="keyword">RANGE</span> <span class="number">10</span> SECONDS SLIDE <span class="keyword">TRIGGER</span> <span class="keyword">by</span> TS <span class="keyword">EXCLUDE</span> <span class="keyword">now</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--ä¿å­˜å‘¨æœŸä¸ºä¸€ä¸ªè‡ªç„¶å¤©çš„åˆ†ç»„çª—</span></span><br><span class="line"><span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,<span class="keyword">count</span>(<span class="keyword">id</span>)</span><br><span class="line"><span class="keyword">FROM</span> transformEvent[<span class="keyword">RANGE</span> TODAY ts <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">TYPE</span>] </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">TYPE</span> <span class="keyword">HAVING</span> <span class="keyword">id</span> &gt; <span class="number">10</span>;</span></span><br></pre></td></tr></table></figure>
<p>Split example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM teststream</span><br><span class="line">  <span class="operator"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s1 <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s2 <span class="keyword">SELECT</span> a</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM s3 <span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">10</span></span><br><span class="line">PRARLLEL <span class="number">4</span>;</span></span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20151126091936179" alt="stream-split"></p>
<blockquote>
<p>åŸå§‹çš„spoutè¾“å…¥æµä¼šåˆ†æˆä¸‰ä¸ªè¾“å‡ºæµ. æ‰€ä»¥ä¸­é—´ç”¨ä¸€ä¸ªSplitBoltæ¥ä½œä¸ºä¸­é—´ä»‹è´¨.  </p>
</blockquote>
<h1 id="From_log_to_see_StreamCQL">From log to see StreamCQL</h1><blockquote>
<p>ç†Ÿæ‚‰ä¸€ä¸ªå¼€æºæ¡†æ¶çš„æµç¨‹, å¯ä»¥å…ˆè·‘ä¸€ä¸ªæµ‹è¯•ä¾‹å­, æŸ¥çœ‹æ‰“å°çš„æ—¥å¿—ä¿¡æ¯, é€šè¿‡æ—¥å¿—çš„é¡ºåº, å¯ä»¥å¤§è‡´ç†Ÿæ‚‰æ•´ä½“çš„æµç¨‹.<br>å½“ç„¶è¦æ±‚æ¡†æ¶æœ¬èº«çš„æ—¥å¿—ä¿¡æ¯è¶³å¤Ÿæ˜äº†, StreamCQLåšçš„ä¸é”™. è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ä¸è‡³äºä¸çŸ¥é“è¦ä»å“ªé‡Œçœ‹èµ·æ¥. </p>
</blockquote>
<h2 id="CQLClient_to_Driver">CQLClient to Driver</h2><p><code>bin/cql</code>ä¼šå¼€å¯ä¸€ä¸ªCQLClientå®¢æˆ·ç«¯, å½“è¾“å…¥<code>;</code>è¡¨ç¤ºä¸€ä¸ªè¯­å¥çš„ç»ˆç»“æ—¶,å°±ä¼šè§¦å‘ä¸€æ¬¡CQLè¯­å¥çš„ç¼–è¯‘æ‰§è¡Œç­‰.</p>
<p>Driver.runæ˜¯CQLçš„è¿è¡Œèµ·ç‚¹</p>
<ul>
<li>1ã€ç¼–è¯‘</li>
<li>2ã€è¯­ä¹‰åˆ†æ</li>
<li>3ã€å‘½ä»¤æ‰§è¡Œ</li>
<li>4ã€è¿”å›ç»“æœ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String cql)</span> </span>&#123;</span><br><span class="line">    ParseContext parseContext = parser.parse(cql);  <span class="comment">//CQLè§£æ â¬…ï¸</span></span><br><span class="line">    saveAllChangeableCQLs(cql, parseContext);</span><br><span class="line">    preDriverRun(context, parseContext);</span><br><span class="line">    executeTask(parseContext);                      <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    postDriverRun(context, parseContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeTask</span><span class="params">(ParseContext parseContext)</span> </span>&#123;</span><br><span class="line">    mergeConfs();</span><br><span class="line">    Task task = TaskFactory.createTask(context, parseContext, config, analyzeHooks);</span><br><span class="line">    task.execute(parseContext);                     <span class="comment">//æ‰§è¡Œä»»åŠ¡ â¬…ï¸</span></span><br><span class="line">    context.setQueryResult(task.getResult());       <span class="comment">//è¿”å›ç»“æœ(æŸ¥è¯¢æ€§çš„å‘½ä»¤æ¯”å¦‚show,getä¼šæœ‰ç»“æœ,å…¶ä»–æ²¡æœ‰ç»“æœ)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹çš„è¯­æ³•è§£æç±»æ˜¯ApplicationParser. parseæ–¹æ³•é‡‡ç”¨visitorè®¿é—®è€…æ¨¡å¼éå†CQLè¯­å¥. æ„Ÿå…´è¶£çš„å¯ä»¥è¿›å…¥CQLParseræŸ¥çœ‹å…·ä½“çš„è§£æè¿‡ç¨‹.     </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IParser (com.huawei.streaming.cql.semanticanalyzer.parser)</span><br><span class="line">    <span class="string">|-- OrderbyClauseParser </span></span><br><span class="line">    <span class="string">|-- GroupbyClauseParser </span></span><br><span class="line">    <span class="string">|-- ApplicationParser                   â¬…ï¸</span></span><br><span class="line">    <span class="string">|-- SelectClauseParser </span></span><br><span class="line">    <span class="string">|-- DataSourceArgumentsParser</span></span><br></pre></td></tr></table></figure>
<p>ParseContextçš„å®ç°ç±»å¾ˆå¤š,åŸºæœ¬ä¸ŠCQLè¯­æ³•çš„æ¯ä¸€éƒ¨åˆ†éƒ½ä¼šå¯¹åº”ä¸€ä¸ªè¯­æ³•è§£æå™¨.    </p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ParseContext (com.huawei.streaming.cql.semanticanalyzer.parser.<span class="keyword">context</span>)</span><br><span class="line">    |<span class="comment">-- CreateStreamStatementContext        è¯­å¥</span></span><br><span class="line">            |<span class="comment">-- CreatePipeStatementContext </span></span><br><span class="line">            |<span class="comment">-- CreateInputStatementContext </span></span><br><span class="line">            |<span class="comment">-- CreateOutputStatementContext </span></span><br><span class="line">    |<span class="comment">-- FromClauseContext                   å­å¥</span></span><br><span class="line">    |<span class="comment">-- RangeWindowContext                  çª—å£</span></span><br><span class="line">    |<span class="comment">-- ...</span></span><br></pre></td></tr></table></figure>
<h2 id="Input,Output,Insert">Input,Output,Insert</h2><p>ApplicationParser.parseè¿”å›çš„ParseContextå…·ä½“é’ˆå¯¹ç‰¹å®šçš„CQLè¯­å¥è¿”å›çš„æ˜¯ä»€ä¹ˆç±»å‹? è¿™ä¸ªç±»å‹å¯¹äºåˆ›å»ºä»€ä¹ˆç±»å‹çš„ä»»åŠ¡éå¸¸é‡è¦.<br>å› ä¸ºè¿™ä¸ªæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„Stream, æ‰€ä»¥ParseContextæ˜¯<code>CreateInputStatementContext</code>.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2015-11-25 02:32:19 | INFO  | [main] | <span class="operator"><span class="keyword">start</span> <span class="keyword">to</span> <span class="keyword">parse</span> cql : <span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s</span><br><span class="line">    (<span class="keyword">id</span> <span class="built_in">INT</span>, <span class="keyword">name</span> <span class="keyword">STRING</span>, <span class="keyword">type</span> <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">SOURCE</span> randomgen</span><br><span class="line">    PROPERTIES ( timeUnit = <span class="string">"SECONDS"</span>, <span class="keyword">period</span> = <span class="string">"1"</span>,</span><br><span class="line">        eventNumPerperiod = <span class="string">"1"</span>, isSchedule = <span class="string">"true"</span> ) | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.<span class="keyword">java</span>:<span class="number">44</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">19</span> | INFO  | [<span class="keyword">main</span>] | <span class="keyword">Parse</span> Completed | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.<span class="keyword">java</span>:<span class="number">69</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">19</span> | INFO  | [<span class="keyword">main</span>] | <span class="keyword">start</span> <span class="keyword">to</span> <span class="keyword">execute</span> <span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s (<span class="keyword">id</span> <span class="built_in">INT</span>, <span class="keyword">name</span> <span class="keyword">STRING</span>, <span class="keyword">type</span> <span class="built_in">INT</span>) <span class="keyword">SOURCE</span> randomgen PROPERTIES ( <span class="string">'timeUnit'</span> = <span class="string">'SECONDS'</span>, <span class="string">'period'</span> = <span class="string">'1'</span>, <span class="string">'eventNumPerperiod'</span> = <span class="string">'1'</span>, <span class="string">'isSchedule'</span> = <span class="string">'true'</span> ) | com.huawei.streaming.cql.tasks.LazyTask (LazyTask.<span class="keyword">java</span>:<span class="number">62</span>)</span></span><br></pre></td></tr></table></figure>
<p>CreateStreamStatementContext.createTaskåˆ›å»ºçš„æ˜¯LazyTask. å®ƒçš„executeæ–¹æ³•åªæ˜¯æŠŠå½“å‰ParseContextåŠ å…¥åˆ°DriverContextçš„parseContextsä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ParseContext parseContext)</span> </span>&#123;</span><br><span class="line">    context.addParseContext(parseContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·è¾“å‡ºæµç»è¿‡ApplicationParser.parseè¿”å›çš„æ˜¯<code>CreateOutputStatementContext</code>,å®ƒä¹Ÿç»§æ‰¿äº†CreateStreamStatementContext.  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2015-11-25 02:32:20 | INFO  | [main] | <span class="operator"><span class="keyword">start</span> <span class="keyword">to</span> <span class="keyword">parse</span> cql : <span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM rs</span><br><span class="line">    (<span class="keyword">type</span> <span class="built_in">INT</span>, cc <span class="built_in">INT</span>)</span><br><span class="line">SINK consoleOutput | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.<span class="keyword">java</span>:<span class="number">44</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">20</span> | INFO  | [<span class="keyword">main</span>] | <span class="keyword">Parse</span> Completed | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.<span class="keyword">java</span>:<span class="number">69</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">20</span> | INFO  | [<span class="keyword">main</span>] | <span class="keyword">start</span> <span class="keyword">to</span> <span class="keyword">execute</span> <span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM rs (<span class="keyword">type</span> <span class="built_in">INT</span>, cc <span class="built_in">INT</span>) SINK consoleOutput | com.huawei.streaming.cql.tasks.LazyTask (LazyTask.<span class="keyword">java</span>:<span class="number">62</span>)</span></span><br></pre></td></tr></table></figure>
<p>insertè¯­å¥æ˜¯<code>InsertStatementContext</code>, è¾“å…¥è¾“å‡ºæ’å…¥è¿™äº›éƒ½æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡,å¹¶ä¸éœ€è¦ç«‹å³æ‰§è¡Œ,å› ä¸ºéœ€è¦æ ¹æ®ä¸Šä¸‹æ–‡æ„é€ ä¸€ä¸ªå®Œæ•´çš„DAGæ‹“æ‰‘å›¾.   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2015-11-25 02:32:20 | INFO  | [main] | <span class="operator"><span class="keyword">start</span> <span class="keyword">to</span> <span class="keyword">parse</span> cql : <span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs <span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">as</span> cc</span><br><span class="line">    <span class="keyword">FROM</span> s[<span class="keyword">RANGE</span> <span class="number">20</span> SECONDS BATCH]</span><br><span class="line">    <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span> | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.<span class="keyword">java</span>:<span class="number">44</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">20</span> | INFO  | [<span class="keyword">main</span>] | <span class="keyword">Parse</span> Completed | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.<span class="keyword">java</span>:<span class="number">69</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">20</span> | INFO  | [<span class="keyword">main</span>] | <span class="keyword">start</span> <span class="keyword">to</span> <span class="keyword">execute</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs <span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">count</span>(<span class="keyword">id</span>) <span class="keyword">AS</span> cc <span class="keyword">FROM</span> s[<span class="keyword">RANGE</span> <span class="number">20</span> SECONDS BATCH] <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span> | com.huawei.streaming.cql.tasks.LazyTask (LazyTask.<span class="keyword">java</span>:<span class="number">62</span>)</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Submit">Submit</h2><p>æäº¤åº”ç”¨ç¨‹åº,ç»è¿‡parseè¿”å›çš„æ˜¯<code>SubmitApplicationContext</code>,åˆ›å»ºçš„Taskæ˜¯SubmitTask.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">23</span> | INFO  | [main] | start to parse cql : SUBMIT APPLICATION example | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.java:<span class="number">44</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">23</span> | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.java:<span class="number">69</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">25</span> <span class="number">02</span>:<span class="number">32</span>:<span class="number">24</span> | INFO  | [main] | combine all split contexts | com.huawei.streaming.cql.builder.operatorsplitter.OperatorSplitter (OperatorCombiner.java:<span class="number">101</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Task_&amp;_SemanticAnalyzer">Task &amp; SemanticAnalyzer</h3><p><img src="http://img.blog.csdn.net/20151125203206771" alt="stream-createTask"></p>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°å¯¹äºå‰é¢çš„è¾“å…¥æµ,è¾“å‡ºæµ,insertè¯­å¥,å¹¶æ²¡æœ‰å¯¹åº”çš„Taskå®ç°ç±»,æ‰€ä»¥å®ƒä»¬éƒ½ä½¿ç”¨LazyTask.  </p>
</blockquote>
<p>Driver.executeTaskä¼šæ ¹æ®ParseContextå…·ä½“çš„å®ç°ç±»ç”±TaskFactoryåˆ›å»ºå¯¹åº”çš„Task.  ParseContextæŠ½è±¡ç±»é™¤äº†åˆ›å»ºTask,è¿˜ä¼šåˆ›å»ºSemanticAnalyzer  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºå¯¹åº”è¯­å¥çš„æ‰§è¡Œtask</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Task <span class="title">createTask</span><span class="params">(DriverContext driverContext, List&lt;SemanticAnalyzeHook&gt; analyzeHooks)</span> <span class="keyword">throws</span> CQLException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºè¯­ä¹‰åˆ†ææ‰§è¡Œè§£æå™¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> SemanticAnalyzer <span class="title">createAnalyzer</span><span class="params">()</span> <span class="keyword">throws</span> SemanticAnalyzerException</span>;</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚SubmitApplicationContextåˆ›å»ºçš„åˆ†æå™¨æ˜¯SubmitApplicationAnalyzer. CreateStreamStatementContextä¹Ÿæ˜¯ä¸ªæŠ½è±¡ç±»,<br>æœ‰ä¸‰ä¸ªå­ç±»CreateInputStatementContext,CreateOutputStatementContext,CreatePipeStatementContext,å®ƒä»¬åˆ›å»ºçš„åˆ†æå™¨åˆ†åˆ«æ˜¯:<br>CreateInputStreamAnalyzer, CreateOutputStreamAnalyzer, CreatePipeStreamAnalyzer å®ƒä»¬éƒ½ç»§æ‰¿äº†CreateStreamAnalyzer.  </p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">ParseContext</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">SubmitApplicationContext</span></span><br><span class="line">                   <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreateStreamStatementContext</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span></span><br><span class="line">                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreateInputStatementContext</span></span><br><span class="line">                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreateOutputStatementContext</span></span><br><span class="line">                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreatePipeStatementContext</span></span><br><span class="line">                                                            </span><br><span class="line"><span class="comment">SemanticAnalyzer</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">SubmitApplicationAnalyzer</span></span><br><span class="line">                   <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreateStreamAnalyzer</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span></span><br><span class="line">                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreateInputStreamAnalyzer</span></span><br><span class="line">                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreateOutputStreamAnalyzer</span></span><br><span class="line">                                                    <span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">CreatePipeStreamAnalyzer</span></span><br></pre></td></tr></table></figure>
<p>SemanticAnalyzerçš„åˆ›å»ºæ–¹å¼å’Œåˆ›å»ºTaskä¸€æ ·éƒ½æ˜¯ä½¿ç”¨å·¥å‚ç±»<code>SemanticAnalyzerFactory</code>. åœ¨åˆ›å»ºå®Œä¹‹åéƒ½è°ƒç”¨äº†initåˆå§‹åŒ–.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task <span class="title">createTask</span><span class="params">(DriverContext driverContext, ParseContext parseContext, StreamingConfig config, List&lt;SemanticAnalyzeHook&gt; analyzeHooks)</span> </span>&#123;</span><br><span class="line">    Task task = parseContext.createTask(driverContext, analyzeHooks);   <span class="comment">// åˆ›å»ºTask â¬…ï¸</span></span><br><span class="line">    task.init(driverContext, config, analyzeHooks);</span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SemanticAnalyzer <span class="title">createAnalyzer</span><span class="params">(ParseContext parseContext, List&lt;Schema&gt; schemas)</span> </span>&#123;</span><br><span class="line">    SemanticAnalyzer analyzer = parseContext.createAnalyzer();          <span class="comment">// åˆ›å»ºè¯­ä¹‰è§£æå™¨ â¬…ï¸</span></span><br><span class="line">    analyzer.init(schemas);</span><br><span class="line">    <span class="keyword">return</span> analyzer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SubmitTask">SubmitTask</h3><h4 id="parseSubmit">parseSubmit</h4><p>SubmitTaskæ‰§è¡Œåº”ç”¨ç¨‹åºæäº¤çš„executeæ–¹æ³•å’Œå‰é¢çš„LazyTaskæœ‰ç‚¹å¤æ‚, å› ä¸ºå®ƒè¦æŠŠå‰é¢åˆ›å»ºçš„LazyTaskéƒ½ç»„åˆèµ·æ¥,ç»„æˆä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åº.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ParseContext parseContext)</span> </span>&#123;   <span class="comment">//è¿™é‡Œçš„parseContextæ˜¯SubmitApplicationContext</span></span><br><span class="line">    parseSubmit(parseContext);  <span class="comment">//è§£æ  â¬…ï¸ </span></span><br><span class="line">    createApplication();        <span class="comment">//åˆ›å»ºåº”ç”¨ç¨‹åº</span></span><br><span class="line">    dropApplicationIfAllow();   <span class="comment">//å¦‚æœå…è®¸çš„è¯å…ˆåˆ é™¤åº”ç”¨ç¨‹åº</span></span><br><span class="line">    submitApplication();        <span class="comment">//æäº¤åº”ç”¨ç¨‹åº</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è§£æSubmit,åˆ›å»ºå¯¹åº”çš„è¯­ä¹‰è§£æå™¨:SubmitApplicationAnalyzer</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSubmit</span><span class="params">(ParseContext parseContext)</span> </span>&#123;</span><br><span class="line">    SemanticAnalyzer analyzer = SemanticAnalyzerFactory.createAnalyzer(parseContext, EMPTY_SCHEMAS);</span><br><span class="line">    submitContext = (SubmitApplicationAnalyzeContext)analyzer.analyze();    <span class="comment">// åˆ›å»ºå®Œè¯­ä¹‰è§£æå™¨, å°±è¦è¿›è¡Œè¯­ä¹‰è§£æ â¬…ï¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢å‡ ä¸ªå¯¹è±¡çš„åˆ›å»ºå…³ç³»æ˜¯(Parserè¯­æ³•è§£æå™¨-&gt;Context-&gt;Analyzerè¯­ä¹‰åˆ†æå™¨-&gt;AnalyzerContext):  </p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationParser.parse() <span class="comment">--&gt; SubmitApplicationContext : ParseContext</span></span><br><span class="line">                                    |<span class="comment">--createTask: SubmitTask</span></span><br><span class="line">                                    |<span class="comment">--createAnalyzer: SubmitApplicationAnalyzer</span></span><br><span class="line">                                                               |<span class="comment">--createAnalyzeContext: SubmitApplicationAnalyzeContext</span></span><br></pre></td></tr></table></figure>
<h4 id="createApplication">createApplication</h4><p>åˆ›å»ºApplication,å¦‚æœæœ‰è·¯å¾„çš„è¯,ç›´æ¥åŠ è½½ç‰©ç†æ‰§è¡Œè®¡åˆ’,å¦åˆ™åˆ›å»ºä¸€ä¸ªAPIç”¨çš„Applicationå¹¶è®¾ç½®åˆ°DriverContextä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Application <span class="title">createAPIApplication</span><span class="params">(String appName)</span> </span>&#123;</span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (context.getApp() == <span class="keyword">null</span>) &#123;             <span class="comment">//åˆ›å»ºApplication</span></span><br><span class="line">        semanticAnalyzerLazyContexts();         <span class="comment">//å‡†å¤‡analyzeContexts â¬…ï¸</span></span><br><span class="line">        app = <span class="keyword">new</span> ApplicationBuilder().build(appName, analyzeContexts, context);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = context.getApp();</span><br><span class="line">    &#125;</span><br><span class="line">    app.setApplicationId(appName);</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºAPIApplication, è®°å¾—å‰é¢çš„é‚£äº›LazyTaskå—, éƒ½è¦ç”¨è¯­ä¹‰åˆ†æåˆ†æä¸€é,å¯¹åº”çš„AnalyzeContextä¼šè¢«ApplicationBuilderç”¨åˆ°.<br>å› ä¸ºLazyTaskçš„executeæ–¹æ³•åªæ˜¯ç®€å•åœ°æŠŠå½“å‰çš„ParseContextå®ç°ç±»åŠ å…¥åˆ°DriverContextä¸­,æ‰€ä»¥ä¸‹é¢çš„forå¾ªç¯èƒ½ä»DriverContextè·å–å‡ºæ‰€æœ‰ParseContext.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">semanticAnalyzerLazyContexts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ParseContext parseContext : context.getParseContexts()) &#123;</span><br><span class="line">        preAnalyze(context, parseContext);</span><br><span class="line">        SemanticAnalyzer analyzer = SemanticAnalyzerFactory.createAnalyzer(parseContext, context.getSchemas());</span><br><span class="line">        AnalyzeContext analyzeContext = analyzer.analyze();</span><br><span class="line">        postAnalyze(context, analyzeContext, parseContext);</span><br><span class="line">        analyzeContexts.add(analyzeContext);    <span class="comment">//å°†å„è‡ªçš„åˆ†æå™¨åˆ†æçš„ç»“æœAnalyzeContextå®ç°ç±»åŠ å…¥åˆ°analyzeContexts</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åƒSubmitTaskä¸€æ ·éƒ½è¦å…ˆåˆ›å»ºSemanticAnalyzer,ç„¶åè°ƒç”¨analyzeæ–¹æ³•, è¿™äº›æ²¡æœ‰è°ƒç”¨çš„æ–¹æ³•éƒ½è¦è°ƒç”¨. éªŒè¯äº†é‚£å¥è¯:<code>äººåœ¨æ±Ÿæ¹–æ¼‚,å“ªæœ‰ä¸æŒ¨åˆ€.è¯¥æ¥çš„æ€»æ˜¯ä¼šæ¥çš„</code>. </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationParser.parse() --&gt; CreateInputStatementContext|<span class="string">CreateOutputStatementContext : ParseContext</span><br><span class="line">                                                         </span>|<span class="string">--createTask: LazyTask</span><br><span class="line">                                                         </span>|<span class="string">--createAnalyzer: CreateInputStreamAnalyzer</span>|CreateOutputStreamAnalyzer</span><br><span class="line">                                                                                                     |<span class="string">--createAnalyzeContext: CreateStreamAnalyzeContext</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„Input,Outputçš„StatementContext,SemanticAnalyzeréƒ½æœ‰å„è‡ªçš„å®ç°ç±»,å¹¶éƒ½ç»§æ‰¿äº†Streamçš„ç›¸å…³çˆ¶ç±»,ä½†æ˜¯AnalyzeContextæ²¡æœ‰å„è‡ªçš„å®ç°ç±»,éƒ½æ˜¯ä¸€æ ·çš„äº†.   </p>
</blockquote>
<h3 id="ApplicationBuilder">ApplicationBuilder</h3><p>ApplicationBuilderçš„æ„å»ºéœ€è¦æ¯ä¸ªåˆ†æå™¨åˆ†æçš„ç»“æœAnalyzeContext(parseContexts): ä¸“é—¨ç”¨æ¥å®Œæˆä»å¤šä¸ªè§£æå†…å®¹åˆ°åº”ç”¨ç¨‹åºçš„è½¬æ¢<br>buildApplication()å°†æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ„å»ºåˆ†æˆ:  1ã€å„ä¸ªç®—å­çš„æ„å»º;  2ã€å°†å®Œæˆæ‹†åˆ†çš„åº”ç”¨ç¨‹åºè§£ææˆä¸ºApplication  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">build</span><span class="params">(String appName, List&lt;AnalyzeContext&gt; parContexts, DriverContext driverContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.applicationName = appName;     <span class="comment">//åº”ç”¨ç¨‹åºåç§°</span></span><br><span class="line">    <span class="keyword">this</span>.parseContexts = parContexts;   <span class="comment">//ä¸€ç³»åˆ—CQLè¯­å¥çš„è§£æç»“æœ</span></span><br><span class="line">    </span><br><span class="line">    executeLogicOptimizer();            <span class="comment">//åœ¨æ„å»ºåº”ç”¨ç¨‹åºä¹‹å‰ï¼Œè¦å…ˆæ‰§è¡Œé€»è¾‘ä¼˜åŒ–å™¨. ç›®å‰è²Œä¼¼è¿˜æ²¡å®ç°.</span></span><br><span class="line">    buildApplication();                 <span class="comment">//æ„å»ºåº”ç”¨ç¨‹åº</span></span><br><span class="line">    executePhysicOptimizer();           <span class="comment">//åœ¨æ„å»ºåº”ç”¨ç¨‹åºä¹‹åï¼Œè¦å…ˆæ‰§è¡Œç‰©ç†ä¼˜åŒ–å™¨</span></span><br><span class="line">    parseDriverContext(driverContext);  <span class="comment">//å°†DriverContextçš„çš„å€¼è®¾ç½®åˆ°Applicationä¸­,æ¯”å¦‚UserConf,UserFile,UDF</span></span><br><span class="line">    <span class="keyword">return</span> app;                         <span class="comment">//æ„å»ºå®Œæˆçš„åº”ç”¨ç¨‹åº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘è®¡åˆ’åŒ…å«çš„åŠŸèƒ½:<br>1ã€SQLè¯­å¥çš„é‡å†™ï¼Œæ¯”å¦‚å°†whereä¸­çš„èšåˆfilterè°ƒæ•´åˆ°havingä¸­ç­‰ç­‰<br>2ã€count(a+b),count(*),count(a) çš„ä¼˜åŒ–ï¼Œå…¨éƒ¨æ”¹æˆcount(1)<br>3ã€Joinçš„è°ƒæ•´ï¼Œå°†ä¸ç­‰å€¼Joinæ”¹ä¸ºInnerjoin<br>4ã€å°†whereæ¡ä»¶ä¸­çš„ç­‰å€¼è¡¨è¾¾å¼æå‡åˆ°Onä¸Šé¢å»ã€‚  </p>
<p>ç‰©ç†ä¼˜åŒ–å™¨çš„ä¼˜åŒ–å†…å®¹ï¼š<br>1ã€OrderByä¼˜åŒ–ï¼Œå®ç°sorted-mergeæ’åºã€‚<br>2ã€limitä¼˜åŒ–ï¼Œä¸Šä¸€ä¸ªç®—å­ä¸­åŠ å…¥limitã€‚<br>3ã€ç®—å­æ›¿æ¢ï¼Œå°†åŠŸèƒ½æ¯”è¾ƒç®€å•çš„ç®—å­ï¼Œæ›¿æ¢ä¸ºFilterç®—å­æˆ–è€…functorç®—å­<br>4ã€ç§»é™¤æ— æ„ä¹‰çš„filterç®—å­</p>
<p>é€»è¾‘è®¡åˆ’å’Œç‰©ç†è®¡åˆ’ä¸­é—´çš„æ­¥éª¤æ˜¯æ„å»ºApplication. åœ¨è¿™é‡Œæ‰å¼€å§‹newä¸€ä¸ªApplication.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    app = <span class="keyword">new</span> Application(applicationName);                         <span class="comment">//åˆ›å»ºApplication</span></span><br><span class="line">    parseSchemas();                                                 <span class="comment">//è®¾ç½®æ‰€æœ‰AnalyzeContextçš„CreatedSchemasåˆ°appçš„schemas</span></span><br><span class="line">    List&lt;SplitContext&gt; splitContexts = splitOperators();            <span class="comment">//æ‹†åˆ†ç®—å­</span></span><br><span class="line">    SplitContext splitContext = combineOperators(splitContexts);    <span class="comment">//åˆå¹¶ç®—å­</span></span><br><span class="line">    changeUnionOperators(splitContext);</span><br><span class="line">    changeSchemaAfterAggregate(splitContext);</span><br><span class="line">    app.setOperators(splitContext.getOperators());                  <span class="comment">//å°†æ‹†åˆ†|åˆå¹¶ç®—å­çš„operatorså’Œtransitionsè®¾ç½®åˆ°Applicationé‡Œ</span></span><br><span class="line">    app.setOpTransition(splitContext.getTransitions());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é¢„å‘Š: SemanticAnalyzer.analyze()å’Œå…·ä½“çš„CQLè¯­æ³•ç›¸å…³,ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°±æ¥çœ‹çœ‹CQLçš„è¯­æ³•å’Œè¯­ä¹‰è§£ææ˜¯æ€ä¹ˆå·¥ä½œçš„.  </p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storm/">storm</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-11-20-Cassandra-Stream" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-11-20-Cassandra-Stream/" class="article-date">
  	<time datetime="2015-12-01T10:02:46.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-11-20-Cassandra-Stream/">Cassandraæºç åˆ†æä¹‹Stream</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="sstableloaderæµç¨‹">sstableloaderæµç¨‹</h2><p>BulkLoaderä¸»æ–¹æ³•åˆ›å»ºSSTableLoader,è°ƒç”¨streamå¼€å§‹æµå¼ä¼ è¾“:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Futureæ“ä½œ,éé˜»å¡çš„. æŠŠé•¿æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡å°è£…åœ¨Futureé‡Œ, ç¨‹åºä¸»é€»è¾‘ç»§ç»­å¾€ä¸‹æ‰§è¡Œ, é€šè¿‡future.getè·å–ç»“æœ</span></span><br><span class="line">StreamResultFuture future = loader.stream(options.ignores);</span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è·å–åˆ°ç»“æœ, ä¼šä¸€ç›´é˜»å¡ä¸‹å», ç›´åˆ°ä»»åŠ¡å®Œæˆ, æ‰é€€å‡º</span></span><br><span class="line">future.get();</span><br></pre></td></tr></table></figure>
<p>SSTableLoader.streamæ–¹æ³•è¿”å›Futureæ‰èƒ½è®©è°ƒç”¨è€…åœ¨Futureä¸Šè°ƒç”¨get.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StreamResultFuture <span class="title">stream</span><span class="params">(Set&lt;InetAddress&gt; toIgnore, StreamEventHandler... listeners)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–, å®¢æˆ·ç«¯ä¸ºBulkLoaderåˆ›å»ºçš„ExternalClient. </span></span><br><span class="line">    client.init(keyspace);</span><br><span class="line">    <span class="comment">//æ„é€ ä¸€ä¸ªæµä¼ è¾“çš„æ‰§è¡Œè®¡åˆ’. æµå¯ä»¥çœ‹åšæ˜¯æµåŠ¨,æˆ–è€…æµå¼</span></span><br><span class="line">    StreamPlan plan = <span class="keyword">new</span> StreamPlan(<span class="string">"Bulk Load"</span>).connectionFactory(client.getConnectionFactory());</span><br><span class="line">    <span class="comment">//åœ¨åˆå§‹åŒ–ä¹‹å, èƒ½å¾—åˆ°ç›®æ ‡é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹å¯¹ä¸€ä¸ªçš„TokenRangeé›†åˆ. å› ä¸ºä¸€ä¸ªèŠ‚ç‚¹æœ‰256ä¸ªvnodes,æ‰€ä»¥ä¸€ä¸ªèŠ‚ç‚¹ä¼šæœ‰å¾ˆå¤šä¸ªToken!</span></span><br><span class="line">    Map&lt;InetAddress, Collection&lt;Range&lt;Token&gt;&gt;&gt; endpointToRanges = client.getEndpointToRangesMap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“å¼€sstables... ä¼šç”ŸæˆstreamingDetails, ä¸‹é¢è¿›ä¸€æ­¥å¤„ç†streamingDetails, è½¬æ¢ç»“æ„</span></span><br><span class="line">    openSSTables(endpointToRanges);</span><br><span class="line">    <span class="comment">//ä¸Šé¢çš„openSSTablesæ˜¯ä»¥ä¸€ä¸ªä¸ªçš„SSTableä¸ºè§†è§‰, ç°åœ¨å›åˆ°streamä¸»æ–¹æ³•,éœ€è¦ä»¥ç›®æ ‡èŠ‚ç‚¹ä¸ºè§†è§‰</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;InetAddress, Collection&lt;Range&lt;Token&gt;&gt;&gt; entry : endpointToRanges.entrySet()) &#123;</span><br><span class="line">        InetAddress remote = entry.getKey();</span><br><span class="line">        List&lt;StreamSession.SSTableStreamingSections&gt; endpointDetails = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="comment">// transferSSTables assumes references have been acquired.  streamingDetailsæ˜¯ä»openSSTablesä¸­å¾—åˆ°çš„</span></span><br><span class="line">        <span class="keyword">for</span> (StreamSession.SSTableStreamingSections details : streamingDetails.get(remote)) &#123;</span><br><span class="line">            endpointDetails.add(details);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ ‡è®°remote endpointèŠ‚ç‚¹éœ€è¦å¤„ç†è¿™äº›stream sections</span></span><br><span class="line">        plan.transferFiles(remote, endpointDetails);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç›‘å¬å™¨,æ¯”å¦‚è¿›åº¦æ¡ProgressIndicator</span></span><br><span class="line">    plan.listeners(<span class="keyword">this</span>, listeners);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çœŸæ­£å¼€å§‹æ‰§è¡ŒStreamPlan</span></span><br><span class="line">    <span class="keyword">return</span> plan.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆè°ƒç”¨StreamPlançš„transferFiles, ç­‰æ‰€æœ‰endpointséƒ½éå†å®Œæ‰å¼€å§‹execute. åœ¨transferFilesä¼šå‡†å¤‡ä¸€äº›executeå¿…å¤‡çš„æ•°æ®æ¯”å¦‚sessions.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StreamPlan <span class="title">transferFiles</span><span class="params">(InetAddress to, Collection&lt;StreamSession.SSTableStreamingSections&gt; sstableDetails)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//èŠ‚ç‚¹toå¯¹åº”çš„Sessionå¦‚æœå·²ç»å­˜åœ¨åˆ™ç›´æ¥è·å–,æ²¡æœ‰å°±åˆ›å»º</span></span><br><span class="line">    StreamSession session = getOrCreateSession(to, to);</span><br><span class="line">    <span class="comment">//ä¸ºè¿™ä¸ªSessionæ·»åŠ ä»»åŠ¡: è¦ä¼ è¾“çš„sstableæ–‡ä»¶</span></span><br><span class="line">    session.addTransferFiles(sstableDetails);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> StreamSession <span class="title">getOrCreateSession</span><span class="params">(InetAddress peer, InetAddress preferred)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//sessionsæ˜¯æ€ä¹ˆæ¥çš„? åªæœ‰åœ¨è¿™ä¸ªæ–¹æ³•é‡Œputè¿›å»çš„. æ‰€ä»¥è°ƒç”¨è¯¥æ–¹æ³•,å¦‚æœä¸åœ¨sessionså°±ä¼šnewä¸€ä¸ªå¹¶æ”¾è¿›æ¥</span></span><br><span class="line">    <span class="comment">//peeræœ‰å¯èƒ½æ˜¯fromèŠ‚ç‚¹,æ¯”å¦‚ç›®æ ‡èŠ‚ç‚¹/æ¥æ”¶æ•°æ®çš„èŠ‚ç‚¹. peerä¹Ÿå¯èƒ½æ˜¯toèŠ‚ç‚¹,ç›®æ ‡èŠ‚ç‚¹,è¦ä¼ è¾“åˆ°è¿™ä¸ªç›®æ ‡èŠ‚ç‚¹.</span></span><br><span class="line">    <span class="comment">//é‚£ä¹ˆfromå’Œtoå°±æœ‰å¯èƒ½æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹.æ¯”å¦‚æ‰§è¡Œsstableå‘½ä»¤çš„èŠ‚ç‚¹æ˜¯æº,åˆ™æ¥æ”¶æ•°æ®to/è¯·æ±‚æ•°æ®fromçš„èŠ‚ç‚¹æ˜¯ç›®æ ‡èŠ‚ç‚¹</span></span><br><span class="line">    StreamSession session = sessions.get(peer);</span><br><span class="line">    <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">        session = <span class="keyword">new</span> StreamSession(peer, preferred, connectionFactory);</span><br><span class="line">        sessions.put(peer, session);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StreamPlan.executeè¿”å›çš„æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„StreamResultFuture,åŸºäºFuture.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StreamResultFuture <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åªæœ‰ä¸€ä¸ªStreamPlan,ä½†æ˜¯æœ‰å¥½å¤šä¸ªStreamSession. è¦å¼€å§‹ä¸€èµ·å¼€å§‹å§</span></span><br><span class="line">    <span class="keyword">return</span> StreamResultFuture.init(planId, description, sessions.values(), handlers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–StreamResultFutureä¼šåˆ›å»ºStreamResultFutureå¹¶æ³¨å†Œåˆ°StreamManager,ç„¶åæŠŠå®ƒä¼ é€’ç»™æ‰€æœ‰StreamSessionçš„åˆå§‹åŒ–æ–¹æ³•, æœ€åå¯åŠ¨æ¯ä¸ªStreamSession:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–å¼‚æ­¥è¿”å›ç»“æœå™¨. ä¸€ä¸ªStreamPlanåªæœ‰ä¸€ä¸ªStreamResultFuture,æœ‰å¤šä¸ªStreamSessions, æ‰€æœ‰çš„StreamSessionså…±ç”¨ä¸€ä¸ªStreamResultFuture</span></span><br><span class="line"><span class="comment">//å› ä¸ºä¸€æ¬¡Streamåªéœ€è¦æœ€åçš„ä¸€ä¸ªç»“æœæ¥è¡¨ç¤ºæ‰€æœ‰(èŠ‚ç‚¹)çš„StreamSessionæ˜¯å¦éƒ½å·²ç»å®Œæˆ. ä¸€ä¸ªStreamSessionå¯¹åº”ä¸€ä¸ªèŠ‚ç‚¹çš„ä¼ è¾“.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> StreamResultFuture <span class="title">init</span><span class="params">(UUID planId, String description, Collection&lt;StreamSession&gt; sessions, Collection&lt;StreamEventHandler&gt; listeners)</span> </span>&#123;</span><br><span class="line">    StreamResultFuture future = createAndRegister(planId, description, sessions);</span><br><span class="line">    <span class="keyword">if</span> (listeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ç»™å¼‚æ­¥æ‰§è¡Œç»“æœæ·»åŠ ç›‘å¬å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (StreamEventHandler listener : listeners)</span><br><span class="line">            future.addEventListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"[Stream #&#123;&#125;] Executing streaming plan for &#123;&#125;"</span>, planId,  description);</span><br><span class="line">    <span class="comment">// start sessions</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> StreamSession session : sessions) &#123;</span><br><span class="line">        logger.info(<span class="string">"[Stream #&#123;&#125;] Beginning stream session with &#123;&#125;"</span>, planId, session.peer);</span><br><span class="line">        <span class="comment">//StreamPlançš„executeä¼šå¯åŠ¨åŒä¸€ä¸ªStreamPlançš„æ‰€æœ‰StreamSession. æœ€åå®é™…æ‰§è¡Œçš„è¿˜æ˜¯è¦äº¤ç»™StreamSession</span></span><br><span class="line">        session.init(future);</span><br><span class="line">        <span class="comment">//å¯åŠ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„StreamSessionä»»åŠ¡</span></span><br><span class="line">        session.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸ºä»€ä¹ˆè¦è¿”å›Future:å¯¹äºå¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡éœ€è¦è¿”å›Future,è¿™æ ·è°ƒç”¨è€…æ‰èƒ½ä½¿ç”¨future.getæ¥è·å¾—ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºåœ¨executeå‰å·²ç»transferFiles,æ‰€ä»¥æ¯ä¸ªStreamSessionçš„transferséƒ½æ˜¯æœ‰æ•°æ®çš„,å½“ç„¶ä¹Ÿå¯èƒ½æ˜¯requests. ç„¶åç”¨çº¿ç¨‹æ± å¯åŠ¨ä»»åŠ¡ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è¯·æ±‚æˆ–è€…ä¼ è¾“å¿…é€‰å…¶ä¸€,å¦åˆ™è¯´æ˜è¿™ä¸ªSessionå·²ç»å®Œæˆäº†</span></span><br><span class="line">    <span class="keyword">if</span> (requests.isEmpty() &amp;&amp; transfers.isEmpty())&#123;</span><br><span class="line">        closeSession(State.COMPLETE);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    streamExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">//å‡†å¤‡å¥½ConnectionHandler</span></span><br><span class="line">            handler.initiate();</span><br><span class="line">            <span class="comment">//åˆå§‹åŒ–å®Œæ¯•</span></span><br><span class="line">            onInitializationComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ConnectionHandleråˆ›å»ºè¾“å…¥å’Œè¾“å‡ºçš„æ¶ˆæ¯å¤„ç†å™¨. handlerç®¡ç†è¿™ä¸¤ä¸ªçº¿ç¨‹.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initiate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Socket incomingSocket = session.createConnection();</span><br><span class="line">    incoming.start(incomingSocket, StreamMessage.CURRENT_VERSION);</span><br><span class="line">    incoming.sendInitMessage(incomingSocket, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    Socket outgoingSocket = session.createConnection();</span><br><span class="line">    outgoing.start(outgoingSocket, StreamMessage.CURRENT_VERSION);</span><br><span class="line">    outgoing.sendInitMessage(outgoingSocket, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥å’Œè¾“å‡ºMessageHandleréƒ½ç»§æ‰¿MessageHandleræŠ½è±¡çº¿ç¨‹ç±»,åˆå§‹åŒ–æ—¶éƒ½å‘é€InitMessage:    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendInitMessage</span><span class="params">(Socket socket, <span class="keyword">boolean</span> isForOutgoing)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºåˆå§‹åŒ–æ¶ˆæ¯, å¹¶è½¬åŒ–ä¸ºByteBuffer, ç”±WriteChannelå‘é€å‡ºå»(å³å†™å…¥åˆ°WriteChannelä¸­)</span></span><br><span class="line">    <span class="comment">//WriteChannelæ˜¯ç”±Socketåˆ›å»ºçš„, è¡¨ç¤ºè¦å†™å…¥åˆ°Socketè¿™ä¸ªåœ°å€åˆ›å»ºçš„å†™å…¥é€šé“ä¸­</span></span><br><span class="line">    StreamInitMessage message = <span class="keyword">new</span> StreamInitMessage(FBUtilities.getBroadcastAddress(), session.planId(), session.description(), isForOutgoing);</span><br><span class="line">    ByteBuffer messageBuf = message.createMessage(<span class="keyword">false</span>, protocolVersion);</span><br><span class="line">    <span class="keyword">while</span> (messageBuf.hasRemaining())</span><br><span class="line">        getWriteChannel(socket).write(messageBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–å®Œæ¯•StreamSession.startå¼€å§‹å‘é€PREPAREå‡†å¤‡æ¶ˆæ¯:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInitializationComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// send prepare message</span></span><br><span class="line">    state(State.PREPARING);</span><br><span class="line">    PrepareMessage prepare = <span class="keyword">new</span> PrepareMessage();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¶ˆæ¯ä¸­é™„å¸¦äº†requestsè¯·æ±‚æˆ–è€…ä¼ è¾“ä»»åŠ¡transfers(ä»»åŠ¡ä¸€å¼€å§‹åªæ˜¯Summary)</span></span><br><span class="line">    prepare.requests.addAll(requests);</span><br><span class="line">    <span class="keyword">for</span> (StreamTransferTask task : transfers.values())</span><br><span class="line">        prepare.summaries.add(task.getSummary());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘é€æ¶ˆæ¯</span></span><br><span class="line">    handler.sendMessage(prepare);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we don't need to prepare for receiving stream, start sending files immediately</span></span><br><span class="line">    <span class="keyword">if</span> (requests.isEmpty())</span><br><span class="line">        startStreamingFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘é€æ¶ˆæ¯æ”¾åˆ°OutgoingMessageHandler.messageQueueé˜Ÿåˆ—ä¸­. ä¸æ­¤åŒæ—¶è¾“å‡ºçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶åºåˆ—åŒ–æ¶ˆæ¯åˆ°outå†™å…¥é€šé“ä¸­:<br>StreamMessageæ˜¯æ¶ˆæ¯çš„æŠ½è±¡ç±»,å„ç±»æ¶ˆæ¯éœ€è¦æœ‰è‡ªå·±çš„åºåˆ—åŒ–å®ç°å™¨,å› ä¸ºä¸åŒç±»å‹çš„æ¶ˆæ¯é‡Œé¢çš„å†…å®¹æ˜¯ä¸ä¸€æ ·çš„.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‘é€æ¶ˆæ¯, éœ€è¦åºåˆ—åŒ–æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(WritableByteChannel out, StreamMessage message)</span> </span>&#123;</span><br><span class="line">    StreamMessage.serialize(message, out, protocolVersion, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å‡è®¾å¾€outå‘é€äº†PrepareMessageæ¶ˆæ¯, ä¸æ­¤åŒæ—¶ConnectionHandlerçš„è¾“å…¥çº¿ç¨‹IncomingMessageHandleræ”¶åˆ°äº†è¿™æ¡æ¶ˆæ¯è¿›è¡Œååºåˆ—åŒ–:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReadableByteChannel in = getReadChannel(socket);</span><br><span class="line">    <span class="keyword">while</span> (!isClosed()) &#123;</span><br><span class="line">        <span class="comment">// receive message</span></span><br><span class="line">        StreamMessage message = StreamMessage.deserialize(in, protocolVersion, session);</span><br><span class="line">        <span class="comment">// Might be null if there is an error during streaming (see FileMessage.deserialize). It's ok to ignore here since we'll have asked for a retry.</span></span><br><span class="line">        <span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">            session.messageReceived(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StreamSessionè´Ÿè´£å¤„ç†æ¶ˆæ¯,å¦‚æœæ˜¯PrepareMessage,ä»ä¸­è·å–å‡ºé™„å¸¦çš„requestså’Œtransfersè°ƒç”¨prepareæ–¹æ³•:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(StreamMessage message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (message.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> PREPARE:</span><br><span class="line">            PrepareMessage msg = (PrepareMessage) message;</span><br><span class="line">            prepare(msg.requests, msg.summaries);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FILE:</span><br><span class="line">            receive((IncomingFileMessage) message);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RECEIVED:</span><br><span class="line">            ReceivedMessage received = (ReceivedMessage) message;</span><br><span class="line">            received(received.cfId, received.sequenceNumber);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PREPAREåå°±ä¸Šå¼€å§‹ä¼ è¾“æ–‡ä»¶äº†:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startStreamingFiles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    streamResult.handleSessionPrepared(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    state(State.STREAMING);</span><br><span class="line">    <span class="keyword">for</span> (StreamTransferTask task : transfers.values()) &#123;</span><br><span class="line">        Collection&lt;OutgoingFileMessage&gt; messages = task.getFileMessages();</span><br><span class="line">        <span class="keyword">if</span> (messages.size() &gt; <span class="number">0</span>)</span><br><span class="line">            handler.sendMessages(messages);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            taskCompleted(task); <span class="comment">// there is no file to send</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨StreamPlançš„transferFilessä¸­ä¼šè°ƒç”¨StreamSession.addTransferFileså°†è¦ä¼ è¾“çš„æ–‡ä»¶åŠ å…¥åˆ°StreamTransferTask:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸ºSessionæ·»åŠ è¦ä¼ è¾“çš„æ–‡ä»¶åˆ—è¡¨, æ·»åŠ åˆ°TransferTaskä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTransferFiles</span><span class="params">(Collection&lt;SSTableStreamingSections&gt; sstableDetails)</span> </span>&#123;</span><br><span class="line">    Iterator&lt;SSTableStreamingSections&gt; iter = sstableDetails.iterator();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        SSTableStreamingSections details = iter.next();</span><br><span class="line">        <span class="comment">//æ¯å¼ è¡¨åº”è¯¥éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ID, è€Œä¸”IDæ˜¯ä¸ä¼šå˜çš„å§å¯¹äºåŒä¸€å¼ è¡¨è€Œè¨€</span></span><br><span class="line">        UUID cfId = details.sstable.metadata.cfId;</span><br><span class="line">        StreamTransferTask task = transfers.get(cfId);</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">            task = <span class="keyword">new</span> StreamTransferTask(<span class="keyword">this</span>, cfId);</span><br><span class="line">            transfers.put(cfId, task);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é’ˆå¯¹åŒä¸€å¼ è¡¨,åªä¼šæœ‰ä¸€ä¸ªTransferTask.ä½†æ˜¯è¿™ä¸ªTaskçš„tablesæ–‡ä»¶ä¼šå¾ˆå¤š</span></span><br><span class="line">        task.addTransferFile(details.sstable, details.estimatedKeys, details.sections);</span><br><span class="line">        <span class="comment">//SSTableStreamingSectionsé˜…åå³ç„š</span></span><br><span class="line">        iter.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼ è¾“æ–‡ä»¶çš„ç±»å‹æ˜¯OutgoingFileMessage, æ‰€ä»¥ä¸Šé¢startStreamingFileså¼€å§‹ä¼ è¾“çš„æ¶ˆæ¯æ˜¯Collection<outgoingfilemessage>,<br>å› ä¸ºä¸€ä¸ªTaskå¯ä»¥è°ƒç”¨å¤šæ¬¡addTransferFileå°±æœ‰å¤šä¸ªè¦ä¼ è¾“çš„æ–‡ä»¶(ä¸Šé¢çš„cfIdæ˜¯CFè¡¨çš„ç¼–å·,åˆ™sstableloaderä¸€æ¬¡ä¸€ä¸ªè¡¨å°±åªæœ‰ä¸€ä¸ªStreamTransferTaskäº†):     </outgoingfilemessage></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addTransferFile</span><span class="params">(SSTableReader sstable, <span class="keyword">long</span> estimatedKeys, List&lt;Pair&lt;Long, Long&gt;&gt; sections)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ¯ä¸€ä¸ªè¦ä¼ è¾“çš„æ–‡ä»¶éƒ½åŒ…è£…æˆè¾“å‡ºæ–‡ä»¶æ¶ˆæ¯, åºåˆ—å·å¯ä»¥è¡¨ç¤ºæ–‡ä»¶ç¼–å·,å› ä¸ºè°ƒç”¨ä¸€æ¬¡å°±å¢åŠ 1. å…¶ä»–ä¿¡æ¯sstable,sectionséƒ½æ˜¯ä»ä¸€å¼€å§‹æ²¿è¢­è¿‡æ¥çš„.</span></span><br><span class="line">    OutgoingFileMessage message = <span class="keyword">new</span> OutgoingFileMessage(sstable, sequenceNumber.getAndIncrement(), estimatedKeys, sections);</span><br><span class="line">    files.put(message.header.sequenceNumber, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OutgoingFileMessageçš„ç±»å‹æ˜¯FILE,å¯¹åº”messageReceivedçš„ä¼šå°†æ¶ˆæ¯è½¬æ¢ä¸ºIncommingFileMessageå¹¶è°ƒç”¨receive:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OutgoingFileMessage</span><span class="params">(SSTableReader sstable, <span class="keyword">int</span> sequenceNumber, <span class="keyword">long</span> estimatedKeys, List&lt;Pair&lt;Long, Long&gt;&gt; sections)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Type.FILE);</span><br><span class="line">    <span class="keyword">this</span>.sstable = sstable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸ŠIncommingFileMessageçš„StreamMessageä¹Ÿæ˜¯FILE. è¿™æ ·Incommingå’ŒOutgoingå„å¸å…¶èŒ: Outgoingè¾“å‡ºè´Ÿè´£åºåˆ—åŒ–,Incommingè¾“å…¥è´Ÿè´£ååºåˆ—åŒ–.  </p>
<ul>
<li>è¾“å‡ºæ¶ˆæ¯OutgoingFileMessageçš„sstableæ˜¯SSTableReader, é€šè¿‡å°è£…æˆStreamWriterè¾“å‡º.  </li>
<li>è¯»å–æ¶ˆæ¯IncomingFileMessageé€šè¿‡æ„é€ StreamReaderè¯»å–è¾“å…¥æµ<code>reader.read(in)</code>æœ€ç»ˆå½¢æˆSSTableWriter.  </li>
<li><code>SSTableReader</code>å’Œ<code>SSTableWriter</code>å‡ç»§æ‰¿<code>SSTable</code>,ç”¨äºè¯»å†™SSTableæ–‡ä»¶, ä½†æ˜¯<code>StreamReader</code>å’Œ<code>StreamWriter</code>æä¾›çš„æ˜¯æµçš„è¯»å†™/ä¼ è¾“. </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯¹è¾“å‡ºæ¶ˆæ¯è¿›è¡Œåºåˆ—åŒ–(output, write, serialize)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Serializer&lt;OutgoingFileMessage&gt; serializer = <span class="keyword">new</span> Serializer&lt;OutgoingFileMessage&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(OutgoingFileMessage message, WritableByteChannel out, <span class="keyword">int</span> version, StreamSession session)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        DataOutput output = <span class="keyword">new</span> DataOutputStream(Channels.newOutputStream(out));</span><br><span class="line">        FileMessageHeader.serializer.serialize(message.header, output, version);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åŒ…è£…åœ¨OutgoingFileMessageé‡Œçš„sstableæ˜¯SSTableReader, æœ€æ—©æ˜¯åœ¨SSTableLoader:SSTableReader.openForBatchæ‰“å¼€çš„.  </span></span><br><span class="line">        <span class="keyword">final</span> SSTableReader reader = message.sstable;</span><br><span class="line">        <span class="comment">//è½¬æ¢æˆStreamWriter, ä¸ºä»€ä¹ˆä¸ç›´æ¥æ˜¯SSTableWriter? å› ä¸ºè¦è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–,ç”¨å­—èŠ‚æµå½¢å¼å³StreamWriteræ›´å¿«.  </span></span><br><span class="line">        StreamWriter writer = message.header.compressionInfo == <span class="keyword">null</span> ? <span class="keyword">new</span> StreamWriter(reader, message.header.sections, session) :</span><br><span class="line">                <span class="keyword">new</span> CompressedStreamWriter(reader, message.header.sections, message.header.compressionInfo, session);</span><br><span class="line">        writer.write(out);</span><br><span class="line">        session.fileSent(message.header);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–è¾“å…¥æ¶ˆæ¯ååºåˆ—åŒ–(input, read, deserialize)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Serializer&lt;IncomingFileMessage&gt; serializer = <span class="keyword">new</span> Serializer&lt;IncomingFileMessage&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IncomingFileMessage <span class="title">deserialize</span><span class="params">(ReadableByteChannel in, <span class="keyword">int</span> version, StreamSession session)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        DataInputStream input = <span class="keyword">new</span> DataInputStream(Channels.newInputStream(in));</span><br><span class="line">        FileMessageHeader header = FileMessageHeader.serializer.deserialize(input, version);</span><br><span class="line">        StreamReader reader = header.compressionInfo == <span class="keyword">null</span> ? <span class="keyword">new</span> StreamReader(header, session) : <span class="keyword">new</span> CompressedStreamReader(header, session);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IncomingFileMessage(reader.read(in), header);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>FileMessage</th>
<th>SSTable</th>
<th>Stream</th>
<th>IN/OUT</th>
<th>SER/DESER</th>
<th>read/write</th>
</tr>
</thead>
<tbody>
<tr>
<td>OutgoingFileMessage</td>
<td>SSTableReader</td>
<td>StreamWriter</td>
<td>Output</td>
<td>serialize</td>
<td>writer.write(out)</td>
</tr>
<tr>
<td>IncomingFileMessage</td>
<td>SSTableWriter</td>
<td>StreamReader</td>
<td>Input</td>
<td>deserialize</td>
<td>reader.read(in)</td>
</tr>
</tbody>
</table>
<p>StreamSessionçš„receiveå°†IncomingFileMessageè½¬æ¢ä¸ºReceivedMessage:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(IncomingFileMessage message)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// send back file received message</span></span><br><span class="line">    handler.sendMessage(<span class="keyword">new</span> ReceivedMessage(message.header.cfId, message.header.sequenceNumber));</span><br><span class="line">    receivers.get(message.header.cfId).received(message.sstable);   <span class="comment">//è¿™é‡Œmessageé‡Œçš„sstableæ˜¯SSTableWriter.  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>receiversç›¸å…³çš„StreamReceiveTaskæ˜¯åœ¨prepareReceivingåˆ›å»ºå¹¶åŠ å…¥çš„(é€šè¿‡StreamSummary,å³PREPAREé™„å¸¦çš„Summaryä¿¡æ¯).<br>æ¥ä¸‹æ¥çš„æµç¨‹äº¤ç»™äº†StreamReceiveTask.receivedæ–¹æ³•, è€ŒReceivedMessageçš„å¤„ç†æ˜¯StreamTransferTask.completeå‘é€æ–¹çš„å·¥ä½œæ¥è¿‘å®Œæˆäº†.<br>æ¥æ”¶sstableæ–‡ä»¶çš„æ–¹å¼æ˜¯ç”¨SSTableWriterå…³é—­å¹¶æ‰“å¼€SSTableReader, åŠ å…¥åˆ°ColumnFamilyStoreä¸­,å¯èƒ½çš„è¯åˆ›å»ºäºŒçº§ç´¢å¼•.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Pair&lt;String, String&gt; kscf = Schema.instance.getCF(task.cfId);</span><br><span class="line">    ColumnFamilyStore cfs = Keyspace.open(kscf.left).getColumnFamilyStore(kscf.right);</span><br><span class="line"></span><br><span class="line">    List&lt;SSTableReader&gt; readers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (SSTableWriter writer : task.sstables)</span><br><span class="line">        readers.add(writer.closeAndOpenReader());</span><br><span class="line">    <span class="comment">// add sstables and build secondary indexes</span></span><br><span class="line">    cfs.addSSTables(readers);</span><br><span class="line">    cfs.indexManager.maybeBuildSecondaryIndexes(readers, cfs.indexManager.allIndexesNames());</span><br><span class="line"></span><br><span class="line">    task.session.taskCompleted(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-11-10-Cassandra-Client" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-11-10-Cassandra-Client/" class="article-date">
  	<time datetime="2015-12-01T10:02:43.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-11-10-Cassandra-Client/">Cassandra ClientæŸ¥è¯¢ä¼˜åŒ–</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="ä¸€æ¬¡æŸ¥è¯¢çš„æµç¨‹">ä¸€æ¬¡æŸ¥è¯¢çš„æµç¨‹</h2><p>é€šè¿‡Sessionæ‰§è¡ŒæŸ¥è¯¢ç­‰SQLè¯­å¥:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.<span class="function"><span class="title">execute</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>AbstractSessionä¼šå¼‚æ­¥åœ°æ‰§è¡Œ, ä½†æ˜¯è¿™ç§å¼‚æ­¥æ˜¯Uninterruptiblyä¸å¯ä¸­æ–­çš„:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractSession.<span class="function"><span class="title">execute</span><span class="params">(Statement)</span></span> : ResultSet</span><br><span class="line"><span class="function"><span class="title">executeAsync</span><span class="params">(statement)</span></span>.<span class="function"><span class="title">getUninterruptibly</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>æ ¹æ®Statementåˆ›å»ºMessage.Request, new Requests.Executeæˆ–è€…Query.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SessionManager: executeQuery(makeRequestMessage(statement, <span class="keyword">null</span>), statement)</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡ŒæŸ¥è¯¢: executeQuery(Message.Request msg, Statement statement)  </p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DefaultResultSetFuture future = new DefaultResultSetFuture(this, , msg)<span class="comment">;</span></span><br><span class="line">execute(future, statement)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>DefaultResultSetFutureç»“åˆäº†ResultSetè¿”å›ç»“æœé›†åˆå’ŒFutureåŠŸèƒ½, å¹¶å®ç°äº†RequestHandlerçš„Callbackå›è°ƒæ¥å£:  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultResultSetFuture</span> <span class="keyword">extends</span> <span class="title">AbstractFuture</span>&lt;<span class="title">ResultSet</span>&gt; <span class="keyword">implements</span> <span class="title">ResultSetFuture</span>, <span class="title">RequestHandler</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> RequestHandler <span class="keyword">handler</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(RequestHandler <span class="keyword">handler</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">handler</span> = <span class="keyword">handler</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>executeå‘é€è¯·æ±‚, ä¼ å…¥çš„callbackæ˜¯DefaultResultSetFuture:  </p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> RequestHandler(<span class="keyword">this</span>, <span class="keyword">callback</span>, statement).sendRequest();</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºçš„RequestHandlerä¼šå°†callbackæ³¨å†Œåˆ°è‡ªå·±: callback.register(this) è°ƒç”¨åˆ°DefaultResultSetFutureçš„registeræ–¹æ³•.<br>å³è®¾ç½®DefaultResultSetFutureçš„handlerä¸ºåˆšåˆšåˆ›å»ºçš„RequestHandler.<br>åœ¨RequestHandlerä¸­, è¿˜ä¼šè´Ÿè´£è°ƒç”¨callbackå³DefaultResultSetFutureçš„onSetæ–¹æ³•, ç”¨æ¥è®¾ç½®è¿”å›å€¼ç»“æœ.  </p>
<p>ä¸€ä¸ªè¯·æ±‚åŒ…å«äº†å¤šä¸ªæŸ¥è¯¢è®¡åˆ’, å¦‚æœæ‰§è¡Œå¤±è´¥, åˆ™å›è°ƒcallback.onException.  </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (queryPlan.hasNext() &amp;&amp; !isCanceled) &#123;</span><br><span class="line">        Host host = queryPlan.next();</span><br><span class="line">        <span class="keyword">if</span> (query(host))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢è®¡åˆ’å®é™…ä¸Šæ˜¯å½“å‰è¯·æ±‚ä¼šå°†è¯·æ±‚ä¾æ¬¡è½¬å‘åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š,æ‰€ä»¥æ˜¯ä¸ªIterator<host><br>å®¢æˆ·ç«¯è¿æ¥åˆ°Cassandra, Driveræä¾›äº†ä¸€ä¸ªè¿æ¥æ± . æŸ¥è¯¢æ—¶ä»è¿æ¥æ± é‡Œborrowä¸€ä¸ªè¿æ¥å¯¹è±¡, ç„¶ååœ¨è¿™ä¸ªConnectionä¸Šå‘èµ·è°ƒç”¨è¯·æ±‚:  </host></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">query</span><span class="params">(Host host)</span> </span>&#123;</span><br><span class="line">    currentPool = manager.pools.get(host);</span><br><span class="line">    PooledConnection connection = currentPool.borrowConnection(manager.configuration().getPoolingOptions().getPoolTimeoutMillis(), TimeUnit.MILLISECONDS)</span><br><span class="line">    connectionHandler = connection.write(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>writeä¼šè¿”å›ä¸€ä¸ªResponseHandler. å‘é€è¯»å–è¯·æ±‚, æ”¶åˆ°å“åº”è¯·æ±‚. RequestHandlerå’ŒResponseHandleræ˜¯ç›¸å¯¹åº”çš„.   </p>
<p>ç°åœ¨AbstractSession.executeAsyncè¯·æ±‚åŸºæœ¬å·²ç»å¤„ç†å®Œæˆ, å‰©ä¸‹çš„å°±æ˜¯è·å–æ•°æ®äº†.  </p>
<p>è·å–æ•°æ®getUninterruptibly,é€šè¿‡future.getè·å–. futureå¯¹è±¡å°±æ˜¯DefaultResultSetFuture.   </p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> future.<span class="keyword">get</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    interrupted = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰åœ¨è¢«ä¸­æ–­æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™, æ•°æ®è·å–çº¿ç¨‹æ‰ä¼šåœæ­¢. è¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜,å¦‚æœæœ‰æ•°æ®,ä½†æ˜¯æŸ¥è¯¢å¾ˆæ…¢,æ˜¯ä¸æ˜¯è¦ç­‰åˆ°è·å–å‡ºæ•°æ®æ‰è¿”å›.<br>é‚£ä¹ˆCassandraæœ¬èº«è®¾ç½®çš„read time outæ˜¯å¦ä¼šèµ·ä½œç”¨?</p>
<h2 id="å¼‚æ­¥+ä¸èƒ½ä¸­æ–­">å¼‚æ­¥+ä¸èƒ½ä¸­æ–­</h2><p>CassandraClientæŸ¥è¯¢: session.execute()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">execute</span><span class="params">(Statement statement)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executeAsync(statement).getUninterruptibly();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨: StatementåŒ…æ‹¬äº†insertå’Œselect. </p>
<p>executeAsyncæ˜¯å¼‚æ­¥æ‰§è¡Œçš„(AbstractSession):  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ResultSetFuture <span class="title">executeAsync</span><span class="params">(Statement statement)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executeQuery(makeRequestMessage(statement, <span class="keyword">null</span>), statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å´æ˜¯Uninterruptedä¸èƒ½ä¸­æ–­çš„: ç­‰å¾…ç»“æœè¿”å›æ˜¯ä¸èƒ½ä¸­æ–­çš„(DefaultResultSetFuture).   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Waits for the query to return and return its result.</span><br><span class="line"> *</span><br><span class="line"> * This method is usually more convenient than &#123;<span class="doctag">@link</span> #get&#125; because it:</span><br><span class="line"> * &lt;ul&gt;</span><br><span class="line"> *   &lt;li&gt;Waits for the result uninterruptibly, and so doesn't throw InterruptedException&#125;.</span><br><span class="line"> *   &lt;li&gt;Returns meaningful exceptions, instead of having to deal with ExecutionException.&lt;/li&gt;</span><br><span class="line"> * &lt;/ul&gt;</span><br><span class="line"> * As such, it is the preferred way to get the future result.  </span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@throws</span> NoHostAvailableException if no host in the cluster can be contacted successfully to execute this query.</span><br><span class="line"> * <span class="doctag">@throws</span> QueryExecutionException if the query triggered an execution</span><br><span class="line"> * exception, that is an exception thrown by Cassandra when it cannot execute</span><br><span class="line"> * the query with the requested consistency level successfully.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">getUninterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Uninterruptibles.getUninterruptibly(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> extractCauseFromExecutionException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Uninterruptedçš„å®ç°:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;V&gt; <span class="function">V <span class="title">getUninterruptibly</span><span class="params">(Future&lt;V&gt; future)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> future.get();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        interrupted = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">      Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§å¯¹äºFutureè€Œè¨€æ˜¯é€‚åˆçš„, è€ŒFutureçš„ç‰¹ç‚¹æ˜¯è¦ç­‰åˆ°æ‰§è¡Œå®Œæˆæ‰æœ‰è¿”å›å€¼. å¦‚æœFutureæ‰§è¡Œæ—¶é—´å¾ˆé•¿, å°±ä¼šå¯¼è‡´æŸ¥è¯¢Cassandraè¶…æ—¶.  </p>
<blockquote>
<p>ç–‘é—®: Cassandraä¸­è®¾ç½®çš„read time out=2sä¸ºä»€ä¹ˆæ²¡æœ‰èµ·ä½œç”¨?  å¯èƒ½æ˜¯driverå®¢æˆ·ç«¯æœ¬èº«å­˜åœ¨çš„é—®é¢˜. </p>
</blockquote>
<p>ç»“è®º: æ‰§è¡Œstatementè™½ç„¶ä½¿ç”¨executeAsyncå¼‚æ­¥æŸ¥è¯¢, ä½†æ˜¯è·å–è¿”å›å€¼æ˜¯ä¸èƒ½ä¸­æ–­çš„: åŒ…è£…ä¸ŠFutureç›´åˆ°è¿”å›ç»“æœ. </p>
<h2 id="å¸¦è¶…æ—¶çš„Future">å¸¦è¶…æ—¶çš„Future</h2><p>DefaultResultSetFutureè¿˜æä¾›äº†ä¸€ä¸ªå¸¦è¶…æ—¶çš„Future:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Waits for the provided time for the query to return and return its result if available.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">getUninterruptibly</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Uninterruptibles.getUninterruptibly(<span class="keyword">this</span>, timeout, unit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> extractCauseFromExecutionException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¶…æ—¶çš„æ§åˆ¶é€šè¿‡å°†æ—¶é—´ä¼ å…¥future, å¦‚æœåˆ°æ—¶é—´äº†è¿˜æ²¡æœ‰è¿”å›å€¼, åˆ™ä¸­æ–­:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;V&gt; <span class="function">V <span class="title">getUninterruptibly</span><span class="params">(Future&lt;V&gt; future, <span class="keyword">long</span> timeout,  TimeUnit unit)</span> <span class="keyword">throws</span> ExecutionException, TimeoutException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">long</span> remainingNanos = unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">long</span> end = System.nanoTime() + remainingNanos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Future treats negative timeouts just like zero.</span></span><br><span class="line">        <span class="keyword">return</span> future.get(remainingNanos, NANOSECONDS);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        interrupted = <span class="keyword">true</span>;</span><br><span class="line">        remainingNanos = end - System.nanoTime();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">      Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§è°ƒç”¨åº”è¯¥å¯ä»¥è§£å†³æ— æ³•ä¸­æ–­çš„é—®é¢˜.  ä½†æ˜¯AbstractSessionçš„æ–¹æ³•ä¸­æ²¡æœ‰æä¾›å¸¦è¶…æ—¶æ—¶é—´çš„executeæ–¹æ³•.<br>ä¸€ç§æ–¹å¼æ˜¯ä¿®æ”¹AbstractSessionæ·»åŠ å¯¹åº”çš„æ–¹æ³•. å¹¶åœ¨CassandraClientä¸­ä½¿ç”¨è¿™ç§å¸¦è¶…æ—¶çš„æ–¹å¼.<br>ä½†è¿™ç§æ–¹å¼éœ€è¦ä¿®æ”¹æºç , å¹¶æ‰“åŒ….  </p>
<h2 id="ç›´æ¥åœ¨CassandraClientæ§åˆ¶">ç›´æ¥åœ¨CassandraClientæ§åˆ¶</h2><p>DefaultResultSetFutureçš„cancelä¸Šè¯´æ˜äº†æ€ä¹ˆä½¿ç”¨Timeout:<br>ä½†æ˜¯è¿™ç§æ–¹å¼åªæ˜¯å–æ¶ˆå®¢æˆ·ç«¯æŸ¥è¯¢,å¹¶ä¸ä¼šå–æ¶ˆåœ¨CassandraæœåŠ¡ç«¯å·²ç»å¼€å§‹çš„è¯·æ±‚.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Attempts to cancel the execution of the request corresponding to this</span><br><span class="line"> * future. This attempt will fail if the request has already returned.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Please note that this only cancels the request driver side, but nothing</span><br><span class="line"> * is done to interrupt the execution of the request Cassandra side (and that even</span><br><span class="line"> * if &#123;<span class="doctag">@code</span> mayInterruptIfRunning&#125; is true) since  Cassandra does not</span><br><span class="line"> * support such interruption.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * This method can be used to ensure no more work is performed driver side</span><br><span class="line"> * (which, while it doesn't include stopping a request already submitted</span><br><span class="line"> * to a Cassandra node, may include not retrying another Cassandra host on</span><br><span class="line"> * failure/timeout) if the ResultSet is not going to be retried. Typically,</span><br><span class="line"> * the code to wait for a request result for a maximum of 1 second could</span><br><span class="line"> * look like:</span><br><span class="line"> * &lt;pre&gt;</span><br><span class="line"> *   ResultSetFuture future = session.executeAsync(...some query...);</span><br><span class="line"> *   try &#123;</span><br><span class="line"> *       ResultSet result = future.get(1, TimeUnit.SECONDS);</span><br><span class="line"> *       ... process result ...</span><br><span class="line"> *   &#125; catch (TimeoutException e) &#123;</span><br><span class="line"> *       future.cancel(true); // Ensure any resource used by this query driver</span><br><span class="line"> *                            // side is released immediately</span><br><span class="line"> *       ... handle timeout ...</span><br><span class="line"> *   &#125;</span><br><span class="line"> * &lt;pre&gt;</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> mayInterruptIfRunning the value of this parameter is currently</span><br><span class="line"> * ignored.</span><br><span class="line"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> false&#125; if the future could not be cancelled (it has already</span><br><span class="line"> * completed normally); &#123;<span class="doctag">@code</span> true&#125; otherwise.</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.cancel(mayInterruptIfRunning))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    handler.cancel();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥CassandraClientçš„æŸ¥è¯¢å¯ä»¥æ”¹é€ æˆ:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¸¦è¶…æ—¶çš„SQL</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">getResultSetTimeout</span><span class="params">(BoundStatement bstmt)</span> </span>&#123;</span><br><span class="line">    ResultSetFuture future = session.executeAsync(bstmt);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ResultSet result = future.get(<span class="number">500</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">        future.cancel(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Row&gt; <span class="title">getRowTimeout</span><span class="params">(BoundStatement bstmt)</span></span>&#123;</span><br><span class="line">    ResultSet resultSet = getResultSetTimeout(bstmt);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> == resultSet) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Row&gt; resultRows = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Iterator&lt;Row&gt; it = resultSet.iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        resultRows.add(it.next());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultRows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-26-drill-fragment-execute" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-26-drill-fragment-execute/" class="article-date">
  	<time datetime="2015-12-01T10:02:40.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-26-drill-fragment-execute/">Apache Drillæºç é˜…è¯»(6) execute</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="è®¾ç½®æ ¹èŠ‚ç‚¹Fragment">è®¾ç½®æ ¹èŠ‚ç‚¹Fragment</h2><p>åœ¨å‰é¢æ ¹æ®ç‰©ç†è®¡åˆ’ç”Ÿæˆçš„QueryWorkUnit, ä¼šç”¨äºè®¾ç½®æ ¹èŠ‚ç‚¹å’Œéæ ¹èŠ‚ç‚¹.<br>å¯¹äºæ ¹èŠ‚ç‚¹, å› ä¸ºç°åœ¨æ˜¯åœ¨Foremané‡Œ, æ‰€ä»¥æ˜¯è¿è¡Œåœ¨ForemanèŠ‚ç‚¹, ç›¸å¯¹æ¥è¯´å°±æ˜¯è¿è¡Œåœ¨æœ¬åœ°äº†.<br>å› ä¸ºRoot Fragmentéƒ½æ˜¯åœ¨ForemanèŠ‚ç‚¹æ‰§è¡Œçš„. </p>
<blockquote>
<p>RootFragmentä¸æ˜¯Major Fragment, æŒ‰ç…§å®˜æ–¹çš„æ–‡æ¡£Major Fragmentå¹¶ä¸ä¼šæ‰§è¡ŒçœŸæ­£çš„ä»»åŠ¡.<br>é‚£ä¹ˆMinor Fragmentå’ŒLeaf Fragmentåˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?  </p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up the root fragment (which will run locally), and submit it for execution.</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">setupRootFragment</span><span class="params">(<span class="keyword">final</span> PlanFragment rootFragment, <span class="keyword">final</span> FragmentRoot rootOperator)</span> <span class="keyword">throws</span> ExecutionSetupException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> FragmentContext rootContext = <span class="keyword">new</span> FragmentContext(drillbitContext, rootFragment, queryContext, initiatingClient, drillbitContext.getFunctionImplementationRegistry());</span><br><span class="line">  <span class="comment">//é¦–å…ˆå‡†å¤‡å¥½IncomingBuffer</span></span><br><span class="line">  <span class="keyword">final</span> IncomingBuffers buffers = <span class="keyword">new</span> IncomingBuffers(rootFragment, rootContext);</span><br><span class="line">  rootContext.setBuffers(buffers);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ¯ä¸ªFragmentéƒ½è¦åŠ å…¥åˆ°QueryManagerçš„ç›‘æ§ä¸­,å½“Fragmentçš„çŠ¶æ€å‘ç”Ÿæ›´æ–°,QMå¯ä»¥çŸ¥é“</span></span><br><span class="line">  queryManager.addFragmentStatusTracker(rootFragment, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Fragmentçš„Executor,æ˜¯çœŸæ­£è¿è¡ŒFragmentçš„çº¿ç¨‹</span></span><br><span class="line">  rootRunner = <span class="keyword">new</span> FragmentExecutor(rootContext, rootFragment, queryManager.newRootStatusHandler(rootContext, drillbitContext), rootOperator);</span><br><span class="line">  <span class="comment">//Fragmentçš„Manager,é™¤äº†çº¿ç¨‹,è¿˜æœ‰Buffer</span></span><br><span class="line">  <span class="keyword">final</span> RootFragmentManager fragmentManager = <span class="keyword">new</span> RootFragmentManager(rootFragment.getHandle(), buffers, rootRunner);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buffers.isDone()) &#123;</span><br><span class="line">    <span class="comment">// if we don't have to wait for any incoming data, start the fragment runner. ä¸éœ€è¦ç­‰å¾…æ¥æ”¶æ•°æ®,å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">    bee.addFragmentRunner(fragmentManager.getRunnable());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// if we do, record the fragment manager in the workBus. å¦‚æœéœ€è¦ç­‰å¾…,åˆ™æŠŠç®¡ç†Executorçš„Manageræ”¾åˆ°WorkBusä¸­</span></span><br><span class="line">    <span class="comment">// TODO aren't we managing our own work? What does this do? It looks like this will never get run</span></span><br><span class="line">    drillbitContext.getWorkBus().addFragmentManager(fragmentManager);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨FragmentExecutorçº¿ç¨‹çš„runæ–¹æ³•é‡Œä¼šåˆ›å»ºRootExec</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root = ImplCreator.getExec(fragmentContext, rootOperator)<span class="comment">;</span></span><br><span class="line">//<span class="built_in">Run</span> the query <span class="keyword">until</span> root.<span class="keyword">next</span> returns <span class="literal">false</span> <span class="literal">OR</span> we no longer need <span class="keyword">to</span> continue.</span><br><span class="line"><span class="keyword">while</span> (shouldContinue() &amp;&amp; root.<span class="keyword">next</span>()) &#123;</span><br><span class="line">  // loop</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±è¦æ¶‰åŠåˆ°Drillåº•å±‚è¯»å–æ•°æ®çš„æ•°æ®ç»“æ„äº†.  å¯¹äº†,å‰é¢çš„IncomingBuffersåˆ°åº•æ˜¯ç”¨æ¥å¹²å˜›çš„?  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-07-Spark-HA-YARN" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-07-Spark-HA-YARN/" class="article-date">
  	<time datetime="2015-12-01T10:02:20.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-07-Spark-HA-YARN/">Spark HAå’ŒYARNæ¨¡å¼</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="SparkStandalone-HA">SparkStandalone-HA</h2><p><a href="http://taoistwar.gitbooks.io/spark-operationand-maintenance-management/content/spark_install/spark_standalone_with_zookeeper_ha.html" target="_blank" rel="external">Spark StandaloneåŸºäºZooKeeperçš„HA</a></p>
<table>
<thead>
<tr>
<th>node</th>
<th>host</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>dp0652,dp0653</td>
</tr>
<tr>
<td>slaves</td>
<td>dp0655,dp0656,dp0657</td>
</tr>
</tbody>
</table>
<p>vi spark-env.sh</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> SPARK_MASTER_IP=dp0652</span><br><span class="line"><span class="keyword">export</span> SPARK_DAEMON_J<span class="built_in">AVA_OPTS</span>=<span class="string">"-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=dp0655:2181,dp0656:2181,dp0657:2181 -Dspark.deploy.zookeeper.dir=/spark"</span></span><br></pre></td></tr></table></figure>
<p>vi slaves</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">dp0655</span></span><br><span class="line">dp0656</span><br><span class="line">dp0657</span><br></pre></td></tr></table></figure>
<p>å°†é…ç½®æ–‡ä»¶åˆ†å‘åˆ°é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scp spark-env.sh dp0653:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp spark-env.sh dp0655:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp spark-env.sh dp0656:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp spark-env.sh dp0657:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp slaves dp0653:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp slaves dp0655:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp slaves dp0656:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br><span class="line">scp slaves dp0657:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br></pre></td></tr></table></figure>
<p>åœ¨dp0653ä¸Šä¿®æ”¹spark-env.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SPARK_MASTER_IP=dp0653</span><br></pre></td></tr></table></figure>
<p>åœ¨dp0652ä¸Šå¯åŠ¨é›†ç¾¤: <code>sbin/start-all.sh</code></p>
<p>åœ¨dp0653ä¸Šå¯åŠ¨Master: <code>sbin/start-master.sh</code></p>
<p>å¯ä»¥çœ‹åˆ°dp0652æ˜¯active, dp0653æ˜¯standby</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/sha1.png" alt=""></p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/sha2.png" alt=""></p>
<p>å…³é—­dp0652çš„master: <code>sbin/stop-master.sh</code></p>
<p>è§‚å¯Ÿdp0653æ˜¯å¦æˆä¸ºmaster:</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/sha3.png" alt=""></p>
<p>æ‰§è¡Œåº”ç”¨ç¨‹åº. æ³¨æ„â€“masterç°åœ¨æœ‰å¤šä¸ªäº†</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --master spark:<span class="comment">//dp0652:7077,dp0653:7077 \</span></span><br><span class="line">  --<span class="keyword">class</span> org.apache.spark.examples.SparkPi \</span><br><span class="line">  --executor-memory <span class="number">4</span>g --total-executor-cores <span class="number">2</span> \</span><br><span class="line">  lib/spark-examples-<span class="number">1.4</span><span class="number">.0</span>-hadoop2<span class="number">.6</span><span class="number">.0</span>.jar <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>dp0652çš„masteræ—¥å¿—:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">50</span> INFO Master: Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">58543</span> with <span class="number">1</span> cores, <span class="number">8.0</span> GB RAM</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">50</span> INFO Master: Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">37859</span> with <span class="number">1</span> cores, <span class="number">8.0</span> GB RAM</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">50</span> INFO Master: Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">34379</span> with <span class="number">1</span> cores, <span class="number">8.0</span> GB RAM</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">01</span> ERROR Master: RECEIVED SIGNAL <span class="number">15</span>: SIGTERM</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">01</span> INFO Utils: Shutdown hook called</span><br></pre></td></tr></table></figure>
<p>dp0653çš„masteræ—¥å¿—:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">03</span> INFO ConnectionStateManager: State change: CONNECTED</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">35</span> INFO ZooKeeperLeaderElectionAgent: We have gained leadership</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: I have been elected leader! New state: RECOVERING</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Trying to recover worker: worker-<span class="number">20150707144149</span>-<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>-<span class="number">37859</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Trying to recover worker: worker-<span class="number">20150707144149</span>-<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>-<span class="number">58543</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Trying to recover worker: worker-<span class="number">20150707144149</span>-<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>-<span class="number">34379</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Worker has been re-registered: worker-<span class="number">20150707144149</span>-<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>-<span class="number">58543</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Worker has been re-registered: worker-<span class="number">20150707144149</span>-<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>-<span class="number">37859</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Worker has been re-registered: worker-<span class="number">20150707144149</span>-<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>-<span class="number">34379</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">14</span>:<span class="number">45</span>:<span class="number">36</span> INFO Master: Recovery complete - resuming operations!</span><br></pre></td></tr></table></figure>
<h2 id="SparkHA-Streamming">SparkHA-Streamming</h2><p>å¦‚æœçº¿ä¸Šçš„SparkStreammingç¨‹åºä¸€ç›´åœ¨è¿è¡Œ, è€ŒMasterå‘ç”Ÿäº†åˆ‡æ¢, éªŒè¯ä¸‹SparkStreammingè¿˜èƒ½ä¸èƒ½æ­£å¸¸è¿è¡Œ.<br>è¿™ä¸ªå®éªŒçš„åŸºç¡€æ˜¯åœ¨Spark-Streammingè¿™ä¸€èŠ‚çš„åŸºç¡€ä¸Š.  </p>
<p>è¿˜æ˜¯å…ˆå¯åŠ¨KafkaProducer[åœ¨52ä¸Š]</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>]$ bin/spark-submit --<span class="keyword">class</span> org.apache.spark.examples.streaming.KafkaWordCountProducer /home/qihuang.zheng/spark-intro-<span class="number">1.0</span>-SNAPSHOT-jar-with-dependencies.jar <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">9092</span> kafka-spark-test <span class="number">2000</span> <span class="number">70</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åå¯åŠ¨Spark-Streammingç¨‹åº[ä¹Ÿåœ¨52ä¸Š], æ³¨æ„â€“masterçš„å€¼  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-1.4.0-bin-hadoop2.6]$ bin/spark-submit --master spark://dp<span class="number">0652:7077</span>,dp<span class="number">0653:7077</span> --class org.apache.spark.examples.streaming.KafkaWordCount --jars /home/qihuang.zheng/spark-streaming-kafka_<span class="number">2.10-1.4</span>.0.jar /home/qihuang.zheng/spark-intro-1.0-SNAPSHOT-jar-with-dependencies.jar <span class="number">192.168.6.55</span>:<span class="number">2181,192.168</span>.<span class="number">6.56:2181</span>,<span class="number">192.168.6.57</span>:2181 my-consumer-group kafka-spark-test 5</span><br></pre></td></tr></table></figure>
<p>å½“å‰çš„masteræ˜¯53,æˆ‘ä»¬æŠŠ53çš„åœæ‰: <code>sbin/stop-master.sh</code></p>
<p>å¯ä»¥å‘ç°Spark-Streammingçš„ç¨‹åºå¹¶æ²¡æœ‰å—åˆ°å½±å“.  ä¹Ÿå°±æ˜¯è¯´masterçš„å˜åŒ–å¹¶ä¸ä¼šå½±å“driverç¨‹åº.<br><strong>åªè¦ä½ çš„driveræŒ‡å®šâ€“masterä¸ºHA,è€Œä¸æ˜¯å•ç‚¹!</strong>  </p>
<blockquote>
<p>å¦‚æœDriverç¨‹åºæ¯”å¦‚spark-streammingç¨‹åºæŒ‚æ‰äº†æ€ä¹ˆåŠ(æ¯”å¦‚è¦å‡çº§åº”ç”¨ç¨‹åº),é‚£ä¹ˆå†èµ·ä¸€ä¸ªstreammingç¨‹åº,è¿™ä¸ªç¨‹åºä¼šä¸€ç›´è¢«é˜»å¡ä½<br>ç›´åˆ°æ—§çš„ç¨‹åºå…³æ‰äº†, æ–°çš„streammingç¨‹åºå°±ä¼šç«‹é©¬æ¥ç®¡è¿‡æ¥.  è¿™åœ¨<a href="http://zqhxuyuan.github.io/2015/06/28/Spark-Streamming/" target="_blank" rel="external">http://zqhxuyuan.github.io/2015/06/28/Spark-Streamming/</a>ä¸­å·²ç»åšè¿‡äº†  </p>
</blockquote>
<p>æ³¨æ„: ä¸ç®¡æ˜¯dp0652è¿˜æ˜¯dp0653,éƒ½æ— æ³•çœ‹åˆ°æ­£åœ¨è¿è¡Œä¸­çš„SparkStreammingç¨‹åº.<br>SparkStreammingç¨‹åºç±»ä¼¼äºDriver, ä½ åœ¨é‚£å°æœºå™¨æ‰§è¡Œ,å°±å†è¿™å°æœºå™¨çš„4040ç«¯å£æŸ¥çœ‹.<br>æ¯”å¦‚ä¸Šé¢çš„å®éªŒ,æˆ‘ä»¬åœ¨dp0652ä¸Šè¿è¡Œäº†Spark-Streammingç¨‹åº, æ‰€ä»¥åœ¨<a href="http://192.168.6.52:4040/streaming/" target="_blank" rel="external">http://192.168.6.52:4040/streaming/</a>æŸ¥çœ‹StreamingUI<br>è‡³äºMasterçš„8082ç«¯å£,åˆ™åªæœ‰ä¸»masteræ‰å¯ä»¥çœ‹åˆ°worker, ä½†æ˜¯éƒ½çœ‹ä¸åˆ°Running Applications</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark9.png" alt="spark-master"></p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark10.png" alt="spark-stream"></p>
<h2 id="Spark_on_YARN">Spark on YARN</h2><p>[qihuang.zheng@dp0652 lib]$ /usr/install/hadoop/bin/hadoop fs -mkdir /lib<br>[qihuang.zheng@dp0652 lib]$ /usr/install/hadoop/bin/hadoop fs -put spark-assembly-1.4.0-hadoop2.6.0.jar /lib</p>
<h3 id="YARN_Cluster">YARN Cluster</h3><p>å…¶å®åœ¨æŒ‰ç…§å¥½Hadoopå,Spark on YARNä¸éœ€è¦ä»»ä½•é…ç½®,åªä¸è¿‡spark-submitçš„æ—¶å€™â€“masterå‘ç”Ÿäº†å˜åŒ–</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SPARK_JAR=hdfs://tdhdfs/lib/spark-assembly-1.4.0-hadoop2.6.0.jar \</span><br><span class="line">./bin/spark-submit --class org.apache.spark.examples.SparkPi \</span><br><span class="line">    -<span class="ruby">-master yarn-cluster \</span><br><span class="line"></span>    -<span class="ruby">-num-executors <span class="number">3</span> \</span><br><span class="line"></span>    -<span class="ruby">-driver-memory <span class="number">4</span>g \</span><br><span class="line"></span>    -<span class="ruby">-executor-memory <span class="number">2</span>g \</span><br><span class="line"></span>    -<span class="ruby">-executor-cores <span class="number">1</span> \</span><br><span class="line"></span>    lib/spark-examples*.jar \</span><br><span class="line">    10</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„: å› ä¸ºç°åœ¨æ˜¯Spark on YARNäº†,æ‰€ä»¥spark-submitçš„Jobä¸ä¼šæ˜¾ç¤ºåœ¨Sparkçš„UIä¸Š,è€Œæ˜¯HadoopYARNçš„UIä¸Š<br>è€Œä¸”, å› ä¸ºæ˜¯yarn-clusteræ¨¡å¼, ç»ˆç«¯å¹¶ä¸ä¼šè¾“å‡ºPiçš„å€¼! ç›¸å,ä¸‹é¢yarn-clientæ¨¡å¼ä¼šåœ¨ç»ˆç«¯è¾“å‡ºPiçš„å€¼.</p>
<h3 id="YARN_Clientæ¨¡å¼">YARN Clientæ¨¡å¼</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">SPARK_JAR</span>=<span class="symbol">hdfs:</span>/<span class="regexp">/tdhdfs/lib</span><span class="regexp">/spark-assembly-1.4.0-hadoop2.6.0.jar \</span><br><span class="line">bin/spark</span>-submit --<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">examples</span>.<span class="title">SparkPi</span> \</span></span><br><span class="line">    --master yarn-client \</span><br><span class="line">    --num-executors <span class="number">3</span> \</span><br><span class="line">    --driver-memory <span class="number">4</span>g \</span><br><span class="line">    --executor-memory <span class="number">2</span>g \</span><br><span class="line">    --executor-cores <span class="number">1</span> \</span><br><span class="line">    <span class="class"><span class="keyword">lib</span>/<span class="title">spark</span>-<span class="title">examples</span>-1.4.0-<span class="title">hadoop2</span>.6.0.<span class="title">jar</span> \</span></span><br><span class="line">    <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>yarn-clientçš„æ—¥å¿—è¾“å‡º: clientæ¨¡å¼ä¹Ÿå¯ä»¥åœ¨sparkuiä¸ŠæŸ¥çœ‹ä½œä¸š<br>å®é™…ä¸Š, è™½ç„¶4040èƒ½è®¿é—®, ä½†æ˜¯å¹¶ä¸ä¼šåœ¨8082(é»˜è®¤8081)ä¸Šçœ‹åˆ°è¿™ä¸ªä½œä¸š.  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">07</span> INFO <span class="string">SparkUI:</span> Started SparkUI at <span class="string">http:</span><span class="comment">//192.168.6.52:4040</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">07</span> INFO <span class="string">SparkContext:</span> Added JAR <span class="string">file:</span><span class="regexp">/usr/</span>install<span class="regexp">/spark-1.4.0-bin-hadoop2.6/</span>lib<span class="regexp">/spark-examples-1.4.0-hadoop2.6.0.jar at http:/</span><span class="regexp">/192.168.6.52:42366/</span>jars/spark-examples-<span class="number">1.4</span><span class="number">.0</span>-hadoop2<span class="number">.6</span><span class="number">.0</span>.jar with timestamp <span class="number">1436254447750</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">ConfiguredRMFailoverProxyProvider:</span> Failing over to rm2</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">Client:</span> Requesting a <span class="keyword">new</span> application from cluster with <span class="number">2</span> NodeManagers</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">Client:</span> Verifying our application has not requested more than the maximum memory capability of the cluster (<span class="number">8192</span> MB per container)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">Client:</span> Will allocate AM container, with <span class="number">896</span> MB memory including <span class="number">384</span> MB overhead</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">Client:</span> Setting up container launch context <span class="keyword">for</span> our AM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">Client:</span> Preparing resources <span class="keyword">for</span> our AM container</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> WARN <span class="string">Client:</span> SPARK_JAR detected <span class="keyword">in</span> the system environment. This variable has been deprecated <span class="keyword">in</span> favor of the spark.yarn.jar configuration variable.</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">08</span> INFO <span class="string">Client:</span> Source and destination file systems are the same. Not copying <span class="string">hdfs:</span><span class="comment">//tdhdfs/lib/spark-assembly-1.4.0-hadoop2.6.0.jar</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">09</span> INFO <span class="string">Client:</span> Uploading resource <span class="string">file:</span><span class="regexp">/tmp/</span>spark-c564fff3-dd94-<span class="number">4</span>b52-<span class="number">81</span>c9-<span class="number">6e6</span>f7e4d4ceb<span class="regexp">/__hadoop_conf__2813971044505707826.zip -&gt; hdfs:/</span><span class="regexp">/tdhdfs/</span>user<span class="regexp">/qihuang.zheng/</span>.sparkStaging<span class="regexp">/application_1436175086022_0003/</span>__hadoop_conf__2813971044505707826.zip</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">09</span> INFO <span class="string">Client:</span> Setting up the launch environment <span class="keyword">for</span> our AM container</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">09</span> WARN <span class="string">Client:</span> SPARK_JAR detected <span class="keyword">in</span> the system environment. This variable has been deprecated <span class="keyword">in</span> favor of the spark.yarn.jar configuration variable.</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">09</span> INFO <span class="string">Client:</span> Submitting application <span class="number">3</span> to ResourceManager</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">09</span> INFO <span class="string">YarnClientImpl:</span> Submitted application application_1436175086022_0003</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">10</span> INFO <span class="string">Client:</span> Application report <span class="keyword">for</span> application_1436175086022_0003 (<span class="string">state:</span> ACCEPTED)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">11</span> INFO <span class="string">Client:</span> Application report <span class="keyword">for</span> application_1436175086022_0003 (<span class="string">state:</span> ACCEPTED)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">38</span> INFO <span class="string">SparkContext:</span> Starting <span class="string">job:</span> reduce at SparkPi.<span class="string">scala:</span><span class="number">35</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">38</span> INFO <span class="string">SparkContext:</span> Created broadcast <span class="number">0</span> from broadcast at DAGScheduler.<span class="string">scala:</span><span class="number">874</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">38</span> INFO <span class="string">DAGScheduler:</span> Submitting <span class="number">10</span> missing tasks from ResultStage <span class="number">0</span> (MapPartitionsRDD[<span class="number">1</span>] at map at SparkPi.<span class="string">scala:</span><span class="number">31</span>)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">38</span> INFO <span class="string">YarnScheduler:</span> Adding task set <span class="number">0.0</span> with <span class="number">10</span> tasks</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">38</span> INFO <span class="string">TaskSetManager:</span> Starting task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">0</span>, dp0653, PROCESS_LOCAL, <span class="number">1446</span> bytes)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">38</span> INFO <span class="string">TaskSetManager:</span> Starting task <span class="number">1.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">1</span>, dp0652, PROCESS_LOCAL, <span class="number">1446</span> bytes)</span><br><span class="line">...</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">48</span> INFO <span class="string">BlockManagerInfo:</span> Added broadcast_0_piece0 <span class="keyword">in</span> memory on <span class="string">dp0653:</span><span class="number">43216</span> (<span class="string">size:</span> <span class="number">1202.0</span> B, <span class="string">free:</span> <span class="number">1060.3</span> MB)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">49</span> INFO <span class="string">TaskSetManager:</span> Finished task <span class="number">0.0</span> <span class="keyword">in</span> stage <span class="number">0.0</span> (TID <span class="number">0</span>) <span class="keyword">in</span> <span class="number">10414</span> ms on dp0653 (<span class="number">10</span>/<span class="number">10</span>)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">49</span> INFO <span class="string">DAGScheduler:</span> ResultStage <span class="number">0</span> (reduce at SparkPi.<span class="string">scala:</span><span class="number">35</span>) finished <span class="keyword">in</span> <span class="number">10.420</span> s</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">49</span> INFO <span class="string">YarnScheduler:</span> Removed TaskSet <span class="number">0.0</span>, whose tasks have all completed, from pool</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">07</span> <span class="number">15</span>:<span class="number">34</span>:<span class="number">49</span> INFO <span class="string">DAGScheduler:</span> Job <span class="number">0</span> <span class="string">finished:</span> reduce at SparkPi.<span class="string">scala:</span><span class="number">35</span>, took <span class="number">10.776165</span> s</span><br><span class="line">Pi is roughly <span class="number">3.144008</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾æ˜¯YARNçš„åº”ç”¨ç¨‹åº, ç¬¬ä¸€ä¸ªæ˜¯yarn-client, ç¬¬äºŒä¸ªæ˜¯yarn-cluster</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/syarn1.png" alt=""></p>
<h3 id="YARNå®¢æˆ·ç«¯å’Œé›†ç¾¤æ¨¡å¼æ¯”è¾ƒ">YARNå®¢æˆ·ç«¯å’Œé›†ç¾¤æ¨¡å¼æ¯”è¾ƒ</h3><p>å…³äºä¸ºä»€ä¹ˆyarn-clientèƒ½çœ‹åˆ°ç»“æœ,è€Œyarn-clusteræ— æ³•çœ‹åˆ°ç»“æœ,å¯ä»¥å‚è€ƒ:<br><a href="http://blog.csdn.net/book_mmicky/article/details/25714287" target="_blank" rel="external">http://blog.csdn.net/book_mmicky/article/details/25714287</a></p>
<blockquote>
<p>åœ¨YARNä¸Šéƒ¨ç½²Sparkåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œä¸éœ€è¦è±¡Standaloneã€Mesosä¸€æ ·æä¾›URLä½œä¸ºmasterå‚æ•°çš„å€¼ï¼Œ<br>å› ä¸ºSparkåº”ç”¨ç¨‹åºå¯ä»¥åœ¨hadoopçš„é…ç½®æ–‡ä»¶é‡Œé¢è·å–ç›¸å…³çš„ä¿¡æ¯ï¼Œ<br>æ‰€ä»¥åªéœ€è¦ç®€å•ä»¥yarn-clusteræˆ–yarn-clientæŒ‡å®šç»™masterå°±å¯ä»¥äº†  </p>
<p>YARN Client:  Spark driveråœ¨å®¢æˆ·æœºä¸Šè¿è¡Œï¼Œç„¶åå‘YARNç”³è¯·è¿è¡Œexeutorä»¥è¿è¡ŒTask<br>YARN Cluster: Spark driverå°†ä½œä¸ºä¸€ä¸ªApplicationMasteråœ¨YARNé›†ç¾¤ä¸­å…ˆå¯åŠ¨ï¼Œ<br>              ç„¶åå†ç”±ApplicationMasterå‘RMç”³è¯·èµ„æºå¯åŠ¨executorä»¥è¿è¡ŒTask</p>
<p>é‡‡ç”¨yarn-clientæ–¹å¼ï¼Œå› ä¸ºdriveråœ¨å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥ç¨‹åºçš„è¿è¡Œç»“æœå¯ä»¥åœ¨å®¢æˆ·ç«¯æ˜¾ç¤º<br>é‡‡ç”¨yarn-clusteræ–¹å¼ï¼Œå› ä¸ºdriveråœ¨YARNä¸­è¿è¡Œï¼Œæ‰€ä»¥ç¨‹åºçš„è¿è¡Œç»“æœä¸èƒ½åœ¨å®¢æˆ·ç«¯æ˜¾ç¤ºï¼Œ<br>   æ‰€ä»¥æœ€å¥½å°†ç»“æœä¿å­˜åœ¨hdfsä¸Šï¼Œå®¢æˆ·ç«¯çš„ç»ˆç«¯æ˜¾ç¤ºçš„æ˜¯ä½œä¸ºYARNçš„jobçš„è¿è¡Œæƒ…å†µ</p>
</blockquote>
<h2 id="å…¶ä»–å‚è€ƒæ–‡æ¡£">å…¶ä»–å‚è€ƒæ–‡æ¡£</h2><p><a href="http://www.cnblogs.com/byrhuangqiang/p/3937654.html" target="_blank" rel="external">Spark:Master High Availabilityï¼ˆHAï¼‰é«˜å¯ç”¨é…ç½®çš„2ç§å®ç°</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/">spark</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-06-Spark-Streamming" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-06-Spark-Streamming/" class="article-date">
  	<time datetime="2015-12-01T10:02:17.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-06-Spark-Streamming/">Spark-Strammingå…¥é—¨</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="NetworkWordCount">NetworkWordCount</h2><p>1.æœ¬æœºè¿è¡Œæ—¶,ä¿®æ”¹spark-env.sh(è¿™ä¸€æ­¥ä¸æ˜¯å¿…é¡»çš„)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1<span class="number">.7</span><span class="number">.0</span>_79.jdk/Contents/Home</span><br><span class="line"><span class="keyword">export</span> SCALA_HOME=/Users/zhengqh/Soft/scala-<span class="number">2.10</span><span class="number">.5</span></span><br><span class="line"><span class="keyword">export</span> HADOOP_HOME=/Users/zhengqh/Soft/cdh542/hadoop-<span class="number">2.6</span><span class="number">.0</span>-cdh5<span class="number">.4</span><span class="number">.2</span></span><br><span class="line"><span class="keyword">export</span> HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop</span><br><span class="line"><span class="keyword">export</span> SPARK_MASTER_IP=localhost</span><br><span class="line"><span class="preprocessor">#export MASTER=spark:<span class="comment">//localhost:7077</span></span></span><br><span class="line"><span class="keyword">export</span> SPARK_LOCAL_IP=localhost</span><br></pre></td></tr></table></figure>
<p>2.å¼€å¯netcatæ•°æ®æœåŠ¡å™¨</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  nc -lk <span class="number">9999</span></span><br><span class="line">hello world hello spark hello spark hello world</span><br></pre></td></tr></table></figure>
<p>3.è¿è¡Œspark-streammingç¤ºä¾‹,å½“åœ¨ncç»ˆç«¯è¾“å…¥textæ—¶,spark-streammingä¼šå®æ—¶ç»Ÿè®¡è¿‡å»ä¸€ç§’çš„wordcount</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">âœ  spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>  bin/run-example org.apache.spark.examples.streaming.NetworkWordCount localhost <span class="number">9999</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">36</span> INFO dstream.SocketReceiver: Connected to localhost:<span class="number">9999</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">37</span> INFO scheduler.ReceiverTracker: Registered receiver <span class="keyword">for</span> stream <span class="number">0</span> from <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">50018</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">37</span> INFO scheduler.JobScheduler: Added jobs <span class="keyword">for</span> time <span class="number">1436143117000</span> ms</span><br><span class="line">...</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">37</span> INFO scheduler.DAGScheduler: Job <span class="number">2</span> finished: print at NetworkWordCount.scala:<span class="number">55</span>, took <span class="number">0.066998</span> s</span><br><span class="line">-------------------------------------------</span><br><span class="line">Time: <span class="number">1436143116000</span> ms</span><br><span class="line">-------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">37</span> INFO scheduler.JobScheduler: Finished job streaming job <span class="number">1436143116000</span> ms<span class="number">.0</span> from job <span class="built_in">set</span> of time <span class="number">1436143116000</span> ms</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">37</span> INFO scheduler.JobScheduler: Total delay: <span class="number">1.204</span> s <span class="keyword">for</span> time <span class="number">1436143116000</span> ms (execution: <span class="number">1.118</span> s)</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">40</span> INFO scheduler.DAGScheduler: Job <span class="number">10</span> finished: print at NetworkWordCount.scala:<span class="number">55</span>, took <span class="number">0.048230</span> s</span><br><span class="line">-------------------------------------------</span><br><span class="line">Time: <span class="number">1436143120000</span> ms</span><br><span class="line">-------------------------------------------</span><br><span class="line">(spark,<span class="number">2</span>)</span><br><span class="line">(hello,<span class="number">4</span>)</span><br><span class="line">(world,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">40</span> INFO scheduler.JobScheduler: Finished job streaming job <span class="number">1436143120000</span> ms<span class="number">.0</span> from job <span class="built_in">set</span> of time <span class="number">1436143120000</span> ms</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">40</span> INFO rdd.ShuffledRDD: Removing RDD <span class="number">16</span> from persistence <span class="built_in">list</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">40</span> INFO scheduler.JobScheduler: Total delay: <span class="number">0.356</span> s <span class="keyword">for</span> time <span class="number">1436143120000</span> ms (execution: <span class="number">0.335</span> s)</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">40</span> INFO rdd.MapPartitionsRDD: Removing RDD <span class="number">15</span> from persistence <span class="built_in">list</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">06</span> <span class="number">08</span>:<span class="number">38</span>:<span class="number">40</span> INFO storage.BlockManager: Removing RDD <span class="number">16</span></span><br></pre></td></tr></table></figure>
<p>4.åœ¨<localhost:4040 streaming="">å¯ä»¥è§‚å¯Ÿstreamingçš„ç»Ÿè®¡ä¿¡æ¯, å…¶ä¸­åœ¨InputRateå‘ä¸Šå‡¸å‡ºçš„æ˜¯äº§ç”Ÿæ•°æ®çš„é€Ÿåº¦  </localhost:4040></p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss1.png" alt=""></p>
<p>5.IDEAæœ¬åœ°è¿è¡Œ</p>
<p>ç»™SparkConfæ·»åŠ .setMaster(), åœ¨<code>Program Arguments</code>ä¸­æ·»åŠ <code>localhost 9999 local[2]</code>, ç„¶åè¿è¡Œ</p>
<p>å¦åˆ™ä¼šæŠ¥é”™:<code>org.apache.spark.SparkException: A master URL must be set in your configuration</code>  </p>
<p>example-code: spark-streammingå®æ—¶è¯»å–sockeræµ,ç»Ÿè®¡è¿‡å»5ç§’çš„wordcount</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the context with a 1 second batch size</span></span><br><span class="line">val sparkConf = new <span class="function"><span class="title">SparkConf</span><span class="params">()</span></span>.<span class="function"><span class="title">setAppName</span><span class="params">(<span class="string">"NetworkWordCount"</span>)</span></span>.<span class="function"><span class="title">setMaster</span><span class="params">(args(<span class="number">2</span>)</span></span>)</span><br><span class="line">val ssc = new <span class="function"><span class="title">StreamingContext</span><span class="params">(sparkConf, Seconds(<span class="number">5</span>)</span></span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a socket stream on target ip:port and count the</span></span><br><span class="line"><span class="comment">// words in input stream of \n delimited text (eg. generated by 'nc')</span></span><br><span class="line"><span class="comment">// Note that no duplication in storage level only for running locally.</span></span><br><span class="line"><span class="comment">// Replication necessary in distributed scenario for fault tolerance.</span></span><br><span class="line">val lines = ssc.<span class="function"><span class="title">socketTextStream</span><span class="params">(args(<span class="number">0</span>)</span></span>, <span class="function"><span class="title">args</span><span class="params">(<span class="number">1</span>)</span></span><span class="class">.toInt</span>, StorageLevel.MEMORY_AND_DISK_SER)</span><br><span class="line">val words = lines.<span class="function"><span class="title">flatMap</span><span class="params">(_.split(<span class="string">" "</span>)</span></span>)</span><br><span class="line">val wordCounts = words.<span class="function"><span class="title">map</span><span class="params">(x =&gt; (x, <span class="number">1</span>)</span></span>).<span class="function"><span class="title">reduceByKey</span><span class="params">(_ + _)</span></span></span><br><span class="line">wordCounts.<span class="function"><span class="title">print</span><span class="params">()</span></span></span><br><span class="line">ssc.<span class="function"><span class="title">start</span><span class="params">()</span></span></span><br><span class="line">ssc.<span class="function"><span class="title">awaitTermination</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>6.æ‰“åŒ…æœ¬åœ°è¿è¡Œ</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ  spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>  bin/spark-submit --class com<span class="class">.tongdun</span><span class="class">.bigdata</span><span class="class">.spark</span><span class="class">.intro</span><span class="class">.NetworkWordCount</span> --jars /Users/zhengqh/IdeaProjects/bigdata/out/artifacts/spark_intro/spark-intro<span class="class">.jar</span> /Users/zhengqh/IdeaProjects/bigdata/out/artifacts/spark_intro/spark-intro<span class="class">.jar</span> localhost <span class="number">9999</span> <span class="string">"local[2]"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS: â€“jars xx.jarå¯ä»¥çœç•¥</p>
</blockquote>
<p>7.æ‰“åŒ…é›†ç¾¤è¿è¡Œ. ç¨‹åºçš„æœ€åä¸€ä¸ªå‚æ•°å¯ä»¥æŒ‡å®šä¸ºlocal[2]æˆ–è€…spark://dp0652:7077</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>  bin/spark-submit --class com<span class="class">.tongdun</span><span class="class">.bigdata</span><span class="class">.spark</span><span class="class">.intro</span><span class="class">.NetworkWordCount</span> /home/qihuang.zheng/spark-intro<span class="class">.jar</span> localhost <span class="number">9999</span> <span class="string">"local[2]"</span></span><br><span class="line"></span><br><span class="line">âœ  spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>  bin/spark-submit --class com<span class="class">.tongdun</span><span class="class">.bigdata</span><span class="class">.spark</span><span class="class">.intro</span><span class="class">.NetworkWordCount</span> /home/qihuang.zheng/spark-intro<span class="class">.jar</span> localhost <span class="number">9999</span> spark:<span class="comment">//dp0652:7077</span></span><br></pre></td></tr></table></figure>
<p>8.ä¸€èˆ¬åœ¨é›†ç¾¤ä¸­è¿è¡Œ,æˆ‘ä»¬ä½¿ç”¨â€“masterè€Œä¸æ˜¯åœ¨ä»£ç ä¸­è®¾ç½®setMaster(),æ‰€ä»¥æŠŠä»£ç ä¸­çš„setMasterå»æ‰é‡æ–°æ‰“åŒ…</p>
<p>å…ˆåœ¨æœ¬åœ°å®éªŒ, ğŸ‘Œ ğŸ‘‰ ä¸æŒ‡å®šâ€“masterå¯ä»¥æˆåŠŸè¿è¡Œ</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --class com<span class="class">.tongdun</span><span class="class">.bigdata</span><span class="class">.spark</span><span class="class">.intro</span><span class="class">.NetworkWordCount</span> /Users/zhengqh/spark-intro<span class="class">.jar</span> localhost <span class="number">9999</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åé›†ç¾¤å®éªŒ, ğŸ‘Œ ğŸ‘‰ æŒ‡å®šâ€“masteræˆ–ä¸æŒ‡å®šéƒ½å¯ä»¥æˆåŠŸè¿è¡Œ</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --class com<span class="class">.tongdun</span><span class="class">.bigdata</span><span class="class">.spark</span><span class="class">.intro</span><span class="class">.NetworkWordCount</span> /home/qihuang.zheng/spark-intro<span class="class">.jar</span> <span class="number">192.168</span>.<span class="number">6.52</span> <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">bin/spark-submit --master spark:<span class="comment">//dp0652:7077 --class com.tongdun.bigdata.spark.intro.NetworkWordCount /home/qihuang.zheng/spark-intro.jar 192.168.6.52 9999</span></span><br></pre></td></tr></table></figure>
<p><strong>å…³äºæœ¬åœ°å’Œé›†ç¾¤çš„è¿è¡Œæ–¹å¼</strong></p>
<p>ä¸‹é¢æ˜¯åœ¨æœ¬åœ°å’Œé›†ç¾¤ä¸­è¿è¡ŒNetworkWordCountå‡ ç§æ–¹å¼çš„ç»“æœ, âœ…è¡¨ç¤ºèƒ½æ­£å¸¸ç»Ÿè®¡,ğŸ™…è¡¨ç¤ºæ²¡æ˜¾ç¤ºç»“æœ.</p>
<p>localhost(æ²¡æœ‰æ›´æ”¹spark-env.sh)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ… bin/run-example org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">ğŸ™… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master <span class="string">"local[2]"</span> --jars lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">ğŸ™… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master local\[<span class="number">2</span>\] --jars lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">âœ… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master <span class="string">"local[*]"</span> --jars lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> localhost <span class="number">9999</span></span><br></pre></td></tr></table></figure>
<p>cluster:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ğŸ™… bin/run-example org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">âœ… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master <span class="string">"local[2]"</span>  lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">âœ… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master local\[<span class="number">2</span>\] lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">âœ… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master <span class="string">"local[*]"</span> lib/spark-examples-<span class="number">1.4</span>.<span class="number">0</span>-hadoop2.<span class="number">6.0</span><span class="class">.jar</span> localhost <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">ğŸ™… bin/spark-submit --class org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.NetworkWordCount</span> --master spark:<span class="comment">//dp0652:7077 lib/spark-examples-1.4.0-hadoop2.6.0.jar localhost 9999</span></span><br></pre></td></tr></table></figure>
<h2 id="Kafka-SparkStreamming">Kafka-SparkStreamming</h2><p>å¦‚æœæ˜¯æœ¬åœ°IDEAè¿è¡Œ, åˆ†åˆ«å¯åŠ¨zookeeper,kafka,ç„¶åè¿è¡ŒKafkaWordCountProducer,KafkaWordCount.<br>ä¸‹é¢æ˜¯åœ¨é›†ç¾¤ä¸­çš„è¿è¡Œæ­¥éª¤:  </p>
<p>1.é¦–å…ˆåœ¨kafkaä¸­åˆ›å»ºä¸€ä¸ªtopic:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0656 kafka]$ bin/kafka-topics.sh --zookeeper localhost:<span class="number">2181</span> --create --topic kafka-spark-test --replication-factor <span class="number">2</span> --partitions <span class="number">2</span></span><br><span class="line">Created topic <span class="string">"kafka-spark-test"</span>.</span><br><span class="line">[qihuang.zheng@dp0656 kafka]$ bin/kafka-topics.sh --zookeeper localhost:<span class="number">2181</span> --<span class="built_in">list</span></span><br><span class="line">kafka-spark-test</span><br><span class="line">[qihuang.zheng@dp0656 kafka]$ bin/kafka-topics.sh --zookeeper localhost:<span class="number">2181</span> --describe kafka-spark-test</span><br><span class="line">Topic:kafka-spark-test	PartitionCount:<span class="number">2</span>	ReplicationFactor:<span class="number">2</span>	Configs:</span><br><span class="line">	Topic: kafka-spark-test	Partition: <span class="number">0</span>	Leader: <span class="number">0</span>	Replicas: <span class="number">0</span>,<span class="number">1</span>	Isr: <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">	Topic: kafka-spark-test	Partition: <span class="number">1</span>	Leader: <span class="number">1</span>	Replicas: <span class="number">1</span>,<span class="number">2</span>	Isr: <span class="number">1</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>2.è¿è¡Œkafkaç”Ÿäº§è€…æ¨¡æ‹Ÿç¨‹åº: ä¸‹é¢æ¨¡æ‹Ÿäº†å¾€kafka-spark-testé˜Ÿåˆ—ä¸­æ¯ç§’å‘é€2000ä¸ªæ¶ˆæ¯,æ¯æ¡æ¶ˆæ¯çš„é•¿åº¦æ˜¯70ä¸ªæ•°å­—.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>]$ bin/spark-submit --<span class="keyword">class</span> org.apache.spark.examples.streaming.KafkaWordCountProducer /home/qihuang.zheng/spark-intro.jar <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">9092</span> kafka-spark-test <span class="number">2000</span> <span class="number">70</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.NoClassDefFoundError: org/apache/kafka/clients/producer/KafkaProducer</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ‰“åŒ…çš„æ–¹å¼æ²¡æœ‰æŠŠä¾èµ–åŒ…æ”¾è¿›æ¥. ç”¨ä¾èµ–åŒ…çš„æ–¹å¼å°±å¯ä»¥æ­£å¸¸åœ°åœ¨æ§åˆ¶å°è¾“å‡ºkafkaçš„æ¨¡æ‹Ÿæ¶ˆæ¯:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>]$ bin/spark-submit --<span class="keyword">class</span> org.apache.spark.examples.streaming.KafkaWordCountProducer /home/qihuang.zheng/spark-intro-<span class="number">1.0</span>-SNAPSHOT-jar-with-dependencies.jar <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">9092</span> kafka-spark-test <span class="number">2000</span> <span class="number">70</span></span><br></pre></td></tr></table></figure>
<p>3.è¿è¡ŒKafkaWordCountå®æ—¶æµåˆ†æç¨‹åº</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>]$ bin/spark-submit --<span class="keyword">class</span> org.apache.spark.examples.streaming.KafkaWordCount /home/qihuang.zheng/spark-intro-<span class="number">1.0</span>-SNAPSHOT-jar-with-dependencies.jar <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">2181</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">2181</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">2181</span> my-consumer-group kafka-spark-test <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>æŠ¥é”™: æ²¡æœ‰æ‰¾åˆ°Kafka-SparkStreammingçš„ç›¸å…³jaråŒ…,å› ä¸ºæˆ‘ä»¬åœ¨pom.xmlä¸­æŠŠ<code>spark-streaming-kafka_2.10-1.4.0</code>ä¹Ÿè®¾ç½®ä¸ºäº†provided  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.NoClassDefFoundError</span>: org/apache/spark/streaming/kafka/KafkaUtils$</span><br><span class="line">	at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.KafkaWordCount</span>$.<span class="function"><span class="title">main</span><span class="params">(KafkaWordCount.scala:<span class="number">59</span>)</span></span></span><br><span class="line">	at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.examples</span><span class="class">.streaming</span><span class="class">.KafkaWordCount</span><span class="class">.main</span>(KafkaWordCount.scala)</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ä¹Ÿå¯ä»¥æŠŠ<code>spark-streaming-kafka_2.10-1.4.0</code>çš„scopeå»æ‰,ç„¶åé‡æ–°ç¼–è¯‘. ä¸è¿‡è¿˜æœ‰ä¸€ç§åŠæ³•:<br>ä¸‹è½½<code>spark-streaming-kafka_2.10-1.4.0.jar</code>,åœ¨spark-submitä¸­æ·»åŠ â€“jarsé€‰é¡¹æŠŠ<code>spark-streaming-kafka_2.10-1.4.0.jar</code>åŠ è¿›æ¥  </p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>]$ bin/spark-submit --<span class="keyword">master</span> <span class="title">spark</span>://dp0652:<span class="number">7077</span> --class org.apache.spark.examples.streaming.KafkaWordCount --jars /home/qihuang.zheng/spark-streaming-kafka_2.<span class="number">10</span>-<span class="number">1.4</span>.<span class="number">0</span>.jar /home/qihuang.zheng/spark-intro-<span class="number">1.0</span>-SNAPSHOT-jar-with-dependencies.jar <span class="number">192.168</span>.<span class="number">6.55</span>:<span class="number">2181</span>,<span class="number">192.168</span>.<span class="number">6.56</span>:<span class="number">2181</span>,<span class="number">192.168</span>.<span class="number">6.57</span>:<span class="number">2181</span> my-consumer-<span class="keyword">group</span> <span class="title">kafka-spark-test</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>4.KafkaWordCountçš„è¾“å‡ºæ—¥å¿—:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">09</span>:<span class="number">40</span>:<span class="number">11</span> WARN BlockManager: Block input-<span class="number">0</span>-<span class="number">1436233210800</span> replicated to only <span class="number">0</span> peer(s) instead of <span class="number">1</span> peers</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">09</span>:<span class="number">40</span>:<span class="number">11</span> WARN BlockManager: Block input-<span class="number">0</span>-<span class="number">1436233211000</span> replicated to only <span class="number">0</span> peer(s) instead of <span class="number">1</span> peers</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">07</span> <span class="number">09</span>:<span class="number">40</span>:<span class="number">12</span> WARN BlockManager: Block input-<span class="number">0</span>-<span class="number">1436233212000</span> replicated to only <span class="number">0</span> peer(s) instead of <span class="number">1</span> peers</span><br><span class="line">-------------------------------------------</span><br><span class="line">Time: <span class="number">1436233212000</span> ms</span><br><span class="line">-------------------------------------------</span><br><span class="line">(<span class="number">4</span>,<span class="number">139354</span>)</span><br><span class="line">(<span class="number">8</span>,<span class="number">140225</span>)</span><br><span class="line">(<span class="number">6</span>,<span class="number">140124</span>)</span><br><span class="line">(<span class="number">0</span>,<span class="number">140515</span>)</span><br><span class="line">(<span class="number">2</span>,<span class="number">139827</span>)</span><br><span class="line">(<span class="number">7</span>,<span class="number">140151</span>)</span><br><span class="line">(<span class="number">5</span>,<span class="number">139425</span>)</span><br><span class="line">(<span class="number">9</span>,<span class="number">140219</span>)</span><br><span class="line">(<span class="number">3</span>,<span class="number">140248</span>)</span><br><span class="line">(<span class="number">1</span>,<span class="number">139912</span>)</span><br></pre></td></tr></table></figure>
<p>5.Streaming-WebUI</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss2.png" alt=""></p>
<p>å› ä¸ºæ¯ç§’2000æ¡æ¶ˆæ¯,æ¯éš”2ç§’ç»Ÿè®¡ä¸€æ¬¡,æ‰€ä»¥æ¯æ¬¡jobçš„è¾“å…¥å¤§å°InputSizeå¤§æ¦‚ä¸º2000*2=4000</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss3.png" alt=""></p>
<h2 id="å…³äºæ‰“åŒ…">å…³äºæ‰“åŒ…</h2><h3 id="IDEAæ‰“åŒ…">IDEAæ‰“åŒ…</h3><p>Project Structures | Artifacts | + | Jar | Empty | å¡«å†™jaråŒ…åç§°: spark-intro |<br>åœ¨Available Elementsä¸­é€‰æ‹©é¡¹ç›®åç§°ä¸‹çš„â€™spark-introâ€™ compile output | åŒå‡» | å°±ä¼šåˆ°å·¦ä¾§çš„jaråŒ…ä¸‹<br>Build | Build Artifacts | é€‰æ‹©åˆšåˆšå¡«å†™çš„Artifact: spark-intro | Rebuild</p>
<h3 id="Mavenæ‰“åŒ…">Mavenæ‰“åŒ…</h3><p>å› ä¸ºæ˜¯mavenå·¥ç¨‹, æ‰€ä»¥å¯ä»¥åœ¨å·¥ç¨‹ä¸‹ç›´æ¥mvn package. ä½†æ˜¯æ³¨æ„å¦‚æœä¸é…ç½®mavençš„æ’ä»¶.åˆ™ä¸ä¼šæŠŠä¾èµ–åŒ…æ‰“è¿›å».<br>å¦‚æœè¦æŠŠä¾èµ–åŒ…æ·»åŠ è¿›å», åˆ™è¦æ·»åŠ <code>maven-assembly-plugin</code>æ’ä»¶:  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="title">descriptorRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">descriptorRefs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">mainClass</span>&gt;</span><span class="tag">&lt;/<span class="title">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="title">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="title">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="title">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„: å¯¹äºsparkçš„ç›¸å…³jarä¾èµ–è®¾ç½®scope=provided</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>spark-core_$&#123;scala.bin.version&#125;<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="title">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>spark-streaming_$&#123;scala.bin.version&#125;<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="title">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å·¥ç¨‹çš„æ ¹ç›®å½•æ‰§è¡Œ<code>mvn package</code>, ç¼–è¯‘æˆåŠŸåä¼šåœ¨targetä¸‹ç”Ÿæˆ2ä¸ªæ–‡ä»¶.ä¸€ä¸ªæ˜¯æœ‰ä¾èµ–çš„,ä¸€ä¸ªæ˜¯æ²¡æœ‰ä»»ä½•ä¾èµ–çš„.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  spark-intro git:(master) âœ— ll target</span><br><span class="line">-rw-r--r--   <span class="number">1</span> zhengqh  staff    <span class="number">16</span>M  <span class="number">7</span>  <span class="number">7</span> <span class="number">09</span>:<span class="number">22</span> spark-intro-<span class="number">1.0</span>-SNAPSHOT-jar-with-dependencies.jar</span><br><span class="line">-rw-r--r--   <span class="number">1</span> zhengqh  staff   <span class="number">466</span>K  <span class="number">7</span>  <span class="number">7</span> <span class="number">09</span>:<span class="number">22</span> spark-intro-<span class="number">1.0</span>-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŠŠæœ‰ä¾èµ–çš„jaråŒ…æ‹·è´åˆ°sparké›†ç¾¤ä¸­è¿è¡Œ</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="tag">target</span> <span class="tag">git</span><span class="pseudo">:(master)</span> âœ— <span class="tag">scp</span> <span class="tag">spark-intro-1</span><span class="class">.0-SNAPSHOT-jar-with-dependencies</span><span class="class">.jar</span> <span class="tag">qihuang</span><span class="class">.zheng</span><span class="at_rule">@<span class="keyword">192.168.6.52:~/</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Kafka-SparkStreamming-Redis">Kafka-SparkStreamming-Redis</h2><p>åœ¨192.168.6.52ä¸Šå¯åŠ¨redis, æ³¨æ„è¦ä»¥åå°æ–¹å¼å¯åŠ¨, å¹¶ä¸”ç”¨adminç”¨æˆ·, å¦åˆ™shutdownæ—¶ä¼šæŠ¥é”™:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/<span class="operator"><span class="keyword">install</span>/redis-<span class="number">3.0</span><span class="number">.2</span></span><br><span class="line">sudo -u <span class="keyword">admin</span> src/redis-<span class="keyword">server</span> &amp;</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨kafkaç”Ÿäº§è€…æ¨¡æ‹Ÿç¨‹åº</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --<span class="keyword">class</span> com.tongdun.bigdata.spark.intro.KafkaEventProducer /home/qihuang.zheng/spark-intro-<span class="number">1.0</span>-SNAPSHOT-jar-with-dependencies.jar <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">9092</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">9092</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ç”¨æˆ·ç‚¹å‡»æ¬¡æ•°å®æ—¶æµç»Ÿè®¡,æœ€ç»ˆå†™åˆ°Redisä¸­</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --master spark://dp<span class="number">0652:7077</span> --class com.tongdun.bigdata.spark.intro.UserClickCountAnalytics --jars /home/qihuang.zheng/spark-streaming-kafka_<span class="number">2.10-1.4</span>.0.jar /home/qihuang.zheng/spark-intro-1.0-SNAPSHOT-jar-with-dependencies.jar spark://dp<span class="number">0652:7077</span> <span class="number">192.168.6.55</span>:<span class="number">9092,192.168</span>.<span class="number">6.56:9092</span>,<span class="number">192.168.6.57</span>:9092</span><br><span class="line"></span><br><span class="line">bin/spark-submit --master spark://dp<span class="number">0652:7077</span> --class com.tongdun.bigdata.spark.intro.UserClickCountAnalytics2 --jars /home/qihuang.zheng/spark-streaming-kafka_<span class="number">2.10-1.4</span>.0.jar /home/qihuang.zheng/spark-intro-1.0-SNAPSHOT-jar-with-dependencies.jar spark://dp<span class="number">0652:7077</span> user_events <span class="number">192.168.6.55</span>:<span class="number">9092,192.168</span>.<span class="number">6.56:9092</span>,<span class="number">192.168.6.57</span>:<span class="number">9092 192.168</span>.6.52</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å®¢æˆ·ç«¯åœ¨æœ¬æœºä¸­éªŒè¯æ•°æ®:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">src/redis-cli -h <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">6379</span>&gt; select <span class="number">1</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">6379</span>[<span class="number">1</span>]&gt; HGETALL app::users::click</span><br><span class="line"> <span class="number">1</span>) <span class="string">"d7f141563005d1b5d0d3dd30138f3f62"</span></span><br><span class="line"> <span class="number">2</span>) <span class="string">"1891"</span></span><br><span class="line"> <span class="number">3</span>) <span class="string">"97edfc08311c70143401745a03a50706"</span></span><br><span class="line"> <span class="number">4</span>) <span class="string">"1814"</span></span><br><span class="line"> <span class="number">5</span>) <span class="string">"4A4D769EB9679C054DE81B973ED5D768"</span></span><br><span class="line"> <span class="number">6</span>) <span class="string">"1845"</span></span><br><span class="line"> <span class="number">7</span>) <span class="string">"a95f22eabc4fd4b580c011a3161a9d9d"</span></span><br><span class="line"> <span class="number">8</span>) <span class="string">"1835"</span></span><br><span class="line"> <span class="number">9</span>) <span class="string">"8dfeb5aaafc027d89349ac9a20b3930f"</span></span><br><span class="line"><span class="number">10</span>) <span class="string">"1821"</span></span><br><span class="line"><span class="number">11</span>) <span class="string">"6b67c8c700427dee7552f81f3228c927"</span></span><br><span class="line"><span class="number">12</span>) <span class="string">"1842"</span></span><br><span class="line"><span class="number">13</span>) <span class="string">"011BBF43B89BFBF266C865DF0397AA71"</span></span><br><span class="line"><span class="number">14</span>) <span class="string">"1819"</span></span><br><span class="line"><span class="number">15</span>) <span class="string">"f2a8474bf7bd94f0aabbd4cdd2c06dcf"</span></span><br><span class="line"><span class="number">16</span>) <span class="string">"1909"</span></span><br><span class="line"><span class="number">17</span>) <span class="string">"c8ee90aade1671a21336c721512b817a"</span></span><br><span class="line"><span class="number">18</span>) <span class="string">"1843"</span></span><br><span class="line"><span class="number">19</span>) <span class="string">"068b746ed4620d25e26055a9f804385f"</span></span><br><span class="line"><span class="number">20</span>) <span class="string">"1955"</span></span><br></pre></td></tr></table></figure>
<p>å‡è®¾æˆ‘ä»¬åŒæ—¶å¯åŠ¨äº†ä¸¤ä¸ªUserClickCountAnalyticsè¿›ç¨‹, åˆ™ç¬¬äºŒä¸ªä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€. åªæœ‰å½“ç¬¬ä¸€ä¸ªè¿›ç¨‹æ€æ‰å, ç¬¬äºŒä¸ªè¿›ç¨‹æ‰ä¼šå¼€å§‹è¿è¡Œ.  </p>
<p>ä¸‹å›¾æ˜¯å¤„äºç­‰å¾…çš„è¿›ç¨‹,é™¤äº†InputRateæœ‰å›¾åƒ,å…¶ä»–ä¸‰ä¸ªéƒ½æ²¡æœ‰</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss4.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°statusä¸ºqueued</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss5.png" alt=""></p>
<p>åœ¨ç­‰å¾…è¿›ç¨‹çš„é‚£ä¸ªç»ˆç«¯ä¹Ÿå¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡º</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">[</span>Stage 0:&gt;                                                         <span class="function"> (</span>0 + 0<span class="function">)</span> / 2]15/07/07 12:05:25 WARN TaskSchedulerImpl: Initial job has<span class="instruction"> not </span>accepted any resources;<span class="instruction"> check </span>your cluster UI to ensure that workers are registered<span class="instruction"> and </span>have sufficient resources</span><br><span class="line">15/07/07 12:05:40 WARN TaskSchedulerImpl: Initial job has<span class="instruction"> not </span>accepted any resources;<span class="instruction"> check </span>your cluster UI to ensure that workers are registered<span class="instruction"> and </span>have sufficient resources</span><br><span class="line">15/07/07 12:05:55 WARN TaskSchedulerImpl: Initial job has<span class="instruction"> not </span>accepted any resources;<span class="instruction"> check </span>your cluster UI to ensure that workers are registered<span class="instruction"> and </span>have sufficient resources</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss6.png" alt=""></p>
<p>å½“æˆ‘ä»¬æŠŠæ­£åœ¨è¿è¡Œçš„æ€æ‰, è¿™æ—¶å€™ç­‰å¾…è¿è¡Œçš„å°±ä¼šæ¥ç€æ‰§è¡Œ</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/ss7.png" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/">spark</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-05-Spark-SQL" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-05-Spark-SQL/" class="article-date">
  	<time datetime="2015-12-01T10:02:13.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-05-Spark-SQL/">Spark SQLå…¥é—¨</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="SparkSQL_Table_Operation_with_ParquetFile">SparkSQL Table Operation with ParquetFile</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sc is an existing SparkContext.</span></span><br><span class="line">val sqlContext = new org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.sql</span><span class="class">.SQLContext</span>(sc)</span><br><span class="line"><span class="comment">// this is used to implicitly convert an RDD to a DataFrame.</span></span><br><span class="line">import sqlContext<span class="class">.implicits</span>._</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define the schema using a case class.</span></span><br><span class="line"><span class="comment">// <span class="doctag">Note:</span> Case classes in Scala 2.10 can support only up to 22 fields. To work around this limit,</span></span><br><span class="line"><span class="comment">// you can use custom classes that implement the Product interface.</span></span><br><span class="line">case class <span class="function"><span class="title">Person</span><span class="params">(name: String, age: Int)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create an RDD of Person objects and register it as a table.</span></span><br><span class="line">val people = sc.<span class="function"><span class="title">textFile</span><span class="params">(<span class="string">"/user/qihuang.zheng/sparktest/people.txt"</span>)</span></span>.<span class="function"><span class="title">map</span><span class="params">(_.split(<span class="string">","</span>)</span></span>).<span class="function"><span class="title">map</span><span class="params">(p =&gt; Person(p(<span class="number">0</span>)</span></span>, <span class="function"><span class="title">p</span><span class="params">(<span class="number">1</span>)</span></span><span class="class">.trim</span><span class="class">.toInt</span>)).<span class="function"><span class="title">toDF</span><span class="params">()</span></span></span><br><span class="line">people.<span class="function"><span class="title">registerTempTable</span><span class="params">(<span class="string">"people"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SQL statements can be run by using the sql methods provided by sqlContext.</span></span><br><span class="line">val teenagers = sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"SELECT name, age FROM people WHERE age &gt;= 13 AND age &lt;= 19"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The results of SQL queries are DataFrames and support all the normal RDD operations.</span></span><br><span class="line"><span class="comment">// The columns of a row in the result can be accessed by field index:</span></span><br><span class="line">teenagers.<span class="function"><span class="title">map</span><span class="params">(t =&gt; <span class="string">"Name: "</span> + t(<span class="number">0</span>)</span></span>).<span class="function"><span class="title">collect</span><span class="params">()</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// or by field name:</span></span><br><span class="line">teenagers.<span class="function"><span class="title">map</span><span class="params">(t =&gt; <span class="string">"Name: "</span> + t.getAs[String](<span class="string">"name"</span>)</span></span>).<span class="function"><span class="title">collect</span><span class="params">()</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// row.getValuesMap[T] retrieves multiple columns at once into a Map[String, T]</span></span><br><span class="line">teenagers.<span class="function"><span class="title">map</span><span class="params">(_.getValuesMap[Any](List(<span class="string">"name"</span>, <span class="string">"age"</span>)</span></span>)).<span class="function"><span class="title">collect</span><span class="params">()</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line"><span class="comment">// Map("name" -&gt; "Justin", "age" -&gt; 19)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The RDD is implicitly converted to a DataFrame by implicits, allowing it to be stored using Parquet.</span></span><br><span class="line">people.<span class="function"><span class="title">saveAsParquetFile</span><span class="params">(<span class="string">"/user/qihuang.zheng/sparktest/people.parquet"</span>)</span></span></span><br><span class="line">people<span class="class">.write</span><span class="class">.parquet</span>(<span class="string">"/user/qihuang.zheng/sparktest/people2.parquet"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read in the parquet file created above.  Parquet files are self-describing so the schema is preserved.</span></span><br><span class="line"><span class="comment">// The result of loading a Parquet file is also a DataFrame.</span></span><br><span class="line">val parquetFile = sqlContext<span class="class">.read</span><span class="class">.parquet</span>(<span class="string">"/user/qihuang.zheng/sparktest/people.parquet"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parquet files can also be registered as tables and then used in SQL statements.</span></span><br><span class="line">parquetFile.<span class="function"><span class="title">registerTempTable</span><span class="params">(<span class="string">"parquetFile"</span>)</span></span></span><br><span class="line">val teenagers = sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"SELECT name FROM parquetFile WHERE age &gt;= 13 AND age &lt;= 19"</span>)</span></span></span><br><span class="line">teenagers.<span class="function"><span class="title">map</span><span class="params">(t =&gt; <span class="string">"Name: "</span> + t(<span class="number">0</span>)</span></span>).<span class="function"><span class="title">collect</span><span class="params">()</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JOIN TABLE</span></span><br><span class="line">val jointbls = sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"SELECT people.name FROM people join parquetFile where people.name=parquetFile.name"</span>)</span></span></span><br><span class="line">jointbls.<span class="function"><span class="title">map</span><span class="params">(t =&gt; <span class="string">"Name: "</span> + t(<span class="number">0</span>)</span></span>).<span class="function"><span class="title">collect</span><span class="params">()</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Action:_activity_table">Action: activity table</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val activityTestRDD = sqlContext<span class="class">.read</span><span class="class">.parquet</span>(<span class="string">"/user/lab/activity"</span>)</span><br><span class="line">scala&gt; activityTestRDD.<span class="function"><span class="title">registerTempTable</span><span class="params">(<span class="string">"activity_test"</span>)</span></span></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select count(*) from activity_test"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line">[<span class="number">14543461</span>]</span><br><span class="line"></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select * from activity_test"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line">[<span class="number">1420549464102</span>,<span class="number">1420549464331</span>,<span class="function"><span class="title">Map</span><span class="params">(eventType -&gt; Other, appName -&gt; nonobank, ...,Map( -&gt; )</span></span>,forseti-<span class="number">20150105</span>]</span><br><span class="line"></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select event_result_map from activity_test"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line">[<span class="function"><span class="title">Map</span><span class="params">(eventType -&gt; Other, appType -&gt; web, timestamp -&gt; <span class="number">1420549464331</span>, ...)</span></span>]</span><br><span class="line"></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select event_result_map.policyList from activity_test"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">1</span>)</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line">[[<span class="string">"åçŸ­ä¿¡ç‚¸å¼¹æ¨¡å‹"</span>,<span class="string">"è™šå‡å·ç "</span>]]</span><br><span class="line"></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select event_result_map.appName,event_result_map.eventType,event_result_map.riskStatus from activity_test"</span>)</span></span>.<span class="function"><span class="title">registerTempTable</span><span class="params">(<span class="string">"activity_event_result_map"</span>)</span></span></span><br><span class="line"></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select * from activity_event_result_map"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">10</span>)</span></span>.<span class="function"><span class="title">foreach</span><span class="params">(println)</span></span></span><br><span class="line"></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select appName,riskStatus,eventType,count(*) from activity_event_result_map group by appName,riskStatus,eventType order by appName,riskStatus,eventType"</span>)</span></span><span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br><span class="line">[aixuedai,Accept,Loan,<span class="number">6594</span>]</span><br><span class="line"></span><br><span class="line">sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select appName,riskStatus,eventType,count(*) from activity_event_result_map group by appName,riskStatus,eventType order by appName,riskStatus,eventType"</span>)</span></span><span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br><span class="line">val cacheResult = sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select appName,riskStatus,eventType,count(*) from activity_event_result_map group by appName,riskStatus,eventType order by appName,riskStatus,eventType"</span>)</span></span><span class="class">.cache</span></span><br><span class="line">cacheResult<span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨æ‰§è¡Œcacheæ—¶å†…å­˜ä¸è¶³,ä¼šé€€å‡ºå½“å‰shell,è§£å†³åŠæ³•æ˜¯åœ¨spark-shellå‘½ä»¤å‰æ·»åŠ <code>SPARK_SUBMIT_OPTS=&quot;-XX:MaxPermSize=1g&quot;</code></p>
<h2 id="DataFrame_API">DataFrame API</h2><p>å°†parquetæ–‡ä»¶åŠ è½½å‡ºæ¥å,å¯ä»¥æ‰“å°å‡ºå®ƒçš„schema,æ³¨æ„æœ€åä¸€ä¸ªindiceæ˜¯partition-key</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">val activityTestRDD = sqlContext.read.parquet(<span class="string">"/user/lab/activity"</span>)</span><br><span class="line">scala&gt; activityTestRDD.printSchema</span><br><span class="line">root</span><br><span class="line"> |-- <span class="string">sequence_id:</span> string (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">occur_time:</span> <span class="typename">long</span> (nullable = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">activity_map:</span> map (nullable = <span class="literal">true</span>)</span><br><span class="line"> |    |-- <span class="string">key:</span> string</span><br><span class="line"> |    |-- <span class="string">value:</span> string (valueContainsNull = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">browser_map:</span> map (nullable = <span class="literal">true</span>)</span><br><span class="line"> |    |-- <span class="string">key:</span> string</span><br><span class="line"> |    |-- <span class="string">value:</span> string (valueContainsNull = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">device_map:</span> map (nullable = <span class="literal">true</span>)</span><br><span class="line"> |    |-- <span class="string">key:</span> string</span><br><span class="line"> |    |-- <span class="string">value:</span> string (valueContainsNull = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">event_result_map:</span> map (nullable = <span class="literal">true</span>)</span><br><span class="line"> |    |-- <span class="string">key:</span> string</span><br><span class="line"> |    |-- <span class="string">value:</span> string (valueContainsNull = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">geo_map:</span> map (nullable = <span class="literal">true</span>)</span><br><span class="line"> |    |-- <span class="string">key:</span> string</span><br><span class="line"> |    |-- <span class="string">value:</span> string (valueContainsNull = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">policy_map:</span> map (nullable = <span class="literal">true</span>)</span><br><span class="line"> |    |-- <span class="string">key:</span> string</span><br><span class="line"> |    |-- <span class="string">value:</span> string (valueContainsNull = <span class="literal">true</span>)</span><br><span class="line"> |-- <span class="string">indice:</span> string (nullable = <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>DataFrameæ”¯æŒè§£æå¤æ‚çš„Mapç»“æ„,ç”¨map.fieldå°±å¯ä»¥è·å–åˆ°key=fieldçš„value</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val event_result_map = activityTestRDD.<span class="function"><span class="title">select</span><span class="params">(<span class="string">"event_result_map.appName"</span>,<span class="string">"event_result_map.riskStatus"</span>,<span class="string">"event_result_map.eventType"</span>)</span></span></span><br><span class="line">event_result_map.<span class="function"><span class="title">take</span><span class="params">(<span class="number">10</span>)</span></span></span><br><span class="line">event_result_map.<span class="function"><span class="title">select</span><span class="params">(<span class="string">"appName"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">10</span>)</span></span></span><br><span class="line">event_result_map.<span class="function"><span class="title">select</span><span class="params">(<span class="string">"appName"</span>,<span class="string">"riskStatus"</span>,<span class="string">"eventType"</span>)</span></span>.<span class="function"><span class="title">take</span><span class="params">(<span class="number">10</span>)</span></span></span><br><span class="line">event_result_map.<span class="function"><span class="title">select</span><span class="params">(<span class="string">"appName"</span>,<span class="string">"riskStatus"</span>,<span class="string">"eventType"</span>)</span></span>.<span class="function"><span class="title">groupBy</span><span class="params">(<span class="string">"appName"</span>,<span class="string">"riskStatus"</span>,<span class="string">"eventType"</span>)</span></span><span class="class">.count</span><span class="class">.show</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨ç¼“å­˜åœ¨ç¬¬äºŒæ¬¡æŸ¥è¯¢æ—¶, é€Ÿåº¦ä¼šåŠ å¿«.  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val res = event<span class="emphasis">_result_</span>map.select("appName","riskStatus","eventType").groupBy("appName","riskStatus","eventType").count.cache</span><br><span class="line">res.show</span><br><span class="line"><span class="header">res.show</span><br><span class="line">+---------------+----------+---------+-------+</span></span><br><span class="line"><span class="header">|        appName|riskStatus|eventType|  count|</span><br><span class="line">+---------------+----------+---------+-------+</span></span><br><span class="line"><span class="header">|    niwodai_ios|    Review| Register|     77|</span><br><span class="line">+---------------+----------+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä¸Šé¢åªæ˜¾ç¤ºéƒ¨åˆ†ç»“æœ(åªæœ‰20æ¡). å®Œæ•´çš„è®°å½•åº”è¯¥æœ‰174æ¡</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; res</span><br><span class="line">res53: org.apache.spark.sql.DataFrame = [appName: string, riskStatus: string, eventType: string, count: bigint]</span><br><span class="line">scala&gt; res.count</span><br><span class="line">res54: Long = 174</span><br><span class="line"></span><br><span class="line"><span class="header">scala&gt; res.filter("appName = 'ppdai'").show</span><br><span class="line">+-------+----------+---------+-----+</span></span><br><span class="line"><span class="header">|appName|riskStatus|eventType|count|</span><br><span class="line">+-------+----------+---------+-----+</span></span><br><span class="line"><span class="header">|  ppdai|    Review|   Modify|  505|</span><br><span class="line">+-------+----------+---------+-----+</span></span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ<code>ä¸ºä»€ä¹ˆDataFrame.showåªè¿”å›éƒ¨åˆ†ç»“æœå‘¢?</code> TODO  </p>
<p>ä¸ºäº†è¿”å›å…¨éƒ¨æ•°æ®, è¦ç”¨collectæ”¶é›†æ‰€æœ‰ç»“æœ(collectä¼šæŠŠæ‰€æœ‰Workerçš„ç»“æœéƒ½æ±‡èšåˆ°Driverä¸Šè¿”å›ç»™å®¢æˆ·ç«¯)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; res.<span class="function"><span class="title">filter</span><span class="params">(<span class="string">"appName = 'ppdai'"</span>)</span></span><span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br><span class="line">[ppdai,Review,Modify,<span class="number">505</span>]</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢åªæ˜¯è¿”å›ä¸€ä¸ªåˆä½œæ–¹çš„æ‰€æœ‰ç»Ÿè®¡æŒ‡æ ‡, æ—¶é—´åªéœ€è¦0.4ç§’å·¦å³. è¦ç»Ÿè®¡æ‰€æœ‰åˆä½œæ–¹,éœ€è¦å»æ‰å‰é¢çš„filter:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res<span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡é€Ÿåº¦ä¼šæ…¢å¾ˆå¤š, å¤§æ¦‚éœ€è¦30ç§’. è€Œä¸”å¤šæ¬¡æŸ¥è¯¢éƒ½æ˜¯è¿™æ ·çš„: <code>resç¼“å­˜åä½¿ç”¨collectè²Œä¼¼æ²¡æœ‰èµ·ä½œç”¨??</code><br>å¦‚æœä½¿ç”¨orderBy,åˆ™ä¹Ÿä¼šåŠ å¿«æŸ¥è¯¢é€Ÿåº¦,å¤§æ¦‚åªéœ€è¦0.9ç§’  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; res.<span class="function"><span class="title">orderBy</span><span class="params">(<span class="string">"appName"</span>,<span class="string">"riskStatus"</span>,<span class="string">"eventType"</span>)</span></span><span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br></pre></td></tr></table></figure>
<p>DataFrameå¯ä»¥æ³¨å†Œä¸ºTableç„¶ååœ¨Tableä¸ŠæŸ¥è¯¢, æŸ¥è¯¢æ‰€æœ‰è®°å½•ä¹Ÿåªéœ€è¦0.4ç§’. SO, Thatâ€™s Great!</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; res.<span class="function"><span class="title">registerTempTable</span><span class="params">(<span class="string">"activity_group"</span>)</span></span></span><br><span class="line">scala&gt; sqlContext.<span class="function"><span class="title">sql</span><span class="params">(<span class="string">"select * from activity_group"</span>)</span></span><span class="class">.collect</span><span class="class">.foreach</span>(println)</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">02</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">38</span> INFO scheduler<span class="class">.DAGScheduler</span>: Job <span class="number">62</span> finished: collect at &lt;console&gt;:<span class="number">20</span>, took <span class="number">0.390465</span> s</span><br><span class="line">[niwodai_ios,Review,Register,<span class="number">77</span>]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>DataFrameå¯ä»¥ä¿å­˜åˆ°HDFSä¸Š, ç„¶åå¯ä»¥å†ä»hdfsä¸ŠåŠ è½½ä¸Šæ¥æŸ¥è¯¢,ä¸è¿‡è¿™æ ·æœ‰ç‚¹å¤šä½™äº†.ç›´æ¥ç”¨ä¸Šé¢çš„ä¸´æ—¶è¡¨|orderBy|filterä¼šæ›´å¿«</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.<span class="function"><span class="title">save</span><span class="params">(<span class="string">"/user/qihuang.zheng/sparktest/group3"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>é»˜è®¤ä¿å­˜çš„æ˜¯parquetæ–‡ä»¶, ä½†æ˜¯<code>ä¸ºä»€ä¹ˆå°æ–‡ä»¶è¿™ä¹ˆå¤š?</code>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 ~]$ /usr/install/hadoop/bin/hadoop fs -ls /user/qihuang.zheng/sparktest/group3</span><br><span class="line">Found <span class="number">203</span> items</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup          <span class="number">0</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/_SUCCESS</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup        <span class="number">462</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/_common_metadata</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup      <span class="number">44724</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/_metadata</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup       <span class="number">1014</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/part-r-<span class="number">00001.</span>gz.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup        <span class="number">999</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/part-r-<span class="number">00002.</span>gz.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup       <span class="number">1034</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/part-r-<span class="number">00003.</span>gz.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup        <span class="number">989</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/part-r-<span class="number">00004.</span>gz.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> qihuang.zheng supergroup       <span class="number">1041</span> <span class="number">2015</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">35</span> /user/qihuang.zheng/sparktest/group3/part-r-<span class="number">00005.</span>gz.parquet</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä¸‰æ¡è¯­å¥åˆ†åˆ«ç”Ÿæˆçš„parquetæ–‡ä»¶çš„ä¸ªæ•°ä¸º: 203,5,5</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; res<span class="class">.write</span><span class="class">.save</span>(<span class="string">"/user/qihuang.zheng/sparktest/group0.parquet"</span>)</span><br><span class="line">scala&gt; res.<span class="function"><span class="title">orderBy</span><span class="params">(<span class="string">"appName"</span>)</span></span><span class="class">.write</span><span class="class">.save</span>(<span class="string">"/user/qihuang.zheng/sparktest/group1.parquet"</span>)</span><br><span class="line">scala&gt; res.<span class="function"><span class="title">orderBy</span><span class="params">(<span class="string">"appName"</span>,<span class="string">"riskStatus"</span>,<span class="string">"eventType"</span>)</span></span><span class="class">.write</span><span class="class">.save</span>(<span class="string">"/user/qihuang.zheng/sparktest/group3.parquet"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Spark_&amp;_Hive">Spark &amp; Hive</h2><p>ç¼–è¯‘æ”¯æŒhiveçš„spark</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -Pyarn -Dyarn.version=<span class="number">2.6</span><span class="number">.0</span> -Phadoop-<span class="number">2.6</span> -Dhadoop.version=<span class="number">2.6</span><span class="number">.0</span> -Phive -Phive-<span class="number">0.13</span><span class="number">.1</span> -Phive-thriftserver -DskipTests clean package</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰ç¼–è¯‘hive on spark,è€Œæ˜¯ç›´æ¥æŠŠhive-site.xmlåˆ†å‘åˆ°sparké›†ç¾¤çš„confç›®å½•ä¸‹,ç›´æ¥å¯åŠ¨spark-sqlä¼šæŠ¥é”™:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>]$ bin/spark-sql</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.RuntimeException</span>: java<span class="class">.io</span><span class="class">.IOException</span>: æƒé™ä¸å¤Ÿ</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.hadoop</span><span class="class">.hive</span><span class="class">.ql</span><span class="class">.session</span><span class="class">.SessionState</span><span class="class">.start</span>(SessionState<span class="class">.java</span>:<span class="number">330</span>)</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.sql</span><span class="class">.hive</span><span class="class">.thriftserver</span><span class="class">.SparkSQLCLIDriver</span>$.<span class="function"><span class="title">main</span><span class="params">(SparkSQLCLIDriver.scala:<span class="number">109</span>)</span></span></span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.sql</span><span class="class">.hive</span><span class="class">.thriftserver</span><span class="class">.SparkSQLCLIDriver</span><span class="class">.main</span>(SparkSQLCLIDriver.scala)</span><br><span class="line">    at sun<span class="class">.reflect</span><span class="class">.NativeMethodAccessorImpl</span><span class="class">.invoke0</span>(Native Method)</span><br><span class="line">    at sun<span class="class">.reflect</span><span class="class">.NativeMethodAccessorImpl</span><span class="class">.invoke</span>(NativeMethodAccessorImpl<span class="class">.java</span>:<span class="number">57</span>)</span><br><span class="line">    at sun<span class="class">.reflect</span><span class="class">.DelegatingMethodAccessorImpl</span><span class="class">.invoke</span>(DelegatingMethodAccessorImpl<span class="class">.java</span>:<span class="number">43</span>)</span><br><span class="line">    at java<span class="class">.lang</span><span class="class">.reflect</span><span class="class">.Method</span><span class="class">.invoke</span>(Method<span class="class">.java</span>:<span class="number">606</span>)</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.SparkSubmit</span>$.org<span class="variable">$apache</span><span class="variable">$spark</span><span class="variable">$deploy</span><span class="variable">$SparkSubmit</span>$<span class="variable">$runMain</span>(SparkSubmit<span class="class">.scala</span>:<span class="number">664</span>)</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.SparkSubmit</span>$.doRunMain$<span class="number">1</span>(SparkSubmit<span class="class">.scala</span>:<span class="number">169</span>)</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.SparkSubmit</span>$.<span class="function"><span class="title">submit</span><span class="params">(SparkSubmit.scala:<span class="number">192</span>)</span></span></span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.SparkSubmit</span>$.<span class="function"><span class="title">main</span><span class="params">(SparkSubmit.scala:<span class="number">111</span>)</span></span></span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.SparkSubmit</span><span class="class">.main</span>(SparkSubmit.scala)</span><br><span class="line">Caused by: java<span class="class">.io</span><span class="class">.IOException</span>: æƒé™ä¸å¤Ÿ</span><br><span class="line">    at java<span class="class">.io</span><span class="class">.UnixFileSystem</span><span class="class">.createFileExclusively</span>(Native Method)</span><br><span class="line">    at java<span class="class">.io</span><span class="class">.File</span><span class="class">.createNewFile</span>(File<span class="class">.java</span>:<span class="number">1006</span>)</span><br><span class="line">    at java<span class="class">.io</span><span class="class">.File</span><span class="class">.createTempFile</span>(File<span class="class">.java</span>:<span class="number">1989</span>)</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.hadoop</span><span class="class">.hive</span><span class="class">.ql</span><span class="class">.session</span><span class="class">.SessionState</span><span class="class">.createTempFile</span>(SessionState<span class="class">.java</span>:<span class="number">432</span>)</span><br><span class="line">    at org<span class="class">.apache</span><span class="class">.hadoop</span><span class="class">.hive</span><span class="class">.ql</span><span class="class">.session</span><span class="class">.SessionState</span><span class="class">.start</span>(SessionState<span class="class">.java</span>:<span class="number">328</span>)</span><br><span class="line">    ... <span class="number">11</span> more</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">03</span> <span class="number">08</span>:<span class="number">42</span>:<span class="number">33</span> INFO util<span class="class">.Utils</span>: Shutdown hook called</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">03</span> <span class="number">08</span>:<span class="number">42</span>:<span class="number">33</span> INFO util<span class="class">.Utils</span>: Deleting directory /tmp/spark-<span class="number">831</span>ff199-cf80-<span class="number">4</span>d49-a22f-<span class="number">824736065289</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºSparké›†ç¾¤çš„æ¯ä¸ªWorkeréƒ½éœ€è¦Hiveçš„æ”¯æŒ,è€ŒWorkerèŠ‚ç‚¹å¹¶æ²¡æœ‰éƒ½å®‰è£…äº†hive. è€Œä¸”sparkéœ€è¦ç¼–è¯‘æ”¯æŒhiveçš„åŒ….<br>ä½†æ˜¯é‡æ–°ç¼–è¯‘hive on sparkè¦èŠ±å¾ˆå¤šæ—¶é—´,å¯ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨é›†ç¾¤ä¸­å·²ç»å®‰è£…å¥½çš„hiveå‘¢?  YES!!<br><a href="http://lxw1234.com/archives/2015/06/294.htm" target="_blank" rel="external">http://lxw1234.com/archives/2015/06/294.htm</a><br><a href="http://shiyanjun.cn/archives/1113.html" target="_blank" rel="external">http://shiyanjun.cn/archives/1113.html</a><br><a href="http://www.cnblogs.com/hseagle/p/3758922.html" target="_blank" rel="external">http://www.cnblogs.com/hseagle/p/3758922.html</a>  </p>
<p>1.åœ¨spark-env.shä¸­æ·»åŠ </p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HIVE_HOME=/usr/install/apache-hive-<span class="number">0</span>.<span class="number">13.1</span>-bin</span><br><span class="line">export SPARK_CLASSPATH=<span class="variable">$HIVE</span>_HOME/lib/mysql-connector-java-<span class="number">5.1</span>.<span class="number">34</span>.jar:<span class="variable">$SPARK</span>_CLASSPATH</span><br></pre></td></tr></table></figure>
<p>2.å°†<code>apache-hive-0.13.1-bin</code>åˆ†å‘åˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹(SparkWorkeræ‰€åœ¨çš„èŠ‚ç‚¹)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="operator"><span class="keyword">install</span></span><br><span class="line">scp -r apache-hive-<span class="number">0.13</span><span class="number">.1</span>-<span class="keyword">bin</span> dp0653:/usr/<span class="keyword">install</span>/</span></span><br></pre></td></tr></table></figure>
<p>3.æ‹·è´apache-hive-0.13.1-bin/conf/hive-site.xmlåˆ°$SPARK_HOME/confä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp apache-hive-<span class="number">0.13</span><span class="number">.1</span>-bin/conf/hive-site.xml dp0653:/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>/conf</span><br></pre></td></tr></table></figure>
<p>4.é‡å¯sparké›†ç¾¤</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sbin/<span class="keyword">stop</span>-<span class="keyword">all</span>.<span class="keyword">sh</span></span><br><span class="line">sbin/start-<span class="keyword">all</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>5.æµ‹è¯•spark-sql</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">56</span> WARN spark.<span class="string">SparkConf:</span> Setting <span class="string">'spark.executor.extraClassPath'</span> to <span class="string">'/usr/install/apache-hive-0.13.1-bin/lib/mysql-connector-java-5.1.34.jar:'</span> <span class="keyword">as</span> a work-around.</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">56</span> WARN spark.<span class="string">SparkConf:</span> Setting <span class="string">'spark.driver.extraClassPath'</span> to <span class="string">'/usr/install/apache-hive-0.13.1-bin/lib/mysql-connector-java-5.1.34.jar:'</span> <span class="keyword">as</span> a work-around.</span><br><span class="line"></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">00</span> INFO hive.<span class="string">metastore:</span> Trying to connect to metastore with URI <span class="string">thrift:</span><span class="comment">//192.168.6.53:9083</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">00</span> INFO hive.<span class="string">metastore:</span> Connected to metastore.</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">03</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">00</span> INFO session.<span class="string">SessionState:</span> No Tez session required at <span class="keyword">this</span> point. hive.execution.engine=mr.</span><br><span class="line">SET spark.sql.hive.version=<span class="number">0.13</span><span class="number">.1</span></span><br><span class="line">SET spark.sql.hive.version=<span class="number">0.13</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">spark-sql&gt; show databases;</span><br><span class="line"><span class="keyword">default</span></span><br><span class="line">test</span><br><span class="line">spark-sql&gt; use test;</span><br><span class="line">spark-sql&gt; show tables;</span><br><span class="line">koudai  <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">spark-sql&gt; select count(*) from koudai;</span><br><span class="line"><span class="number">311839</span></span><br></pre></td></tr></table></figure>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark-perf.png" alt=""></p>
<h2 id="SparkSQL_&amp;_thrift">SparkSQL &amp; thrift</h2><p>ç›´æ¥ç”¨bin/spark-sqlå¯åŠ¨:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 ~]$ jps -lm</span><br><span class="line"><span class="number">35146</span> org.apache.spark.deploy.SparkSubmit --master spark:<span class="comment">//192.168.6.52:7078 --class org.apache.spark.sql.hive.thriftserver.SparkSQLCLIDriver spark-internal</span></span><br><span class="line"><span class="number">35668</span> sun.tools.jps.Jps -lm</span><br><span class="line">[qihuang.zheng@dp0653 ~]$ ps -ef | grep SparkSQL</span><br><span class="line"><span class="number">506</span>      <span class="number">35146</span> <span class="number">35011</span> <span class="number">26</span> <span class="number">09</span>:<span class="number">16</span> pts/<span class="number">15</span>   <span class="number">00</span>:<span class="number">00</span>:<span class="number">19</span> /usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51/bin/java ... org.apache.spark.deploy.SparkSubmit --master spark:<span class="comment">//192.168.6.52:7078 --class org.apache.spark.sql.hive.thriftserver.SparkSQLCLIDriver spark-internal</span></span><br></pre></td></tr></table></figure>
<p>hiveåœ¨53ä¸Š, æŸ¥çœ‹thriftæœåŠ¡:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 ~]$ ps -ef | grep thrift</span><br><span class="line">admin    <span class="number">28541</span>     <span class="number">1</span>  <span class="number">0</span> Aug19 ?        <span class="number">00</span>:<span class="number">02</span>:<span class="number">47</span> /usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51/bin/java ... org.apache.hadoop.util.RunJar /usr/install/apache-hive-<span class="number">1.2</span><span class="number">.0</span>-bin/lib/hive-service-<span class="number">1.2</span><span class="number">.0</span>.jar org.apache.hive.service.server.HiveServer2 --hiveconf hive.metastore.uris=thrift:<span class="comment">//192.168.6.53:9083 --hiveconf hive.metastore.local=false --hiveconf hive.server2.thrift.bind.host=192.168.6.53 --hiveconf hive.server2.thrift.port=10001</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨sparkçš„thrift server:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sbin/start-thriftserver<span class="class">.sh</span> --master spark:<span class="comment">//192.168.6.52:7078</span></span><br><span class="line">starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.sql</span><span class="class">.hive</span><span class="class">.thriftserver</span><span class="class">.HiveThriftServer2</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">1</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.sql</span><span class="class">.hive</span><span class="class">.thriftserver</span><span class="class">.HiveThriftServer2-1-dp0652</span><span class="class">.out</span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨thrift-serverçš„æ—¶å€™, æŒ‡å®šmaster, ä¼šåœ¨masterçš„web uiä¸Šçœ‹åˆ°app. ä½†æ˜¯å¯åŠ¨å®Œæˆå, appå°±ç»“æŸäº†.<br>æ ¹æ®æ—¥å¿—ä¿¡æ¯, ç”±äºæ²¡æœ‰æ­£ç¡®æŒ‡å®šç«¯å£,å¯¼è‡´æ— æ³•è¿æ¥   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> INFO hive.metastore: Trying to connect to metastore with URI thrift:<span class="comment">//192.168.6.53:9083</span></span><br><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> INFO hive.metastore: Connected to metastore.</span><br><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> INFO service.AbstractService: Service:ThriftBinaryCLIService is started.</span><br><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> INFO service.AbstractService: Service:HiveServer2 is started.</span><br><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> INFO thriftserver.HiveThriftServer2: HiveThriftServer2 started</span><br><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> WARN conf.HiveConf: DEPRECATED: hive.metastore.ds.retry.* no longer has any effect.  Use hive.hmshandler.retry.* instead</span><br><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">48</span>:<span class="number">39</span> ERROR thrift.ThriftCLIService: Error:</span><br><span class="line">org.apache.thrift.transport.TTransportException: Could not create ServerSocket on address /<span class="number">192.168</span><span class="number">.47</span><span class="number">.213</span>:<span class="number">10000.</span></span><br><span class="line">        at org.apache.thrift.transport.TServerSocket.&lt;init&gt;(TServerSocket.java:<span class="number">93</span>)</span><br><span class="line">        at org.apache.thrift.transport.TServerSocket.&lt;init&gt;(TServerSocket.java:<span class="number">79</span>)</span><br><span class="line">        at org.apache.hive.service.auth.HiveAuthFactory.getServerSocket(HiveAuthFactory.java:<span class="number">236</span>)</span><br><span class="line">        at org.apache.hive.service.cli.thrift.ThriftBinaryCLIService.run(ThriftBinaryCLIService.java:<span class="number">69</span>)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">744</span>)</span><br></pre></td></tr></table></figure>
<p>æŒ‡å®šhiveçš„ç«¯å£:   </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sbin/start-thriftserver<span class="class">.sh</span> \</span><br><span class="line">  --hiveconf hive<span class="class">.server2</span><span class="class">.thrift</span><span class="class">.port</span>=<span class="number">10001</span> \</span><br><span class="line">  --hiveconf hive<span class="class">.server2</span><span class="class">.thrift</span><span class="class">.bind</span><span class="class">.host</span>=<span class="number">192.168</span>.<span class="number">6.53</span> \</span><br><span class="line">  --master spark:<span class="comment">//192.168.6.52:7078</span></span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹thriftè¿›ç¨‹:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.1</span>-bin-hadoop2<span class="number">.6</span>]$ ps -ef | grep thrift</span><br><span class="line">root     <span class="number">24997</span>     <span class="number">1</span> <span class="number">99</span> <span class="number">09</span>:<span class="number">55</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">12</span> /usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51/bin/java .. org.apache.spark.deploy.SparkSubmit --master spark:<span class="comment">//192.168.6.52:7078 --class org.apache.spark.sql.hive.thriftserver.HiveThriftServer2 spark-internal --hiveconf hive.server2.thrift.port=10001 --hiveconf hive.server2.thrift.bind.host=192.168.6.53</span></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯æ—¥å¿—è¿˜æ˜¯æŠ¥é”™:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>/<span class="number">08</span>/<span class="number">21</span> <span class="number">09</span>:<span class="number">55</span>:<span class="number">42</span> ERROR thrift.ThriftCLIService: Error:</span><br><span class="line">org.apache.thrift.transport.TTransportException: Could not create ServerSocket on address /<span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>:<span class="number">10001.</span></span><br></pre></td></tr></table></figure></p>
<p>è¿‡äº†å‡ ç§’,å†æ¬¡æŸ¥çœ‹thriftè¿›ç¨‹, æ‰¾ä¸åˆ°HiveThriftServer2äº†!</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qihuang.zheng<span class="annotation">@dp</span>0652 spark-<span class="number">1.4</span><span class="number">.1</span>-bin-hadoop2<span class="number">.6</span>]$ bin<span class="regexp">/beeline -u jdbc:hive2:/</span>/<span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>:<span class="number">10001</span></span><br><span class="line">scan complete <span class="keyword">in</span> <span class="number">3</span>ms</span><br><span class="line">Connecting to <span class="string">jdbc:</span><span class="string">hive2:</span><span class="comment">//192.168.6.53:10001</span></span><br><span class="line">Connected <span class="string">to:</span> Apache Hive (version <span class="number">1.2</span><span class="number">.0</span>)</span><br><span class="line"><span class="string">Driver:</span> Spark Project Core (version <span class="number">1.4</span><span class="number">.1</span>)</span><br><span class="line">Transaction <span class="string">isolation:</span> TRANSACTION_REPEATABLE_READ</span><br><span class="line">Beeline version <span class="number">1.4</span><span class="number">.1</span> by Apache Hive</span><br><span class="line"><span class="number">0</span>: <span class="string">jdbc:</span><span class="string">hive2:</span><span class="comment">//192.168.6.53:10001&gt; show tables;</span></span><br></pre></td></tr></table></figure>
<h2 id="spark-sqlåå°è¿è¡Œ">spark-sqlåå°è¿è¡Œ</h2><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">nohup /usr/install/spark-<span class="number">1</span><span class="number">.4</span><span class="number">.1</span>-bin-hadoop<span class="number">2</span><span class="number">.4</span>/bin/spark-sql \</span><br><span class="line">--master spark:<span class="comment">//192.168.47.213:7077,192.168.47.216:7077 \</span><br><span class="line">--executor-memory 8g --total-executor-cores 20 --driver-memory 8g \</span><br><span class="line">-e "</span><br><span class="line">SET spark.kryoserializer.buffer.mb=1024;</span></span><br><span class="line"></span><br><span class="line">cache table consumer_loan as</span><br><span class="line"><span class="keyword">SELECT</span> activity_map[<span class="string">'eventOccurTime'</span>] as eventOccurTime,</span><br><span class="line">                      activity_map[<span class="string">'accountLogin'</span>] as accountLogin,</span><br><span class="line">                      activity_map[<span class="string">'accountMobile'</span>] as accountMobile,</span><br><span class="line">                      activity_map[<span class="string">'idNumber'</span>] as idNumber,</span><br><span class="line">                      activity_map[<span class="string">'accountEmail'</span>] as accountEmail,</span><br><span class="line">                      activity_map[<span class="string">'accountPhone'</span>] as accountPhone,</span><br><span class="line">                      activity_map[<span class="string">'qqNumber'</span>] as qqNumber,</span><br><span class="line">                      activity_map[<span class="string">'cardNumber'</span>] as cardNumber,</span><br><span class="line">                      device_map[<span class="string">'deviceId'</span>] as deviceId,</span><br><span class="line">                      geo_map[<span class="string">'ipAddress'</span>] as ipAddress,</span><br><span class="line">                      geo_map[<span class="string">'trueIpAddress'</span>] as trueIpAddress,</span><br><span class="line">                      activity_map[<span class="string">'eventType'</span>] as eventType,</span><br><span class="line">                      event_result_map[<span class="string">'ruleList'</span>] as ruleList</span><br><span class="line">FROM activity</span><br><span class="line">WHERE activity_map[<span class="string">'partnerCode'</span>] in (<span class="string">'aixuedai'</span>,<span class="string">'fenqile'</span>) and activity_map[<span class="string">'eventType'</span>] = <span class="string">'Loan'</span>;</span><br><span class="line"></span><br><span class="line">cache table consumer_register as </span><br><span class="line"><span class="keyword">SELECT</span> activity_map[<span class="string">'eventOccurTime'</span>] as eventOccurTime,</span><br><span class="line">                      activity_map[<span class="string">'accountLogin'</span>] as accountLogin,</span><br><span class="line">                      activity_map[<span class="string">'accountMobile'</span>] as accountMobile,</span><br><span class="line">                      activity_map[<span class="string">'idNumber'</span>] as idNumber,</span><br><span class="line">                      activity_map[<span class="string">'accountEmail'</span>] as accountEmail,</span><br><span class="line">                      activity_map[<span class="string">'accountPhone'</span>] as accountPhone,</span><br><span class="line">                      activity_map[<span class="string">'qqNumber'</span>] as qqNumber,</span><br><span class="line">                      activity_map[<span class="string">'cardNumber'</span>] as cardNumber,</span><br><span class="line">                      device_map[<span class="string">'deviceId'</span>] as deviceId,</span><br><span class="line">                      geo_map[<span class="string">'ipAddress'</span>] as ipAddress,</span><br><span class="line">                      geo_map[<span class="string">'trueIpAddress'</span>] as trueIpAddress,</span><br><span class="line">                      activity_map[<span class="string">'eventType'</span>] as eventType,</span><br><span class="line">                      event_result_map[<span class="string">'ruleList'</span>] as ruleList</span><br><span class="line">   FROM activity</span><br><span class="line">   WHERE activity_map[<span class="string">'partnerCode'</span>] in (<span class="string">'aixuedai'</span>,<span class="string">'fenqile'</span>) and activity_map[<span class="string">'eventType'</span>] = <span class="string">'Register'</span>;</span><br><span class="line"></span><br><span class="line">select * from consumer_loan</span><br><span class="line"></span><br><span class="line">UNION ALL</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> a.* FROM consumer_register a</span><br><span class="line">JOIN (<span class="keyword">SELECT</span> deviceId FROM consumer_loan) b </span><br><span class="line"><span class="constant">ON</span> a.deviceId = b.deviceId;</span><br><span class="line"></span><br><span class="line"><span class="string">" &gt; ./consume_loan/consumer_loan.csv 2&gt; ./consume_loan/log_loan &amp;</span></span><br></pre></td></tr></table></figure>
<h2 id="Spark-SQLé…ç½®å‚æ•°">Spark-SQLé…ç½®å‚æ•°</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/spark-<span class="number">1.4</span><span class="number">.1</span>-<span class="keyword">bin</span>-hadoop2<span class="number">.4</span>/<span class="keyword">bin</span>/spark-shell <span class="comment">--conf spark.driver.maxResultSize=2g --conf spark.executor.memory=512m                              </span></span><br><span class="line"></span><br><span class="line">/usr/<span class="keyword">install</span>/spark-<span class="number">1.4</span><span class="number">.1</span>-<span class="keyword">bin</span>-hadoop2<span class="number">.4</span>/<span class="keyword">bin</span>/spark-shell <span class="comment">--driver-java-options -Dspark.driver.maxResultSize=2g</span></span><br><span class="line">scala&gt; sc.getConf.<span class="keyword">get</span>(<span class="string">"spark.driver.maxResultSize"</span>)</span><br><span class="line">res1: <span class="keyword">String</span> = <span class="number">2</span><span class="keyword">g</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="keyword">install</span>/spark-<span class="number">1.4</span><span class="number">.1</span>-<span class="keyword">bin</span>-hadoop2<span class="number">.4</span>/<span class="keyword">bin</span>/spark-<span class="keyword">sql</span> <span class="comment">--driver-java-options -Dspark.driver.maxResultSize=2g</span></span><br><span class="line">/usr/<span class="keyword">install</span>/spark-<span class="number">1.4</span><span class="number">.1</span>-<span class="keyword">bin</span>-hadoop2<span class="number">.4</span>/<span class="keyword">bin</span>/spark-<span class="keyword">sql</span> <span class="comment">--conf spark.driver.maxResultSize=2g</span></span><br><span class="line"></span><br><span class="line">/usr/<span class="keyword">install</span>/spark-<span class="number">1.4</span><span class="number">.1</span>-<span class="keyword">bin</span>-hadoop2<span class="number">.4</span>/<span class="keyword">bin</span>/spark-<span class="keyword">sql</span> -h</span><br><span class="line"><span class="keyword">Usage</span>: ./<span class="keyword">bin</span>/spark-<span class="keyword">sql</span> [options] [cli <span class="keyword">option</span>]</span><br><span class="line">  <span class="comment">--driver-java-options       Extra Java options to pass to the driver.</span></span><br><span class="line">  <span class="comment">--conf PROP=VALUE           Arbitrary Spark configuration property.</span></span><br><span class="line">  <span class="comment">--properties-file FILE      Path to a file from which to load extra properties. If not</span></span><br><span class="line">                              specified, this will look <span class="keyword">for</span> conf/spark-<span class="keyword">defaults</span>.conf.</span></span><br></pre></td></tr></table></figure>
<h2 id="Tips_&amp;_TODO">Tips &amp; TODO</h2><ol>
<li>åœ¨åšæŒ‡æ ‡åˆ†ææ—¶,å¦‚æœæ˜¯æ¯å¤©æˆ–è€…æ¯å‘¨è¿™æ ·çš„ç»Ÿè®¡é—´éš”,å¯ä»¥å°†åˆ†æåçš„ç»“æœä¿å­˜æˆPersistent Tableæˆ–è€…saveåˆ°HDFSä¸Šä¾›åˆ«äººä½¿ç”¨.  </li>
<li>çº¿ä¸Šçš„æ•°æ®ä¸€èˆ¬éƒ½æ¯”è¾ƒå¤š,æŸ¥è¯¢æ—¶å¯ä»¥ä½¿ç”¨partitionåˆ†åŒº</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/">spark</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-07-05-Apache-Spark" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-07-05-Apache-Spark/" class="article-date">
  	<time datetime="2015-12-01T10:02:10.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-07-05-Apache-Spark/">Apache Sparkå…¥é—¨</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><a href="http://spark.apache.org/docs/latest/quick-start.html" target="_blank" rel="external">http://spark.apache.org/docs/latest/quick-start.html</a></p>
<h2 id="Spark_Shell">Spark Shell</h2><p>âœ  spark-1.4.0-bin-hadoop2.6  <code>bin/spark-shell</code></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Welcome to</span><br><span class="line">      ____              __</span><br><span class="line">     / __/__  ___ _____/ /__</span><br><span class="line">    _\ \/ _ \/ _ `/ __/  '_/</span><br><span class="line">   /___/ .__/\_,_/_/ /_/\_\   <span class="keyword">version</span> 1.4.0</span><br><span class="line">      /_/</span><br><span class="line"></span><br><span class="line">Using <span class="keyword">Scala</span> <span class="keyword">version</span> 2.10.4 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_25)</span><br><span class="line">15/06/28 10:36:07 INFO ui.SparkUI: Started SparkUI at http:<span class="comment">//127.0.0.1:4040</span></span><br><span class="line">15/06/28 10:36:07 INFO repl.SparkILoop: Created spark context..</span><br><span class="line">Spark context available <span class="keyword">as</span> <span class="keyword">sc</span>.</span><br><span class="line">15/06/28 10:36:08 INFO hive.HiveContext: Initializing execution hive, <span class="keyword">version</span> 0.13.1</span><br><span class="line">15/06/28 10:36:23 INFO repl.SparkILoop: Created sql context (with Hive support)..</span><br><span class="line">SQL context available <span class="keyword">as</span> sqlContext.</span><br></pre></td></tr></table></figure>
<h2 id="Basic_RDD_Operation">Basic RDD Operation</h2><p>ç¬¬ä¸€ä¸ªä¾‹å­: ç»Ÿè®¡ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶çš„å•è¯æ•°é‡.<br>è°ƒç”¨scçš„textFile(fileName)ä¼šç”Ÿæˆä¸€ä¸ªMapPartitionsRDD  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val textFile = sc.<span class="function"><span class="title">textFile</span><span class="params">(<span class="string">"README.md"</span>)</span></span></span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">45</span> INFO storage<span class="class">.MemoryStore</span>: <span class="function"><span class="title">ensureFreeSpace</span><span class="params">(<span class="number">63424</span>)</span></span> called with curMem=<span class="number">0</span>, maxMem=<span class="number">278019440</span></span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">45</span> INFO storage<span class="class">.MemoryStore</span>: Block broadcast_0 stored as values <span class="keyword">in</span> memory (estimated size <span class="number">61.9</span> KB, free <span class="number">265.1</span> MB)</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">45</span> INFO storage<span class="class">.MemoryStore</span>: <span class="function"><span class="title">ensureFreeSpace</span><span class="params">(<span class="number">20061</span>)</span></span> called with curMem=<span class="number">63424</span>, maxMem=<span class="number">278019440</span></span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">45</span> INFO storage<span class="class">.MemoryStore</span>: Block broadcast_0_piece0 stored as bytes <span class="keyword">in</span> memory (estimated size <span class="number">19.6</span> KB, free <span class="number">265.1</span> MB)</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">45</span> INFO storage<span class="class">.BlockManagerInfo</span>: Added broadcast_0_piece0 <span class="keyword">in</span> memory on localhost:<span class="number">58638</span> (size: <span class="number">19.6</span> KB, free: <span class="number">265.1</span> MB)</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">36</span>:<span class="number">45</span> INFO spark<span class="class">.SparkContext</span>: Created broadcast <span class="number">0</span> from textFile at &lt;console&gt;:<span class="number">21</span></span><br><span class="line">textFile: org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.rdd</span><span class="class">.RDD</span>[String] = MapPartitionsRDD[<span class="number">1</span>] at textFile at &lt;console&gt;:<span class="number">21</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ä¸Šé¢ç”Ÿæˆçš„textFile RDDçš„count()ä¼šè§¦å‘ä¸€ä¸ªAction.  </p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; textFile.count()</span><br><span class="line">java.net.ConnectException: Call <span class="keyword">From</span> hadoop/<span class="number">127.0</span>.<span class="number">0.1</span> <span class="keyword">to</span> localhost:<span class="number">9000</span> failed <span class="keyword">on</span> connection exception: java.net.ConnectException: æ‹’ç»è¿æ¥; <span class="keyword">For</span> more details see:  http:<span class="comment">//wiki.apache.org/hadoop/ConnectionRefused</span></span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native <span class="function"><span class="keyword">Method</span>)</span><br><span class="line">    ...</span><br><span class="line"><span class="title">Caused</span> <span class="title">by</span>:</span> java.net.ConnectException: æ‹’ç»è¿æ¥</span><br><span class="line">	at sun.nio.ch.SocketChannelImpl.checkConnect(Native <span class="function"><span class="keyword">Method</span>)</span><br><span class="line">	...</span></span><br></pre></td></tr></table></figure>
<p>ç”±äºæœ¬æœºå·²ç»å®‰è£…äº†Hadoop,ä½¿ç”¨çš„æ˜¯ä¼ªåˆ†å¸ƒå¼æ¨¡å¼,æ‰€ä»¥Sparkä¼šè¯»å–Hadoopçš„é…ç½®ä¿¡æ¯.<br>æˆ‘ä»¬è¿™é‡Œå…ˆä¸å¯åŠ¨Hadoop,ä½¿ç”¨æœ¬åœ°æ¨¡å¼,è¦æ‰‹åŠ¨æ·»åŠ file:///å¹¶ä½¿ç”¨ç»å¯¹è·¯å¾„è¯»å–æ–‡æœ¬æ–‡ä»¶  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; textFile</span><br><span class="line">res1: org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.rdd</span><span class="class">.RDD</span>[String] = MapPartitionsRDD[<span class="number">1</span>] at textFile at &lt;console&gt;:<span class="number">21</span></span><br></pre></td></tr></table></figure>
<p>é‡æ–°æ„é€ è¯»å–æœ¬åœ°æ–‡æœ¬æ–‡ä»¶çš„textFile RDD</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val textFile = sc.<span class="function"><span class="title">textFile</span><span class="params">(<span class="string">"file:///home/hadoop/soft/spark-1.4.0-bin-hadoop2.6/README.md"</span>)</span></span></span><br><span class="line">textFile: org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.rdd</span><span class="class">.RDD</span>[String] = MapPartitionsRDD[<span class="number">3</span>] at textFile at &lt;console&gt;:<span class="number">21</span></span><br></pre></td></tr></table></figure>
<p>è§¦å‘RDDçš„Action: count  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; textFile.count()</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">44</span>:<span class="number">07</span> INFO scheduler.DAGScheduler: Job <span class="number">0</span> finished: count at &lt;console&gt;:<span class="number">24</span>, took <span class="number">0.275609</span> s</span><br><span class="line">res2: Long = <span class="number">98</span></span><br></pre></td></tr></table></figure>
<p>åˆä¸€ä¸ªAction RDD : è¾“å‡ºæ–‡æœ¬æ–‡ä»¶çš„ç¬¬ä¸€è¡Œ  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; textFile.first()</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">44</span>:<span class="number">27</span> INFO scheduler.DAGScheduler: Job <span class="number">1</span> finished: first at &lt;console&gt;:<span class="number">24</span>, took <span class="number">0.017917</span> s</span><br><span class="line">res3: String = <span class="preprocessor"># Apache Spark</span></span><br></pre></td></tr></table></figure>
<h2 id="More_RDD_Operations">More RDD Operations</h2><p>1.ç»Ÿè®¡åŒ…å«äº†Sparkè¿™ä¸ªå•è¯ä¸€å…±æœ‰å‡ è¡Œ</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val linesWithSpark = textFile.<span class="function"><span class="title">filter</span><span class="params">(line =&gt; line.contains(<span class="string">"Spark"</span>)</span></span>)</span><br><span class="line">linesWithSpark: org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.rdd</span><span class="class">.RDD</span>[String] = MapPartitionsRDD[<span class="number">4</span>] at <span class="attribute">filter</span> at &lt;console&gt;:<span class="number">23</span></span><br><span class="line">scala&gt; textFile.<span class="function"><span class="title">filter</span><span class="params">(line =&gt; line.contains(<span class="string">"Spark"</span>)</span></span>).<span class="function"><span class="title">count</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>2.æ–‡æœ¬æ–‡ä»¶ä¸­é•¿åº¦æœ€é•¿çš„é‚£ä¸€è¡Œ,å®ƒä¸€å…±æœ‰å¤šå°‘ä¸ªå•è¯</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; textFile.<span class="function"><span class="title">map</span><span class="params">(line =&gt; line.split(<span class="string">" "</span>)</span></span>.size).<span class="function"><span class="title">reduce</span><span class="params">((a, b)</span></span> =&gt; <span class="keyword">if</span> (<span class="tag">a</span> &gt; b) <span class="tag">a</span> <span class="keyword">else</span> b)</span><br></pre></td></tr></table></figure>
<p>3.MapReduce WordCount</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val wordCounts = textFile.<span class="function"><span class="title">flatMap</span><span class="params">(line =&gt; line.split(<span class="string">" "</span>)</span></span>).<span class="function"><span class="title">map</span><span class="params">(word =&gt; (word, <span class="number">1</span>)</span></span>).<span class="function"><span class="title">reduceByKey</span><span class="params">((a, b)</span></span> =&gt; <span class="tag">a</span> + b)</span><br><span class="line">wordCounts: org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.rdd</span><span class="class">.RDD</span>[(String, Int)] = ShuffledRDD[<span class="number">9</span>] at reduceByKey at &lt;console&gt;:<span class="number">23</span></span><br><span class="line"></span><br><span class="line">scala&gt;  wordCounts.<span class="function"><span class="title">collect</span><span class="params">()</span></span></span><br><span class="line">res6: Array[(String, Int)] = <span class="function"><span class="title">Array</span><span class="params">((package,<span class="number">1</span>)</span></span>, (this,<span class="number">1</span>), (Version<span class="string">"](http://spark.apache.org/docs/latest/building-spark.html#specifying-the-hadoop-version),1), (Because,1), (Python,2), (cluster.,1), (its,1), ([run,1), (general,2), (have,1), (pre-built,1), (locally.,1), (locally,2), (changed,1), (sc.parallelize(1,1), (only,1), (several,1), (This,2), (basic,1), (Configuration,1), (learning,,1), (documentation,3), (YARN,,1), (graph,1), (Hive,2), (first,1), (["</span>Specifying,<span class="number">1</span>), (<span class="string">"yarn-client"</span>,<span class="number">1</span>), (page](http:<span class="comment">//spark.apache.org/documentation.html),1), ([params]`.,1), (application,1), ([project,2), (prefer,1), (SparkPi,2), (&lt;http://spark.apache.org/&gt;,1), (engine,1), (version,1), (file,1), (documentation,,1), (MASTER,1), (example,3), (distribution.,1), (are,1), (params,1), (scala&gt;,1), (systems.,1...</span></span><br></pre></td></tr></table></figure>
<p>4.Cache</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scala&gt;  linesWithSpark.cache()</span><br><span class="line">res7: linesWithSpark.type = MapPartitionsRDD[<span class="number">4</span>] at filter at &lt;console&gt;:<span class="number">23</span></span><br><span class="line"></span><br><span class="line">scala&gt; linesWithSpark.count()</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">47</span>:<span class="number">11</span> INFO scheduler.DAGScheduler: Job <span class="number">5</span> finished: count at &lt;console&gt;:<span class="number">26</span>, took <span class="number">0.054036</span> s</span><br><span class="line">res8: Long = <span class="number">19</span></span><br><span class="line"></span><br><span class="line">scala&gt; linesWithSpark.count()</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">28</span> <span class="number">10</span>:<span class="number">47</span>:<span class="number">14</span> INFO scheduler.DAGScheduler: Job <span class="number">6</span> finished: count at &lt;console&gt;:<span class="number">26</span>, took <span class="number">0.016638</span> s</span><br><span class="line">res9: Long = <span class="number">19</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">val textFile = sc.<span class="function"><span class="title">textFile</span><span class="params">(<span class="string">"file:///home/hadoop/soft/spark-1.4.0-bin-hadoop2.6/README.md"</span>)</span></span></span><br><span class="line">ã€‡ textFile.<span class="function"><span class="title">count</span><span class="params">()</span></span></span><br><span class="line">â‘  textFile.<span class="function"><span class="title">first</span><span class="params">()</span></span></span><br><span class="line">val linesWithSpark = textFile.<span class="function"><span class="title">filter</span><span class="params">(line =&gt; line.contains(<span class="string">"Spark"</span>)</span></span>)</span><br><span class="line">â‘¡ textFile.<span class="function"><span class="title">filter</span><span class="params">(line =&gt; line.contains(<span class="string">"Spark"</span>)</span></span>).<span class="function"><span class="title">count</span><span class="params">()</span></span></span><br><span class="line">textFile.<span class="function"><span class="title">map</span><span class="params">(line =&gt; line.split(<span class="string">" "</span>)</span></span>.size).<span class="function"><span class="title">reduce</span><span class="params">((a, b)</span></span> =&gt; <span class="keyword">if</span> (<span class="tag">a</span> &gt; b) <span class="tag">a</span> <span class="keyword">else</span> b)</span><br><span class="line">â‘¢ val wordCounts = textFile.<span class="function"><span class="title">flatMap</span><span class="params">(line =&gt; line.split(<span class="string">" "</span>)</span></span>).<span class="function"><span class="title">map</span><span class="params">(word =&gt; (word, <span class="number">1</span>)</span></span>).<span class="function"><span class="title">reduceByKey</span><span class="params">((a, b)</span></span> =&gt; <span class="tag">a</span> + b)</span><br><span class="line">â‘£ wordCounts.<span class="function"><span class="title">collect</span><span class="params">()</span></span></span><br><span class="line">linesWithSpark.<span class="function"><span class="title">cache</span><span class="params">()</span></span></span><br><span class="line">â‘¤ linesWithSpark.<span class="function"><span class="title">count</span><span class="params">()</span></span></span><br><span class="line">â‘¥ linesWithSpark.<span class="function"><span class="title">count</span><span class="params">()</span></span></span><br><span class="line">â‘¦ linesWithSpark.<span class="function"><span class="title">count</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Spark_Shell_UI">Spark Shell UI</h2><p><a href="http://127.0.0.1:4040" target="_blank" rel="external">http://127.0.0.1:4040</a></p>
<h3 id="Jobs,_Stages,_Storage">Jobs, Stages, Storage</h3><p>Jobs: ä¸Šé¢æ¯ä¸ªAction RDDç¼–å·å¯¹åº”äº†ä¸‹å›¾ä¸­çš„Job Id.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark1.png" alt=""></p>
<p>Stages: ä¸Šé¢æœ‰8ä¸ªJob, ä½†æ˜¯Stageså¤šäº†ä¸€ä¸ª. å…¶å®æ˜¯â‘£çš„<code>collect</code>æœ‰ä¸¤ä¸ªstage  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark2.png" alt=""></p>
<p>Storage: åœ¨Cacheçš„æ—¶å€™æ‰æœ‰</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark3.png" alt=""></p>
<h3 id="æŸ¥çœ‹Stage">æŸ¥çœ‹Stage</h3><p>åœ¨Jobsä¸­ç‚¹å‡»Job Id=4çš„collect RDD(è¾“å‡ºWordCountçš„ç»“æœ). åœ¨ä¸‹æ–¹çš„åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°æœ‰2ä¸ªStages<br>ä»”ç»†è§‚å¯Ÿåˆ—è¡¨çš„æœ€åé¢ä¸¤åˆ—, åˆ†åˆ«æ˜¯Shuffle Readå’ŒShuffle Write.<br>å…¶ä¸­mapä¼šè¿›è¡ŒShuffle Write, collectä¼šè¿›è¡ŒShuffle Read</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark4.png" alt=""></p>
<p>ç‚¹å‡»Stage Id=4çš„map. å®ƒçš„DAGå¯è§†åŒ–å›¾å’Œä¸Šé¢çš„æ¦‚è§ˆå›¾çš„å·¦ä¾§æ˜¯ä¸€æ ·çš„</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark5.png" alt=""></p>
<p>Sparkçš„WebUIè¿˜æä¾›äº†ä¸€ä¸ªEventTime,å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°æ¯ä¸ªé˜¶æ®µæ¶ˆè€—çš„æ—¶é—´</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark7.png" alt=""></p>
<p>å›é€€,ç‚¹å‡»Stage Id=5çš„collect</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark6.png" alt=""></p>
<hr>
<h2 id="Spark_Standalone_é›†ç¾¤å®‰è£…">Spark Standalone é›†ç¾¤å®‰è£…</h2><p>å‡†å¤‡å·¥ä½œ:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>masteræ— å¯†ç sshåˆ°slaves(å°†masterçš„pubè¿½åŠ åˆ°æ‰€æœ‰slavesçš„authorized_keys)</span><br><span class="line"><span class="number">2.</span>å…³é—­æ‰€æœ‰èŠ‚ç‚¹çš„é˜²ç«å¢™(chkconfig iptables off)</span><br><span class="line"><span class="number">3.</span>å®‰è£…scala-<span class="number">2.10</span>,å¹¶è®¾ç½®~/.bashrc</span><br></pre></td></tr></table></figure>
<p>cd $SPARK_HOME<br>vi conf/spark-env.sh  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> JAVA_HOME=/usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51</span><br><span class="line"><span class="keyword">export</span> SCALA_HOME=/usr/install/scala-<span class="number">2.10</span><span class="number">.5</span></span><br><span class="line"><span class="keyword">export</span> HADOOP_HOME=/usr/install/hadoop</span><br><span class="line"><span class="keyword">export</span> HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop</span><br><span class="line"><span class="keyword">export</span> SPARK_MASTER_IP=dp0652</span><br><span class="line"><span class="keyword">export</span> MASTER=spark:<span class="comment">//dp0652:7077</span></span><br><span class="line"><span class="preprocessor">#export SPARK_LOCAL_IP=dp0652</span></span><br><span class="line"><span class="keyword">export</span> SPARK_LOCAL_DIRS=/usr/install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span></span><br><span class="line"><span class="keyword">export</span> SPARK_MASTER_WEBUI_PORT=<span class="number">8082</span></span><br><span class="line"><span class="keyword">export</span> SPARK_MASTER_PORT=<span class="number">7077</span></span><br><span class="line"><span class="keyword">export</span> SPARK_WORKER_CORES=<span class="number">1</span></span><br><span class="line"><span class="keyword">export</span> SPARK_WORKER_INSTANCES=<span class="number">1</span></span><br><span class="line"><span class="keyword">export</span> SPARK_WORKER_MEMORY=<span class="number">8</span>g</span><br></pre></td></tr></table></figure>
<p>vi conf/slaves</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">dp0652</span></span><br><span class="line">dp0653</span><br><span class="line">dp0655</span><br><span class="line">dp0656</span><br><span class="line">dp0657</span><br></pre></td></tr></table></figure>
<p>å°†sparkç›®å½•åˆ†å‘åˆ°é›†ç¾¤çš„å…¶ä»–èŠ‚ç‚¹</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">scp -r <span class="variable">$SPARK</span>_HOME dp0653:/usr/install</span><br><span class="line">scp -r <span class="variable">$SPARK</span>_HOME dp0655:/usr/install</span><br><span class="line">scp -r <span class="variable">$SPARK</span>_HOME dp0656:/usr/install</span><br><span class="line">scp -r <span class="variable">$SPARK</span>_HOME dp0657:/usr/install</span><br></pre></td></tr></table></figure>
<p>ç”±äºé›†ç¾¤ä¸­dp0652å’Œdp0653çš„å†…å­˜æ¯”è¾ƒå¤§, æˆ‘ä»¬ä¿®æ”¹äº†è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„spark-env.sh  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> SPARK_WORKER_INSTANCES=<span class="number">2</span></span><br><span class="line"><span class="keyword">export</span> SPARK_WORKER_MEMORY=<span class="number">20</span>g</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨é›†ç¾¤, åœ¨masterä¸Šå¯åŠ¨å³å¯.  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>]$ sbin/start-all<span class="class">.sh</span></span><br><span class="line">starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.master</span><span class="class">.Master</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.master</span><span class="class">.Master-1-dp0652</span><span class="class">.out</span></span><br><span class="line">dp0656: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-1-dp0656</span><span class="class">.out</span></span><br><span class="line">dp0655: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-1-dp0655</span><span class="class">.out</span></span><br><span class="line">dp0657: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-1-dp0657</span><span class="class">.out</span></span><br><span class="line">dp0652: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-1-dp0652</span><span class="class">.out</span></span><br><span class="line">dp0653: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-1-dp0653</span><span class="class">.out</span></span><br><span class="line">dp0652: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-2-dp0652</span><span class="class">.out</span></span><br><span class="line">dp0653: starting org<span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker</span>, logging to /usr/install/spark-<span class="number">1.4</span>.<span class="number">0</span>-bin-hadoop2.<span class="number">6</span>/sbin/../logs/spark-qihuang<span class="class">.zheng-org</span><span class="class">.apache</span><span class="class">.spark</span><span class="class">.deploy</span><span class="class">.worker</span><span class="class">.Worker-2-dp0653</span><span class="class">.out</span></span><br></pre></td></tr></table></figure>
<p>åœ¨masterå’Œslavesä¸ŠæŸ¥çœ‹Sparkè¿›ç¨‹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>]$ jps -lm</span><br><span class="line"><span class="number">40708</span> org.apache.spark.deploy.master.Master --ip dp0652 --port <span class="number">7077</span> --webui-port <span class="number">8082</span></span><br><span class="line"><span class="number">41095</span> org.apache.spark.deploy.worker.Worker --webui-port <span class="number">8082</span> spark:<span class="comment">//dp0652:7077</span></span><br><span class="line"><span class="number">40926</span> org.apache.spark.deploy.worker.Worker --webui-port <span class="number">8081</span> spark:<span class="comment">//dp0652:7077</span></span><br><span class="line">[qihuang.zheng@dp0652 spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>]$ ssh dp0653</span><br><span class="line">Last login: Thu Jul  <span class="number">2</span> <span class="number">09</span>:<span class="number">07</span>:<span class="number">17</span> <span class="number">2015</span> from <span class="number">192.168</span><span class="number">.6</span><span class="number">.140</span></span><br><span class="line">[qihuang.zheng@dp0653 ~]$ jps -lm</span><br><span class="line"><span class="number">27153</span> org.apache.spark.deploy.worker.Worker --webui-port <span class="number">8082</span> spark:<span class="comment">//dp0652:7077</span></span><br><span class="line"><span class="number">27029</span> org.apache.spark.deploy.worker.Worker --webui-port <span class="number">8081</span> spark:<span class="comment">//dp0652:7077</span></span><br><span class="line">[qihuang.zheng@dp0653 ~]$ <span class="built_in">exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to dp0653 closed.</span><br><span class="line">[qihuang.zheng@dp0652 logs]$ ssh dp0655</span><br><span class="line">Last login: Thu Jul  <span class="number">2</span> <span class="number">08</span>:<span class="number">55</span>:<span class="number">05</span> <span class="number">2015</span> from <span class="number">192.168</span><span class="number">.6</span><span class="number">.140</span></span><br><span class="line">[qihuang.zheng@dp0655 ~]$ jps -lm</span><br><span class="line"><span class="number">8766</span> org.apache.spark.deploy.worker.Worker --webui-port <span class="number">8081</span> spark:<span class="comment">//dp0652:7077</span></span><br><span class="line">[qihuang.zheng@dp0655 ~]$</span><br></pre></td></tr></table></figure>
<p>åœ¨masterä¸ŠæŸ¥çœ‹web ui: <a href="http://dp0652:8082/" target="_blank" rel="external">http://dp0652:8082/</a></p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/spark8.png" alt=""></p>
<h3 id="é‡åˆ°ä¸€äº›é—®é¢˜">é‡åˆ°ä¸€äº›é—®é¢˜</h3><p><strong>1.å¦‚æœé…ç½®äº†SPARK_LOCAL_IP, ä½†æ˜¯å¹¶æ²¡æœ‰åœ¨slavesä¸Šä¿®æ”¹ä¸ºè‡ªå·±çš„IP,åˆ™ä¼šæŠ¥é”™:</strong>  </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">15/07/02 09:04:08 <span class="keyword">ERROR</span> netty.NettyTransport: failed to bind to /192.168.6.52:0, shutting down Netty transport</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.<span class="keyword">net</span>.BindException: Failed to bind to: /192.168.6.52:0: Service 'sparkWorker' failed after 16 retries!</span><br><span class="line">        at org.jboss.netty.<span class="keyword">bootstrap</span>.ServerBootstrap.bind(ServerBootstrap.java:272)</span><br><span class="line">        at akka.remote.transport.netty.NettyTransport$<span class="label">$anonfun</span><span class="label">$listen</span><span class="label">$1</span>.apply(NettyTransport.<span class="keyword">scala</span>:393)</span><br><span class="line">        at akka.remote.transport.netty.NettyTransport$<span class="label">$anonfun</span><span class="label">$listen</span><span class="label">$1</span>.apply(NettyTransport.<span class="keyword">scala</span>:389)</span><br><span class="line">        at <span class="keyword">scala</span>.util.Success$<span class="label">$anonfun</span><span class="label">$map</span><span class="label">$1</span>.apply(Try.<span class="keyword">scala</span>:206)</span><br><span class="line">        at <span class="keyword">scala</span>.util.Try$.apply(Try.<span class="keyword">scala</span>:161)</span><br><span class="line">        at <span class="keyword">scala</span>.util.Success.map(Try.<span class="keyword">scala</span>:206)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.Future$<span class="label">$anonfun</span><span class="label">$map</span><span class="label">$1</span>.apply(Future.<span class="keyword">scala</span>:235)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.Future$<span class="label">$anonfun</span><span class="label">$map</span><span class="label">$1</span>.apply(Future.<span class="keyword">scala</span>:235)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.impl.CallbackRunnable.<span class="keyword">run</span>(Promise.<span class="keyword">scala</span>:32)</span><br><span class="line">        at akka.dispatch.BatchingExecutor<span class="label">$Batch</span>$<span class="label">$anonfun</span><span class="label">$run</span><span class="label">$1</span>.processBatch<span class="label">$1</span>(BatchingExecutor.<span class="keyword">scala</span>:67)</span><br><span class="line">        at akka.dispatch.BatchingExecutor<span class="label">$Batch</span>$<span class="label">$anonfun</span><span class="label">$run</span><span class="label">$1</span>.apply<span class="label">$mcV</span><span class="label">$sp</span>(BatchingExecutor.<span class="keyword">scala</span>:82)</span><br><span class="line">        at akka.dispatch.BatchingExecutor<span class="label">$Batch</span>$<span class="label">$anonfun</span><span class="label">$run</span><span class="label">$1</span>.apply(BatchingExecutor.<span class="keyword">scala</span>:59)</span><br><span class="line">        at akka.dispatch.BatchingExecutor<span class="label">$Batch</span>$<span class="label">$anonfun</span><span class="label">$run</span><span class="label">$1</span>.apply(BatchingExecutor.<span class="keyword">scala</span>:59)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.BlockContext$.withBlockContext(BlockContext.<span class="keyword">scala</span>:72)</span><br><span class="line">        at akka.dispatch.BatchingExecutor<span class="label">$Batch</span>.<span class="keyword">run</span>(BatchingExecutor.<span class="keyword">scala</span>:58)</span><br><span class="line">        at akka.dispatch.TaskInvocation.<span class="keyword">run</span>(AbstractDispatcher.<span class="keyword">scala</span>:41)</span><br><span class="line">        at akka.dispatch.ForkJoinExecutorConfigurator<span class="label">$AkkaForkJoinTask</span>.exec(AbstractDispatcher.<span class="keyword">scala</span>:393)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.forkjoin.ForkJoinPool<span class="label">$WorkQueue</span>.runTask(ForkJoinPool.java:1339)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)</span><br><span class="line">        at <span class="keyword">scala</span>.concurrent.forkjoin.ForkJoinWorkerThread.<span class="keyword">run</span>(ForkJoinWorkerThread.java:107)</span><br><span class="line">15/07/02 09:04:09 INFO remote.RemoteActorRefProvider<span class="label">$RemotingTerminator</span>: Shutting down remote daemon.</span><br><span class="line">15/07/02 09:04:09 INFO remote.RemoteActorRefProvider<span class="label">$RemotingTerminator</span>: Remote daemon shut down; proceeding with flushing remote transports.</span><br><span class="line">15/07/02 09:04:09 INFO util.Utils: Shutdown hook called</span><br></pre></td></tr></table></figure>
<p>åŸå› åˆ†æ: SPARK_LOCAL_IPæŒ‡çš„æ˜¯æœ¬æœºIPåœ°å€,å› æ­¤åˆ†å‘åˆ°é›†ç¾¤çš„ä¸åŒèŠ‚ç‚¹ä¸Š,éƒ½è¦åˆ°å„è‡ªçš„èŠ‚ç‚¹ä¿®æ”¹ä¸ºè‡ªå·±çš„IPåœ°å€.<br>å¦‚æœé›†ç¾¤èŠ‚ç‚¹æ¯”è¾ƒå¤š,åˆ™æ¯”è¾ƒéº»çƒ¦, å¯ä»¥ç”¨SPARK_LOCAL_DIRSä»£æ›¿.</p>
<p><strong>2.å¦‚æœæ²¡æœ‰é…ç½®export MASTER, åœ¨workerä¸Šä¼šæŠ¥é”™:</strong>  </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span>/<span class="number">07</span>/<span class="number">02</span> <span class="number">08</span>:<span class="number">40</span>:<span class="number">51</span> INFO worker.Worker: Retrying connection <span class="keyword">to</span> master (attempt <span class="preprocessor"># 12)</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">02</span> <span class="number">08</span>:<span class="number">40</span>:<span class="number">51</span> INFO worker.Worker: Connecting <span class="keyword">to</span> master akka.tcp://sparkMaster<span class="constant">@dp0652</span>:<span class="number">7077</span>/user/Master...</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">02</span> <span class="number">08</span>:<span class="number">40</span>:<span class="number">51</span> WARN Remoting: Tried <span class="keyword">to</span> associate <span class="keyword">with</span> unreachable remote address [akka.tcp://sparkMaster<span class="constant">@dp0652</span>:<span class="number">7077</span>].</span><br><span class="line">Address is <span class="built_in">now</span> gated <span class="keyword">for</span> <span class="number">5000</span> ms, all messages <span class="keyword">to</span> this address will be delivered <span class="keyword">to</span> dead letters.</span><br><span class="line">Reason: æ‹’ç»è¿æ¥: dp0652/<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">7077</span></span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">02</span> <span class="number">08</span>:<span class="number">41</span>:<span class="number">23</span> ERROR worker.Worker: RECEIVED SIGNAL <span class="number">15</span>: SIGTERM</span><br><span class="line"><span class="number">15</span>/<span class="number">07</span>/<span class="number">02</span> <span class="number">08</span>:<span class="number">41</span>:<span class="number">23</span> INFO util.Utils: <span class="built_in">Shutdown</span> hook called</span><br></pre></td></tr></table></figure>
<p>å¯¼è‡´çš„åæœæ˜¯è™½ç„¶slavesä¸Šéƒ½å¯åŠ¨äº†Workerè¿›ç¨‹(ä½¿ç”¨jpsæŸ¥çœ‹),ä½†æ˜¯åœ¨Masterä¸Šå¹¶æ²¡æœ‰çœ‹åˆ°workers. è¿™æ—¶å€™åº”è¯¥æŸ¥çœ‹Masterä¸Šçš„æ—¥å¿—.<br>masterä¸Šå¯åŠ¨æˆåŠŸæ˜¾ç¤ºçš„æ—¥å¿—æ˜¯spark@dp0652:7077. è€Œä¸Šé¢å´æ˜¾ç¤ºçš„æ˜¯sparkMaster@dp0652:7077. æ‰€ä»¥åº”è¯¥æ‰‹åŠ¨export MASTER  </p>
<p><strong>3.æœ€åæˆåŠŸå¯åŠ¨é›†ç¾¤, åœ¨Masterä¸Šçš„æ—¥å¿—:</strong>  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Spark <span class="string">Command:</span> <span class="regexp">/usr/</span>java<span class="regexp">/jdk1.7.0_51/</span>bin<span class="regexp">/java -cp /</span>usr<span class="regexp">/install/</span>spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span><span class="regexp">/sbin/</span>..<span class="regexp">/conf/</span>:<span class="regexp">/usr/</span>install<span class="regexp">/spark-1.4.0-bin-hadoop2.6/</span>lib<span class="regexp">/spark-assembly-1.4.0-hadoop2.6.0.jar:/</span>usr<span class="regexp">/install/</span>spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span><span class="regexp">/lib/</span>datanucleus-rdbms-<span class="number">3.2</span><span class="number">.9</span>.<span class="string">jar:</span><span class="regexp">/usr/</span>install<span class="regexp">/spark-1.4.0-bin-hadoop2.6/</span>lib<span class="regexp">/datanucleus-core-3.2.10.jar:/</span>usr<span class="regexp">/install/</span>spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span><span class="regexp">/lib/</span>datanucleus-api-jdo-<span class="number">3.2</span><span class="number">.6</span>.<span class="string">jar:</span><span class="regexp">/usr/</span>install<span class="regexp">/hadoop/</span>etc<span class="regexp">/hadoop/</span>:<span class="regexp">/usr/</span>install<span class="regexp">/hadoop/</span>etc<span class="regexp">/hadoop/</span> -Xms512m -Xmx512m -<span class="string">XX:</span>MaxPermSize=<span class="number">128</span>m org.apache.spark.deploy.master.Master --ip dp0652 --port <span class="number">7077</span> --webui-port <span class="number">8082</span></span><br><span class="line">========================================</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">49</span> INFO master.<span class="string">Master:</span> Registered signal handlers <span class="keyword">for</span> [TERM, HUP, INT]</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">50</span> WARN util.<span class="string">NativeCodeLoader:</span> Unable to load native-hadoop library <span class="keyword">for</span> your platform... using builtin-java classes where applicable</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">50</span> INFO spark.<span class="string">SecurityManager:</span> Changing view acls <span class="string">to:</span> qihuang.zheng</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">50</span> INFO spark.<span class="string">SecurityManager:</span> Changing modify acls <span class="string">to:</span> qihuang.zheng</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">50</span> INFO spark.<span class="string">SecurityManager:</span> <span class="string">SecurityManager:</span> authentication disabled; ui acls disabled; users with view <span class="string">permissions:</span> Set(qihuang.zheng); users with modify <span class="string">permissions:</span> Set(qihuang.zheng)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO slf4j.<span class="string">Slf4jLogger:</span> Slf4jLogger started</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO <span class="string">Remoting:</span> Starting remoting</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO <span class="string">Remoting:</span> Remoting started; listening on <span class="string">addresses :</span>[akka.<span class="string">tcp:</span><span class="comment">//sparkMaster@dp0652:7077]</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO util.<span class="string">Utils:</span> Successfully started service <span class="string">'sparkMaster'</span> on port <span class="number">7077.</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO server.<span class="string">Server:</span> jetty-<span class="number">8.</span>y.z-SNAPSHOT</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO server.<span class="string">AbstractConnector:</span> Started SelectChannelConnector<span class="annotation">@dp</span><span class="number">0652:</span><span class="number">6066</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO util.<span class="string">Utils:</span> Successfully started service on port <span class="number">6066.</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO rest.<span class="string">StandaloneRestServer:</span> Started REST server <span class="keyword">for</span> submitting applications on port <span class="number">6066</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO master.<span class="string">Master:</span> Starting Spark master at <span class="string">spark:</span><span class="comment">//dp0652:7077</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO master.<span class="string">Master:</span> Running Spark version <span class="number">1.4</span><span class="number">.0</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO server.<span class="string">Server:</span> jetty-<span class="number">8.</span>y.z-SNAPSHOT</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO server.<span class="string">AbstractConnector:</span> Started SelectChannelConnector@<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8082</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO util.<span class="string">Utils:</span> Successfully started service <span class="string">'MasterUI'</span> on port <span class="number">8082.</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">51</span> INFO ui.<span class="string">MasterWebUI:</span> Started MasterWebUI at <span class="string">http:</span><span class="comment">//192.168.6.52:8082</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">52</span> INFO master.<span class="string">Master:</span> I have been elected leader! New <span class="string">state:</span> ALIVE</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">35398</span> with <span class="number">1</span> cores, <span class="number">20.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>:<span class="number">60106</span> with <span class="number">1</span> cores, <span class="number">8.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">50995</span> with <span class="number">1</span> cores, <span class="number">8.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>:<span class="number">55994</span> with <span class="number">1</span> cores, <span class="number">20.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">34020</span> with <span class="number">1</span> cores, <span class="number">8.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">55912</span> with <span class="number">1</span> cores, <span class="number">20.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> INFO master.<span class="string">Master:</span> Registering worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>:<span class="number">35846</span> with <span class="number">1</span> cores, <span class="number">20.0</span> GB RAM</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨53çš„å…¶ä¸­ä¸€ä¸ªWorkerä¸Šçš„æ—¥å¿—:</strong>  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Spark <span class="string">Command:</span> <span class="regexp">/usr/</span>java<span class="regexp">/jdk1.7.0_51/</span>bin<span class="regexp">/java -cp /</span>usr<span class="regexp">/install/</span>spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span><span class="regexp">/sbin/</span>..<span class="regexp">/conf/</span>:<span class="regexp">/usr/</span>install<span class="regexp">/spark-1.4.0-bin-hadoop2.6/</span>lib<span class="regexp">/spark-assembly-1.4.0-hadoop2.6.0.jar:/</span>usr<span class="regexp">/install/</span>spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span><span class="regexp">/lib/</span>datanucleus-api-jdo-<span class="number">3.2</span><span class="number">.6</span>.<span class="string">jar:</span><span class="regexp">/usr/</span>install<span class="regexp">/spark-1.4.0-bin-hadoop2.6/</span>lib<span class="regexp">/datanucleus-core-3.2.10.jar:/</span>usr<span class="regexp">/install/</span>spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span><span class="regexp">/lib/</span>datanucleus-rdbms-<span class="number">3.2</span><span class="number">.9</span>.<span class="string">jar:</span><span class="regexp">/usr/</span>install<span class="regexp">/hadoop/</span>etc<span class="regexp">/hadoop/</span>:<span class="regexp">/usr/</span>install<span class="regexp">/hadoop/</span>etc<span class="regexp">/hadoop/</span> -Xms512m -Xmx512m -<span class="string">XX:</span>MaxPermSize=<span class="number">128</span>m org.apache.spark.deploy.worker.Worker --webui-port <span class="number">8081</span> <span class="string">spark:</span><span class="comment">//dp0652:7077</span></span><br><span class="line">========================================</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">52</span> INFO worker.<span class="string">Worker:</span> Registered signal handlers <span class="keyword">for</span> [TERM, HUP, INT]</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">52</span> WARN util.<span class="string">NativeCodeLoader:</span> Unable to load native-hadoop library <span class="keyword">for</span> your platform... using builtin-java classes where applicable</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">52</span> INFO spark.<span class="string">SecurityManager:</span> Changing view acls <span class="string">to:</span> qihuang.zheng</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">52</span> INFO spark.<span class="string">SecurityManager:</span> Changing modify acls <span class="string">to:</span> qihuang.zheng</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">52</span> INFO spark.<span class="string">SecurityManager:</span> <span class="string">SecurityManager:</span> authentication disabled; ui acls disabled; users with view <span class="string">permissions:</span> Set(qihuang.zheng); users with modify <span class="string">permissions:</span> Set(qihuang.zheng)</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">53</span> INFO slf4j.<span class="string">Slf4jLogger:</span> Slf4jLogger started</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">53</span> INFO <span class="string">Remoting:</span> Starting remoting</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO <span class="string">Remoting:</span> Remoting started; listening on <span class="string">addresses :</span>[akka.<span class="string">tcp:</span><span class="comment">//sparkWorker@192.168.6.53:55994]</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO util.<span class="string">Utils:</span> Successfully started service <span class="string">'sparkWorker'</span> on port <span class="number">55994.</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO worker.<span class="string">Worker:</span> Starting Spark worker <span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>:<span class="number">55994</span> with <span class="number">1</span> cores, <span class="number">20.0</span> GB RAM</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO worker.<span class="string">Worker:</span> Running Spark version <span class="number">1.4</span><span class="number">.0</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO worker.<span class="string">Worker:</span> Spark <span class="string">home:</span> <span class="regexp">/usr/</span>install/spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO server.<span class="string">Server:</span> jetty-<span class="number">8.</span>y.z-SNAPSHOT</span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO server.<span class="string">AbstractConnector:</span> Started SelectChannelConnector@<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8081</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO util.<span class="string">Utils:</span> Successfully started service <span class="string">'WorkerUI'</span> on port <span class="number">8081.</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO ui.<span class="string">WorkerWebUI:</span> Started WorkerWebUI at <span class="string">http:</span><span class="comment">//192.168.6.53:8081</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO worker.<span class="string">Worker:</span> Connecting to master akka.<span class="string">tcp:</span><span class="comment">//sparkMaster@dp0652:7077/user/Master...</span></span><br><span class="line"><span class="number">15</span><span class="regexp">/07/</span><span class="number">02</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> INFO worker.<span class="string">Worker:</span> Successfully registered with master <span class="string">spark:</span><span class="comment">//dp0652:7077</span></span><br></pre></td></tr></table></figure>
<h3 id="spark-shell_&amp;_spark-submit">spark-shell &amp; spark-submit</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-shell --master spark:<span class="comment">//dp0652:7077 --executor-memory 4g</span></span><br><span class="line"></span><br><span class="line">bin/spark-submit --master spark:<span class="comment">//dp0652:7077 \</span></span><br><span class="line">  --<span class="keyword">class</span> org.apache.spark.examples.SparkPi \</span><br><span class="line">  --executor-memory <span class="number">4</span>g --total-executor-cores <span class="number">2</span> \</span><br><span class="line">  lib/spark-examples-<span class="number">1.4</span><span class="number">.0</span>-hadoop2<span class="number">.6</span><span class="number">.0</span>.jar <span class="number">1000</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spark/">spark</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-06-20-ElasticSearch" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-06-20-ElasticSearch/" class="article-date">
  	<time datetime="2015-12-01T10:02:07.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-06-20-ElasticSearch/">ElasticSearchå…¥é—¨</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="You_Know,_For_Search">You Know, For Search</h2><p><a href="http://www.elasticsearch.cn/" target="_blank" rel="external">http://www.elasticsearch.cn/</a></p>
<p>å¯åŠ¨ES: </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch</span><br></pre></td></tr></table></figure>
<p>Hello CRUD: </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç´¢å¼•. æ•°æ®åº“ä¸ºtwitter,è¡¨åä¸ºuser,ä¸»é”®ä¸ºkimchy,å­—æ®µnameå€¼ä¸ºShay Banon</span></span><br><span class="line">$ curl -XPUT http:<span class="comment">//localhost:9200/twitter/user/kimchy -d '&#123;</span></span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"Shay Banon"</span></span><br><span class="line">&#125;'</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç´¢å¼•ï¼Œå¤šä¸ªfield. ä¸»é”®ä¸º1,tweetè¡¨æœ‰ä¸‰ä¸ªå­—æ®µ:user,post_date,message</span></span><br><span class="line">$ curl -XPUT http:<span class="comment">//localhost:9200/twitter/tweet/1 -d '&#123;</span></span><br><span class="line">    <span class="string">"user"</span>: <span class="string">"kimchy"</span>,</span><br><span class="line">    <span class="string">"post_date"</span>: <span class="string">"2009-11-15T13:12:00"</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"Trying out elasticsearch, so far so good?"</span></span><br><span class="line">&#125;'</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç´¢å¼•ï¼Œæ³¨æ„urlé‡Œé¢çš„idæ˜¯ä¸ä¸€æ ·çš„å“¦. ä¸»é”®ä¸º2,å¦ä¸€æ¡è®°å½•</span></span><br><span class="line">$ curl -XPUT http:<span class="comment">//localhost:9200/twitter/tweet/2 -d '&#123;</span></span><br><span class="line">    <span class="string">"user"</span>: <span class="string">"kimchy"</span>,</span><br><span class="line">    <span class="string">"post_date"</span>: <span class="string">"2009-11-15T14:12:12"</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"You know, for Search"</span></span><br><span class="line">&#125;'</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç´¢å¼•, åŒä¸€ä¸ªidå†æ¬¡putç›¸å½“äºæ›´æ–°,version+1</span></span><br><span class="line">$ curl -XPUT http:<span class="comment">//localhost:9200/twitter/tweet/2 -d '&#123;</span></span><br><span class="line">    <span class="string">"user"</span>: <span class="string">"kimchy"</span>,</span><br><span class="line">    <span class="string">"post_date"</span>: <span class="string">"2009-11-15T14:12:12"</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"You know, for Search"</span></span><br><span class="line">&#125;'</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–: è·å–twitteræ•°æ®åº“ä¸­tweetè¡¨ä¸»é”®ä¸º2çš„è®°å½•</span></span><br><span class="line">$ curl -XGET http:<span class="comment">//localhost:9200/twitter/tweet/2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//luceneè¯­æ³•æ–¹å¼çš„æŸ¥è¯¢, æŸ¥è¯¢tweetè¡¨ä¸­userå­—æ®µ=kimchyçš„è®°å½•</span></span><br><span class="line">$ curl -XGET http:<span class="comment">//localhost:9200/twitter/tweet/_search?q=user:kimchy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//query DSLæ–¹å¼æŸ¥è¯¢, åŒä¸Š</span></span><br><span class="line">$ curl -XGET http:<span class="comment">//localhost:9200/twitter/tweet/_search -d '&#123;</span></span><br><span class="line">    <span class="string">"query"</span> : &#123;</span><br><span class="line">        <span class="string">"term"</span> : &#123; <span class="string">"user"</span>: <span class="string">"kimchy"</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br><span class="line"></span><br><span class="line"><span class="comment">//query DSLæ–¹å¼æŸ¥è¯¢, æŸ¥è¯¢post_dateåœ¨æŒ‡å®šèŒƒå›´å†…çš„è®°å½•é›†</span></span><br><span class="line">$ curl -XGET http:<span class="comment">//localhost:9200/twitter/_search?pretty=true -d '&#123;</span></span><br><span class="line">    <span class="string">"query"</span> : &#123;</span><br><span class="line">        <span class="string">"range"</span> : &#123;</span><br><span class="line">            <span class="string">"post_date"</span> : &#123;</span><br><span class="line">                <span class="string">"from"</span> : <span class="string">"2009-11-15T13:00:00"</span>,</span><br><span class="line">                <span class="string">"to"</span> : <span class="string">"2009-11-15T14:30:00"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Exampel</th>
<th>ElasticSearch</th>
<th>DataBases</th>
</tr>
</thead>
<tbody>
<tr>
<td>1 twitter</td>
<td>Index ğŸ‘‰</td>
<td>DataBase</td>
</tr>
<tr>
<td>2 tweet</td>
<td>Type ğŸ‘‰</td>
<td>Table</td>
</tr>
<tr>
<td>3 user,post_date,message</td>
<td>-</td>
<td>Field</td>
</tr>
</tbody>
</table>
<p>å¯¹åº”çš„ç»“æ„Mapping: <strong> <a href="http://localhost:9200/_all?pretty" target="_blank" rel="external">http://localhost:9200/_all?pretty</a> </strong></p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"twitter"</span> : &#123;							    <span class="number">1</span></span><br><span class="line">    <span class="string">"aliases"</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">"mappings"</span> : &#123;</span><br><span class="line">      <span class="string">"user"</span> : &#123;						  <span class="number">2</span></span><br><span class="line">        <span class="string">"properties"</span> : &#123;</span><br><span class="line">          <span class="string">"name"</span> : &#123;					<span class="number">3</span>ï¸</span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"string"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"tweet"</span> : &#123;					    <span class="number">2</span></span><br><span class="line">        <span class="string">"properties"</span> : &#123;</span><br><span class="line">          <span class="string">"message"</span> : &#123;				<span class="number">3</span></span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"string"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"post_date"</span> : &#123;			<span class="number">3</span></span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"date"</span>,</span><br><span class="line">            <span class="string">"format"</span> : <span class="string">"dateOptionalTime"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"user"</span> : &#123;					<span class="number">3</span></span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"string"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"settings"</span> : &#123;</span><br><span class="line">      <span class="string">"index"</span> : &#123;</span><br><span class="line">        <span class="string">"creation_date"</span> : <span class="string">"1435222918809"</span>,</span><br><span class="line">        <span class="string">"number_of_shards"</span> : <span class="string">"5"</span>,</span><br><span class="line">        <span class="string">"number_of_replicas"</span> : <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"version"</span> : &#123;</span><br><span class="line">          <span class="string">"created"</span> : <span class="string">"1060099"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"uuid"</span> : <span class="string">"jk1_iEyvTaibjDyLymZO5g"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"warmers"</span> : &#123; &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>æ—¥å¿—ä¿¡æ¯</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">âœ  elasticsearch-1.6.0  bin/elasticsearch</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:05,297</span>][<span class="link_reference">INFO </span>][<span class="link_label">node                     </span>] [Y'Garon] version[1.6.0], pid[5619], build[cdd3ac4/2015-06-09T13:36:34Z]</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:05,298</span>][<span class="link_reference">INFO </span>][<span class="link_label">node                     </span>] [Y'Garon] initializing ...</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:05,313</span>][<span class="link_reference">INFO </span>][<span class="link_label">plugins                  </span>] [Y'Garon] loaded [], sites []</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:05,517</span>][<span class="link_reference">INFO </span>][<span class="link_label">env                      </span>] [Y'Garon] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable<span class="emphasis">_space [61.3gb], net total_</span>space [111.8gb], types [hfs]</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:13,075</span>][<span class="link_reference">INFO </span>][<span class="link_label">node                     </span>] [Y'Garon] initialized</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:13,078</span>][<span class="link_reference">INFO </span>][<span class="link_label">node                     </span>] [Y'Garon] starting ...</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:13,457</span>][<span class="link_reference">INFO </span>][<span class="link_label">transport                </span>] [Y'Garon] bound<span class="emphasis">_address &#123;inet[/0:0:0:0:0:0:0:0:9300]&#125;, publish_</span>address &#123;inet[/192.168.7.130:9300]&#125;</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:13,532</span>][<span class="link_reference">INFO </span>][<span class="link_label">discovery                </span>] [Y'Garon] elasticsearch/5K_ytFi9QfGnt0aPACBo-A</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:17,368</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.service          </span>] [<span class="link_label">Y'Garon</span>] new<span class="emphasis">_master [Y'Garon][5K_</span>ytFi9QfGnt0aPACBo-A][<span class="link_label">zqhmac</span>][<span class="link_reference">inet[/192.168.7.130:9300</span>]], reason: zen-disco-join (elected<span class="emphasis">_as_</span>master)</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:17,399</span>][<span class="link_reference">INFO </span>][<span class="link_label">http                     </span>] [Y'Garon] bound<span class="emphasis">_address &#123;inet[/0:0:0:0:0:0:0:0:9200]&#125;, publish_</span>address &#123;inet[/192.168.7.130:9200]&#125;</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:17,399</span>][<span class="link_reference">INFO </span>][<span class="link_label">node                     </span>] [Y'Garon] started</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:17,419</span>][<span class="link_reference">INFO </span>][<span class="link_label">gateway                  </span>] [Y'Garon] recovered [0] indices into cluster_state</span><br><span class="line">[<span class="link_label">2015-06-25 17:01:59,932</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [twitter] creating index, cause [auto(index api)], templates [], shards [5]/[1], mappings [tweet]</span><br><span class="line">[<span class="link_label">2015-06-25 17:02:00,497</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [twitter] update_mapping [tweet] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:05:01,428</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [spark] creating index, cause [api], templates [], shards [5]/[1], mappings []</span><br><span class="line">[<span class="link_label">2015-06-25 17:05:02,010</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [spark] update_mapping [docs] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:05:03,284</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [spark] update_mapping [docs] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:05:03,402</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [spark] update_mapping [json-trips] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:17:11,309</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [twitter] update_mapping [user] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:25:32,611</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [my-collection] creating index, cause [auto(bulk api)], templates [], shards [5]/[1], mappings [game, music, book]</span><br><span class="line">[<span class="link_label">2015-06-25 17:25:32,800</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [my-collection] update_mapping [music] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:25:32,811</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [my-collection] update_mapping [book] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 17:25:32,819</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [my-collection] update_mapping [game] (dynamic)</span><br><span class="line">[<span class="link_label">2015-06-25 18:04:25,860</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [airports] creating index, cause [api], templates [], shards [5]/[1], mappings []</span><br><span class="line">[<span class="link_label">2015-06-25 18:04:26,148</span>][<span class="link_reference">INFO </span>][<span class="link_label">cluster.metadata         </span>] [Y'Garon] [airports] update_mapping [2015] (dynamic)</span><br></pre></td></tr></table></figure>
<h3 id="åŸºæœ¬æŸ¥è¯¢API">åŸºæœ¬æŸ¥è¯¢API</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">ğŸ‘‰ <span class="number">1.</span>æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“æ‰€æœ‰çš„è®°å½•æ•°</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_count</span></span><br><span class="line">&#123;<span class="string">"count"</span>:<span class="number">9</span>,<span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:<span class="number">10</span>,<span class="string">"successful"</span>:<span class="number">10</span>,<span class="string">"failed"</span>:<span class="number">0</span>&#125;&#125;%</span><br><span class="line"></span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_cat/count</span></span><br><span class="line"><span class="number">1435224149</span> <span class="number">17</span>:<span class="number">22</span>:<span class="number">29</span> <span class="number">9</span></span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">2.</span>æŸ¥è¯¢æ ¹è·¯å¾„ä¸‹éƒ½æœ‰å“ªäº›RESTæœåŠ¡</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_cat</span></span><br><span class="line">=^.^=</span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards</span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/master</span><br><span class="line">/_cat/nodes</span><br><span class="line">/_cat/indices</span><br><span class="line">/_cat/indices/&#123;index&#125;</span><br><span class="line">/_cat/segments</span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br><span class="line">/_cat/count</span><br><span class="line">/_cat/count/&#123;index&#125;</span><br><span class="line">/_cat/recovery</span><br><span class="line">/_cat/recovery/&#123;index&#125;</span><br><span class="line">/_cat/health</span><br><span class="line">/_cat/pending_tasks</span><br><span class="line">/_cat/aliases</span><br><span class="line">/_cat/aliases/&#123;alias&#125;</span><br><span class="line">/_cat/thread_pool</span><br><span class="line">/_cat/plugins</span><br><span class="line">/_cat/fielddata</span><br><span class="line">/_cat/fielddata/&#123;fields&#125;</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">3.</span>ESæ‰€æœ‰ä¿¡æ¯</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_all</span></span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">4.</span>æŸ¥è¯¢éƒ½æœ‰å“ªäº›æ•°æ®åº“. å…¶ä¸­indexå¯¹åº”äº†DB</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_cat/indices</span></span><br><span class="line">yellow open spark   <span class="number">5</span> <span class="number">1</span> <span class="number">6</span> <span class="number">0</span>  <span class="number">16</span>kb  <span class="number">16</span>kb</span><br><span class="line">yellow open twitter <span class="number">5</span> <span class="number">1</span> <span class="number">3</span> <span class="number">0</span> <span class="number">8.7</span>kb <span class="number">8.7</span>kb</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">5.</span>æŸ¥è¯¢æ•°æ®åº“ä¸‹æœ‰å“ªäº›è¡¨</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark</span></span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">6.</span>æŸ¥è¯¢æ•°æ®åº“çš„è®°å½•æ•°</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark/_count</span></span><br><span class="line">&#123;<span class="string">"count"</span>:<span class="number">6</span>,<span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:<span class="number">5</span>,<span class="string">"successful"</span>:<span class="number">5</span>,<span class="string">"failed"</span>:<span class="number">0</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">7.</span>æŸ¥è¯¢æ•°æ®åº“ä¸‹æŸå¼ è¡¨çš„è®°å½•æ•°, è¡¨çš„ä¿¡æ¯ä»<span class="number">5.</span>ä¸­å¾—åˆ°</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark/people/_count</span></span><br><span class="line"></span><br><span class="line">ğŸ‘‰ <span class="number">8.</span>æŸ¥è¯¢æ•°æ®åº“æŸå¼ è¡¨çš„æ‰€æœ‰è®°å½•</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark/people/_search?q=*&amp;pretty</span></span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark/people/_search?petty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : <span class="number">9</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">"successful"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">3</span>,</span><br><span class="line">    <span class="string">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="string">"hits"</span> : [ &#123;</span><br><span class="line">      <span class="string">"_index"</span> : <span class="string">"spark"</span>,</span><br><span class="line">      <span class="string">"_type"</span> : <span class="string">"people"</span>,</span><br><span class="line">      <span class="string">"_id"</span> : <span class="string">"AU4tjNnbu9a9LJalW5X9"</span>,</span><br><span class="line">      <span class="string">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="string">"_source"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Andy"</span>,<span class="string">"surname"</span>:<span class="string">"Feng"</span>,<span class="string">"age"</span>:<span class="number">30</span>&#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="string">"_index"</span> : <span class="string">"spark"</span>,</span><br><span class="line">      <span class="string">"_type"</span> : <span class="string">"people"</span>,</span><br><span class="line">      <span class="string">"_id"</span> : <span class="string">"AU4tjNnbu9a9LJalW5X8"</span>,</span><br><span class="line">      <span class="string">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="string">"_source"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Michael"</span>,<span class="string">"surname"</span>:<span class="string">"Jackson"</span>,<span class="string">"age"</span>:<span class="number">29</span>&#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="string">"_index"</span> : <span class="string">"spark"</span>,</span><br><span class="line">      <span class="string">"_type"</span> : <span class="string">"people"</span>,</span><br><span class="line">      <span class="string">"_id"</span> : <span class="string">"AU4tjNnbu9a9LJalW5X-"</span>,</span><br><span class="line">      <span class="string">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="string">"_source"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Justin"</span>,<span class="string">"surname"</span>:<span class="string">"Beeper"</span>,<span class="string">"age"</span>:<span class="number">19</span>&#125;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ æŸ¥è¯¢æŸå¼ è¡¨æ‰€æœ‰å­—æ®µçš„æŸä¸ªå€¼</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark/people/_search?q=*s*</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : <span class="number">12</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">"successful"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="string">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="string">"hits"</span> : [ &#123;</span><br><span class="line">      <span class="string">"_index"</span> : <span class="string">"spark"</span>,</span><br><span class="line">      <span class="string">"_type"</span> : <span class="string">"people"</span>,</span><br><span class="line">      <span class="string">"_id"</span> : <span class="string">"AU4tjNnbu9a9LJalW5X8"</span>,</span><br><span class="line">      <span class="string">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="string">"_source"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Michael"</span>,<span class="string">"surname"</span>:<span class="string">"Jackson"</span>,<span class="string">"age"</span>:<span class="number">29</span>&#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="string">"_index"</span> : <span class="string">"spark"</span>,</span><br><span class="line">      <span class="string">"_type"</span> : <span class="string">"people"</span>,</span><br><span class="line">      <span class="string">"_id"</span> : <span class="string">"AU4tjNnbu9a9LJalW5X-"</span>,</span><br><span class="line">      <span class="string">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="string">"_source"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Justin"</span>,<span class="string">"surname"</span>:<span class="string">"Beeper"</span>,<span class="string">"age"</span>:<span class="number">19</span>&#125;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ æŸ¥è¯¢æŸå¼ è¡¨æŸä¸ªå­—æ®µçš„å€¼</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/spark/people/_search?q=name:*ch*&amp;pretty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : <span class="number">14</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">"successful"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="string">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="string">"hits"</span> : [ &#123;</span><br><span class="line">      <span class="string">"_index"</span> : <span class="string">"spark"</span>,</span><br><span class="line">      <span class="string">"_type"</span> : <span class="string">"people"</span>,</span><br><span class="line">      <span class="string">"_id"</span> : <span class="string">"AU4tjNnbu9a9LJalW5X8"</span>,</span><br><span class="line">      <span class="string">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="string">"_source"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Michael"</span>,<span class="string">"surname"</span>:<span class="string">"Jackson"</span>,<span class="string">"age"</span>:<span class="number">29</span>&#125;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>URL</th>
<th>Tips</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://localhost:9200" target="_blank" rel="external">http://localhost:9200</a></td>
<td>éªŒè¯å®‰è£…æˆåŠŸ</td>
</tr>
<tr>
<td><a href="http://localhost:9200/_count" target="_blank" rel="external">http://localhost:9200/_count</a></td>
<td>ESæ‰€æœ‰è®°å½•æ•°</td>
</tr>
<tr>
<td><a href="http://localhost:9200/_cat" target="_blank" rel="external">http://localhost:9200/_cat</a></td>
<td>RESTæœåŠ¡</td>
</tr>
<tr>
<td><a href="http://localhost:9200/_cat/indices" target="_blank" rel="external">http://localhost:9200/_cat/indices</a></td>
<td>ESæ‰€æœ‰æ•°æ®åº“æ¦‚è§ˆ</td>
</tr>
<tr>
<td><a href="http://localhost:9200/spark" target="_blank" rel="external">http://localhost:9200/spark</a></td>
<td>æŒ‡å®šæ•°æ®åº“spark</td>
</tr>
<tr>
<td><a href="http://localhost:9200/spark/_count" target="_blank" rel="external">http://localhost:9200/spark/_count</a></td>
<td>æŒ‡å®šæ•°æ®åº“sparkçš„è®°å½•æ•°</td>
</tr>
<tr>
<td><a href="http://localhost:9200/spark/people/_count" target="_blank" rel="external">http://localhost:9200/spark/people/_count</a></td>
<td>æŒ‡å®šæ•°æ®åº“sparkæŒ‡å®šè¡¨peopleçš„è®°å½•æ•°</td>
</tr>
<tr>
<td><a href="http://localhost:9200/spark/people/_search" target="_blank" rel="external">http://localhost:9200/spark/people/_search</a></td>
<td>æŸ¥è¯¢æŒ‡å®šæ•°æ®åº“æŒ‡å®šè¡¨çš„æ‰€æœ‰è®°å½•</td>
</tr>
<tr>
<td><a href="http://localhost:9200/spark/people/_search/q=*" target="_blank" rel="external">http://localhost:9200/spark/people/_search/q=*</a></td>
<td>æŸ¥è¯¢æŒ‡å®šæ•°æ®åº“æŒ‡å®šè¡¨çš„æ‰€æœ‰è®°å½•</td>
</tr>
<tr>
<td><a href="http://localhost:9200/spark/people/_search/q=name:*a*" target="_blank" rel="external">http://localhost:9200/spark/people/_search/q=name:*a*</a></td>
<td>æŸ¥è¯¢æŸå¼ è¡¨nameå­—æ®µåŒ¹é…<em>a</em>çš„è®°å½•</td>
</tr>
</tbody>
</table>
<h2 id="spark-es-hdfs">spark-es-hdfs</h2><p><a href="http://chenlinux.com/2014/09/04/spark-to-elasticsearch/" target="_blank" rel="external">http://chenlinux.com/2014/09/04/spark-to-elasticsearch/</a></p>
<h3 id="1-_How_to_Get_the_Schema_when_only_get_the_ES_IP">1. How to Get the Schema when only get the ES IP</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢éƒ½æœ‰å“ªäº›æ•°æ®åº“</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_cat/indices</span></span><br><span class="line">green forseti-<span class="number">20140526</span> <span class="number">2</span> <span class="number">1</span>    <span class="number">30056</span>      <span class="number">6</span> <span class="number">125.6</span>mb  <span class="number">62.7</span>mb</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">æŸ¥è¯¢æ€»çš„è®°å½•æ•°</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/_count</span></span><br><span class="line">&#123;<span class="string">"count"</span>:<span class="number">631463275</span>,<span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:<span class="number">201</span>,<span class="string">"successful"</span>:<span class="number">201</span>,<span class="string">"failed"</span>:<span class="number">0</span>&#125;&#125;%</span><br><span class="line"></span><br><span class="line">é€‰å‡ºå…¶ä¸­ä¸€ä¸ªæ•°æ®åº“æ¯”å¦‚forseti-<span class="number">20140417</span></span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/forseti-20140407</span></span><br><span class="line"></span><br><span class="line">è·å–è¿™ä¸ªæ•°æ®åº“è¡¨activityçš„è®°å½•æ•°,è¡¨åå¯ä»¥ä»ä¸Šä¸€æ­¥å¾—åˆ°</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/forseti-20140407/activity/_count</span></span><br><span class="line">&#123;<span class="string">"count"</span>:<span class="number">118</span>,<span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:<span class="number">2</span>,<span class="string">"successful"</span>:<span class="number">2</span>,<span class="string">"failed"</span>:<span class="number">0</span>&#125;&#125;%</span><br><span class="line"></span><br><span class="line">æŸ¥è¯¢è¿™ä¸ªæ•°æ®åº“çš„å…¨éƒ¨æ•°æ®, åªå…³å¿ƒhits.hits.source, å°±æ˜¯æ–‡æ¡£çš„è¡¨ç»“æ„</span><br><span class="line">âœ  ~  curl http:<span class="comment">//localhost:9200/forseti-20140407/activity/_search\?pretty</span></span><br><span class="line"><span class="string">"_source"</span>: &#123;</span><br><span class="line">  <span class="string">"geo"</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"device"</span>: &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Python_ES">Python ES</h3><p>1.Build an Elasticsearch Index with Python:<br><a href="http://blog.qbox.io/building-an-elasticsearch-index-with-python" target="_blank" rel="external">http://blog.qbox.io/building-an-elasticsearch-index-with-python</a>  </p>
<p>2.Elasticsearch in Apache Spark with Python:<br><a href="http://blog.qbox.io/elasticsearch-in-apache-spark-python" target="_blank" rel="external">http://blog.qbox.io/elasticsearch-in-apache-spark-python</a>  </p>
<p>3.Deploying Elasticsearch and Apache Spark to the Cloud:<br><a href="http://blog.qbox.io/deploy-elasticsearch-and-apache-spark-to-the-cloud" target="_blank" rel="external">http://blog.qbox.io/deploy-elasticsearch-and-apache-spark-to-the-cloud</a>  </p>
<p>4.Sparse Matrix Multiplication with Elasticsearch and Apache Spark:<br><a href="http://blog.qbox.io/sparse-matrix-multiplication-elasticsearch-apache-spark" target="_blank" rel="external">http://blog.qbox.io/sparse-matrix-multiplication-elasticsearch-apache-spark</a>  </p>
<p>5.Rectangular Matrix Multiplication with Elasticsearch and Apache Spark:<br><a href="http://blog.qbox.io/rectangular-matrix-multiplication-elasticsearch-apache-spark" target="_blank" rel="external">http://blog.qbox.io/rectangular-matrix-multiplication-elasticsearch-apache-spark</a>  </p>
<p>6.Running Asynchronous Apache Spark Jobs from a Web App with Flask, Celery, &amp; Elasticsearch:<br><a href="http://blog.qbox.io/asynchronous-apache-spark-flask-celery-elasticsearch" target="_blank" rel="external">http://blog.qbox.io/asynchronous-apache-spark-flask-celery-elasticsearch</a> </p>
<p>å¯¼å…¥JSONæ•°æ®:  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~  curl -XPOST <span class="string">'http://192.168.6.140:9200/forseti-201501/activity/'</span> -d @<span class="regexp">/Users/</span>zhengqh<span class="regexp">/data/</span>koudai_201501.json</span><br><span class="line">&#123;<span class="string">"_index"</span>:<span class="string">"forseti-201501"</span>,<span class="string">"_type"</span>:<span class="string">"activity"</span>,<span class="string">"_id"</span>:<span class="string">"AU4"</span>,<span class="string">"_version"</span>:<span class="number">1</span>,<span class="string">"created"</span>:<span class="keyword">true</span>&#125;%                                                                                             </span><br><span class="line">âœ  ~  curl -XDELETE <span class="string">'http://192.168.6.140:9200/forseti-201501/activity/'</span></span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="keyword">true</span>&#125;%</span><br></pre></td></tr></table></figure>
<h3 id="2-_Spark-ES_Demo">2. Spark-ES Demo</h3><p>spark-shellæ–¹å¼:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ  spark-<span class="number">1.4</span><span class="number">.0</span>-bin-hadoop2<span class="number">.6</span>  bin/spark-shell --master local[<span class="number">2</span>] \</span><br><span class="line">   --jars /Users/zhengqh/Downloads/bigdata/elasticsearch-hadoop-<span class="number">2.1</span><span class="number">.0</span>.rc1.jar</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">29</span> <span class="number">11</span>:<span class="number">17</span>:<span class="number">16</span> INFO spark.SparkContext: Added JAR file:/Users/zhengqh/Downloads/bigdata/elasticsearch-hadoop-<span class="number">2.1</span><span class="number">.0</span>.rc1.jar at http:<span class="comment">//192.168.6.140:52359/jars/elasticsearch-hadoop-2.1.0.rc1.jar with timestamp 1435547836823</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-2015-06-20-Apache-Drill" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/01/2015-06-20-Apache-Drill/" class="article-date">
  	<time datetime="2015-12-01T10:02:04.000Z" itemprop="datePublished">2015-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/01/2015-06-20-Apache-Drill/">Apache-Drillå…¥é—¨</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="å•æœºæ¨¡å¼">å•æœºæ¨¡å¼</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="comment">@dp0653 ~]$ cd apache-drill-1.0.0</span></span><br><span class="line">[qihuang.zheng<span class="comment">@dp0653 apache-drill-1.0.0]$ bin/drill-embedded</span></span><br><span class="line">apache drill 1.0.0</span><br><span class="line"><span class="string">"json ain't no thang"</span></span><br><span class="line">0: jdbc:drill:zk&gt; select <span class="keyword">*</span> from cp.`employee.json` limit 2;</span><br><span class="line">+--------------+------------------+-------------+------------+--------------+---------------------+-----------+----------------+-------------+------------------------+----------+----------------+------------------+-----------------+---------+--------------------+</span><br><span class="line">|<span class="string"> employee_id  </span>|<span class="string">    full_name     </span>|<span class="string"> first_name  </span>|<span class="string"> last_name  </span>|<span class="string"> position_id  </span>|<span class="string">   position_title    </span>|<span class="string"> store_id  </span>|<span class="string"> department_id  </span>|<span class="string"> birth_date  </span>|<span class="string">       hire_date        </span>|<span class="string">  salary  </span>|<span class="string"> supervisor_id  </span>|<span class="string"> education_level  </span>|<span class="string"> marital_status  </span>|<span class="string"> gender  </span>|<span class="string">  management_role   </span>|</span><br><span class="line">+--------------+------------------+-------------+------------+--------------+---------------------+-----------+----------------+-------------+------------------------+----------+----------------+------------------+-----------------+---------+--------------------+</span><br><span class="line">|<span class="string"> 1            </span>|<span class="string"> Sheri Nowmer     </span>|<span class="string"> Sheri       </span>|<span class="string"> Nowmer     </span>|<span class="string"> 1            </span>|<span class="string"> President           </span>|<span class="string"> 0         </span>|<span class="string"> 1              </span>|<span class="string"> 1961-08-26  </span>|<span class="string"> 1994-12-01 00:00:00.0  </span>|<span class="string"> 80000.0  </span>|<span class="string"> 0              </span>|<span class="string"> Graduate Degree  </span>|<span class="string"> S               </span>|<span class="string"> F       </span>|<span class="string"> Senior Management  </span>|</span><br><span class="line">|<span class="string"> 2            </span>|<span class="string"> Derrick Whelply  </span>|<span class="string"> Derrick     </span>|<span class="string"> Whelply    </span>|<span class="string"> 2            </span>|<span class="string"> VP Country Manager  </span>|<span class="string"> 0         </span>|<span class="string"> 1              </span>|<span class="string"> 1915-07-03  </span>|<span class="string"> 1994-12-01 00:00:00.0  </span>|<span class="string"> 40000.0  </span>|<span class="string"> 1              </span>|<span class="string"> Graduate Degree  </span>|<span class="string"> M               </span>|<span class="string"> M       </span>|<span class="string"> Senior Management  </span>|</span><br><span class="line">+--------------+------------------+-------------+------------+--------------+---------------------+-----------+----------------+-------------+------------------------+----------+----------------+------------------+-----------------+---------+--------------------+</span><br><span class="line">2 rows selected (1.247 seconds)</span><br></pre></td></tr></table></figure>
<p>drillä½¿ç”¨zookeeperè¿›è¡Œé›†ç¾¤. å…¶ä¸­localè¡¨ç¤ºä½¿ç”¨æœ¬æœºçš„zk.</p>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨sqllineå¯åŠ¨:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@dp</span>0653 apache-drill-<span class="number">1.0</span><span class="number">.0</span>]$ bin/sqlline -u <span class="string">jdbc:</span><span class="string">drill:</span>zk=local</span><br><span class="line"><span class="string">log4j:</span>WARN No appenders could be found <span class="keyword">for</span> logger (DataNucleus.General).</span><br><span class="line"><span class="string">log4j:</span>WARN Please initialize the log4j system properly.</span><br><span class="line"><span class="string">log4j:</span>WARN See <span class="string">http:</span><span class="comment">//logging.apache.org/log4j/1.2/faq.html#noconfig for more info.</span></span><br><span class="line">å…­æœˆ <span class="number">15</span>, <span class="number">2015</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">18</span> ä¸Šåˆ org.glassfish.jersey.server.ApplicationHandler initialize</span><br><span class="line">ä¿¡æ¯: Initiating Jersey application, version <span class="string">Jersey:</span> <span class="number">2.8</span> <span class="number">2014</span>-<span class="number">04</span>-<span class="number">29</span> <span class="number">01</span>:<span class="number">25</span>:<span class="number">26.</span>..</span><br><span class="line">apache drill <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">"a drill in the hand is better than two in the bush"</span></span><br><span class="line"><span class="number">0</span>: <span class="string">jdbc:</span><span class="string">drill:</span>zk=local&gt;</span><br></pre></td></tr></table></figure>
<p>é€€å‡ºdrillçš„æ–¹å¼:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:drill:zk=local&gt; !quit</span><br><span class="line">Closing: org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.jdbc</span><span class="class">.DrillJdbc41Factory</span><span class="variable">$DrillJdbc41Connection</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨åå°è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 apache-drill-1.0.0]$ bin/drillbit.sh <span class="operator"><span class="keyword">start</span></span><br><span class="line"><span class="keyword">starting</span> drillbit, <span class="keyword">logging</span> <span class="keyword">to</span> /home/qihuang.zheng/apache-drill-<span class="number">1.0</span><span class="number">.0</span>/<span class="keyword">log</span>/drillbit.<span class="keyword">out</span></span></span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹drillè¿›ç¨‹</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 apache-drill-<span class="number">1.0</span>.<span class="number">0</span>]$ jps -lm</span><br><span class="line"><span class="number">2788</span> org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.exec</span><span class="class">.server</span><span class="class">.Drillbit</span></span><br><span class="line"><span class="number">3045</span> sqlline<span class="class">.SqlLine</span> -d org<span class="class">.apache</span><span class="class">.drill</span><span class="class">.jdbc</span><span class="class">.Driver</span> --maxWidth=<span class="number">10000</span> --<span class="attribute">color</span>=true -u jdbc:drill:zk=local</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªæ˜¯drillbitçš„åå°è¿›ç¨‹, ç¬¬äºŒä¸ªæ˜¯ä½¿ç”¨sqllineæˆ–è€…dril-embbedå¯åŠ¨çš„å®¢æˆ·ç«¯è¿›ç¨‹</p>
<h2 id="Storage_Plugin">Storage Plugin</h2><p>cpæ˜¯classpath storage plugin, drillçš„web ui: <a href="http://192.168.6.53:8047/storage" target="_blank" rel="external">http://192.168.6.53:8047/storage</a><br>Drillæ”¯æŒä¸åŒçš„å­˜å‚¨ä»‹è´¨, å¹¶ä¸”å¯ä»¥ä»ä¸åŒçš„å­˜å‚¨ä»‹è´¨ä¸­ä½¿ç”¨SQLæŸ¥è¯¢æ•°æ®.</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150616-2@2x.png" alt="Storage Plugin"></p>
<p>é»˜è®¤åªæœ‰cpå’Œdfsæ˜¯enableçš„. åœ¨Diabled Storage Pluginsä¸­ç‚¹å‡»æŸä¸ªæ’ä»¶çš„Enable, å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­˜å‚¨æ’ä»¶äº†</p>
<h3 id="æ·»åŠ HDFSæ’ä»¶">æ·»åŠ HDFSæ’ä»¶</h3><p>é»˜è®¤æ²¡æœ‰hdfs, å¯ä»¥åœ¨New Storage Pluginä¸­è¾“å…¥hdfs, ç‚¹å‡»Create, åœ¨Configurationä¸­è¾“å…¥hdfsçš„å­˜å‚¨æ’ä»¶é…ç½®ä¿¡æ¯:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">type</span>": <span class="value"><span class="string">"file"</span></span>,</span><br><span class="line">  "<span class="attribute">enabled</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">  "<span class="attribute">connection</span>": <span class="value"><span class="string">"hdfs://192.168.6.53:9000/"</span></span>,</span><br><span class="line">  "<span class="attribute">workspaces</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">root</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">location</span>": <span class="value"><span class="string">"/"</span></span>,</span><br><span class="line">      "<span class="attribute">writable</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">      "<span class="attribute">defaultInputFormat</span>": <span class="value"><span class="literal">null</span></span><br><span class="line">    </span>&#125;</span><br><span class="line">  </span>&#125;</span>,</span><br><span class="line">  "<span class="attribute">formats</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">csv</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>": <span class="value"><span class="string">"text"</span></span>,</span><br><span class="line">      "<span class="attribute">extensions</span>": <span class="value">[</span><br><span class="line">        <span class="string">"csv"</span></span><br><span class="line">      ]</span>,</span><br><span class="line">      "<span class="attribute">delimiter</span>": <span class="value"><span class="string">","</span></span><br><span class="line">    </span>&#125;</span>,</span><br><span class="line">    "<span class="attribute">tsv</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>": <span class="value"><span class="string">"text"</span></span>,</span><br><span class="line">      "<span class="attribute">extensions</span>": <span class="value">[</span><br><span class="line">        <span class="string">"tsv"</span></span><br><span class="line">      ]</span>,</span><br><span class="line">      "<span class="attribute">delimiter</span>": <span class="value"><span class="string">"\t"</span></span><br><span class="line">    </span>&#125;</span>,</span><br><span class="line">    "<span class="attribute">parquet</span>": <span class="value">&#123;</span><br><span class="line">      "<span class="attribute">type</span>": <span class="value"><span class="string">"parquet"</span></span><br><span class="line">    </span>&#125;</span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯HDFS HAçš„æ¨¡å¼, ä¹Ÿå¯ä»¥æ”¯æŒ: <code>hdfs://tdhdfs</code>, è¿˜å¯ä»¥æ·»åŠ workspaces</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"tmp"</span>: &#123;</span><br><span class="line">  <span class="string">"location"</span>: <span class="string">"/user/qihuang.zheng"</span>,</span><br><span class="line">  <span class="string">"writable"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"defaultInputFormat"</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è·¯å¾„(dfså’Œhdfs)">è·¯å¾„(dfså’Œhdfs)</h3><p>è®¾ç½®dfsæ’ä»¶çš„å·¥ä½œç›®å½•: ç‚¹å‡»dfsæ’ä»¶çš„Update, æ·»åŠ workç›®å½•, ç„¶åç‚¹å‡»Update</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"connection"</span>: <span class="string">"file:///"</span>,</span><br><span class="line"><span class="string">"workspaces"</span>: &#123;</span><br><span class="line">  <span class="string">"root"</span>: &#123;</span><br><span class="line">    <span class="string">"location"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="string">"writable"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"defaultInputFormat"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tmp"</span>: &#123;</span><br><span class="line">    <span class="string">"location"</span>: <span class="string">"/tmp"</span>,</span><br><span class="line">    <span class="string">"writable"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"defaultInputFormat"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"work"</span>: &#123;</span><br><span class="line">    <span class="string">"location"</span>: <span class="string">"/home/qihuang.zheng/apache-drill-1.0.0/"</span>,</span><br><span class="line">    <span class="string">"writable"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"defaultInputFormat"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>å¯¹äºhdfsä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„å·¥ä½œç©ºé—´æ¯”å¦‚work=/user/zhengqh. åˆ™å®šä½åˆ°/user/zhengqhä¸‹,ç›´æ¥ä½¿ç”¨hfs.workè¿›è¡ŒæŸ¥è¯¢</p>
<h3 id="DFSæ–‡ä»¶">DFSæ–‡ä»¶</h3><p>ä¸‹é¢æµ‹è¯•äº†ä½¿ç”¨ä¸åŒçš„è·¯å¾„æŸ¥è¯¢drillå®‰è£…ç›®å½•ä¸‹sample-dataä¸‹çš„parquetæ–‡ä»¶</p>
<ul>
<li>æ²¡æœ‰ä½¿ç”¨å®šä¹‰å¥½çš„workå·¥ä½œç›®å½•,å¯¼è‡´æ— æ³•æ‰¾åˆ°æ–‡ä»¶</li>
<li>ä½¿ç”¨äº†è‡ªå®šä¹‰çš„workç›®å½•(æ³¨æ„workçš„ä½¿ç”¨æ–¹å¼: dfs.work.``), ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¹Ÿèƒ½æ‰¾åˆ°æ–‡ä»¶</li>
<li>ç»å¯¹è·¯å¾„</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:drill:zk&gt; select * from dfs.<span class="code">`sample-data/region.parquet`</span> limit 2;</span><br><span class="line">Error: PARSE ERROR: From line 1, column 15 to line 1, column 17: Table <span class="emphasis">'dfs.sample-data/region.parquet'</span> not found</span><br><span class="line">[Error Id: a1e53ed6-cc07-4799-9e9f-a7b112bb4e36 on dp0657:31010] (state=,code=0)</span><br><span class="line"></span><br><span class="line"><span class="header">0: jdbc:drill:zk&gt; select * from dfs.work.`sample-data/region.parquet` limit 2;</span><br><span class="line">+--------------+----------+-----------------------+</span></span><br><span class="line"><span class="header">| R_REGIONKEY  |  R_NAME  |       R_COMMENT       |</span><br><span class="line">+--------------+----------+-----------------------+</span></span><br><span class="line">| 0            | AFRICA   | lar deposits. blithe  |</span><br><span class="line"><span class="header">| 1            | AMERICA  | hs use ironic, even   |</span><br><span class="line">+--------------+----------+-----------------------+</span></span><br><span class="line">2 rows selected (0.338 seconds)</span><br><span class="line"></span><br><span class="line"><span class="header">0: jdbc:drill:zk&gt; select * from dfs.`/home/qihuang.zheng/apache-drill-1.0.0/sample-data/region.parquet` limit 2;</span><br><span class="line">+--------------+----------+-----------------------+</span></span><br><span class="line"><span class="header">| R_REGIONKEY  |  R_NAME  |       R_COMMENT       |</span><br><span class="line">+--------------+----------+-----------------------+</span></span><br><span class="line">| 0            | AFRICA   | lar deposits. blithe  |</span><br><span class="line"><span class="header">| 1            | AMERICA  | hs use ironic, even   |</span><br><span class="line">+--------------+----------+-----------------------+</span></span><br><span class="line">2 rows selected (0.235 seconds)</span><br></pre></td></tr></table></figure>
<h3 id="HDFSæ–‡ä»¶">HDFSæ–‡ä»¶</h3><ul>
<li>ç¬¬ä¸€ä¸ªæŸ¥è¯¢ç›´æ¥ä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„, å› ä¸ºé»˜è®¤çš„hdfsæ’ä»¶çš„rootæŒ‡å‘çš„æ˜¯/, è€Œå®ƒçš„connectioné…ç½®è·¯å¾„æ˜¯: hdfs://192.168.6.53:9000/.</li>
<li>ç¬¬äºŒä¸ªæŸ¥è¯¢ä½¿ç”¨äº†ç»å¯¹è·¯å¾„</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">0: jdbc:drill:zk&gt; select count(*) from hdfs.`user/admin/evidence`;</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">|  EXPR$0  |</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">| 4003278  |</span><br><span class="line">+----------+</span></span><br><span class="line">1 row selected (0.586 seconds)</span><br><span class="line"><span class="header">0: jdbc:drill:zk&gt; select count(*) from hdfs.`hdfs://tdhdfs/user/admin/evidence`;</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">|  EXPR$0  |</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">| 4003278  |</span><br><span class="line">+----------+</span></span><br><span class="line">1 row selected (0.278 seconds)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹: å¯ä»¥ç›´æ¥æŸ¥è¯¢æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶. ä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶å¤¹ä¸‹çš„å­æ–‡ä»¶å¤¹éƒ½å¯ä»¥</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 ~]$ /usr/install/hadoop/bin/hadoop fs -ls /user/admin/evidence</span><br><span class="line"><span class="number">15</span>/<span class="number">06</span>/<span class="number">17</span> <span class="number">08</span>:<span class="number">25</span>:<span class="number">37</span> WARN util.NativeCodeLoader: Unable to load native-hadoop library <span class="keyword">for</span> your platform... <span class="keyword">using</span> builtin-java classes where applicable</span><br><span class="line">Found <span class="number">4</span> items</span><br><span class="line">-rw-r--r--   <span class="number">3</span> shuoyi.zhao supergroup   <span class="number">67561800</span> <span class="number">2015</span>-<span class="number">05</span>-<span class="number">21</span> <span class="number">10</span>:<span class="number">49</span> /user/admin/evidence/<span class="number">4</span>b75f114-<span class="number">7f</span>64-<span class="number">40</span>df-<span class="number">9f</span>f6-<span class="number">11</span>a1e75637a7.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> shuoyi.zhao supergroup   <span class="number">96528887</span> <span class="number">2015</span>-<span class="number">05</span>-<span class="number">21</span> <span class="number">10</span>:<span class="number">49</span> /user/admin/evidence/bdb0bdb4-fa04-<span class="number">402f</span>-af05-b2aea02728ed.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> shuoyi.zhao supergroup   <span class="number">80968799</span> <span class="number">2015</span>-<span class="number">05</span>-<span class="number">21</span> <span class="number">10</span>:<span class="number">49</span> /user/admin/evidence/da1439fc-<span class="number">0</span>c32-<span class="number">4</span>cd8-<span class="number">90f</span>2-<span class="number">67</span>d24dbaa6cc.parquet</span><br><span class="line">-rw-r--r--   <span class="number">3</span> shuoyi.zhao supergroup  <span class="number">136852232</span> <span class="number">2015</span>-<span class="number">05</span>-<span class="number">21</span> <span class="number">10</span>:<span class="number">50</span> /user/admin/evidence/f0954a8f-<span class="number">583</span>b-<span class="number">4173</span>-<span class="number">9</span>b89-<span class="number">55</span>ed3107daf1.parquet</span><br></pre></td></tr></table></figure>
<h3 id="å¤æ‚SQLæŸ¥è¯¢">å¤æ‚SQLæŸ¥è¯¢</h3><ol>
<li>ä¸¤è¡¨joinæŸ¥è¯¢</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> nations.<span class="keyword">name</span>, regions.<span class="keyword">name</span> <span class="keyword">FROM</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> N_REGIONKEY <span class="keyword">as</span> regionKey, N_NAME <span class="keyword">as</span> <span class="keyword">name</span></span><br><span class="line">  <span class="keyword">FROM</span> dfs.<span class="keyword">work</span>.<span class="string">`sample-data/nation.parquet`</span></span><br><span class="line">) nations <span class="keyword">join</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> R_REGIONKEY <span class="keyword">as</span> regionKey, R_NAME <span class="keyword">as</span> <span class="keyword">name</span></span><br><span class="line">  <span class="keyword">FROM</span> dfs.<span class="keyword">work</span>.<span class="string">`sample-data/region.parquet`</span></span><br><span class="line">) regions</span><br><span class="line">  <span class="keyword">on</span> nations.regionKey = regions.regionKey</span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> nations.<span class="keyword">name</span>;</span></span><br><span class="line"></span><br><span class="line">+<span class="comment">-----------------+--------------+</span></span><br><span class="line">|      name       |    name0     |</span><br><span class="line">+<span class="comment">-----------------+--------------+</span></span><br><span class="line">| ALGERIA         | AFRICA       |</span><br><span class="line">| ARGENTINA       | AMERICA      |</span><br><span class="line">| BRAZIL          | AMERICA      |</span><br><span class="line">| CANADA          | AMERICA      |</span><br><span class="line">| CHINA           | ASIA         |</span><br><span class="line">...</span><br><span class="line">+<span class="comment">-----------------+--------------+</span></span><br><span class="line">25 rows selected (1.038 seconds)</span><br></pre></td></tr></table></figure>
<ol>
<li>å­æŸ¥è¯¢in</li>
</ol>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SELECT N<span class="emphasis">_REGIONKEY as regionKey, N_</span>NAME as name  </span><br><span class="line">FROM dfs.work.<span class="code">`sample-data/nation.parquet`</span></span><br><span class="line">WHERE cast(N<span class="emphasis">_NAME as varchar(10)) IN ('INDIA', 'CHINA');</span><br><span class="line"></span><br><span class="line"></span><span class="code">+------------+</span>--------+</span><br><span class="line"><span class="header">| regionKey  |  name  |</span><br><span class="line">+------------+--------+</span></span><br><span class="line">| 2          | INDIA  |</span><br><span class="line"><span class="header">| 2          | CHINA  |</span><br><span class="line">+------------+--------+</span></span><br></pre></td></tr></table></figure>
<h2 id="Drillè¿æ¥Hive">Drillè¿æ¥Hive</h2><h3 id="HIVEä½¿ç”¨(æœ¬æœºç¯å¢ƒ:_cdh542)">HIVEä½¿ç”¨(æœ¬æœºç¯å¢ƒ: cdh542)</h3><p>drillä¸­æœ‰ä¸€ä¸ªé»˜è®¤çš„hiveé…ç½®é¡¹:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">type</span>": <span class="value"><span class="string">"hive"</span></span>,</span><br><span class="line">  "<span class="attribute">enabled</span>": <span class="value"><span class="literal">false</span></span>,</span><br><span class="line">  "<span class="attribute">configProps</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">hive.metastore.uris</span>": <span class="value"><span class="string">""</span></span>,</span><br><span class="line">    "<span class="attribute">javax.jdo.option.ConnectionURL</span>": <span class="value"><span class="string">"jdbc:derby:;databaseName=../sample-data/drill_hive_db;create=true"</span></span>,</span><br><span class="line">    "<span class="attribute">hive.metastore.warehouse.dir</span>": <span class="value"><span class="string">"/tmp/drill_hive_wh"</span></span>,</span><br><span class="line">    "<span class="attribute">fs.default.name</span>": <span class="value"><span class="string">"file:///"</span></span>,</span><br><span class="line">    "<span class="attribute">hive.metastore.sasl.enabled</span>": <span class="value"><span class="string">"false"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¿®æ”¹æˆä½¿ç”¨hive-site.xmlä¸­çš„é…ç½®é¡¹:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">type</span>": <span class="value"><span class="string">"hive"</span></span>,</span><br><span class="line">  "<span class="attribute">enabled</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">  "<span class="attribute">configProps</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">hive.metastore.uris</span>": <span class="value"><span class="string">"thrift://localhost:9083"</span></span>,</span><br><span class="line">    "<span class="attribute">hive.metastore.sasl.enabled</span>": <span class="value"><span class="string">"false"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯åŠ¨hadoop: start-all.sh</li>
<li>å¯åŠ¨hive: hive â€“service metastoreå’Œhiveserver2</li>
<li>å¯åŠ¨drill:  bin/drill-embedded</li>
<li>è¿›å…¥drillçš„å‘½ä»¤è¡Œä¸­, å’Œhiveçš„ä¸€äº›è¯­æ³•ç±»ä¼¼, æ¯”å¦‚ä¸‹é¢åˆ—å‡ºå·²ç»å­˜åœ¨çš„æ•°æ®åº“show databases, å®šä½åˆ°æŸä¸ªæ•°æ®åº“use xxxâ€¦</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">0: jdbc:drill:zk=local&gt; show databases;</span><br><span class="line">+---------------------+</span></span><br><span class="line"><span class="header">|     SCHEMA_NAME     |</span><br><span class="line">+---------------------+</span></span><br><span class="line">| INFORMATION<span class="emphasis">_SCHEMA  |</span><br><span class="line">| cp.default          |</span><br><span class="line">| dfs.default         |</span><br><span class="line">| dfs.root            |</span><br><span class="line">| dfs.tmp             |</span><br><span class="line">| hive.default        |</span><br><span class="line">| hive.wiki           |</span><br><span class="line">| sys                 |</span><br><span class="line">+---------------------+</span><br><span class="line">8 rows selected (0.627 seconds)</span><br><span class="line">0: jdbc:drill:zk=local&gt; use hive.wiki;</span><br><span class="line">+-------+----------------------------------------+</span><br><span class="line">|  ok   |                summary                 |</span><br><span class="line">+-------+----------------------------------------+</span><br><span class="line">| true  | Default schema changed to [hive.wiki]  |</span><br><span class="line">+-------+----------------------------------------+</span><br><span class="line">1 row selected (0.156 seconds)</span><br><span class="line">0: jdbc:drill:zk=local&gt; show tables;</span><br><span class="line">+---------------+-------------+</span><br><span class="line">| TABLE_</span>SCHEMA  | TABLE<span class="emphasis">_NAME  |</span><br><span class="line">+---------------+-------------+</span><br><span class="line">| hive.wiki     | invites     |</span><br><span class="line">| hive.wiki     | pokes       |</span><br><span class="line">| hive.wiki     | u_</span>data      |</span><br><span class="line"><span class="header">| hive.wiki     | u_data_new  |</span><br><span class="line">+---------------+-------------+</span></span><br><span class="line">4 rows selected (1.194 seconds)</span><br><span class="line"><span class="header">0: jdbc:drill:zk=local&gt; select count(*) from invites;</span><br><span class="line">+---------+</span></span><br><span class="line"><span class="header">| EXPR$0  |</span><br><span class="line">+---------+</span></span><br><span class="line"><span class="header">| 525     |</span><br><span class="line">+---------+</span></span><br><span class="line">1 row selected (4.204 seconds)</span><br></pre></td></tr></table></figure>
<h3 id="HIVEæµ‹è¯•ç¯å¢ƒ(hive-1-2-0)">HIVEæµ‹è¯•ç¯å¢ƒ(hive-1.2.0)</h3><p>ä¿®æ”¹hiveçš„é…ç½®ä¿¡æ¯:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">type</span>": <span class="value"><span class="string">"hive"</span></span>,</span><br><span class="line">  "<span class="attribute">enabled</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">  "<span class="attribute">configProps</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">hive.metastore.uris</span>": <span class="value"><span class="string">"thrift://192.168.6.53:9083"</span></span>,</span><br><span class="line">    "<span class="attribute">javax.jdo.option.ConnectionURL</span>": <span class="value"><span class="string">"jdbc:mysql://192.168.6.53:3306/hive?characterEncoding=UTF-8"</span></span>,</span><br><span class="line">    "<span class="attribute">hive.metastore.warehouse.dir</span>": <span class="value"><span class="string">"/user/hive/warehouse"</span></span>,</span><br><span class="line">    "<span class="attribute">fs.default.name</span>": <span class="value"><span class="string">"hdfs://tdhdfs"</span></span>,</span><br><span class="line">    "<span class="attribute">hive.metastore.sasl.enabled</span>": <span class="value"><span class="string">"false"</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨: ä¸Šé¢ç»¿è‰²éƒ¨åˆ†é™¤äº†fs.default.nameéƒ½ä¸æ˜¯å¿…é¡»çš„.</p>
<p><strong><code>é—®é¢˜: æ— æ³•æŸ¥è¯¢hiveè¡¨æ•°æ®</code></strong><br>åœ¨æµ‹è¯•ç¯å¢ƒé‡åˆ°ä¸€ä¸ªé—®é¢˜: æ­»æ´»æŸ¥ä¸å‡ºæ¥hiveä¸­çš„è¡¨(ä½†æ˜¯show databases, show tables, describe xxéƒ½æ˜¯æ­£å¸¸)<br>æ¯”å¦‚select count(*) from employee; åå°±ä¸€ç›´ä¸åŠ¨äº†. è§‚å¯Ÿweb uiæ˜¾ç¤ºpendingçŠ¶æ€</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150616-17@2x.png" alt="pending job"></p>
<p>ç”¨Control+Cå–æ¶ˆå, æ‰§è¡Œå…¶ä»–ä¹‹å‰æ­£å¸¸çš„å‘½ä»¤éƒ½æ— æ³•æ‰§è¡Œäº†, ä½¿ç”¨!quitä¹Ÿæ— æ³•æ­£å¸¸é€€å‡º. åªèƒ½é€šè¿‡kill -9 pidæ€æ­»sqllineè¿›ç¨‹!</p>
<p><strong><code>é—®é¢˜è¿½è¸ª</code></strong><br>å°†confä¸‹çš„logback.xmlçš„æ—¥å¿—çº§åˆ«æ”¹æˆdebug. è¿™æ ·æ‰§è¡Œæ¯ä¸€æ¡å‘½ä»¤éƒ½ä¼šæ‰“å°å‡ºæ—¥å¿—ä¿¡æ¯<br>å‰é¢çš„è¯­å¥éƒ½æ²¡æœ‰é—®é¢˜, å½“æ‰§è¡ŒæŸ¥è¯¢hiveè¡¨æ•°æ®çš„æ—¶å€™, æŠ¥é”™è¿çš„æ˜¯å¦å¤–ä¸€ä¸ªåœ°å€: tdhdfs/220.250.64.20:8020</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150616-9@2x.png" alt="strange address"></p>
<p><strong><code>é—®é¢˜æ€è€ƒ</code></strong><br>æœäº†ä¸€ç•ªhadoop /etc/hostsä»¥åŠdns;  hdfs ha dnsä¹‹åæ— æœ.<br>ç„¶åæƒ³åˆ°220.250.64.20:8020å…¶ä¸­8020ç«¯å£æ ¹æœ¬å°±æ˜¯é»˜è®¤çš„.<br>è€Œæˆ‘ä»¬çš„æµ‹è¯•é›†ç¾¤ä½¿ç”¨çš„æ˜¯hdfs ha, å¹¶ä¸”ç”¨çš„æ˜¯9000ç«¯å£.  </p>
<p>è¯´æ˜drillæ ¹æœ¬æ²¡æœ‰æ‰¾åˆ°hadoopçš„é…ç½®! å³ä½¿åœ¨hiveçš„é…ç½®é¡µé¢æŒ‡å®šäº†hdfs.default.nameä¸ºhdfs://tdhdfs<br>æ­£å› ä¸ºæ²¡æœ‰drillæ²¡æœ‰æ‰¾åˆ°hadoopçš„é…ç½®æ–‡ä»¶, é‚£ä¹ˆæˆ‘ä»¬å°±è¦æ‰‹åŠ¨è®©drillçŸ¥é“hadoopçš„é…ç½®æ–‡ä»¶ä½ç½®!  </p>
<p><strong><code>å…¶ä»–é—®é¢˜</code></strong><br>å¯åŠ¨drill-embeddedçš„æ—¶å€™æœ‰ä¸€ä¸ªæŠ¥é”™:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">43</span>:<span class="number">54.789</span> [main] DEBUG org<span class="class">.apache</span><span class="class">.hadoop</span><span class="class">.util</span><span class="class">.Shell</span> - Failed to detect <span class="tag">a</span> valid hadoop home directory</span><br><span class="line">java<span class="class">.io</span><span class="class">.IOException</span>: HADOOP_HOME or hadoop<span class="class">.home</span><span class="class">.dir</span> are not set.</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶æ²¡æœ‰å½±å“drillçš„å¯åŠ¨. ä½†è¿˜æ˜¯ä¿®æ”¹ä¸‹: <code>vi ~/.bashrc</code>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HADOOP_HOME=<span class="string">"/usr/install/hadoop"</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_MAPRED_HOME=<span class="variable">$&#123;HADOOP_HOME&#125;</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_COMMON_HOME=<span class="variable">$&#123;HADOOP_HOME&#125;</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_HDFS_HOME=<span class="variable">$&#123;HADOOP_HOME&#125;</span></span><br><span class="line"><span class="built_in">export</span> YARN_HOME=<span class="variable">$&#123;HADOOP_HOME&#125;</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_YARN_HOME=<span class="variable">$&#123;HADOOP_HOME&#125;</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_CONF_DIR=<span class="variable">$&#123;HADOOP_HOME&#125;</span>/etc/hadoop</span><br><span class="line"><span class="built_in">export</span> HDFS_CONF_DIR=<span class="variable">$&#123;HADOOP_HOME&#125;</span>/etc/hadoop</span><br><span class="line"><span class="built_in">export</span> YARN_CONF_DIR=<span class="variable">$&#123;HADOOP_HOME&#125;</span>/etc/hadoop</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/bin:<span class="variable">$HADOOP_HOME</span>/sbin"</span></span><br></pre></td></tr></table></figure>
<p>å¹¶åœ¨drill-env.shä¸­æ·»åŠ   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> HADOOP_HOME=<span class="string">"/usr/install/hadoop"</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å¢åŠ çš„é…ç½®è™½ç„¶å¯åŠ¨æ—¶ä¸å†æŠ¥é”™, ä½†æ˜¯å¹¶ä¸èƒ½è§£å†³æˆ‘ä»¬ä¹‹å‰é‡åˆ°çš„é—®é¢˜.</p>
<p><strong><code>é—®é¢˜è§£å†³</code></strong><br>æ‹·è´hadoopå®‰è£…ç›®å½•ä¸‹çš„core-site.xml, mapred-site.xml, hdfs-site.xml, yarn-site.xmlåˆ°DRILL/confä¸‹!<br>é‡å¯bin/drill-embedded. (å‘ç°é‡å¯å, åŸå…ˆçš„hiveå’Œhdfsé…ç½®éƒ½ä¸è§äº†, æ‰€ä»¥è¦é‡æ–°update)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 conf]$ ll -rt</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">3835</span> <span class="number">5</span>æœˆ  <span class="number">16</span> <span class="number">10</span>:<span class="number">35</span> drill-override-example.conf</span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> qihuang.zheng users <span class="number">1276</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">10</span>:<span class="number">51</span> drill-env.sh</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">2354</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span> core-site.xml</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">3257</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span> hdfs-site.xml</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">2111</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span> mapred-site.xml</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">8382</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span> yarn-site.xml</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">3119</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">15</span>:<span class="number">25</span> logback.xml</span><br><span class="line">-rw-r--r--. <span class="number">1</span> qihuang.zheng users <span class="number">1237</span> <span class="number">6</span>æœˆ  <span class="number">16</span> <span class="number">15</span>:<span class="number">35</span> drill-override.conf</span><br></pre></td></tr></table></figure>
<h3 id="Hiveçš„æ•°æ®ç±»å‹">Hiveçš„æ•°æ®ç±»å‹</h3><p>ç›®å‰Drillå¹¶<code>ä¸æ”¯æŒHiveä¸€äº›å¤æ‚çš„ç»“æ„ç±»å‹, æ¯”å¦‚LIST, MAP, STRUCT, UNION</code></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">0: jdbc:drill:zk&gt; describe koudai;</span><br><span class="line">+-------------------+---------------------------------------+--------------+</span></span><br><span class="line"><span class="header">|    COLUMN_NAME    |               DATA_TYPE               | IS_NULLABLE  |</span><br><span class="line">+-------------------+---------------------------------------+--------------+</span></span><br><span class="line">| sequence<span class="emphasis">_id       | VARCHAR                               | YES          |</span><br><span class="line">| occur_</span>time        | BIGINT                                | YES          |</span><br><span class="line">| activity<span class="emphasis">_map      | (VARCHAR(65535), VARCHAR(65535)) MAP  | NO           |</span><br><span class="line">| device_</span>map        | (VARCHAR(65535), VARCHAR(65535)) MAP  | NO           |</span><br><span class="line">| event<span class="emphasis">_result_</span>map  | (VARCHAR(65535), VARCHAR(65535)) MAP  | NO           |</span><br><span class="line">| geo<span class="emphasis">_map           | (VARCHAR(65535), VARCHAR(65535)) MAP  | NO           |</span><br><span class="line">| policy_</span>map        | (VARCHAR(65535), VARCHAR(65535)) MAP  | NO           |</span><br><span class="line"><span class="header">| indice            | VARCHAR                               | YES          |</span><br><span class="line">+-------------------+---------------------------------------+--------------+</span></span><br><span class="line">8 rows selected (0.504 seconds)</span><br><span class="line">0: jdbc:drill:zk&gt; select count(<span class="strong">*) from koudai;</span><br><span class="line">Error: SYSTEM ERROR: java.lang.RuntimeException: Unsupported Hive data type MAP.</span><br><span class="line">Following Hive data types are supported in Drill for querying: BOOLEAN, BYTE, SHORT, INT, LONG, FLOAT, DOUBLE, DATE, TIMESTAMP, BINARY, DECIMAL, STRING, and VARCHAR</span><br><span class="line"></span><br><span class="line"></span>Fragment 1:0</span><br><span class="line"></span><br><span class="line">[Error Id: 7c5dd0d4-1e18-4dbc-b470-1eb6ca6a3b36 on dp0653:31010] (state=,code=0)</span><br><span class="line"><span class="header">0: jdbc:drill:zk&gt; describe int_table;</span><br><span class="line">+--------------+------------+--------------+</span></span><br><span class="line"><span class="header">| COLUMN_NAME  | DATA_TYPE  | IS_NULLABLE  |</span><br><span class="line">+--------------+------------+--------------+</span></span><br><span class="line"><span class="header">| id           | INTEGER    | YES          |</span><br><span class="line">+--------------+------------+--------------+</span></span><br><span class="line">1 row selected (0.334 seconds)</span><br><span class="line"><span class="header">0: jdbc:drill:zk&gt; select count(*) from int_table;</span><br><span class="line">+---------+</span></span><br><span class="line"><span class="header">| EXPR$0  |</span><br><span class="line">+---------+</span></span><br><span class="line"><span class="header">| 90      |</span><br><span class="line">+---------+</span></span><br><span class="line">1 row selected (0.654 seconds)</span><br></pre></td></tr></table></figure>
<p>So What Can We do when we want to query Hive Table which has map type?</p>
<p>åœ¨drillçš„mail-listä¸Šçœ‹åˆ°è¿™æ ·çš„ä¸€ä¸ªå›å¤:<br><a href="http://mail-archives.apache.org/mod_mbox/drill-dev/201504.mbox/browser" target="_blank" rel="external">http://mail-archives.apache.org/mod_mbox/drill-dev/201504.mbox/browser</a></p>
<blockquote>
<p>We havenâ€™t yet added support for Hiveâ€™s Map type.  Can we work together on<br>adding this?  Drill doesnâ€™t distinguish between maps and structs given its<br>support for schemaless data.  If you could post a small example piece of<br>data, maybe we could figure out the best way to work together to add this<br>functionality.  As I said, it is mostly just a metadata mapping exercise<br>since Drill already has complex type support in the execution engine.  You<br>can see how it works by looking at the JSONReader complex Parquet reader.</p>
<p>å¤§è‡´çš„æ„æ€æ˜¯æˆ‘ä»¬ç°åœ¨ä¸æ”¯æŒhiveçš„mapç±»å‹. ä¸ºä»€ä¹ˆå‘¢? å› ä¸ºdrillæ”¯æŒæ— æ¨¡å¼çš„æ•°æ®, æ‰€ä»¥mapç±»å‹è¿˜æ˜¯ç»“æ„ç±»å‹å¯¹äºdrillè€Œè¨€éƒ½æ˜¯ä¸€æ ·çš„.<br>Drillçš„æ‰§è¡Œå¼•æ“ä¸­å·²ç»æ”¯æŒäº†å¤æ‚çš„ç±»å‹. ä½ å¯ä»¥çœ‹çœ‹æ€ä¹ˆè¯»JSONæˆ–è€…Parquetæ ¼å¼çš„æ–‡ä»¶æ˜¯æ€ä¹ˆåšçš„.</p>
</blockquote>
<p>ç„¶åæƒ³åˆ°hiveåŒ…å«æœ‰mapç±»å‹çš„è¡¨ç»“æ„è™½ç„¶drillä¸æ”¯æŒ. ä½†æ˜¯drillå¯ä»¥ä½¿ç”¨hiveçš„æ•°æ®å•Š.<br>æ—¢ç„¶hiveçš„è¡¨ç»“æ„æ˜¯æœ‰ä¸€å®šschemaçš„. é‚£ä¹ˆå®ƒçš„æ•°æ®æ ¼å¼ä¹Ÿä¸€å®šæ˜¯æœ‰æ ¼å¼çš„.<br>æ‰€ä»¥è¿™é‡Œè™½ç„¶drillå¯ä»¥å’Œhiveå…¬ç”¨è¡¨ç»“æ„, å¦‚æœæˆ‘ä»¬ç›´æ¥ç”¨hiveçš„è¡¨æ•°æ®, ç›¸å½“äºè¿˜æ˜¯ä½¿ç”¨hdfsæ’ä»¶äº†.  </p>
<h2 id="Drillåˆ†å¸ƒå¼æ¨¡å¼">Drillåˆ†å¸ƒå¼æ¨¡å¼</h2><ul>
<li>ä¸Šé¢åœ¨å•æœºä¸Šçš„é…ç½®é¡¹, å°†drillæ–‡ä»¶å¤¹å¤åˆ¶åˆ°é›†ç¾¤ä¸­. æ³¨æ„ä¿®æ”¹drillä¸‹confçš„drill-override.conf  </li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">drill</span><span class="class">.exec</span>: <span class="rules">&#123;</span><br><span class="line">  <span class="rule"><span class="attribute">cluster-id</span>:<span class="value"> <span class="string">"drillbits1"</span>,</span><br><span class="line">  zk.connect: <span class="string">"192.168.6.55:2181,192.168.6.56:2181,192.168.6.57:2181"</span></span><br><span class="line"></span></span></span>&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ¯å°èŠ‚ç‚¹çš„cluster-idéƒ½æ˜¯ä¸€æ ·çš„. ä¿è¯äº†æ‰€æœ‰çš„èŠ‚ç‚¹ç»„æˆä¸€ä¸ªé›†ç¾¤.<br>è¿™å’ŒElasticSearché›†ç¾¤çš„å®‰è£…ä¸€æ ·. å®ƒçš„å¥½å¤„æ˜¯éšæ—¶å¯ä»¥æ‰©å±•èŠ‚ç‚¹, è€Œä¸éœ€è¦æ›´æ”¹åŸå…ˆçš„ä»»ä½•é…ç½®.</p>
</blockquote>
<ul>
<li>ç„¶ååœ¨æ¯å°æœºå™¨ä¸Šéƒ½å¯åŠ¨bin/drillbit.sh start  </li>
<li>éšä¾¿è®¿é—®ä»»æ„ä¸€å°æœºå™¨çš„8047ç«¯å£, éƒ½å¯ä»¥åˆ—å‡ºé›†ç¾¤ä¸­çš„æ‰€æœ‰drillæœåŠ¡  </li>
</ul>
<p><a href="http://192.168.6.52:8047/" target="_blank" rel="external">http://192.168.6.52:8047/</a><br><a href="http://192.168.6.53:8047/" target="_blank" rel="external">http://192.168.6.53:8047/</a><br><a href="http://192.168.6.54:8047/" target="_blank" rel="external">http://192.168.6.54:8047/</a><br><a href="http://192.168.6.56:8047/" target="_blank" rel="external">http://192.168.6.56:8047/</a><br><a href="http://192.168.6.57:8047/" target="_blank" rel="external">http://192.168.6.57:8047/</a>  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150616-15@2x.png" alt="distribute mode"></p>
<h2 id="å®¢æˆ·ç«¯è¿æ¥">å®¢æˆ·ç«¯è¿æ¥</h2><p>Drillæä¾›äº†ä¸€äº›å·¥å…·, åŒ…æ‹¬ç¬¬ä¸‰æ–¹å·¥å…·ä¹Ÿæä¾›äº†è®¿é—®Drillæ•°æ®çš„æ–¹æ³•.<br>ä¸»è¦æ˜¯Drillå’Œå…¶ä»–SQL DBä¸€æ ·æä¾›äº†ä¸€ä¸ªODBC Driver.  å‚è€ƒ: <a href="https://drill.apache.org/docs/interfaces-introduction/" target="_blank" rel="external">https://drill.apache.org/docs/interfaces-introduction/</a></p>
<h3 id="sqlline">sqlline</h3><p><strong>è¿æ¥æœ¬åœ°ZK</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/sqlline -u <span class="string">jdbc:</span><span class="string">drill:</span>zk=local</span><br></pre></td></tr></table></figure>
<p><strong>è¿æ¥ZKé›†ç¾¤</strong>  </p>
<ul>
<li>æ‰‹åŠ¨æŒ‡å®šZK</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0653 apache-drill-<span class="number">1.0</span><span class="number">.0</span>]$ bin/sqlline -u jdbc:drill:zk=<span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.56</span>,<span class="number">192.168</span><span class="number">.6</span><span class="number">.57</span>:<span class="number">2181</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼, ä¹Ÿå¯ä»¥ä¸è·Ÿä¸Šzkåœ°å€:   <strong>bin/sqlline -u jdbc:drill:zk</strong> ä¼šè‡ªåŠ¨è¯»å–drill-override.confçš„é…ç½®</li>
</ul>
<blockquote>
<p>æ³¨æ„: å½“æŒ‡å®šçš„zkæ˜¯ä¸€ä¸ªå…¨æ–°çš„ZK, ä¹‹å‰å¦‚æœä½¿ç”¨zk=localåœ¨æœ¬æ¬¡æ–°çš„zkä¼šè¯ä¸­Storage-Pluginçš„ä¿¡æ¯éƒ½ä¸¢å¤±.<br>å› ä¸ºæˆ‘ä»¬æŒ‡å®šçš„zookeeperé›†ç¾¤æ˜¯å…¨æ–°çš„. æ‰€ä»¥drillè¿˜æ²¡æœ‰å¾€é‡Œé¢å†™å…¥ä»»ä½•æ•°æ®.<br>è¿™æ˜¯å› ä¸ºåœ¨web uiä¸Šå¯¹Storage Pluginè¿›è¡Œupdateæˆ–è€…createçš„æ•°æ®éƒ½ä¼šå†™å…¥åˆ°å¯¹åº”çš„zookeeperèŠ‚ç‚¹ä¸Š!<br>å½“æˆ‘ä»¬åœ¨ç•Œé¢ä¸Šupdate hive, å¹¶ä¸”enableå, é€šè¿‡show databaseså°±å¯ä»¥çœ‹åˆ°hiveé‡Œçš„è¡¨äº†</p>
</blockquote>
<h3 id="iodbc">iodbc</h3><p><strong>iodbc data source manager</strong></p>
<p>é€‰æ‹©ä¸€ä¸ªå·²æœ‰çš„Driver, ä¿®æ”¹è¿æ¥ç±»å‹, å¦‚æœæ˜¯ZooKeeper,è¦æŒ‡å®šZKé›†ç¾¤å’ŒclusterId<br>å¦‚æœæ˜¯Direct, åˆ™ç›´æ¥æŒ‡å®šè¦è¿æ¥çš„Drillçš„hostå’Œport  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150617-5@2x.png" alt="iodbc"></p>
<p>æµ‹è¯•æˆåŠŸå, æ–°å»ºä¸€ä¸ªSQLæŸ¥è¯¢  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150617-6@2x.png" alt="iodbc query"></p>
<p>ç‚¹å‡»OKå, ä¼šè¿”å›æŸ¥è¯¢ç»“æœ  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150617-7@2x.png" alt="iodbc result"></p>
<p><strong>iodbc terminal</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ iodbctest</span><br><span class="line">iODBC Demonstration program</span><br><span class="line">This program shows an interactive SQL processor</span><br><span class="line">Driver Manager: 03.52.0607.1008</span><br><span class="line"></span><br><span class="line">Enter ODBC connect string (? shows list): ?</span><br><span class="line"><span class="header">DSN                              | Driver</span><br><span class="line">------------------------------------------------------------------------------</span></span><br><span class="line">Sample MapR Drill DSN            | MapR Drill ODBC Driver</span><br><span class="line"></span><br><span class="line">Enter ODBC connect string (? shows list): DRIVER=MapR Drill ODBC Driver;AdvancedProperties= &#123;HandshakeTimeout=0;QueryTimeout=0; TimestampTZDisplayTimezone=utc;ExcludedSchemas=sys, INFORMATION_SCHEMA;&#125;;Catalog=DRILL;Schema=; ConnectionType=Direct;Host=192.168.6.53;Port=31010</span><br><span class="line">1: SQLDriverConnect = [<span class="link_label">iODBC</span>][<span class="link_reference">Driver Manager</span>]dlopen(MapR Drill ODBC Driver, 6): image not found (0) SQLSTATE=00000</span><br><span class="line">2: SQLDriverConnect = [<span class="link_label">iODBC</span>][<span class="link_reference">Driver Manager</span>]Specified driver could not be loaded (0) SQLSTATE=IM003</span><br><span class="line"></span><br><span class="line">Enter ODBC connect string (? shows list): DSN=Sample MapR Drill DSN;ConnectionType=Direct;Host=192.168.6.53;Port=31010</span><br><span class="line">Driver: 1.0.0.1001 (MapR Drill ODBC Driver)</span><br><span class="line"></span><br><span class="line">SQL&gt;select count(*) from cp.<span class="code">`employee.json`</span></span><br><span class="line"><span class="header">EXPR$0</span><br><span class="line">--------------------</span></span><br><span class="line">1155</span><br><span class="line"> result set 1 returned 1 rows.</span><br><span class="line">SQL&gt;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ä¸Šé¢è¾“å…¥ODBCçš„è¿æ¥å­—ç¬¦ä¸², æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æœ‰äº›åœ°æ–¹å†™çš„æ˜¯:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DRIVER=MapR Drill ODBC Driver;AdvancedProperties= &#123;HandshakeTimeout=<span class="number">0</span>;QueryTimeout=<span class="number">0</span>; TimestampTZDisplayTimezone=utc;ExcludedSchemas=sys, INFORMATION_SCHEMA;&#125;;Catalog=DRILL;Schema=; ConnectionType=Direct;Host=<span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>;Port=<span class="number">31010</span></span><br></pre></td></tr></table></figure>
<p>ä¼šæŠ¥é”™è¯´image not found. æ­£ç¡®çš„æ ¼å¼åº”è¯¥æ˜¯:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DSN=Sample MapR Drill DSN;ConnectionType=Direct;Host=<span class="number">192.168</span><span class="number">.6</span><span class="number">.53</span>;Port=<span class="number">31010</span></span><br></pre></td></tr></table></figure>
<h3 id="Drill_Explorer">Drill Explorer</h3><p>Drill Expoloerè¿æ¥Drillçš„å­—ç¬¦ä¸²æ ¼å¼å’Œä¸Šé¢ä¸€æ ·, åœ¨Advanceä¸­è¾“å…¥  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150618-1@2x.png" alt="explorer connect"></p>
<p>åœ¨Drill Explorerä¸­å¯ä»¥æµè§ˆæ•°æ®, å¹¶ä¸”å¯ä»¥å»ºç«‹ä¸€äº›è§†å›¾  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150617-4@2x.png" alt="expoloer"></p>
<h2 id="æ€§èƒ½æµ‹è¯•">æ€§èƒ½æµ‹è¯•</h2><h3 id="HDFSçš„Parquetæ–‡ä»¶æŸ¥è¯¢(å•æœºå’Œåˆ†å¸ƒå¼æ¨¡å¼å¯¹æ¯”)">HDFSçš„Parquetæ–‡ä»¶æŸ¥è¯¢(å•æœºå’Œåˆ†å¸ƒå¼æ¨¡å¼å¯¹æ¯”)</h3><p>å•æœºæ¨¡å¼:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">0: jdbc:drill:zk=local&gt; select count(*) from hdfs.`/user/admin/evidence`;</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">|  EXPR$0  |</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">| 4003278  |</span><br><span class="line">+----------+</span></span><br><span class="line">1 row selected (0.854 seconds)</span><br><span class="line"></span><br><span class="line"><span class="header">0: jdbc:drill:zk=local&gt; select fraud_type,count(*) from hdfs.`/user/admin/evidence` group by fraud_type order by count(*) desc;</span><br><span class="line">+--------------------+----------+</span></span><br><span class="line"><span class="header">|     fraud_type     |  EXPR$1  |</span><br><span class="line">+--------------------+----------+</span></span><br><span class="line">| fakeMobile         | 1941589  |</span><br><span class="line"><span class="bullet">...</span><br><span class="line"></span><span class="header">| clickFraud,        | 18       |</span><br><span class="line">+--------------------+----------+</span></span><br><span class="line">14 rows selected (4.451 seconds)</span><br></pre></td></tr></table></figure>
<p>äº”å°æœºå™¨çš„åˆ†å¸ƒå¼æ¨¡å¼:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">0: jdbc:drill:zk=192.168.6.55,192.168.6.56,19&gt; select count(*) from hdfs.`/user/admin/evidence`;</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">|  EXPR$0  |</span><br><span class="line">+----------+</span></span><br><span class="line"><span class="header">| 4003278  |</span><br><span class="line">+----------+</span></span><br><span class="line">1 row selected (0.394 seconds)</span><br><span class="line"></span><br><span class="line"><span class="header">0: jdbc:drill:zk=192.168.6.55,192.168.6.56,19&gt; select fraud_type,count(*) from hdfs.`/user/admin/evidence` group by fraud_type order by count(*) desc;</span><br><span class="line">+--------------------+----------+</span></span><br><span class="line"><span class="header">|     fraud_type     |  EXPR$1  |</span><br><span class="line">+--------------------+----------+</span></span><br><span class="line">| fakeMobile         | 1941589  |</span><br><span class="line"><span class="bullet">...</span><br><span class="line"></span><span class="header">| clickFraud,        | 18       |</span><br><span class="line">+--------------------+----------+</span></span><br><span class="line">14 rows selected (1.744 seconds)</span><br></pre></td></tr></table></figure>
<p><code>å®éªŒç°è±¡1: Foremanä¸å›ºå®š</code><br>åœ¨æ¯å°æœºå™¨çš„8047ç«¯å£çš„Profileä¸­çœ‹åˆ°å¹¶ä¸ä¸€å®šæ¯å°æœºå™¨éƒ½å›æ˜¾ç¤ºQueries.<br>æ¯”å¦‚åœ¨dp0655ä¸Šè¿è¡Œæ—¶, å…¶ä»–å‡ å°æœºå™¨éƒ½æ²¡æœ‰ åªæœ‰dp0656ä¸Šæ‰æœ‰.<br>è€Œä¸”å³ä½¿æ˜¯åœ¨ç›¸åŒçš„å®¢æˆ·ç«¯, ä¸åŒçš„ä¼šè¯ä¹Ÿä¼šåœ¨ä¸åŒçš„Foremanä¸Šè¿è¡Œ.</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150616-16@2x.png" alt="foreman"></p>
<p>A: Foremanåªæ˜¯ç±»ä¼¼Facade, æ˜¯æœ€ç»ˆè¿”å›æŸ¥è¯¢ç»“æœç»™å®¢æˆ·ç«¯çš„èŠ‚ç‚¹. åªéœ€è¦ä¸€ä¸ªå³å¯.<br>Drillåˆ†å¸ƒå¼è®¡ç®—ä¼šç”±Formanå†³å®šå¦‚ä½•æ´¾å‘æ•°æ®ç»™ä¸åŒçš„DrillbitèŠ‚ç‚¹.</p>
<p>å¦‚ä½•éªŒè¯: æŸ¥çœ‹Profilesä¸‹æŸä¸ªQuery, é€šå¸¸ç¬¬ä¸€ä¸ªMajor Fragmentå°±æ˜¯FormanèŠ‚ç‚¹.<br>å…¶ä½™çš„Major Fragmentä¼šåˆ†å‘åˆ°ä¸åŒçš„èŠ‚ç‚¹.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/QQ20150617-1@2x.png" alt="profile"></p>
<p>å…¶å®ä»Drillçš„æ¶æ„å›¾ä¹Ÿå¯ä»¥çœ‹å‡ºFormanåªæœ‰ä¸€ä¸ª  </p>
<p><img src="http://drill.apache.org/docs/img/query-flow-client.png" alt="query-flow-client"></p>
<p><img src="http://drill.apache.org/docs/img/leaf-frag.png" alt="leaf-frag"></p>
<p><code>å®éªŒç°è±¡2: ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ…¢</code><br>æœ‰äº›æŸ¥è¯¢åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶è¾ƒæ…¢. åé¢åŒæ ·çš„è¯­å¥ä¼šå¿«ä¸€å€å¤š.<br>ä½†æœ€åä¼šç¨³å®šä¸‹æ¥æ¯”å¦‚ä¸Šé¢çš„group by order byæµ‹è¯•ç»“æœ(400ä¸‡æ¡,åˆ†ç»„åæ’åº)<br>æ¨ªåæ ‡è¡¨ç¤ºä¾æ¬¡åœ¨è¿™äº›æœºå™¨ä¸Šæ‰§è¡Œ, çºµåæ ‡è¡¨ç¤ºåœ¨è¿™å°æœºå™¨ä¸Šæ‰§è¡Œäº†å¤šæ¬¡åŒæ ·çš„SQLè¯­å¥.</p>
<table>
<thead>
<tr>
<th>Round</th>
<th>dp0653</th>
<th>dp0652</th>
<th>dp0655</th>
<th>dp0657</th>
<th>dp0656</th>
<th>dp0653</th>
</tr>
</thead>
<tbody>
<tr>
<td>Round1</td>
<td>7.871</td>
<td>5.079</td>
<td>4.8299</td>
<td>1.764</td>
<td>1.557</td>
<td>4.305</td>
</tr>
<tr>
<td>Round2</td>
<td>2.549</td>
<td>2.103</td>
<td>2.106</td>
<td>1.66</td>
<td>1.418</td>
<td>1.854</td>
</tr>
<tr>
<td>Round3</td>
<td>1.888</td>
<td>1.893</td>
<td>1.779</td>
<td>1.534</td>
<td>1.512</td>
<td>1.955</td>
</tr>
<tr>
<td>Round4</td>
<td>1.841</td>
<td>1.641</td>
<td>1.703</td>
</tr>
<tr>
<td>Round5</td>
<td>1.744</td>
<td>1.714</td>
<td>1.9</td>
</tr>
<tr>
<td>Round6</td>
<td>1.763</td>
<td>1.572</td>
<td>1.53</td>
</tr>
</tbody>
</table>
<h2 id="Drillå…¶ä»–çŸ¥è¯†ç‚¹">Drillå…¶ä»–çŸ¥è¯†ç‚¹</h2><p>1.QueryUI</p>
<p>åœ¨<a href="http://192.168.6.53:8047/query" target="_blank" rel="external">http://192.168.6.53:8047/query</a>é¡µé¢è¾“å…¥æŸ¥è¯¢æ¡ä»¶. æ³¨æ„ä¸‹é¢çš„hdfs.tmp.by_yr<br>å…¶ä¸­hdfs.tmpç±»ä¼¼äºåœ¨sqlineä¸­å…ˆæ‰§è¡Œäº†<code>use hdfs.tmp</code>, by_yræ˜¯è¡¨å  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-query.png" alt=""></p>
<p>ç‚¹å‡»submit, å¯ä»¥å¾—å‡ºæŸ¥è¯¢ç»“æœ</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill-ui.png" alt=""></p>
<p>2.RESTæœåŠ¡</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl  \</span><br><span class="line">  <span class="comment">--header "Content-type: application/json" \</span></span><br><span class="line">  <span class="comment">--request POST \</span></span><br><span class="line">  <span class="comment">--data '&#123;</span></span><br><span class="line">    "queryType" : "SQL",</span><br><span class="line">    "query" : "<span class="operator"><span class="keyword">select</span> yr,<span class="keyword">count</span>(*) <span class="keyword">from</span> hdfs.tmp.by_yr <span class="keyword">group</span> <span class="keyword">by</span> yr <span class="keyword">having</span> <span class="keyword">count</span>(*) &gt; <span class="number">30000</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">count</span>(*) <span class="keyword">desc</span><span class="string">"</span><br><span class="line">&#125;' \</span><br><span class="line">http://192.168.6.52:8047/query.json</span></span></span><br></pre></td></tr></table></figure>
<p>è¿”å›ç»“æœ:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="collection">&#123;</span><br><span class="line">  <span class="string">"columns"</span> : <span class="collection">[ <span class="string">"yr"</span>, <span class="string">"EXPR$1"</span> ]</span>,</span><br><span class="line">  <span class="string">"rows"</span> : <span class="collection">[ <span class="collection">&#123;</span><br><span class="line">    <span class="string">"yr"</span> : <span class="string">"2008"</span>,</span><br><span class="line">    <span class="string">"EXPR$1"</span> : <span class="string">"38425"</span></span><br><span class="line">  &#125;</span>, <span class="collection">&#123;</span><br><span class="line">    <span class="string">"yr"</span> : <span class="string">"2004"</span>,</span><br><span class="line">    <span class="string">"EXPR$1"</span> : <span class="string">"38252"</span></span><br><span class="line">  &#125;</span>, <span class="collection">&#123;</span><br><span class="line">    <span class="string">"yr"</span> : <span class="string">"2007"</span>,</span><br><span class="line">    <span class="string">"EXPR$1"</span> : <span class="string">"38069"</span></span><br><span class="line">  &#125;</span>, <span class="collection">&#123;</span><br><span class="line">    <span class="string">"yr"</span> : <span class="string">"2003"</span>,</span><br><span class="line">    <span class="string">"EXPR$1"</span> : <span class="string">"37050"</span></span><br><span class="line">  &#125;</span>, <span class="collection">&#123;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span>, <span class="collection">&#123;</span><br><span class="line">    <span class="string">"yr"</span> : <span class="string">"1990"</span>,</span><br><span class="line">    <span class="string">"EXPR$1"</span> : <span class="string">"30368"</span></span><br><span class="line">  &#125;</span> ]</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Q&amp;A">Q&amp;A</h2><ul>
<li><p>[ ] Q: ä¸ºä»€ä¹ˆç¬¬ä¸€æ¬¡æ‰§è¡Œä¼šæ¯”è¾ƒæ…¢?</p>
</li>
<li><p>[x] Q: æ—¢ç„¶æ˜¯åˆ†å¸ƒå¼çš„, ä¸ºä»€ä¹ˆæ¯æ¬¡æ‰§è¡Œæ—¶, åªæ´¾å‘ç»™ä¸€ä¸ªForeman?  </p>
<pre><code><span class="label">A:</span> Formanåªæ˜¯æœ€ç»ˆè¿”å›ç»™å®¢æˆ·ç«¯çš„èŠ‚ç‚¹, åªéœ€è¦ä¸€ä¸ªå³å¯.  
ä½†æ˜¯å…·ä½“çš„æŸ¥è¯¢Foremanä¼šåˆ†å‘ç»™å¤šä¸ªå‡ ç‚¹!
</code></pre></li>
</ul>
<h2 id="TODO">TODO</h2><ul>
<li>æµ‹è¯•ç¯å¢ƒhiveä¸­æ²¡ä»€ä¹ˆè¡¨, è€Œä¸”koudaiè¡¨çš„ç±»å‹æ˜¯map, drillä¸æ”¯æŒmapç±»å‹æ— æ³•æŸ¥è¯¢<br>å‡†å¤‡å¯¼å…¥ä¸€äº›æµ‹è¯•æ•°æ®é›†è¿›æ¥æµ‹ä¸‹</li>
<li>Drill + Tableau  </li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2><p><a href="http://drill.apache.org/docs/" target="_blank" rel="external">Drillå®˜ç½‘</a><br><a href="http://www.yankay.com/google-dremel-rationale/" target="_blank" rel="external">Google Dremel åŸç† - å¦‚ä½•èƒ½3ç§’åˆ†æ1PB</a></p>
<p><a href="http://duguyiren3476.iteye.com/blog/2203055" target="_blank" rel="external">apache drill 0.8.0 å•æœº/åˆ†å¸ƒå¼å®‰è£…æµ‹è¯•</a><br><a href="http://xn--jlq582ax31c.xn--fiqs8s/post/31" target="_blank" rel="external">éƒ¨ç½²åˆ†å¸ƒå¼Drillé›†ç¾¤</a><br><a href="http://blog.chinaunix.net/uid-20593827-id-4042244.html" target="_blank" rel="external">Apache Drillç¯å¢ƒæ­å»ºåŠè¿æ¥hdfs</a>  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/bigdata/">bigdata</a>
	</div>


      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/29/hello-world/" class="article-date">
  	<time datetime="2015-11-29T12:49:30.000Z" itemprop="datePublished">2015-11-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/29/hello-world/">Hello World</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<p>Or you can just copy your markdown file to soruce/_post folder without <code>hexo new</code> command.  </p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<blockquote>
<p>hexo s</p>
</blockquote>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<blockquote>
<p>hexo g</p>
</blockquote>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hexo d</p>
</blockquote>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
<h2 id="Hexo_and_Github">Hexo and Github</h2><p>settup _config.yml file </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">deploy</span>:</span><br><span class="line">    <span class="attribute">type</span>: git</span><br><span class="line">    <span class="attribute">repository</span>: git<span class="variable">@github</span>.<span class="attribute">com</span>:zqhxuyuan/zqhxuyuan.github.io.git</span><br><span class="line">    <span class="attribute">branch</span>: master</span><br></pre></td></tr></table></figure>
<p>generate file and deploy to your github site</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">d</span> -<span class="keyword">g</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        

  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2015 zqhxuyuan
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="å¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„é™æ€åšå®¢æ¡†æ¶">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="ç®€è€Œä¸å‡åŒæ  Hexo åšå®¢ä¸»é¢˜">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >æœ¬ç«™åˆ°è®¿æ•°: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, æœ¬é¡µé˜…è¯»é‡: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    
	<script>
		var yiliaConfig = {
			fancybox: false,
			mathjax: true,
			animate: true,
			isHome: true,
			isPost: false,
			isArchive: false,
			isTag: false,
			isCategory: false,
			open_in_new: false
		}
	</script>


<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>