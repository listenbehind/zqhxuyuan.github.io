<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Cassandra操作 | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;lt;!-- MarkdownTOC --&amp;gt;

优雅关闭节点
不同集群数据同步
增量备份
准备工作：新集群搭建和建表
开始：先测试一张表的迁移
整个集群做一次完整的快照迁移
增量备份（需要多次执行）
机房迁移
直接从当前集群同步到上海集群
新集群安装

表结构



数据迁移



增量数据迁移



数据验证






nodetool工具
集群状态: nodetool decribecluste">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra操作">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/10/15/Cassandra-Operation/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="&amp;lt;!-- MarkdownTOC --&amp;gt;

优雅关闭节点
不同集群数据同步
增量备份
准备工作：新集群搭建和建表
开始：先测试一张表的迁移
整个集群做一次完整的快照迁移
增量备份（需要多次执行）
机房迁移
直接从当前集群同步到上海集群
新集群安装

表结构



数据迁移



增量数据迁移



数据验证






nodetool工具
集群状态: nodetool decribecluste">
<meta property="og:image" content="http://img.blog.csdn.net/20151030101713671">
<meta property="og:image" content="http://img.blog.csdn.net/20160317181038372">
<meta property="og:updated_time" content="2017-05-25T04:40:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cassandra操作">
<meta name="twitter:description" content="&amp;lt;!-- MarkdownTOC --&amp;gt;

优雅关闭节点
不同集群数据同步
增量备份
准备工作：新集群搭建和建表
开始：先测试一张表的迁移
整个集群做一次完整的快照迁移
增量备份（需要多次执行）
机房迁移
直接从当前集群同步到上海集群
新集群安装

表结构



数据迁移



增量数据迁移



数据验证






nodetool工具
集群状态: nodetool decribecluste">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/akka/" style="font-size: 10px;">akka</a> <a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.75px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.25px;">drill</a> <a href="/tags/druid/" style="font-size: 13.75px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 13.75px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.25px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 11.25px;">midd</a> <a href="/tags/ops/" style="font-size: 13.75px;">ops</a> <a href="/tags/redis/" style="font-size: 11.25px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.75px;">scala</a> <a href="/tags/spark/" style="font-size: 17.5px;">spark</a> <a href="/tags/storm/" style="font-size: 17.5px;">storm</a> <a href="/tags/timeseries/" style="font-size: 12.5px;">timeseries</a> <a href="/tags/work/" style="font-size: 13.75px;">work</a> <a href="/tags/流处理/" style="font-size: 11.25px;">流处理</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Cassandra-Operation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/15/Cassandra-Operation/" class="article-date">
  	<time datetime="2015-10-14T16:00:00.000Z" itemprop="datePublished">2015-10-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Cassandra操作
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/work/">work</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cassandra/">cassandra</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <!-- MarkdownTOC -->
<ul>
<li>优雅关闭节点</li>
<li>不同集群数据同步<ul>
<li>增量备份</li>
<li>准备工作：新集群搭建和建表</li>
<li>开始：先测试一张表的迁移</li>
<li>整个集群做一次完整的快照迁移</li>
<li>增量备份（需要多次执行）</li>
<li>机房迁移<ul>
<li>直接从当前集群同步到上海集群</li>
<li>新集群安装</li>
<li><ol>
<li>表结构</li>
</ol>
</li>
<li><ol>
<li>数据迁移</li>
</ol>
</li>
<li><ol>
<li>增量数据迁移</li>
</ol>
</li>
<li><ol>
<li>数据验证</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>nodetool工具<ul>
<li>集群状态: nodetool decribecluster</li>
<li>删除节点: removenode</li>
<li>替换节点: replace_address</li>
<li>重新加入</li>
<li>网络状态netstats: 显示一个节点的Active Stream</li>
<li>节点信息: nodetool info</li>
<li>Gossip信息: nodetool gossipinfo</li>
<li>表相关的信息:nodetool cfstats forseti.velocity</li>
<li>compactionhistory</li>
<li>节点sstable数量异常</li>
</ul>
</li>
<li>tpstats</li>
<li>sstable writer<ul>
<li>文件数过多</li>
<li>导入数据后，用refresh</li>
<li>通过增大内存来增大sstable大小（内存不足）</li>
<li>分表？</li>
</ul>
</li>
<li>sstableloader</li>
<li>jHiccup</li>
</ul>
<!-- /MarkdownTOC -->
<a id="more"></a>
<h2 id="优雅关闭节点">优雅关闭节点</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass048169 ~]$ /usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/nodetool stopdaemon</span><br><span class="line">Cassandra has <span class="keyword">shutdown</span>.</span><br><span class="line"><span class="keyword">error</span>: 拒绝连接</span><br><span class="line"><span class="comment">-- StackTrace --</span></span><br><span class="line"><span class="keyword">java</span>.net.ConnectException: 拒绝连接</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.PlainSocketImpl.socketConnect(<span class="keyword">Native</span> Method)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.<span class="keyword">java</span>:<span class="number">339</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.<span class="keyword">java</span>:<span class="number">200</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.AbstractPlainSocketImpl.<span class="keyword">connect</span>(AbstractPlainSocketImpl.<span class="keyword">java</span>:<span class="number">182</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.SocksSocketImpl.<span class="keyword">connect</span>(SocksSocketImpl.<span class="keyword">java</span>:<span class="number">392</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.Socket.<span class="keyword">connect</span>(Socket.<span class="keyword">java</span>:<span class="number">579</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.Socket.<span class="keyword">connect</span>(Socket.<span class="keyword">java</span>:<span class="number">528</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.Socket.&lt;init&gt;(Socket.<span class="keyword">java</span>:<span class="number">425</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.net.Socket.&lt;init&gt;(Socket.<span class="keyword">java</span>:<span class="number">208</span>)</span><br><span class="line">  <span class="keyword">at</span> sun.rmi.transport.proxy.RMIDirectSocketFactory.createSocket(RMIDirectSocketFactory.<span class="keyword">java</span>:<span class="number">40</span>)</span><br><span class="line">  <span class="keyword">at</span> sun.rmi.transport.proxy.RMIMasterSocketFactory.createSocket(RMIMasterSocketFactory.<span class="keyword">java</span>:<span class="number">147</span>)</span><br><span class="line">  <span class="keyword">at</span> sun.rmi.transport.tcp.TCPEndpoint.newSocket(TCPEndpoint.<span class="keyword">java</span>:<span class="number">613</span>)</span><br><span class="line">  <span class="keyword">at</span> sun.rmi.transport.tcp.TCPChannel.createConnection(TCPChannel.<span class="keyword">java</span>:<span class="number">216</span>)</span><br><span class="line">  <span class="keyword">at</span> sun.rmi.transport.tcp.TCPChannel.newConnection(TCPChannel.<span class="keyword">java</span>:<span class="number">202</span>)</span><br><span class="line">  <span class="keyword">at</span> sun.rmi.<span class="keyword">server</span>.UnicastRef.invoke(UnicastRef.<span class="keyword">java</span>:<span class="number">129</span>)</span><br><span class="line">  <span class="keyword">at</span> com.sun.jmx.remote.internal.PRef.invoke(<span class="keyword">Unknown</span> <span class="keyword">Source</span>)</span><br><span class="line">  <span class="keyword">at</span> javax.<span class="keyword">management</span>.remote.rmi.RMIConnectionImpl_Stub.<span class="keyword">close</span>(<span class="keyword">Unknown</span> <span class="keyword">Source</span>)</span><br><span class="line">  <span class="keyword">at</span> javax.<span class="keyword">management</span>.remote.rmi.RMIConnector.<span class="keyword">close</span>(RMIConnector.<span class="keyword">java</span>:<span class="number">512</span>)</span><br><span class="line">  <span class="keyword">at</span> javax.<span class="keyword">management</span>.remote.rmi.RMIConnector.<span class="keyword">close</span>(RMIConnector.<span class="keyword">java</span>:<span class="number">452</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.tools.NodeProbe.<span class="keyword">close</span>(NodeProbe.<span class="keyword">java</span>:<span class="number">237</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.tools.NodeTool$NodeToolCmd.run(NodeTool.<span class="keyword">java</span>:<span class="number">295</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.tools.NodeTool.<span class="keyword">main</span>(NodeTool.<span class="keyword">java</span>:<span class="number">206</span>)</span><br><span class="line"></span><br><span class="line">[<span class="keyword">admin</span>@cass048169 ~]$</span><br><span class="line">[<span class="keyword">admin</span>@cass048169 ~]$</span><br><span class="line">[<span class="keyword">admin</span>@cass048169 ~]$ ps -ef|grep cassandra</span><br><span class="line"><span class="keyword">admin</span>    <span class="number">40084</span> <span class="number">37927</span>  <span class="number">0</span> <span class="number">09</span>:<span class="number">46</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep cassandra</span></span><br></pre></td></tr></table></figure>
<h2 id="不同集群数据同步">不同集群数据同步</h2><p>1.sstableloader的文件夹必须是keyspace/table格式,否则空指针异常:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 ~]$ /usr/install/cassandra/bin/sstableloader -d localhost <span class="number">1445938244634</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span>.&lt;init&gt;(SSTableLoader<span class="class">.java</span>:<span class="number">59</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line">$ cd /home/admin/data/cassandra/data/forseti/velocity/snapshots</span><br><span class="line">$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> <span class="number">1445938244634</span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span>.&lt;init&gt;(SSTableLoader<span class="class">.java</span>:<span class="number">59</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<p>2.做快照后会在表目录生成snapshots文件夹, 不能直接在表目录上使用sstableloader:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> /home/admin/data/cassandra/data/forseti/velocity/snapshots/<span class="number">1445938244634</span></span><br><span class="line">Could not retrieve endpoint ranges:</span><br><span class="line"><span class="function"><span class="title">InvalidRequestException</span><span class="params">(why:No such keyspace: snapshots)</span></span></span><br><span class="line">Run with --debug to get full stack trace or --help to get help.</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@mysql006070 ~]$ /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> /home/admin/data/cassandra/data/forseti/velocity</span><br><span class="line">Established connection to <span class="attribute">initial</span> hosts</span><br><span class="line">Opening sstables and calculating sections to stream</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> FSWriteError <span class="keyword">in</span> /home/admin/data/cassandra/data/forseti/velocity/forseti-velocity-jb-<span class="number">414</span>-Summary<span class="class">.db</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.FileUtils</span><span class="class">.deleteWithConfirm</span>(FileUtils<span class="class">.java</span>:<span class="number">122</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableReader</span><span class="class">.loadSummary</span>(SSTableReader<span class="class">.java</span>:<span class="number">546</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableReader</span><span class="class">.openForBatch</span>(SSTableReader<span class="class">.java</span>:<span class="number">173</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span>$<span class="number">1</span>.<span class="function"><span class="title">accept</span><span class="params">(SSTableLoader.java:<span class="number">107</span>)</span></span></span><br><span class="line">  at java<span class="class">.io</span><span class="class">.File</span><span class="class">.list</span>(File<span class="class">.java</span>:<span class="number">1155</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.openSSTables</span>(SSTableLoader<span class="class">.java</span>:<span class="number">68</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">150</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">95</span>)</span><br><span class="line">Caused by: java<span class="class">.nio</span><span class="class">.file</span><span class="class">.AccessDeniedException</span>: /home/admin/data/cassandra/data/forseti/velocity/forseti-velocity-jb-<span class="number">414</span>-Summary<span class="class">.db</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.FileUtils</span><span class="class">.deleteWithConfirm</span>(FileUtils<span class="class">.java</span>:<span class="number">118</span>)</span><br><span class="line">  ... <span class="number">7</span> more</span><br><span class="line">[qihuang.zheng@mysql006070 ~]$ sudo -u admin /usr/install/cassandra/bin/sstableloader -d <span class="number">192.168</span>.<span class="number">6.52</span> /home/admin/data/cassandra/data/forseti/velocity</span><br><span class="line">Caused by: java<span class="class">.net</span><span class="class">.UnknownHostException</span>: mysql006070: 未知的名称或服务</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.Inet6AddressImpl</span><span class="class">.lookupAllHostAddr</span>(Native Method)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.InetAddress</span>$<span class="number">1</span>.<span class="function"><span class="title">lookupAllHostAddr</span><span class="params">(InetAddress.java:<span class="number">901</span>)</span></span></span><br><span class="line">  at java<span class="class">.net</span><span class="class">.InetAddress</span><span class="class">.getAddressesFromNameService</span>(InetAddress<span class="class">.java</span>:<span class="number">1293</span>)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.InetAddress</span><span class="class">.getLocalHost</span>(InetAddress<span class="class">.java</span>:<span class="number">1469</span>)</span><br><span class="line">  ... <span class="number">11</span> more</span><br></pre></td></tr></table></figure>
<p>3.使用sstableloader时, 在表目录下不能存在snapshots目录.  <a href="http://tonywutao.github.io/2013/10/17/SSS-Table-Loader-in-Cassandra/" target="_blank" rel="external">http://tonywutao.github.io/2013/10/17/SSS-Table-Loader-in-Cassandra/</a><br>但是做快照时, snapshots目录又是生成在表目录下, 所以不能直接用sstableloader, 解决办法是将快照文件夹拷贝到别的地方,并按照keyspace/table格式.<br>如果运行sstableloader的机器的内存不足, 会报OOM, 可以加大内存, 但是如果机器本身内存不足, 最好的办法只能是scp到一台比较大内存的机器.  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.TreeMap</span><span class="class">.put</span>(TreeMap<span class="class">.java</span>:<span class="number">569</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.TreeSet</span><span class="class">.add</span>(TreeSet<span class="class">.java</span>:<span class="number">255</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.compress</span><span class="class">.CompressionMetadata</span><span class="class">.getChunksForSections</span>(CompressionMetadata<span class="class">.java</span>:<span class="number">226</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.messages</span><span class="class">.OutgoingFileMessage</span>.&lt;init&gt;(OutgoingFileMessage<span class="class">.java</span>:<span class="number">76</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamTransferTask</span><span class="class">.addTransferFile</span>(StreamTransferTask<span class="class">.java</span>:<span class="number">56</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.addTransferFiles</span>(StreamSession<span class="class">.java</span>:<span class="number">340</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamPlan</span><span class="class">.transferFiles</span>(StreamPlan<span class="class">.java</span>:<span class="number">138</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">178</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">95</span>)</span><br><span class="line">ERROR <span class="number">13</span>:<span class="number">32</span>:<span class="number">10</span>,<span class="number">104</span> Error <span class="keyword">in</span> ThreadPoolExecutor</span><br><span class="line">java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Java heap space</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.BackgroundActivityMonitor</span><span class="class">.readAndCompute</span>(BackgroundActivityMonitor<span class="class">.java</span>:<span class="number">84</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.BackgroundActivityMonitor</span><span class="class">.getIOWait</span>(BackgroundActivityMonitor<span class="class">.java</span>:<span class="number">125</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.BackgroundActivityMonitor</span><span class="variable">$BackgroundActivityReporter</span>.<span class="function"><span class="title">run</span><span class="params">(BackgroundActivityMonitor.java:<span class="number">153</span>)</span></span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.concurrent</span><span class="class">.DebuggableScheduledThreadPoolExecutor</span><span class="variable">$UncomplainingRunnable</span>.<span class="function"><span class="title">run</span><span class="params">(DebuggableScheduledThreadPoolExecutor.java:<span class="number">80</span>)</span></span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.runAndReset</span>(FutureTask<span class="class">.java</span>:<span class="number">304</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.access$<span class="number">301</span>(ScheduledThreadPoolExecutor<span class="class">.java</span>:<span class="number">178</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.<span class="function"><span class="title">run</span><span class="params">(ScheduledThreadPoolExecutor.java:<span class="number">293</span>)</span></span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="class">.runWorker</span>(ThreadPoolExecutor<span class="class">.java</span>:<span class="number">1145</span>)</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.<span class="function"><span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">615</span>)</span></span></span><br><span class="line">  at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>)</span><br><span class="line"></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: GC overhead limit exceeded</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.compress</span><span class="class">.CompressionMetadata</span><span class="class">.getChunksForSections</span>(CompressionMetadata<span class="class">.java</span>:<span class="number">226</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.messages</span><span class="class">.OutgoingFileMessage</span>.&lt;init&gt;(OutgoingFileMessage<span class="class">.java</span>:<span class="number">76</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamTransferTask</span><span class="class">.addTransferFile</span>(StreamTransferTask<span class="class">.java</span>:<span class="number">56</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.addTransferFiles</span>(StreamSession<span class="class">.java</span>:<span class="number">340</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamPlan</span><span class="class">.transferFiles</span>(StreamPlan<span class="class">.java</span>:<span class="number">138</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">178</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">95</span>)</span><br></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/32715401/cassandra-migrate-keyspace-data-from-multinode-cluster-to-singlenode-cluster" target="_blank" rel="external">http://stackoverflow.com/questions/32715401/cassandra-migrate-keyspace-data-from-multinode-cluster-to-singlenode-cluster</a></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ERROR [StreamReceiveTask:<span class="number">124</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">10</span> <span class="number">18</span>:<span class="number">09</span>:<span class="number">31</span>,<span class="number">717</span> StreamReceiveTask<span class="class">.java</span>:<span class="number">183</span> - Error applying streamed data:</span><br><span class="line">org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.FSReadError</span>: java<span class="class">.io</span><span class="class">.IOException</span>: Map failed</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.MmappedSegmentedFile</span><span class="variable">$Builder</span>.<span class="function"><span class="title">createSegments</span><span class="params">(MmappedSegmentedFile.java:<span class="number">399</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.MmappedSegmentedFile</span><span class="variable">$Builder</span>.<span class="function"><span class="title">complete</span><span class="params">(MmappedSegmentedFile.java:<span class="number">365</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.SegmentedFile</span><span class="variable">$Builder</span>.<span class="function"><span class="title">complete</span><span class="params">(SegmentedFile.java:<span class="number">174</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableWriter</span><span class="class">.finish</span>(SSTableWriter<span class="class">.java</span>:<span class="number">463</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableWriter</span><span class="class">.closeAndOpenReader</span>(SSTableWriter<span class="class">.java</span>:<span class="number">447</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableWriter</span><span class="class">.closeAndOpenReader</span>(SSTableWriter<span class="class">.java</span>:<span class="number">442</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamReceiveTask</span><span class="variable">$OnCompletionRunnable</span>.<span class="function"><span class="title">run</span><span class="params">(StreamReceiveTask.java:<span class="number">141</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.run</span>(FutureTask<span class="class">.java</span>:<span class="number">262</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="class">.runWorker</span>(ThreadPoolExecutor<span class="class">.java</span>:<span class="number">1145</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.<span class="function"><span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">615</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">Caused by: java<span class="class">.io</span><span class="class">.IOException</span>: Map failed</span><br><span class="line">        at sun<span class="class">.nio</span><span class="class">.ch</span><span class="class">.FileChannelImpl</span><span class="class">.map</span>(FileChannelImpl<span class="class">.java</span>:<span class="number">888</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.util</span><span class="class">.MmappedSegmentedFile</span><span class="variable">$Builder</span>.<span class="function"><span class="title">createSegments</span><span class="params">(MmappedSegmentedFile.java:<span class="number">392</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        ... <span class="number">11</span> common frames omitted</span><br><span class="line">Caused by: java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Map failed</span><br><span class="line">        at sun<span class="class">.nio</span><span class="class">.ch</span><span class="class">.FileChannelImpl</span><span class="class">.map0</span>(Native Method) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at sun<span class="class">.nio</span><span class="class">.ch</span><span class="class">.FileChannelImpl</span><span class="class">.map</span>(FileChannelImpl<span class="class">.java</span>:<span class="number">885</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        ... <span class="number">12</span> common frames omitted</span><br><span class="line">ERROR [StreamReceiveTask:<span class="number">124</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">10</span> <span class="number">18</span>:<span class="number">09</span>:<span class="number">31</span>,<span class="number">717</span> JVMStabilityInspector<span class="class">.java</span>:<span class="number">117</span> - JVM state determined to be unstable.  Exiting forcefully due to:</span><br><span class="line">java<span class="class">.lang</span><span class="class">.OutOfMemoryError</span>: Map failed</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ERROR [CompactionExecutor:<span class="number">10060</span>] <span class="number">2016</span>-<span class="number">07</span>-<span class="number">10</span> <span class="number">15</span>:<span class="number">29</span>:<span class="number">45</span>,<span class="number">520</span> CassandraDaemon<span class="class">.java</span>:<span class="number">229</span> - Exception <span class="keyword">in</span> thread Thread[CompactionExecutor:<span class="number">10060</span>,<span class="number">1</span>,main]</span><br><span class="line">java<span class="class">.lang</span><span class="class">.RuntimeException</span>: Out of native memory occured, You can avoid it by increasing the system ram space or by increasing bloom_filter_fp_chance.</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.obs</span><span class="class">.OffHeapBitSet</span>.&lt;init&gt;(OffHeapBitSet<span class="class">.java</span>:<span class="number">48</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.FilterFactory</span><span class="class">.createFilter</span>(FilterFactory<span class="class">.java</span>:<span class="number">84</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.FilterFactory</span><span class="class">.getFilter</span>(FilterFactory<span class="class">.java</span>:<span class="number">78</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableWriter</span><span class="variable">$IndexWriter</span>.&lt;init&gt;(SSTableWriter<span class="class">.java</span>:<span class="number">592</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableWriter</span>.&lt;init&gt;(SSTableWriter<span class="class">.java</span>:<span class="number">141</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.createCompactionWriter</span>(CompactionTask<span class="class">.java</span>:<span class="number">308</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.runMayThrow</span>(CompactionTask<span class="class">.java</span>:<span class="number">190</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.WrappedRunnable</span><span class="class">.run</span>(WrappedRunnable<span class="class">.java</span>:<span class="number">28</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.executeInternal</span>(CompactionTask<span class="class">.java</span>:<span class="number">73</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.AbstractCompactionTask</span><span class="class">.execute</span>(AbstractCompactionTask<span class="class">.java</span>:<span class="number">59</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionManager</span><span class="variable">$BackgroundCompactionCandidate</span>.<span class="function"><span class="title">run</span><span class="params">(CompactionManager.java:<span class="number">263</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span> ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.run</span>(FutureTask<span class="class">.java</span>:<span class="number">262</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="class">.runWorker</span>(ThreadPoolExecutor<span class="class">.java</span>:<span class="number">1145</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.<span class="function"><span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">615</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">        at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br></pre></td></tr></table></figure>
<h3 id="增量备份">增量备份</h3><p>先做snaptshot，然后修改配置，并重启集群</p>
<blockquote>
<p>在新版的Cassandra中有nodetool enablebackup选项可以直接修改，而不用重启！</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">host=`ifconfig | grep <span class="string">"192.168.4"</span> | awk <span class="string">'/inet addr/&#123;sub("addr:",""); print $2&#125;'</span>`</span><br><span class="line">sed -i -e <span class="string">"s/incremental_backups: false/incremental_backups: true/g"</span> <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>conf/cassandra.yaml</span><br><span class="line">cat <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>conf/cassandra.yaml | grep incremental_backups</span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/nodetool -h $host snapshot forseti_fp</span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/nodetool flush</span><br><span class="line">kill -<span class="number">9</span> `<span class="regexp">/usr/</span>install<span class="regexp">/java/</span>bin/jps | grep CassandraDaemon |awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">ps -ef | grep cassandra</span><br><span class="line">sleep <span class="number">10</span>s</span><br><span class="line"><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/cassandra</span><br><span class="line"></span><br><span class="line">ll <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session/snapshots</span><br><span class="line">ll <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session/backups</span><br><span class="line">du -sh <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session/snapshots</span><br><span class="line">du -sh <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session/backups</span><br></pre></td></tr></table></figure>
<p>After a system-wide snapshot is performed, you can enable incremental backups on each node to backup data that has changed<br>since the last snapshot: each time an SSTable is flushed, a hard link is copied into a /backups subdirectory of the data directory</p>
<p>是先做全局的快照（每个节点都做），然后再开启增量备份：修改配置，重启每个节点。<br>如果没有先做全局快照，而是每个节点做完快照后，立即修改配置，然后重启，接着处理下一个节点，有没有影响？<br>不过可以通过制定nodetool的-h选项一次性在一个节点上就做完全的快照，而不用登陆每个节点一个一个做快照！根本不用pssh！</p>
<p>快照后生成的文件在：data_directory_location/keyspace_name/table_name/snapshots/UUID/<br>增量备份后文件生成在：data_directory_location/keyspace_name/table_name/backups/</p>
<p>incremental backups combine with snapshots to provide a dependable, up-to-date backup mechanism.<br>增量备份依赖于快照中的内容，提供可靠的、最新的备份机制。</p>
<p>问题：如果把快照删除了，增量备份还可以正常工作吗？</p>
<h3 id="准备工作：新集群搭建和建表">准备工作：新集群搭建和建表</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster_name:</span> fp_back</span><br><span class="line"><span class="string">data_file_directories:</span> [<span class="regexp">/data01,/</span>data02,<span class="regexp">/data03,/</span>data04,<span class="regexp">/data05,/</span>data06,<span class="regexp">/data07,/</span>data08,<span class="regexp">/data09,/</span>data10,<span class="regexp">/data11,/</span>data12]</span><br><span class="line"><span class="string">saved_caches_directory:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>saved_caches</span><br><span class="line"><span class="string">commitlog_directory:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>commitlog</span><br></pre></td></tr></table></figure>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//192.168.47.211:8000/apache-cassandra-2.1.13.tar.gz</span></span><br><span class="line">tar zxf apache-cassandra-2.1.13.tar.gz</span><br><span class="line">host=`ifconfig | grep <span class="string">"192.168.50"</span> | awk '/inet addr/&#123;sub(<span class="string">"addr:"</span>,<span class="string">""</span>); <span class="keyword">print</span> <span class="label">$2&#125;</span>'`</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s#192.168.47.211#$host#g"</span> apache-cassandra-2.1.13/<span class="keyword">conf</span>/cassandra.yaml</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s#192.168.47.211#$host#g"</span> apache-cassandra-2.1.13/<span class="keyword">conf</span>/cassandra-env.<span class="keyword">sh</span></span><br><span class="line"><span class="keyword">mkdir</span> /home/admin/cassandra</span><br><span class="line">apache-cassandra-2.1.13/bin/cassandra</span><br></pre></td></tr></table></figure>
<p>将原集群的脚本导成cql文件，并连接目标集群，导入数据库，可以修改副本数。 不需要登录目标集群操作！  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span> -<span class="keyword">e</span> <span class="string">'desc keyspace forseti_fp'</span> &gt; forseti_fp.cql</span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh <span class="number">192.168</span><span class="number">.50</span><span class="number">.20</span> -<span class="keyword">f</span> forseti_fp.cql</span><br><span class="line"><span class="keyword">CREATE</span> KEYSPACE forseti_fp <span class="keyword">WITH</span> <span class="keyword">replication</span> = &#123;</span><br><span class="line">  <span class="string">'class'</span>: <span class="string">'NetworkTopologyStrategy'</span>,</span><br><span class="line">  <span class="string">'DC2'</span>: <span class="string">'1'</span>,</span><br><span class="line">  <span class="string">'DC1'</span>: <span class="string">'1'</span></span><br><span class="line">&#125;;</span></span><br></pre></td></tr></table></figure>
<h3 id="开始：先测试一张表的迁移">开始：先测试一张表的迁移</h3><p>快照文件不能直接用sstableloader操作</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ll <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session/snapshots</span><br><span class="line"><span class="number">1464167616242</span></span><br><span class="line">$ <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/sstableloader -d 192.168.50.20 /</span>home<span class="regexp">/admin/</span>cassandra<span class="regexp">/data/</span>forseti_fp<span class="regexp">/android_device_session/</span>snapshots</span><br><span class="line">Could not retrieve endpoint <span class="string">ranges:</span></span><br><span class="line">InvalidRequestException(<span class="string">why:</span>No such <span class="string">keyspace:</span> android_device_session)</span><br><span class="line">$ <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/sstableloader -d 192.168.50.20 /</span>home<span class="regexp">/admin/</span>cassandra<span class="regexp">/data/</span>forseti_fp<span class="regexp">/android_device_session/</span>snapshots/<span class="number">1464167616242</span></span><br><span class="line">Could not retrieve endpoint <span class="string">ranges:</span></span><br><span class="line">InvalidRequestException(<span class="string">why:</span>No such <span class="string">keyspace:</span> snapshots)</span><br><span class="line"></span><br><span class="line">snap=`ls <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session/snapshots`</span><br><span class="line">mv <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/forseti_fp/</span>android_device_session<span class="regexp">/snapshots/</span>$snap <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span> &amp;&amp; cd <span class="regexp">/home/</span>admin/cassandra &amp;&amp; mkdir forseti_fp</span><br><span class="line">mv $snap android_device_session &amp;&amp; mv android_device_session forseti_fp</span><br><span class="line">nohup <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/sstableloader -d 192.168.50.20,192.168.50.21,192.168.50.22,192.168.50.23,192.168.50.24 /</span>home<span class="regexp">/admin/</span>cassandra<span class="regexp">/forseti_fp/</span>android_device_session &amp;</span><br></pre></td></tr></table></figure>
<p>默认sstableloader的内存只有512M，修改为<strong>3072M</strong>后，可以成功导入：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[admin@spark015010 ~]$ du -sh /data*/forseti_fp/android_device_session-*</span><br><span class="line"><span class="number">4.0</span>K    /data01/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data02/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data03/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data04/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data05/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data06/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data07/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data08/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data09/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">3.5</span>G    /data10/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data11/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br><span class="line"><span class="number">4.0</span>K    /data12/forseti_fp/android_device_session-<span class="number">980e940023</span>af11e6a5ea87f007ccb41c</span><br></pre></td></tr></table></figure>
<p>内存不足时报错：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ERROR <span class="number">03</span>:<span class="number">58</span>:<span class="number">12</span> [Stream <span class="preprocessor">#<span class="number">4f</span>0fadf0-<span class="number">23</span>b1-<span class="number">11e6</span>-bbf2-<span class="number">2592342</span>d3b2e] Streaming <span class="keyword">error</span> occurred</span></span><br><span class="line">java.lang.OutOfMemoryError: GC overhead limit exceeded</span><br><span class="line">    at java.util.TreeMap.put(TreeMap.java:<span class="number">569</span>) ~[na:<span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">    at java.util.TreeSet.add(TreeSet.java:<span class="number">255</span>) ~[na:<span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">    at org.apache.cassandra.io.compress.CompressionMetadata.getChunksForSections(CompressionMetadata.java:<span class="number">287</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.messages.FileMessageHeader$FileMessageHeaderSerializer.serialize(FileMessageHeader.java:<span class="number">172</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.messages.OutgoingFileMessage.serialize(OutgoingFileMessage.java:<span class="number">82</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.messages.OutgoingFileMessage$<span class="number">1.</span>serialize(OutgoingFileMessage.java:<span class="number">49</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.messages.OutgoingFileMessage$<span class="number">1.</span>serialize(OutgoingFileMessage.java:<span class="number">41</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:<span class="number">45</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:<span class="number">351</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.run(ConnectionHandler.java:<span class="number">323</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.jar:<span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">    at java.lang.Thread.run(Thread.java:<span class="number">744</span>) [na:<span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">progress: [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.24</span>]<span class="number">0</span>:<span class="number">0</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.21</span>]<span class="number">0</span>:<span class="number">1</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.20</span>]<span class="number">0</span>:<span class="number">0</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.23</span>]<span class="number">0</span>:<span class="number">2</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.22</span>]<span class="number">0</span>:<span class="number">1</span>/<span class="number">19</span> <span class="number">0</span>  % total: <span class="number">0</span>% <span class="number">0</span>  MB/s(avg: <span class="number">0</span> MB/s)</span><br><span class="line">ERROR <span class="number">03</span>:<span class="number">58</span>:<span class="number">12</span> [Stream <span class="preprocessor">#<span class="number">4f</span>0fadf0-<span class="number">23</span>b1-<span class="number">11e6</span>-bbf2-<span class="number">2592342</span>d3b2e] Remote peer <span class="number">192.168</span><span class="number">.50</span><span class="number">.23</span> failed stream session.</span></span><br><span class="line">progress: [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.24</span>]<span class="number">0</span>:<span class="number">0</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.21</span>]<span class="number">0</span>:<span class="number">1</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.20</span>]<span class="number">0</span>:<span class="number">0</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.23</span>]<span class="number">0</span>:<span class="number">2</span>/<span class="number">19</span> <span class="number">0</span>  % [/<span class="number">192.168</span><span class="number">.50</span><span class="number">.22</span>]<span class="number">0</span>:<span class="number">3</span>/<span class="number">19</span> <span class="number">0</span>  % total: <span class="number">0</span>% <span class="number">0</span>  MB/s(avg: <span class="number">0</span> MB/s)</span><br><span class="line">/usr/install/cassandra/bin/sstableloader: line <span class="number">53</span>: </span><br><span class="line"><span class="number">15459</span> 已杀死               <span class="string">"$JAVA"</span> $JAVA_AGENT -ea -cp <span class="string">"$CLASSPATH"</span> $JVM_OPTS -Xmx$MAX_HEAP_SIZE -Dcassandra.storagedir=<span class="string">"$cassandra_storagedir"</span> -Dlogback.configurationFile=logback-tools.xml org.apache.cassandra.tools.BulkLoader <span class="string">"$@"</span></span><br></pre></td></tr></table></figure>
<p>sstableloader完成后的日志：  </p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Established connection <span class="keyword">to</span> initial hosts</span><br><span class="line">Opening sstables <span class="subst">and</span> calculating sections <span class="keyword">to</span> stream</span><br><span class="line"><span class="attribute">...</span><span class="built_in">.</span><br><span class="line"></span><span class="number">100</span>% total: <span class="number">100</span>% <span class="number">0</span>  MB/s(avg: <span class="number">24</span> MB/s)</span><br><span class="line">Summary statistics:</span><br><span class="line">   Connections per host:         : <span class="number">1</span></span><br><span class="line">   Total files transferred:      : <span class="number">85</span></span><br><span class="line">   Total <span class="built_in">bytes</span> transferred:      : <span class="number">2291137192904</span></span><br><span class="line">   Total <span class="built_in">duration</span> (ms):          : <span class="number">87700111</span>  -<span class="subst">-&gt; </span><span class="number">24</span>小时！</span><br><span class="line">   <span class="keyword">Average</span> transfer rate (MB/s): : <span class="number">24</span></span><br><span class="line">   Peak transfer rate (MB/s):    : <span class="number">24</span></span><br></pre></td></tr></table></figure>
<p>一次完整的snapshot，android_device_session表在每个节点的耗时统计</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">节点             Load       耗时(ms)   传输量(bytes)   大小/实际大小</span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.228</span>  <span class="number">2.51</span> TB    <span class="number">69222991</span>  <span class="number">1808724189277</span>   <span class="number">80</span>G/<span class="number">1.7</span>T</span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.227</span>  <span class="number">2.67</span> TB    <span class="number">24897246</span>  <span class="number">590477418187</span>    <span class="number">284</span>G/<span class="number">1.9</span>T</span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.226</span>  <span class="number">2.58</span> TB    <span class="number">73820237</span>  <span class="number">1928301531978</span>   <span class="number">249</span>G/<span class="number">1.8</span>T </span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.176</span>  <span class="number">5.9</span> TB     <span class="number">77773491</span>  <span class="number">2032068642522</span>   <span class="number">1018</span>G/<span class="number">1.9</span>T   </span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">4.28</span> TB    <span class="number">78947850</span>  <span class="number">2060434319116</span>   <span class="number">46</span>G/?</span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">4.34</span> TB    <span class="number">87700111</span>  <span class="number">2291137192904</span>   ?/<span class="number">1.1</span>T</span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.175</span>  <span class="number">3.01</span> TB    <span class="number">68711040</span>  <span class="number">1794574379750</span>   <span class="number">178</span>G/?</span><br><span class="line"><span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">4.46</span> TB    <span class="number">88088722</span>  <span class="number">2299781089484</span>   ?/<span class="number">1.4</span>T</span><br></pre></td></tr></table></figure>
<h3 id="整个集群做一次完整的快照迁移">整个集群做一次完整的快照迁移</h3><p>准备目录结构(只需执行一次)：<code>sh table.sh</code><br>在<code>/home/admin/cassandra/forseti_fp</code>下创建表目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/admin/cassandra/forseti_fp</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> /home/admin/cassandra/data/forseti_fp/*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="operator">-d</span> <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        table=`basename <span class="variable">$file</span>`</span><br><span class="line">        snap=`ls <span class="variable">$file</span>/snapshots`</span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$snap</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$table</span> <span class="variable">$snap</span></span><br><span class="line">            mkdir <span class="variable">$table</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>执行一次snapshot全量数据迁移(只需执行一次): <code>nohup sh snap.sh &gt; snap_alltable.log &amp;</code><br>拷贝<code>/home/admin/cassandra/data/forseti_fp/$table/snapshots/$snap/*</code> 到<code>/home/admin/cassandra/forseti_fp/$table</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> /home/admin/cassandra/data/forseti_fp/*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="operator">-d</span> <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        table=`basename <span class="variable">$file</span>`</span><br><span class="line">        snap=`ls <span class="variable">$file</span>/snapshots`</span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$snap</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            mv <span class="variable">$file</span>/snapshots/<span class="variable">$snap</span>/* /home/admin/cassandra/forseti_fp/<span class="variable">$table</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"smart_device_map"</span> == <span class="variable">$table</span> ]||[ <span class="string">"android_device_session_temp"</span> == <span class="variable">$table</span> ]||[ <span class="string">"android_device_session"</span> == <span class="variable">$table</span> ]||[ <span class="string">"android_device"</span> == <span class="variable">$table</span> ]||[ <span class="string">"analysis"</span> == <span class="variable">$table</span> ]||[ <span class="string">"device_session"</span> == <span class="variable">$table</span> ]; <span class="keyword">then</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">" "</span></span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$table</span> <span class="variable">$snap</span></span><br><span class="line">                /usr/install/cassandra/bin/sstableloader <span class="operator">-d</span> <span class="number">192.168</span>.<span class="number">50.20</span>,<span class="number">192.168</span>.<span class="number">50.21</span>,<span class="number">192.168</span>.<span class="number">50.22</span>,<span class="number">192.168</span>.<span class="number">50.23</span>,<span class="number">192.168</span>.<span class="number">50.24</span> /home/admin/cassandra/forseti_fp/<span class="variable">$table</span></span><br><span class="line">            <span class="keyword">fi</span>        </span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：android_device_session表已经同步过了，所以不需要再次同步</p>
</blockquote>
<h3 id="增量备份（需要多次执行）">增量备份（需要多次执行）</h3><p>执行增量迁移: nohup sh increment.sh  &gt; increment0616.log 2&gt;&amp;1 &amp;<br>把<code>/home/admin/cassandra/forseti_fp/$table/backups/*</code> 拷贝到 <code>/home/admin/cassandra/forseti_fp/$table</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> /home/admin/cassandra/data/forseti_fp/*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="operator">-d</span> <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        table=`basename <span class="variable">$file</span>`</span><br><span class="line">        <span class="keyword">if</span> [ <span class="operator">-d</span> <span class="string">"<span class="variable">$file</span>/backups"</span> ]; <span class="keyword">then</span></span><br><span class="line">            rm /home/admin/cassandra/forseti_fp/<span class="variable">$table</span>/*</span><br><span class="line">            <span class="built_in">cd</span> <span class="variable">$file</span>/backups</span><br><span class="line">            ls | xargs -t -I &#123;&#125; mv &#123;&#125; /home/admin/cassandra/forseti_fp/<span class="variable">$table</span>/</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"smart_device_map"</span> == <span class="variable">$table</span> ]||[ <span class="string">"android_device_session_temp"</span> == <span class="variable">$table</span> ]||[ <span class="string">"android_device"</span> == <span class="variable">$table</span> ]||[ <span class="string">"analysis"</span> == <span class="variable">$table</span> ]||[ <span class="string">"device_session"</span> == <span class="variable">$table</span> ]; <span class="keyword">then</span></span><br><span class="line">              <span class="built_in">echo</span> <span class="string">" "</span></span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$table</span></span><br><span class="line">                /usr/install/cassandra/bin/sstableloader <span class="operator">-d</span> <span class="number">192.168</span>.<span class="number">50.20</span>,<span class="number">192.168</span>.<span class="number">50.21</span>,<span class="number">192.168</span>.<span class="number">50.22</span>,<span class="number">192.168</span>.<span class="number">50.23</span>,<span class="number">192.168</span>.<span class="number">50.24</span> /home/admin/cassandra/forseti_fp/<span class="variable">$table</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：要把android_device_session表加上，backups都必须同步</p>
</blockquote>
<p>vi increment_timer.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ps -fe|grep BulkLoader |grep -v grep</span><br><span class="line"><span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">start=$(date +%s)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"可以开始处理。。。"</span></span><br><span class="line">sh increment.sh</span><br><span class="line">end=$(date +%s)</span><br><span class="line">timeT=$(( <span class="variable">$end</span> - <span class="variable">$start</span> ))</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"COST:<span class="variable">$timeT</span>, start:<span class="variable">$start</span>, end: <span class="variable">$end</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"BulkLoader正在运行，请稍等"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>定时任务脚本：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> *<span class="regexp">/2 * * * sh /home</span><span class="regexp">/admin/cassandra</span><span class="regexp">/increment_timer.sh</span><br><span class="line">tail -f /var</span><span class="regexp">/spool/mail</span><span class="regexp">/admin</span><br><span class="line">crontab -e</span></span><br></pre></td></tr></table></figure>
<p>228一个节点所有表的耗时(一次backups), 大概1G花费1min</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="list">[<span class="keyword">admin@192-168-48-228</span> cassandra]$ cat nohup.out  | grep <span class="string">"Total duration"</span></span><br><span class="line"><span class="number">50</span>M     android_device_index        Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">26</span></span><br><span class="line"><span class="number">525</span>G    android_device_session      Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">25291</span><span class="list">(<span class="keyword">7h=420m</span>)</span></span><br><span class="line"><span class="number">71</span>M     android_device_time         Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">30</span></span><br><span class="line"><span class="number">5.3</span>G    api_invoke_result           Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">561</span></span><br><span class="line"><span class="number">1.6</span>G    device                      Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">288</span></span><br><span class="line"><span class="number">3.9</span>G    devicedbmap                 Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">316</span></span><br><span class="line"><span class="number">66</span>G     device_session_map          Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">4563</span><span class="list">(<span class="keyword">76min</span>)</span></span><br><span class="line"><span class="number">2.1</span>G    ios_device_index            Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">151</span></span><br><span class="line"><span class="number">4.5</span>G    ios_device_info             Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">342</span></span><br><span class="line"><span class="number">4.8</span>G    ios_device_session          Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">353</span></span><br><span class="line"><span class="number">373</span>M    ip_device_id                Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">53</span></span><br><span class="line"><span class="number">7.3</span>G    page_info                   Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">536</span></span><br><span class="line"><span class="number">3.3</span>G    tcp_stack_ua                Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">276</span></span><br><span class="line"><span class="number">9.6</span>G    tcp_syn_data                Total duration <span class="list">(<span class="keyword">s</span>)</span>:          : <span class="number">686</span></span></span><br></pre></td></tr></table></figure>
<h3 id="机房迁移">机房迁移</h3><p>准备工作：</p>
<ol>
<li>老集群的snapshot和backups同步到新集群</li>
<li>？？</li>
</ol>
<h4 id="直接从当前集群同步到上海集群">直接从当前集群同步到上海集群</h4><p><strong>有节点挂掉</strong>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[admin@<span class="number">192</span>-<span class="number">168</span>-<span class="number">48</span>-<span class="number">228</span> ~]$ /usr/install/cassandra/bin/sstableloader -d <span class="number">10.21</span>.<span class="number">21.20</span> -t <span class="number">50</span> /home/admin/cassandra/forseti_fp/device</span><br><span class="line">ERROR <span class="number">11</span>:<span class="number">11</span>:<span class="number">56</span> Error creating pool to /<span class="number">10.21</span>.<span class="number">21.22</span>:<span class="number">9042</span></span><br><span class="line">com<span class="class">.datastax</span><span class="class">.driver</span><span class="class">.core</span><span class="class">.TransportException</span>: [/<span class="number">10.21</span>.<span class="number">21.22</span>:<span class="number">9042</span>] Cannot connect</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.driver</span><span class="class">.core</span><span class="class">.Connection</span>$<span class="number">1</span>.<span class="function"><span class="title">operationComplete</span><span class="params">(Connection.java:<span class="number">156</span>)</span></span> [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.driver</span><span class="class">.core</span><span class="class">.Connection</span>$<span class="number">1</span>.<span class="function"><span class="title">operationComplete</span><span class="params">(Connection.java:<span class="number">139</span>)</span></span> [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.DefaultPromise</span><span class="class">.notifyListener0</span>(DefaultPromise<span class="class">.java</span>:<span class="number">680</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.DefaultPromise</span><span class="class">.notifyListeners0</span>(DefaultPromise<span class="class">.java</span>:<span class="number">603</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.DefaultPromise</span><span class="class">.notifyListeners</span>(DefaultPromise<span class="class">.java</span>:<span class="number">563</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.DefaultPromise</span><span class="class">.tryFailure</span>(DefaultPromise<span class="class">.java</span>:<span class="number">424</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.AbstractNioChannel</span><span class="variable">$AbstractNioUnsafe</span>.<span class="function"><span class="title">fulfillConnectPromise</span><span class="params">(AbstractNioChannel.java:<span class="number">268</span>)</span></span> [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.AbstractNioChannel</span><span class="variable">$AbstractNioUnsafe</span>.<span class="function"><span class="title">finishConnect</span><span class="params">(AbstractNioChannel.java:<span class="number">284</span>)</span></span> [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.NioEventLoop</span><span class="class">.processSelectedKey</span>(NioEventLoop<span class="class">.java</span>:<span class="number">528</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.NioEventLoop</span><span class="class">.processSelectedKeysOptimized</span>(NioEventLoop<span class="class">.java</span>:<span class="number">468</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.NioEventLoop</span><span class="class">.processSelectedKeys</span>(NioEventLoop<span class="class">.java</span>:<span class="number">382</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.NioEventLoop</span><span class="class">.run</span>(NioEventLoop<span class="class">.java</span>:<span class="number">354</span>) [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.SingleThreadEventExecutor</span>$<span class="number">2</span>.<span class="function"><span class="title">run</span><span class="params">(SingleThreadEventExecutor.java:<span class="number">111</span>)</span></span> [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">Caused by: java<span class="class">.net</span><span class="class">.ConnectException</span>: 拒绝连接: /<span class="number">10.21</span>.<span class="number">21.22</span>:<span class="number">9042</span></span><br><span class="line">  at sun<span class="class">.nio</span><span class="class">.ch</span><span class="class">.SocketChannelImpl</span><span class="class">.checkConnect</span>(Native Method) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at sun<span class="class">.nio</span><span class="class">.ch</span><span class="class">.SocketChannelImpl</span><span class="class">.finishConnect</span>(SocketChannelImpl<span class="class">.java</span>:<span class="number">739</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.socket</span><span class="class">.nio</span><span class="class">.NioSocketChannel</span><span class="class">.doFinishConnect</span>(NioSocketChannel<span class="class">.java</span>:<span class="number">224</span>) ~[cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  at com<span class="class">.datastax</span><span class="class">.shaded</span><span class="class">.netty</span><span class="class">.channel</span><span class="class">.nio</span><span class="class">.AbstractNioChannel</span><span class="variable">$AbstractNioUnsafe</span>.<span class="function"><span class="title">finishConnect</span><span class="params">(AbstractNioChannel.java:<span class="number">281</span>)</span></span> [cassandra-driver-core-<span class="number">2.2</span>.<span class="number">0</span>-rc2-SNAPSHOT-<span class="number">20150617</span>-shaded<span class="class">.jar</span>:na]</span><br><span class="line">  ... <span class="number">6</span> common frames omitted</span><br><span class="line">Established connection to <span class="attribute">initial</span> hosts</span><br><span class="line">Opening sstables and calculating sections to stream</span><br><span class="line">..<span class="class">.Streaming</span> relevant part of /home/admin/cassan</span><br></pre></td></tr></table></figure>
<p><strong>版本不一样,拒绝连接</strong>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[admin@fp-cass048159 device]$ /usr/install/cassandra/bin/sstableloader -d <span class="number">10.21</span>.<span class="number">21.20</span> -t <span class="number">50</span> /home/admin/cassandra/forseti_fp/<span class="variable">$table</span></span><br><span class="line">Could not retrieve endpoint ranges:</span><br><span class="line">org<span class="class">.apache</span><span class="class">.thrift</span><span class="class">.transport</span><span class="class">.TTransportException</span>: java<span class="class">.net</span><span class="class">.ConnectException</span>: 拒绝连接</span><br><span class="line">java<span class="class">.lang</span><span class="class">.RuntimeException</span>: Could not retrieve endpoint ranges:</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="variable">$ExternalClient</span>.<span class="function"><span class="title">init</span><span class="params">(BulkLoader.java:<span class="number">342</span>)</span></span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.sstable</span><span class="class">.SSTableLoader</span><span class="class">.stream</span>(SSTableLoader<span class="class">.java</span>:<span class="number">156</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">109</span>)</span><br><span class="line">Caused by: org<span class="class">.apache</span><span class="class">.thrift</span><span class="class">.transport</span><span class="class">.TTransportException</span>: java<span class="class">.net</span><span class="class">.ConnectException</span>: 拒绝连接</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.thrift</span><span class="class">.transport</span><span class="class">.TSocket</span><span class="class">.open</span>(TSocket<span class="class">.java</span>:<span class="number">187</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.thrift</span><span class="class">.transport</span><span class="class">.TFramedTransport</span><span class="class">.open</span>(TFramedTransport<span class="class">.java</span>:<span class="number">81</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.thrift</span><span class="class">.TFramedTransportFactory</span><span class="class">.openTransport</span>(TFramedTransportFactory<span class="class">.java</span>:<span class="number">41</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="variable">$ExternalClient</span>.<span class="function"><span class="title">createThriftClient</span><span class="params">(BulkLoader.java:<span class="number">380</span>)</span></span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="variable">$ExternalClient</span>.<span class="function"><span class="title">init</span><span class="params">(BulkLoader.java:<span class="number">302</span>)</span></span></span><br><span class="line">  ... <span class="number">2</span> more</span><br><span class="line">Caused by: java<span class="class">.net</span><span class="class">.ConnectException</span>: 拒绝连接</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.PlainSocketImpl</span><span class="class">.socketConnect</span>(Native Method)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.AbstractPlainSocketImpl</span><span class="class">.doConnect</span>(AbstractPlainSocketImpl<span class="class">.java</span>:<span class="number">339</span>)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.AbstractPlainSocketImpl</span><span class="class">.connectToAddress</span>(AbstractPlainSocketImpl<span class="class">.java</span>:<span class="number">200</span>)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.AbstractPlainSocketImpl</span><span class="class">.connect</span>(AbstractPlainSocketImpl<span class="class">.java</span>:<span class="number">182</span>)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.SocksSocketImpl</span><span class="class">.connect</span>(SocksSocketImpl<span class="class">.java</span>:<span class="number">392</span>)</span><br><span class="line">  at java<span class="class">.net</span><span class="class">.Socket</span><span class="class">.connect</span>(Socket<span class="class">.java</span>:<span class="number">579</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.thrift</span><span class="class">.transport</span><span class="class">.TSocket</span><span class="class">.open</span>(TSocket<span class="class">.java</span>:<span class="number">182</span>)</span><br><span class="line">  ... <span class="number">6</span> more</span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin<span class="annotation">@fp</span>-cass048159 ~]$ <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/cqlsh <span class="number">10.21</span><span class="number">.21</span><span class="number">.20</span></span><br><span class="line">Connection <span class="string">error:</span> (<span class="string">'Unable to connect to any servers'</span>, &#123;<span class="string">'10.21.21.20'</span>: </span><br><span class="line">ProtocolError(<span class="string">"cql_version '3.2.1' is not supported by remote (w/ native protocol). Supported versions: [u'3.3.1']"</span>,)&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>sstableloader 100%后卡住</strong>  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@<span class="number">192</span>-<span class="number">168</span>-<span class="number">48</span>-<span class="number">228</span> ~]$ tail -c <span class="number">500</span> nohup.out</span><br><span class="line">progress: [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.23</span>]<span class="number">0</span>:<span class="number">60</span>/<span class="number">60</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.21</span>]<span class="number">0</span>:<span class="number">65</span>/<span class="number">65</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.20</span>]<span class="number">0</span>:<span class="number">63</span>/<span class="number">63</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.19</span>]<span class="number">0</span>:<span class="number">60</span>/<span class="number">60</span> <span class="number">100</span>% </span><br><span class="line">[/<span class="number">10.21</span><span class="number">.21</span><span class="number">.26</span>]<span class="number">0</span>:<span class="number">60</span>/<span class="number">60</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.25</span>]<span class="number">0</span>:<span class="number">63</span>/<span class="number">63</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.24</span>]<span class="number">0</span>:<span class="number">64</span>/<span class="number">64</span> <span class="number">100</span>%</span><br><span class="line">progress: [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.23</span>]<span class="number">0</span>:<span class="number">60</span>/<span class="number">60</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.21</span>]<span class="number">0</span>:<span class="number">65</span>/<span class="number">65</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.20</span>]<span class="number">0</span>:<span class="number">63</span>/<span class="number">63</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.19</span>]<span class="number">0</span>:<span class="number">60</span>/<span class="number">60</span> <span class="number">100</span>% </span><br><span class="line">[/<span class="number">10.21</span><span class="number">.21</span><span class="number">.26</span>]<span class="number">0</span>:<span class="number">60</span>/<span class="number">60</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.25</span>]<span class="number">0</span>:<span class="number">63</span>/<span class="number">63</span> <span class="number">100</span>% [/<span class="number">10.21</span><span class="number">.21</span><span class="number">.24</span>]<span class="number">0</span>:<span class="number">64</span>/<span class="number">64</span> <span class="number">100</span>% total: <span class="number">100</span>% <span class="number">0</span>  MB/s(avg: <span class="number">2</span> MB/s)</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> S0C    S1C     S0U     S1U      EC       EU        OC         OU       PC     PU         YGC    YGCT    FGC    FGCT     GCT</span><br><span class="line"><span class="number">11264.0</span> <span class="number">11264.0</span> <span class="number">3525.9</span>  <span class="number">0.0</span>   <span class="number">1032704.0</span> <span class="number">346823.5</span>  <span class="number">342016.0</span>    <span class="number">9527.1</span>   <span class="number">21504.0</span> <span class="number">21335.9</span>     <span class="number">24</span>    <span class="number">0.466</span>   <span class="number">0</span>      <span class="number">0.000</span>    <span class="number">0.466</span></span><br><span class="line"><span class="number">11264.0</span> <span class="number">11264.0</span> <span class="number">3525.9</span>  <span class="number">0.0</span>   <span class="number">1032704.0</span> <span class="number">346823.5</span>  <span class="number">342016.0</span>    <span class="number">9527.1</span>   <span class="number">21504.0</span> <span class="number">21335.9</span>     <span class="number">24</span>    <span class="number">0.466</span>   <span class="number">0</span>      <span class="number">0.000</span>    <span class="number">0.466</span></span><br><span class="line"><span class="number">11264.0</span> <span class="number">11264.0</span> <span class="number">3525.9</span>  <span class="number">0.0</span>   <span class="number">1032704.0</span> <span class="number">346823.5</span>  <span class="number">342016.0</span>    <span class="number">9527.1</span>   <span class="number">21504.0</span> <span class="number">21335.9</span>     <span class="number">24</span>    <span class="number">0.466</span>   <span class="number">0</span>      <span class="number">0.000</span>    <span class="number">0.466</span></span><br><span class="line"><span class="number">11264.0</span> <span class="number">11264.0</span> <span class="number">3525.9</span>  <span class="number">0.0</span>   <span class="number">1032704.0</span> <span class="number">346823.5</span>  <span class="number">342016.0</span>    <span class="number">9527.1</span>   <span class="number">21504.0</span> <span class="number">21335.9</span>     <span class="number">24</span>    <span class="number">0.466</span>   <span class="number">0</span>      <span class="number">0.000</span>    <span class="number">0.466</span></span><br></pre></td></tr></table></figure>
<p><strong>FP主要的表迁移：</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">device</span></span><br><span class="line"><span class="keyword">android_device_index</span><br><span class="line"></span><span class="keyword">android_device_time</span><br><span class="line"></span><span class="label">ios_device_index</span></span><br><span class="line"><span class="label">ios_device_info</span></span><br></pre></td></tr></table></figure>
<p>查看数据量：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cd /home/admin/cassandra/data/forseti_fp</span><br><span class="line">$ du -sh <span class="keyword">*</span> |<span class="string"> egrep 'android_device_index</span>|<span class="string">android_device_time</span>|<span class="string">ios_device_index</span>|<span class="string">ios_device_info'</span><br><span class="line">869M  android_device_index</span><br><span class="line">1023M android_device_time</span><br><span class="line">23G ios_device_index</span><br><span class="line">54G ios_device_info</span></span><br></pre></td></tr></table></figure>
<p>48.228: 还剩device和ios_device_info<br>227: 升级完，7-7 9<br>226: 升级完，7-8 2<br>159：升级完，7-8 6</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#####先测试一个表</span><br><span class="line">ll /home/admin/cassandra/data/forseti_fp/android_device_index/snapshots/<span class="label">$snapTime</span></span><br><span class="line"><span class="keyword">mkdir</span> -p /home/admin/cassandra/forseti_fp/device</span><br><span class="line"><span class="keyword">cd</span> /home/admin/cassandra/data/forseti_fp/device/snapshots/<span class="label">$snapTime</span></span><br><span class="line"><span class="keyword">ls</span> | xargs -t -I &#123;&#125; mv &#123;&#125; /home/admin/cassandra/forseti_fp/device/</span><br><span class="line">/usr/install/cassandra/bin/sstableloader -<span class="keyword">d</span> 10.21.21.20 -t 50 /home/admin/cassandra/forseti_fp/device</span><br><span class="line"></span><br><span class="line">####脚本循环方式 load.<span class="keyword">sh</span></span><br><span class="line"><span class="keyword">rm</span> -rf /home/admin/cassandra/forseti_fp/</span><br><span class="line">/usr/install/cassandra/bin/nodetool snapshot forseti_fp &gt; snap.<span class="literal">log</span></span><br><span class="line">snapTime=`<span class="keyword">cat</span> snap.<span class="keyword">log</span> | grep directory | awk '&#123;<span class="keyword">print</span> <span class="label">$3&#125;</span>'`</span><br><span class="line">nums=('device' 'android_device_index' 'android_device_time' 'ios_device_index' 'ios_device_info')</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">table</span> <span class="keyword">in</span> <span class="label">$&#123;nums</span>[@]&#125;;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">mkdir</span> -p /home/admin/cassandra/forseti_fp/<span class="label">$table</span></span><br><span class="line">  <span class="keyword">cd</span> /home/admin/cassandra/data/forseti_fp/<span class="label">$table</span>/snapshots/<span class="label">$snapTime</span></span><br><span class="line">  <span class="keyword">ls</span> | xargs -t -I &#123;&#125; mv &#123;&#125; /home/admin/cassandra/forseti_fp/<span class="label">$table</span>/</span><br><span class="line">  /usr/install/cassandra/bin/sstableloader -<span class="keyword">d</span> 10.21.21.20 -t 100 /home/admin/cassandra/forseti_fp/<span class="label">$table</span></span><br><span class="line">done</span><br><span class="line">echo <span class="string">"end."</span></span><br><span class="line"></span><br><span class="line">crontab -<span class="literal">e</span></span><br><span class="line">00 6 8 7 * <span class="keyword">sh</span> /home/admin/load.<span class="keyword">sh</span> &gt; load.<span class="keyword">log</span> 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>多个节点做快照</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">nodetool status |grep RAC|awk '&#123;<span class="keyword">print</span> <span class="label">$2&#125;</span>' | <span class="keyword">while</span> <span class="keyword">read</span> ip; <span class="keyword">do</span> echo <span class="label">$ip</span>; nodetool -<span class="keyword">h</span> <span class="label">$ip</span> snapshot forseti_fp; done</span><br><span class="line">192.168.48.227</span><br><span class="line">Snapshot directory: 1467716730094</span><br><span class="line">192.168.48.226</span><br><span class="line">Snapshot directory: 1467716742257</span><br><span class="line">192.168.48.176</span><br><span class="line">Snapshot directory: 1467716753938</span><br><span class="line">192.168.48.161</span><br><span class="line">Requested creating snapshot(s) <span class="keyword">for</span> [forseti_fp] with snapshot name [1467716770566]</span><br><span class="line">192.168.48.228</span><br><span class="line">Snapshot directory: 1467716780650</span><br><span class="line">192.168.48.160</span><br><span class="line">Requested creating snapshot(s) <span class="keyword">for</span> [forseti_fp] with snapshot name [1467716792487]</span><br><span class="line">192.168.48.175</span><br><span class="line">Requested creating snapshot(s) <span class="keyword">for</span> [forseti_fp] with snapshot name [1467716802910]</span><br><span class="line">192.168.48.159</span><br><span class="line">Requested creating snapshot(s) <span class="keyword">for</span> [forseti_fp] with snapshot name [1467716815575]</span><br><span class="line"></span><br><span class="line">以159为例：</span><br><span class="line">[admin@fp-cass048159 ~]$ ll /home/admin/cassandra/data/forseti_fp/android_device_session/snapshots/</span><br><span class="line">总用量 4</span><br><span class="line">drwxr-xr-x. 2 admin admin 4096 7月   5 19:07 1467716815575</span><br><span class="line"></span><br><span class="line">declare -A map=([<span class="string">"192.168.48.227"</span>]=<span class="string">"1467716730094"</span> [<span class="string">"192.168.48.226"</span>]=<span class="string">"1467716742257"</span> </span><br><span class="line">[<span class="string">"192.168.48.176"</span>]=<span class="string">"1467716753938"</span> [<span class="string">"192.168.48.161"</span>]=<span class="string">"1467716770566"</span> </span><br><span class="line">[<span class="string">"192.168.48.228"</span>]=<span class="string">"1467716780650"</span> [<span class="string">"192.168.48.160"</span>]=<span class="string">"1467716792487"</span> </span><br><span class="line">[<span class="string">"192.168.48.175"</span>]=<span class="string">"1467716802910"</span> [<span class="string">"192.168.48.159"</span>]=<span class="string">"1467716815575"</span>)</span><br><span class="line">host=`ifconfig | grep <span class="string">"192.168.4"</span> | awk '/inet addr/&#123;sub(<span class="string">"addr:"</span>,<span class="string">""</span>); <span class="keyword">print</span> <span class="label">$2&#125;</span>'`</span><br><span class="line">snapshot=<span class="label">$&#123;map</span>[<span class="string">"$host"</span>]&#125;</span><br><span class="line">snapshotAbs=<span class="string">"/home/admin/cassandra/data/forseti_fp/android_device_session/snapshots/$snapshot"</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">rm</span> -rf /home/admin/cassandra/forseti_fp/</span><br><span class="line">#<span class="keyword">mkdir</span> -p /home/admin/cassandra/forseti_fp/</span><br><span class="line"><span class="keyword">table</span>=<span class="string">"device"</span></span><br><span class="line"><span class="keyword">mkdir</span> -p /home/admin/cassandra/forseti_fp/<span class="label">$table</span></span><br><span class="line"><span class="keyword">cd</span> <span class="label">$snapshotAbs</span></span><br><span class="line"><span class="keyword">ls</span> | xargs -t -I &#123;&#125; mv &#123;&#125; /home/admin/cassandra/forseti_fp/<span class="label">$table</span>/</span><br><span class="line">/usr/install/cassandra/bin/sstableloader -t 50 -<span class="keyword">d</span> 10.21.21.20 /home/admin/cassandra/forseti_fp/<span class="label">$table</span></span><br></pre></td></tr></table></figure>
<h4 id="新集群安装">新集群安装</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">rm</span> -rf apache-cassandra-2.2.6 &amp; <span class="keyword">rm</span> apache-cassandra-2.2.6-bin.tar.gz &amp; <span class="keyword">rm</span> -rf <span class="keyword">test</span></span><br><span class="line">wget http:<span class="comment">//192.168.47.211:8000/apache-cassandra-2.2.6-bin.tar.gz</span></span><br><span class="line">tar zxf apache-cassandra-2.2.6-bin.tar.gz</span><br><span class="line"></span><br><span class="line">#<span class="keyword">cluster</span>=sh_velocity</span><br><span class="line">#seeds=10.21.21.11,10.21.21.12,10.21.21.13</span><br><span class="line"></span><br><span class="line">#<span class="keyword">cluster</span>=sh_fp</span><br><span class="line">#seeds=10.21.21.19,10.21.21.20,10.21.21.21</span><br><span class="line"></span><br><span class="line"><span class="keyword">cluster</span>=sh_galaxy</span><br><span class="line">seeds=10.21.21.131,10.21.21.132</span><br><span class="line"></span><br><span class="line"><span class="keyword">mkdir</span> data</span><br><span class="line">host=`ifconfig | grep <span class="string">"10.21.21."</span> | awk '/inet addr/&#123;sub(<span class="string">"addr:"</span>,<span class="string">""</span>); <span class="keyword">print</span> <span class="label">$2&#125;</span>'`</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s/localhost/$host/g"</span> apache-cassandra-2.2.6/<span class="keyword">conf</span>/cassandra.yaml</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s#localhost#$host#g"</span> apache-cassandra-2.2.6/<span class="keyword">conf</span>/cassandra-env.<span class="keyword">sh</span></span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s/127.0.0.1/$seeds/g"</span> apache-cassandra-2.2.6/<span class="keyword">conf</span>/cassandra.yaml</span><br><span class="line">sed -i -<span class="keyword">e</span> <span class="string">"s/Test Cluster/$cluster/g"</span> apache-cassandra-2.2.6/<span class="keyword">conf</span>/cassandra.yaml</span><br><span class="line">ln -s apache-cassandra-2.2.6 cassandra</span><br><span class="line"></span><br><span class="line">cassandra/bin/cassandra</span><br><span class="line">cassandra/bin/nodetool status</span><br><span class="line">cassandra/bin/nodetool -<span class="keyword">h</span> 10.21.21.10 status</span><br><span class="line">cassandra/bin/nodetool -<span class="keyword">h</span> 10.21.21.19 status</span><br><span class="line">cassandra/bin/nodetool -<span class="keyword">h</span> 10.21.21.131 status</span><br></pre></td></tr></table></figure>
<h4 id="1-_表结构">1. 表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="operator"><span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">'desc keyspace forseti'</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> &gt; forseti_api.cql</span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">'desc keyspace forseti'</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span> &gt; forseti.cql</span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">'desc keyspace forseti_fp'</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span> &gt; forseti_fp.cql</span><br><span class="line">/usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/cqlsh -<span class="keyword">e</span> <span class="string">'desc keyspace realtime'</span> <span class="number">192.168</span><span class="number">.49</span><span class="number">.56</span> &gt; forseti_galaxy.cql</span><br><span class="line"></span><br><span class="line">wget <span class="keyword">http</span>://<span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span>:<span class="number">8000</span>/forseti.cql</span><br><span class="line">wget <span class="keyword">http</span>://<span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span>:<span class="number">8000</span>/forseti_fp.cql</span><br><span class="line">wget <span class="keyword">http</span>://<span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span>:<span class="number">8000</span>/forseti_galaxy.cql</span><br><span class="line">cassandra/<span class="keyword">bin</span>/cqlsh <span class="number">10.21</span><span class="number">.21</span><span class="number">.11</span> -<span class="keyword">f</span> forseti.cql</span><br><span class="line">cassandra/<span class="keyword">bin</span>/cqlsh <span class="number">10.21</span><span class="number">.21</span><span class="number">.19</span> -<span class="keyword">f</span> forseti_fp.cql</span><br><span class="line">cassandra/<span class="keyword">bin</span>/cqlsh <span class="number">10.21</span><span class="number">.21</span><span class="number">.131</span> -<span class="keyword">f</span> forseti_galaxy.cql</span></span><br></pre></td></tr></table></figure>
<h4 id="2-_数据迁移">2. 数据迁移</h4><h4 id="3-_增量数据迁移">3. 增量数据迁移</h4><h4 id="4-_数据验证">4. 数据验证</h4><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/hadoop/bin/hadoop fs -cat /user/tongdun/velocity/raw/<span class="number">2016</span>-<span class="number">6</span>-<span class="number">9</span>/part-<span class="number">00000</span> | head</span><br><span class="line"> <span class="number">115.55</span><span class="number">.206</span><span class="localvars">|sdo|sdo_client|ip3|</span><span class="number">1465401548233</span>|<span class="number">1465401548238838</span>F30790E445243217|&#123;<span class="comment">"state"</span>:<span class="comment">"0"</span>,<span class="comment">"ipAddressProvince"</span>:<span class="comment">"河南省"</span>,<span class="comment">"ipAddressCity"</span>:<span class="comment">"鹤壁市"</span>,<span class="comment">"ipAddress"</span>:<span class="comment">"115.55.206.177"</span>,<span class="comment">"ext_is_gplus_login"</span>:<span class="comment">"0"</span>,<span class="comment">"ext_is_bingding_mobile"</span>:<span class="comment">"0"</span>,<span class="comment">"eventType"</span>:<span class="comment">"Login"</span>,<span class="comment">"eventOccurTime"</span>:<span class="comment">"1465401548233"</span>,<span class="comment">"deviceId"</span>:<span class="comment">"00-0C-29-BC-62-D1"</span>,<span class="comment">"accountLogin"</span>:<span class="comment">"166f751ebf90b9fbb38977d75b1265f6"</span>,<span class="comment">"eventId"</span>:<span class="comment">"login_client"</span>,<span class="comment">"partnerCode"</span>:<span class="comment">"sdo"</span>,<span class="comment">"ip3"</span>:<span class="comment">"115.55.206"</span>,<span class="comment">"location"</span>:<span class="comment">"鹤壁市"</span>,<span class="comment">"status"</span>:<span class="comment">"Review"</span>&#125;</span><br><span class="line"></span><br><span class="line">select * from velocity_app where attribute=<span class="string">'115.55.206'</span> and type=<span class="string">'ip3'</span> and partner_code=<span class="string">'sdo'</span> and app_name=<span class="string">'sdo_client'</span> and sequence_id &gt; <span class="string">'1465401548238838F30790E445243210'</span> and sequence_id &lt; <span class="string">'1465401548238838F30790E445243220'</span>;</span><br><span class="line"></span><br><span class="line"> <span class="number">115.55</span><span class="number">.206</span> <span class="localvars">|          sdo | sdo_client |  ip3 |</span> <span class="number">1465401548238838</span>F30790E445243217 | &#123;<span class="comment">"state"</span>:<span class="comment">"0"</span>,<span class="comment">"ipAddressProvince"</span>:<span class="comment">"河南省"</span>,<span class="comment">"ipAddressCity"</span>:<span class="comment">"鹤壁市"</span>,<span class="comment">"ipAddress"</span>:<span class="comment">"115.55.206.177"</span>,<span class="comment">"ext_is_gplus_login"</span>:<span class="comment">"0"</span>,<span class="comment">"ext_is_bingding_mobile"</span>:<span class="comment">"0"</span>,<span class="comment">"eventType"</span>:<span class="comment">"Login"</span>,<span class="comment">"eventOccurTime"</span>:<span class="comment">"1465401548233"</span>,<span class="comment">"deviceId"</span>:<span class="comment">"00-0C-29-BC-62-D1"</span>,<span class="comment">"accountLogin"</span>:<span class="comment">"166f751ebf90b9fbb38977d75b1265f6"</span>,<span class="comment">"eventId"</span>:<span class="comment">"login_client"</span>,<span class="comment">"partnerCode"</span>:<span class="comment">"sdo"</span>,<span class="comment">"ip3"</span>:<span class="comment">"115.55.206"</span>,<span class="comment">"location"</span>:<span class="comment">"鹤壁市"</span>,<span class="comment">"status"</span>:<span class="comment">"Review"</span>&#125; | <span class="number">1465401548233</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="nodetool工具">nodetool工具</h2><h3 id="集群状态:_nodetool_decribecluster">集群状态: nodetool decribecluster</h3><p>启动OpsCenter后, 在8888上新建Cluster时报异常:  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:07+08</span>00 [forseti_cluster]  WARN: Node <span class="number">192.168.47.206</span> is reporting a schema disagreement: </span><br><span class="line">&#123;UUID('bc083db4-b<span class="number">544-38d1</span>-a37c-be3e78db1df1'): ['<span class="number">192.168.47.229</span>'], </span><br><span class="line">UUID('<span class="number">67462d4</span>d-a<span class="number">9c9-38a1</span>-afd<span class="number">8-1a39172</span>32b8a'): ['<span class="number">192.168.47.203</span>', '<span class="number">192.168.47.228</span>', '<span class="number">192.168.47.227</span>', '<span class="number">192.168.47.202</span>', '<span class="number">192.168.47.225</span>', '<span class="number">192.168.47.204</span>', '<span class="number">192.168.47.205</span>', '<span class="number">192.168.47.206</span>', '<span class="number">192.168.47.221</span>', '<span class="number">192.168.47.222</span>', '<span class="number">192.168.47.224</span>']&#125;</span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:07+08</span>00 []  WARN: [control connection] No schema built on connect<span class="comment">; retrying without wait for schema agreement</span></span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:13+08</span>00 []  WARN: Host <span class="number">192.168.47.229</span> has been marked down</span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:46:14+08</span>00 []  WARN: Failed to create connection pool for new host <span class="number">192.168.47.229</span>: errors=Timed out creating connection, last_host=None</span><br><span class="line"><span class="number">2015-10-31</span> <span class="number">13:47:07+08</span>00 []  INFO: Host <span class="number">192.168.47.229</span> may be up<span class="comment">; will prepare queries and open connection pool</span></span><br></pre></td></tr></table></figure>
<p>按照这里的方式, 如果状态为UNREACHABLE,则重启后再观察.<br><a href="http://docs.datastax.com/en/cassandra/2.1/cassandra/troubleshooting/trblshootSchemaDisagree.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.1/cassandra/troubleshooting/trblshootSchemaDisagree.html</a>  </p>
<p>果然有一个状态是UNREACHABLE的:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">    Name: forseti_cluster</span><br><span class="line">    Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">    Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">    Schema versions:</span><br><span class="line">        <span class="number">3e4</span>c6580-<span class="number">3</span>d3c-<span class="number">327</span>b-<span class="number">986</span>c-<span class="number">63086e93</span>e94f: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br><span class="line">        UNREACHABLE: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>]</span><br></pre></td></tr></table></figure>
<p>发现229当掉, 重启后, 版本不一致:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">    Name: forseti_cluster</span><br><span class="line">    Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">    Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">    Schema versions:</span><br><span class="line">        <span class="number">3e4</span>c6580-<span class="number">3</span>d3c-<span class="number">327</span>b-<span class="number">986</span>c-<span class="number">63086e93</span>e94f: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br><span class="line"></span><br><span class="line">        d2601534-c7ff-<span class="number">394</span>d-a656-<span class="number">33</span>d9da3dc574: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>]</span><br></pre></td></tr></table></figure>
<p>但是在229上查看到所有节点都不可达:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">    Name: forseti_cluster</span><br><span class="line">    Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">    Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">    Schema versions:</span><br><span class="line">        UNREACHABLE: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br></pre></td></tr></table></figure>
<p>229过了段时间因为GC, 再次重启, 再次查看, 版本一样了:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">229</span> ~]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">  Name: forseti_cluster</span><br><span class="line">  Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">  Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">  Schema versions:</span><br><span class="line">    <span class="number">977</span>ca50d-<span class="number">70</span>ab-<span class="number">3f</span>45-a1e6-ca18560b0c29: [<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span>, <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>]</span><br></pre></td></tr></table></figure>
<h3 id="删除节点:_removenode">删除节点: removenode</h3><p><a href="http://zhaoyanblog.com/archives/533.html" target="_blank" rel="external">http://zhaoyanblog.com/archives/533.html</a></p>
<p><code>A</code>.对正在运行Cassandra进程的节点下线,或者在其他节点-h指定要下线的目标节点. 运行命令的节点会有NodeCmd进程.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool decommission</span><br><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool decommission -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.226</span></span><br></pre></td></tr></table></figure>
<p><code>B</code>.如果节点已经下线,比如进程被杀死, 则在正常的节点上删除节点:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool status 获取宕机节点的host-id</span><br><span class="line">/usr/install/apache-cassandra-<span class="number">2.0</span><span class="number">.16</span>/bin/nodetool removenode  <span class="number">2591</span>cec9-<span class="number">42f</span>9-<span class="number">4f</span>60-a622-<span class="number">00</span>d463910994</span><br></pre></td></tr></table></figure>
<p><code>C</code>.进程挂住的解决办法:<br>1).线上采用decommission后, 发现执行了很久都没有完成. 后来发现是streamming的一个bug:<br>nodetool removenode hangs: <a href="https://issues.apache.org/jira/browse/CASSANDRA-6542" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-6542</a>,<br><a href="http://stackoverflow.com/questions/25943261/nodetool-removenode-stuck-during-removal" target="_blank" rel="external">http://stackoverflow.com/questions/25943261/nodetool-removenode-stuck-during-removal</a><br>Streams hang in repair: <a href="https://issues.apache.org/jira/browse/CASSANDRA-8472" target="_blank" rel="external">https://issues.apache.org/jira/browse/CASSANDRA-8472</a></p>
<blockquote>
<p>Streaming hanging is a familiar trouble in my cluster (2.0/2.1). In my experience,<br>the node that being restarted recently won’t hang the streaming.<br>So each time when I want to add or remove a node, I will restart all nodes one by one.<br>这种方式在线上是不可行的, 需要重启线上的每个节点. 于是尝试使用force直接中断.  </p>
</blockquote>
<p>2).杀掉226的Cassandra进程, 在202上使用B方式removenode删除226. 不过removenode也存在hang的情况.   </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode status</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">918468213369</span><span class="number">8409841</span>). Waiting for replication confirmation from [/<span class="number">192.168.47.206</span>,/<span class="number">192.168.47.222</span>,/<span class="number">192.168.47.221</span>,/<span class="number">192.168.47.204</span>,/<span class="number">192.168.47.205</span>,/<span class="number">192.168.47.202</span>,/<span class="number">192.168.47.224</span>,/<span class="number">192.168.47.225</span>].</span><br></pre></td></tr></table></figure>
<p>3).由于nodetool命令都是调用JMX方法,所以尽管kill掉进程,命令对应的进程实际是还存在的.  </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>jps</span><br><span class="line"><span class="number">8596</span> <span class="constant">NodeCmd</span></span><br><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>kill -<span class="number">9</span> <span class="number">8596</span></span><br><span class="line">[qihuang.zheng<span class="variable">@cass047202</span> ~]<span class="variable">$ </span>nodetool removenode status</span><br><span class="line"><span class="constant">RemovalStatus</span>: <span class="constant">Removing</span> token (-<span class="number">9184682133698409841</span>). <span class="constant">Waiting</span> <span class="keyword">for</span> replication confirmation from [<span class="regexp">/192.168.47.206,/</span><span class="number">192.168</span>.<span class="number">47.222</span>,<span class="regexp">/192.168.47.221,/</span><span class="number">192.168</span>.<span class="number">47.204</span>,<span class="regexp">/192.168.47.205,/</span><span class="number">192.168</span>.<span class="number">47.202</span>,<span class="regexp">/192.168.47.224,/</span><span class="number">192.168</span>.<span class="number">47.225</span>].</span><br></pre></td></tr></table></figure>
<p>4).删除操作正在进行,不能重复执行removenode命令,不过提示信息给了我们另一种解决方案.  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">UN  <span class="number">192.168</span>.<span class="number">47.202</span>  <span class="number">612.13</span> GB  <span class="number">256</span>     <span class="number">7.4%</span>   abaa0cbc-<span class="number">09</span>d3-<span class="number">4990</span>-<span class="number">8698</span>-ff4d2f2bb4f7  RAC1</span><br><span class="line">DL  <span class="number">192.168</span>.<span class="number">47.226</span>  <span class="number">406.34</span> GB  <span class="number">256</span>     <span class="number">7.6%</span>   <span class="number">2591</span>cec9-<span class="number">42</span>f9-<span class="number">4</span>f60-a622-<span class="number">00</span>d463910994  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode <span class="number">2591</span>cec9-<span class="number">42</span>f9-<span class="number">4</span>f60-a622-<span class="number">00</span>d463910994</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.UnsupportedOperationException</span>: This node is already processing <span class="tag">a</span> removal. Wait <span class="keyword">for</span> it to complete, or use <span class="string">'removenode force'</span> <span class="keyword">if</span> this has failed.</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.StorageService</span><span class="class">.removeNode</span>(StorageService<span class="class">.java</span>:<span class="number">3342</span>)</span><br><span class="line">  ...</span><br><span class="line">  at com<span class="class">.sun</span><span class="class">.jmx</span><span class="class">.interceptor</span><span class="class">.DefaultMBeanServerInterceptor</span><span class="class">.invoke</span>(DefaultMBeanServerInterceptor<span class="class">.java</span>:<span class="number">819</span>)</span><br><span class="line">  at com<span class="class">.sun</span><span class="class">.jmx</span><span class="class">.mbeanserver</span><span class="class">.JmxMBeanServer</span><span class="class">.invoke</span>(JmxMBeanServer<span class="class">.java</span>:<span class="number">801</span>)</span><br></pre></td></tr></table></figure>
<p>5).如果removenode失败, 则强制删除, 使用<code>nodetool removenode force</code>命令,不需要跟上host-id.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode force 2591cec<span class="number">9-42f9-4</span>f60-a<span class="number">622-00d46</span><span class="number">3910994</span></span><br><span class="line">Missing an argument for removenode (either status, force, or an ID)</span><br><span class="line">usage: java org.apache.cassandra.tools.NodeCmd --host &lt;arg&gt; &lt;command&gt;</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode force</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">918468213369</span><span class="number">8409841</span>). Waiting for replication confirmation from [/<span class="number">192.168.47.206</span>,/<span class="number">192.168.47.222</span>,/<span class="number">192.168.47.221</span>,/<span class="number">192.168.47.204</span>,/<span class="number">192.168.47.205</span>,/<span class="number">192.168.47.202</span>,/<span class="number">192.168.47.224</span>,/<span class="number">192.168.47.225</span>].</span><br></pre></td></tr></table></figure>
<p>6).成功删除后, 下线的226节点不会出现在状态列表中, 并且集群的Owns也发生了变化. gossipinfo可以查看状态为removed.   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool removenode status</span><br><span class="line">RemovalStatus: No token removals in process.</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span>  <span class="number">612.13</span> GB  <span class="number">256</span>     <span class="number">8.1</span>%   abaa0cbc-<span class="number">09</span>d3-<span class="number">4990</span>-<span class="number">8698</span>-ff4d2f2bb4f7  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047204 ~]$ nodetool gossipinfo</span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.226</span></span><br><span class="line">  STATUS:removed,<span class="number">2591</span>cec9-<span class="number">42f</span>9-<span class="number">4f</span>60-a622-<span class="number">00</span>d463910994,<span class="number">1446339305944</span></span><br><span class="line">  REMOVAL_COORDINATOR:REMOVER,abaa0cbc-<span class="number">09</span>d3-<span class="number">4990</span>-<span class="number">8698</span>-ff4d2f2bb4f7</span><br></pre></td></tr></table></figure>
<p><code>D</code>.Active Streams:  </p>
<p>下图是对225进行decommission,225的数据通过streams转移到其他节点:  </p>
<p><img src="http://img.blog.csdn.net/20151030101713671" alt="streams"></p>
<h3 id="替换节点:_replace_address">替换节点: replace_address</h3><p><a href="http://zhaoyanblog.com/archives/591.html" target="_blank" rel="external">http://zhaoyanblog.com/archives/591.html</a><br><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_replace_node_t.html" target="_blank" rel="external">http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_replace_node_t.html</a></p>
<blockquote>
<p>CAUTION:<br>1.Wait at least 72 hours to ensure that old node information is removed from gossip.<br>If removed from the property file too soon, problems may result.<br>2.auto_bootstrap不能设置为false:<br>java.lang.RuntimeException: Trying to replace_address with auto_bootstrap disabled will not work, check your configuration</p>
</blockquote>
<p>要被替换的节点状态为DN, 新启动的节点启动时加上-Dcassandra.replace_address选项:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo -u admin /usr/install/cassandra/bin/cassandra -Dcassandra.replace_address=<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line"></span><br><span class="line"> WARN <span class="number">13</span>:<span class="number">49</span>:<span class="number">37</span>,<span class="number">423</span> Token -<span class="number">3920394820366823756</span> changing ownership from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> to /<span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span></span><br><span class="line"> INFO <span class="number">13</span>:<span class="number">50</span>:<span class="number">40</span>,<span class="number">122</span> Node /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> is now part of the cluster</span><br><span class="line"> WARN <span class="number">13</span>:<span class="number">50</span>:<span class="number">40</span>,<span class="number">127</span> Not updating token metadata <span class="keyword">for</span> /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> because I am replacing it</span><br><span class="line"> INFO <span class="number">13</span>:<span class="number">50</span>:<span class="number">40</span>,<span class="number">127</span> Nodes /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> and /<span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> have the same token -<span class="number">1001533036333769848.</span>  Ignoring /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> </span><br><span class="line"> INFO <span class="number">13</span>:<span class="number">51</span>:<span class="number">10</span>,<span class="number">272</span> FatClient /<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> has been silent <span class="keyword">for</span> <span class="number">30000</span>ms, removing from gossip</span><br></pre></td></tr></table></figure>
<p>查看节点的状态:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@fp-cass048160 ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">460.9</span> GB   <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">6.02</span> MB    <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.4</span> TB     <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">483.48</span> GB  <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">686.97</span> GB  <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">460.78</span> GB  <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.4</span> TB     <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">483.41</span> GB  <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">686.93</span> GB  <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.上面发现一个奇怪的现象就是229和160的HostID都是一样的, 所以日志中会有<code>have the same token ignoring</code><br>2.227并不认识160, 而是认为229状态为DN<br>3.160上能看到其他节点, 但是看不到229.  </p>
</blockquote>
<p>过了有一周, 再次查看发现还是上面的状况, 而且160的日志还是经常打印Ignoring…</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@fp-cass048160 ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">972.25</span> GB  <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">250.64</span> GB  <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.89</span> TB    <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1</span> TB       <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">972.16</span> GB  <span class="number">256</span>     <span class="number">20.1</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.89</span> TB    <span class="number">256</span>     <span class="number">19.2</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">21.2</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1</span> TB       <span class="number">256</span>     <span class="number">19.5</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">20.0</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<p>索性把160停掉重启(注意要加上auto_bootstrap:false), 现在227上能观察到160了. 但是160上还是看不到229.<br>不过更加奇怪的是229的HostID变成了null(因为出现160就不能同时再出现229了).这样子没办法removenode了.<br>其实也不能removenode了, 因为229和160的HostID之前是一样的!如果根据hostId删除,会把160也都删除掉了.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">973.32</span> GB  <span class="number">256</span>     <span class="number">17.4</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">250.93</span> GB  <span class="number">256</span>     <span class="number">15.4</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">5.89</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">17.8</span>%  null                                  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1</span> TB       <span class="number">256</span>     <span class="number">16.4</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<p>不能根据hostId来removenode 229, 那怎么删除229节点?  </p>
<p>下面采用JMX的方式也不行: <a href="https://gist.github.com/justenwalker/8338334" target="_blank" rel="external">https://gist.github.com/justenwalker/8338334</a>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ java -jar ./jmxterm<span class="class">.jar</span></span><br><span class="line">Welcome to JMX terminal. Type <span class="string">"help"</span> <span class="keyword">for</span> available commands.</span><br><span class="line">$&gt;open localhost:<span class="number">7199</span></span><br><span class="line"><span class="id">#Connection</span> to localhost:<span class="number">7199</span> is opened</span><br><span class="line">$&gt;bean org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.net</span>:type=Gossiper</span><br><span class="line"><span class="hexcolor">#bea</span>n is set to org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.net</span>:type=Gossiper</span><br><span class="line">$&gt;run unsafeAssassinateEndpoint <span class="number">192.168</span>.<span class="number">47.229</span></span><br><span class="line"><span class="id">#calling</span> operation unsafeAssassinateEndpoint of mbean org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.net</span>:type=Gossiper</span><br><span class="line"><span class="id">#RuntimeMBeanException</span>: java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br></pre></td></tr></table></figure>
<p><a href="https://gist.github.com/nstielau/3373649" target="_blank" rel="external">https://gist.github.com/nstielau/3373649</a>  </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java -jar jmxsh-R*.jar -h <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> -p <span class="number">7199</span></span><br><span class="line"></span><br><span class="line">% [Hit Enter <span class="keyword">to</span> go into Browse Mode]</span><br><span class="line"><span class="keyword">Select</span> a domain: [Enter <span class="built_in">number</span> <span class="keyword">for</span> org.apache.cassandra.net]</span><br><span class="line"><span class="keyword">Select</span> an mbean: [Enter <span class="built_in">number</span> <span class="keyword">for</span> org.apache.cassandra.net:type=Gossiper]</span><br><span class="line"><span class="keyword">Select</span> an attribute <span class="literal">or</span> operation: [Enter <span class="built_in">number</span> <span class="keyword">for</span> unsafeAssassinateEndpoint(<span class="built_in">String</span>  p1)]</span><br><span class="line">p1 (<span class="built_in">String</span>): <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line"></span><br><span class="line">It may also be possible <span class="keyword">to</span> <span class="built_in">run</span> it directly (untested):</span><br><span class="line">% jmx_invoke -m org.apache.cassandra.net:type=Gossiper unsafeAssassinateEndpoint &lt;STALE-IP-ADDRESS&gt;</span><br></pre></td></tr></table></figure>
<p>但最后还是报错NPE:  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">%</span><br><span class="line"><span class="header">Entering browse mode.</span><br><span class="line">====================================================</span></span><br><span class="line"><span class="code"> Available Domains:</span></span><br><span class="line"><span class="code">       1. org.apache.cassandra.internal</span></span><br><span class="line"><span class="code">       2. org.apache.cassandra.metrics</span></span><br><span class="line"><span class="code">       6. org.apache.cassandra.request</span></span><br><span class="line"><span class="code">       7. org.apache.cassandra.net      ⬅️</span></span><br><span class="line"><span class="code">      10. org.apache.cassandra.db</span></span><br><span class="line"><span class="code">  SERVER: service:jmx:rmi:///jndi/rmi://192.168.47.227:7199/jmxrmi</span></span><br><span class="line"></span><br><span class="line">Exception caught: java.lang.NullPointerException</span><br></pre></td></tr></table></figure>
<p>查看每个节点自己的peers, 发现229和160的host_id一样:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ cqlsh -e <span class="string">"select peer, host_id from system.peers;"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line"> peer           | host_id</span><br><span class="line">----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> | f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span> | <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span> | df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ cqlsh -e <span class="string">"select peer, host_id from system.peers;"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line"></span><br><span class="line"> peer           | host_id</span><br><span class="line">----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> | f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> | <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span> | <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ nodetool status -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">1.15</span> TB    <span class="number">256</span>     <span class="number">17.4</span>%  <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">461.6</span> GB   <span class="number">256</span>     <span class="number">15.4</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span>  <span class="number">6.09</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">17.8</span>%  null                                  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">1.2</span> TB     <span class="number">256</span>     <span class="number">16.4</span>%  df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span>  <span class="number">1.34</span> TB    <span class="number">256</span>     <span class="number">16.5</span>%  <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d  RAC1</span><br></pre></td></tr></table></figure>
<p>因为peers表的主键是peer, 所以可以根据peer删除一条记录:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span></span><br><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span></span><br><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line">cqlsh -e <span class="string">"delete from system.peers where peer='192.168.47.229';"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192</span>-<span class="number">168</span>-<span class="number">47</span>-<span class="number">227</span> ~]$ cqlsh -e <span class="string">"select peer, host_id from system.peers;"</span> <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line"> peer           | host_id</span><br><span class="line">----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.228</span> | f3d26148-d2da-<span class="number">479</span>c-ae9e-ae41aced1be9</span><br><span class="line"> <span class="number">192.168</span><span class="number">.47</span><span class="number">.227</span> | <span class="number">02575631</span>-<span class="number">6</span>ccb-<span class="number">4803</span>-<span class="number">81f</span>d-<span class="number">5</span>bf7a978726d</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span> | <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06</span><br><span class="line"> <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span> | <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6</span><br><span class="line"></span><br><span class="line">nodetool status -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span></span><br><span class="line">虽然peers中已经把<span class="number">229</span>移除了, 但是staus还是能看到<span class="number">229</span>为null</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">467.14</span> GB  <span class="number">256</span>     <span class="number">15.4</span>%  <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span>  <span class="number">937.05</span> GB  <span class="number">256</span>     <span class="number">17.8</span>%  null                                  RAC1</span><br></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/20549284/cassandra-how-to-remove-a-dead-node" target="_blank" rel="external">http://stackoverflow.com/questions/20549284/cassandra-how-to-remove-a-dead-node</a></p>
<p>另一种方式: 重启229, 这时候会分配一个新的HostID, 然后停掉, 再用removenode移除229.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.48.161</span>  1.16 TB    256     17.1%  <span class="number">54b3a7e0</span>-f<span class="number">778-4087</span>-98c3-ac<span class="number">84e56f77e6</span>  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.160</span>  473.62 GB  256     16.1%  18a87c56-dcba-4614-adba-804aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.228</span>  6.1 TB     256     16.8%  f<span class="number">3d26148</span>-d2da-479c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.229</span>  44.07 KB   256     16.7%  <span class="number">41211503-27</span>cd-47b0-b7c0-e<span class="number">5a7a4074</span>d34  RAC1    ⬅️</span><br><span class="line">UN  <span class="number">192.168.48.159</span>  1.22 TB    256     17.8%  df9a693b-efc1-41bc-9a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.227</span>  1.35 TB    256     15.4%  <span class="number">02575631-6</span>ccb-4803-81fd-5bf<span class="number">7a978726</span>d  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool removenode status</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">91890739788</span><span class="number">95940412</span>). Waiting for replication confirmation from [/<span class="number">192.168.48.161</span>,/<span class="number">192.168.48.160</span>,/<span class="number">192.168.47.228</span>,/<span class="number">192.168.48.159</span>,/<span class="number">192.168.47.227</span>].</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool ring | grep <span class="number">91890739788</span><span class="number">95940412</span></span><br><span class="line"><span class="number">192.168.47.229</span>  RAC1        Down   Leaving 44.07 KB        16.73%              -<span class="number">91890739788</span><span class="number">95940412</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool removenode force</span><br><span class="line">RemovalStatus: Removing token (-<span class="number">91890739788</span><span class="number">95940412</span>). Waiting for replication confirmation from [/<span class="number">192.168.48.161</span>,/<span class="number">192.168.48.160</span>,/<span class="number">192.168.47.228</span>,/<span class="number">192.168.48.159</span>,/<span class="number">192.168.47.227</span>].</span><br><span class="line">[qihuang.zheng@<span class="number">192-168-47-227</span> ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.48.161</span>  1.16 TB    256     20.6%  <span class="number">54b3a7e0</span>-f<span class="number">778-4087</span>-98c3-ac<span class="number">84e56f77e6</span>  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.160</span>  474.38 GB  256     20.2%  18a87c56-dcba-4614-adba-804aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.228</span>  6.1 TB     256     20.4%  f<span class="number">3d26148</span>-d2da-479c-ae9e-ae41aced1be9  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.159</span>  1.22 TB    256     20.1%  df9a693b-efc1-41bc-9a42-cf868ea75e65  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.227</span>  1.35 TB    256     18.8%  <span class="number">02575631-6</span>ccb-4803-81fd-5bf<span class="number">7a978726</span>d  RAC1</span><br></pre></td></tr></table></figure>
<h3 id="重新加入">重新加入</h3><p>228节点正在sstablelader，它实际上没有挂，但是其他节点确认为228挂了。 手动removenode后，其他节点认为228挂了。  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[admin@fp-cass048160 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns    Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.227</span>  <span class="number">2.89</span> TB    <span class="number">256</span>     ?       f6136233-<span class="number">08</span>b3-<span class="number">4</span>cad-bd37-<span class="number">57</span>ab6dc4622b  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.226</span>  <span class="number">2.81</span> TB    <span class="number">256</span>     ?       <span class="number">6f</span>4416e1-<span class="number">4493</span>-<span class="number">4909</span>-<span class="number">8427</span>-<span class="number">3738</span>ae72fd82  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.176</span>  <span class="number">6.12</span> TB    <span class="number">256</span>     ?       <span class="number">08491</span>b7a-<span class="number">8e9</span>f-<span class="number">4</span>b5e-b22b-<span class="number">2e73</span>c455fd3f  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">4.48</span> TB    <span class="number">256</span>     ?       <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">4.57</span> TB    <span class="number">256</span>     ?       <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.175</span>  <span class="number">3.21</span> TB    <span class="number">256</span>     ?       <span class="number">5</span>bbd4400-<span class="number">2132</span>-<span class="number">42</span>b6-<span class="number">91</span>c5-<span class="number">389592</span>b75423  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">4.69</span> TB    <span class="number">256</span>     ?       df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br><span class="line">DN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.228</span>  <span class="number">2.72</span> TB    <span class="number">256</span>     ?       dbf53446-<span class="number">35</span>b6-<span class="number">4</span>d18-<span class="number">80e2</span>-<span class="number">396</span>bc633924c  RAC1</span><br><span class="line">[admin@fp-cass048160 ~]$ nohup nodetool removenode dbf53446-<span class="number">35</span>b6-<span class="number">4</span>d18-<span class="number">80e2</span>-<span class="number">396</span>bc633924c &amp;</span><br><span class="line">[admin@fp-cass048160 ~]$ nodetool removenode force</span><br><span class="line">[admin@fp-cass048160 ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns    Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.227</span>  <span class="number">2.89</span> TB    <span class="number">256</span>     ?       f6136233-<span class="number">08</span>b3-<span class="number">4</span>cad-bd37-<span class="number">57</span>ab6dc4622b  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.226</span>  <span class="number">2.81</span> TB    <span class="number">256</span>     ?       <span class="number">6f</span>4416e1-<span class="number">4493</span>-<span class="number">4909</span>-<span class="number">8427</span>-<span class="number">3738</span>ae72fd82  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.176</span>  <span class="number">6.12</span> TB    <span class="number">256</span>     ?       <span class="number">08491</span>b7a-<span class="number">8e9</span>f-<span class="number">4</span>b5e-b22b-<span class="number">2e73</span>c455fd3f  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.161</span>  <span class="number">4.48</span> TB    <span class="number">256</span>     ?       <span class="number">54</span>b3a7e0-f778-<span class="number">4087</span>-<span class="number">98</span>c3-ac84e56f77e6  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.160</span>  <span class="number">4.57</span> TB    <span class="number">256</span>     ?       <span class="number">18</span>a87c56-dcba-<span class="number">4614</span>-adba-<span class="number">804</span>aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.175</span>  <span class="number">3.21</span> TB    <span class="number">256</span>     ?       <span class="number">5</span>bbd4400-<span class="number">2132</span>-<span class="number">42</span>b6-<span class="number">91</span>c5-<span class="number">389592</span>b75423  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span>  <span class="number">4.69</span> TB    <span class="number">256</span>     ?       df9a693b-efc1-<span class="number">41</span>bc-<span class="number">9</span>a42-cf868ea75e65  RAC1</span><br></pre></td></tr></table></figure>
<p>但是228节点认为其他节点都是好的。 如果尝试加入，会说已经在组中了。但是实际上它并不属于组了。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[admin@<span class="number">192-168-48-228</span> ~]$ /usr/install/cassandra/bin/nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns    Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.48.227</span>  2.88 TB    256     ?       f<span class="number">6136233-08</span>b3-4cad-bd37-57ab6dc4622b  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.226</span>  2.79 TB    256     ?       <span class="number">6f4416e1</span>-<span class="number">4493-4909</span>-<span class="number">8427-3738</span>ae72fd82  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.176</span>  6.1 TB     256     ?       <span class="number">08491b7</span>a-8e9f-4b5e-b22b-<span class="number">2e73c455</span>fd3f  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.161</span>  4.47 TB    256     ?       <span class="number">54b3a7e0</span>-f<span class="number">778-4087</span>-98c3-ac<span class="number">84e56f77e6</span>  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.228</span>  2.72 TB    256     ?       dbf<span class="number">53446-35b6</span>-<span class="number">4d18-80e2</span>-396bc633924c  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.160</span>  4.55 TB    256     ?       18a87c56-dcba-4614-adba-804aa7761a06  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.175</span>  3.2 TB     256     ?       5bbd<span class="number">4400-2132</span>-<span class="number">42b6-91c5</span>-<span class="number">389592b75</span>423  RAC1</span><br><span class="line">UN  <span class="number">192.168.48.159</span>  4.67 TB    256     ?       df9a693b-efc1-41bc-9a42-cf868ea75e65  RAC1</span><br><span class="line"></span><br><span class="line">Note: Non-system keyspaces don't have the same replication settings, effective ownership information is meaningless</span><br><span class="line">[admin@<span class="number">192-168-48-228</span> ~]$ /usr/install/cassandra/bin/nodetool join</span><br><span class="line">nodetool: This node has already joined the ring.</span><br></pre></td></tr></table></figure>
<h3 id="网络状态netstats:_显示一个节点的Active_Stream">网络状态netstats: 显示一个节点的Active Stream</h3><p>正常没有stream：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047202 ~]$ nodetool netstats</span><br><span class="line">Mode: NORMAL</span><br><span class="line">Not sending any streams.</span><br><span class="line">Read Repair Statistics:</span><br><span class="line">Attempted: <span class="number">749</span></span><br><span class="line">Mismatch (Blocking): <span class="number">4</span></span><br><span class="line">Mismatch (Background): <span class="number">13</span></span><br><span class="line">Pool Name                    Active   Pending      Completed</span><br><span class="line">Commands                        n/a         <span class="number">0</span>      <span class="number">581681910</span></span><br><span class="line">Responses                       n/a         <span class="number">0</span>      <span class="number">519983825</span></span><br></pre></td></tr></table></figure>
<p>stream分成几种类型：bulkload(即通过sstableloader)， nodetool repair等</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047202 ~]$ nodetool netstats</span><br><span class="line">Mode: NORMAL</span><br><span class="line">Bulk Load <span class="number">839</span>a5ef0-<span class="number">44</span>cf-<span class="number">11e6</span>-b6f3-dff3aadcb7ef</span><br><span class="line">    /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> (<span class="keyword">using</span> /<span class="number">192.168</span><span class="number">.48</span><span class="number">.168</span>)</span><br><span class="line">        Receiving <span class="number">272</span> files, <span class="number">4388357561</span> bytes total. Already received <span class="number">2</span> files, <span class="number">46586511</span> bytes total</span><br><span class="line">            /home/admin/cassandra/data/md5s/md5_id_0-e842c330440a11e69e5f2bcdca057dae/md5s-md5_id_0-tmp-ka-<span class="number">63</span>-Data.db <span class="number">16194058</span>/<span class="number">16194058</span> bytes(<span class="number">100</span>%) received from idx:<span class="number">0</span>/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">            /home/admin/cassandra/data/md5s/md5_id_0-e842c330440a11e69e5f2bcdca057dae/md5s-md5_id_0-tmp-ka-<span class="number">64</span>-Data.db <span class="number">16202304</span>/<span class="number">16202304</span> bytes(<span class="number">100</span>%) received from idx:<span class="number">0</span>/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">            /home/admin/cassandra/data/md5s/md5_id_0-e842c330440a11e69e5f2bcdca057dae/md5s-md5_id_0-tmp-ka-<span class="number">65</span>-Data.db <span class="number">14190149</span>/<span class="number">16008570</span> bytes(<span class="number">88</span>%) received from idx:<span class="number">0</span>/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Read Repair Statistics:</span><br><span class="line">Attempted: <span class="number">749</span></span><br><span class="line">Mismatch (Blocking): <span class="number">4</span></span><br><span class="line">Mismatch (Background): <span class="number">13</span></span><br><span class="line">Pool Name                    Active   Pending      Completed</span><br><span class="line">Commands                        n/a         <span class="number">0</span>      <span class="number">581694648</span></span><br><span class="line">Responses                       n/a         <span class="number">0</span>      <span class="number">520000034</span></span><br></pre></td></tr></table></figure>
<p>1.正在加入集群的节点JOINING:   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047224 cassandra]$ /usr/install/cassandra/bin/nodetool netstats</span><br><span class="line">Mode: JOINING</span><br><span class="line">Bootstrap fcca1bf0-<span class="number">4</span>a6e-<span class="number">11e5</span>-<span class="number">8677</span>-<span class="number">6</span>da22c7e072c</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">        Receiving <span class="number">929</span> files, <span class="number">259726626064</span> bytes total</span><br><span class="line">            /home/admin/cassandra/data/forseti_fp/tcp_syn_data/forseti_fp-tcp_syn_data-tmp-jb-<span class="number">198</span>-Data.db <span class="number">120433605</span>/<span class="number">120433605</span> bytes(<span class="number">100</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br><span class="line">        Receiving <span class="number">976</span> files, <span class="number">214785965744</span> bytes total</span><br><span class="line">            /home/admin/cassandra/data/forseti/ip_mobilephone/forseti-ip_mobilephone-tmp-jb-<span class="number">16</span>-Data.db <span class="number">30801577</span>/<span class="number">30801577</span> bytes(<span class="number">100</span>%) received from /<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br></pre></td></tr></table></figure>
<p>2.离开集群的节点LEAVING:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047225 snapshots]$ nodetool netstats | head</span><br><span class="line">Mode: LEAVING</span><br><span class="line">Restore replica count dad915d0-<span class="number">7</span>d6f-<span class="number">11e5</span>-<span class="number">8681</span>-<span class="number">9f</span>6f9f8ad5ca</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span></span><br><span class="line">        Sending <span class="number">243</span> files, <span class="number">7877174416</span> bytes total</span><br></pre></td></tr></table></figure>
<p>下线的节点除了发送数据给其他节点, 也会接收数据.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047225 ~]$ nodetool netstats | grep <span class="string">"files"</span></span><br><span class="line">        Sending <span class="number">183</span> files, <span class="number">2169787693</span> bytes total</span><br><span class="line">        Sending <span class="number">223</span> files, <span class="number">6492707205</span> bytes total</span><br><span class="line">        ....</span><br><span class="line">        Receiving <span class="number">242</span> files, <span class="number">10438497913</span> bytes total</span><br><span class="line">        Receiving <span class="number">279</span> files, <span class="number">12407597530</span> bytes total</span><br></pre></td></tr></table></figure>
<p>3.正常的节点NORMAL, 会发送文件给其他节点, 并从下线的节点接收文件:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@spark047245 ~]$ /usr/install/cassandra/bin/nodetool netstats | head</span><br><span class="line">Mode: NORMAL</span><br><span class="line">Restore replica count db2a4310-<span class="number">7</span>d6f-<span class="number">11e5</span>-a4ef-<span class="number">8f</span>719a2aece0</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span></span><br><span class="line">        Sending <span class="number">309</span> files, <span class="number">25090493062</span> bytes total</span><br><span class="line"></span><br><span class="line">Unbootstrap <span class="number">00</span>ecfbb0-<span class="number">7</span>ea6-<span class="number">11e5</span>-<span class="number">9266</span>-f38b27f65aa6</span><br><span class="line">    /<span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span></span><br><span class="line">        Receiving <span class="number">556</span> files, <span class="number">58062261421</span> bytes total</span><br></pre></td></tr></table></figure>
<h3 id="节点信息:_nodetool_info">节点信息: nodetool info</h3><p>主要关注KeyCache, 容量为512M(key_cache_size_in_mb), 用了500M左右, 命中率为65%. 没有开启RowCache(row_cache_size_in_mb:0).<br>堆内存16G, 用了6G(执行命令的这一时刻,并不是说总是占用这么点), 堆外内存off-heap使用了1G. 异常50个.    </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool info</span><br><span class="line">Token                  : (invoke with -T/<span class="comment">--tokens to see all 256 tokens)</span></span><br><span class="line">ID                     : abaa0cbc-09d3-4990-8698-ff4d2f2bb4f7</span><br><span class="line">Gossip active          : true</span><br><span class="line">Thrift active          : true</span><br><span class="line">Native Transport active: true</span><br><span class="line"><span class="operator"><span class="keyword">Load</span>                   : <span class="number">618.81</span> GB</span><br><span class="line">Generation <span class="keyword">No</span>          : <span class="number">1445525962</span></span><br><span class="line">Uptime (seconds)       : <span class="number">651191</span></span><br><span class="line"><span class="keyword">Heap</span> <span class="keyword">Memory</span> (MB)       : <span class="number">6167.96</span> / <span class="number">15974.44</span></span><br><span class="line"><span class="keyword">Off</span> <span class="keyword">Heap</span> <span class="keyword">Memory</span> (MB)   : <span class="number">1154.13</span></span><br><span class="line"><span class="keyword">Data</span> Center            : DC1</span><br><span class="line">Rack                   : RAC1</span><br><span class="line"><span class="keyword">Exceptions</span>             : <span class="number">50</span></span><br><span class="line"><span class="keyword">Key</span> <span class="keyword">Cache</span>              : <span class="keyword">size</span> <span class="number">520120120</span> (<span class="keyword">bytes</span>), <span class="keyword">capacity</span> <span class="number">536870912</span> (<span class="keyword">bytes</span>), <span class="number">112077861</span> hits, <span class="number">182128983</span> requests, <span class="number">0.656</span> recent hit rate, <span class="number">14400</span> <span class="keyword">save</span> <span class="keyword">period</span> <span class="keyword">in</span> seconds</span><br><span class="line"><span class="keyword">Row</span> <span class="keyword">Cache</span>              : <span class="keyword">size</span> <span class="number">0</span> (<span class="keyword">bytes</span>), <span class="keyword">capacity</span> <span class="number">0</span> (<span class="keyword">bytes</span>), <span class="number">0</span> hits, <span class="number">0</span> requests, <span class="keyword">NaN</span> recent hit rate, <span class="number">0</span> <span class="keyword">save</span> <span class="keyword">period</span> <span class="keyword">in</span> seconds</span></span><br></pre></td></tr></table></figure>
<p>仅仅查看每个节点的KeyCache:  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">"/usr/install/cassandra/bin/nodetool info | tail -2 | head -1"</span></span><br><span class="line">./pssh<span class="class">.sh</span> ip_all<span class="class">.txt</span> <span class="string">"/usr/install/cassandra/bin/nodetool info | sed -n '14p'"</span></span><br></pre></td></tr></table></figure>
<h3 id="Gossip信息:_nodetool_gossipinfo">Gossip信息: nodetool gossipinfo</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">nodetool gossipinfo</span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.205</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1027890057681052346</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.206</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1004054309250591595</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1062467338696068910</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.204</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1130382709140432588</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.224</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1137590811836749748</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.203</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1024266383569750575</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.222</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">105769922317262244</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.225</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">1061781412716791842</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.221</span></span><br><span class="line">  STATUS:NORMAL,-<span class="number">104095308743394398</span></span><br><span class="line">/<span class="number">192.168</span><span class="number">.47</span><span class="number">.229</span></span><br><span class="line">  STATUS:LEFT,-<span class="number">9088453765955214068</span>,<span class="number">1448966282585</span></span><br></pre></td></tr></table></figure>
<h3 id="表相关的信息:nodetool_cfstats_forseti-velocity">表相关的信息:nodetool cfstats forseti.velocity</h3><p>1.查看表的信息, 前面四行是当前的读写延迟和读写次数.  </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@cass</span>047202 cassandra]$ nodetool cfstats forseti.velocity</span><br><span class="line"><span class="string">Keyspace:</span> forseti</span><br><span class="line">    Read <span class="string">Count:</span> <span class="number">10470099</span></span><br><span class="line">    Read <span class="string">Latency:</span> <span class="number">1.3186399419909973</span> ms.</span><br><span class="line">    Write <span class="string">Count:</span> <span class="number">146970362</span></span><br><span class="line">    Write <span class="string">Latency:</span> <span class="number">0.06062576270989929</span> ms.</span><br><span class="line">    Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">        Table:</span> velocity</span><br><span class="line">        SSTable <span class="string">count:</span> <span class="number">2144</span></span><br><span class="line">        SSTables <span class="keyword">in</span> each <span class="string">level:</span> [<span class="number">1</span>, <span class="number">10</span>, <span class="number">96</span>, <span class="number">723</span>, <span class="number">1314</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        Space used (live), <span class="string">bytes:</span> <span class="number">509031385679</span></span><br><span class="line">        Space used (total), <span class="string">bytes:</span> <span class="number">523815500936</span></span><br><span class="line">        Off heap memory used (total), <span class="string">bytes:</span> <span class="number">558210701</span></span><br><span class="line">        SSTable Compression <span class="string">Ratio:</span> <span class="number">0.23635049381008288</span></span><br><span class="line">        Number of keys (estimate): <span class="number">269787648</span></span><br><span class="line">        Memtable cell <span class="string">count:</span> <span class="number">271431</span></span><br><span class="line">        Memtable data size, <span class="string">bytes:</span> <span class="number">141953019</span></span><br><span class="line">        Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">1713</span></span><br><span class="line">        Local read <span class="string">count:</span> <span class="number">10470099</span></span><br><span class="line">        Local read <span class="string">latency:</span> <span class="number">1.266</span> ms</span><br><span class="line">        Local write <span class="string">count:</span> <span class="number">146970371</span></span><br><span class="line">        Local write <span class="string">latency:</span> <span class="number">0.053</span> ms</span><br><span class="line">        Pending <span class="string">tasks:</span> <span class="number">0</span></span><br><span class="line">        Bloom filter <span class="literal">false</span> <span class="string">positives:</span> <span class="number">534721</span></span><br><span class="line">        Bloom filter <span class="literal">false</span> <span class="string">ratio:</span> <span class="number">0.13542</span></span><br><span class="line">        Bloom filter space used, <span class="string">bytes:</span> <span class="number">180529808</span></span><br><span class="line">        Bloom filter off heap memory used, <span class="string">bytes:</span> <span class="number">180512656</span></span><br><span class="line">        Index summary off heap memory used, <span class="string">bytes:</span> <span class="number">118613037</span></span><br><span class="line">        Compression metadata off heap memory used, <span class="string">bytes:</span> <span class="number">259085008</span></span><br><span class="line">        Compacted partition minimum <span class="string">bytes:</span> <span class="number">104</span></span><br><span class="line">        Compacted partition maximum <span class="string">bytes:</span> <span class="number">190420296972</span></span><br><span class="line">        Compacted partition mean <span class="string">bytes:</span> <span class="number">8656</span></span><br><span class="line">        Average live cells per slice (last five minutes): <span class="number">0.0</span></span><br><span class="line">        Average tombstones per slice (last five minutes): <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="annotation">@spark</span>047211 ~]$ nodetool -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.159</span> cfstats forseti_fp.android_device_session</span><br><span class="line"><span class="string">Keyspace:</span> forseti_fp</span><br><span class="line">  Read <span class="string">Count:</span> <span class="number">3436820</span></span><br><span class="line">  Read <span class="string">Latency:</span> <span class="number">0.7271564521854504</span> ms.</span><br><span class="line">  Write <span class="string">Count:</span> <span class="number">1242325989</span></span><br><span class="line">  Write <span class="string">Latency:</span> <span class="number">0.01608114556074058</span> ms.</span><br><span class="line">  Pending <span class="string">Flushes:</span> <span class="number">0</span></span><br><span class="line"><span class="label">    Table:</span> android_device_session</span><br><span class="line">    SSTable <span class="string">count:</span> <span class="number">14</span></span><br><span class="line">    Space used (live): <span class="number">3315056965329</span></span><br><span class="line">    Space used (total): <span class="number">3315312862453</span></span><br><span class="line">    Space used by snapshots (total): <span class="number">0</span></span><br><span class="line">    Off heap memory used (total): <span class="number">1813094460</span></span><br><span class="line">    SSTable Compression <span class="string">Ratio:</span> <span class="number">0.37206192803944754</span> </span><br><span class="line">    Number of keys (estimate): <span class="number">954623103</span>             -&gt; <span class="number">9</span>亿</span><br><span class="line">    Memtable cell <span class="string">count:</span> <span class="number">92654</span></span><br><span class="line">    Memtable data <span class="string">size:</span> <span class="number">104729033</span></span><br><span class="line">    Memtable off heap memory <span class="string">used:</span> <span class="number">0</span></span><br><span class="line">    Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">13386</span></span><br><span class="line">    Local read <span class="string">count:</span> <span class="number">3436820</span></span><br><span class="line">    Local read <span class="string">latency:</span> <span class="number">0.728</span> ms</span><br><span class="line">    Local write <span class="string">count:</span> <span class="number">1242326281</span></span><br><span class="line">    Local write <span class="string">latency:</span> <span class="number">0.017</span> ms</span><br><span class="line">    Pending <span class="string">flushes:</span> <span class="number">0</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">positives:</span> <span class="number">15</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">ratio:</span> <span class="number">0.00000</span></span><br><span class="line">    Bloom filter space <span class="string">used:</span> <span class="number">607412928</span></span><br><span class="line">    Bloom filter off heap memory <span class="string">used:</span> <span class="number">607412816</span></span><br><span class="line">    Index summary off heap memory <span class="string">used:</span> <span class="number">138144620</span></span><br><span class="line">    Compression metadata off heap memory <span class="string">used:</span> <span class="number">1067537024</span></span><br><span class="line">    Compacted partition minimum <span class="string">bytes:</span> <span class="number">125</span></span><br><span class="line">    Compacted partition maximum <span class="string">bytes:</span> <span class="number">4866323</span></span><br><span class="line">    Compacted partition mean <span class="string">bytes:</span> <span class="number">10051</span></span><br><span class="line">    Average live cells per slice (last five minutes): <span class="number">0.10287086386072478</span></span><br><span class="line">    Maximum live cells per slice (last five minutes): <span class="number">7.0</span></span><br><span class="line">    Average tombstones per slice (last five minutes): <span class="number">0.14188850295078587</span></span><br><span class="line">    Maximum tombstones per slice (last five minutes): <span class="number">2164.0</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="annotation">@spark</span>047211 ~]$ nodetool -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span> cfstats forseti.velocity_app</span><br><span class="line"><span class="string">Keyspace:</span> forseti</span><br><span class="line">  Read <span class="string">Count:</span> <span class="number">120443046</span></span><br><span class="line">  Read <span class="string">Latency:</span> <span class="number">1.1013535886995087</span> ms.</span><br><span class="line">  Write <span class="string">Count:</span> <span class="number">2058015125</span></span><br><span class="line">  Write <span class="string">Latency:</span> <span class="number">0.016679299918653415</span> ms.</span><br><span class="line">  Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">    Table:</span> velocity_app</span><br><span class="line">    SSTable <span class="string">count:</span> <span class="number">24</span></span><br><span class="line">    Space used (live), <span class="string">bytes:</span> <span class="number">2670044515793</span></span><br><span class="line">    Space used (total), <span class="string">bytes:</span> <span class="number">2670239936283</span></span><br><span class="line">    Off heap memory used (total), <span class="string">bytes:</span> <span class="number">2958340937</span></span><br><span class="line">    SSTable Compression <span class="string">Ratio:</span> <span class="number">0.28255581535232427</span></span><br><span class="line">    Number of keys (estimate): <span class="number">1976325248</span>   (<span class="number">19</span>亿)</span><br><span class="line">    Memtable cell <span class="string">count:</span> <span class="number">613404</span></span><br><span class="line">    Memtable data size, <span class="string">bytes:</span> <span class="number">233170920</span></span><br><span class="line">    Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">4214</span></span><br><span class="line">    Local read <span class="string">count:</span> <span class="number">120443053</span></span><br><span class="line">    Local read <span class="string">latency:</span> <span class="number">0.931</span> ms</span><br><span class="line">    Local write <span class="string">count:</span> <span class="number">2058015151</span></span><br><span class="line">    Local write <span class="string">latency:</span> <span class="number">0.015</span> ms</span><br><span class="line">    Pending <span class="string">tasks:</span> <span class="number">0</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">positives:</span> <span class="number">45097</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">ratio:</span> <span class="number">0.00732</span></span><br><span class="line">    Bloom filter space used, <span class="string">bytes:</span> <span class="number">1230425688</span></span><br><span class="line">    Bloom filter off heap memory used, <span class="string">bytes:</span> <span class="number">1230425496</span></span><br><span class="line">    Index summary off heap memory used, <span class="string">bytes:</span> <span class="number">578011001</span></span><br><span class="line">    Compression metadata off heap memory used, <span class="string">bytes:</span> <span class="number">1149904440</span></span><br><span class="line">    Compacted partition minimum <span class="string">bytes:</span> <span class="number">150</span></span><br><span class="line">    Compacted partition maximum <span class="string">bytes:</span> <span class="number">158</span>(GB),<span class="number">683</span>(MB),<span class="number">580</span>(KB),<span class="number">810</span></span><br><span class="line">    Compacted partition mean <span class="string">bytes:</span> <span class="number">5225</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="annotation">@spark</span>047211 ~]$ nodetool -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span> cfstats forseti.velocity_partner</span><br><span class="line"><span class="string">Keyspace:</span> forseti</span><br><span class="line">  Read <span class="string">Count:</span> <span class="number">3664048</span></span><br><span class="line">  Read <span class="string">Latency:</span> <span class="number">1.265197941730021</span> ms.</span><br><span class="line">  Write <span class="string">Count:</span> <span class="number">1963754310</span></span><br><span class="line">  Write <span class="string">Latency:</span> <span class="number">0.017543929064120042</span> ms.</span><br><span class="line">  Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">    Table:</span> velocity_partner</span><br><span class="line">    SSTable <span class="string">count:</span> <span class="number">5798</span></span><br><span class="line">    SSTables <span class="keyword">in</span> each <span class="string">level:</span> [<span class="number">1</span>, <span class="number">11</span>/<span class="number">10</span>, <span class="number">90</span>, <span class="number">881</span>, <span class="number">4813</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    Space used (live), <span class="string">bytes:</span> <span class="number">1237251258441</span></span><br><span class="line">    Space used (total), <span class="string">bytes:</span> <span class="number">1240223108780</span></span><br><span class="line">    Off heap memory used (total), <span class="string">bytes:</span> <span class="number">1220821758</span></span><br><span class="line">    SSTable Compression <span class="string">Ratio:</span> <span class="number">0.2518164031088747</span></span><br><span class="line">    Number of keys (estimate): <span class="number">821395584</span>      <span class="number">8</span>亿</span><br><span class="line">    Memtable cell <span class="string">count:</span> <span class="number">775752</span></span><br><span class="line">    Memtable data size, <span class="string">bytes:</span> <span class="number">265533044</span></span><br><span class="line">    Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">4217</span></span><br><span class="line">    Local read <span class="string">count:</span> <span class="number">3664048</span></span><br><span class="line">    Local read <span class="string">latency:</span> <span class="number">1.200</span> ms</span><br><span class="line">    Local write <span class="string">count:</span> <span class="number">1963754352</span></span><br><span class="line">    Local write <span class="string">latency:</span> <span class="number">0.017</span> ms</span><br><span class="line">    Pending <span class="string">tasks:</span> <span class="number">0</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">positives:</span> <span class="number">599</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">ratio:</span> <span class="number">0.00000</span></span><br><span class="line">    Bloom filter space used, <span class="string">bytes:</span> <span class="number">503778320</span></span><br><span class="line">    Bloom filter off heap memory used, <span class="string">bytes:</span> <span class="number">503731936</span></span><br><span class="line">    Index summary off heap memory used, <span class="string">bytes:</span> <span class="number">144796454</span></span><br><span class="line">    Compression metadata off heap memory used, <span class="string">bytes:</span> <span class="number">572293368</span></span><br><span class="line">    Compacted partition minimum <span class="string">bytes:</span> <span class="number">259</span></span><br><span class="line">    Compacted partition maximum <span class="string">bytes:</span> <span class="number">91</span>,<span class="number">830</span>,<span class="number">775</span>,<span class="number">932</span></span><br><span class="line">    Compacted partition mean <span class="string">bytes:</span> <span class="number">6265</span></span><br><span class="line">    Average live cells per slice (last five minutes): <span class="number">1.0</span></span><br><span class="line">    Average tombstones per slice (last five minutes): <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="annotation">@spark</span>047211 ~]$ nodetool -h <span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span> cfstats forseti.velocity_global</span><br><span class="line"><span class="string">Keyspace:</span> forseti</span><br><span class="line">  Read <span class="string">Count:</span> <span class="number">27019937</span></span><br><span class="line">  Read <span class="string">Latency:</span> <span class="number">0.8387888214173111</span> ms.</span><br><span class="line">  Write <span class="string">Count:</span> <span class="number">2057412727</span></span><br><span class="line">  Write <span class="string">Latency:</span> <span class="number">0.01946266525841317</span> ms.</span><br><span class="line">  Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">    Table:</span> velocity_global</span><br><span class="line">    SSTable <span class="string">count:</span> <span class="number">5468</span></span><br><span class="line">    SSTables <span class="keyword">in</span> each <span class="string">level:</span> [<span class="number">7</span><span class="regexp">/4, 12/</span><span class="number">10</span>, <span class="number">77</span>, <span class="number">703</span>, <span class="number">4667</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    Space used (live), <span class="string">bytes:</span> <span class="number">1476150066588</span></span><br><span class="line">    Space used (total), <span class="string">bytes:</span> <span class="number">1477238480867</span></span><br><span class="line">    Off heap memory used (total), <span class="string">bytes:</span> <span class="number">1092884433</span></span><br><span class="line">    SSTable Compression <span class="string">Ratio:</span> <span class="number">0.24933201816062378</span></span><br><span class="line">    Number of keys (estimate): <span class="number">558798080</span>     <span class="number">5</span>亿</span><br><span class="line">    Memtable cell <span class="string">count:</span> <span class="number">120625</span></span><br><span class="line">    Memtable data size, <span class="string">bytes:</span> <span class="number">38130612</span></span><br><span class="line">    Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">4250</span></span><br><span class="line">    Local read <span class="string">count:</span> <span class="number">27019937</span></span><br><span class="line">    Local read <span class="string">latency:</span> <span class="number">1.128</span> ms</span><br><span class="line">    Local write <span class="string">count:</span> <span class="number">2057412797</span></span><br><span class="line">    Local write <span class="string">latency:</span> <span class="number">0.016</span> ms</span><br><span class="line">    Pending <span class="string">tasks:</span> <span class="number">0</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">positives:</span> <span class="number">1700</span></span><br><span class="line">    Bloom filter <span class="literal">false</span> <span class="string">ratio:</span> <span class="number">0.00000</span></span><br><span class="line">    Bloom filter space used, <span class="string">bytes:</span> <span class="number">319642480</span></span><br><span class="line">    Bloom filter off heap memory used, <span class="string">bytes:</span> <span class="number">319598736</span></span><br><span class="line">    Index summary off heap memory used, <span class="string">bytes:</span> <span class="number">100862649</span></span><br><span class="line">    Compression metadata off heap memory used, <span class="string">bytes:</span> <span class="number">672423048</span></span><br><span class="line">    Compacted partition minimum <span class="string">bytes:</span> <span class="number">311</span></span><br><span class="line">    Compacted partition maximum <span class="string">bytes:</span> <span class="number">568</span>G,<span class="number">591</span>M,<span class="number">960</span>K,<span class="number">032</span></span><br><span class="line">    Compacted partition mean <span class="string">bytes:</span> <span class="number">10777</span></span><br><span class="line">    Average live cells per slice (last five minutes): <span class="number">0.0</span></span><br><span class="line">    Average tombstones per slice (last five minutes): <span class="number">0.0</span></span><br></pre></td></tr></table></figure>
<p>velocity在当前节点的keys有2.6亿. 其中最大的partition有190G! 说明存在一些很宽的行wide rows. 平均每个partition的大小是104Byte.   </p>
<p><a href="http://docs.datastax.com/en/cql/3.1/cql/cql_reference/compactSubprop.html" target="_blank" rel="external">http://docs.datastax.com/en/cql/3.1/cql/cql_reference/compactSubprop.html</a>  </p>
<blockquote>
<p>sstable_size_in_mb默认是160MB. The target size for SSTables that use the leveled compaction strategy.<br>Although SSTable sizes should be less or equal to sstable_size_in_mb, 尽管SSTable的大小应该比默认的160M要小或相等.<br>it is possible to have a larger SSTable during compaction. 在Compaction过程中,可能产生更大的SSTable.<br>This occurs when data for a given partition key is exceptionally large. 当某个分区键的数据非常大时,<br>The data is not split into two SSTables. 分区很大的键在compact时不会拆分到两个SSTable文件中(因为partition key只会在一个SSTable中).  </p>
</blockquote>
<p>2.线程池状态: tpstatus可以查看的内容和system.log中打印的StatsLogger差不多.  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ nodetool tpstats</span><br><span class="line">Pool Name                    Active   Pending      Completed   Blocked  All time blocked</span><br><span class="line">ReadStage                         <span class="number">2</span>         <span class="number">0</span>       <span class="number">10960442</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">RequestResponseStage              <span class="number">0</span>         <span class="number">0</span>      <span class="number">447942623</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MutationStage                     <span class="number">0</span>         <span class="number">0</span>      <span class="number">239315421</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ReadRepairStage                   <span class="number">0</span>         <span class="number">0</span>        <span class="number">1124868</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ReplicateOnWriteStage             <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">GossipStage                       <span class="number">0</span>         <span class="number">0</span>        <span class="number">1477282</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CacheCleanupExecutor              <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MigrationStage                    <span class="number">0</span>         <span class="number">0</span>             <span class="number">46</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemoryMeter                       <span class="number">0</span>         <span class="number">0</span>          <span class="number">10694</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">FlushWriter                       <span class="number">0</span>         <span class="number">0</span>          <span class="number">11360</span>         <span class="number">0</span>               <span class="number">511</span></span><br><span class="line">ValidationExecutor                <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">InternalResponseStage             <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">AntiEntropyStage                  <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemtablePostFlusher               <span class="number">0</span>         <span class="number">0</span>          <span class="number">16487</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MiscStage                         <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">PendingRangeCalculator            <span class="number">0</span>         <span class="number">0</span>             <span class="number">39</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CompactionExecutor                <span class="number">3</span>         <span class="number">3</span>          <span class="number">47113</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">commitlog_archiver                <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">HintedHandoff                     <span class="number">0</span>         <span class="number">1</span>            <span class="number">867</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Message type           Dropped</span><br><span class="line">RANGE_SLICE                  <span class="number">0</span></span><br><span class="line">READ_REPAIR                  <span class="number">0</span></span><br><span class="line">PAGED_RANGE                  <span class="number">0</span></span><br><span class="line">BINARY                       <span class="number">0</span></span><br><span class="line">READ                         <span class="number">0</span></span><br><span class="line">MUTATION                     <span class="number">0</span></span><br><span class="line">_TRACE                       <span class="number">0</span></span><br><span class="line">REQUEST_RESPONSE             <span class="number">2</span></span><br><span class="line">COUNTER_MUTATION             <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>比如正在运行的CompactionExecutor有3个, 用compactionstats可以查看正在运行Compaction的表:   </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass047202 cassandra]$ nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">4</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction         forseti        velocity      <span class="number">9600330302</span>     <span class="number">12886138624</span>     bytes    <span class="number">74.50</span>%</span><br><span class="line">               Compaction         forseti  device_account        <span class="number">64712962</span>      <span class="number">1923986398</span>     bytes     <span class="number">3.36</span>%</span><br><span class="line">     Tombstone Compaction         forseti        velocity        <span class="number">95382333</span>    <span class="number">170991248015</span>     bytes     <span class="number">0.06</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">0</span>h00m38s</span><br></pre></td></tr></table></figure>
<h3 id="compactionhistory">compactionhistory</h3><p><a href="https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCompactionHistory.html" target="_blank" rel="external">https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCompactionHistory.html</a></p>
<p>最后一列表示rows_merged：{tables:rows}. For example: {1:3, 3:1} means 3 rows were taken from one SSTable (1:3)<br>and 1 row taken from 3 SSTables (3:1) to make the one SSTable in that compaction operation.  </p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nodetool compactionhistory | grep velocity | sort -r -k 4 &gt; compactionhistory.log</span><br><span class="line">nodetool compactionhistory | grep velocity | sort -r -k 4 | awk '&#123;for(i=4<span class="comment">;i&lt;=NF;i++) printf"%s\t",$i&#125; &#123;print ""&#125;' | head </span></span><br><span class="line">nodetool compactionhistory | grep velocity | sort -r -k 4 | awk '&#123;if(NF&gt;9) print $0&#125;'</span><br><span class="line"></span><br><span class="line">3cb01450-e<span class="number">5d7-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751483035</span>7             <span class="number">985256393</span>      <span class="number">869306399</span>      &#123;<span class="number">1:325289</span>, <span class="number">2:11651</span>&#125;</span><br><span class="line">ff100470-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751472696</span>7             <span class="number">161269131</span>      <span class="number">159732166</span>      &#123;<span class="number">1:207378</span>, 2:9918&#125;</span><br><span class="line">bafef020-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751461277</span>0             <span class="number">1171434739</span>     <span class="number">1167942768</span>     &#123;<span class="number">1:811453</span>, <span class="number">2:28598</span>&#125;</span><br><span class="line">b7c08e00-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751460732</span>8             <span class="number">144946713</span>      <span class="number">143529681</span>      &#123;<span class="number">1:187320</span>, <span class="number">2:10070</span>&#125;</span><br><span class="line"><span class="number">6f66d380</span>-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751448594</span>4             <span class="number">128493647</span>      <span class="number">127148807</span>      &#123;<span class="number">1:167405</span>, 2:9312&#125;</span><br><span class="line">2be5ca30-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751437269</span>1             <span class="number">112061194</span>      <span class="number">111124311</span>      &#123;<span class="number">1:151315</span>, 2:6405&#125;</span><br><span class="line"><span class="number">2a335f40</span>-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751436984</span>4             <span class="number">2078394794</span>     <span class="number">2073816751</span>     &#123;<span class="number">1:1298699</span>, <span class="number">2:39956</span>&#125;</span><br><span class="line"><span class="number">04070880</span>-e<span class="number">5d6-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751430579</span>9             <span class="number">103532684</span>      <span class="number">102206816</span>      &#123;<span class="number">1:137231</span>, 2:9020&#125;</span><br><span class="line">bb648530-e<span class="number">5d5-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">1457514183938</span>             <span class="number">86832984</span>       <span class="number">85571719</span>       &#123;<span class="number">1:115214</span>, 2:8749&#125;</span><br><span class="line"><span class="number">750254f0</span>-e<span class="number">5d5-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751406585</span>5             <span class="number">69678994</span>       <span class="number">68516377</span>       &#123;<span class="number">1:93817</span>, 2:7968&#125;</span><br><span class="line"><span class="number">3b9a2260</span>-e<span class="number">5d5-11e5</span>-8fe9-2bcdca057dae     forseti            velocity                     <span class="number">145751396954</span>2             <span class="number">53715409</span>       <span class="number">51918781</span>       &#123;<span class="number">1:69930</span>, 2:6969, 3:2522&#125;</span><br></pre></td></tr></table></figure>
<p>history的信息解释</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">id                                     ks           cf                  compactedAt       bytes_in        bytes_out       rows_compacted</span><br><span class="line"><span class="number">3</span>cb01450-e5d7-<span class="number">11e5</span>-<span class="number">8f</span>e9-<span class="number">2</span>bcdca057dae   forseti      velocity            <span class="number">1457514830357</span>     <span class="number">985</span>,<span class="number">256</span>,<span class="number">393</span>     <span class="number">869</span>,<span class="number">306</span>,<span class="number">399</span>     &#123;<span class="number">1</span>:<span class="number">325289</span>, <span class="number">2</span>:<span class="number">11651</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">985</span>MB，一个文件的有<span class="number">325289</span>条， 读取两个文件的有<span class="number">11651</span></span><br><span class="line"></span><br><span class="line">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx    model_result credit_id_labels    xxxxxxxxxxxxx     <span class="number">7</span>,<span class="number">166</span>,<span class="number">010</span>         <span class="number">7</span>,<span class="number">166</span>,<span class="number">549</span>     &#123;<span class="number">1</span>:<span class="number">8954</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>MB，一个文件的有<span class="number">8954</span>条，平均每条数据的大小是<span class="number">7</span>,<span class="number">166</span>/<span class="number">8964</span>=<span class="number">0.8</span>KB</span><br><span class="line"></span><br><span class="line">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx    model_result credit_id_labels_v2 xxxxxxxxxxxxx     <span class="number">65</span>,<span class="number">738</span>,<span class="number">206</span>        <span class="number">65</span>,<span class="number">799</span>,<span class="number">090</span>    &#123;<span class="number">1</span>:<span class="number">113483</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">65</span>MB，一个文件的有<span class="number">113483</span>条，每条大小=<span class="number">65738206</span>/<span class="number">113483</span>=<span class="number">579</span>Bytes</span><br><span class="line"></span><br><span class="line">这两张表的不同点是：credit_id_labels有多个字段，而credit_id_labels_v2将所有字段用json表示</span><br></pre></td></tr></table></figure>
<p>system.log中对于每次Compaction操作都有记录本次合并了多少个文件：  </p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INFO [CompactionExecutor:<span class="number">48884</span>] <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">08</span>:<span class="number">34</span>,<span class="number">162</span> CompactionTask.java (<span class="built_in">line</span> <span class="number">120</span>) Compacting [</span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947338-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947335-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947334-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947336-Data.db'</span>), </span><br><span class="line">  SSTableReader(path=<span class="string">'/home/admin/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-jb-947337-Data.db'</span>)]</span><br><span class="line">INFO [CompactionExecutor:<span class="number">48884</span>] <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">08</span>:<span class="number">08</span>:<span class="number">34</span>,<span class="number">181</span> CompactionTask.java (<span class="built_in">line</span> <span class="number">299</span>) Compacted <span class="number">5</span> sstables <span class="built_in">to</span> [</span><br><span class="line">/home/admin/cassandra/data/<span class="keyword">system</span>/compactions_in_progress/<span class="keyword">system</span>-compactions_in_progress-jb-<span class="number">947339</span>,].  </span><br><span class="line"><span class="number">1</span>,<span class="number">803</span> <span class="keyword">bytes</span> <span class="built_in">to</span> <span class="number">1</span>,<span class="number">044</span> (~<span class="number">57</span>% <span class="operator">of</span> original) <span class="operator">in</span> <span class="number">18</span>ms = <span class="number">0.055313</span>MB/s.  </span><br><span class="line"><span class="number">12</span> total partitions merged <span class="built_in">to</span> <span class="number">8.</span>  Partition <span class="built_in">merge</span> counts were &#123;<span class="number">1</span>:<span class="number">8</span>, <span class="number">2</span>:<span class="number">2</span>, &#125;</span><br></pre></td></tr></table></figure>
<p>1:8表示：有8行从一个sstables中获取<br>2:2表示：有2行从两个sstables中获取</p>
<p>疑问：partitions数量从12个被合并为8个，为什么partition会减少呢？<br>totalSourceRows=12, totalkeysWritten=8<br>rows和keys的概念是不同的。 相同key可以有多个rows。<br>所以12条记录中，会有4条记录的row-key和8条中的相同。最后的keys数量也就只有4个。  </p>
<h3 id="节点sstable数量异常">节点sstable数量异常</h3><p>某个节点读延迟异常高，700ms</p>
<p><img src="http://img.blog.csdn.net/20160317181038372" alt="fp_readrt_high"></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@fp</span>-cass048160 ~]$ nodetool cfstats forseti_fp.android_device_session</span><br><span class="line"><span class="string">Keyspace:</span> forseti_fp</span><br><span class="line">    Read <span class="string">Count:</span> <span class="number">608718</span></span><br><span class="line">    Read <span class="string">Latency:</span> <span class="number">414.3243900525366</span> ms.</span><br><span class="line">    Write <span class="string">Count:</span> <span class="number">594753618</span></span><br><span class="line">    Write <span class="string">Latency:</span> <span class="number">0.025195973536725928</span> ms.</span><br><span class="line">    Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">        Table:</span> android_device_session</span><br><span class="line">        SSTable <span class="string">count:</span> <span class="number">32459</span></span><br><span class="line">        Space used (live), <span class="string">bytes:</span> <span class="number">2788804636549</span></span><br><span class="line">        Space used (total), <span class="string">bytes:</span> <span class="number">2795041174866</span></span><br><span class="line">        Off heap memory used (total), <span class="string">bytes:</span> <span class="number">2909029224</span></span><br><span class="line">        SSTable Compression <span class="string">Ratio:</span> <span class="number">0.3635126499232498</span></span><br><span class="line">        Number of keys (estimate): <span class="number">1299672448</span></span><br><span class="line">        Memtable cell <span class="string">count:</span> <span class="number">30494</span></span><br><span class="line">        Memtable data size, <span class="string">bytes:</span> <span class="number">109313490</span></span><br><span class="line">        Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">19297</span></span><br><span class="line">        Local read <span class="string">count:</span> <span class="number">608718</span></span><br><span class="line">        Local read <span class="string">latency:</span> <span class="number">866.253</span> ms</span><br><span class="line">        Local write <span class="string">count:</span> <span class="number">594753660</span></span><br><span class="line">        Local write <span class="string">latency:</span> <span class="number">0.024</span> ms</span><br></pre></td></tr></table></figure>
<p>同一个集群其他节点的读延迟很少，sstable数量不超过20个。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@fp</span>-cass048159 ~]$ nodetool cfstats forseti_fp.android_device_session</span><br><span class="line"><span class="string">Keyspace:</span> forseti_fp</span><br><span class="line">    Read <span class="string">Count:</span> <span class="number">266951</span></span><br><span class="line">    Read <span class="string">Latency:</span> <span class="number">0.9562793471461055</span> ms.</span><br><span class="line">    Write <span class="string">Count:</span> <span class="number">799860155</span></span><br><span class="line">    Write <span class="string">Latency:</span> <span class="number">0.024167126153446163</span> ms.</span><br><span class="line">    Pending <span class="string">Tasks:</span> <span class="number">0</span></span><br><span class="line"><span class="label">        Table:</span> android_device_session</span><br><span class="line">        SSTable <span class="string">count:</span> <span class="number">16</span></span><br><span class="line">        Space used (live), <span class="string">bytes:</span> <span class="number">4644725077858</span></span><br><span class="line">        Space used (total), <span class="string">bytes:</span> <span class="number">4659648681740</span></span><br><span class="line">        Off heap memory used (total), <span class="string">bytes:</span> <span class="number">2942472988</span></span><br><span class="line">        SSTable Compression <span class="string">Ratio:</span> <span class="number">0.3659509172064071</span></span><br><span class="line">        Number of keys (estimate): <span class="number">1344413568</span></span><br><span class="line">        Memtable cell <span class="string">count:</span> <span class="number">30468</span></span><br><span class="line">        Memtable data size, <span class="string">bytes:</span> <span class="number">107505453</span></span><br><span class="line">        Memtable <span class="keyword">switch</span> <span class="string">count:</span> <span class="number">25428</span></span><br><span class="line">        Local read <span class="string">count:</span> <span class="number">266951</span></span><br><span class="line">        Local read <span class="string">latency:</span> <span class="number">0.774</span> ms</span><br><span class="line">        Local write <span class="string">count:</span> <span class="number">799860178</span></span><br><span class="line">        Local write <span class="string">latency:</span> <span class="number">0.022</span> ms</span><br></pre></td></tr></table></figure>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass048169 ~]$ nodetool status |grep RAC|awk '&#123;<span class="keyword">print</span> <span class="label">$2&#125;</span>' | <span class="keyword">while</span> <span class="keyword">read</span> ip; <span class="keyword">do</span> echo <span class="label">$ip</span>; nodetool -<span class="keyword">h</span> <span class="label">$ip</span> cfstats forseti.velocity_app | grep <span class="string">"SSTable count"</span>; done</span><br><span class="line">192.168.48.163</span><br><span class="line">        SSTable <span class="keyword">count</span>: 42</span><br><span class="line">192.168.48.162</span><br><span class="line">        SSTable <span class="keyword">count</span>: 34</span><br><span class="line">192.168.48.174</span><br><span class="line">        SSTable <span class="keyword">count</span>: 26</span><br><span class="line">192.168.48.173</span><br><span class="line">        SSTable <span class="keyword">count</span>: 26</span><br><span class="line">192.168.48.171</span><br><span class="line">        SSTable <span class="keyword">count</span>: 30</span><br><span class="line">192.168.48.169</span><br><span class="line">        SSTable <span class="keyword">count</span>: 2620</span><br></pre></td></tr></table></figure>
<p>磁盘空间和status的负载不同，差距不是一般大：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass048169 ~]$ df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3       <span class="number">271</span>G  <span class="number">8.3</span>G  <span class="number">249</span>G   <span class="number">4</span>% /</span><br><span class="line">tmpfs            <span class="number">16</span>G     <span class="number">0</span>   <span class="number">16</span>G   <span class="number">0</span>% /dev/shm</span><br><span class="line">/dev/sda1       <span class="number">190</span>M   <span class="number">30</span>M  <span class="number">151</span>M  <span class="number">17</span>% /boot</span><br><span class="line">/dev/sdb1        <span class="number">11</span>T  <span class="number">8.3</span>T  <span class="number">1.6</span>T  <span class="number">85</span>% /home</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass048169 ~]$ nodetool status</span><br><span class="line">Note: Ownership information does not include topology; <span class="keyword">for</span> complete information, specify a keyspace</span><br><span class="line">--  Address         Load       Tokens  Owns   Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.163</span>  <span class="number">2.34</span> TB    <span class="number">256</span>     <span class="number">15.9</span>%  <span class="number">003</span>a7621-a62b-<span class="number">4</span>c29-<span class="number">83</span>ac-<span class="number">6724</span>d2d749ab  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.162</span>  <span class="number">2.11</span> TB    <span class="number">256</span>     <span class="number">15.3</span>%  <span class="number">9</span>d507979-f309-<span class="number">4</span>a8b-<span class="number">98e2</span>-<span class="number">92385701</span>dcfe  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.174</span>  <span class="number">2.35</span> TB    <span class="number">256</span>     <span class="number">17.9</span>%  bc66ae3b-d694-<span class="number">4286</span>-<span class="number">9</span>c89-<span class="number">09</span>ea46ea740d  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.173</span>  <span class="number">2.39</span> TB    <span class="number">256</span>     <span class="number">17.4</span>%  <span class="number">6</span>de0bf8b-<span class="number">620</span>b-<span class="number">4</span>b47-b47b-<span class="number">1</span>d8ecb82f20d  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.171</span>  <span class="number">2.24</span> TB    <span class="number">256</span>     <span class="number">15.6</span>%  d9b4f2e3-<span class="number">54</span>a4-<span class="number">47</span>d6-<span class="number">95e1</span>-<span class="number">55</span>a6f9734e79  RAC1</span><br><span class="line">UN  <span class="number">192.168</span><span class="number">.48</span><span class="number">.169</span>  <span class="number">2.63</span> TB    <span class="number">256</span>     <span class="number">17.9</span>%  <span class="number">2</span>a80470e-<span class="number">1</span>dc4-<span class="number">4734</span>-a268-<span class="number">946886f</span>e25b7  RAC1</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass048169 ~]$ du -sh /home/admin/cassandra/data/forseti<span class="comment">/*</span><br><span class="line">3.4T    /home/admin/cassandra/data/forseti/velocity_app</span><br><span class="line">2.5T    /home/admin/cassandra/data/forseti/velocity_global</span><br><span class="line">2.5T    /home/admin/cassandra/data/forseti/velocity_partner</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@cass048169 ~]$ nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">4117</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction         forsetivelocity_partner       <span class="number">454792709</span>       <span class="number">608062664</span>     bytes    <span class="number">74.79</span>%</span><br><span class="line">               Compaction         forseti    velocity_app   <span class="number">5711586451164</span>   <span class="number">6322585431145</span>     bytes    <span class="number">90.34</span>%</span><br><span class="line">               Compaction         forseti velocity_global     <span class="number">11137129414</span>     <span class="number">79062862183</span>     bytes    <span class="number">14.09</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner      <span class="number">3724946719</span>      <span class="number">3887650106</span>     bytes    <span class="number">95.81</span>%</span><br><span class="line">               Compaction         forseti    velocity_app       <span class="number">145281458</span>       <span class="number">167205065</span>     bytes    <span class="number">86.89</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner    <span class="number">112338305659</span>    <span class="number">774832769029</span>     bytes    <span class="number">14.50</span>%</span><br><span class="line">               Compaction         forseti velocity_global     <span class="number">24832092819</span>     <span class="number">41353336206</span>     bytes    <span class="number">60.05</span>%</span><br><span class="line">               Compaction         forseti velocity_global      <span class="number">4981924282</span>      <span class="number">6189383778</span>     bytes    <span class="number">80.49</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">2</span>h48m48s</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@fp-cass048162 velocity_app]$ nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">3082</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction         forseti velocity_global     <span class="number">11519537972</span>     <span class="number">58891073447</span>     bytes    <span class="number">19.56</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner       <span class="number">519435163</span>       <span class="number">900884457</span>     bytes    <span class="number">57.66</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner    <span class="number">218779482632</span>    <span class="number">268314967832</span>     bytes    <span class="number">81.54</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner     <span class="number">53136709412</span>     <span class="number">77669440754</span>     bytes    <span class="number">68.41</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner        <span class="number">96402475</span>       <span class="number">225578061</span>     bytes    <span class="number">42.74</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner        <span class="number">13945308</span>       <span class="number">205008051</span>     bytes     <span class="number">6.80</span>%</span><br><span class="line">               Compaction         forseti    velocity_app     <span class="number">92188611730</span>    <span class="number">284042451190</span>     bytes    <span class="number">32.46</span>%</span><br><span class="line">               Compaction         forsetivelocity_partner       <span class="number">205665564</span>       <span class="number">700947805</span>     bytes    <span class="number">29.34</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">0</span>h39m03s</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@cass047202 ~]$ nodetool compactionstats</span><br><span class="line">pending tasks: <span class="number">1</span></span><br><span class="line">          compaction type        keyspace           table       completed           total      unit  progress</span><br><span class="line">               Compaction         forseti        velocity      <span class="number">4094787925</span>      <span class="number">6749331650</span>     bytes    <span class="number">60.67</span>%</span><br><span class="line">Active compaction remaining time :   <span class="number">0</span>h00m19s</span><br></pre></td></tr></table></figure>
<h2 id="tpstats">tpstats</h2><p>正常情况下不应该出现有Dropped的，但是在Driver报错：All host(s) tried for query failed,… connection has been closed.<br>是不是连接数过多，直接拒绝？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[admin@mysql047012 ~]$ /usr/install/cassandra/bin/nodetool tpstats</span><br><span class="line">Pool Name                    Active   Pending      Completed   Blocked  All time blocked</span><br><span class="line">CounterMutationStage              <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ReadStage                         <span class="number">0</span>         <span class="number">0</span>        <span class="number">4302492</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">RequestResponseStage              <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MutationStage                    <span class="number">15</span>         <span class="number">0</span>       <span class="number">44176401</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ReadRepairStage                   <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">GossipStage                       <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CacheCleanupExecutor              <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">AntiEntropyStage                  <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MigrationStage                    <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">Sampler                           <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">ValidationExecutor                <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CommitLogArchiver                 <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MiscStage                         <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemtableFlushWriter               <span class="number">0</span>         <span class="number">0</span>            <span class="number">920</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemtableReclaimMemory             <span class="number">0</span>         <span class="number">0</span>            <span class="number">925</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">PendingRangeCalculator            <span class="number">0</span>         <span class="number">0</span>              <span class="number">1</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">MemtablePostFlush                 <span class="number">0</span>         <span class="number">0</span>           <span class="number">5245</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">CompactionExecutor                <span class="number">1</span>         <span class="number">1</span>         <span class="number">328827</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">InternalResponseStage             <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">HintedHandoff                     <span class="number">0</span>         <span class="number">0</span>              <span class="number">0</span>         <span class="number">0</span>                 <span class="number">0</span></span><br><span class="line">Native-Transport-Requests        <span class="number">19</span>         <span class="number">0</span>       <span class="number">13670768</span>         <span class="number">0</span>              <span class="number">6885</span></span><br><span class="line"></span><br><span class="line">Message type           Dropped</span><br><span class="line">RANGE_SLICE                  <span class="number">0</span></span><br><span class="line">READ_REPAIR                  <span class="number">0</span></span><br><span class="line">PAGED_RANGE                  <span class="number">0</span></span><br><span class="line">BINARY                       <span class="number">0</span></span><br><span class="line">READ                         <span class="number">0</span></span><br><span class="line">MUTATION                  <span class="number">1808</span></span><br><span class="line">_TRACE                       <span class="number">0</span></span><br><span class="line">REQUEST_RESPONSE             <span class="number">0</span></span><br><span class="line">COUNTER_MUTATION             <span class="number">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INFO  [SharedPool-Worker-<span class="number">40</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">23</span> <span class="number">17</span>:<span class="number">38</span>:<span class="number">19</span>,<span class="number">848</span> Message.java:<span class="number">532</span> - Unexpected exception during request; channel = [id: <span class="number">0</span>x04539b0a, /<span class="number">192.168</span>.<span class="number">47.34</span>:<span class="number">64733</span> :&gt; /<span class="number">192.168</span>.<span class="number">47.12</span>:<span class="number">9042</span>]</span><br><span class="line">java.io.IOException: Error <span class="keyword">while</span> <span class="keyword">read</span>(...): Connection reset <span class="keyword">by</span> peer</span><br><span class="line">        at io.netty.channel.epoll.Native.readAddress(Native <span class="function"><span class="keyword">Method</span>) ~[<span class="title">netty</span>-<span class="title">all</span>-4.0.23.<span class="title">Final</span>.<span class="title">jar</span>:</span><span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at io.netty.channel.epoll.EpollSocketChannel$EpollSocketUnsafe.doReadBytes(EpollSocketChannel.java:<span class="number">675</span>) ~[netty-all-<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>.jar:<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at io.netty.channel.epoll.EpollSocketChannel$EpollSocketUnsafe.epollInReady(EpollSocketChannel.java:<span class="number">714</span>) ~[netty-all-<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>.jar:<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:<span class="number">326</span>) ~[netty-all-<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>.jar:<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:<span class="number">264</span>) ~[netty-all-<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>.jar:<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at io.netty.util.concurrent.SingleThreadEventExecutor$<span class="number">2</span>.run(SingleThreadEventExecutor.java:<span class="number">116</span>) ~[netty-all-<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>.jar:<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:<span class="number">137</span>) ~[netty-all-<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>.jar:<span class="number">4.0</span>.<span class="number">23</span>.<span class="keyword">Final</span>]</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">745</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_71]</span><br></pre></td></tr></table></figure>
<h2 id="sstable_writer">sstable writer</h2><blockquote>
<p>Loads newly placed SSTables onto the system without a restart.</p>
</blockquote>
<p><a href="http://www.planetcassandra.org/blog/bulk-loading-options-for-cassandra/" target="_blank" rel="external">http://www.planetcassandra.org/blog/bulk-loading-options-for-cassandra/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">小批量测试</span><br><span class="line">cp /home/admin/md5id_20160601/data/md5_id/data-md5_id-ka-<span class="number">2165</span>* </span><br><span class="line"><span class="built_in">cd</span> ~/cassandra/data/md5/md5_id<span class="operator">-f</span>88d3930345811e694a62bcdca057dae/ </span><br><span class="line">rename data md5 *</span><br><span class="line">nodetool -h <span class="number">192.168</span>.<span class="number">47.202</span> refresh md5 md5_id</span><br><span class="line"></span><br><span class="line"><span class="comment">#重命名所有文件</span></span><br><span class="line"><span class="built_in">cd</span> /home/admin/md5id_20160601/data/md5_id/</span><br><span class="line">rename data md5 * </span><br><span class="line"></span><br><span class="line"><span class="comment">#找出所有不同编号</span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> $( ls | cut <span class="operator">-d</span><span class="string">'-'</span> <span class="operator">-f</span>-<span class="number">4</span> | uniq | head -<span class="number">5</span> ); <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$f</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#一次多个，但是如何循环所有，直到文件夹都处理完毕？ --》使用while循环判断文件夹下存在文件时处理</span></span><br><span class="line">ls | cut <span class="operator">-d</span><span class="string">'-'</span> <span class="operator">-f</span>-<span class="number">4</span> | uniq | head -<span class="number">5</span> | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span>   <span class="comment">#分组，一次可以多个数据文件，而一个数据文件总共包含8个相关组件</span></span><br><span class="line">  mv <span class="variable">$f</span>-* ~/cassandra/data/md5/md5_id<span class="operator">-f</span>88d3930345811e694a62bcdca057dae/   <span class="comment">#移动到cassandra的目标位置</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">nodetool -h <span class="number">192.168</span>.<span class="number">47.202</span> refresh md5 md5_id         <span class="comment">#刷新sstable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#模拟把分多次把一个文件夹test的文件搬到另一个文件夹test1</span></span><br><span class="line">rm -rf <span class="built_in">test</span> <span class="built_in">test</span>1 &amp;&amp; mkdir <span class="built_in">test</span> &amp;&amp; <span class="built_in">cd</span> <span class="built_in">test</span> &amp;&amp; touch <span class="number">10</span> <span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">30</span> <span class="number">31</span> <span class="number">32</span> &amp;&amp; <span class="built_in">cd</span> ~/ &amp;&amp; mkdir <span class="built_in">test</span>1 </span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line">flag=<span class="string">"BEGIN"</span></span><br><span class="line"><span class="keyword">while</span> [ ! <span class="operator">-d</span> <span class="built_in">test</span> ]; <span class="keyword">do</span></span><br><span class="line">  ls | head -<span class="number">2</span> | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span> </span><br><span class="line">    mv <span class="variable">$f</span> ~/<span class="built_in">test</span>1</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="comment">#确保只需要执行一次, test的文件都被移动到test1后，test下没有文件，判断依据是：ls -A为空</span></span><br><span class="line">  <span class="comment">#但是如果没有加任何条件，while循环会无条件判断，因为while中是判断存在文件夹</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"`ls -A ~/test`"</span> = <span class="string">""</span> &amp;&amp; <span class="variable">$flag</span> != <span class="string">"OVER"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    flag=<span class="string">"OVER"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"DONE"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以把判断放在while循环里！--GOOD</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line">flag=<span class="string">"BEGIN"</span></span><br><span class="line"><span class="keyword">while</span> [[ ! <span class="operator">-d</span> <span class="built_in">test</span> &amp;&amp; <span class="variable">$flag</span> != <span class="string">"OVER"</span> ]]; <span class="keyword">do</span></span><br><span class="line">  ls | head -<span class="number">2</span> | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span> </span><br><span class="line">    mv <span class="variable">$f</span> ~/<span class="built_in">test</span>1</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"`ls -A ~/test`"</span> = <span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">    flag=<span class="string">"OVER"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"OVER..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当然可以把if的所有条件都放到while里</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line"><span class="keyword">while</span> [[ ! <span class="operator">-d</span> <span class="built_in">test</span> &amp;&amp; <span class="string">"`ls -A ~/test`"</span> != <span class="string">""</span> ]]; <span class="keyword">do</span></span><br><span class="line">  ls | head -<span class="number">2</span> | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span> </span><br><span class="line">    mv <span class="variable">$f</span> ~/<span class="built_in">test</span>1</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"OVER..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##最终脚本</span></span><br><span class="line">startT=$(date +%s)</span><br><span class="line"><span class="built_in">cd</span> /home/admin/md5id_20160601/data/md5_id</span><br><span class="line"><span class="keyword">while</span> [[ ! <span class="operator">-d</span> /home/admin/md5id_20160601/data/md5_id &amp;&amp;  <span class="string">"`ls -A /home/admin/md5id_20160601/data/md5_id`"</span> != <span class="string">""</span> ]]; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"......"</span></span><br><span class="line">  start=$(date +%s)</span><br><span class="line">  ls | cut <span class="operator">-d</span><span class="string">'-'</span> <span class="operator">-f</span>-<span class="number">4</span> | uniq | head -<span class="number">5</span> | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span></span><br><span class="line">    cfile=<span class="string">"<span class="variable">$f</span>-*"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$cfile</span></span><br><span class="line">    mv <span class="variable">$cfile</span> /home/admin/cassandra/data/md5/md5_id<span class="operator">-f</span>88d3930345811e694a62bcdca057dae/</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  nodetool -h <span class="number">192.168</span>.<span class="number">47.202</span> refresh md5 md5_id</span><br><span class="line">  end=$(date +%s)</span><br><span class="line">  time=$(( <span class="variable">$end</span> - <span class="variable">$start</span> ))</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"耗时:<span class="variable">$time</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"OVER..."</span></span><br><span class="line">endT=$(date +%s)</span><br><span class="line">timeT=$(( <span class="variable">$endT</span> - <span class="variable">$startT</span> ))</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Total耗时:<span class="variable">$timeT</span>"</span></span><br></pre></td></tr></table></figure>
<p>ONLY ONE SHELL: IF RUN TOO LONG, JUST <code>CTRL+z, bg, jobs</code>:  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/admin/md5id_20160601/data/md5_id</span><br><span class="line">ls | cut <span class="operator">-d</span><span class="string">'-'</span> <span class="operator">-f</span>-<span class="number">4</span> | uniq | <span class="keyword">while</span> <span class="built_in">read</span> f; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">"batch <span class="variable">$f</span>"</span>; mv <span class="variable">$f</span>-* /home/admin/cassandra/data/md5/md5_id<span class="operator">-f</span>88d3930345811e694a62bcdca057dae/; nodetool -h <span class="number">192.168</span>.<span class="number">47.202</span> refresh md5 md5_id; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h3 id="文件数过多">文件数过多</h3><p>大批量同时进行，报错生成hs_err_pid9998.log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># There is insufficient memory for the Java Runtime Environment to continue.</span><br><span class="line"># Native memory allocation (malloc) failed to allocate 350224384 bytes for committing reserved memory.</span><br><span class="line"># Possible reasons:</span><br><span class="line">#   The system is out of physical RAM or swap space</span><br><span class="line">#   In 32 bit mode, the process size limit was hit</span><br><span class="line"># Possible solutions:</span><br><span class="line">#   Reduce memory <span class="operator"><span class="keyword">load</span> <span class="keyword">on</span> the <span class="keyword">system</span></span><br><span class="line">#   Increase <span class="keyword">physical</span> <span class="keyword">memory</span> <span class="keyword">or</span> swap <span class="keyword">space</span></span><br><span class="line">#   <span class="keyword">Check</span> <span class="keyword">if</span> swap backing <span class="keyword">store</span> <span class="keyword">is</span> <span class="keyword">full</span></span><br><span class="line">#   <span class="keyword">Use</span> <span class="number">64</span> <span class="built_in">bit</span> <span class="keyword">Java</span> <span class="keyword">on</span> a <span class="number">64</span> <span class="built_in">bit</span> OS</span><br><span class="line">#   Decrease <span class="keyword">Java</span> <span class="keyword">heap</span> <span class="keyword">size</span> (-Xmx/-Xms)</span><br><span class="line">#   Decrease <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">Java</span> threads</span><br><span class="line">#   Decrease <span class="keyword">Java</span> <span class="keyword">thread</span> stack <span class="keyword">sizes</span> (-Xss)</span><br><span class="line">#   <span class="keyword">Set</span> larger code <span class="keyword">cache</span> <span class="keyword">with</span> -XX:ReservedCodeCacheSize=</span><br><span class="line"># This <span class="keyword">output</span> <span class="keyword">file</span> may be truncated <span class="keyword">or</span> incomplete.</span><br><span class="line">#</span><br><span class="line">#  <span class="keyword">Out</span> <span class="keyword">of</span> <span class="keyword">Memory</span> <span class="keyword">Error</span> (os_linux.cpp:<span class="number">2726</span>), pid=<span class="number">9998</span>, tid=<span class="number">140593796617984</span></span><br><span class="line">#</span><br><span class="line"># JRE <span class="keyword">version</span>:  (<span class="number">7.0</span>_51-b13) (<span class="keyword">build</span> )</span><br><span class="line"># <span class="keyword">Java</span> VM: <span class="keyword">Java</span> HotSpot(TM) <span class="number">64</span>-<span class="built_in">Bit</span> <span class="keyword">Server</span> VM (<span class="number">24.51</span>-b03 mixed <span class="keyword">mode</span> linux-amd64 compressed oops)</span><br><span class="line"># <span class="keyword">Failed</span> <span class="keyword">to</span> write core dump. Core dumps have been disabled. <span class="keyword">To</span> <span class="keyword">enable</span> core dumping, try <span class="string">"ulimit -c unlimited"</span> <span class="keyword">before</span> <span class="keyword">starting</span> <span class="keyword">Java</span> again</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="comment">---------------  T H R E A D  ---------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">thread</span> (<span class="number">0x00007fde84009800</span>):  JavaThread <span class="string">"Unknown thread"</span> [_thread_in_vm, <span class="keyword">id</span>=<span class="number">10000</span>, stack(<span class="number">0x00007fde8b3e1000</span>,<span class="number">0x00007fde8b4e2000</span>)]</span><br><span class="line"></span><br><span class="line">Stack: [<span class="number">0x00007fde8b3e1000</span>,<span class="number">0x00007fde8b4e2000</span>],  sp=<span class="number">0x00007fde8b4e01a0</span>,  free <span class="keyword">space</span>=<span class="number">1020</span><span class="keyword">k</span></span><br><span class="line"><span class="keyword">Native</span> frames: (J=<span class="keyword">compiled</span> <span class="keyword">Java</span> code, j=interpreted, Vv=VM code, <span class="keyword">C</span>=<span class="keyword">native</span> code)</span><br><span class="line">V  [libjvm.so+<span class="number">0x992f4a</span>]  VMError::report_and_die()+<span class="number">0x2ea</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x4931ab</span>]  report_vm_out_of_memory(<span class="built_in">char</span> const*, <span class="built_in">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="built_in">char</span> const*)+<span class="number">0x9b</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x81338e</span>]  os::Linux::commit_memory_impl(<span class="built_in">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, bool)+<span class="number">0xfe</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x81383f</span>]  os::Linux::commit_memory_impl(<span class="built_in">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, bool)+<span class="number">0x4f</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x813a2c</span>]  os::pd_commit_memory(<span class="built_in">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, bool)+<span class="number">0xc</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x80daea</span>]  os::commit_memory(<span class="built_in">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, bool)+<span class="number">0x2a</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x87fcd3</span>]  PSVirtualSpace::expand_by(<span class="keyword">unsigned</span> <span class="keyword">long</span>)+<span class="number">0x53</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x86eaf3</span>]  PSOldGen::initialize(ReservedSpace, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="built_in">char</span> const*, <span class="built_in">int</span>)+<span class="number">0x103</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x299043</span>]  AdjoiningGenerations::AdjoiningGenerations(ReservedSpace, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>)+<span class="number">0x3e3</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x8341e0</span>]  ParallelScavengeHeap::initialize()+<span class="number">0x550</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x9664ca</span>]  Universe::initialize_heap()+<span class="number">0xca</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x967699</span>]  universe_init()+<span class="number">0x79</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x5a9625</span>]  init_globals()+<span class="number">0x65</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x94ef8d</span>]  Threads::create_vm(JavaVMInitArgs*, bool*)+<span class="number">0x1ed</span></span><br><span class="line">V  [libjvm.so+<span class="number">0x6307e4</span>]  JNI_CreateJavaVM+<span class="number">0x74</span></span><br><span class="line"><span class="keyword">C</span>  [libjli.so+<span class="number">0x2f8e</span>]  JavaMain+<span class="number">0x9e</span></span></span><br></pre></td></tr></table></figure>
<p>因为内存不足，直接挂掉，日志文件中并不会有报错信息！</p>
<p>节点挂掉后，重启报错：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ERROR <span class="number">01</span>:<span class="number">47</span>:<span class="number">33</span> Exception encountered during startup</span><br><span class="line">org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.io</span><span class="class">.FSReadError</span>: java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.ColumnFamilyStore</span><span class="class">.removeUnfinishedCompactionLeftovers</span>(ColumnFamilyStore<span class="class">.java</span>:<span class="number">668</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.CassandraDaemon</span><span class="class">.setup</span>(CassandraDaemon<span class="class">.java</span>:<span class="number">308</span>) [apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.CassandraDaemon</span><span class="class">.activate</span>(CassandraDaemon<span class="class">.java</span>:<span class="number">564</span>) [apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.CassandraDaemon</span><span class="class">.main</span>(CassandraDaemon<span class="class">.java</span>:<span class="number">653</span>) [apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">Caused by: java<span class="class">.lang</span><span class="class">.NullPointerException</span>: null</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.ColumnFamilyStore</span><span class="class">.removeUnfinishedCompactionLeftovers</span>(ColumnFamilyStore<span class="class">.java</span>:<span class="number">660</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  ... <span class="number">3</span> common frames omitted</span><br><span class="line">FSReadError <span class="keyword">in</span> Failed to remove unfinished compaction leftovers (file: /home/admin/cassandra/data/md5/md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">1051</span>-Statistics.db).  See log <span class="keyword">for</span> <span class="tag">details</span>.</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.ColumnFamilyStore</span><span class="class">.removeUnfinishedCompactionLeftovers</span>(ColumnFamilyStore<span class="class">.java</span>:<span class="number">668</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.CassandraDaemon</span><span class="class">.setup</span>(CassandraDaemon<span class="class">.java</span>:<span class="number">308</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.CassandraDaemon</span><span class="class">.activate</span>(CassandraDaemon<span class="class">.java</span>:<span class="number">564</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.service</span><span class="class">.CassandraDaemon</span><span class="class">.main</span>(CassandraDaemon<span class="class">.java</span>:<span class="number">653</span>)</span><br><span class="line">Caused by: java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.ColumnFamilyStore</span><span class="class">.removeUnfinishedCompactionLeftovers</span>(ColumnFamilyStore<span class="class">.java</span>:<span class="number">660</span>)</span><br><span class="line">  ... <span class="number">3</span> more</span><br><span class="line">Exception encountered during startup: java<span class="class">.lang</span><span class="class">.NullPointerException</span></span><br><span class="line"></span><br><span class="line">Polling page always armed</span><br><span class="line">Deoptimize                         <span class="number">4</span></span><br><span class="line">GenCollectForAllocation            <span class="number">1</span></span><br><span class="line">CMS_Initial_Mark                   <span class="number">1</span></span><br><span class="line">CMS_Final_Remark                   <span class="number">1</span></span><br><span class="line">EnableBiasedLocking                <span class="number">1</span></span><br><span class="line">RevokeBias                        <span class="number">77</span></span><br><span class="line">BulkRevokeBias                     <span class="number">5</span></span><br><span class="line">Exit                               <span class="number">1</span></span><br><span class="line">   <span class="number">15</span> VM operations coalesced during safepoint</span><br><span class="line">Maximum sync <span class="tag">time</span>   <span class="number">6133</span> ms</span><br><span class="line">Maximum vm operation <span class="tag">time</span> (except <span class="keyword">for</span> Exit VM operation)    <span class="number">521</span> ms</span><br></pre></td></tr></table></figure>
<p>正常来说，一个Data文件附属多个其他组件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">正常的文件</span><br><span class="line">[admin@cass047202 md5_id-f88d3930345811e694a62bcdca057dae]$ ll md5-md5_id-ka-<span class="number">996</span>-*</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin     <span class="number">66859</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">23</span>:<span class="number">06</span> md5-md5_id-ka-<span class="number">996</span>-CompressionInfo.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">298635289</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">23</span>:<span class="number">06</span> md5-md5_id-ka-<span class="number">996</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin        <span class="number">10</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">23</span>:<span class="number">06</span> md5-md5_id-ka-<span class="number">996</span>-Digest.sha1</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin        <span class="number">16</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">23</span>:<span class="number">06</span> md5-md5_id-ka-<span class="number">996</span>-Filter.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">242118240</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">23</span>:<span class="number">06</span> md5-md5_id-ka-<span class="number">996</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin      <span class="number">9895</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">17</span>:<span class="number">53</span> md5-md5_id-ka-<span class="number">996</span>-Statistics.db</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin    <span class="number">113248</span> <span class="number">6</span>月  <span class="number">16</span> <span class="number">16</span>:<span class="number">23</span> md5-md5_id-ka-<span class="number">996</span>-Summary.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin        <span class="number">91</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">23</span>:<span class="number">06</span> md5-md5_id-ka-<span class="number">996</span>-TOC.txt</span><br><span class="line"></span><br><span class="line">但是报错的这个文件只有三个，没有statics等。。。</span><br><span class="line">[admin@cass047202 md5_id-f88d3930345811e694a62bcdca057dae]$ ll md5-md5_id-ka-<span class="number">1051</span>*</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">282</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">17</span>:<span class="number">56</span> /home/admin/cassandra/data/md5/md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">1051</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">231</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">17</span>:<span class="number">56</span> /home/admin/cassandra/data/md5/md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">1051</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">1.8</span>M <span class="number">6</span>月  <span class="number">17</span> <span class="number">17</span>:<span class="number">55</span> /home/admin/cassandra/data/md5/md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">1051</span>-Summary.db</span><br><span class="line"></span><br><span class="line">tmp临时文件中也没有</span><br><span class="line">[admin@cass047202 md5_id-f88d3930345811e694a62bcdca057dae]$ ll | grep tmp</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">9967157248</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmp-ka-<span class="number">354</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">7710769152</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmp-ka-<span class="number">354</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">1224817304</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">10</span>:<span class="number">01</span> md5-md5_id-tmp-ka-<span class="number">4329</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin  <span class="number">950730752</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">10</span>:<span class="number">01</span> md5-md5_id-tmp-ka-<span class="number">4329</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin          <span class="number">0</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmp-ka-<span class="number">48053</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin          <span class="number">0</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmp-ka-<span class="number">48053</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">9049241296</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmp-ka-<span class="number">526</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">6999441408</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmp-ka-<span class="number">526</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">9967157248</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmplink-ka-<span class="number">354</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">7710769152</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmplink-ka-<span class="number">354</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">1224817304</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">10</span>:<span class="number">01</span> md5-md5_id-tmplink-ka-<span class="number">4329</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin  <span class="number">950730752</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">10</span>:<span class="number">01</span> md5-md5_id-tmplink-ka-<span class="number">4329</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">9049241296</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmplink-ka-<span class="number">526</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">2</span> admin admin <span class="number">6999441408</span> <span class="number">6</span>月  <span class="number">17</span> <span class="number">18</span>:<span class="number">54</span> md5-md5_id-tmplink-ka-<span class="number">526</span>-Index.db</span><br></pre></td></tr></table></figure>
<p>删除这些文件后， 重启没有问题，但是查询时报错：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">WARN  [SharedPool-Worker-<span class="number">52</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">23</span>:<span class="number">30</span>,<span class="number">376</span> AbstractTracingAwareExecutorService.<span class="string">java:</span><span class="number">169</span> - Uncaught exception on thread Thread[SharedPool-Worker-<span class="number">52</span>,<span class="number">5</span>,main]: &#123;&#125;</span><br><span class="line">java.lang.<span class="string">RuntimeException:</span> java.lang.<span class="string">RuntimeException:</span> java.io.<span class="string">FileNotFoundException:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/md5/</span>md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">139</span>-Data.db (打开的文件过&gt;多)</span><br><span class="line">        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.<span class="string">java:</span><span class="number">2244</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.<span class="string">java:</span><span class="number">471</span>) ~[<span class="string">na:</span><span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">        at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.<span class="string">java:</span><span class="number">164</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.<span class="string">java:</span><span class="number">105</span>) [apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at java.lang.Thread.run(Thread.<span class="string">java:</span><span class="number">744</span>) [<span class="string">na:</span><span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">Caused <span class="string">by:</span> java.lang.<span class="string">RuntimeException:</span> java.io.<span class="string">FileNotFoundException:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/md5/</span>md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">139</span>-Data.db (打开的文件过多)</span><br><span class="line">        at org.apache.cassandra.io.compress.CompressedRandomAccessReader.open(CompressedRandomAccessReader.<span class="string">java:</span><span class="number">52</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.util.CompressedPoolingSegmentedFile.createReader(CompressedPoolingSegmentedFile.<span class="string">java:</span><span class="number">85</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.sstable.SSTableReader.openDataReader(SSTableReader.<span class="string">java:</span><span class="number">2075</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.sstable.SSTableScanner.&lt;init&gt;(SSTableScanner.<span class="string">java:</span><span class="number">84</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.sstable.SSTableScanner.getScanner(SSTableScanner.<span class="string">java:</span><span class="number">63</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.sstable.SSTableReader.getScanner(SSTableReader.<span class="string">java:</span><span class="number">1859</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.db.RowIteratorFactory.getIterator(RowIteratorFactory.<span class="string">java:</span><span class="number">67</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.db.ColumnFamilyStore.getSequentialIterator(ColumnFamilyStore.<span class="string">java:</span><span class="number">2074</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.db.ColumnFamilyStore.getRangeSlice(ColumnFamilyStore.<span class="string">java:</span><span class="number">2191</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.db.RangeSliceCommand.executeLocally(RangeSliceCommand.<span class="string">java:</span><span class="number">132</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.service.StorageProxy$LocalRangeSliceRunnable.runMayThrow(StorageProxy.<span class="string">java:</span><span class="number">1567</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.<span class="string">java:</span><span class="number">2241</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        ... <span class="number">4</span> common frames omitted</span><br><span class="line">Caused <span class="string">by:</span> java.io.<span class="string">FileNotFoundException:</span> <span class="regexp">/home/</span>admin<span class="regexp">/cassandra/</span>data<span class="regexp">/md5/</span>md5_id-f88d3930345811e694a62bcdca057dae/md5-md5_id-ka-<span class="number">139</span>-Data.db (打开的文件过多)</span><br><span class="line">        at java.io.RandomAccessFile.open(Native Method) ~[<span class="string">na:</span><span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">        at java.io.RandomAccessFile.&lt;init&gt;(RandomAccessFile.<span class="string">java:</span><span class="number">241</span>) ~[<span class="string">na:</span><span class="number">1.7</span><span class="number">.0</span>_51]</span><br><span class="line">        at org.apache.cassandra.io.util.RandomAccessReader.&lt;init&gt;(RandomAccessReader.<span class="string">java:</span><span class="number">65</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.compress.CompressedRandomAccessReader.&lt;init&gt;(CompressedRandomAccessReader.<span class="string">java:</span><span class="number">70</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        at org.apache.cassandra.io.compress.CompressedRandomAccessReader.open(CompressedRandomAccessReader.<span class="string">java:</span><span class="number">48</span>) ~[apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>.<span class="string">jar:</span><span class="number">2.1</span><span class="number">.13</span>]</span><br><span class="line">        ... <span class="number">15</span> common frames omitted</span><br><span class="line"></span><br><span class="line">WARN  [epollEventLoopGroup-<span class="number">2</span>-<span class="number">1</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">19</span> <span class="number">10</span>:<span class="number">23</span>:<span class="number">54</span>,<span class="number">839</span> Slf4JLogger.<span class="string">java:</span><span class="number">151</span> - An exceptionCaught() event was fired, and it reached at the tail of the pipeline. It usually means the last handler <span class="keyword">in</span> the pipeline did not handle the exception.</span><br><span class="line">java.io.<span class="string">IOException:</span> Error during accept(...): 打开的文件过多</span><br><span class="line">  at io.netty.channel.epoll.Native.accept(Native Method) ~[netty-all-<span class="number">4.0</span><span class="number">.23</span>.Final.<span class="string">jar:</span><span class="number">4.0</span><span class="number">.23</span>.Final]</span><br><span class="line">  at io.netty.channel.epoll.EpollServerSocketChannel$EpollServerSocketUnsafe.epollInReady(EpollServerSocketChannel.<span class="string">java:</span><span class="number">102</span>) ~[netty-all-<span class="number">4.0</span><span class="number">.23</span>.Final.<span class="string">jar:</span><span class="number">4.0</span><span class="number">.23</span>.Final]</span><br><span class="line">  at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.<span class="string">java:</span><span class="number">326</span>) [netty-all-<span class="number">4.0</span><span class="number">.23</span>.Final.<span class="string">jar:</span><span class="number">4.0</span><span class="number">.23</span>.Final]</span><br><span class="line">  at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.<span class="string">java:</span><span class="number">264</span>) [netty-all-<span class="number">4.0</span><span class="number">.23</span>.Final.<span class="string">jar:</span><span class="number">4.0</span><span class="number">.23</span>.Final]</span><br><span class="line">  at io.netty.util.concurrent.SingleThreadEventExecutor$<span class="number">2.</span>run(SingleThreadEventExecutor.<span class="string">java:</span><span class="number">116</span>) [netty-all-<span class="number">4.0</span><span class="number">.23</span>.Final.<span class="string">jar:</span><span class="number">4.0</span><span class="number">.23</span>.Final]</span><br><span class="line">  at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.<span class="string">java:</span><span class="number">137</span>) [netty-all-<span class="number">4.0</span><span class="number">.23</span>.Final.<span class="string">jar:</span><span class="number">4.0</span><span class="number">.23</span>.Final]</span><br><span class="line">  at java.lang.Thread.run(Thread.<span class="string">java:</span><span class="number">744</span>) [<span class="string">na:</span><span class="number">1.7</span><span class="number">.0</span>_51]</span><br></pre></td></tr></table></figure>
<p>文件夹数过多：–&gt;生成时确保每个文件大点，比如1G</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047202 md5_id-f88d3930345811e694a62bcdca057dae]$ ll -rth | grep Data | wc -l</span><br><span class="line"><span class="number">2127</span></span><br><span class="line">[admin@cass047202 md5_id-f88d3930345811e694a62bcdca057dae]$ ll -rth | grep Data | head</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">281</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">20</span> md5-md5_id-ka-<span class="number">4225</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">282</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">21</span> md5-md5_id-ka-<span class="number">46880</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">285</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">22</span> md5-md5_id-ka-<span class="number">632</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">284</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">23</span> md5-md5_id-ka-<span class="number">47652</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">281</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">25</span> md5-md5_id-ka-<span class="number">3954</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">287</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">26</span> md5-md5_id-ka-<span class="number">47131</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">281</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">27</span> md5-md5_id-ka-<span class="number">1002</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">281</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">28</span> md5-md5_id-ka-<span class="number">491</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">286</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">29</span> md5-md5_id-ka-<span class="number">210</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">281</span>M <span class="number">6</span>月   <span class="number">1</span> <span class="number">11</span>:<span class="number">30</span> md5-md5_id-ka-<span class="number">43627</span>-Data.db</span><br></pre></td></tr></table></figure>
<h3 id="导入数据后，用refresh">导入数据后，用refresh</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047202 cassandra]$ cqlsh <span class="number">192.168.47.202</span></span><br><span class="line">Connected to forseti_cluster at <span class="number">192.168.47.202</span>:9042.</span><br><span class="line">[cqlsh 5.0.1 | Cassandra 2.1.13 | CQL spec 3.2.1 | Native protocol v3]</span><br><span class="line">Use HELP for help.</span><br><span class="line">cqlsh&gt; use data<span class="comment">;</span></span><br><span class="line">cqlsh:data&gt; select * from md5_id limit 1<span class="comment">;</span></span><br><span class="line">Warning: schema version mismatch detected, which might be caused by DOWN nodes<span class="comment">; if this is not the case, check the schema versions of your nodes in system.local and system.peers.</span></span><br><span class="line">Schema metadata was not refreshed. See log for details.</span><br><span class="line">cqlsh:data&gt; quit</span><br><span class="line">[admin@cass047202 cassandra]$ cqlsh <span class="number">192.168.47.202</span></span><br><span class="line">Connection error: ('Unable to connect to any servers', &#123;'<span class="number">192.168.47.202</span>': OperationTimedOut('errors=None, last_host=None',)&#125;)</span><br><span class="line">[admin@cass047202 cassandra]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns    Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.206</span>  802.88 GB  256     ?       <span class="number">75f42842</span>-e3ac-4bbe-947d-<span class="number">6b7537a52</span>1da  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.222</span>  670.08 GB  256     ?       1cc<span class="number">2c236-8</span>def-4f2b-<span class="number">8149-28d59</span>1fc6b05  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.204</span>  627.63 GB  256     ?       91ad<span class="number">3d42-4207</span>-46fe-<span class="number">8188-34c3</span>f0b2dbd2  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.221</span>  677.56 GB  256     ?       87e100ed-85c4-44cb-9d9f-<span class="number">2d602d01</span>6038  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.205</span>  724.58 GB  256     ?       ac6313c8-e<span class="number">0b5-463</span>b-8f90-55dc<span class="number">0f59e476</span>  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.202</span>  1.72 TB    256     ?       abaa0cbc-<span class="number">09d3-4990</span>-8698-ff4d2f2bb4f7  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.203</span>  1.01 TB    256     ?       19b0b9cc-cad<span class="number">2-4b61-8</span>da<span class="number">6-95423</span>fe94af8  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.224</span>  739.47 GB  256     ?       27e84abe-fb06-47ff-<span class="number">8861-130767</span>ee006b  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.225</span>  677.46 GB  256     ?       216c67cf-de7d-<span class="number">4190-9d0</span>d-441fc16a7f71  RAC1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select key,bootstrapped,broadcast_address,cluster_name,cql_version,data_center,gossip_generation,host_id,listen_address,native_protocol_version,partitioner,</span><br><span class="line">    rack,release_version,rpc_address,schema_version,thrift_version from system.local<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"> key   | bootstrapped | broadcast_address | cluster_name    | cql_version | data_center | gossip_generation | host_id                              | listen_address | native_protocol_version |  rack | release_version | rpc_address    | schema_version                       | thrift_version</span><br><span class="line">-------+--------------+-------------------+-----------------+-------------+-------------+-------------------+--------------------------------------+----------------+-------------------------+-------+-----------------+----------------+--------------------------------------+----------------</span><br><span class="line"> local |    COMPLETED |    <span class="number">192.168.47.203</span> | forseti_cluster |       3.2.1 |         DC1 |        <span class="number">1464055043</span> | 19b0b9cc-cad<span class="number">2-4b61-8</span>da<span class="number">6-95423</span>fe94af8 | <span class="number">192.168.47.203</span> |                       3 |  RAC1 |          2.1.13 | <span class="number">192.168.47.203</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c |        19.39.0</span><br><span class="line"></span><br><span class="line">    select peer,data_center,host_id,preferred_ip,rack,release_version,rpc_address,schema_version from system.peers<span class="comment">;</span></span><br><span class="line"> peer           | data_center | host_id                              | preferred_ip | rack | release_version | rpc_address    | schema_version</span><br><span class="line">----------------+-------------+--------------------------------------+--------------+------+-----------------+----------------+--------------------------------------</span><br><span class="line"> <span class="number">192.168.47.205</span> |         DC1 | ac6313c8-e<span class="number">0b5-463</span>b-8f90-55dc<span class="number">0f59e476</span> |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.205</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.221</span> |         DC1 | 87e100ed-85c4-44cb-9d9f-<span class="number">2d602d01</span>6038 |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.221</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.202</span> |         DC1 | abaa0cbc-<span class="number">09d3-4990</span>-8698-ff4d2f2bb4f7 |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.202</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.225</span> |         DC1 | 216c67cf-de7d-<span class="number">4190-9d0</span>d-441fc16a7f71 |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.225</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.224</span> |         DC1 | 27e84abe-fb06-47ff-<span class="number">8861-130767</span>ee006b |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.224</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.204</span> |         DC1 | 91ad<span class="number">3d42-4207</span>-46fe-<span class="number">8188-34c3</span>f0b2dbd2 |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.204</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.206</span> |         DC1 | <span class="number">75f42842</span>-e3ac-4bbe-947d-<span class="number">6b7537a52</span>1da |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.206</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"> <span class="number">192.168.47.222</span> |         DC1 | 1cc<span class="number">2c236-8</span>def-4f2b-<span class="number">8149-28d59</span>1fc6b05 |         null | RAC1 |          2.1.13 | <span class="number">192.168.47.222</span> | <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line"></span><br><span class="line">[admin@cass047202 cassandra]$ nodetool describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">  Name: forseti_cluster</span><br><span class="line">  Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">  Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">  Schema versions:</span><br><span class="line">    <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c: [<span class="number">192.168.47.206</span>, <span class="number">192.168.47.222</span>, <span class="number">192.168.47.221</span>, <span class="number">192.168.47.204</span>, <span class="number">192.168.47.205</span>, <span class="number">192.168.47.202</span>, <span class="number">192.168.47.203</span>, <span class="number">192.168.47.224</span>, <span class="number">192.168.47.225</span>]</span><br><span class="line"></span><br><span class="line">[admin@cass047202 cassandra]$ nodetool -h <span class="number">192.168.47.203</span> describecluster</span><br><span class="line">Cluster Information:</span><br><span class="line">  Name: forseti_cluster</span><br><span class="line">  Snitch: org.apache.cassandra.locator.DynamicEndpointSnitch</span><br><span class="line">  Partitioner: org.apache.cassandra.dht.Murmur3Partitioner</span><br><span class="line">  Schema versions:</span><br><span class="line">    <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c: [<span class="number">192.168.47.206</span>, <span class="number">192.168.47.222</span>, <span class="number">192.168.47.221</span>, <span class="number">192.168.47.204</span>, <span class="number">192.168.47.205</span>, <span class="number">192.168.47.203</span>, <span class="number">192.168.47.224</span>, <span class="number">192.168.47.225</span>]</span><br><span class="line">    UNREACHABLE: [<span class="number">192.168.47.202</span>] </span><br><span class="line"></span><br><span class="line">[admin@cass047203 ~]$ nodetool status</span><br><span class="line">--  Address         Load       Tokens  Owns    Host ID                               Rack</span><br><span class="line">UN  <span class="number">192.168.47.205</span>  724.58 GB  256     ?       ac6313c8-e<span class="number">0b5-463</span>b-8f90-55dc<span class="number">0f59e476</span>  RAC1</span><br><span class="line">DN  <span class="number">192.168.47.202</span>  1.72 TB    256     ?       abaa0cbc-<span class="number">09d3-4990</span>-8698-ff4d2f2bb4f7  RAC1</span><br><span class="line">UN  <span class="number">192.168.47.203</span>  1.01 TB    256     ?       19b0b9cc-cad<span class="number">2-4b61-8</span>da<span class="number">6-95423</span>fe94af8  RAC1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">INFO  01:50:05 Harmless error reading saved cache /home/admin/cassandra/saved_caches/KeyCache-ba.db</span><br><span class="line">java.lang.RuntimeException: Cache schema version b48bf712-fad2-3951-bb18-aa<span class="number">178e738b30</span> does not match current schema version <span class="number">73e0e7c4</span>-03b1-3db6-8967-d7c0144faa5c</span><br><span class="line">  at org.apache.cassandra.cache.AutoSavingCache.loadSaved(AutoSavingCache.java:188) ~[apache-cassandra-2.1.13.jar:2.1.13]</span><br><span class="line">  at org.apache.cassandra.cache.AutoSavingCache$3.call(AutoSavingCache.java:148) [apache-cassandra-2.1.13.jar:2.1.13]</span><br><span class="line">  at org.apache.cassandra.cache.AutoSavingCache$3.call(AutoSavingCache.java:144) [apache-cassandra-2.1.13.jar:2.1.13]</span><br><span class="line">  at java.util.concurrent.FutureTask.run(FutureTask.java:262) [na:<span class="number">1.7.0_51</span>]</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:<span class="number">1.7.0_51</span>]</span><br><span class="line">  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:<span class="number">1.7.0_51</span>]</span><br><span class="line">  at java.lang.Thread.run(Thread.java:744) [na:<span class="number">1.7.0_51</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">只要不操作：select * from md5_id limit 1<span class="comment">;  其他节点就不会认为202DN掉了。</span></span><br></pre></td></tr></table></figure>
<h3 id="通过增大内存来增大sstable大小（内存不足）">通过增大内存来增大sstable大小（内存不足）</h3><p>内存为512M，每个数据文件和索引文件的大小都差不多（281M，231M）。能不能减少Index文件的占用？？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047203 md5_id]$ ll -rth|grep Data | wc -l</span><br><span class="line"><span class="number">2576</span></span><br><span class="line">[admin@cass047203 md5_id]$ cd ..</span><br><span class="line">[admin@cass047203 data]$ du -sh *</span><br><span class="line"><span class="number">1.3</span>T    md5_id</span><br><span class="line">[admin@cass047204 md5_id]$ ll data-md5_id-ka-<span class="number">2010</span>-* -h</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin  <span class="number">66</span>K <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-CompressionInfo.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">281</span>M <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">10</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-Digest.sha1</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">16</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-Filter.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">231</span>M <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">9.7</span>K <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-Statistics.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">91</span> <span class="number">6</span>月   <span class="number">2</span> <span class="number">22</span>:<span class="number">26</span> data-md5_id-ka-<span class="number">2010</span>-TOC.txt</span><br></pre></td></tr></table></figure>
<p>内存为2048，直接在运行Cassnadra的线上跑</p>
<p>nohup java -cp guava-19.0.jar:rainbow-table-1.0.0-SNAPSHOT-jar-with-dependencies.jar \<br>cn.fraudmetrix.vulcan.rainbowtable.sstable.BulkLoadIdCard -table md5_id -partition 13 -memory 1024 &gt; rainbow-table-idcard.log.1 2&gt;&amp;1 &amp;</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.OutOfMemoryError: GC overhead limit exceeded</span><br><span class="line">    <span class="keyword">at</span> java.util.Arrays.copyOfRange(Arrays.java:<span class="number">2694</span>)</span><br><span class="line">    <span class="keyword">at</span> java.lang.String.&lt;init&gt;(String.java:<span class="number">203</span>)</span><br><span class="line">    <span class="keyword">at</span> java.lang.StringBuilder.toString(StringBuilder.java:<span class="number">405</span>)</span><br><span class="line">    <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.last1(AbstractGenData.java:<span class="number">220</span>)</span><br><span class="line">    <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.genIdCardOneProvince(AbstractGenData.java:<span class="number">82</span>)</span><br><span class="line">    <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.genIdCard(AbstractGenData.java:<span class="number">63</span>)</span><br><span class="line">    <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.genData(AbstractGenData.java:<span class="number">55</span>)</span><br><span class="line">    <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.sstable.BulkLoadIdCard.main(BulkLoadIdCard.java:<span class="number">116</span>)</span><br><span class="line"></span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM warning: INFO: os::commit_memory(<span class="number">0x0000000632f80000</span>, <span class="number">436731904</span>, <span class="number">0</span>) failed; <span class="keyword">error</span>='无法分配内存' (errno=<span class="number">12</span>)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span><br><span class="line"><span class="comment"># Native memory allocation (malloc) failed to allocate 436731904 bytes for committing reserved memory.</span></span><br><span class="line"><span class="comment"># An error report file with more information is saved as:</span></span><br><span class="line"><span class="comment"># /home/admin/hs_err_pid33681.log</span></span><br></pre></td></tr></table></figure>
<p>因为Cassandra本身占用了很大内存，运行sstable的程序内存不足，可以先停掉Cassandra。为了不影响线上，只能停掉一个节点，生成完数据，再停另一个节点。。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047225 ~]$ <span class="built_in">free</span> -h</span><br><span class="line">             total       used       <span class="built_in">free</span>     shared    buffers     cached</span><br><span class="line">Mem:           <span class="number">31</span>G        <span class="number">30</span>G       <span class="number">470</span>M       <span class="number">716</span>K        <span class="number">30</span>M       <span class="number">3.8</span>G</span><br><span class="line">-/+ buffers/cache:        <span class="number">27</span>G       <span class="number">4.3</span>G</span><br><span class="line">Swap:           <span class="number">0</span>B         <span class="number">0</span>B         <span class="number">0</span>B</span><br></pre></td></tr></table></figure>
<p>设置内存大小，并使用G1，刚开始还好，过了一段时间，控制台打印的WriteCount几乎不动了，查看GC，这个时候会发现OC=OU。只能等FGC完成后，才有可能继续打印，<br>不过没过多久，这种情况会继续下去。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">nohup java -Xmx16g -Xms16g -XX:+UseG1GC -XX:MaxGCPauseMillis=1000 -cp guava-19.0.jar:rainbow-table-1.0.0-SNAPSHOT-jar-with-dependencies.jar \</span><br><span class="line">cn.fraudmetrix.vulcan.rainbowtable.sstable.BulkLoadIdCard -table md5_id -partition $myRange -memory 4096 &gt; rainbow-table-idcard.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">jstat -gc -h 10 `jps | grep BulkLoadIdCard |awk '&#123;print $1&#125;'` 1000 | \</span><br><span class="line">awk '&#123;printf("%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t%10s\t\n",$1,$5,$3,$4,$6,$8,$11,$12,$13,$14)&#125;'</span><br><span class="line"></span><br><span class="line">[admin@cass047225 ~]$ jstat -gc -h 10 `jps | grep BulkLoadIdCard |awk '&#123;print $1&#125;'` 1000</span><br><span class="line"> S0C    S1C      S0U   S1U      EC        EU       OC         OU         PC       PU         YGC  YGCT    FGC     FGCT     GCT</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 46</span><span class="number">03904.0 50</span><span class="number">7904.0 120</span><span class="number">66816.0 101</span><span class="number">33504.0 163</span><span class="number">84.0 12784</span>.5     52   30.335   0      0.000   30.335</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 46</span><span class="number">03904.0 113</span><span class="number">8688.0 120</span><span class="number">66816.0 101</span><span class="number">33504.0 163</span><span class="number">84.0 12784</span>.5     52   30.335   0      0.000   30.335</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 46</span><span class="number">03904.0 200</span><span class="number">7040.0 120</span><span class="number">66816.0 101</span><span class="number">33504.0 163</span><span class="number">84.0 12784</span>.5     52   30.335   0      0.000   30.335</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 46</span><span class="number">03904.0 28</span><span class="number">83584.0 120</span><span class="number">66816.0 101</span><span class="number">33504.0 163</span><span class="number">84.0 12784</span>.5     52   30.335   0      0.000   30.335</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 46</span><span class="number">03904.0 37</span><span class="number">02784.0 120</span><span class="number">66816.0 101</span><span class="number">33504.0 163</span><span class="number">84.0 12784</span>.5     52   30.335   0      0.000   30.335</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 46</span><span class="number">03904.0 43</span><span class="number">33568.0 120</span><span class="number">66816.0 101</span><span class="number">33504.0 163</span><span class="number">84.0 12784</span>.5     52   30.335   0      0.000   30.335</span><br><span class="line"> 0.0   <span class="number">425984.0</span>  0.0   <span class="number">425984.0</span> <span class="number">4333568.0</span> <span class="number">229376.0 120</span><span class="number">17664.0 101</span><span class="number">29408.0 163</span><span class="number">84.0 12784</span>.5     53   30.975   0      0.000   30.975</span><br><span class="line"> 0.0   <span class="number">425984.0</span>  0.0   <span class="number">425984.0</span> <span class="number">4333568.0</span> <span class="number">942080.0</span> <span class="number">12017664.0</span> <span class="number">10129408.0</span> <span class="number">16384.0 127</span>84.5     53   30.975   0      0.000   30.975</span><br><span class="line"> 0.0   <span class="number">425984.0</span>  0.0   <span class="number">425984.0</span> <span class="number">4333568.0</span> <span class="number">1433600.0</span> <span class="number">12017664.0</span> <span class="number">10129408.0</span> <span class="number">16384.0 127</span>84.5     53   30.975   0      0.000   30.975</span><br><span class="line"> 0.0   <span class="number">425984.0</span>  0.0   <span class="number">425984.0</span> <span class="number">4333568.0</span> <span class="number">1785856.0</span> <span class="number">12017664.0</span> <span class="number">10129408.0</span> <span class="number">16384.0 127</span>84.5     54   30.975   0      0.000   30.975</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 41</span><span class="number">28768.0 245</span><span class="number">760.0 125</span><span class="number">41952.0 105</span><span class="number">79968.0 163</span><span class="number">84.0 12784</span>.5     54   32.056   0      0.000   32.056</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 41</span><span class="number">28768.0 106</span><span class="number">4960.0 125</span><span class="number">41952.0 105</span><span class="number">79968.0 163</span><span class="number">84.0 12784</span>.5     54   32.056   0      0.000   32.056</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 41</span><span class="number">28768.0 167</span><span class="number">1168.0 125</span><span class="number">41952.0 105</span><span class="number">79968.0 163</span><span class="number">84.0 12784</span>.5     54   32.056   0      0.000   32.056</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 41</span><span class="number">28768.0 243</span><span class="number">3024.0 125</span><span class="number">41952.0 105</span><span class="number">79968.0 163</span><span class="number">84.0 12784</span>.5     54   32.056   0      0.000   32.056</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 41</span><span class="number">28768.0 31</span><span class="number">70304.0 125</span><span class="number">41952.0 105</span><span class="number">79968.0 163</span><span class="number">84.0 12784</span>.5     54   32.056   0      0.000   32.056</span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 41</span><span class="number">28768.0 38</span><span class="number">33856.0 125</span><span class="number">41952.0 105</span><span class="number">79968.0 163</span><span class="number">84.0 12784</span>.5     54   32.056   0      0.000   32.056</span><br><span class="line"> 0.0   <span class="number">409600.0</span>  0.0   <span class="number">409600.0</span> <span class="number">3457024.0</span> <span class="number">147456.0 129</span><span class="number">10592.0 105</span><span class="number">75872.0 163</span><span class="number">84.0 12784</span>.5     55   32.641   0      0.000   32.641</span><br><span class="line"> 0.0   <span class="number">409600.0</span>  0.0   <span class="number">409600.0</span> <span class="number">3457024.0</span> <span class="number">655360.0</span> <span class="number">12910592.0</span> <span class="number">10575872.0</span> <span class="number">16384.0 127</span>84.5     55   32.641   0      0.000   32.641</span><br><span class="line"> 0.0   <span class="number">409600.0</span>  0.0   <span class="number">409600.0</span> <span class="number">3457024.0</span> <span class="number">1269760.0</span> <span class="number">12910592.0</span> <span class="number">10575872.0</span> <span class="number">16384.0 127</span>84.5     55   32.641   0      0.000   32.641</span><br><span class="line"> 0.0   <span class="number">409600.0</span>  0.0   <span class="number">409600.0</span> <span class="number">3457024.0</span> <span class="number">1900544.0</span> <span class="number">12910592.0</span> <span class="number">10575872.0</span> <span class="number">16384.0 127</span>84.5     55   32.641   0      0.000   32.641</span><br><span class="line"></span><br><span class="line">0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770048.5</span> <span class="number">16384.0 127</span>84.5    133   65.236   2     61.382  <span class="number">126.618</span></span><br><span class="line"> 0.0    0.0    0.0    0.0   <span class="number">884736.0</span> <span class="number">450560.0</span> <span class="number">15892480.0</span> <span class="number">15681440.2</span> <span class="number">16384.0 127</span>84.5    133   65.236   2    <span class="number">122.783</span>  <span class="number">188.019</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"> 0.0   <span class="number">57344.0</span>  0.0   <span class="number">57344.0 82</span><span class="number">7392.0 37</span><span class="number">6832.0 158</span><span class="number">92480.0 156</span><span class="number">80244.2 163</span><span class="number">84.0 12784</span>.5    134   65.394   2    <span class="number">122.783</span>  <span class="number">188.177</span></span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 77</span><span class="number">8240.0 163</span><span class="number">840.0 158</span><span class="number">92480.0 157</span><span class="number">01920.2 163</span><span class="number">84.0 12784</span>.5    135   65.691   2    <span class="number">122.783</span>  <span class="number">188.474</span></span><br><span class="line"> 0.0   <span class="number">106496.0</span>  0.0   <span class="number">106496.0 77</span><span class="number">8240.0 72</span><span class="number">9088.0 158</span><span class="number">92480.0 157</span><span class="number">01920.2 163</span><span class="number">84.0 12784</span>.5    136   65.691   2    <span class="number">122.783</span>  <span class="number">188.474</span></span><br><span class="line"> 0.0   <span class="number">73728.0</span>  0.0   <span class="number">73728.0 81</span><span class="number">1008.0 60</span><span class="number">6208.0 158</span><span class="number">92480.0 157</span><span class="number">96935.3 163</span><span class="number">84.0 12784</span>.5    136   66.004   2    <span class="number">122.783</span>  <span class="number">188.786</span></span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 81</span><span class="number">9200.0 53</span><span class="number">2480.0 158</span><span class="number">92480.0 158</span><span class="number">69856.2 163</span><span class="number">84.0 12784</span>.5    137   66.209   2    <span class="number">122.783</span>  <span class="number">188.992</span></span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 81</span><span class="number">9200.0 77</span><span class="number">0048.0 158</span><span class="number">92480.0 158</span><span class="number">69856.2 163</span><span class="number">84.0 12784</span>.5    138   66.209   2    <span class="number">122.783</span>  <span class="number">188.992</span></span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 81</span><span class="number">9200.0 77</span><span class="number">0048.0 158</span><span class="number">92480.0 158</span><span class="number">69856.2 163</span><span class="number">84.0 12784</span>.5    138   66.209   2    <span class="number">122.783</span>  <span class="number">188.992</span></span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 35</span><span class="number">2256.0 35</span><span class="number">2256.0 163</span><span class="number">59424.0 163</span><span class="number">53184.2 163</span><span class="number">84.0 12784</span>.5    139   67.845   2    <span class="number">122.783</span>  <span class="number">190.628</span></span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 35</span><span class="number">2256.0 35</span><span class="number">2256.0 163</span><span class="number">59424.0 163</span><span class="number">53184.2 163</span><span class="number">84.0 12784</span>.5    139   67.845   2    <span class="number">122.783</span>  <span class="number">190.628</span></span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 35</span><span class="number">2256.0 35</span><span class="number">2256.0 163</span><span class="number">59424.0 163</span><span class="number">53184.2 163</span><span class="number">84.0 12784</span>.5    139   67.845   2    <span class="number">122.783</span>  <span class="number">190.628</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"> 0.0   <span class="number">65536.0</span>  0.0   <span class="number">65536.0 35</span><span class="number">2256.0 35</span><span class="number">2256.0 163</span><span class="number">59424.0 163</span><span class="number">53184.2 163</span><span class="number">84.0 12784</span>.5    139   67.845   2    <span class="number">122.783</span>  <span class="number">190.628</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16770976.2</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">122.783</span>  <span class="number">194.533</span></span><br><span class="line"> 0.0    0.0    0.0    0.0   <span class="number">811008.0</span> <span class="number">385024.0</span> <span class="number">15966208.0</span> <span class="number">15960817.7</span> <span class="number">16384.0 127</span>84.5    140   71.751   3    <span class="number">173.703</span>  <span class="number">245.454</span></span><br><span class="line"> 0.0    0.0    0.0    0.0   <span class="number">811008.0</span> <span class="number">811008.0</span> <span class="number">15966208.0</span> <span class="number">15960817.7</span> <span class="number">16384.0 127</span>84.5    141   71.751   3    <span class="number">173.703</span>  <span class="number">245.454</span></span><br><span class="line"> 0.0    0.0    0.0    0.0   <span class="number">811008.0</span> <span class="number">811008.0</span> <span class="number">15966208.0</span> <span class="number">15960817.7</span> <span class="number">16384.0 127</span>84.5    141   71.751   3    <span class="number">173.703</span>  <span class="number">245.454</span></span><br><span class="line"> 0.0    0.0    0.0    0.0   <span class="number">286720.0</span> <span class="number">155648.0 164</span><span class="number">90496.0 164</span><span class="number">85105.7 163</span><span class="number">84.0 12784</span>.5    141   73.666   3    <span class="number">173.703</span>  <span class="number">247.369</span></span><br><span class="line"> 0.0    0.0    0.0    0.0   <span class="number">286720.0</span> <span class="number">286720.0</span> <span class="number">16490496.0</span> <span class="number">16485105.7</span> <span class="number">16384.0 127</span>84.5    142   73.666   3    <span class="number">173.703</span>  <span class="number">247.369</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16771825.7</span> <span class="number">16384.0 127</span>84.5    143   75.252   4    <span class="number">173.703</span>  <span class="number">248.955</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16771825.7</span> <span class="number">16384.0 127</span>84.5    143   75.252   4    <span class="number">173.703</span>  <span class="number">248.955</span></span><br><span class="line"> 0.0    0.0    0.0    0.0     0.0      0.0    <span class="number">16777216.0</span> <span class="number">16771825.7</span> <span class="number">16384.0 127</span>84.5    143   75.252   4    <span class="number">173.703</span>  <span class="number">248.955</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT</span><br></pre></td></tr></table></figure>
<p>为什么FGC之后，几乎马上又重现？实际上内存中的数据还没有刷写到磁盘上，当然这部分内存就不能回收了。这就导致FGC实际上并没有回收多少内存。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047225 ~]$ tail -f rainbow-<span class="keyword">table</span>-idcard.<span class="literal">log</span></span><br><span class="line">WriteCount:65531,<span class="keyword">SAMPLE</span>:92FF12AE4A27EC01692DC05F041ECF44,13010219701011217X</span><br><span class="line">[admin@cass047225 ~]$ <span class="keyword">cat</span> rainbow-<span class="keyword">table</span>-idcard.<span class="keyword">log</span> | grep <span class="string">"WriteCount"</span> | wc -<span class="keyword">l</span></span><br><span class="line">515</span><br><span class="line">[admin@cass047225 ~]$ du -<span class="keyword">sh</span> *</span><br><span class="line">12K md5_id20160622</span><br></pre></td></tr></table></figure>
<p>写了将近515<em>65531=3000万，还是没有生成一个sstable文件。 因为buffer size设置为4G，只有Memtable达到4G时，才会刷写一个sstable文件。<br>一条记录”92FF12AE4A27EC01692DC05F041ECF44,13010219701011217X”只有52个字符(52byte)，再加上写sstable还有其他组件比如index，<br>就算一条记录=1KB=1024byte，1万记录=10000kb=10M, 3000万=3000</em>10M=300G  </p>
<p>以buffer=4G为例，总内存=4G=4000M=4000M<em>1000KB=4000000KB=400万KB,如果内存中只以一条记录=52byte计算。<br>总共可以存放最大记录数=`400万</em>1000byte/50byte=400万*20=800万`，但是上面将近3000万，为什么没有结果？  </p>
<p>唯一的办法是减少buffer大小到2G/1G…。通过让内存中的数据尽快刷写到磁盘上！释放掉内存中的数据。<br>否则数据源源不断写到内存中，无法及时释放，即使FGC也无能为力。</p>
<p>运行过程，查看堆栈信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047225 md5_id]$ jps -lm</span><br><span class="line">7594 cn.fraudmetrix.vulcan.rainbowtable.sstable.BulkLoadIdCard -table md5_id -partition 13,14,15,21 -memory 2048</span><br><span class="line">[admin@cass047225 md5_id]$ top -Hp 7594</span><br><span class="line">top - 10:19:32 up 211 days, 15:36,  3 users,  <span class="operator"><span class="keyword">load</span> average: <span class="number">2.77</span>, <span class="number">3.62</span>, <span class="number">3.68</span></span><br><span class="line">Tasks:  <span class="number">34</span> total,   <span class="number">4</span> running,  <span class="number">30</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span><br><span class="line">Cpu(s):  <span class="number">8.6</span>%us,  <span class="number">3.0</span>%sy, <span class="number">17.3</span>%ni, <span class="number">70.6</span>%<span class="keyword">id</span>,  <span class="number">0.2</span>%wa,  <span class="number">0.0</span>%hi,  <span class="number">0.3</span>%si,  <span class="number">0.0</span>%st</span><br><span class="line">Mem:  <span class="number">32794428</span><span class="keyword">k</span> total, <span class="number">32493800</span><span class="keyword">k</span> used,   <span class="number">300628</span><span class="keyword">k</span> free,    <span class="number">31944</span><span class="keyword">k</span> buffers</span><br><span class="line">Swap:        <span class="number">0</span><span class="keyword">k</span> total,        <span class="number">0</span><span class="keyword">k</span> used,        <span class="number">0</span><span class="keyword">k</span> free, <span class="number">10400404</span><span class="keyword">k</span> cached</span><br><span class="line"></span><br><span class="line">  PID <span class="keyword">USER</span>      PR  NI  VIRT  RES  SHR S %CPU %MEM    <span class="keyword">TIME</span>+  COMMAND</span><br><span class="line"> <span class="number">7625</span> <span class="keyword">admin</span>     <span class="number">20</span>   <span class="number">0</span> <span class="number">21.8</span><span class="keyword">g</span>  <span class="number">19</span><span class="keyword">g</span>  <span class="number">16</span><span class="keyword">m</span> R <span class="number">101.7</span> <span class="number">63.6</span>  <span class="number">17</span>:<span class="number">55.41</span> <span class="keyword">java</span></span><br><span class="line"> <span class="number">7603</span> <span class="keyword">admin</span>     <span class="number">20</span>   <span class="number">0</span> <span class="number">21.8</span><span class="keyword">g</span>  <span class="number">19</span><span class="keyword">g</span>  <span class="number">16</span><span class="keyword">m</span> R <span class="number">99.7</span> <span class="number">63.6</span>  <span class="number">28</span>:<span class="number">13.74</span> <span class="keyword">java</span></span><br><span class="line"> <span class="number">7627</span> <span class="keyword">admin</span>     <span class="number">20</span>   <span class="number">0</span> <span class="number">21.8</span><span class="keyword">g</span>  <span class="number">19</span><span class="keyword">g</span>  <span class="number">16</span><span class="keyword">m</span> R <span class="number">99.7</span> <span class="number">63.6</span>  <span class="number">13</span>:<span class="number">13.43</span> <span class="keyword">java</span></span><br><span class="line"> <span class="number">7628</span> <span class="keyword">admin</span>     <span class="number">20</span>   <span class="number">0</span> <span class="number">21.8</span><span class="keyword">g</span>  <span class="number">19</span><span class="keyword">g</span>  <span class="number">16</span><span class="keyword">m</span> R <span class="number">99.7</span> <span class="number">63.6</span>  <span class="number">13</span>:<span class="number">13.73</span> <span class="keyword">java</span></span><br><span class="line"></span><br><span class="line">[<span class="keyword">admin</span>@cass047225 ~]$ ./<span class="keyword">show</span>-busy-javathreads.sh</span><br><span class="line">Busy(<span class="number">73.4</span>%) <span class="keyword">thread</span>(<span class="number">7603</span>/<span class="number">0x1db3</span>) stack <span class="keyword">of</span> <span class="keyword">java</span> process(<span class="number">7594</span>) <span class="keyword">under</span> <span class="keyword">user</span>(<span class="keyword">admin</span>):</span><br><span class="line"><span class="string">"main"</span> prio=<span class="number">10</span> tid=<span class="number">0x00007f7468009000</span> nid=<span class="number">0x1db3</span> runnable [<span class="number">0x00007f7471aa9000</span>]</span><br><span class="line">   <span class="keyword">java</span>.lang.<span class="keyword">Thread</span>.State: RUNNABLE</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.util.Arrays.copyOf(Arrays.<span class="keyword">java</span>:<span class="number">2271</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.lang.StringCoding.safeTrim(StringCoding.<span class="keyword">java</span>:<span class="number">79</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.lang.StringCoding.<span class="keyword">encode</span>(StringCoding.<span class="keyword">java</span>:<span class="number">365</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.lang.<span class="keyword">String</span>.getBytes(<span class="keyword">String</span>.<span class="keyword">java</span>:<span class="number">939</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.utils.ByteBufferUtil.<span class="keyword">bytes</span>(ByteBufferUtil.<span class="keyword">java</span>:<span class="number">225</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.serializers.AbstractTextSerializer.serialize(AbstractTextSerializer.<span class="keyword">java</span>:<span class="number">49</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.serializers.AbstractTextSerializer.serialize(AbstractTextSerializer.<span class="keyword">java</span>:<span class="number">26</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.db.marshal.AbstractType.<span class="keyword">decompose</span>(AbstractType.<span class="keyword">java</span>:<span class="number">73</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.io.sstable.CQLSSTableWriter.addRow(CQLSSTableWriter.<span class="keyword">java</span>:<span class="number">142</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.io.sstable.CQLSSTableWriter.addRow(CQLSSTableWriter.<span class="keyword">java</span>:<span class="number">118</span>)</span><br><span class="line">  <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.sstable.BulkLoadIdCard.batchWrite(BulkLoadIdCard.<span class="keyword">java</span>:<span class="number">55</span>)</span><br><span class="line">  <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.genIdCardOneProvince(AbstractGenData.<span class="keyword">java</span>:<span class="number">86</span>)</span><br><span class="line">  <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.genIdCard(AbstractGenData.<span class="keyword">java</span>:<span class="number">63</span>)</span><br><span class="line">  <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.util.AbstractGenData.genData(AbstractGenData.<span class="keyword">java</span>:<span class="number">55</span>)</span><br><span class="line">  <span class="keyword">at</span> cn.fraudmetrix.vulcan.rainbowtable.sstable.BulkLoadIdCard.<span class="keyword">main</span>(BulkLoadIdCard.<span class="keyword">java</span>:<span class="number">116</span>)</span><br><span class="line"></span><br><span class="line">Busy(<span class="number">46.8</span>%) <span class="keyword">thread</span>(<span class="number">7625</span>/<span class="number">0x1dc9</span>) stack <span class="keyword">of</span> <span class="keyword">java</span> process(<span class="number">7594</span>) <span class="keyword">under</span> <span class="keyword">user</span>(<span class="keyword">admin</span>):</span><br><span class="line"><span class="string">"G1 Concurrent Refinement Thread#0"</span> prio=<span class="number">10</span> tid=<span class="number">0x00007f746803c800</span> nid=<span class="number">0x1dc9</span> runnable</span><br><span class="line"></span><br><span class="line">Busy(<span class="number">34.5</span>%) <span class="keyword">thread</span>(<span class="number">7628</span>/<span class="number">0x1dcc</span>) stack <span class="keyword">of</span> <span class="keyword">java</span> process(<span class="number">7594</span>) <span class="keyword">under</span> <span class="keyword">user</span>(<span class="keyword">admin</span>):</span><br><span class="line"><span class="string">"Gang worker#1 (G1 Parallel Marking Threads)"</span> prio=<span class="number">10</span> tid=<span class="number">0x00007f746806b800</span> nid=<span class="number">0x1dcc</span> runnable</span><br><span class="line"></span><br><span class="line">Busy(<span class="number">34.5</span>%) <span class="keyword">thread</span>(<span class="number">7627</span>/<span class="number">0x1dcb</span>) stack <span class="keyword">of</span> <span class="keyword">java</span> process(<span class="number">7594</span>) <span class="keyword">under</span> <span class="keyword">user</span>(<span class="keyword">admin</span>):</span><br><span class="line"><span class="string">"Gang worker#0 (G1 Parallel Marking Threads)"</span> prio=<span class="number">10</span> tid=<span class="number">0x00007f7468069800</span> nid=<span class="number">0x1dcb</span> runnable</span><br><span class="line"></span><br><span class="line">Busy(<span class="number">25.6</span>%) <span class="keyword">thread</span>(<span class="number">7688</span>/<span class="number">0x1e08</span>) stack <span class="keyword">of</span> <span class="keyword">java</span> process(<span class="number">7594</span>) <span class="keyword">under</span> <span class="keyword">user</span>(<span class="keyword">admin</span>):</span><br><span class="line"><span class="string">"Thread-2"</span> prio=<span class="number">10</span> tid=<span class="number">0x00007f7469e3b000</span> nid=<span class="number">0x1e08</span> waiting <span class="keyword">on</span> condition [<span class="number">0x00007f73f012c000</span>]</span><br><span class="line">   <span class="keyword">java</span>.lang.<span class="keyword">Thread</span>.State: WAITING (parking)</span><br><span class="line">  <span class="keyword">at</span> sun.misc.<span class="keyword">Unsafe</span>.park(<span class="keyword">Native</span> Method)</span><br><span class="line">  - parking <span class="keyword">to</span> <span class="keyword">wait</span> <span class="keyword">for</span>  &lt;<span class="number">0x00000003fb131618</span>&gt; (a <span class="keyword">java</span>.util.<span class="keyword">concurrent</span>.SynchronousQueue$TransferStack)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.util.<span class="keyword">concurrent</span>.locks.LockSupport.park(LockSupport.<span class="keyword">java</span>:<span class="number">186</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.util.<span class="keyword">concurrent</span>.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.<span class="keyword">java</span>:<span class="number">458</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.util.<span class="keyword">concurrent</span>.SynchronousQueue$TransferStack.transfer(SynchronousQueue.<span class="keyword">java</span>:<span class="number">359</span>)</span><br><span class="line">  <span class="keyword">at</span> <span class="keyword">java</span>.util.<span class="keyword">concurrent</span>.SynchronousQueue.take(SynchronousQueue.<span class="keyword">java</span>:<span class="number">925</span>)</span><br><span class="line">  <span class="keyword">at</span> org.apache.cassandra.io.sstable.SSTableSimpleUnsortedWriter$DiskWriter.run(SSTableSimpleUnsortedWriter.<span class="keyword">java</span>:<span class="number">240</span>)</span></span><br></pre></td></tr></table></figure>
<p>打印存活的对象占比</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[admin@cass047225 ~]$ jmap -histo:live <span class="number">7594</span></span><br><span class="line"></span><br><span class="line"> num     <span class="preprocessor">#instances         #bytes  class name</span></span><br><span class="line">----------------------------------------------</span><br><span class="line">   <span class="number">1</span>:      <span class="number">48953579</span>     <span class="number">2</span>,<span class="number">349</span>,<span class="number">771</span>,<span class="number">792</span>  java.nio.HeapByteBuffer</span><br><span class="line">   <span class="number">2</span>:      <span class="number">48959365</span>     <span class="number">2</span>,<span class="number">154</span>,<span class="number">707</span>,<span class="number">824</span>  [B</span><br><span class="line">   <span class="number">3</span>:      <span class="number">48953434</span>     <span class="number">1566509888</span>  org.apache.cassandra.db.BufferCell</span><br><span class="line">   <span class="number">4</span>:      <span class="number">24476718</span>     <span class="number">1370696168</span>  [Lorg.apache.cassandra.db.Cell;</span><br><span class="line">   <span class="number">5</span>:      <span class="number">24533905</span>      <span class="number">981356200</span>  java.util.TreeMap$Entry</span><br><span class="line">   <span class="number">6</span>:      <span class="number">24476720</span>      <span class="number">979068800</span>  org.apache.cassandra.io.sstable.CQLSSTableWriter$BufferedWriter$<span class="number">1</span></span><br><span class="line">   <span class="number">7</span>:      <span class="number">24476718</span>      <span class="number">783254976</span>  org.apache.cassandra.db.composites.CompoundSparseCellName</span><br><span class="line">   <span class="number">8</span>:      <span class="number">24476720</span>      <span class="number">587441280</span>  org.apache.cassandra.dht.LongToken</span><br><span class="line">   <span class="number">9</span>:      <span class="number">24476720</span>      <span class="number">587441280</span>  org.apache.cassandra.db.DeletionInfo</span><br><span class="line">  <span class="number">10</span>:      <span class="number">24476719</span>      <span class="number">587441256</span>  org.apache.cassandra.db.BufferDecoratedKey</span><br><span class="line">  <span class="number">11</span>:         <span class="number">94817</span>        <span class="number">9075720</span>  [C</span><br><span class="line">  <span class="number">12</span>:         <span class="number">27311</span>        <span class="number">3820688</span>  &lt;constMethodKlass&gt;</span><br><span class="line">  <span class="number">13</span>:         <span class="number">27311</span>        <span class="number">3505968</span>  &lt;methodKlass&gt;</span><br><span class="line">  <span class="number">14</span>:          <span class="number">2349</span>        <span class="number">2919216</span>  &lt;constantPoolKlass&gt;</span><br><span class="line">  <span class="number">15</span>:         <span class="number">94761</span>        <span class="number">2274264</span>  java.lang.String</span><br><span class="line">  <span class="number">16</span>:          <span class="number">2349</span>        <span class="number">1619680</span>  &lt;instanceKlassKlass&gt;</span><br><span class="line">  <span class="number">17</span>:          <span class="number">1882</span>        <span class="number">1474880</span>  &lt;constantPoolCacheKlass&gt;</span><br><span class="line">  <span class="number">18</span>:         <span class="number">57261</span>        <span class="number">1374264</span>  java.lang.Long</span><br><span class="line">  <span class="number">19</span>:         <span class="number">28499</span>        <span class="number">1367952</span>  org.apache.cassandra.io.sstable.IndexSummaryBuilder$ReadableBoundary</span><br></pre></td></tr></table></figure>
<p>内存缓冲区设置为2G时，运行省份13花费：69385；内存为512，花费：75597<br>2G时每个SSTable的文件大小为1G多，512M时，每个文件的大小为281M<br>只有一半的原因是Data文件和Index文件都差不多大。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">内存为<span class="number">512</span>M</span><br><span class="line">[admin@cass047221 md5_id]$ ll data-md5_id-ka-<span class="number">1578</span>-* -rth</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">16</span> <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-Filter.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">231</span>M <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">282</span>M <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin  <span class="number">66</span>K <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-CompressionInfo.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">9.7</span>K <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-Statistics.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin    <span class="number">8</span> <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-Digest.sha1</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">91</span> <span class="number">6</span>月  <span class="number">24</span> <span class="number">06</span>:<span class="number">23</span> data-md5_id-ka-<span class="number">1578</span>-TOC.txt</span><br><span class="line"></span><br><span class="line">内存为<span class="number">2</span>G</span><br><span class="line">[admin@cass047225 md5_id]$ ll data-md5_id-ka-<span class="number">1</span>-* -rth</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">16</span> <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-Filter.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">924</span>M <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-Index.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">1.2</span>G <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-Data.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">262</span>K <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-CompressionInfo.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">10</span> <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-Digest.sha1</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin <span class="number">9.7</span>K <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-Statistics.db</span><br><span class="line">-rw-rw-r--. <span class="number">1</span> admin admin   <span class="number">91</span> <span class="number">6</span>月  <span class="number">22</span> <span class="number">09</span>:<span class="number">47</span> data-md5_id-ka-<span class="number">1</span>-TOC.txt</span><br></pre></td></tr></table></figure>
<h3 id="分表？">分表？</h3><p>生成数据按照省份，对应表为md5<em>id</em>省份编号，比如md5_id_13。<br>key - value = B566B86D791DB56E4F149B42A2E84B5A,130100196303225584  </p>
<p>最终表有： md5_id_13， md5_id_14，md5_id_15… 总共有30张表<br>每张表数据量大概1000亿/30=30亿  </p>
<p>问题： 给定md5值，怎么知道要查询哪张表？<br>建立md5值和省份的对应关系？ 或者不用建立，查询时所有表依次查询</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">du -<span class="keyword">sh</span> * | <span class="keyword">grep</span> md5_id201606</span><br><span class="line"><span class="keyword">cat</span> rainbow-table-idcard.<span class="built_in">log</span>.<span class="number">2</span> | <span class="keyword">grep</span> seconds</span><br><span class="line"><span class="keyword">cat</span> rainbow-table-idcard.<span class="built_in">log</span>.<span class="number">2</span> | <span class="keyword">grep</span> WriteCount | wc -<span class="keyword">l</span></span><br><span class="line"><span class="keyword">ll</span> md5_id20160623/data/md5_id | <span class="keyword">grep</span> Data | wc -<span class="keyword">l</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>运行节点</th>
<th>省份</th>
<th>数据源个数</th>
<th>耗时(s)</th>
<th>数据占用空间</th>
<th>数据条数</th>
<th>SSTable数量</th>
<th>导入耗时(s)</th>
<th>状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.47.202</td>
<td>22,23,31,32</td>
<td>156,301,32,289=778</td>
<td>29580,59443,6066,57166</td>
<td>1.1T</td>
<td>173812*65531+16516</td>
<td>2164</td>
<td>✅</td>
</tr>
<tr>
<td>192.168.47.203</td>
<td>33,34,35,36</td>
<td>230,256,201,239=926</td>
<td>38062,41404,32837,41002</td>
<td>1.3T</td>
<td>206875*65531</td>
<td>2576</td>
<td>✅</td>
</tr>
<tr>
<td>192.168.47.204</td>
<td>37,41</td>
<td>383,367</td>
<td>61807,60992</td>
</tr>
<tr>
<td>192.168.47.206</td>
<td>46,50,51</td>
<td>72,51,512=635</td>
<td>13851,10217,95683</td>
<td>885G</td>
<td>141864*65531</td>
<td>1767</td>
<td>✅</td>
</tr>
<tr>
<td>192.168.47.221</td>
<td>52,53,54</td>
<td>161,246,161=</td>
<td>20690,31109,20306</td>
<td>791G</td>
<td>126896*65531+20992=8315642768=83亿</td>
<td>1580</td>
<td>25758</td>
<td>✅✅</td>
</tr>
<tr>
<td>192.168.47.225</td>
<td>13,14,15,21</td>
<td>390,274,210,209=1083</td>
<td>69385,47905,36801,36486</td>
<td>1.5T</td>
<td></td>
<td>784</td>
<td>✅</td>
</tr>
<tr>
<td>192.168.48.168</td>
<td>61,62,63,64,65,11,12</td>
<td>231,199,70,65,172,28,23=788</td>
<td>29579,25761,9046,8602,22679,3699,3040</td>
<td>176047*65531</td>
<td>2192</td>
<td>1.1T</td>
</tr>
<tr>
<td>192.168.48.165</td>
<td>43,44,45</td>
<td>284,383,253=920</td>
<td>36764,49562,32799</td>
</tr>
</tbody>
</table>
<p>,42  ==?259</p>
<h2 id="sstableloader">sstableloader</h2><p>168 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd md5_id20160623 &amp;&amp; mv data md5 &amp;&amp; cd md5_id &amp;&amp; <span class="operator"><span class="keyword">rename</span> <span class="keyword">data</span> <span class="keyword">md5</span> *</span><br><span class="line">MAX_HEAP_SIZE=<span class="string">"256M"</span></span><br><span class="line">MAX_HEAP_SIZE=<span class="string">"3096M"</span></span><br><span class="line">nohup /usr/<span class="keyword">install</span>/cassandra/<span class="keyword">bin</span>/sstableloader -<span class="keyword">d</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> /home/<span class="keyword">admin</span>/md5_id20160623/<span class="keyword">md5</span>/md5_id &amp; </span><br><span class="line">nohup apache-cassandra-<span class="number">2.1</span><span class="number">.13</span>/<span class="keyword">bin</span>/sstableloader -<span class="keyword">d</span> <span class="number">192.168</span><span class="number">.47</span><span class="number">.202</span> /home/<span class="keyword">admin</span>/md5_id20160627/<span class="keyword">md5</span>/md5_id &amp; </span><br><span class="line"></span><br><span class="line">Summary <span class="keyword">statistics</span>:</span><br><span class="line">   Connections per host:         : <span class="number">1</span></span><br><span class="line">   Total files transferred:      : <span class="number">14220</span></span><br><span class="line">   Total <span class="keyword">bytes</span> transferred:      : <span class="number">579</span>(gb),<span class="number">024</span>(mb),<span class="number">927</span>(kb),<span class="number">946</span>(b)</span><br><span class="line">   Total <span class="keyword">duration</span> (ms):          : <span class="number">25758</span>,<span class="number">956</span> = <span class="number">7</span><span class="keyword">hour</span></span><br><span class="line">   Average transfer rate (MB/s): : <span class="number">21</span></span><br><span class="line">   Peak transfer rate (MB/s):    : <span class="number">21</span></span><br><span class="line"></span><br><span class="line">[<span class="keyword">admin</span>@cass047202 ~]$ nodetool cfstats <span class="keyword">md5</span>.md5_id | grep <span class="keyword">keys</span></span><br><span class="line">    <span class="built_in">Number</span> <span class="keyword">of</span> <span class="keyword">keys</span> (estimate): <span class="number">5567257543</span></span></span><br></pre></td></tr></table></figure>
<p>如果遇到节点挂掉：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[/<span class="number">192.168</span>.<span class="number">47.222</span>, /<span class="number">192.168</span>.<span class="number">47.204</span>, /<span class="number">192.168</span>.<span class="number">47.203</span>, /<span class="number">192.168</span>.<span class="number">47.224</span>]</span><br><span class="line">java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ExecutionException</span>: org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamException</span>: Stream failed</span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.AbstractFuture</span><span class="variable">$Sync</span>.<span class="function"><span class="title">getValue</span><span class="params">(AbstractFuture.java:<span class="number">299</span>)</span></span></span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.AbstractFuture</span><span class="variable">$Sync</span>.<span class="function"><span class="title">get</span><span class="params">(AbstractFuture.java:<span class="number">286</span>)</span></span></span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.AbstractFuture</span><span class="class">.get</span>(AbstractFuture<span class="class">.java</span>:<span class="number">116</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.tools</span><span class="class">.BulkLoader</span><span class="class">.main</span>(BulkLoader<span class="class">.java</span>:<span class="number">125</span>)</span><br><span class="line">Caused by: org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamException</span>: Stream failed</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.management</span><span class="class">.StreamEventJMXNotifier</span><span class="class">.onFailure</span>(StreamEventJMXNotifier<span class="class">.java</span>:<span class="number">85</span>)</span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Futures</span>$<span class="number">4</span>.<span class="function"><span class="title">run</span><span class="params">(Futures.java:<span class="number">1172</span>)</span></span></span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.MoreExecutors</span><span class="variable">$SameThreadExecutorService</span>.<span class="function"><span class="title">execute</span><span class="params">(MoreExecutors.java:<span class="number">297</span>)</span></span></span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ExecutionList</span><span class="class">.executeListener</span>(ExecutionList<span class="class">.java</span>:<span class="number">156</span>)</span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ExecutionList</span><span class="class">.execute</span>(ExecutionList<span class="class">.java</span>:<span class="number">145</span>)</span><br><span class="line">  at com<span class="class">.google</span><span class="class">.common</span><span class="class">.util</span><span class="class">.concurrent</span><span class="class">.AbstractFuture</span><span class="class">.setException</span>(AbstractFuture<span class="class">.java</span>:<span class="number">202</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamResultFuture</span><span class="class">.maybeComplete</span>(StreamResultFuture<span class="class">.java</span>:<span class="number">208</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamResultFuture</span><span class="class">.handleSessionComplete</span>(StreamResultFuture<span class="class">.java</span>:<span class="number">184</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.closeSession</span>(StreamSession<span class="class">.java</span>:<span class="number">415</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.complete</span>(StreamSession<span class="class">.java</span>:<span class="number">607</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.StreamSession</span><span class="class">.messageReceived</span>(StreamSession<span class="class">.java</span>:<span class="number">471</span>)</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.streaming</span><span class="class">.ConnectionHandler</span><span class="variable">$IncomingMessageHandler</span>.<span class="function"><span class="title">run</span><span class="params">(ConnectionHandler.java:<span class="number">256</span>)</span></span></span><br><span class="line">  at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ERROR [CompactionExecutor:<span class="number">19</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">29</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">19</span>,<span class="number">266</span> CassandraDaemon<span class="class">.java</span>:<span class="number">229</span> - Exception <span class="keyword">in</span> thread Thread[CompactionExecutor:<span class="number">19</span>,<span class="number">1</span>,main]</span><br><span class="line">java<span class="class">.lang</span><span class="class">.RuntimeException</span>: Not enough space <span class="keyword">for</span> compaction, estimated sstables = <span class="number">1</span>, expected write size = <span class="number">221195610</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.checkAvailableDiskSpace</span>(CompactionTask<span class="class">.java</span>:<span class="number">296</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.runMayThrow</span>(CompactionTask<span class="class">.java</span>:<span class="number">124</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.WrappedRunnable</span><span class="class">.run</span>(WrappedRunnable<span class="class">.java</span>:<span class="number">28</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.executeInternal</span>(CompactionTask<span class="class">.java</span>:<span class="number">73</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.AbstractCompactionTask</span><span class="class">.execute</span>(AbstractCompactionTask<span class="class">.java</span>:<span class="number">59</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionManager</span>$<span class="number">8</span>.<span class="function"><span class="title">runMayThrow</span><span class="params">(CompactionManager.java:<span class="number">626</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.WrappedRunnable</span><span class="class">.run</span>(WrappedRunnable<span class="class">.java</span>:<span class="number">28</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span> ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.run</span>(FutureTask<span class="class">.java</span>:<span class="number">262</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="class">.runWorker</span>(ThreadPoolExecutor<span class="class">.java</span>:<span class="number">1145</span>) ~[na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.<span class="function"><span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">615</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">ERROR [HintedHandoffManager:<span class="number">1</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">29</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">19</span>,<span class="number">267</span> CassandraDaemon<span class="class">.java</span>:<span class="number">229</span> - Exception <span class="keyword">in</span> thread Thread[HintedHandoffManager:<span class="number">1</span>,<span class="number">1</span>,main]</span><br><span class="line">java<span class="class">.lang</span><span class="class">.RuntimeException</span>: java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ExecutionException</span>: java<span class="class">.lang</span><span class="class">.RuntimeException</span>: Not enough space <span class="keyword">for</span> compaction, estimated sstables = <span class="number">1</span>, expected write size = <span class="number">221195610</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.HintedHandOffManager</span><span class="class">.compact</span>(HintedHandOffManager<span class="class">.java</span>:<span class="number">282</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.HintedHandOffManager</span><span class="class">.scheduleAllDeliveries</span>(HintedHandOffManager<span class="class">.java</span>:<span class="number">522</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.HintedHandOffManager</span><span class="class">.access</span>$<span class="number">000</span>(HintedHandOffManager<span class="class">.java</span>:<span class="number">93</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.HintedHandOffManager</span>$<span class="number">1</span>.<span class="function"><span class="title">run</span><span class="params">(HintedHandOffManager.java:<span class="number">182</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.concurrent</span><span class="class">.DebuggableScheduledThreadPoolExecutor</span><span class="variable">$UncomplainingRunnable</span>.<span class="function"><span class="title">run</span><span class="params">(DebuggableScheduledThreadPoolExecutor.java:<span class="number">118</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.runAndReset</span>(FutureTask<span class="class">.java</span>:<span class="number">304</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.access$<span class="number">301</span>(ScheduledThreadPoolExecutor<span class="class">.java</span>:<span class="number">178</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ScheduledThreadPoolExecutor</span><span class="variable">$ScheduledFutureTask</span>.<span class="function"><span class="title">run</span><span class="params">(ScheduledThreadPoolExecutor.java:<span class="number">293</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="class">.runWorker</span>(ThreadPoolExecutor<span class="class">.java</span>:<span class="number">1145</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ThreadPoolExecutor</span><span class="variable">$Worker</span>.<span class="function"><span class="title">run</span><span class="params">(ThreadPoolExecutor.java:<span class="number">615</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.lang</span><span class="class">.Thread</span><span class="class">.run</span>(Thread<span class="class">.java</span>:<span class="number">744</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">Caused by: java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.ExecutionException</span>: java<span class="class">.lang</span><span class="class">.RuntimeException</span>: Not enough space <span class="keyword">for</span> compaction, estimated sstables = <span class="number">1</span>, expected write size = <span class="number">221195610</span></span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.report</span>(FutureTask<span class="class">.java</span>:<span class="number">122</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.get</span>(FutureTask<span class="class">.java</span>:<span class="number">188</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.HintedHandOffManager</span><span class="class">.compact</span>(HintedHandOffManager<span class="class">.java</span>:<span class="number">278</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  ... <span class="number">11</span> common frames omitted</span><br><span class="line">Caused by: java<span class="class">.lang</span><span class="class">.RuntimeException</span>: Not enough space <span class="keyword">for</span> compaction, estimated sstables = <span class="number">1</span>, expected write size = <span class="number">221195610</span></span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.checkAvailableDiskSpace</span>(CompactionTask<span class="class">.java</span>:<span class="number">296</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.runMayThrow</span>(CompactionTask<span class="class">.java</span>:<span class="number">124</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.WrappedRunnable</span><span class="class">.run</span>(WrappedRunnable<span class="class">.java</span>:<span class="number">28</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionTask</span><span class="class">.executeInternal</span>(CompactionTask<span class="class">.java</span>:<span class="number">73</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.AbstractCompactionTask</span><span class="class">.execute</span>(AbstractCompactionTask<span class="class">.java</span>:<span class="number">59</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.db</span><span class="class">.compaction</span><span class="class">.CompactionManager</span>$<span class="number">8</span>.<span class="function"><span class="title">runMayThrow</span><span class="params">(CompactionManager.java:<span class="number">626</span>)</span></span> ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at org<span class="class">.apache</span><span class="class">.cassandra</span><span class="class">.utils</span><span class="class">.WrappedRunnable</span><span class="class">.run</span>(WrappedRunnable<span class="class">.java</span>:<span class="number">28</span>) ~[apache-cassandra-<span class="number">2.1</span>.<span class="number">13</span><span class="class">.jar</span>:<span class="number">2.1</span>.<span class="number">13</span>]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.Executors</span><span class="variable">$RunnableAdapter</span>.<span class="function"><span class="title">call</span><span class="params">(Executors.java:<span class="number">471</span>)</span></span> [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  at java<span class="class">.util</span><span class="class">.concurrent</span><span class="class">.FutureTask</span><span class="class">.run</span>(FutureTask<span class="class">.java</span>:<span class="number">262</span>) [na:<span class="number">1.7</span>.<span class="number">0</span>_51]</span><br><span class="line">  ... <span class="number">3</span> common frames omitted</span><br><span class="line">WARN  [STREAM-IN-/<span class="number">127.0</span>.<span class="number">0.1</span>] <span class="number">2016</span>-<span class="number">06</span>-<span class="number">29</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">29</span>,<span class="number">500</span> CompressedStreamReader<span class="class">.java</span>:<span class="number">115</span> - [Stream ab888f50-<span class="number">3</span>d8f-<span class="number">11</span>e6-<span class="number">8</span>b24-dff3aadcb7ef] Error while reading partition <span class="function"><span class="title">DecoratedKey</span><span class="params">(-<span class="number">677751571849691691</span>, <span class="number">4435344444443536393133383636353144303931304334383341363032413842</span>)</span></span> from stream on ks=<span class="string">'md5'</span> and table=<span class="string">'md5_id'</span>./usr</span><br></pre></td></tr></table></figure>
<h2 id="jHiccup">jHiccup</h2><p><a href="http://hao.jobbole.com/jhiccup/" target="_blank" rel="external">http://hao.jobbole.com/jhiccup/</a></p>
<ol>
<li>给bin/cassandra启动命令，添加jHiccup：</li>
</ol>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/install/cassandra/bin/cassandra</span><br><span class="line">exec <span class="string">"/usr/install/jHiccup-2.0.6/jHiccup"</span> <span class="variable">$NUMACTL</span> <span class="string">"$JAVA"</span> <span class="variable">$JVM</span>_OPTS <span class="variable">$cassandra</span>_parms -cp <span class="string">"$CLASSPATH"</span> <span class="variable">$props</span> <span class="string">"$class"</span></span><br></pre></td></tr></table></figure>
<p>注意必须先停止Cassanra，然后再启动（废话，不停止，再次启动肯定有问题）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">HiccupMeter:</span> Failed to open log file.</span><br><span class="line">INFO  <span class="number">06</span>:<span class="number">02</span>:<span class="number">01</span> <span class="string">Classpath:</span> <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/../</span><span class="string">conf:</span>...<span class="regexp">/usr/</span>install<span class="regexp">/jHiccup-2.0.6/</span>jHiccup.<span class="string">jar:</span><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/../</span>lib/jamm-<span class="number">0.3</span><span class="number">.0</span>.jar</span><br><span class="line">INFO  <span class="number">06</span>:<span class="number">02</span>:<span class="number">01</span> JVM <span class="string">Arguments:</span> [-<span class="string">javaagent:</span><span class="regexp">/usr/</span>install<span class="regexp">/jHiccup-2.0.6/</span>jHiccup.jar=, -ea, -<span class="string">javaagent:</span><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/../</span>lib/jamm-<span class="number">0.3</span><span class="number">.0</span>.jar, -<span class="string">XX:</span></span><br><span class="line">WARN  <span class="number">06</span>:<span class="number">02</span>:<span class="number">01</span> Unable to lock JVM memory (ENOMEM). This can result <span class="keyword">in</span> part of the JVM being swapped out, especially with mmapped I/O enabled. Increase RLIMIT_MEMLOCK or run Cassandra <span class="keyword">as</span> root.</span><br><span class="line">WARN  <span class="number">06</span>:<span class="number">02</span>:<span class="number">01</span> JMX is not enabled to receive remote connections. Please see cassandra-env.sh <span class="keyword">for</span> more info.</span><br><span class="line">ERROR <span class="number">06</span>:<span class="number">02</span>:<span class="number">01</span> Error starting local jmx <span class="string">server:</span></span><br><span class="line">java.rmi.server.<span class="string">ExportException:</span> Port already <span class="keyword">in</span> <span class="string">use:</span> <span class="number">7199</span>; nested exception <span class="string">is:</span></span><br><span class="line">  java.net.<span class="string">BindException:</span> 地址已在使用</span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="annotation">@dp</span>0652 ~]$ export _JAVA_OPTIONS=<span class="string">'-javaagent:/usr/install/jHiccup-2.0.6/jHiccup.jar="-d 20000 -i 1000"'</span> &amp;&amp; sudo -u admin <span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin/cassandra</span><br><span class="line">[qihuang.zheng<span class="annotation">@dp</span>0652 ~]$ Picked up <span class="string">_JAVA_OPTIONS:</span> -<span class="string">javaagent:</span><span class="regexp">/usr/</span>install<span class="regexp">/jHiccup-2.0.6/</span>jHiccup.jar=<span class="string">"-d 20000 -i 1000"</span></span><br><span class="line"><span class="string">HiccupMeter:</span> Failed to open log file.</span><br><span class="line">INFO  <span class="number">06</span>:<span class="number">24</span>:<span class="number">09</span> JVM <span class="string">Arguments:</span> [-ea, -<span class="string">javaagent:</span><span class="regexp">/usr/</span>install<span class="regexp">/cassandra/</span>bin<span class="regexp">/../</span>lib<span class="regexp">/jamm-0.3.0.jar, -Dcassandra.storagedir=/</span>usr<span class="regexp">/install/</span>cassandra<span class="regexp">/bin/</span>..<span class="regexp">/data, -javaagent:/</span>usr<span class="regexp">/install/</span>jHiccup-<span class="number">2.0</span><span class="number">.6</span>/jHiccup.jar=-d <span class="number">20000</span> -i <span class="number">1000</span>]</span><br><span class="line">WARN  <span class="number">06</span>:<span class="number">24</span>:<span class="number">09</span> Unable to lock JVM memory (ENOMEM). This can result <span class="keyword">in</span> part of the JVM being swapped out, especially with mmapped I/O enabled. Increase RLIMIT_MEMLOCK or run Cassandra <span class="keyword">as</span> root.</span><br><span class="line">WARN  <span class="number">06</span>:<span class="number">24</span>:<span class="number">09</span> JMX is not enabled to receive remote connections. Please see cassandra-env.sh <span class="keyword">for</span> more info.</span><br><span class="line">ERROR <span class="number">06</span>:<span class="number">24</span>:<span class="number">09</span> Error starting local jmx <span class="string">server:</span></span><br><span class="line">java.rmi.server.<span class="string">ExportException:</span> Port already <span class="keyword">in</span> <span class="string">use:</span> <span class="number">7199</span>; nested exception <span class="string">is:</span></span><br><span class="line">  java.net.<span class="string">BindException:</span> 地址已在使用</span><br><span class="line"></span><br><span class="line">[qihuang.zheng<span class="annotation">@dp</span>0652 ~]$ jps -lm</span><br><span class="line">Picked up <span class="string">_JAVA_OPTIONS:</span> -<span class="string">javaagent:</span><span class="regexp">/usr/</span>install<span class="regexp">/jHiccup-2.0.6/</span>jHiccup.jar=<span class="string">"-d 20000 -i 1000"</span></span><br><span class="line"><span class="number">35054</span> sun.tools.jps.Jps -lm  </span><br><span class="line">[qihuang.zheng<span class="annotation">@dp</span>0652 ~]$ sudo -u admin jps -lm</span><br><span class="line">Picked up <span class="string">_JAVA_OPTIONS:</span> -<span class="string">javaagent:</span><span class="regexp">/usr/</span>install<span class="regexp">/jHiccup-2.0.6/</span>jHiccup.jar=<span class="string">"-d 20000 -i 1000"</span></span><br><span class="line"><span class="string">HiccupMeter:</span> Failed to open log file.</span><br></pre></td></tr></table></figure>
<p>正常启动Cassandra后，jHiccup.jar会作为agent：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="variable">@dp0652</span> ~]<span class="variable">$ </span>ps -ef|grep cassandra</span><br><span class="line">/usr/java/jdk1.<span class="number">7.0_51</span>/bin/java -<span class="symbol">javaagent:</span>/usr/install/jHiccup-<span class="number">2.0</span>.<span class="number">6</span>/jHiccup.jar= -ea -<span class="symbol">javaagent:</span>/usr/install/cassandra/bin/../<span class="class"><span class="keyword">lib</span>/<span class="title">jamm</span>-0.3.0.<span class="title">jar</span> -<span class="title">XX</span>:...</span></span><br></pre></td></tr></table></figure>
<p>正常生成的文件格式：hiccup.160505.1429.34233.hlog<br>会生成到pid指定的目录下，比如pid是cassandra的进程，则生成到/usr/install/cassandra下</p>
<p>但是在生产环境测试时，无法生产日志文件：</p>
<p>ps: the problem of jHiccup tool not working:  </p>
<p>We use jHiccup -p $pid to attach jHiccup to Cassandra Service,<br>but unfortunately, there are non hlog file generated which should be in Cassandra install home.<br>Last week I had demonstration to Daniel, and Daniel say he will checkout.<br>Here is our steps on production environment</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[admin@<span class="number">192</span>-<span class="number">168</span>-<span class="number">48</span>-<span class="number">47</span> ~]$ ps -ef|grep cassandra</span><br><span class="line">admin    <span class="number">27021</span>     <span class="number">1</span> <span class="number">10</span> Apr29 ?        <span class="number">1</span>-<span class="number">22</span>:<span class="number">50</span>:<span class="number">40</span> /usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51/bin/java ... org.apache.cassandra.service.CassandraDaemon</span><br><span class="line"></span><br><span class="line">[admin@<span class="number">192</span>-<span class="number">168</span>-<span class="number">48</span>-<span class="number">47</span> ~]$ /usr/install/jHiccup-<span class="number">2.0</span><span class="number">.6</span>/jHiccup -p <span class="number">27021</span> -v</span><br><span class="line">jHiccup version <span class="number">2.0</span><span class="number">.5</span></span><br><span class="line">jHiccup executing: /usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51/bin/java -cp /usr/java/jdk1<span class="number">.7</span><span class="number">.0</span>_51/lib/tools.jar:/usr/install/jHiccup-<span class="number">2.0</span><span class="number">.6</span>/jHiccup.jar </span><br><span class="line">org.jhiccup.HiccupMeterAttacher -v -j /usr/install/jHiccup-<span class="number">2.0</span><span class="number">.6</span>/jHiccup.jar -p <span class="number">27021</span></span><br><span class="line">Attaching to process <span class="number">27021</span> and launching jHiccup agent from jar <span class="number">27021</span> with args: -d <span class="number">0</span> -i <span class="number">5000</span> -s <span class="number">2</span> -r <span class="number">1.0</span> -v</span><br><span class="line"></span><br><span class="line">[admin@<span class="number">192</span>-<span class="number">168</span>-<span class="number">48</span>-<span class="number">47</span> ~]$ ll /usr/install/cassandra/</span><br><span class="line">drwxr-xr-x. <span class="number">2</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">25</span> <span class="number">11</span>:<span class="number">08</span> bin</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin <span class="number">263216</span> <span class="number">1</span>月  <span class="number">26</span> <span class="number">22</span>:<span class="number">21</span> CHANGES.txt</span><br><span class="line">drwxr-xr-x. <span class="number">3</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">29</span> <span class="number">10</span>:<span class="number">35</span> conf</span><br><span class="line">drwxr-xr-x. <span class="number">2</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">25</span> <span class="number">11</span>:<span class="number">08</span> interface</span><br><span class="line">drwxr-xr-x. <span class="number">3</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">25</span> <span class="number">11</span>:<span class="number">08</span> javadoc</span><br><span class="line">drwxr-xr-x. <span class="number">3</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">25</span> <span class="number">11</span>:<span class="number">08</span> lib</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">11609</span> <span class="number">1</span>月  <span class="number">26</span> <span class="number">22</span>:<span class="number">21</span> LICENSE.txt</span><br><span class="line">drwxr-xr-x. <span class="number">2</span> admin admin   <span class="number">4096</span> <span class="number">5</span>月  <span class="number">13</span> <span class="number">12</span>:<span class="number">43</span> logs</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin  <span class="number">67603</span> <span class="number">1</span>月  <span class="number">26</span> <span class="number">22</span>:<span class="number">21</span> NEWS.txt</span><br><span class="line">-rw-r--r--. <span class="number">1</span> admin admin   <span class="number">2117</span> <span class="number">1</span>月  <span class="number">26</span> <span class="number">22</span>:<span class="number">21</span> NOTICE.txt</span><br><span class="line">drwxr-xr-x. <span class="number">3</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">25</span> <span class="number">11</span>:<span class="number">08</span> pylib</span><br><span class="line">drwxr-xr-x. <span class="number">4</span> admin admin   <span class="number">4096</span> <span class="number">4</span>月  <span class="number">25</span> <span class="number">11</span>:<span class="number">08</span> tools</span><br></pre></td></tr></table></figure>
<p>原因是启动Cassandra用普通用户，然后通过sudo -u admin方式启动，但是/home/admin用户却无法访问普通用户的权限。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[admin@fp-cass048162 ~]$ pwdx <span class="number">19649</span></span><br><span class="line"><span class="number">19649</span>: /home/qihuang.zheng</span><br><span class="line"></span><br><span class="line">[admin@fp-cass048162 ~]$ lsof -p <span class="number">19649</span> | grep cwd</span><br><span class="line">java    <span class="number">19649</span> admin  cwd    <span class="type">DIR</span>               <span class="number">8</span>,<span class="number">17</span>         <span class="number">4096</span>  <span class="number">490733569</span> /home/qihuang.zheng</span><br><span class="line"></span><br><span class="line">[admin@fp-cass048162 ~]$ readlink -e /<span class="keyword">proc</span>/<span class="number">19649</span>/cwd</span><br></pre></td></tr></table></figure>
<p>解决方法：停止Cassandra，用admin用户登陆， 用admin用户启动，不需要sudo -u admin。<br>最后会生成文件到/home/admin下。正常的日志如下：  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># Executing: HiccupMeter -d <span class="number">0</span> -i <span class="number">5000</span> -s <span class="number">2</span> -r <span class="number">1.0</span> -v</span></span><br><span class="line"><span class="preprocessor">#[Logged with jHiccup version <span class="number">2.0</span><span class="number">.6</span>]</span></span><br><span class="line"><span class="preprocessor">#[Histogram log format version <span class="number">1.1</span>]</span></span><br><span class="line"><span class="preprocessor">#[StartTime: <span class="number">1463708353.327</span> (seconds since epoch), Fri May <span class="number">20</span> <span class="number">09</span>:<span class="number">39</span>:<span class="number">13</span> CST <span class="number">2016</span>]</span></span><br><span class="line"><span class="string">"StartTimestamp"</span>,<span class="string">"Interval_Length"</span>,<span class="string">"Interval_Max"</span>,<span class="string">"Interval_Compressed_Histogram"</span></span><br><span class="line"><span class="number">1166.248</span>,<span class="number">5.002</span>,<span class="number">570.425</span>,HISTIgAAAKp42pNpmazIwMApwAABTBDKT4GBgdnNYMcCBvsPUJlfDO8Yt3GfY1jCwM3AzsDIwAIUYwRCJjCJCZiwimITIx4w0kAlpW4amTYzUmAqI0UuGiibGfHqYCTaPEaK4oVxgGTR5RkpkB08qkkxi5EompEGqgfOTEweAjNiiGDDxKkaCiqxQyacMuSqpL6J1LGbCQyZoTQyxCZGvErq66aNe1igkBVMMgMAUHALXQ==</span><br><span class="line"><span class="number">1171.250</span>,<span class="number">5.000</span>,<span class="number">42.729</span>,HISTIgAAAHt42pNpmazIwMDqxgABTBDKT4GBgdnNYMcCBvsPUJk/jDwMf/huM8gzcDOwglWyMjDC1EMBIwN2gEscP2AkWjcjmSaT77aRaTP++GWkoe6BsxlTDyMBmxjJlCVs9mCxmRCfiWaqGQnELCMJsqSpZsRKM+KVxVAFADZ8CIQ=</span><br><span class="line"><span class="number">1176.250</span>,<span class="number">5.000</span>,<span class="number">406.847</span>,HISTIgAAAJt42pNpmazIwMDRwgABTBDKT4GBgdnNYMcCBvsPUJlnDJ8YhXjDGOoYBBnYgOpYGBiBJEg9IxgzMjCDSUYG8gAjDeQoN2PgbGagui5KzWCksbsYB0gv6boZaSY7VMxmJKCXdqoHymZGkmhqqqKFmeTYzIiCGTFEcOGBU0lN83BBJjxy5KijhUpqmMgEhsxQGhUyUyBGgm4AXGIJ5w==</span><br><span class="line"><span class="number">1181.250</span>,<span class="number">5.000</span>,<span class="number">125.829</span>,HISTIgAAAG942pNpmazIwMD2gAECmCCUnwIDA7ObwY4FDPYfoDK/Gf4wcvFlMnQzcABVsTEwAiEDFEPY2AAu8cEFGEdtHgRmMg4ZmxlpJjtUzGYkoJd2qgfKZkaSaGqqooWZ5NjMiIIZMURw4YFTSYJ5AGq7CUM=</span><br><span class="line"><span class="number">1186.250</span>,<span class="number">5.000</span>,<span class="number">444.596</span>,HISTIgAAAIR42pNpmazIwMCxggECmCCUnwIDA7ObwY4FDPYfoDIXGVkZvvGaMBxm4GBgAapjBGJmoDgjFA9mwEgnPSPNZka6u3BgbWakmSwtzaa2zYwk8SmRHTyqGUmi6a+K9mYyEsSMRKkaKiqxicAgEwoPH2SisrqBsxtU2zNhQErEaKIbAEcEChs=</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/10/15/Cassandra-Operation/">Cassandra操作</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年10月15日 - 00时00分</p>
  <p><span>最后更新:</span>2017年05月25日 - 12时40分</p>
  <p>
    <span>原始链接:</span><a href="/2015/10/15/Cassandra-Operation/" title="Cassandra操作">http://github.com/zqhxuyuan/2015/10/15/Cassandra-Operation/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/10/15/Cassandra-Operation/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/10/16/Cassandra-query/">
        Cassandra查询
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/10/15/Cassandra-Daily/">
        Cassandra日常运维
      </a>
    </div>
  
</nav>

  
  
    <div class ="post-donate">
	<br/>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   这么长的文章我都读完了，看起来作者写的很辛苦哇！给作者赏杯咖啡喝，支持作者继续写作😁
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<img src="/img/zhifubao.png" alt="支付宝打赏"> 
		<img src="/img/weixin.png" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#优雅关闭节点"><span class="toc-number">1.</span> <span class="toc-text">优雅关闭节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不同集群数据同步"><span class="toc-number">2.</span> <span class="toc-text">不同集群数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#增量备份"><span class="toc-number">2.1.</span> <span class="toc-text">增量备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备工作：新集群搭建和建表"><span class="toc-number">2.2.</span> <span class="toc-text">准备工作：新集群搭建和建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开始：先测试一张表的迁移"><span class="toc-number">2.3.</span> <span class="toc-text">开始：先测试一张表的迁移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#整个集群做一次完整的快照迁移"><span class="toc-number">2.4.</span> <span class="toc-text">整个集群做一次完整的快照迁移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#增量备份（需要多次执行）"><span class="toc-number">2.5.</span> <span class="toc-text">增量备份（需要多次执行）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#机房迁移"><span class="toc-number">2.6.</span> <span class="toc-text">机房迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接从当前集群同步到上海集群"><span class="toc-number">2.6.1.</span> <span class="toc-text">直接从当前集群同步到上海集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#新集群安装"><span class="toc-number">2.6.2.</span> <span class="toc-text">新集群安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-_表结构"><span class="toc-number">2.6.3.</span> <span class="toc-text">1. 表结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-_数据迁移"><span class="toc-number">2.6.4.</span> <span class="toc-text">2. 数据迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-_增量数据迁移"><span class="toc-number">2.6.5.</span> <span class="toc-text">3. 增量数据迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-_数据验证"><span class="toc-number">2.6.6.</span> <span class="toc-text">4. 数据验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodetool工具"><span class="toc-number">3.</span> <span class="toc-text">nodetool工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群状态:_nodetool_decribecluster"><span class="toc-number">3.1.</span> <span class="toc-text">集群状态: nodetool decribecluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除节点:_removenode"><span class="toc-number">3.2.</span> <span class="toc-text">删除节点: removenode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#替换节点:_replace_address"><span class="toc-number">3.3.</span> <span class="toc-text">替换节点: replace_address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重新加入"><span class="toc-number">3.4.</span> <span class="toc-text">重新加入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#网络状态netstats:_显示一个节点的Active_Stream"><span class="toc-number">3.5.</span> <span class="toc-text">网络状态netstats: 显示一个节点的Active Stream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#节点信息:_nodetool_info"><span class="toc-number">3.6.</span> <span class="toc-text">节点信息: nodetool info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gossip信息:_nodetool_gossipinfo"><span class="toc-number">3.7.</span> <span class="toc-text">Gossip信息: nodetool gossipinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#表相关的信息:nodetool_cfstats_forseti-velocity"><span class="toc-number">3.8.</span> <span class="toc-text">表相关的信息:nodetool cfstats forseti.velocity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compactionhistory"><span class="toc-number">3.9.</span> <span class="toc-text">compactionhistory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#节点sstable数量异常"><span class="toc-number">3.10.</span> <span class="toc-text">节点sstable数量异常</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tpstats"><span class="toc-number">4.</span> <span class="toc-text">tpstats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sstable_writer"><span class="toc-number">5.</span> <span class="toc-text">sstable writer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#文件数过多"><span class="toc-number">5.1.</span> <span class="toc-text">文件数过多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#导入数据后，用refresh"><span class="toc-number">5.2.</span> <span class="toc-text">导入数据后，用refresh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过增大内存来增大sstable大小（内存不足）"><span class="toc-number">5.3.</span> <span class="toc-text">通过增大内存来增大sstable大小（内存不足）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分表？"><span class="toc-number">5.4.</span> <span class="toc-text">分表？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sstableloader"><span class="toc-number">6.</span> <span class="toc-text">sstableloader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jHiccup"><span class="toc-number">7.</span> <span class="toc-text">jHiccup</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2015/10/15/Cassandra-Operation/" data-title="Cassandra操作" data-url="http://github.com/zqhxuyuan/2015/10/15/Cassandra-Operation/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2015/10/16/Cassandra-query/" title="上一篇: Cassandra查询">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/10/15/Cassandra-Daily/" title="下一篇: Cassandra日常运维">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>