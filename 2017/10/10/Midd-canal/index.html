<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深入解析中间件之-Canal | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="canal: 阿里巴巴mysql数据库binlog的增量订阅&amp;amp;消费组件">
<meta property="og:type" content="article">
<meta property="og:title" content="深入解析中间件之-Canal">
<meta property="og:url" content="http://github.com/zqhxuyuan/2017/10/10/Midd-canal/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="canal: 阿里巴巴mysql数据库binlog的增量订阅&amp;amp;消费组件">
<meta property="og:image" content="http://img.blog.csdn.net/20160914112042547">
<meta property="og:image" content="https://camo.githubusercontent.com/db1debcfa50f4ebea1f56a1fa0e18a4e960cafcc/687474703a2f2f646c2e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303038302f333239372f39643765643133652d366138362d333836642d393266342d3835323233386334373562662e6a7067">
<meta property="og:image" content="http://img.blog.csdn.net/20171011202259253">
<meta property="og:image" content="http://img.blog.csdn.net/20171011211529169">
<meta property="og:image" content="http://img.blog.csdn.net/20171011225116791">
<meta property="og:image" content="https://camo.githubusercontent.com/031db3aa27461d13faa2dea479ef639f93386a00/687474703a2f2f646c2e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303038302f333134332f37393531633136392d663764662d336362332d616562622d6439323466353733313163622e6a7067">
<meta property="og:image" content="http://img.blog.csdn.net/20171011234800632">
<meta property="og:image" content="https://camo.githubusercontent.com/c8f1d98268a307821273e94e7eefcd29a26f9b78/687474703a2f2f646c2e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303038302f333330332f64333230326332362d653935342d333563302d613331392d3537363034313032633537642e6a7067">
<meta property="og:image" content="http://img.blog.csdn.net/20171012184033228">
<meta property="og:image" content="https://camo.githubusercontent.com/8cc684cf92e22d738d57b002c356afba96bcc4f5/687474703a2f2f646c322e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303039302f363435332f39326233343335302d323566632d333162332d626361362d3865326131653763356532322e6a7067">
<meta property="og:image" content="http://img.blog.csdn.net/20171012230738279">
<meta property="og:image" content="http://img.blog.csdn.net/20171012234337736">
<meta property="og:image" content="http://img.blog.csdn.net/20171011211529169">
<meta property="og:updated_time" content="2017-11-22T04:18:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入解析中间件之-Canal">
<meta name="twitter:description" content="canal: 阿里巴巴mysql数据库binlog的增量订阅&amp;amp;消费组件">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/akka/" style="font-size: 10px;">akka</a> <a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.75px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.25px;">drill</a> <a href="/tags/druid/" style="font-size: 13.75px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 13.75px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.25px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 11.25px;">midd</a> <a href="/tags/ops/" style="font-size: 13.75px;">ops</a> <a href="/tags/redis/" style="font-size: 11.25px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.75px;">scala</a> <a href="/tags/spark/" style="font-size: 17.5px;">spark</a> <a href="/tags/storm/" style="font-size: 17.5px;">storm</a> <a href="/tags/timeseries/" style="font-size: 12.5px;">timeseries</a> <a href="/tags/work/" style="font-size: 13.75px;">work</a> <a href="/tags/流处理/" style="font-size: 11.25px;">流处理</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Midd-canal" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/10/10/Midd-canal/" class="article-date">
  	<time datetime="2017-10-09T16:00:00.000Z" itemprop="datePublished">2017-10-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深入解析中间件之-Canal
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/midd/">midd</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/midd/">midd</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><a href="https://github.com/alibaba/canal">canal</a>: 阿里巴巴mysql数据库binlog的增量订阅&amp;消费组件<br><a id="more"></a></p>
<h2 id="MySQL_binlog">MySQL binlog</h2><h3 id="MySQL主从复制">MySQL主从复制</h3><p>mysql服务端修改配置并重启</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog-format=ROW</span><br><span class="line">server_id=1</span><br><span class="line"></span><br><span class="line">$ mysql -uroot</span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">USER</span> canal <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'canal'</span>;</span>  </span><br><span class="line"><span class="operator"><span class="keyword">GRANT</span> ALL <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'canal'</span>@<span class="string">'%'</span> ;</span></span><br><span class="line"><span class="operator"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span></span><br><span class="line"></span><br><span class="line">$ sudo service mysqld <span class="operator"><span class="keyword">start</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>问题：创建canal用户的目的是什么？直接使用现有的用户名可以吗，比如root。<br>答案：有些用户没有REPLICATION SLAVE, REPLICATION CLIENT的权限，用这些用户连接canal时，无法获取到binlog。<br>这里的canal用户授权了全部权限，所以客户端可以从canal中获取binlog。</p>
</blockquote>
<p>明确两个概念：canal server连接mysql，客户端连接canal server。</p>
<ul>
<li>canal指的是canal server，它会读取mysql的binlog，解析后存储起来</li>
<li>客户端指的是消费canal server的binlog</li>
</ul>
<p>本机连接服务端，验证binlog的格式是ROW</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -h192.168.6.52 -ucanal -pcanal</span><br><span class="line"><span class="header">mysql&gt; show variables like '%binlog_format%';</span><br><span class="line">+---------------+-------+</span></span><br><span class="line"><span class="header">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span></span><br><span class="line"><span class="header">| binlog_format | ROW   |</span><br><span class="line">+---------------+-------+</span></span><br></pre></td></tr></table></figure>
<p>mysql主从复制的原理：</p>
<ul>
<li>master将改变记录到二进制日志(binary log)中；</li>
<li>slave将master的binary log events拷贝到它的中继日志(relay log)；</li>
<li>slave重做中继日志中的事件，将改变反映它自己的数据。</li>
</ul>
<p><img src="http://img.blog.csdn.net/20160914112042547" alt="mysql replication"></p>
<h3 id="binlog">binlog</h3><p>在启动canal之前，先来了解下什么是mysql的binlog:</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binlog events;</span><br><span class="line">| Log_name         | Pos   | Event_type  | Server_id | End_log_pos | Info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |</span><br><span class="line">+<span class="comment">------------------+-------+-------------+-----------+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| mysql-bin.<span class="number">000001</span> |     <span class="number">4</span> | Format_desc |         <span class="number">1</span> |         <span class="number">106</span> | Server ver: <span class="number">5.1</span>.<span class="number">73</span>-log, Binlog ver: <span class="number">4</span>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |</span><br><span class="line">| mysql-bin.<span class="number">000001</span> |   <span class="number">106</span> | Query       |         <span class="number">1</span> |        <span class="number">1864</span> | <span class="keyword">use</span> `mysql`; CREATE TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> EXISTS db (   Host char(<span class="number">60</span>) binary <span class="keyword">DEFAULT</span> '' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Db char(<span class="number">64</span>) binary <span class="keyword">DEFAULT</span> '' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, User char(<span class="number">16</span>) binary <span class="keyword">DEFAULT</span> '' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Select_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Insert_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Update_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Delete_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Drop_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Grant_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, References_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Index_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Alter_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_tmp_table_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Lock_tables_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_view_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Show_view_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_routine_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Alter_routine_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Execute_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Event_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Trigger_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, PRIMARY KEY Host (Host,Db,User), KEY User (User) ) engine=MyISAM <span class="typename">CHARACTER</span> SET utf8 COLLATE utf8_bin comment=<span class="attribute">'Database</span> privileges' |</span><br><span class="line">| mysql-bin.<span class="number">000001</span> |  <span class="number">1864</span> | Query       |         <span class="number">1</span> |        <span class="number">3518</span> | <span class="keyword">use</span> `mysql`; CREATE TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> EXISTS host (  Host char(<span class="number">60</span>) binary <span class="keyword">DEFAULT</span> '' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Db char(<span class="number">64</span>) binary <span class="keyword">DEFAULT</span> '' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Select_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Insert_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Update_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Delete_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Drop_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Grant_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, References_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Index_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Alter_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_tmp_table_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Lock_tables_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_view_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Show_view_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Create_routine_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Alter_routine_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Execute_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, Trigger_priv enum(<span class="attribute">'N</span>',<span class="attribute">'Y</span>') COLLATE utf8_general_ci <span class="keyword">DEFAULT</span> <span class="attribute">'N</span>' <span class="keyword">NOT</span> <span class="keyword">NULL</span>, PRIMARY KEY Host (Host,Db) ) engine=MyISAM <span class="typename">CHARACTER</span> SET utf8 COLLATE utf8_bin comment=<span class="attribute">'Host</span> privileges;  Merged <span class="keyword">with</span> database privileges' |</span><br></pre></td></tr></table></figure>
<p>mysql数据文件下会生成mysql-bin.xxx的binlog文件，以及索引文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 canal]$ ll /var/lib/mysql/</span><br><span class="line">总用量 <span class="number">26228</span></span><br><span class="line">drwx------ <span class="number">2</span> mysql mysql     <span class="number">4096</span> <span class="number">10</span>月 <span class="number">11</span> <span class="number">14</span>:<span class="number">05</span> canal_test</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql <span class="number">10485760</span> <span class="number">9</span>月  <span class="number">30</span> <span class="number">22</span>:<span class="number">12</span> ibdata1</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql  <span class="number">5242880</span> <span class="number">10</span>月 <span class="number">11</span> <span class="number">09</span>:<span class="number">57</span> ib_logfile0</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql  <span class="number">5242880</span> <span class="number">10</span>月 <span class="number">11</span> <span class="number">09</span>:<span class="number">57</span> ib_logfile1</span><br><span class="line">drwx------ <span class="number">2</span> mysql mysql     <span class="number">4096</span> <span class="number">8</span>月   <span class="number">2</span> <span class="number">11</span>:<span class="number">01</span> mysql</span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql    <span class="number">18451</span> <span class="number">8</span>月   <span class="number">2</span> <span class="number">11</span>:<span class="number">01</span> mysql-bin<span class="number">.000001</span></span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql   <span class="number">929226</span> <span class="number">8</span>月   <span class="number">2</span> <span class="number">11</span>:<span class="number">01</span> mysql-bin<span class="number">.000002</span></span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql  <span class="number">4890698</span> <span class="number">9</span>月  <span class="number">30</span> <span class="number">22</span>:<span class="number">12</span> mysql-bin<span class="number">.000003</span></span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql      <span class="number">897</span> <span class="number">10</span>月 <span class="number">11</span> <span class="number">14</span>:<span class="number">06</span> mysql-bin<span class="number">.000004</span></span><br><span class="line">-rw-rw---- <span class="number">1</span> mysql mysql       <span class="number">76</span> <span class="number">10</span>月 <span class="number">11</span> <span class="number">09</span>:<span class="number">57</span> mysql-bin.index</span><br><span class="line">srwxrwxrwx <span class="number">1</span> mysql mysql        <span class="number">0</span> <span class="number">10</span>月 <span class="number">11</span> <span class="number">09</span>:<span class="number">57</span> mysql.sock</span><br></pre></td></tr></table></figure>
<p>针对mysql的操作都会有二进制的事件记录到binlog文件中。下面的一些操作包括创建用户，授权，创建数据库，创建表，插入一条记录。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 canal]$ sudo strings /var/lib/mysql/mysql-bin.000004</span><br><span class="line">5.1.73-log</span><br><span class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">USER</span> canal <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'canal'</span></span><br><span class="line">root    localhost</span><br><span class="line"><span class="keyword">GRANT</span> ALL <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'canal'</span>@<span class="string">'%'</span></span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span></span><br><span class="line">canal_test</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> canal_test    ===》创建数据库</span><br><span class="line">canal_test</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span> (   uid <span class="built_in">int</span> (<span class="number">4</span>) primary <span class="keyword">key</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment,   <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>)  ==》创建表</span><br><span class="line">canal_test</span><br><span class="line"><span class="keyword">BEGIN</span>     ==》插入记录，这里有事务。但是没有把具体的语句打印出来</span><br><span class="line">canal_test</span><br><span class="line"><span class="keyword">test</span></span><br><span class="line">canal_test</span><br><span class="line"><span class="keyword">COMMIT</span></span></span><br></pre></td></tr></table></figure>
<h2 id="Canal_QuickStart">Canal QuickStart</h2><h3 id="canal_&amp;_config">canal &amp; config</h3><p>部署canal server到6.52，并启动。查看canal的日志：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 canal]$ cat logs/canal/canal.<span class="built_in">log</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.076</span> [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="preprocessor">## start the canal server.</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.151</span> [main] INFO  com.alibaba.otter.canal.deployer.CanalController - <span class="preprocessor">## start the canal server[<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11111</span>]</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.644</span> [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - <span class="preprocessor">## the canal server is running now ......</span></span><br></pre></td></tr></table></figure>
<p>查看instance的日志：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 canal]$ cat logs/example/example<span class="class">.log</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.435</span> [main] INFO  c<span class="class">.a</span><span class="class">.o</span><span class="class">.c</span><span class="class">.i</span><span class="class">.spring</span><span class="class">.support</span><span class="class">.PropertyPlaceholderConfigurer</span> - Loading properties file from class path resource [canal.properties]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.444</span> [main] INFO  c<span class="class">.a</span><span class="class">.o</span><span class="class">.c</span><span class="class">.i</span><span class="class">.spring</span><span class="class">.support</span><span class="class">.PropertyPlaceholderConfigurer</span> - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.587</span> [main] INFO  c<span class="class">.a</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.instance</span><span class="class">.spring</span><span class="class">.CanalInstanceWithSpring</span> - start CannalInstance <span class="keyword">for</span> <span class="number">1</span>-example</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.599</span> [main] INFO  c<span class="class">.a</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.instance</span><span class="class">.core</span><span class="class">.AbstractCanalInstance</span> - start successful....</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">31</span>:<span class="number">52.679</span> [destination = example , <span class="tag">address</span> = /<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span> , EventParser] WARN  c<span class="class">.a</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.parse</span><span class="class">.inbound</span><span class="class">.mysql</span><span class="class">.MysqlEventParser</span> - prepare to find start <span class="attribute">position</span> just show master status</span><br></pre></td></tr></table></figure>
<p>canal server的conf下有几个配置文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  canal<span class="class">.deployer-1</span>.<span class="number">0.24</span> tree conf</span><br><span class="line">conf</span><br><span class="line">├── canal<span class="class">.properties</span></span><br><span class="line">├── example</span><br><span class="line">│   └── instance<span class="class">.properties</span></span><br><span class="line">├── logback<span class="class">.xml</span></span><br><span class="line">└── spring</span><br><span class="line">    ├── default-instance<span class="class">.xml</span></span><br><span class="line">    ├── file-instance<span class="class">.xml</span></span><br><span class="line">    ├── group-instance<span class="class">.xml</span></span><br><span class="line">    ├── local-instance<span class="class">.xml</span></span><br><span class="line">    └── memory-instance.xml</span><br></pre></td></tr></table></figure>
<p>先来看<code>canal.properties</code>的<strong>common</strong>属性前四个配置项：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">canal.id= <span class="number">1</span></span><br><span class="line">canal.ip=</span><br><span class="line">canal.port= <span class="number">11111</span></span><br><span class="line">canal.zkServers=</span><br></pre></td></tr></table></figure>
<p>canal.id是canal的编号，在集群环境下，不同canal的id不同，注意它和mysql的server_id不同。<br>ip这里不指定，默认为本机，比如上面是192.168.6.52，端口号是11111。zk用于canal cluster。</p>
<p>再看下<code>canal.properties</code>下<strong>destinations</strong>相关的配置：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#</span></span><br><span class="line"><span class="comment">######</span><span class="comment">###       destinations        ###</span><span class="comment">######</span><span class="comment">#### </span><br><span class="line">###</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">####</span><br><span class="line">canal.destinations = example</span><br><span class="line">canal.conf.dir = ../conf</span><br><span class="line">canal.auto.scan = true</span><br><span class="line">canal.auto.scan.interval = 5</span><br><span class="line"></span><br><span class="line">canal.instance.global.mode = spring </span><br><span class="line">canal.instance.global.lazy = false</span><br><span class="line">canal.instance.global.spring.xml = classpath:spring/file-instance.xml</span></span><br></pre></td></tr></table></figure>
<p>这里的canal.destinations = example可以设置多个，比如example1,example2，<br>则需要创建对应的两个文件夹，并且每个文件夹下都有一个instance.properties文件。</p>
<p>全局的canal实例管理用spring，这里的<code>file-instance.xml</code>最终会实例化所有的destinations instances:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean class=<span class="string">"com.alibaba.otter.canal.instance.spring.support.PropertyPlaceholderConfigurer"</span> lazy-init=<span class="string">"false"</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">"ignoreResourceNotFound"</span> value=<span class="string">"true"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"systemPropertiesModeName"</span> value=<span class="string">"SYSTEM_PROPERTIES_MODE_OVERRIDE"</span>/&gt;&lt;!-- 允许system覆盖 --&gt;</span><br><span class="line">    &lt;property name=<span class="string">"locationNames"</span>&gt;</span><br><span class="line">        &lt;list&gt;</span><br><span class="line">            &lt;value&gt;classpath:canal.properties&lt;/value&gt;</span><br><span class="line">            &lt;value&gt;classpath:$&#123;canal.instance.destination:&#125;/instance.properties&lt;/value&gt;</span><br><span class="line">        &lt;/list&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">&lt;bean id=<span class="string">"instance"</span> class=<span class="string">"com.alibaba.otter.canal.instance.spring.CanalInstanceWithSpring"</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">"destination"</span> value=<span class="string">"$&#123;canal.instance.destination&#125;"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"eventParser"</span>&gt;&lt;<span class="keyword">ref</span> local=<span class="string">"eventParser"</span> /&gt;&lt;/property&gt;</span><br><span class="line">    &lt;property name=<span class="string">"eventSink"</span>&gt;&lt;<span class="keyword">ref</span> local=<span class="string">"eventSink"</span> /&gt;&lt;/property&gt;</span><br><span class="line">    &lt;property name=<span class="string">"eventStore"</span>&gt;&lt;<span class="keyword">ref</span> local=<span class="string">"eventStore"</span> /&gt;&lt;/property&gt;</span><br><span class="line">    &lt;property name=<span class="string">"metaManager"</span>&gt;&lt;<span class="keyword">ref</span> local=<span class="string">"metaManager"</span> /&gt;&lt;/property&gt;</span><br><span class="line">    &lt;property name=<span class="string">"alarmHandler"</span>&gt;&lt;<span class="keyword">ref</span> local=<span class="string">"alarmHandler"</span> /&gt;&lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>比如<code>canal.instance.destination</code>等于example，就会加载<code>example/instance.properties</code>配置文件</p>
<p>example下instance.properties配置文件不需要修改。一个canal server可以运行多个canal instance。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#</span></span><br><span class="line"><span class="comment">## mysql serverId，这里的slaveId不能和myql集群中已有的server_id一样</span></span><br><span class="line">canal.instance.mysql.slaveId = <span class="number">1234</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># position info 这里连接的是mysql master的地址。</span></span><br><span class="line">canal.instance.master.address = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span></span><br><span class="line">canal.instance.master.journal.name = </span><br><span class="line">canal.instance.master.position = </span><br><span class="line">canal.instance.master.timestamp = </span><br><span class="line"></span><br><span class="line"><span class="comment">#canal.instance.standby.address = </span></span><br><span class="line"><span class="comment">#canal.instance.standby.journal.name =</span></span><br><span class="line"><span class="comment">#canal.instance.standby.position = </span></span><br><span class="line"><span class="comment">#canal.instance.standby.timestamp = </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># username/password</span></span><br><span class="line">canal.instance.dbUsername = canal</span><br><span class="line">canal.instance.dbPassword = canal</span><br><span class="line">canal.instance.defaultDatabaseName =</span><br><span class="line">canal.instance.connectionCharset = UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line">canal.instance.filter.regex = .*\\..*</span><br><span class="line">canal.instance.filter.black.regex =  </span><br><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="simple_client">simple client</h3><p>在mysql上创建数据库，创建表，插入一条记录，再修改记录。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">database</span> canal_test;</span></span><br><span class="line"><span class="operator"><span class="keyword">use</span> canal_test;</span></span><br><span class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span> (   uid <span class="built_in">int</span> (<span class="number">4</span>) primary <span class="keyword">key</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment,   <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>);</span></span><br><span class="line"><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> (<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'10'</span>);</span></span><br></pre></td></tr></table></figure>
<p>修改<a href="https://github.com/alibaba/canal/blob/master/example/src/main/java/com/alibaba/otter/canal/example/SimpleCanalClientTest.java">客户端测试例子</a>的连接信息。其中example对应了canal实例的名称。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SimpleCanalClientTest</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractCanalClientTest</span> &#123;</span></span><br><span class="line">    public static void main(<span class="type">String</span> args[]) &#123;</span><br><span class="line">        <span class="type">String</span> destination = <span class="string">"example"</span>;</span><br><span class="line">        <span class="type">CanalConnector</span> connector = <span class="type">CanalConnectors</span>.newSingleConnector(</span><br><span class="line">            <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"192.168.6.52"</span>, <span class="number">11111</span>), destination, <span class="string">"canal"</span>, <span class="string">"canal"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果连接有错误，客户端测试例子会立即结束，打印## stop the canal client。正常的话，终端不会退出，会一直运行。</p>
</blockquote>
<p>SimpleCanalClientTest控制台的结果如下：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [1] ,count : [2] , memsize : [263] , Time : 2017-10-11 14:06:06</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:396:1507701897000(2017-10-11 14:04:57)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:491:1507701904000(2017-10-11 14:05:04)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:396] , name[canal_test,] , eventType : QUERY , executeTime : 1507701897000 , delay : 69710ms</span><br><span class="line"> sql ----&gt; create database canal_test</span><br><span class="line"></span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:491] , name[canal_test,test] , eventType : CREATE , executeTime : 1507701904000 , delay : 62723ms</span><br><span class="line"> sql ----&gt; create table test (   uid int (4) primary key not null auto_increment,   name varchar(10) not null)</span><br></pre></td></tr></table></figure>
<p>插入一条记录：（其中uid和name的update都等于true）</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [2] ,count : [3] , memsize : [186] , Time : 2017-10-11 14:06:32</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:659:1507701989000(2017-10-11 14:06:29)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:822:1507701989000(2017-10-11 14:06:29)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">================&gt; binlog[mysql-bin.000004:659] , executeTime : 1507701989000 , delay : 3142ms</span><br><span class="line"> BEGIN ----&gt; Thread id: 11</span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:785] , name[canal_test,test] , eventType : INSERT , executeTime : 1507701989000 , delay : 3154ms</span><br><span class="line">uid : 1    type=int(4)    update=true</span><br><span class="line">name : 10    type=varchar(10)    update=true</span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:822] , executeTime : 1507701989000 , delay : 3179ms</span><br></pre></td></tr></table></figure>
<p>修改记录：（其中name的update等于true）</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [3] ,count : [3] , memsize : [202] , Time : 2017-10-11 14:49:11</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:897:1507704547000(2017-10-11 14:49:07)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:1076:1507704547000(2017-10-11 14:49:07)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">================&gt; binlog[mysql-bin.000004:897] , executeTime : 1507704547000 , delay : 4048ms</span><br><span class="line"> BEGIN ----&gt; Thread id: 13</span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:1023] , name[canal_test,test] , eventType : UPDATE , executeTime : 1507704547000 , delay : 4059ms</span><br><span class="line">uid : 1    type=int(4)</span><br><span class="line">name : zqhxuyuan    type=varchar(10)    update=true</span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:1076] , executeTime : 1507704547000 , delay : 4096ms</span><br></pre></td></tr></table></figure>
<p>canal安装包下的example instance下除了example.log外，还有一个<code>meta.log</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 canal]$ cat logs/example/meta.<span class="built_in">log</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">03.728</span> - clientId:<span class="number">1001</span> cursor:[mysql-bin<span class="number">.000004</span>,<span class="number">396</span>,<span class="number">1507701897000</span>] address[/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">04.589</span> - clientId:<span class="number">1001</span> cursor:[mysql-bin<span class="number">.000004</span>,<span class="number">491</span>,<span class="number">1507701904000</span>] address[localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">14</span>:<span class="number">06</span>:<span class="number">29.589</span> - clientId:<span class="number">1001</span> cursor:[mysql-bin<span class="number">.000004</span>,<span class="number">822</span>,<span class="number">1507701989000</span>] address[localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">11</span> <span class="number">14</span>:<span class="number">49</span>:<span class="number">08.589</span> - clientId:<span class="number">1001</span> cursor:[mysql-bin<span class="number">.000004</span>,<span class="number">1076</span>,<span class="number">1507704547000</span>] address[localhost/<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>]</span><br></pre></td></tr></table></figure>
<h2 id="Cannal_Internal_Overview">Cannal Internal Overview</h2><h3 id="canal_client_&amp;_server">canal client &amp; server</h3><p><a href="https://github.com/alibaba/canal/blob/master/example/src/main/java/com/alibaba/otter/canal/example/AbstractCanalClientTest.java">canal client</a>与canal server之间是C/S模式的通信，客户端采用NIO，服务端采用Netty。<br>canal server启动后，如果没有canal client，那么canal server不会去mysql拉取binlog。<br>即Canal客户端主动发起拉取请求，服务端才会模拟一个MySQL Slave节点去主节点拉取binlog。<br>通常Canal客户端是一个死循环，这样客户端一直调用get方法，服务端也就会一直拉取binlog。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> AbstractCanalClientTest &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> process() &#123;</span><br><span class="line">        <span class="keyword">int</span> batchSize = <span class="number">5</span> * <span class="number">1024</span>; <span class="comment">// 一次请求拉取多条记录</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect(); <span class="comment">// 先连接服务端</span></span><br><span class="line">            connector.subscribe(); <span class="comment">// 订阅</span></span><br><span class="line">            <span class="comment">// keep send request to canal server, thus canal server can fetch binlog from mysql</span></span><br><span class="line">            <span class="keyword">while</span> (running) &#123; </span><br><span class="line">                Message message = connector.getWithoutAck(batchSize); <span class="comment">// 获取指定数量的数据</span></span><br><span class="line">                <span class="keyword">long</span> batchId = message.getId();</span><br><span class="line">                <span class="keyword">int</span> <span class="keyword">size</span> = message.getEntries().<span class="keyword">size</span>();</span><br><span class="line">                printSummary(message, batchId, <span class="keyword">size</span>);</span><br><span class="line">                printEntry(message.getEntries());</span><br><span class="line">                connector.ack(batchId); <span class="comment">// 提交确认</span></span><br><span class="line">                <span class="comment">//connector.rollback(batchId); // 处理失败, 回滚数据</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>canal client与canal server之间属于增量订阅/消费，流程图如下：（其中C端是canal client，S端是canal server）</p>
<p><img src="https://camo.githubusercontent.com/db1debcfa50f4ebea1f56a1fa0e18a4e960cafcc/687474703a2f2f646c2e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303038302f333239372f39643765643133652d366138362d333836642d393266342d3835323233386334373562662e6a7067" alt="canal protocol"></p>
<p>canal client调用<a href="https://github.com/alibaba/canal/blob/master/client/src/main/java/com/alibaba/otter/canal/client/impl/SimpleCanalConnector.java#L129"><code>connect()</code></a>方法时，发送的数据包（PacketType）类型为：</p>
<ol>
<li><a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/netty/handler/HandshakeInitializationHandler.java"><strong>HANDSHAKE</strong></a>，</li>
<li><a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/netty/handler/ClientAuthenticationHandler.java"><strong>CLIENTAUTHENTICATION</strong></a>。</li>
</ol>
<p>canal client调用<code>subscribe()</code>方法，类型为[<strong>SUBSCRIPTION</strong>]。</p>
<p>对应服务端采用netty处理RPC请求（<a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/netty/CanalServerWithNetty.java"><code>CanalServerWithNetty</code></a>）:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CanalServerWithNetty</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractCanalLifeCycle</span> <span class="title">implements</span> <span class="title">CanalServer</span> &#123;</span></span><br><span class="line">    public void start() &#123;</span><br><span class="line">        bootstrap.setPipelineFactory(<span class="keyword">new</span> <span class="type">ChannelPipelineFactory</span>() &#123;</span><br><span class="line">            public <span class="type">ChannelPipeline</span> getPipeline() <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">                <span class="type">ChannelPipeline</span> pipelines = <span class="type">Channels</span>.pipeline();</span><br><span class="line">                pipelines.addLast(<span class="type">FixedHeaderFrameDecoder</span>.<span class="keyword">class</span>.getName(), <span class="keyword">new</span> <span class="type">FixedHeaderFrameDecoder</span>());</span><br><span class="line">                <span class="comment">// 处理客户端的HANDSHAKE请求</span></span><br><span class="line">                pipelines.addLast(<span class="type">HandshakeInitializationHandler</span>.<span class="keyword">class</span>.getName(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="type">HandshakeInitializationHandler</span>(childGroups));</span><br><span class="line">                <span class="comment">// 处理客户端的CLIENTAUTHENTICATION请求</span></span><br><span class="line">                pipelines.addLast(<span class="type">ClientAuthenticationHandler</span>.<span class="keyword">class</span>.getName(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="type">ClientAuthenticationHandler</span>(embeddedServer));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 处理客户端的会话请求，包括SUBSCRIPTION，GET等</span></span><br><span class="line">                <span class="type">SessionHandler</span> sessionHandler = <span class="keyword">new</span> <span class="type">SessionHandler</span>(embeddedServer);</span><br><span class="line">                pipelines.addLast(<span class="type">SessionHandler</span>.<span class="keyword">class</span>.getName(), sessionHandler);</span><br><span class="line">                <span class="keyword">return</span> pipelines;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ClientAuthenticationHandler处理鉴权后，会移除HandshakeInitializationHandler和<a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/netty/handler/ClientAuthenticationHandler.java#L81">ClientAuthenticationHandler</a>。<br>最重要的是会话处理器<a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/netty/handler/SessionHandler.java"><strong>SessionHandler</strong></a>。</p>
<p>以client发送GET，server从mysql得到binlog后，返回<strong>MESSAGES</strong>给client为例，说明client和server的rpc交互过程：</p>
<p>SimpleCanalConnector发送<a href="https://github.com/alibaba/canal/blob/master/client/src/main/java/com/alibaba/otter/canal/client/impl/SimpleCanalConnector.java#L272"><strong>GET</strong></a>请求，并读取响应结果的流程：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public <span class="type">Message</span> getWithoutAck(<span class="type">int</span> batchSize, <span class="type">Long</span> timeout, <span class="type">TimeUnit</span> unit) throws <span class="type">CanalClientException</span> &#123;</span><br><span class="line">    waitClientRunning();</span><br><span class="line">    <span class="type">int</span> size = (batchSize &lt;= <span class="number">0</span>) ? <span class="number">1000</span> : batchSize;</span><br><span class="line">    long time = (timeout == null || timeout &lt; <span class="number">0</span>) ? -<span class="number">1</span> : timeout; // -<span class="number">1</span>代表不做timeout控制</span><br><span class="line">    <span class="keyword">if</span> (unit == null) unit = <span class="type">TimeUnit</span>.<span class="type">MILLISECONDS</span>;</span><br><span class="line"></span><br><span class="line">    // client发送<span class="type">GET</span>请求</span><br><span class="line">    writeWithHeader(<span class="type">Packet</span>.newBuilder()</span><br><span class="line">        .setType(<span class="type">PacketType</span>.<span class="type">GET</span>)</span><br><span class="line">        .setBody(<span class="type">Get</span>.newBuilder()</span><br><span class="line">            .setAutoAck(<span class="literal">false</span>)</span><br><span class="line">            .setDestination(clientIdentity.getDestination())</span><br><span class="line">            .setClientId(<span class="type">String</span>.valueOf(clientIdentity.getClientId()))</span><br><span class="line">            .setFetchSize(size)</span><br><span class="line">            .setTimeout(time)</span><br><span class="line">            .setUnit(unit.ordinal())</span><br><span class="line">            .build()</span><br><span class="line">            .toByteString())</span><br><span class="line">        .build()</span><br><span class="line">        .toByteArray());</span><br><span class="line">    // client获取<span class="type">GET</span>结果    </span><br><span class="line">    <span class="keyword">return</span> receiveMessages();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="type">Message</span> receiveMessages() throws <span class="type">IOException</span> &#123;</span><br><span class="line">    // 读取server发送的数据包</span><br><span class="line">    <span class="type">Packet</span> p = <span class="type">Packet</span>.parseFrom(readNextPacket());</span><br><span class="line">    switch (p.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">MESSAGES</span>: &#123;</span><br><span class="line">            <span class="type">Messages</span> messages = <span class="type">Messages</span>.parseFrom(p.getBody());</span><br><span class="line">            <span class="type">Message</span> <span class="literal">result</span> = new <span class="type">Message</span>(messages.getBatchId());</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">ByteString</span> byteString : messages.getMessagesList()) &#123;</span><br><span class="line">                <span class="literal">result</span>.addEntry(<span class="type">Entry</span>.parseFrom(byteString));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端SessionHandler处理客户端发送的<a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/netty/handler/SessionHandler.java#L105"><strong>GET</strong></a>请求流程：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GET:</span><br><span class="line">    <span class="comment">// 读取客户端发送的数据包，封装为Get对象</span></span><br><span class="line">    Get <span class="keyword">get</span> = CanalPacket.Get.parseFrom(packet.getBody());</span><br><span class="line">    <span class="comment">// destination表示canal instance</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotEmpty(<span class="keyword">get</span>.getDestination()) &amp;&amp; StringUtils.isNotEmpty(<span class="keyword">get</span>.getClientId())) &#123;</span><br><span class="line">        clientIdentity = <span class="keyword">new</span> ClientIdentity(<span class="keyword">get</span>.getDestination(), Short.valueOf(<span class="keyword">get</span>.getClientId()));</span><br><span class="line">        Message message = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">get</span>.getTimeout() == -<span class="number">1</span>) &#123;<span class="comment">// 是否是初始值</span></span><br><span class="line">            message = embeddedServer.getWithoutAck(clientIdentity, <span class="keyword">get</span>.getFetchSize());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            TimeUnit unit = convertTimeUnit(<span class="keyword">get</span>.getUnit());</span><br><span class="line">            message = embeddedServer.getWithoutAck(clientIdentity, <span class="keyword">get</span>.getFetchSize(), <span class="keyword">get</span>.getTimeout(), unit);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置返回给客户端的数据包类型为MESSAGES   </span></span><br><span class="line">        Packet.Builder packetBuilder = CanalPacket.Packet.newBuilder();</span><br><span class="line">        packetBuilder.setType(PacketType.MESSAGES);</span><br><span class="line">        <span class="comment">// 构造Message</span></span><br><span class="line">        Messages.Builder messageBuilder = CanalPacket.Messages.newBuilder();</span><br><span class="line">        messageBuilder.setBatchId(message.getId());</span><br><span class="line">        <span class="keyword">if</span> (message.getId() != -<span class="number">1</span> &amp;&amp; !CollectionUtils.isEmpty(message.getEntries())) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Entry entry : message.getEntries()) &#123;</span><br><span class="line">                messageBuilder.addMessages(entry.toByteString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        packetBuilder.setBody(messageBuilder.build().toByteString());</span><br><span class="line">        <span class="comment">// 输出数据，返回给客户端</span></span><br><span class="line">        NettyUtils.write(ctx.getChannel(), packetBuilder.build().toByteArray(), <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>get/ack/rollback协议介绍：</p>
<ul>
<li><code>Message getWithoutAck(int batchSize)</code>，允许指定batchSize，一次可以获取多条，每次返回的对象为Message，包含的内容为：<br>– batch id 唯一标识<br>– entries 具体的数据对象，对应的数据对象格式：<a href="https://github.com/alibaba/canal/blob/master/protocol/src/main/java/com/alibaba/otter/canal/protocol/EntryProtocol.proto">EntryProtocol.proto</a></li>
<li><a href="https://github.com/alibaba/canal/blob/master/client/src/main/java/com/alibaba/otter/canal/client/impl/SimpleCanalConnector.java#L325"><code>void rollback(long batchId)</code></a>，回滚上次的get请求，重新获取数据。基于get获取的batchId进行提交，避免误操作</li>
<li><a href="https://github.com/alibaba/canal/blob/master/client/src/main/java/com/alibaba/otter/canal/client/impl/SimpleCanalConnector.java#L343"><code>void ack(long batchId)</code></a>，确认已经消费成功，通知server删除数据。基于get获取的batchId进行提交，避免误操作</li>
</ul>
<p>EntryProtocol.protod对应的canal消息结构如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Entry  </span><br><span class="line">    Header  </span><br><span class="line">        logfileName [binlog文件名]  </span><br><span class="line">        logfileOffset [binlog position]  </span><br><span class="line">        executeTime [binlog里记录变更发生的时间戳,精确到秒]  </span><br><span class="line">        schemaName   </span><br><span class="line">        tableName  </span><br><span class="line">        eventType [<span class="operator"><span class="keyword">insert</span>/<span class="keyword">update</span>/<span class="keyword">delete</span>类型]  </span><br><span class="line">    entryType   [事务头<span class="keyword">BEGIN</span>/事务尾<span class="keyword">END</span>/数据ROWDATA]  </span><br><span class="line">    storeValue  [<span class="keyword">byte</span>数据,可展开，对应的类型为RowChange]  </span><br><span class="line">      </span><br><span class="line">RowChange  </span><br><span class="line">    isDdl       [是否是<span class="keyword">ddl</span>变更操作，比如<span class="keyword">create</span> <span class="keyword">table</span>/<span class="keyword">drop</span> <span class="keyword">table</span>]  </span><br><span class="line">    <span class="keyword">sql</span>         [具体的<span class="keyword">ddl</span> <span class="keyword">sql</span>]  </span><br><span class="line">    rowDatas    [具体<span class="keyword">insert</span>/<span class="keyword">update</span>/<span class="keyword">delete</span>的变更数据，可为多条，<span class="number">1</span>个<span class="keyword">binlog</span> <span class="keyword">event</span>事件可对应多条变更，比如批处理]  </span><br><span class="line">        beforeColumns [<span class="keyword">Column</span>类型的数组，变更前的数据字段]  </span><br><span class="line">        afterColumns [<span class="keyword">Column</span>类型的数组，变更后的数据字段]  </span><br><span class="line">          </span><br><span class="line"><span class="keyword">Column</span>   </span><br><span class="line">    <span class="keyword">index</span>         </span><br><span class="line">    sqlType     [jdbc <span class="keyword">type</span>]  </span><br><span class="line">    <span class="keyword">name</span>        [<span class="keyword">column</span> <span class="keyword">name</span>]  </span><br><span class="line">    isKey       [是否为主键]  </span><br><span class="line">    <span class="keyword">updated</span>     [是否发生过变更]  </span><br><span class="line">    <span class="keyword">isNull</span>      [值是否为<span class="literal">null</span>]  </span><br><span class="line">    <span class="keyword">value</span>       [具体的内容，注意为<span class="keyword">string</span>文本]</span></span><br></pre></td></tr></table></figure>
<p>SessionHandler中服务端处理客户端的其他类型请求，都会调用<a href="https://github.com/alibaba/canal/blob/master/server/src/main/java/com/alibaba/otter/canal/server/embedded/CanalServerWithEmbedded.java">CanalServerWithEmbedded</a>的相关方法：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SUBSCRIPTION:</span><br><span class="line">        Sub sub = Sub.parseFrom(packet.getBody());</span><br><span class="line">        embeddedServer.subscribe(clientIdentity);</span><br><span class="line"><span class="keyword">case</span> GET:</span><br><span class="line">        Get get = CanalPacket.Get.parseFrom(packet.getBody());</span><br><span class="line">        message = embeddedServer.getWithoutAck(clientIdentity, get.getFetchSize());</span><br><span class="line"><span class="keyword">case</span> CLIENTACK:</span><br><span class="line">        ClientAck ack = CanalPacket.ClientAck.parseFrom(packet.getBody());</span><br><span class="line">        embeddedServer.ack(clientIdentity, ack.getBatchId());</span><br><span class="line"><span class="keyword">case</span> CLIENTROLLBACK:</span><br><span class="line">        ClientRollback rollback = CanalPacket.ClientRollback.parseFrom(packet.getBody());</span><br><span class="line">        embeddedServer.rollback(clientIdentity);<span class="comment">// 回滚所有批次</span></span><br></pre></td></tr></table></figure>
<p>所以真正的处理逻辑在CanalServerWithEmbedded中，下面重点来了。。。</p>
<h3 id="CanalServerWithEmbedded">CanalServerWithEmbedded</h3><p>CanalServer包含多个Instance，它的成员变量<code>canalInstances</code>记录了instance名称与<a href="https://github.com/alibaba/canal/blob/master/instance/core/src/main/java/com/alibaba/otter/canal/instance/core/AbstractCanalInstance.java">实例</a>的映射关系。<br>因为是一个Map，所以同一个Server不允许出现相同instance名称（本例中实例名称为example），<br>比如不能同时有两个example在一个server上。但是允许一个Server上有example1和example2。</p>
<blockquote>
<p>注意：<code>CanalServer</code>中最重要的是<code>CanalServerWithEmbedded</code>，而CanalServerWithEmbedded中最重要的是<code>CanalInstance</code>。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CanalServerWithEmbedded</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractCanalLifeCycle</span> <span class="title">implements</span> <span class="title">CanalServer</span>, <span class="title">CanalService</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">CanalInstance</span>&gt; canalInstances;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">CanalInstanceGenerator</span>     canalInstanceGenerator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下图表示一个server配置了两个Canal实例（instance），每个Client连接一个Instance。<br>每个Canal实例模拟为一个MySQL的slave，所以每个Instance的slaveId必须不一样。<br>比如图中两个Instance的id分别是1234和1235，它们都会拉取MySQL主节点的binlog。</p>
<p><img src="http://img.blog.csdn.net/20171011202259253" alt="instances"></p>
<p>这里每个Canal Client都对应一个Instance，每个Client在启动时，<br>都会指定一个Destination，这个Destination就表示Instance的名称。<br>所以CanalServerWithEmbedded处理各种请求时的参数都有ClientIdentity，<br>从ClientIdentity中获取destination，就可以获取出对应的CanalInstance。</p>
<p>理解下各个组件的对应关系：</p>
<ul>
<li>Canal Client通过destination找出Canal Server中对应的Canal Instance。</li>
<li>一个Canal Server可以配置多个Canal Instances。</li>
</ul>
<p>下面以CanalServerWithEmbedded的订阅方法为例：</p>
<ol>
<li>根据客户端标识获取CanalInstance</li>
<li>向CanalInstance的元数据管理器订阅当前客户端</li>
<li>从元数据管理中获取客户端的游标</li>
<li>通知CanalInstance订阅关系发生变化</li>
</ol>
<blockquote>
<p>注意：提供订阅方法的作用是：MySQL新增了一张表，客户端原先没有同步这张表，现在需要同步，所以需要重新订阅。</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ClientIdentity clientIdentity)</span> <span class="keyword">throws</span> CanalServerException </span>&#123;</span><br><span class="line">    <span class="comment">// ClientIdentity表示Canal Client客户端，从中可以获取出客户端指定连接的Destination</span></span><br><span class="line">    <span class="comment">// 由于CanalServerWithEmbedded记录了每个Destination对应的Instance，可以获取客户端对应的Instance</span></span><br><span class="line">    CanalInstance canalInstance = canalInstances.get(clientIdentity.getDestination());</span><br><span class="line">    <span class="keyword">if</span> (!canalInstance.getMetaManager().isStart()) &#123;</span><br><span class="line">        canalInstance.getMetaManager().start(); <span class="comment">// 启动Instance的元数据管理器</span></span><br><span class="line">    &#125;</span><br><span class="line">    canalInstance.getMetaManager().subscribe(clientIdentity); <span class="comment">// 执行一下meta订阅</span></span><br><span class="line">    Position position = canalInstance.getMetaManager().getCursor(clientIdentity);</span><br><span class="line">    <span class="keyword">if</span> (position == <span class="keyword">null</span>) &#123;</span><br><span class="line">        position = canalInstance.getEventStore().getFirstPosition();<span class="comment">// 获取一下store中的第一条</span></span><br><span class="line">        <span class="keyword">if</span> (position != <span class="keyword">null</span>) &#123;</span><br><span class="line">            canalInstance.getMetaManager().updateCursor(clientIdentity, position); <span class="comment">// 更新一下cursor</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通知下订阅关系变化</span></span><br><span class="line">    canalInstance.subscribeChange(clientIdentity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个CanalInstance中包括了四个组件：<strong>EventParser、EventSink、EventStore、MetaManager</strong>。</p>
<p>服务端主要的处理方法包括get/ack/rollback，这三个方法都会用到Instance上面的几个内部组件，主要还是EventStore和MetaManager：</p>
<p>在这之前，要先理解EventStore的含义，EventStore是一个RingBuffer，有三个指针：<strong>Put、Get、Ack</strong>。</p>
<ul>
<li>Put: Canal Server从MySQL拉取到数据后，放到内存中，Put增加</li>
<li>Get: 消费者（Canal Client）从内存中消费数据，Get增加</li>
<li>Ack: 消费者消费完成，Ack增加。并且会删除Put中已经被Ack的数据</li>
</ul>
<p>这三个操作与Instance组件的关系如下：</p>
<p><img src="http://img.blog.csdn.net/20171011211529169" alt="ops"></p>
<p>客户端通过canal server获取mysql binlog有几种方式（get方法和getWithoutAck）：</p>
<ul>
<li>如果timeout为null，则采用tryGet方式，即时获取  </li>
<li>如果timeout不为null  <ol>
<li>timeout为0，则采用get阻塞方式，获取数据，不设置超时，直到有足够的batchSize数据才返回  </li>
<li>timeout不为0，则采用get+timeout方式，获取数据，超时还没有batchSize足够的数据，有多少返回多少  </li>
</ol>
</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Events&lt;Event&gt; getEvents(CanalEventStore eventStore, Position <span class="built_in">start</span>, int batchSize, Long timeout,</span><br><span class="line">                                TimeUnit unit) &#123;</span><br><span class="line">    <span class="keyword">if</span> (timeout == <span class="constant">null</span>) &#123;</span><br><span class="line">        <span class="constant">return</span> eventStore.tryGet(<span class="built_in">start</span>, batchSize);<span class="comment"> // 即时获取</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="constant">return</span> eventStore.<span class="built_in">get</span>(<span class="built_in">start</span>, batchSize);<span class="comment"> // 阻塞获取</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="constant">return</span> eventStore.<span class="built_in">get</span>(<span class="built_in">start</span>, batchSize, timeout, unit);<span class="comment"> // 异步获取</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：EventStore的实现采用了类似Disruptor的RingBuffer环形缓冲区。RingBuffer的实现类是MemoryEventStoreWithBuffer</p>
</blockquote>
<p>get方法和getWithoutAck方法的区别是：</p>
<ul>
<li>get方法会立即调用ack</li>
<li>getWithoutAck方法不会调用ack</li>
</ul>
<h3 id="EventStore">EventStore</h3><p>以10条数据为例，初始时current=-1，第一个元素起始next=0，end=9，循环<code>[0,9]</code>所有元素。<br>List元素为(A,B,C,D,E,F,G,H,I,J)</p>
<table>
<thead>
<tr>
<th>next</th>
<th>entries[next]</th>
<th>next-current-1</th>
<th>list element</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>entries[0]</td>
<td>0-(-1)-1=0</td>
<td>A</td>
</tr>
<tr>
<td>1</td>
<td>entries[1]</td>
<td>1-(-1)-1=1</td>
<td>B</td>
</tr>
<tr>
<td>2</td>
<td>entries[2]</td>
<td>2-(-1)-1=2</td>
<td>C</td>
</tr>
<tr>
<td>3</td>
<td>entries[3]</td>
<td>3-(-1)-1=3</td>
<td>D</td>
</tr>
<tr>
<td>.</td>
<td>……….</td>
<td>……….</td>
<td>.</td>
</tr>
<tr>
<td>9</td>
<td>entries[9]</td>
<td>9-(-1)-1=9</td>
<td>J</td>
</tr>
</tbody>
</table>
<p>第一批10个元素put完成后，putSequence设置为end=9。假设第二批又Put了5个元素:(K,L,M,N,O)</p>
<p>current=9，起始next=9+1=10，end=9+5=14，在Put完成后，putSequence设置为end=14。</p>
<table>
<thead>
<tr>
<th>next</th>
<th>entries[next]</th>
<th>next-current-1</th>
<th>list element</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>entries[10]</td>
<td>10-(9)-1=0</td>
<td>K</td>
</tr>
<tr>
<td>11</td>
<td>entries[11]</td>
<td>11-(9)-1=1</td>
<td>L</td>
</tr>
<tr>
<td>12</td>
<td>entries[12]</td>
<td>12-(9)-1=2</td>
<td>M</td>
</tr>
<tr>
<td>13</td>
<td>entries[13]</td>
<td>13-(9)-1=3</td>
<td>N</td>
</tr>
<tr>
<td>14</td>
<td>entries[14]</td>
<td>14-(9)-1=3</td>
<td>O</td>
</tr>
</tbody>
</table>
<p>这里假设环形缓冲区的最大大小为15个（源码中是16MB），那么上面两批一共产生了15个元素，刚好填满了环形缓冲区。<br>如果又有Put事件进来，由于环形缓冲区已经满了，没有可用的slot，则Put操作会被阻塞，直到被消费掉。</p>
<p>下面是Put填充环形缓冲区的代码，检查可用slot（checkFreeSlotAt方法）在几个put方法中。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> MemoryEventStoreWithBuffer <span class="keyword">extends</span> AbstractCanalStoreScavenge <span class="keyword">implements</span> CanalEventStore&lt;Event&gt;, CanalStoreScavenge &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INIT_SQEUENCE = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>               bufferSize    = <span class="number">16</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>               bufferMemUnit = <span class="number">1024</span>;                         <span class="comment">// memsize的单位，默认为1kb大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>               indexMask;</span><br><span class="line">    <span class="keyword">private</span> Event[]           entries;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录下put/get/ack操作的三个下标</span></span><br><span class="line">    <span class="keyword">private</span> AtomicLong        putSequence   = <span class="keyword">new</span> AtomicLong(INIT_SQEUENCE); <span class="comment">// 代表当前put操作最后一次写操作发生的位置</span></span><br><span class="line">    <span class="keyword">private</span> AtomicLong        getSequence   = <span class="keyword">new</span> AtomicLong(INIT_SQEUENCE); <span class="comment">// 代表当前get操作读取的最后一条的位置</span></span><br><span class="line">    <span class="keyword">private</span> AtomicLong        ackSequence   = <span class="keyword">new</span> AtomicLong(INIT_SQEUENCE); <span class="comment">// 代表当前ack操作的最后一条的位置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动EventStore时，创建指定大小的缓冲区，Event数组的大小是16*1024</span></span><br><span class="line">    <span class="comment">// 也就是说算个数的话，数组可以容纳16000个事件。算内存的话，大小为16MB</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> start() <span class="keyword">throws</span> CanalStoreException &#123;</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">        indexMask = bufferSize - <span class="number">1</span>;</span><br><span class="line">        entries = <span class="keyword">new</span> Event[bufferSize];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// EventParser解析后，会放入内存中（Event数组，缓冲区）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> doPut(List&lt;Event&gt; data) &#123;</span><br><span class="line">        <span class="keyword">long</span> current = putSequence.get(); <span class="comment">// 取得当前的位置，初始时为-1，第一个元素为-1+1=0</span></span><br><span class="line">        <span class="keyword">long</span> end = current + data.<span class="keyword">size</span>(); <span class="comment">// 最末尾的位置，假设Put了10条数据，end=-1+10=9</span></span><br><span class="line">        <span class="comment">// 先写数据，再更新对应的cursor,并发度高的情况，putSequence会被get请求可见，拿出了ringbuffer中的老的Entry值</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> <span class="keyword">next</span> = current + <span class="number">1</span>; <span class="keyword">next</span> &lt;= end; <span class="keyword">next</span>++) &#123;</span><br><span class="line">            entries[getIndex(<span class="keyword">next</span>)] = data.get((<span class="keyword">int</span>) (<span class="keyword">next</span> - current - <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        putSequence.set(end);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Put是生产数据，Get是消费数据，Get一定不会超过Put。比如Put了10条数据，Get最多只能获取到10条数据。但有时候为了保证Get处理的速度，Put和Get并不会相等。<br>可以把Put看做是生产者，Get看做是消费者。生产者速度可以很快，消费者则可以慢慢地消费。比如Put了1000条，而Get我们只需要每次处理10条数据。</p>
<p>仍然以前面的示例来说明Get的流程，初始时current=-1，假设Put了两批数据一共15条，maxAbleSequence=14，而Get的BatchSize假设为10。<br>初始时next=current=-1，end=-1。通过startPosition，会设置next=0。最后end又被赋值为9，即循环缓冲区[0,9]一共10个元素。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Events&lt;Event&gt; doGet(Position start, <span class="keyword">int</span> batchSize) <span class="keyword">throws</span> CanalStoreException &#123;</span><br><span class="line">    LogPosition startPosition = (LogPosition) start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> current = getSequence.get();</span><br><span class="line">    <span class="keyword">long</span> maxAbleSequence = putSequence.get();</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">next</span> = current;</span><br><span class="line">    <span class="keyword">long</span> end = current;</span><br><span class="line">    <span class="comment">// 如果startPosition为null，说明是第一次，默认+1处理</span></span><br><span class="line">    <span class="keyword">if</span> (startPosition == <span class="keyword">null</span> || !startPosition.getPostion().isIncluded()) &#123; <span class="comment">// 第一次订阅之后，需要包含一下start位置，防止丢失第一条记录</span></span><br><span class="line">        <span class="keyword">next</span> = <span class="keyword">next</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    end = (<span class="keyword">next</span> + batchSize - <span class="number">1</span>) &lt; maxAbleSequence ? (<span class="keyword">next</span> + batchSize - <span class="number">1</span>) : maxAbleSequence;</span><br><span class="line">    <span class="comment">// 提取数据并返回</span></span><br><span class="line">    <span class="keyword">for</span> (; <span class="keyword">next</span> &lt;= end; <span class="keyword">next</span>++) &#123;</span><br><span class="line">        Event event = entries[getIndex(<span class="keyword">next</span>)];</span><br><span class="line">        <span class="keyword">if</span> (ddlIsolation &amp;&amp; isDdl(event.getEntry().getHeader().getEventType())) &#123;</span><br><span class="line">            <span class="comment">// 如果是ddl隔离，直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (entrys.<span class="keyword">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">                entrys.add(event);<span class="comment">// 如果没有DML事件，加入当前的DDL事件</span></span><br><span class="line">                end = <span class="keyword">next</span>; <span class="comment">// 更新end为当前</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果之前已经有DML事件，直接返回了，因为不包含当前next这记录，需要回退一个位置</span></span><br><span class="line">                end = <span class="keyword">next</span> - <span class="number">1</span>; <span class="comment">// next-1一定大于current，不需要判断</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            entrys.add(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理PositionRange，然后设置getSequence为end</span></span><br><span class="line">    getSequence.compareAndSet(current, end)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ack操作的上限是Get，假设Put了15条数据，Get了10条数据，最多也只能Ack10条数据。Ack的目的是清空缓冲区中已经被Get过的数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> ack(Position position) <span class="keyword">throws</span> CanalStoreException &#123;</span><br><span class="line">    cleanUntil(position);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> cleanUntil(Position position) <span class="keyword">throws</span> CanalStoreException &#123;</span><br><span class="line">    <span class="keyword">long</span> sequence = ackSequence.get();</span><br><span class="line">    <span class="keyword">long</span> maxSequence = getSequence.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasMatch = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">long</span> memsize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> <span class="keyword">next</span> = sequence + <span class="number">1</span>; <span class="keyword">next</span> &lt;= maxSequence; <span class="keyword">next</span>++) &#123;</span><br><span class="line">        Event event = entries[getIndex(<span class="keyword">next</span>)];</span><br><span class="line">        memsize += calculateSize(event);</span><br><span class="line">        <span class="keyword">boolean</span> match = CanalEventUtils.checkPosition(event, (LogPosition) position);</span><br><span class="line">        <span class="keyword">if</span> (match) &#123;<span class="comment">// 找到对应的position，更新ack seq</span></span><br><span class="line">            hasMatch = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (batchMode.isMemSize()) &#123;</span><br><span class="line">                ackMemSize.addAndGet(memsize);</span><br><span class="line">                <span class="comment">// 尝试清空buffer中的内存，将ack之前的内存全部释放掉</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">long</span> index = sequence + <span class="number">1</span>; index &lt; <span class="keyword">next</span>; index++) &#123;</span><br><span class="line">                    entries[getIndex(index)] = <span class="keyword">null</span>;<span class="comment">// 设置为null</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ackSequence.compareAndSet(sequence, <span class="keyword">next</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rollback回滚方法的实现则比较简单，将getSequence回退到ack位置。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span>(<span class="params"></span>) throws CanalStoreException </span>&#123;</span><br><span class="line">    getSequence.<span class="keyword">set</span>(ackSequence.<span class="keyword">get</span>());</span><br><span class="line">    getMemSize.<span class="keyword">set</span>(ackMemSize.<span class="keyword">get</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下图展示了RingBuffer的几个操作示例：</p>
<p><img src="http://img.blog.csdn.net/20171011225116791" alt="ringbuffer"></p>
<h3 id="EventParser_WorkFlow">EventParser WorkFlow</h3><p>EventStore负责存储解析后的Binlog事件，而解析动作负责拉取Binlog，它的流程比较复杂。需要和MetaManager进行交互。<br>比如要记录每次拉取的Position，这样下一次就可以从上一次的最后一个位置继续拉取。所以MetaManager应该是有状态的。</p>
<p>EventParser的流程如下：</p>
<ol>
<li>Connection获取上一次解析成功的位置 (如果第一次启动，则获取初始指定的位置或者是当前数据库的binlog位点)</li>
<li>Connection建立链接，发送BINLOG_DUMP指令</li>
<li>Mysql开始推送Binaly Log</li>
<li>接收到的Binaly Log的通过Binlog parser进行协议解析，补充一些特定信息</li>
<li>传递给EventSink模块进行数据存储，是一个阻塞操作，直到存储成功</li>
<li>存储成功后，定时记录Binaly Log位置</li>
</ol>
<p><img src="https://camo.githubusercontent.com/031db3aa27461d13faa2dea479ef639f93386a00/687474703a2f2f646c2e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303038302f333134332f37393531633136392d663764662d336362332d616562622d6439323466353733313163622e6a7067" alt="parser"></p>
<p>上面提到的Connection指的是实现了<code>ErosaConnection</code>接口的<code>MysqlConnection</code>。<br><code>EventParser</code>的实现类是实现了<code>AbstractEventParser</code>的<code>MysqlEventParser</code>。</p>
<p><code>EventParser</code>解析binlog后通过<code>EventSink</code>写入到<code>EventStore</code>，这条链路可以通过EventStore的put方法串联起来：</p>
<p><img src="http://img.blog.csdn.net/20171011234800632" alt="put"></p>
<p>其实这里还有一个EventTransactionBuffer缓冲区，即Parser解析后先放到缓冲区中，<br>当事务发生时或者数据超过阈值，就会执行刷新操作：即消费缓冲区的数据，放到EventStore中。<br>这个缓冲区有两个偏移量指针：putSequence和flushSequence。</p>
<h2 id="Canal_HA">Canal HA</h2><p>单机模拟两个Canal Server，将单机模式复制出两个文件夹，并修改相关配置</p>
<p>canal_m/conf/canal.properties</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">canal.id= <span class="number">2</span></span><br><span class="line">canal.ip=</span><br><span class="line">canal.port= <span class="number">11112</span></span><br><span class="line">canal.zkServers=localhost:<span class="number">2181</span></span><br><span class="line">canal.<span class="keyword">instance</span>.<span class="keyword">global</span>.<span class="keyword">spring</span>.xml = classpath:<span class="keyword">spring</span>/<span class="keyword">default</span>-<span class="keyword">instance</span>.xml</span><br></pre></td></tr></table></figure>
<p>canal_m/conf/example/instance.properties</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canal<span class="class">.instance</span><span class="class">.mysql</span><span class="class">.slaveId</span> = <span class="number">1235</span></span><br></pre></td></tr></table></figure>
<p>canal_s</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">canal.id= <span class="number">3</span></span><br><span class="line">canal.ip=</span><br><span class="line">canal.port= <span class="number">11113</span></span><br><span class="line">canal.zkServers=localhost:<span class="number">2181</span></span><br><span class="line">canal.<span class="keyword">instance</span>.<span class="keyword">global</span>.<span class="keyword">spring</span>.xml = classpath:<span class="keyword">spring</span>/<span class="keyword">default</span>-<span class="keyword">instance</span>.xml</span><br></pre></td></tr></table></figure>
<p>canal_s/conf/example/instance.properties</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canal<span class="class">.instance</span><span class="class">.mysql</span><span class="class">.slaveId</span> = <span class="number">1236</span></span><br></pre></td></tr></table></figure>
<p>启动canal_m</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2017<span class="tag">-10-12</span> 14<span class="pseudo">:51</span><span class="pseudo">:45</span><span class="class">.202</span> <span class="attr_selector">[main]</span> <span class="tag">INFO</span>  <span class="tag">com</span><span class="class">.alibaba</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.deployer</span><span class="class">.CanalLauncher</span> <span class="tag">-</span> ## <span class="tag">start</span> <span class="tag">the</span> <span class="tag">canal</span> <span class="tag">server</span>.</span><br><span class="line">2017<span class="tag">-10-12</span> 14<span class="pseudo">:51</span><span class="pseudo">:45</span><span class="class">.776</span> <span class="attr_selector">[main]</span> <span class="tag">INFO</span>  <span class="tag">com</span><span class="class">.alibaba</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.deployer</span><span class="class">.CanalController</span> <span class="tag">-</span> ## <span class="tag">start</span> <span class="tag">the</span> <span class="tag">canal</span> <span class="tag">server</span><span class="attr_selector">[192.168.6.52:11112]</span></span><br><span class="line">2017<span class="tag">-10-12</span> 14<span class="pseudo">:51</span><span class="pseudo">:46</span><span class="class">.687</span> <span class="attr_selector">[main]</span> <span class="tag">INFO</span>  <span class="tag">com</span><span class="class">.alibaba</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.deployer</span><span class="class">.CanalLauncher</span> <span class="tag">-</span> ## <span class="tag">the</span> <span class="tag">canal</span> <span class="tag">server</span> <span class="tag">is</span> <span class="tag">running</span> <span class="tag">now</span> ......</span><br></pre></td></tr></table></figure>
<p>启动canal_s</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2017<span class="tag">-10-12</span> 14<span class="pseudo">:52</span><span class="pseudo">:18</span><span class="class">.999</span> <span class="attr_selector">[main]</span> <span class="tag">INFO</span>  <span class="tag">com</span><span class="class">.alibaba</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.deployer</span><span class="class">.CanalLauncher</span> <span class="tag">-</span> ## <span class="tag">start</span> <span class="tag">the</span> <span class="tag">canal</span> <span class="tag">server</span>.</span><br><span class="line">2017<span class="tag">-10-12</span> 14<span class="pseudo">:52</span><span class="pseudo">:19</span><span class="class">.208</span> <span class="attr_selector">[main]</span> <span class="tag">INFO</span>  <span class="tag">com</span><span class="class">.alibaba</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.deployer</span><span class="class">.CanalController</span> <span class="tag">-</span> ## <span class="tag">start</span> <span class="tag">the</span> <span class="tag">canal</span> <span class="tag">server</span><span class="attr_selector">[192.168.6.52:11113]</span></span><br><span class="line">2017<span class="tag">-10-12</span> 14<span class="pseudo">:52</span><span class="pseudo">:19</span><span class="class">.364</span> <span class="attr_selector">[main]</span> <span class="tag">INFO</span>  <span class="tag">com</span><span class="class">.alibaba</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.deployer</span><span class="class">.CanalLauncher</span> <span class="tag">-</span> ## <span class="tag">the</span> <span class="tag">canal</span> <span class="tag">server</span> <span class="tag">is</span> <span class="tag">running</span> <span class="tag">now</span> ......</span><br></pre></td></tr></table></figure>
<p>master提供服务，canal_m/logs/example/example.log下有日志，而canal_s/logs没有example文件夹</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 ~]$ tail -f canal_m/logs/example/example<span class="class">.log</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">46.453</span> [main] INFO  c<span class="class">.a</span><span class="class">.o</span><span class="class">.c</span><span class="class">.i</span><span class="class">.spring</span><span class="class">.support</span><span class="class">.PropertyPlaceholderConfigurer</span> - Loading properties file from class path resource [canal.properties]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">46.463</span> [main] INFO  c<span class="class">.a</span><span class="class">.o</span><span class="class">.c</span><span class="class">.i</span><span class="class">.spring</span><span class="class">.support</span><span class="class">.PropertyPlaceholderConfigurer</span> - Loading properties file from class path resource [example/instance.properties]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">46.624</span> [main] INFO  c<span class="class">.a</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.instance</span><span class="class">.spring</span><span class="class">.CanalInstanceWithSpring</span> - start CannalInstance <span class="keyword">for</span> <span class="number">1</span>-example</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">46.644</span> [main] INFO  c<span class="class">.a</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.instance</span><span class="class">.core</span><span class="class">.AbstractCanalInstance</span> - start successful....</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">51</span>:<span class="number">46.658</span> [destination = example , <span class="tag">address</span> = /<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span> , EventParser] WARN  c<span class="class">.a</span><span class="class">.otter</span><span class="class">.canal</span><span class="class">.parse</span><span class="class">.inbound</span><span class="class">.mysql</span><span class="class">.MysqlEventParser</span> - prepare to find start <span class="attribute">position</span> just show master status</span><br></pre></td></tr></table></figure>
<p>查看Canal HA记录在ZK的信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">7</span>] ls /otter/canal/destinations/example/cluster</span><br><span class="line">[<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11112</span>, <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11113</span>]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">10</span>] get /otter/canal/destinations/example/running</span><br><span class="line">&#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"192.168.6.52:11112"</span>,<span class="string">"cid"</span>:<span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<p>启动example的<a href="https://github.com/alibaba/canal/blob/master/example/src/main/java/com/alibaba/otter/canal/example/ClusterCanalClientTest.java">ClusterCanalClientTest</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">CanalConnector</span> connector = CanalConnectors.newClusterConnector(<span class="string">"192.168.6.52:2181"</span>, destination, <span class="string">"canal"</span>, <span class="string">"canal"</span>);</span><br></pre></td></tr></table></figure>
<p>执行SQL：<code>update test set name = &#39;zqh&#39; where uid=1;</code>，控制台打印日志如下：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [1] ,count : [3] , memsize : [203] , Time : 2017-10-12 15:05:20</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:1151:1507791918000(2017-10-12 15:05:18)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:1331:1507791918000(2017-10-12 15:05:18)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">================&gt; binlog[mysql-bin.000004:1151] , executeTime : 1507791918000 , delay : 2080ms</span><br><span class="line"> BEGIN ----&gt; Thread id: 763</span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:1277] , name[canal_test,test] , eventType : UPDATE , executeTime : 1507791918000 , delay : 2092ms</span><br><span class="line">uid : 1    type=int(4)</span><br><span class="line">name : zqh    type=varchar(10)    update=true</span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:1331] , executeTime : 1507791918000 , delay : 2130ms</span><br></pre></td></tr></table></figure>
<p>再次查看ZK中记录的客户端信息：</p>
<ul>
<li>一个Instance对应一个Client，这里的Instance名称为example，对应的客户端编号是1001</li>
<li>为了验证Instance确实是由指定的Client连接，在Server上查看11112端口</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">18</span>] get /otter/canal/destinations/example/<span class="number">1001</span>/running</span><br><span class="line">&#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"10.57.241.44:53942"</span>,<span class="string">"clientId"</span>:<span class="number">1001</span>&#125;</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">19</span>] get /otter/canal/destinations/example/<span class="number">1001</span>/cursor</span><br><span class="line">&#123;<span class="string">"@type"</span>:<span class="string">"com.alibaba.otter.canal.protocol.position.LogPosition"</span>,</span><br><span class="line"><span class="string">"identity"</span>:&#123;<span class="string">"slaveId"</span>:-<span class="number">1</span>,<span class="string">"sourceAddress"</span>:&#123;<span class="string">"address"</span>:<span class="string">"localhost"</span>,<span class="string">"port"</span>:<span class="number">3306</span>&#125;&#125;,</span><br><span class="line"><span class="string">"postion"</span>:&#123;<span class="string">"included"</span>:<span class="literal">false</span>,<span class="string">"journalName"</span>:<span class="string">"mysql-bin.000004"</span>,<span class="string">"position"</span>:<span class="number">1331</span>,<span class="string">"serverId"</span>:<span class="number">1</span>,<span class="string">"timestamp"</span>:<span class="number">1507791918000</span>&#125;&#125; ==》serverId表示MySQL的server_id</span><br><span class="line"></span><br><span class="line">[qihuang.zheng@dp0652 ~]$ netstat -anpt|grep <span class="number">11112</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">11112</span>               <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*                   LISTEN      <span class="number">27816</span>/java   ==》Canal服务端</span><br><span class="line">tcp        <span class="number">0</span>     <span class="number">19</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11112</span>          <span class="number">10.57</span><span class="number">.241</span><span class="number">.44</span>:<span class="number">53942</span>          ESTABLISHED <span class="number">27816</span>/java   ==》Canal客户端</span><br></pre></td></tr></table></figure>
<p>停止canal_m</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng<span class="annotation">@dp</span>0652 canal_m]$ bin/stop.sh</span><br><span class="line"><span class="string">dp0652:</span> stopping canal <span class="number">27816</span> ...</span><br><span class="line">Oook! <span class="string">cost:</span><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>Instance会在slave节点即canal_s上启动</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[qihuang.zheng@dp0652 ~]$ tail -f canal_s/logs/example/example.<span class="built_in">log</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">21.452</span> [New I/O server worker <span class="preprocessor">#<span class="number">1</span>-<span class="number">1</span>] ERROR com.alibaba.otter.canal.server.netty.NettyUtils - ErrotCode:<span class="number">400</span> , Caused by :</span></span><br><span class="line">something goes wrong with channel:[id: <span class="number">0x0c182149</span>, /<span class="number">10.57</span><span class="number">.241</span><span class="number">.44</span>:<span class="number">54008</span> =&gt; /<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11113</span>], exception=com.alibaba.otter.canal.server.exception.CanalServerException: destination:example should start first</span><br><span class="line"></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">21.661</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from <span class="keyword">class</span> path resource [canal.properties]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">21.663</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from <span class="keyword">class</span> path resource [example/instance.properties]</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">21.767</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN  org.springframework.beans.TypeConverterDelegate - PropertyEditor [com.sun.beans.editors.EnumEditor] found through deprecated global PropertyEditorManager fallback - consider <span class="keyword">using</span> a more isolated form of registration, e.g. on the BeanWrapper/BeanFactory!</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">21.968</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance <span class="keyword">for</span> <span class="number">1</span>-example</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">21.998</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  c.a.otter.canal.instance.core.AbstractCanalInstance - start successful....</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">22.071</span> [destination = example , address = /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span> , EventParser] WARN  c.a.otter.canal.parse.inbound.mysql.MysqlEventParser - prepare to find start position just last position</span><br><span class="line"> &#123;<span class="string">"identity"</span>:&#123;<span class="string">"slaveId"</span>:-<span class="number">1</span>,<span class="string">"sourceAddress"</span>:&#123;<span class="string">"address"</span>:<span class="string">"localhost"</span>,<span class="string">"port"</span>:<span class="number">3306</span>&#125;&#125;,<span class="string">"postion"</span>:&#123;<span class="string">"included"</span>:<span class="literal">false</span>,<span class="string">"journalName"</span>:<span class="string">"mysql-bin.000004"</span>,<span class="string">"position"</span>:<span class="number">1331</span>,<span class="string">"serverId"</span>:<span class="number">1</span>,<span class="string">"timestamp"</span>:<span class="number">1507791918000</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>停止canal_m后，只剩下canal_s，所以Canal集群只有一个节点了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">14</span>] ls /otter/canal/cluster</span><br><span class="line">[<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11113</span>]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">5</span>] get /otter/canal/destinations/example/running</span><br><span class="line">&#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"192.168.6.52:11113"</span>,<span class="string">"cid"</span>:<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<p>切换过程中，Client的日志</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2017-10-12 15:17:22.524 [Thread-2] WARN  c.alibaba.otter.canal.client.impl.ClusterCanalConnector - failed to connect to:/192.168.6.52:11113 after retry 0 times</span><br><span class="line">2017-10-12 15:17:22.529 [Thread-2] WARN  c.a.otter.canal.client.impl.running.ClientRunningMonitor - canal is not run any in node</span><br><span class="line">2017-10-12 15:17:27.695 [Thread-2] INFO  c.alibaba.otter.canal.client.impl.ClusterCanalConnector - restart the connector for next round retry.</span><br><span class="line"></span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [1] ,count : [1] , memsize : [75] , Time : 2017-10-12 15:17:27</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:1331:1507791918000(2017-10-12 15:05:18)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:1331:1507791918000(2017-10-12 15:05:18)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:1331] , executeTime : 1507791918000 , delay : 729763ms</span><br></pre></td></tr></table></figure>
<p>再次执行SQL语句</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [2] ,count : [3] , memsize : [198] , Time : 2017-10-12 15:20:56</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:1406:1507792855000(2017-10-12 15:20:55)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:1581:1507792855000(2017-10-12 15:20:55)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">================&gt; binlog[mysql-bin.000004:1406] , executeTime : 1507792855000 , delay : 1539ms</span><br><span class="line"> BEGIN ----&gt; Thread id: 763</span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:1532] , name[canal_test,test] , eventType : UPDATE , executeTime : 1507792855000 , delay : 1539ms</span><br><span class="line">uid : 1    type=int(4)</span><br><span class="line">name : zqhx    type=varchar(10)    update=true</span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:1581] , executeTime : 1507792855000 , delay : 1540ms</span><br></pre></td></tr></table></figure>
<p>停止客户端后，查询ZK中的客户端信息。注意，仍然有cursor信息，但是没有running，因为instance没有对应的client了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">1</span>] ls /otter/canal/destinations/example</span><br><span class="line">[running, cluster, <span class="number">1001</span>]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">0</span>] ls /otter/canal/destinations/example/<span class="number">1001</span></span><br><span class="line">[cursor]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">6</span>] get /otter/canal/destinations/example/<span class="number">1001</span>/cursor</span><br><span class="line">&#123;<span class="string">"@type"</span>:<span class="string">"com.alibaba.otter.canal.protocol.position.LogPosition"</span>,</span><br><span class="line"><span class="string">"identity"</span>:&#123;<span class="string">"slaveId"</span>:-<span class="number">1</span>,<span class="string">"sourceAddress"</span>:&#123;<span class="string">"address"</span>:<span class="string">"localhost"</span>,<span class="string">"port"</span>:<span class="number">3306</span>&#125;&#125;,</span><br><span class="line"><span class="string">"postion"</span>:&#123;<span class="string">"included"</span>:<span class="literal">false</span>,<span class="string">"journalName"</span>:<span class="string">"mysql-bin.000004"</span>,<span class="string">"position"</span>:<span class="number">1581</span>,<span class="string">"serverId"</span>:<span class="number">1</span>,<span class="string">"timestamp"</span>:<span class="number">1507792855000</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>cursor信息是instance消费binlog的位置，即使客户端停掉了，也仍然保留在zk中。</p>
<blockquote>
<p>注意：1001是ClientIdentity的固定编号，相关源码在<a href="https://github.com/alibaba/canal/blob/master/client/src/main/java/com/alibaba/otter/canal/client/impl/SimpleCanalConnector.java#L88">SimpleCanalConnector</a>的构造方法里。</p>
</blockquote>
<p>下面总结下zk中的相关记录：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/otter/canal/</span><br><span class="line">  |- cluster          ==&gt; [<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11112</span>, <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11113</span>]</span><br><span class="line">  |- destinations     ==&gt; instances</span><br><span class="line">     |- example1/     ==&gt; instance name</span><br><span class="line">     |  |- cluster    ==&gt; [<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11112</span>, <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11113</span>]</span><br><span class="line">     |  |- running    ==&gt; &#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"192.168.6.52:11112"</span>,<span class="string">"cid"</span>:<span class="number">2</span>&#125;</span><br><span class="line">     |  |- <span class="number">1001</span></span><br><span class="line">     |     |- running  ==&gt; &#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"10.57.241.44:53942"</span>,<span class="string">"clientId"</span>:<span class="number">1001</span>&#125;</span><br><span class="line">     |     |- cursor  ==&gt; &#123;localhost:<span class="number">3306</span>,<span class="string">"journalName"</span>:<span class="string">"mysql-bin.000004"</span>,<span class="string">"position"</span>:<span class="number">1331</span>,<span class="string">"serverId"</span>:<span class="number">1</span>&#125;</span><br><span class="line">     |- example2/</span><br><span class="line">     |  |- cluster    ==&gt; [<span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11112</span>, <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">11113</span>]</span><br><span class="line">     |  |- running    ==&gt; &#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"192.168.6.52:11112"</span>,<span class="string">"cid"</span>:<span class="number">2</span>&#125;</span><br><span class="line">     |  |- <span class="number">1001</span></span><br><span class="line">     |     |- running  ==&gt; &#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"10.57.241.44:53942"</span>,<span class="string">"clientId"</span>:<span class="number">1001</span>&#125;</span><br><span class="line">     |     |- cursor  ==&gt; &#123;localhost:<span class="number">3306</span>,<span class="string">"journalName"</span>:<span class="string">"mysql-bin.000004"</span>,<span class="string">"position"</span>:<span class="number">1331</span>,<span class="string">"serverId"</span>:<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里有两个running节点，第一个是CanalServer，第二个是CanalClient。</p>
<ul>
<li><code>/otter/canal/destinations/example1/running</code>: <em>{“active”:true,”address”:”192.168.6.52:11112”,”cid”:2}</em></li>
<li><code>/otter/canal/destinations/example1/1001/running</code>: <em>{“active”:true,”address”:”10.57.241.44:53942”,”clientId”:1001}</em></li>
</ul>
<p>下图是Canal Server HA的流程图：</p>
<ol>
<li>canal server要启动某个canal instance时都先向zookeeper进行一次尝试启动判断 (实现：创建EPHEMERAL节点，谁创建成功就允许谁启动)</li>
<li>创建zookeeper节点成功后，对应的canal server就启动对应的canal instance，没有创建成功的canal instance就会处于standby状态</li>
<li>一旦zookeeper发现canal server A创建的节点消失后，立即通知其他的canal server再次进行步骤1的操作，重新选出一个canal server启动instance.</li>
<li>canal client每次进行connect时，会首先向zookeeper询问当前是谁启动了canal instance，然后和其建立链接，一旦链接不可用，会重新尝试connect.</li>
</ol>
<p><img src="https://camo.githubusercontent.com/c8f1d98268a307821273e94e7eefcd29a26f9b78/687474703a2f2f646c2e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303038302f333330332f64333230326332362d653935342d333563302d613331392d3537363034313032633537642e6a7067" alt="server ha"></p>
<h2 id="Canal_Client_HA">Canal Client HA</h2><p>Canal Client的方式和canal server方式类似，也是利用zookeeper的抢占EPHEMERAL节点的方式进行控制。</p>
<blockquote>
<p>HA的实现，客户端是ClientRunningMonitor，服务端是ServerRunningMonitor。</p>
</blockquote>
<p>关于Canal Client HA的验证，可以参考：<a href="http://blog.csdn.net/xiaolinzi007/article/details/52933909" target="_blank" rel="external">http://blog.csdn.net/xiaolinzi007/article/details/52933909</a></p>
<ul>
<li>在IDEA中同时启动多个客户端，执行一条SQL语句，其中一个客户端会打印日志，另一个不会打印。</li>
<li>停止打印日志的那个客户端（在停止这个客户端之前，日志一直发动到这个客户端，不是负载均衡）。</li>
<li>再次执行SQL语句，另外一个客户端会打印日志。</li>
</ul>
<p>Client1的日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [3] ,count : [3] , memsize : [198] , Time : 2017-10-12 17:59:59</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:1656:1507802398000(2017-10-12 17:59:58)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:1831:1507802398000(2017-10-12 17:59:58)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">================&gt; binlog[mysql-bin.000004:1656] , executeTime : 1507802398000 , delay : 1188ms</span><br><span class="line"> BEGIN ----&gt; Thread id: 768</span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:1782] , name[canal_test,test] , eventType : UPDATE , executeTime : 1507802398000 , delay : 1199ms</span><br><span class="line">uid : 1    type=int(4)</span><br><span class="line">name : zqh    type=varchar(10)    update=true</span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:1831] , executeTime : 1507802398000 , delay : 1236ms</span><br><span class="line"><span class="comment">## stop the canal client## canal client is down.</span></span><br></pre></td></tr></table></figure>
<p>停止Client1后，Client2的日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> Batch Id: [4] ,count : [3] , memsize : [198] , Time : 2017-10-12 18:02:15</span><br><span class="line"><span class="keyword">*</span> Start : [mysql-bin.000004:1906:1507802534000(2017-10-12 18:02:14)] </span><br><span class="line"><span class="keyword">*</span> End : [mysql-bin.000004:2081:1507802534000(2017-10-12 18:02:14)] </span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line">================&gt; binlog[mysql-bin.000004:1906] , executeTime : 1507802534000 , delay : 1807ms</span><br><span class="line"> BEGIN ----&gt; Thread id: 768</span><br><span class="line">----------------&gt; binlog[mysql-bin.000004:2032] , name[canal_test,test] , eventType : UPDATE , executeTime : 1507802534000 , delay : 1819ms</span><br><span class="line">uid : 1    type=int(4)</span><br><span class="line">name : zqhx    type=varchar(10)    update=true</span><br><span class="line">----------------</span><br><span class="line"> END ----&gt; transaction id: 0</span><br><span class="line">================&gt; binlog[mysql-bin.000004:2081] , executeTime : 1507802534000 , delay : 1855ms</span><br></pre></td></tr></table></figure>
<p>观察ZK节点中instance对应的client节点，在Client切换时，会进行变更。<br>比如下面的客户端从56806端口切换到了56842端口。<br>把所有客户端都关闭后，1001下没有running。表示instance没有客户端消费binlog了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">启动两个客户端，第一个客户端（<span class="number">56806</span>）正在运行</span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">29</span>] get /otter/canal/destinations/example/<span class="number">1001</span>/running</span><br><span class="line">&#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"10.57.241.44:56806"</span>,<span class="string">"clientId"</span>:<span class="number">1001</span>&#125;</span><br><span class="line"></span><br><span class="line">停止第一个客户端，删除节点</span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">30</span>] get /otter/canal/destinations/example/<span class="number">1001</span>/running</span><br><span class="line">Node does not exist: /otter/canal/destinations/example/<span class="number">1001</span>/running</span><br><span class="line"></span><br><span class="line">第二个客户端（<span class="number">56842</span>）成为主</span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">31</span>] get /otter/canal/destinations/example/<span class="number">1001</span>/running</span><br><span class="line">&#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"10.57.241.44:56842"</span>,<span class="string">"clientId"</span>:<span class="number">1001</span>&#125;</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.52</span>:<span class="number">2181</span>(CONNECTED) <span class="number">32</span>] ls /otter/canal/destinations/example/<span class="number">1001</span></span><br><span class="line">[cursor]</span><br></pre></td></tr></table></figure>
<p>具体实现相关类有：ClientRunningMonitor/ClientRunningListener/ClientRunningData。</p>
<p>client running相关控制，主要为解决client自身的failover机制。<br>canal client允许同时启动多个canal client，<br>通过running机制，可保证只有一个client在工作，其他client做为冷备.<br>当运行中的client挂了，running会控制让冷备中的client转为工作模式，<br>这样就可以确保canal client也不会是单点. 保证整个系统的高可用性.</p>
<p>下图左边是客户端的HA实现，右边是服务端的HA实现</p>
<p><img src="http://img.blog.csdn.net/20171012184033228" alt="ha"></p>
<h2 id="Develop_Canal_Client"><a href="https://github.com/alibaba/canal/wiki/ClientAPI">Develop Canal Client</a></h2><p>先理解下面的类图结构：</p>
<ul>
<li>CanalConnector接口，定义了连接、订阅、获取、应答、回滚等方法</li>
<li>SimpleCanalConnector实现，单机版本</li>
<li>ClusterCanalConnector实现，HA版本</li>
</ul>
<p><img src="https://camo.githubusercontent.com/8cc684cf92e22d738d57b002c356afba96bcc4f5/687474703a2f2f646c322e69746579652e636f6d2f75706c6f61642f6174746163686d656e742f303039302f363435332f39326233343335302d323566632d333162332d626361362d3865326131653763356532322e6a7067" alt="client"></p>
<h3 id="subscribe_change">subscribe change</h3><p>重新看下CanalServerWithEmbedded的订阅方法。我们知道客户端在连接服务端的某个destination之后，会紧接着调用subscribe()方法。</p>
<p>客户端连接服务端时，必须指定destination名称，因为一个服务端可能有多个destination。<br>比如服务端启动了两个Instance，它们的destination名称分别是example1和example2。<br>假设有两个客户端A和B，A连接example1，B连接example2（在代码中手动指定的，不是自动选择）。<br>服务端的canalInstances字典为：{example1=&gt;Instance1，example2-&gt;Instance2}。<br>那么ClientA的destination等于example1，对应的服务端实例为Instance1。<br>ClientB的destination等于example2，对应的服务端实例为Instance3。</p>
<p><img src="http://img.blog.csdn.net/20171012230738279" alt="clients"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 客户端订阅，重复订阅时会更新对应的filter信息</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span>(<span class="params">ClientIdentity clientIdentity</span>) throws CanalServerException </span>&#123;</span><br><span class="line">    CanalInstance canalInstance = canalInstances.<span class="keyword">get</span>(clientIdentity.getDestination());</span><br><span class="line">    <span class="keyword">if</span> (!canalInstance.getMetaManager().isStart()) &#123;</span><br><span class="line">        canalInstance.getMetaManager().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    canalInstance.getMetaManager().subscribe(clientIdentity); <span class="comment">// 执行一下meta订阅</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据Client从MetaManager中获取最近一次的Cursor</span></span><br><span class="line">    Position position = canalInstance.getMetaManager().getCursor(clientIdentity);</span><br><span class="line">    <span class="keyword">if</span> (position == <span class="keyword">null</span>) &#123; <span class="comment">// 如果没有</span></span><br><span class="line">        position = canalInstance.getEventStore().getFirstPosition();<span class="comment">// 获取一下store中的第一条</span></span><br><span class="line">        <span class="keyword">if</span> (position != <span class="keyword">null</span>) &#123;</span><br><span class="line">            canalInstance.getMetaManager().updateCursor(clientIdentity, position); <span class="comment">// 更新一下cursor</span></span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"subscribe successfully, &#123;&#125; with first position:&#123;&#125; "</span>, clientIdentity, position);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 有就直接使用</span></span><br><span class="line">        logger.info(<span class="string">"subscribe successfully, use last cursor position:&#123;&#125; "</span>, clientIdentity, position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知下订阅关系变化</span></span><br><span class="line">    canalInstance.subscribeChange(clientIdentity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面关于订阅方法有两个地方，CanalInstance本身调用了subscribeChange，它关联的MetaManager也调用了subscribe方法。</p>
<p>一个CanalServer可以有多个CanalInstance，每个Instance都会有一个MetaManager。<br>而一个Instance对应一个Client。那么，这么说来，一个MetaManager也就只会有一个Client了。<br>但是从下面的数据结构来看的话，一个MetaManager貌似可以有多个Destination。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MemoryMetaManager</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractCanalLifeCycle</span> <span class="title">implements</span> <span class="title">CanalMetaManager</span> &#123;</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">List</span>&lt;<span class="type">ClientIdentity</span>&gt;&gt;              destinations;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Map</span>&lt;<span class="type">ClientIdentity</span>, <span class="type">MemoryClientIdentityBatch</span>&gt; batches;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Map</span>&lt;<span class="type">ClientIdentity</span>, <span class="type">Position</span>&gt;                  cursors;</span><br><span class="line"></span><br><span class="line">    public synchronized void subscribe(<span class="type">ClientIdentity</span> clientIdentity) <span class="keyword">throws</span> <span class="type">CanalMetaManagerException</span> &#123;</span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">ClientIdentity</span>&gt; clientIdentitys = destinations.get(clientIdentity.getDestination());</span><br><span class="line">        <span class="keyword">if</span> (clientIdentitys.contains(clientIdentity)) &#123;</span><br><span class="line">            clientIdentitys.remove(clientIdentity);</span><br><span class="line">        &#125;</span><br><span class="line">        clientIdentitys.add(clientIdentity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>猜测：多个Client可以连接到同一个Instance（虽然只会有一个Instance起作用），所以一个MetaManager可以管理多个Client。<br>NO！Client的HA与MetaManager记录的Client是不一样的。HA表示同一时间只有一个Client起作用，那么MetaManager不可能同时记录两个Client。</p>
<p>官方ClientAPI文档上：ClientIdentity是canal client和server交互之间的身份标识，目前clientId写死为1001.<br><strong><font color="red" size="5">目前canal server上的一个instance只能有一个client消费</font></strong>，<br>clientId的设计是为1个instance多client消费模式而预留的，暂时不需要理会。</p>
</blockquote>
<p>也就是说：一个Instance还是有可能有多个Client连接上来的，只是目前只允许一个而已！！！</p>
<p><img src="http://img.blog.csdn.net/20171012234337736" alt="subscribes"></p>
<p>这里的数据结构为什么这么设计，还需要参考<em>AbstractMetaManagerTest</em>的<em>doSubscribeTest</em>方法来理解。</p>
<p>对于相同的destination，可以订阅不同的client。下面的示例分别订阅了[client1,client2]和[client1,client3]。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSubscribeTest</span><span class="params">(CanalMetaManager metaManager)</span> </span>&#123;</span><br><span class="line">    ClientIdentity client1 = <span class="keyword">new</span> ClientIdentity(destination, (<span class="keyword">short</span>) <span class="number">1</span>);</span><br><span class="line">    metaManager.subscribe(client1);</span><br><span class="line">    metaManager.subscribe(client1); <span class="comment">// 重复调用：删除旧的client1，并继续增加新的client1</span></span><br><span class="line">    ClientIdentity client2 = <span class="keyword">new</span> ClientIdentity(destination, (<span class="keyword">short</span>) <span class="number">2</span>);</span><br><span class="line">    metaManager.subscribe(client2);</span><br><span class="line"></span><br><span class="line">    List&lt;ClientIdentity&gt; clients = metaManager.listAllSubscribeInfo(destination);</span><br><span class="line">    Assert.assertEquals(Arrays.asList(client1, client2), clients);</span><br><span class="line"></span><br><span class="line">    metaManager.unsubscribe(client2);</span><br><span class="line">    ClientIdentity client3 = <span class="keyword">new</span> ClientIdentity(destination, (<span class="keyword">short</span>) <span class="number">3</span>);</span><br><span class="line">    metaManager.subscribe(client3);</span><br><span class="line"></span><br><span class="line">    clients = metaManager.listAllSubscribeInfo(destination);</span><br><span class="line">    Assert.assertEquals(Arrays.asList(client1, client3), clients);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有不懂的地方，可以看看测试用例，验证自己的想法是否正确。</p>
</blockquote>
<p><strong>CanalServerWithEmbedded</strong>的订阅方法最后还会调用<strong>AbstractCanalInstance</strong>的<code>subscribeChange</code>方法。<br>这里会设置表名的filter，以及黑名单。配置项在instance.properties中。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># table regex</span></span><br><span class="line">canal.instance.<span class="built_in">filter</span>.regex = .*\\..*</span><br><span class="line"><span class="comment"># table black regex</span></span><br><span class="line">canal.instance.<span class="built_in">filter</span>.<span class="keyword">black</span>.regex =</span><br></pre></td></tr></table></figure>
<p>filter表示客户端要通过Canal Server获取MySQL哪些表的binlog，上面配置项表示获取所有表。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AbstractCanalInstance</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractCanalLifeCycle</span> <span class="title">implements</span> <span class="title">CanalInstance</span> &#123;</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Long</span>                                   canalId;                                                      <span class="comment">// 和manager交互唯一标示</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span>                                 destination;                                                  <span class="comment">// 队列名字</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalEventStore</span>&lt;<span class="type">Event</span>&gt;                 eventStore;                                                   <span class="comment">// 有序队列</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalEventParser</span>                       eventParser;                                                  <span class="comment">// 解析对应的数据信息</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalEventSink</span>&lt;<span class="type">List</span>&lt;<span class="type">CanalEntry</span>.<span class="type">Entry</span>&gt;&gt; eventSink;                                                    <span class="comment">// 链接parse和store的桥接器</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalMetaManager</span>                       metaManager;                                                  <span class="comment">// 消费信息管理器</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalAlarmHandler</span>                      alarmHandler;                                                 <span class="comment">// alarm报警机制</span></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public boolean subscribeChange(<span class="type">ClientIdentity</span> identity) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">StringUtils</span>.isNotEmpty(identity.getFilter())) &#123;</span><br><span class="line">            logger.info(<span class="string">"subscribe filter change to "</span> + identity.getFilter());</span><br><span class="line">            <span class="type">AviaterRegexFilter</span> aviaterFilter = <span class="keyword">new</span> <span class="type">AviaterRegexFilter</span>(identity.getFilter());</span><br><span class="line"></span><br><span class="line">            boolean isGroup = (eventParser instanceof <span class="type">GroupEventParser</span>);</span><br><span class="line">            <span class="keyword">if</span> (isGroup) &#123;</span><br><span class="line">                <span class="comment">// 处理group的模式</span></span><br><span class="line">                <span class="type">List</span>&lt;<span class="type">CanalEventParser</span>&gt; eventParsers = ((<span class="type">GroupEventParser</span>) eventParser).getEventParsers();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">CanalEventParser</span> singleEventParser : eventParsers) &#123;<span class="comment">// 需要遍历启动</span></span><br><span class="line">                    ((<span class="type">AbstractEventParser</span>) singleEventParser).setEventFilter(aviaterFilter);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ((<span class="type">AbstractEventParser</span>) eventParser).setEventFilter(aviaterFilter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// filter的处理规则</span></span><br><span class="line">        <span class="comment">// a. parser处理数据过滤处理</span></span><br><span class="line">        <span class="comment">// b. sink处理数据的路由&amp;分发,一份parse数据经过sink后可以分发为多份，每份的数据可以根据自己的过滤规则不同而有不同的数据</span></span><br><span class="line">        <span class="comment">// 后续内存版的一对多分发，可以考虑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应在EventParser中，存在两个Filter的引用。比如上面eventParser.setEventFilter()方法会设置AbstractEventParser的eventFilter。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractEventParser&lt;EVENT&gt;</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractCanalLifeCycle</span> <span class="title">implements</span> <span class="title">CanalEventParser&lt;EVENT&gt;</span> &#123;</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalLogPositionManager</span>                logPositionManager         = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalEventSink</span>&lt;<span class="type">List</span>&lt;<span class="type">CanalEntry</span>.<span class="type">Entry</span>&gt;&gt; eventSink                  = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalEventFilter</span>                       eventFilter                = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">CanalEventFilter</span>                       eventBlackFilter           = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EventParser_Implement">EventParser Implement</h3><p>AbstractEventParser的start()方法是解析binlog的主要方法。<br>在启动transactionBuffer和BinLogParser后，<br>会启动一个后台的工作线程<strong>parseThread</strong>一直运行：  </p>
<p>注意：下面的几个步骤是嵌套在一个while死循环里，最后会进行sleep。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开始执行replication</span></span><br><span class="line"><span class="comment">// 1. 构造Erosa连接</span></span><br><span class="line">erosaConnection = buildErosaConnection();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 启动一个心跳线程</span></span><br><span class="line">startHeartBeat(erosaConnection);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 执行dump前的准备工作</span></span><br><span class="line">preDump(erosaConnection);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 连接MySQL数据库</span></span><br><span class="line">erosaConnection.connect(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 获取最后的位置信息</span></span><br><span class="line">EntryPosition startPosition = findStartPosition(erosaConnection);</span><br><span class="line">logger.info(<span class="string">"find start position : &#123;&#125;"</span>, startPosition.toString());</span><br><span class="line"><span class="comment">// 重新链接，因为在找position过程中可能有状态，需要断开后重建</span></span><br><span class="line">erosaConnection.reconnect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义回调函数，当解析成功后，sink()方法会暂存到缓冲区transactionBuffer中。缓冲区的数据会通过心跳线程放入EventSink</span></span><br><span class="line">final SinkFunction sinkHandler = <span class="keyword">new</span> SinkFunction&lt;EVENT&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> LogPosition lastPosition;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sink</span>(<span class="params">EVENT <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        CanalEntry.Entry entry = parseAndProfilingIfNecessary(<span class="keyword">event</span>);</span><br><span class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            transactionBuffer.add(entry);</span><br><span class="line">            <span class="keyword">this</span>.lastPosition = buildLastPosition(entry);  <span class="comment">// 记录一下对应的positions</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. 开始dump数据</span></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isEmpty(startPosition.getJournalName()) &amp;&amp; startPosition.getTimestamp() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    erosaConnection.dump(startPosition.getTimestamp(), sinkHandler);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    erosaConnection.dump(startPosition.getJournalName(), startPosition.getPosition(), sinkHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的erosaConnection指的是Canal Server到MySQL的连接。<br>而前面我们说的客户端（CanalClient）连接CanalConnector指的是CanalClient到CanalServer的连接。</p>
<p><strong><font color="red" size="3">CanalServer到MySQL的连接是要获取binlog的dump数据包。而CanalClient到CanalServer有多种请求（GET/ACK等）。</font></strong></p>
<p>我们不会具体分析<em>dump</em>的流程，不过粗略看下erosaConnection的MySQL实现<strong>MysqlConnection</strong>是如何在获取到事件后调用回调函数。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dump</span>(<span class="params">String binlogfilename, Long binlogPosition, SinkFunction func</span>) throws IOException </span>&#123;</span><br><span class="line">    updateSettings();</span><br><span class="line">    sendBinlogDump(binlogfilename, binlogPosition);</span><br><span class="line">    <span class="comment">// connector指的是CanalServer到MySQL Master服务器的连接，创建一个拉取线程拉取MySQL的binlog</span></span><br><span class="line">    DirectLogFetcher fetcher = <span class="keyword">new</span> DirectLogFetcher(connector.getReceiveBufferSize());</span><br><span class="line">    fetcher.start(connector.getChannel());</span><br><span class="line">    LogDecoder decoder = <span class="keyword">new</span> LogDecoder(LogEvent.UNKNOWN_EVENT, LogEvent.ENUM_END_EVENT);</span><br><span class="line">    LogContext context = <span class="keyword">new</span> LogContext();</span><br><span class="line">    <span class="keyword">while</span> (fetcher.fetch()) &#123; <span class="comment">// 由于设置了缓冲区的大小，每次dump都只会拉取一批数据</span></span><br><span class="line">        LogEvent <span class="keyword">event</span> = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">event</span> = decoder.decode(fetcher, context);</span><br><span class="line">        <span class="keyword">if</span> (!func.sink(<span class="keyword">event</span>)) <span class="keyword">break</span>; <span class="comment">// 调用回调方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端有一个心跳线程，它的目的是消费<em>transactionBuffer</em>，并写入到<strong>EventSink</strong>中。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected boolean consumeTheEventAndProfilingIfNecessary(<span class="type">List</span>&lt;<span class="type">CanalEntry</span>.<span class="type">Entry</span>&gt; entrys) &#123;</span><br><span class="line">    boolean <span class="literal">result</span> = eventSink.sink(entrys, </span><br><span class="line">        (runningInfo == null) ? null : runningInfo.getAddress(), destination);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>EventSink</strong>最终会将数据写入到<strong>EventStore</strong>中，即<em>Put</em>到<strong>RingBuffer</strong>中。回顾下这张图：</p>
<p><img src="http://img.blog.csdn.net/20171011211529169" alt="ops"></p>
<h2 id="CanalController">CanalController</h2><p>前面分析了这么多，一直没分析Canal服务是怎么起来的，其实很简单，<br>执行脚本startup.sh本质上通过CanalLauncher会启动CanalController。</p>
<h2 id="eunomia">eunomia</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">2181</span>(CONNECTED) <span class="number">3</span>] ls /otter/canal/destinations</span><br><span class="line">[octopus_demeter, example_bak, namelist_test, xiaopang2, namelist2, xiaopang3, namelist1, example, xiaopang]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">2181</span>(CONNECTED) <span class="number">4</span>] ls /otter/canal/destinations/xiaopang</span><br><span class="line">[eunomia, cluster, <span class="number">1001</span>, running]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">2181</span>(CONNECTED) <span class="number">5</span>] ls /otter/canal/destinations/xiaopang/eunomia</span><br><span class="line">[_c_2a900d4e-<span class="number">75f</span>b-<span class="number">4445</span>-b30c-<span class="number">04e1</span>bdb2e5d9-lock-<span class="number">0001381746</span>, runnning, _c_ea33db37-<span class="number">9193</span>-<span class="number">4</span>c75-<span class="number">9e61</span>-<span class="number">85e59</span>e123109-lock-<span class="number">0001381738</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Eunomia Server？还是Canal Client？</span></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">2181</span>(CONNECTED) <span class="number">7</span>] get /otter/canal/destinations/xiaopang/eunomia/runnning</span><br><span class="line"><span class="number">10.57</span><span class="number">.17</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line">[zk: <span class="number">192.168</span><span class="number">.6</span><span class="number">.55</span>:<span class="number">2181</span>(CONNECTED) <span class="number">18</span>] get /otter/canal/destinations/xiaopang/<span class="number">1001</span>/running</span><br><span class="line">&#123;<span class="string">"active"</span>:<span class="literal">true</span>,<span class="string">"address"</span>:<span class="string">"10.57.17.100:60661"</span>,<span class="string">"clientId"</span>:<span class="number">1001</span>&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2017/10/10/Midd-canal/">深入解析中间件之-Canal</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2017年10月10日 - 00时00分</p>
  <p><span>最后更新:</span>2017年11月22日 - 12时18分</p>
  <p>
    <span>原始链接:</span><a href="/2017/10/10/Midd-canal/" title="深入解析中间件之-Canal">http://github.com/zqhxuyuan/2017/10/10/Midd-canal/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2017/10/10/Midd-canal/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2017/10/18/Midd-Dubbo/">
        深入解析中间件之-Dubbo
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2017/09/15/2017-09-15-Spark-DataSources/">
        Spark DataSources Implementation
      </a>
    </div>
  
</nav>

  
  
    <div class ="post-donate">
	<br/>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   这么长的文章我都读完了，看起来作者写的很辛苦哇！给作者赏杯咖啡喝，支持作者继续写作😁
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<img src="/img/zhifubao.png" alt="支付宝打赏"> 
		<img src="/img/weixin.png" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL_binlog"><span class="toc-number">1.</span> <span class="toc-text">MySQL binlog</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL主从复制"><span class="toc-number">1.1.</span> <span class="toc-text">MySQL主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#binlog"><span class="toc-number">1.2.</span> <span class="toc-text">binlog</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Canal_QuickStart"><span class="toc-number">2.</span> <span class="toc-text">Canal QuickStart</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#canal_&_config"><span class="toc-number">2.1.</span> <span class="toc-text">canal & config</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#simple_client"><span class="toc-number">2.2.</span> <span class="toc-text">simple client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cannal_Internal_Overview"><span class="toc-number">3.</span> <span class="toc-text">Cannal Internal Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#canal_client_&_server"><span class="toc-number">3.1.</span> <span class="toc-text">canal client & server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CanalServerWithEmbedded"><span class="toc-number">3.2.</span> <span class="toc-text">CanalServerWithEmbedded</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventStore"><span class="toc-number">3.3.</span> <span class="toc-text">EventStore</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventParser_WorkFlow"><span class="toc-number">3.4.</span> <span class="toc-text">EventParser WorkFlow</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Canal_HA"><span class="toc-number">4.</span> <span class="toc-text">Canal HA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Canal_Client_HA"><span class="toc-number">5.</span> <span class="toc-text">Canal Client HA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Develop_Canal_Client"><span class="toc-number">6.</span> <span class="toc-text">Develop Canal Client</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#subscribe_change"><span class="toc-number">6.1.</span> <span class="toc-text">subscribe change</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventParser_Implement"><span class="toc-number">6.2.</span> <span class="toc-text">EventParser Implement</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CanalController"><span class="toc-number">7.</span> <span class="toc-text">CanalController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eunomia"><span class="toc-number">8.</span> <span class="toc-text">eunomia</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2017/10/10/Midd-canal/" data-title="深入解析中间件之-Canal" data-url="http://github.com/zqhxuyuan/2017/10/10/Midd-canal/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div  class="post-nav-button">
    <a href="/2017/10/18/Midd-Dubbo/" title="上一篇: 深入解析中间件之-Dubbo">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2017/09/15/2017-09-15-Spark-DataSources/" title="下一篇: Spark DataSources Implementation">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>